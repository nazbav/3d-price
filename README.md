# Калькулятор себестоимости 3D‑печати

Проект представляет набор HTML‑страниц для расчёта полной стоимости моделей, печатаемых на 3D‑принтере. Содержит как стабильные, так и экспериментальные версии калькулятора.

## Содержание репозитория

1. **index1.html** – первая версия с минимальным функционалом
2. **index2.html** – расширенная версия (основная)
3. **index3.html** – тест предыдущего поколения
4. **index.html**  – четвёртый релиз
5. **test.html**   – эксперименты и новые возможности

Онлайн‑версию можно открыть по ссылке: <https://nazbav.github.io/3d-price/test.html> (см. раздел *Навигация и разделы*).

---

## Быстрый старт

1. Перейдите по ссылке выше либо откройте нужный HTML‑файл локально в браузере.
2. Заполните справочники во вкладках **«Принтеры»**, **«Материалы»** и **«Доп. расходы»**.
3. На вкладке **«Калькулятор»** задайте параметры печати и нажмите **«Рассчитать»**.
4. Сохраните расчёт в историю или распечатайте термоэтикетку.

### Запуск локально

```bash
git clone https://github.com/nazbav/3d-price.git
cd 3d-price
# открыть test.html в любом современном браузере
```
Никаких зависимостей устанавливать не требуется – все скрипты подключены через CDN.

---

## Навигация и разделы

Экспериментальная версия `test.html` содержит несколько вкладок:

1. **Рассчитать** – основной калькулятор
2. **История** – список всех сохранённых расчётов
3. **Клиенты** – база заказчиков с телефоном и комментариями
4. **Принтеры** – перечень доступных принтеров
5. **Материалы** – глобальный список материалов
6. **Доп. расходы** – разовые и постоянные траты
7. **Настройки** – параметры калькуляции и брендинга
8. **Сводка** – статистика по прибыли и занятости
9. **Импорт/Экспорт** – обмен данными через JSON или Supabase

При удалении принтера, указанного в истории, приложение открывает модальное окно для переноса расчётов на другой существующий принтер.

### Карта переходов

Обычный путь пользователя выглядит так:

```
Принтеры ─▶ Материалы ─▶ Доп. расходы ─▶ Рассчитать
        ╰────▶ История ─▶ Сводка
                        ╰────▶ Импорт/Экспорт
```
Из калькулятора можно перейти к истории либо сразу к сводке. Из истории – к редактированию клиентов и обратно.

---

## Данные и параметры

Все сущности хранятся в `LocalStorage` и состоят из нескольких блоков.

### 1. Принтеры
- `name` – название
- `cost` – полная стоимость (включая ремонт)
- `hoursToRecoup` – через сколько часов принтер должен окупиться
- `power` – мощность в ваттах
- `maintCostHour` – обслуживание (руб/ч)

### 2. Материалы
- `name` – тип и бренд
- `costPerKg` – цена за килограмм
- `availableKg` – количество в наличии
- `wastePercent` – процент отхода

### 3. Доп. расходы
- `description` – комментарий
- `cost` – общая сумма, распределяемая на часы печати

### 4. Настройки калькулятора (`calcSettings`)
- `operatorRate` – ставка оператора, руб/ч
- `workHoursDay` – рабочих часов в день
- `startDate` – дата начала печати
- `costKwh` – цена электроэнергии
- `shipping` – упаковка/доставка, руб
- `taxPercent` – процент налога
- `parallelPrinting` – учёт параллельной печати
- `markupPercent` – наценка на итоговую стоимость

---

## Формулы расчёта

Ниже описаны ключевые формулы, применяемые при вычислении итоговой цены.

### 1. Амортизация принтера

```text
costPerHourPrinter = cost / hoursToRecoup
costPrinterPart    = costPerHourPrinter * hours
```

### 2. Оплата оператора

```text
costOperatorPart = hours * operatorRate
```

### 3. Расход материала

```text
realGrams        = grams * (1 + wastePercent / 100)
costPerGram      = costPerKg / 1000
costMaterialPart = realGrams * costPerGram
```

### 4. Дополнительные расходы

```text
sumAdditional       = Σ(cost)
costPerHourAddition = sumAdditional / hoursToRecoup
costAdditionalPart  = costPerHourAddition * hours
```

### 5. Электричество и обслуживание

```text
costElectric     = (power / 1000) * hours * costKwh
costMaintenance  = maintCostHour * hours
```

### 6. Доставка/упаковка и налог

```text
costShipping = shipping
subTotal     = costPrinterPart + costOperatorPart + costMaterialPart +
               costAdditionalPart + costElectric + costMaintenance + costShipping
costTax      = subTotal * (taxPercent / 100)
total        = subTotal + costTax
```

### 7. Пример расчёта срока

```text
daysNeeded = ceil(hours / workHoursDay)
```
Если указан `startDate`, к нему прибавляется `daysNeeded` для получения предполагаемой даты окончания.

---

## Алгоритм вычисления

1. Пользователь вводит исходные данные во вкладке **Калькулятор**.
2. Скрипт подставляет значения в формулы, описанные выше.
3. Если активирован режим параллельной печати, время распределяется между несколькими принтерами.
4. Результат отображается на экране и может быть сохранён в историю.
5. При сохранении в историю данные попадают в список, где их можно отредактировать или удалить.

### Очередь и параллельная печать

При включённой опции `parallelPrinting` калькулятор сравнивает время для каждого выбранного принтера и определяет общее время как максимум из них. Это позволяет учитывать одновременную загрузку нескольких устройств.

### Синхронизация через Supabase

1. При загрузке страницы создаётся уникальный `sync_id` и ключ шифрования.
2. При экспорте данные шифруются в браузере с помощью `AES-GCM` и отправляются в таблицу `user_settings`.
3. При импорте происходит обратная процедура: данные загружаются, проверяется актуальность (не старше 5 минут) и расшифровываются тем же ключом.
4. Для обмена с мобильным устройством генерируется QR‑код с параметрами `sync_id` и `key`.

### Генерация термоэтикеток

После расчёта можно вывести мини‑этикетку со сведениями о модели, дате и цене. Печать осуществляется через стандартное окно браузера или экспорт в PDF.

---

## Customer Journey Maps

### Новая печать
1. Пользователь открывает калькулятор и добавляет свой принтер и материал.
2. Заполняет параметры печати, нажимает **«Рассчитать»** и просматривает итог.
3. Сохраняет расчёт, получает ориентировочную дату окончания и при необходимости печатает этикетку.
4. Данные сохраняются в историю, где можно отслеживать статус заказа.

### Постоянный клиент с облачным профилем
1. Пользователь сканирует QR‑код, созданный ранее на основном устройстве.
2. Происходит загрузка настроек из Supabase – все принтеры, материалы и история восстанавливаются.
3. Менеджер выбирает клиента из списка, проводит новый расчёт и отправляет ссылку заказчику.
4. По завершении заказ архивируется, а статистика обновляется в разделе **Сводка**.

---

## Импорт, экспорт и хранение данных

- Все данные хранятся локально в `LocalStorage` и не требуют подключения к серверу.
- Во вкладке **Импорт/Экспорт** можно сохранить JSON на диск или загрузить его обратно.
- Через Supabase доступна облачная синхронизация: данные шифруются в браузере, хранятся не более 5 минут и доступны по ссылке или QR‑коду.

---

## Тёмная тема

Кнопка переключения темы находится в шапке каждой страницы. Выбранная тема запоминается в `LocalStorage`.

---

## Связь

Если у вас есть вопросы или предложения, создавайте issue или пишите автору через профиль GitHub.

---

## Лицензия

Проект распространяется по лицензии MIT.

---

**Приятных расчётов и успешной печати!**
