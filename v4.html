<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 3D-–ø–µ—á–∞—Ç–∏ (v3)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

	<script>
  window.location.href = "test.html";
</script>
	
  <style>
    body { margin: 0; padding: 0; }
    .container { margin-top: 20px; margin-bottom: 20px; }
    .nav-tabs .nav-link.active { font-weight: bold; }
    .small-text { font-size: 0.9rem; color: #555; }
    .footer { margin-top: 40px; font-size: 0.9rem; border-top: 1px solid var(--bs-border-color); padding-top: 10px; }
    table td, table th { vertical-align: middle; white-space: nowrap; }
    .btn-group-sm > .btn { font-size: 0.8rem; padding: 2px 6px; margin-left: 2px; }
    thead th { background-color: var(--bs-table-bg) !important; color: var(--bs-body-color) !important; }
    [data-bs-theme="dark"] thead th { background-color: var(--bs-dark-bg-subtle) !important; color: var(--bs-light) !important; }
    @media (max-width: 576px) {
      .d-flex { flex-wrap: wrap !important; }
      .d-flex > * { margin-top: .5rem; }
    }
@media (max-width: 768px) {
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
  th, td {
    min-width: 100px;
  }
}
    .form-select.form-select-sm { min-width: 120px; }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–∏–∫–µ—Ç–∫–∏ */
    .label-preview { border: 1px solid #000; width: 30mm; height: 20mm; padding: 2mm; font-family: sans-serif; }
  </style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="my-4">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 3D-–ø–µ—á–∞—Ç–∏ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)</h1>
    <div class="d-flex gap-2">
      <a href="https://github.com/nazbav/3d-price/blob/main/README.md" class="btn btn-outline-primary" target="_blank">README</a>
      <button class="btn btn-outline-secondary" id="themeToggle">üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</button>
    </div>
  </div>
  <ul class="nav nav-tabs" id="mainTab" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="calculate-tab" data-bs-toggle="tab"
              data-bs-target="#calculatePane" type="button" role="tab" aria-selected="true"
              aria-controls="calculatePane" aria-selected="false">
        –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="history-tab" data-bs-toggle="tab"
              data-bs-target="#historyPane" type="button" role="tab"
              aria-controls="historyPane" aria-selected="false">
        –ò—Å—Ç–æ—Ä–∏—è
      </button>
    </li>

    <li class="nav-item">
      <button class="nav-link" id="printers-tab" data-bs-toggle="tab"
              data-bs-target="#printersPane" type="button" role="tab" aria-controls="printersPane" >
        –ü—Ä–∏–Ω—Ç–µ—Ä—ã
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="globalMaterials-tab" data-bs-toggle="tab"
              data-bs-target="#globalMaterialsPane" type="button" role="tab"
              aria-controls="globalMaterialsPane" aria-selected="false">
        –û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="globalAdditional-tab" data-bs-toggle="tab"
              data-bs-target="#globalAdditionalPane" type="button" role="tab"
              aria-controls="globalAdditionalPane" aria-selected="false">
        –û–±—â–∏–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="labelsettings-tab" data-bs-toggle="tab"
              data-bs-target="#labelsettingsPane" type="button" role="tab"
              aria-controls="labelsettingsPane" aria-selected="false">
        –≠—Ç–∏–∫–µ—Ç–∫–∞
      </button>
    </li>
	<li class="nav-item">
      <button class="nav-link" id="summary-tab" data-bs-toggle="tab"
              data-bs-target="#summaryPane" type="button" role="tab"
              aria-controls="summaryPane" aria-selected="false">
        –ò—Ç–æ–≥–∏
      </button>
    </li>

    <li class="nav-item">
      <button class="nav-link" id="importexport-tab" data-bs-toggle="tab"
              data-bs-target="#importexportPane" type="button" role="tab"
              aria-controls="importexportPane" aria-selected="false">
        –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç
      </button>
    </li>

  </ul>

  <div class="tab-content" id="mainTabContent">
    <!-- –ü—Ä–∏–Ω—Ç–µ—Ä—ã -->
    <div class="tab-pane fade" id="printersPane" role="tabpanel" aria-labelledby="printers-tab">
      <div class="mt-4">
        <h3>–°–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</h3>
        <p class="small-text">
          –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–ª—è –Ω–µ–≥–æ.
        </p>
        <div class="mb-2">
          <button class="btn btn-primary btn-sm" onclick="onAddPrinter()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä</button>
          <button class="btn btn-danger btn-sm" onclick="massDelete('printers')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
          <button class="btn btn-warning btn-sm" onclick="massEdit('printers')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="printersTable">
            <thead class="">
              <tr>
                <th><input type="checkbox" id="selectAll_printers" onchange="selectAll(this, 'printers')"></th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</th>
                <th>–ß–∞—Å—ã –æ–∫—É–ø.</th>
                <th>–ú–æ—â–Ω. (–í—Ç)</th>
                <th>–û–±—Å–ª. (‚ÇΩ/—á)</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <hr/>
      <div id="printerDetails" style="display: none;">
        <h4>–†–∞—Å—Ö–æ–¥—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ <span id="printerDetailsName"></span> (ID: <span id="printerDetailsId"></span>)</h4>
        <div class="row">
          <div class="col-md-6">
            <h5>–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ)</h5>
            <p class="small-text">–£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å, —á–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ –∏ –æ—Ç–º–µ—Ç—å—Ç–µ, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ —Ä–∞—Å—Ö–æ–¥ –≤ —Ä–∞—Å—á—ë—Ç–µ.</p>
            <div class="mb-2">
              <button class="btn btn-sm btn-success" id="btnAddPrinterAdditional">–î–æ–±–∞–≤–∏—Ç—å</button>
              <button class="btn btn-danger btn-sm" onclick="massDelete('printerAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
              <button class="btn btn-warning btn-sm" onclick="massEdit('printerAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-hover" id="printerAdditionalTable">
                <thead>
                  <tr>
                    <th><input type="checkbox" id="selectAll_printerAdditional" onchange="selectAll(this, 'printerAdditional')"></th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–°—Ç–æ–∏–º. (‚ÇΩ)</th>
                    <th>–ß–∞—Å—ã –æ–∫—É–ø.</th>
                    <th>–í–∫–ª. –≤ —Ä–∞—Å—á—ë—Ç?</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="col-md-6">
            <h5>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ)</h5>
            <p class="small-text">–£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥, –æ—Å—Ç–∞—Ç–æ–∫ (–≤ –∫–≥), –∑–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å, –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Ö–æ–¥–æ–≤, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –∏ –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.</p>
            <div class="mb-2">
              <button class="btn btn-sm btn-success" id="btnAddPrinterMaterial">–î–æ–±–∞–≤–∏—Ç—å</button>
              <button class="btn btn-danger btn-sm" onclick="massDelete('printerMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
              <button class="btn btn-warning btn-sm" onclick="massEdit('printerMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-hover" id="printerMaterialsTable">
                <thead>
                  <tr>
                    <th><input type="checkbox" id="selectAll_printerMaterials" onchange="selectAll(this, 'printerMaterials')"></th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–°—Ç–æ–∏–º./–∫–≥</th>
                    <th>–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥)</th>
                    <th>–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥)</th>
                    <th>–û—Ç—Ö–æ–¥ (%)</th>
                    <th>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</th>
                    <th>–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤.</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã -->
    <div class="tab-pane fade" id="globalMaterialsPane" role="tabpanel" aria-labelledby="globalMaterials-tab">
      <div class="mt-4">
        <h3>–û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
        <p class="small-text">–≠—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º ¬´–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é¬ª. –£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥, –æ—Å—Ç–∞—Ç–æ–∫, –∑–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –∏ –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.</p>
        <div class="mb-2">
          <button class="btn btn-primary btn-sm" onclick="onAddGlobalMaterial()">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
          <button class="btn btn-danger btn-sm" onclick="massDelete('globalMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
          <button class="btn btn-warning btn-sm" onclick="massEdit('globalMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="materialsTable">
            <thead class="">
              <tr>
                <th><input type="checkbox" id="selectAll_globalMaterials" onchange="selectAll(this, 'globalMaterials')"></th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–°—Ç–æ–∏–º./–∫–≥</th>
                <th>–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥)</th>
                <th>–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥)</th>
                <th>–û—Ç—Ö–æ–¥ (%)</th>
                <th>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</th>
                <th>–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤.</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –û–±—â–∏–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã -->
    <div class="tab-pane fade" id="globalAdditionalPane" role="tabpanel" aria-labelledby="globalAdditional-tab">
      <div class="mt-4">
        <h3>–û–±—â–∏–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã</h3>
        <div class="mb-2">
          <button class="btn btn-primary btn-sm" onclick="onAddGlobalAdditional()">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
          <button class="btn btn-danger btn-sm" onclick="massDelete('globalAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
          <button class="btn btn-warning btn-sm" onclick="massEdit('globalAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="additionalGlobalTable">
            <thead class="">
              <tr>
                <th><input type="checkbox" id="selectAll_globalAdditional" onchange="selectAll(this, 'globalAdditional')"></th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–°—Ç–æ–∏–º. (‚ÇΩ)</th>
                <th>–ß–∞—Å—ã –æ–∫—É–ø.</th>
                <th>–í–∫–ª. –≤ —Ä–∞—Å—á—ë—Ç?</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
    <div class="tab-pane fade show active" id="calculatePane" role="tabpanel" aria-labelledby="calculate-tab">
      <div class="my-4">
        <h3>–†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–æ—á–µ—Ä–µ–¥—å –ø–µ—á–∞—Ç–∏)</h3>
        <p class="small-text">
          –î–æ 10 –º–æ–¥–µ–ª–µ–π –Ω–∞ –∫–∞–∂–¥—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞, –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞.
        </p>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="calcName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞:</label>
          <input type="text" id="calcName" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫–∞–∑ 123" />
        </div>
        <div class="col-md-4">
          <label for="calcClientName" class="form-label">–ö–ª–∏–µ–Ω—Ç (–§–ò–û/–∫–æ–º–ø–∞–Ω–∏—è):</label>
          <input type="text" id="calcClientName" class="form-control" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" />
        </div>
        <div class="col-md-4">
          <label for="calcOrderStatus" class="form-label">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:</label>
          <select id="calcOrderStatus" class="form-select">
            <option value="new">–ù–æ–≤—ã–π</option>
            <option value="inprogress">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
            <option value="canceled">–û—Ç–º–µ–Ω—ë–Ω</option>
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="calcOperatorRate" class="form-label">–°—Ç–∞–≤–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (‚ÇΩ/—á):</label>
          <input type="number" step="0.01" id="calcOperatorRate" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcWorkHoursDay" class="form-label">–†–∞–±. —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å:</label>
          <input type="number" id="calcWorkHoursDay" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcCostKwh" class="form-label">–¶–µ–Ω–∞ 1‚ÄØ–∫–í—Ç‚ãÖ—á (‚ÇΩ):</label>
          <input type="number" step="0.01" id="calcCostKwh" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcTaxPercent" class="form-label">–ù–∞–ª–æ–≥ (%):</label>
          <input type="number" step="1" id="calcTaxPercent" class="form-control" />
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="calcShipping" class="form-label">–£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞ (‚ÇΩ):</label>
          <input type="number" step="1" id="calcShipping" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcStartDate" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
          <input type="date" id="calcStartDate" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcParallelPrinting" class="form-label">–£—á—ë—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–µ—á–∞—Ç–∏?</label>
          <select id="calcParallelPrinting" class="form-select">
            <option value="no">–ù–µ—Ç</option>
            <option value="yes">–î–∞</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="calcMarkupPercent" class="form-label">–ù–∞—Ü–µ–Ω–∫–∞ (%):</label>
          <input type="number" step="1" id="calcMarkupPercent" class="form-control" />
        </div>
      </div>
      <hr/>
      <div id="calcPrintersContainer"></div>
      <div class="mt-3">
        <button class="btn btn-success" onclick="onCalculateAll()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Å—ë</button>
      </div>
      <div class="alert alert-info mt-3" id="calcResult" style="display: none;"></div>
    </div>

    <!-- –ò—Ç–æ–≥–∏ -->
    <div class="tab-pane fade" id="summaryPane" role="tabpanel" aria-labelledby="summary-tab">
      <div class="mt-4">
        <h3>–û–±—â–∏–π –æ–±–∑–æ—Ä (¬´–ò—Ç–æ–≥–∏¬ª)</h3>
        <p class="small-text">–°—É–º–º–∞—Ä–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º, –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º (–±–µ–∑. —É—á –æ—Å—Ç–∞—Ç–∫–∞).</p>
        <div id="summaryContent"></div>
      </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div class="tab-pane fade" id="historyPane" role="tabpanel" aria-labelledby="history-tab">
      <div class="mt-4">
        <h3>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤</h3>
        <p class="small-text">
          –ü—Ä–æ—à–ª—ã–µ —Ä–∞—Å—á—ë—Ç—ã. –ö–Ω–æ–ø–∫–∏: ¬´JSON¬ª ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ–±—ä–µ–∫—Ç, ¬´HTML¬ª ‚Äî —Å–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç, ¬´–†–µ–¥–∞–∫—Ç.¬ª ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.
        </p>
        <button class="btn btn-danger mb-3" onclick="onClearCalcHistory()">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="historyTable">
            <thead class="">
              <tr>
                <th>–î–∞—Ç–∞/–≤—Ä–µ–º—è</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞</th>
                <th>–ö–ª–∏–µ–Ω—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ò—Ç–æ–≥ (‚ÇΩ)</th>
                <th>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç -->
<div class="tab-pane fade" id="importexportPane" role="tabpanel" aria-labelledby="importexport-tab">
        <div class="mt-4">  
<h3>üì° –ë—ã—Å—Ç—Ä–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–æ–±–ª–∞—á–Ω–∞—è)</h3>
<button class="btn btn-primary mt-2" onclick="generateSyncLinkAndQR()">üîó –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –∏ QR</button>
<button class="btn btn-warning mt-2" onclick="saveSettingsToCloud()">‚òÅÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ (–Ω–∞ 5 –º–∏–Ω—É—Ç)</button>
<button class="btn btn-info mt-2" onclick="loadSettingsFromCloud()">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
<input type="text" id="syncLinkDisplay" class="form-control mt-2" readonly>
<div id="qrcode" class="mt-2"></div>
<hr>
<h3>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>

    <button class="btn btn-primary" onclick="onExportJson()">–í—ã–≥—Ä—É–∑–∏—Ç—å JSON</button>
    <button class="btn btn-secondary" onclick="onExportHistory()">–í—ã–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <textarea id="exportArea" class="form-control mt-2" rows="5"></textarea>

  <hr>
  <div class="mt-4">
    <h3>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
    <textarea id="importArea" class="form-control" rows="5"></textarea>
    <button class="btn btn-success mt-2" onclick="onImportJson()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button class="btn btn-secondary mt-2" onclick="onImportHistory()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
  </div>
</div>
  </div>  </div>
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ç–∏–∫–µ—Ç–∫–∏ -->
 <div class="tab-pane fade" id="labelsettingsPane" role="tabpanel" aria-labelledby="labelsettings-tab">
  <div class="mt-4">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ç–∏–∫–µ—Ç–∫–∏</h3>
    <div class="mb-3">
      <label for="companyNameInput" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏:</label>
      <input type="text" id="companyNameInput" class="form-control"/>
    </div>
    <div class="mb-3">
      <label for="chatLinkInput" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç (QR):</label>
      <input type="text" id="chatLinkInput" class="form-control"/>
    </div>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è -->
    <div class="mb-3">
      <label for="labelCostInput" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å 1 —ç—Ç–∏–∫–µ—Ç–∫–∏ (‚ÇΩ):</label>
      <input type="number" step="0.01" id="labelCostInput" class="form-control"/>
    </div>
    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="printLabelsCheckbox">
      <label class="form-check-label" for="printLabelsCheckbox">–ü–µ—á–∞—Ç–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏</label>
    </div>
    <button class="btn btn-primary" onclick="saveLabelSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>
  </div>
  <div class="footer" style="text-align:center">
    <p class="mb-1">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ LocalStorage –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.</p>
    <p class="mb-0">–î–ª—è —Å–±—Ä–æ—Å–∞ –º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–π JSON –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å LocalStorage –≤—Ä—É—á–Ω—É—é.</p>
    <a href="index2.html"><h6>–ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ (—Ç—ã–∫)</h6></a>
    <p class="mt-3"><span style="text-decoration:line-through">¬©</span>2025. –ù–∏—á—å–∏ –ø—Ä–∞–≤–∞ –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã. –°–¥–µ–ª–∞–Ω–æ –ø—Ä–∏ —É—á–∞—Å—Ç–∏–∏ –ò–ò</p>
  </div>
</div>
	
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const THEME_STORAGE_KEY = "themePreference";
function setTheme(theme) {
  document.documentElement.setAttribute("data-bs-theme", theme);
  localStorage.setItem(THEME_STORAGE_KEY, theme);
  const btn = document.getElementById("themeToggle");
  btn.innerText = theme==="dark" ? "‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞" : "üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞";
}
document.getElementById("themeToggle").addEventListener("click",()=>{
  const th = document.documentElement.getAttribute("data-bs-theme");
  setTheme(th==="dark"?"light":"dark");
});
const savedTheme = localStorage.getItem(THEME_STORAGE_KEY)||"light";
setTheme(savedTheme);

const STORAGE_KEY = "ThreeDPrintCalc_Extended_v5";
let appData = {
  printers: [
    {
      id: 1,
      name: "FF5M",
      cost: 35000,
      hoursToRecoup: 500,
      power: 350,
      maintCostHour: 5,
      additional: [],
      materials: []
    }
  ],
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã: –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è: balance (–æ—Å—Ç–∞—Ç–æ–∫), declaredWeight, manufacturer, productionDate
  materials: [
    // –ü—Ä–∏–º–µ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    // { id: 1001, name: "PLA", costPerKg: 150, balance: 10, declaredWeight: 1, wastePercent: 5, manufacturer: "XYZ", productionDate: "01.01.2025" }
  ],
  additionalGlobal: [],
  calcSettings: {
    operatorRate: 200,
    workHoursDay: 8,
    startDate: "",
    costKwh: 6,
    shipping: 300,
    taxPercent: 6,
    parallelPrinting: "no",
    markupPercent: 0
  },
  labelSettings: {
  companyName: "–ö–æ–º–ø–∞–Ω–∏—è",
  chatLink: "https://t.me/dur",
  costPerLabel: 0,   
  printLabels: false 
},
  calcHistory: []
};

function loadFromLocalStorage(){
  try{
    const s = localStorage.getItem(STORAGE_KEY);
    if(s){
      const p = JSON.parse(s);
      if(p) appData = p;
    }
  } catch(e){}
}
function saveToLocalStorage(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
}
function initAll(){
  loadFromLocalStorage();
  renderPrintersTable();
  renderGlobalMaterialsTable();
  renderGlobalAdditionalTable();
  renderCalcPrinters();
  renderHistoryTable();
  renderSummary();
  document.getElementById("calcOperatorRate").value = appData.calcSettings.operatorRate || "";
  document.getElementById("calcWorkHoursDay").value = appData.calcSettings.workHoursDay || "";
  document.getElementById("calcCostKwh").value = appData.calcSettings.costKwh || "";
  document.getElementById("calcTaxPercent").value = appData.calcSettings.taxPercent || "";
  document.getElementById("calcShipping").value = appData.calcSettings.shipping || "";
  document.getElementById("calcStartDate").value = appData.calcSettings.startDate || "";
  document.getElementById("calcParallelPrinting").value = appData.calcSettings.parallelPrinting || "no";
  document.getElementById("calcMarkupPercent").value = appData.calcSettings.markupPercent || 0;
  document.getElementById("companyNameInput").value = appData.labelSettings.companyName || "";
  document.getElementById("chatLinkInput").value = appData.labelSettings.chatLink || "";
  document.getElementById("labelCostInput").value = appData.labelSettings.costPerLabel || 0;
  document.getElementById("printLabelsCheckbox").checked = appData.labelSettings.printLabels || false;


}


// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏
function parseTimeInput(input) {
  if (input.includes(":")) {
    const [hours, minutes] = input.split(":").map(Number);
    return hours + (minutes / 60);
  }
  return parseFloat(input) || 0;
}

function formatTimeForDisplay(time) {
  if (time === undefined || time === null) return "";
  const hours = Math.floor(time);
  const minutes = Math.round((time - hours) * 60);
  return `${hours}:${minutes.toString().padStart(2, '0')}`;
}

function handleTimeInput(event) {
  const input = event.target.value;
  // –ü–æ–∑–≤–æ–ª—è–µ–º –≤–≤–æ–¥–∏—Ç—å –∫–∞–∫ –ß:–ú, —Ç–∞–∫ –∏ –¥–µ—Å—è—Ç–∏—á–Ω–æ–µ —á–∏—Å–ª–æ
  if (input.includes(":")) {
    const [hours, minutes] = input.split(":").map(Number);
    if (!isNaN(hours) && !isNaN(minutes)) {
      return hours + (minutes / 60);
    }
  }
  return parseFloat(input) || 0;
}

document.addEventListener("DOMContentLoaded", initAll);

/* –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
function selectAll(source, type) {
  const checkboxes = document.querySelectorAll("."+type+"_chk");
  checkboxes.forEach(cb => cb.checked = source.checked);
}
function massDelete(type) {
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã?")) return;
  switch(type) {
    case 'printers':
      appData.printers = appData.printers.filter(p => {
        const chk = document.getElementById("chk_printers_"+p.id);
        return !(chk && chk.checked);
      });
      renderPrintersTable();
      break;
    case 'globalMaterials':
      appData.materials = appData.materials.filter(m => {
        const chk = document.getElementById("chk_globalMaterials_"+m.id);
        return !(chk && chk.checked);
      });
      renderGlobalMaterialsTable();
      break;
    case 'globalAdditional':
      appData.additionalGlobal = appData.additionalGlobal.filter(a => {
        const chk = document.getElementById("chk_globalAdditional_"+a.id);
        return !(chk && chk.checked);
      });
      renderGlobalAdditionalTable();
      break;
    case 'printerAdditional':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          printer.additional = printer.additional.filter(a => {
            const chk = document.getElementById("chk_printerAdditional_"+a.id);
            return !(chk && chk.checked);
          });
          onShowPrinterDetails(printerId);
        }
      }
      break;
    case 'printerMaterials':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          printer.materials = printer.materials.filter(m => {
            const chk = document.getElementById("chk_printerMaterials_"+m.id);
            return !(chk && chk.checked);
          });
          onShowPrinterDetails(printerId);
        }
      }
      break;
  }
  saveToLocalStorage();
}
function massEdit(type) {
  // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π (–∏—Å–∫–ª—é—á–∞—è –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ id)
  switch(type) {
    case 'printers':
      {
        let newCost = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):");
        let newHours = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —á–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:");
        let newPower = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –º–æ—â–Ω–æ—Å—Ç—å (–í—Ç):");
        let newMaint = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (‚ÇΩ/—á):");
        if(newCost===null || newHours===null || newPower===null || newMaint===null) return;
        appData.printers.forEach(p => {
          const chk = document.getElementById("chk_printers_"+p.id);
          if(chk && chk.checked) {
            p.cost = parseFloat(newCost) || p.cost;
            p.hoursToRecoup = parseFloat(newHours) || p.hoursToRecoup;
            p.power = parseFloat(newPower) || p.power;
            p.maintCostHour = parseFloat(newMaint) || p.maintCostHour;
          }
        });
        renderPrintersTable();
      }
      break;
    case 'globalMaterials':
      {
        let newCost = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:");
        let newBalance = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (–∫–≥):");
        let newDeclared = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥):");
        let newWaste = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Ö–æ–¥–æ–≤:");
        let newManuf = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è:");
        let newProdDate = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (DD.MM.YYYY):");
        if(newCost===null || newBalance===null || newDeclared===null || newWaste===null || newManuf===null || newProdDate===null) return;
        appData.materials.forEach(m => {
          const chk = document.getElementById("chk_globalMaterials_"+m.id);
          if(chk && chk.checked) {
            m.costPerKg = parseFloat(newCost) || m.costPerKg;
            m.balance = parseFloat(newBalance) || m.balance;
            m.declaredWeight = parseFloat(newDeclared) || m.declaredWeight;
            m.wastePercent = parseFloat(newWaste) || m.wastePercent;
            m.manufacturer = newManuf;
            m.productionDate = newProdDate;
          }
        });
        renderGlobalMaterialsTable();
      }
      break;
    case 'globalAdditional':
      {
        let newCost = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):");
        let newHours = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —á–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:");
        let newUse = confirm("–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö?");
        if(newCost===null || newHours===null) return;
        appData.additionalGlobal.forEach(a => {
          const chk = document.getElementById("chk_globalAdditional_"+a.id);
          if(chk && chk.checked) {
            a.cost = parseFloat(newCost) || a.cost;
            a.hoursToRecoup = parseFloat(newHours) || a.hoursToRecoup;
            a.useInCalc = newUse;
          }
        });
        renderGlobalAdditionalTable();
      }
      break;
    case 'printerAdditional':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          let newCost = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):");
          let newHours = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —á–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:");
          let newUse = confirm("–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö?");
          if(newCost===null || newHours===null) return;
          printer.additional.forEach(a => {
            const chk = document.getElementById("chk_printerAdditional_"+a.id);
            if(chk && chk.checked) {
              a.cost = parseFloat(newCost) || a.cost;
              a.hoursToRecoup = parseFloat(newHours) || a.hoursToRecoup;
              a.useInCalc = newUse;
            }
          });
          onShowPrinterDetails(printerId);
        }
      }
      break;
    case 'printerMaterials':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          let newCost = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:");
          let newBalance = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (–∫–≥):");
          let newDeclared = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥):");
          let newWaste = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Ö–æ–¥–æ–≤:");
          let newManuf = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è:");
          let newProdDate = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (DD.MM.YYYY):");
          if(newCost===null || newBalance===null || newDeclared===null || newWaste===null || newManuf===null || newProdDate===null) return;
          printer.materials.forEach(m => {
            const chk = document.getElementById("chk_printerMaterials_"+m.id);
            if(chk && chk.checked) {
              m.costPerKg = parseFloat(newCost) || m.costPerKg;
              m.balance = parseFloat(newBalance) || m.balance;
              m.declaredWeight = parseFloat(newDeclared) || m.declaredWeight;
              m.wastePercent = parseFloat(newWaste) || m.wastePercent;
              m.manufacturer = newManuf;
              m.productionDate = newProdDate;
            }
          });
          onShowPrinterDetails(printerId);
        }
      }
      break;
  }
  saveToLocalStorage();
}
function copyElement(type, id) {
  switch(type) {
    case 'printers':
      {
        const orig = appData.printers.find(p => p.id === id);
        if(orig){
          const copy = JSON.parse(JSON.stringify(orig));
          copy.id = Date.now();
          copy.name += " (–∫–æ–ø–∏—è)";
          appData.printers.push(copy);
          renderPrintersTable();
        }
      }
      break;
    case 'globalMaterials':
      {
        const orig = appData.materials.find(m => m.id === id);
        if(orig){
          const copy = JSON.parse(JSON.stringify(orig));
          copy.id = Date.now();
          copy.name += " (–∫–æ–ø–∏—è)";
          appData.materials.push(copy);
          renderGlobalMaterialsTable();
        }
      }
      break;
    case 'globalAdditional':
      {
        const orig = appData.additionalGlobal.find(a => a.id === id);
        if(orig){
          const copy = JSON.parse(JSON.stringify(orig));
          copy.id = Date.now();
          copy.description += " (–∫–æ–ø–∏—è)";
          appData.additionalGlobal.push(copy);
          renderGlobalAdditionalTable();
        }
      }
      break;
    case 'printerAdditional':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          const orig = printer.additional.find(a => a.id === id);
          if(orig){
            const copy = JSON.parse(JSON.stringify(orig));
            copy.id = Date.now();
            copy.description += " (–∫–æ–ø–∏—è)";
            printer.additional.push(copy);
            onShowPrinterDetails(printerId);
          }
        }
      }
      break;
    case 'printerMaterials':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          const orig = printer.materials.find(m => m.id === id);
          if(orig){
            const copy = JSON.parse(JSON.stringify(orig));
            copy.id = Date.now();
            copy.name += " (–∫–æ–ø–∏—è)";
            printer.materials.push(copy);
            onShowPrinterDetails(printerId);
          }
        }
      }
      break;
  }
  saveToLocalStorage();
}
function getCurrentPrinterId(){
  // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  return parseInt(document.getElementById("printerDetailsId").textContent, 10);
}

/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ */
function renderPrintersTable(){
  const tbody = document.querySelector("#printersTable tbody");
  tbody.innerHTML = "";
  appData.printers.forEach(printer => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_printers_${printer.id}" class="printers_chk"><\/td>
      <td>${printer.name}<\/td>
      <td>${printer.cost}<\/td>
      <td>${printer.hoursToRecoup}<\/td>
      <td>${printer.power}<\/td>
      <td>${printer.maintCostHour}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditPrinter(${printer.id})">–†–µ–¥.<\/button>
          <button class="btn btn-info" onclick="onShowPrinterDetails(${printer.id})">–î–µ—Ç–∞–ª–∏<\/button>
          <button class="btn btn-warning" onclick="copyElement('printers', ${printer.id})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeletePrinter(${printer.id})">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tbody.appendChild(tr);
  });
}
function onAddPrinter(){
  const newId = Date.now();
  const p = {
    id: newId,
    name: "–ù–æ–≤—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä",
    cost: 0,
    hoursToRecoup: 1000,
    power: 0,
    maintCostHour: 0,
    additional: [],
    materials: []
  };
  appData.printers.push(p);
  saveToLocalStorage();
  renderPrintersTable();
}
function onEditPrinter(id){
  const p = appData.printers.find(x => x.id === id);
  if(!p) return;
  const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—Ç–µ—Ä–∞:", p.name);
  if(n === null) return;
  const c = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):", p.cost);
  if(c === null) return;
  const h = prompt("–ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:", p.hoursToRecoup);
  if(h === null) return;
  const pw = prompt("–ú–æ—â–Ω–æ—Å—Ç—å (–í—Ç):", p.power);
  if(pw === null) return;
  const m = prompt("–û–±—Å–ª. (‚ÇΩ/—á):", p.maintCostHour);
  if(m === null) return;
  p.name = n;
  p.cost = parseFloat(c) || 0;
  p.hoursToRecoup = parseFloat(h) || 1000;
  p.power = parseFloat(pw) || 0;
  p.maintCostHour = parseFloat(m) || 0;
  saveToLocalStorage();
  renderPrintersTable();
}
function onDeletePrinter(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä?")) return;
  appData.printers = appData.printers.filter(x => x.id !== id);
  saveToLocalStorage();
  renderPrintersTable();
  document.getElementById("printerDetails").style.display = "none";
}
function onShowPrinterDetails(id){
  const printer = appData.printers.find(p => p.id === id);
  if(!printer) return;
  document.getElementById("printerDetails").style.display = "block";
  document.getElementById("printerDetailsName").textContent = printer.name;
  document.getElementById("printerDetailsId").textContent = printer.id;
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  const tbodyAdd = document.querySelector("#printerAdditionalTable tbody");
  tbodyAdd.innerHTML = "";
  printer.additional.forEach(a => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_printerAdditional_${a.id}" class="printerAdditional_chk"><\/td>
      <td>${a.description}<\/td>
      <td>${a.cost}<\/td>
      <td>${a.hoursToRecoup}<\/td>
      <td>${a.useInCalc ? "–î–∞" : "–ù–µ—Ç"}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditPrinterAdditional(${printer.id}, ${a.id})">–†–µ–¥.<\/button>
          <button class="btn btn-warning" onclick="copyElement('printerAdditional', ${a.id})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeletePrinterAdditional(${printer.id}, ${a.id})">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tbodyAdd.appendChild(tr);
  });
  
  // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  const tbodyMat = document.querySelector("#printerMaterialsTable tbody");
  tbodyMat.innerHTML = "";
  printer.materials.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_printerMaterials_${m.id}" class="printerMaterials_chk"><\/td>
      <td>${m.name}<\/td>
      <td>${m.costPerKg}<\/td>
      <td>${m.balance}<\/td>
      <td>${m.declaredWeight || "-"}<\/td>
      <td>${m.wastePercent}<\/td>
      <td>${m.manufacturer || "-"}<\/td>
      <td>${m.productionDate || "-"}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditPrinterMaterial(${printer.id}, ${m.id})">–†–µ–¥.<\/button>
          <button class="btn btn-info" onclick="downloadMaterialLabelHtml(${m.id})">–≠—Ç–∏–∫–µ—Ç–∫–∞<\/button>
          <button class="btn btn-warning" onclick="copyElement('printerMaterials', ${m.id})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeletePrinterMaterial(${printer.id}, ${m.id})">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tbodyMat.appendChild(tr);
  });
  
  document.getElementById("btnAddPrinterAdditional").onclick = () => onAddPrinterAdditional(printer.id);
  document.getElementById("btnAddPrinterMaterial").onclick = () => onAddPrinterMaterial(printer.id);
}
function onAddPrinterAdditional(printerId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  const nid = Date.now();
  pr.additional.push({
    id: nid,
    description: "–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è",
    cost: 0,
    hoursToRecoup: 1000,
    useInCalc: true
  });
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}
function onEditPrinterAdditional(printerId, addId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  const it = pr.additional.find(a => a.id === addId);
  if(!it) return;
  const d = prompt("–û–ø–∏—Å–∞–Ω–∏–µ:", it.description);
  if(d === null) return;
  const c = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):", it.cost);
  if(c === null) return;
  const h = prompt("–ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:", it.hoursToRecoup);
  if(h === null) return;
  const used = confirm("–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç?");
  it.description = d;
  it.cost = parseFloat(c) || 0;
  it.hoursToRecoup = parseFloat(h) || 1000;
  it.useInCalc = used;
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}
function onDeletePrinterAdditional(printerId, addId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é?")) return;
  pr.additional = pr.additional.filter(a => a.id !== addId);
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}
function onAddPrinterMaterial(printerId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  const nid = Date.now();
  pr.materials.push({
    id: nid,
    name: "–ù–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª",
    costPerKg: 0,
    balance: 0,
    declaredWeight: 0,
    wastePercent: 0,
    manufacturer: "",
    productionDate: ""
  });
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}
function onEditPrinterMaterial(printerId, matId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  const mat = pr.materials.find(m => m.id === matId);
  if(!mat) return;
  const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ:", mat.name);
  if(n === null) return;
  const c = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:", mat.costPerKg);
  if(c === null) return;
  const b = prompt("–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥):", mat.balance);
  if(b === null) return;
  const dW = prompt("–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥):", mat.declaredWeight);
  if(dW === null) return;
  const w = prompt("–û—Ç—Ö–æ–¥ (%):", mat.wastePercent);
  if(w === null) return;
  const manuf = prompt("–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:", mat.manufacturer || "");
  if(manuf === null) return;
  const prodDate = prompt("–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (DD.MM.YYYY):", mat.productionDate || "");
  if(prodDate === null) return;
  mat.name = n;
  mat.costPerKg = parseFloat(c) || 0;
  mat.balance = parseFloat(b) || 0;
  mat.declaredWeight = parseFloat(dW) || 0;
  mat.wastePercent = parseFloat(w) || 0;
  mat.manufacturer = manuf;
  mat.productionDate = prodDate;
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}
function onDeletePrinterMaterial(printerId, matId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª?")) return;
  pr.materials = pr.materials.filter(m => m.id !== matId);
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}

/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ */
function renderGlobalMaterialsTable(){
  const tb = document.querySelector("#materialsTable tbody");
  tb.innerHTML = "";
  appData.materials.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_globalMaterials_${m.id}" class="globalMaterials_chk"><\/td>
      <td>${m.name}<\/td>
      <td>${m.costPerKg}<\/td>
      <td>${m.balance}<\/td>
      <td>${m.declaredWeight || "-"}<\/td>
      <td>${m.wastePercent}<\/td>
      <td>${m.manufacturer || "-"}<\/td>
      <td>${m.productionDate || "-"}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditGlobalMaterial(${m.id})">–†–µ–¥.<\/button>
          <button class="btn btn-info" onclick="downloadMaterialLabelHtml(${m.id})">–≠—Ç–∏–∫–µ—Ç–∫–∞<\/button>
          <button class="btn btn-warning" onclick="copyElement('globalMaterials', ${m.id})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeleteGlobalMaterial(${m.id})">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tb.appendChild(tr);
  });
}
function onAddGlobalMaterial(){
  const nid = Date.now();
  let name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞:", "–ù–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª");
  if(name === null) return;
  let cost = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:", "0");
  if(cost === null) return;
  let balance = prompt("–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥):", "0");
  if(balance === null) return;
  let declared = prompt("–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥):", "0");
  if(declared === null) return;
  let waste = prompt("–û—Ç—Ö–æ–¥ (%):", "0");
  if(waste === null) return;
  let manuf = prompt("–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:", "");
  if(manuf === null) return;
  let prodDate = prompt("–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (DD.MM.YYYY):", "");
  if(prodDate === null) return;
  appData.materials.push({
    id: nid,
    name: name,
    costPerKg: parseFloat(cost) || 0,
    balance: parseFloat(balance) || 0,
    declaredWeight: parseFloat(declared) || 0,
    wastePercent: parseFloat(waste) || 0,
    manufacturer: manuf,
    productionDate: prodDate
  });
  saveToLocalStorage();
  renderGlobalMaterialsTable();
}
function onEditGlobalMaterial(id){
  const m = appData.materials.find(x => x.id === id);
  if(!m) return;
  const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞:", m.name);
  if(n === null) return;
  const c = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:", m.costPerKg);
  if(c === null) return;
  const b = prompt("–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥):", m.balance);
  if(b === null) return;
  const d = prompt("–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥):", m.declaredWeight);
  if(d === null) return;
  const w = prompt("–û—Ç—Ö–æ–¥ (%):", m.wastePercent);
  if(w === null) return;
  const manuf = prompt("–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:", m.manufacturer || "");
  if(manuf === null) return;
  const prodDate = prompt("–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (DD.MM.YYYY):", m.productionDate || "");
  if(prodDate === null) return;
  m.name = n;
  m.costPerKg = parseFloat(c) || 0;
  m.balance = parseFloat(b) || 0;
  m.declaredWeight = parseFloat(d) || 0;
  m.wastePercent = parseFloat(w) || 0;
  m.manufacturer = manuf;
  m.productionDate = prodDate;
  saveToLocalStorage();
  renderGlobalMaterialsTable();
}
function onDeleteGlobalMaterial(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª?")) return;
  appData.materials = appData.materials.filter(x => x.id !== id);
  saveToLocalStorage();
  renderGlobalMaterialsTable();
}

/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥–æ–≤ */
function renderGlobalAdditionalTable(){
  const tb = document.querySelector("#additionalGlobalTable tbody");
  tb.innerHTML = "";
  appData.additionalGlobal.forEach(a => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_globalAdditional_${a.id}" class="globalAdditional_chk"><\/td>
      <td>${a.description}<\/td>
      <td>${a.cost}<\/td>
      <td>${a.hoursToRecoup || 1000}<\/td>
      <td>${a.useInCalc ? "–î–∞" : "–ù–µ—Ç"}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditGlobalAdditional(${a.id})">–†–µ–¥.<\/button>
          <button class="btn btn-warning" onclick="copyElement('globalAdditional', ${a.id})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeleteGlobalAdditional(${a.id})">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tb.appendChild(tr);
  });
}
function onAddGlobalAdditional(){
  const nid = Date.now();
  appData.additionalGlobal.push({
    id: nid,
    description: "–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è",
    cost: 0,
    hoursToRecoup: 1000,
    useInCalc: true
  });
  saveToLocalStorage();
  renderGlobalAdditionalTable();
}
function onEditGlobalAdditional(id){
  const x = appData.additionalGlobal.find(a => a.id === id);
  if(!x) return;
  const d = prompt("–û–ø–∏—Å–∞–Ω–∏–µ:", x.description);
  if(d === null) return;
  const c = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):", x.cost);
  if(c === null) return;
  const hh = prompt("–ß–∞—Å—ã –æ–∫—É–ø.", x.hoursToRecoup || 1000);
  if(hh === null) return;
  const used = confirm("–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç?");
  x.description = d;
  x.cost = parseFloat(c) || 0;
  x.hoursToRecoup = parseFloat(hh) || 1000;
  x.useInCalc = used;
  saveToLocalStorage();
  renderGlobalAdditionalTable();
}
function onDeleteGlobalAdditional(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é?")) return;
  appData.additionalGlobal = appData.additionalGlobal.filter(a => a.id !== id);
  saveToLocalStorage();
  renderGlobalAdditionalTable();
}

/* –§—É–Ω–∫—Ü–∏–∏ –∫–∞–ª—å–∫—É–ª—è—Ü–∏–∏ */
function renderCalcPrinters(){
  const c = document.getElementById("calcPrintersContainer");
  c.innerHTML = "";
  appData.printers.forEach(pr => {
    const block = document.createElement("div");

    block.className = "border p-3 mb-3";
    block.innerHTML = `
      <h5>–ü—Ä–∏–Ω—Ç–µ—Ä: ${pr.name} (ID: ${pr.id})<\/h5>
      <div class="small-text mb-2">
        –ú–æ—â–Ω–æ—Å—Ç—å: ${pr.power}–í—Ç, –û–±—Å–ª: ${pr.maintCostHour}‚ÇΩ/—á, –ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏: ${pr.hoursToRecoup}.
      <\/div>
      <table class="table table-bordered table-sm mb-2" id="calcModelsTable_${pr.id}">
        <thead>
          <tr>
            <th>–ò–º—è –º–æ–¥–µ–ª–∏<\/th>
            <th>–°—Ç–∞—Ç—É—Å<\/th>
            <th>–ß–∞—Å—ã –ø–µ—á–∞—Ç–∏<\/th>
            <th>–í–µ—Å (–≥)<\/th>
            <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
            <th>–î–µ–π—Å—Ç–≤–∏—è<\/th>
          <\/tr>
        <\/thead>
        <tbody><\/tbody>
      <\/table>
      <button class="btn btn-sm btn-primary" onclick="addModelRow(${pr.id}, {})">–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å<\/button>
    `;
    c.appendChild(block);
  });
}
function addModelRow(printerId, modelData) {
  const table = document.getElementById(`calcModelsTable_${printerId}`);
  if(!table) return;
  const tbody = table.querySelector("tbody");
  const idx = tbody.rows.length + 1;
  const statuses = [
    {val:"new", text:"–ù–æ–≤–∞—è"},
    {val:"inprogress", text:"–ü–µ—á–∞—Ç—å"},
    {val:"done", text:"–ì–æ—Ç–æ–≤–∞"},
    {val:"canceled", text:"–û—Ç–º–µ–Ω–µ–Ω–∞"}
  ];
  const optsStatus = statuses.map(s =>
    `<option value="${s.val}" ${(modelData.status === s.val) ? "selected" : ""}>${s.text}<\/option>`
  ).join("");
  const mats = getAllMaterialsForPrinter(printerId);
  const optsMat = mats.map(m =>
    `<option value="${m.id}" ${(modelData.materialId == m.id) ? "selected" : ""}>${m.name}<\/option>`
  ).join("");
  const uniqueId = Date.now() + Math.floor(Math.random()*1000);
  const nameId = `modelName_${printerId}_${uniqueId}`;
  const statusId = `modelStatus_${printerId}_${uniqueId}`;
  const hoursId = `modelHours_${printerId}_${uniqueId}`;
  const weightId = `modelWeight_${printerId}_${uniqueId}`;
  const materialId = `modelMaterial_${printerId}_${uniqueId}`;
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="text" class="form-control form-control-sm" id="${nameId}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${modelData.name || ''}" /><\/td>
    <td>
      <select class="form-select form-select-sm" id="${statusId}">
        ${optsStatus}
      <\/select>
    <\/td>
    <td><input type="text" class="form-control form-control-sm time-input" 
             id="${hoursId}" placeholder="—á:–º" 
             value="${modelData.hours ? formatTimeForDisplay(modelData.hours) : ''}" 
             onblur="this.value = formatTimeForDisplay(handleTimeInput({target: {value: this.value}}))" /><\/td>
    <td><input type="number" step="0.1" class="form-control form-control-sm" id="${weightId}" placeholder="–≥" value="${modelData.weight || ''}" /><\/td>
    <td>
      <select class="form-select form-select-sm" id="${materialId}">
        <option value="">-–ú–∞—Ç–µ—Ä–∏–∞–ª-<\/option>
        ${optsMat}
      <\/select>
    <\/td>
    <td><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">–£–¥–ª.<\/button><\/td>
  `;
  tbody.appendChild(tr);
}
function getAllMaterialsForPrinter(printerId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return [];
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º –æ—Å—Ç–∞—Ç–∫–æ–º
  const globalMats = appData.materials.filter(m => m.balance > 0);
  const printerMats = pr.materials.filter(m => m.balance > 0);
  return [...globalMats, ...printerMats];
}

let lastCalcFullData = null;




function onCalculateAll() {
  const calcName = document.getElementById("calcName").value.trim();
  const clientName = document.getElementById("calcClientName").value.trim();
  const orderStatus = document.getElementById("calcOrderStatus").value;
  const opRate = parseFloat(document.getElementById("calcOperatorRate").value) || 0;
  const whDay = parseFloat(document.getElementById("calcWorkHoursDay").value) || 8;
  const cKwh = parseFloat(document.getElementById("calcCostKwh").value) || 0;
  const tPercent = parseFloat(document.getElementById("calcTaxPercent").value) || 0;
  const ship = parseFloat(document.getElementById("calcShipping").value) || 0;
  const sDate = document.getElementById("calcStartDate").value;
  const parallelMode = document.getElementById("calcParallelPrinting").value;
  const markupPercent = parseFloat(document.getElementById("calcMarkupPercent").value) || 0;
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–∞—Å—á—ë—Ç–∞
  appData.calcSettings.operatorRate = opRate;
  appData.calcSettings.workHoursDay = whDay;
  appData.calcSettings.costKwh = cKwh;
  appData.calcSettings.taxPercent = tPercent;
  appData.calcSettings.shipping = ship;
  appData.calcSettings.startDate = sDate;
  appData.calcSettings.parallelPrinting = parallelMode;
  appData.calcSettings.markupPercent = markupPercent;
  
  saveToLocalStorage();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  let calcData = {};
  appData.printers.forEach(pr => {
    const table = document.getElementById(`calcModelsTable_${pr.id}`);
    if (!table) return;
    const rows = table.querySelectorAll("tbody tr");
    let modelsData = [];
    rows.forEach(row => {
      const inpName = row.querySelectorAll("input")[0];
      const selStatus = row.querySelectorAll("select")[0];
      const inpH = row.querySelectorAll("input")[1];
      const inpW = row.querySelectorAll("input")[2];
      const selM = row.querySelectorAll("select")[1];
      const h = handleTimeInput({target: {value: inpH.value}}); // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥
      const w = parseFloat(inpW.value) || 0;
      modelsData.push({
        name: inpName.value.trim() || "–ú–æ–¥–µ–ª—å",
        status: selStatus.value || "new",
        hours: h,
        weight: w,
        materialId: parseInt(selM.value, 10)
      });
    });
    calcData[pr.id] = modelsData;
  });
  
  // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º —Å—É–º–º–∞—Ä–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–ª–∞—Å—Ç–∏–∫–∞ (–≤ –≥—Ä–∞–º–º–∞—Ö) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø–æ –≤—Å–µ–º—É —Ä–∞—Å—á—ë—Ç—É
  let materialConsumption = {};
  
  // –†–∞—Å—á—ë—Ç –∑–∞—Ç—Ä–∞—Ç –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º
  let detailsByPrinter = [];
  let sumWithoutTax = 0;
  let finalTimeAllPrinters = 0;
  let maxPrinterTime = 0;
  
  appData.printers.forEach(pr => {
    const table = document.getElementById(`calcModelsTable_${pr.id}`);
    if (!table) return;
    
    let prTime = 0;
    let prCostNoTax = 0;
    let lines = [];
    const rows = table.querySelectorAll("tbody tr");
    rows.forEach(row => {
      const inpName = row.querySelectorAll("input")[0];
      const selStatus = row.querySelectorAll("select")[0];
      const inpH = row.querySelectorAll("input")[1];
      const inpW = row.querySelectorAll("input")[2];
      const selM = row.querySelectorAll("select")[1];
      const h = handleTimeInput({target: {value: inpH.value}}); // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥
      const w = parseFloat(inpW.value) || 0;
      const mid = parseInt(selM.value, 10);
      if (!mid || h <= 0 || w <= 0) return;
      
      prTime += h;
      
      const mat = getAllMaterialsForPrinter(pr.id).find(x => x.id === mid);
      if (!mat) return;
      
      const costPH = (pr.hoursToRecoup > 0) ? pr.cost / pr.hoursToRecoup : 0;
      const costPrinterPart = h * costPH;
      // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—Ö–æ–¥ –ø–ª–∞—Å—Ç–∏–∫–∞ —Å —É—á—ë—Ç–æ–º –æ—Ç—Ö–æ–¥–æ–≤ (–≤ –≥—Ä–∞–º–º–∞—Ö)
      const realW = w * (1 + (mat.wastePercent / 100));
      // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
      materialConsumption[mid] = (materialConsumption[mid] || 0) + realW;
      
      const costPerGram = mat.costPerKg / 1000;
      const costMaterial = realW * costPerGram;
      
      const costElectric = (pr.power / 1000) * h * cKwh;
      const costMaint = pr.maintCostHour * h;
      const subTotalModel = costPrinterPart + costMaterial + costElectric + costMaint;
      
      prCostNoTax += subTotalModel;
      
      lines.push({
        name: inpName.value.trim() || "–ú–æ–¥–µ–ª—å",
        status: selStatus.value || "new",
        hours: h,
        weight: w,
        matName: mat.name,
        realWeight: realW,
        costPrinterPart: costPrinterPart,
        costMaterial: costMaterial,
        costElectric: costElectric,
        costMaintenance: costMaint,
        subTotalModel: subTotalModel,
        materialData: {
          id: mat.id,
          declaredWeight: mat.declaredWeight,
          manufacturer: mat.manufacturer,
          productionDate: mat.productionDate
        }
      });
    });
    
    // –†–∞—Å—á—ë—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ (–ø–æ –≤—Å–µ–º –µ–≥–æ —Ä–∞—Å—Ö–æ–¥–Ω—ã–º —Å—Ç–∞—Ç—å—è–º)
    let printerAdditionalDetails = [];
    let sumPrAddFull = 0;
    pr.additional.filter(a => a.useInCalc !== false).forEach(a => { sumPrAddFull += a.cost; });
    pr.additional.filter(a => a.useInCalc !== false).forEach(a => {
      let costDistributed = 0;
      if (pr.hoursToRecoup > 0) {
        costDistributed = (a.cost / pr.hoursToRecoup) * prTime;
      }
      printerAdditionalDetails.push({
         description: a.description,
         baseCost: a.cost,
         hoursToRecoup: a.hoursToRecoup,
         costDistributed: costDistributed
      });
    });
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—É–º–º—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –∫ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
    if (pr.hoursToRecoup > 0 && sumPrAddFull > 0) {
      prCostNoTax += (sumPrAddFull / pr.hoursToRecoup) * prTime;
    }
    
    if (parallelMode === "no") {
      finalTimeAllPrinters += prTime;
    } else {
      if (prTime > maxPrinterTime) maxPrinterTime = prTime;
    }
    
    sumWithoutTax += prCostNoTax;
    detailsByPrinter.push({
      printerId: pr.id,
      printerName: pr.name,
      linesDetail: lines,
      printerTime: prTime,
      subTotal: prCostNoTax,
      additionalDetails: printerAdditionalDetails
    });
  });
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –æ—Å—Ç–∞—Ç–∫–∞
  let warnings = [];
  for (let mid in materialConsumption) {
    const required = materialConsumption[mid];
    const mat = findMaterialById(parseInt(mid, 10));
    if (mat && required > (mat.balance * 1000)) {
      warnings.push(`–ú–∞—Ç–µ—Ä–∏–∞–ª–∞ "${mat.name}" –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: —Ç—Ä–µ–±—É–µ—Ç—Å—è ${required.toFixed(2)} –≥, –æ—Å—Ç–∞—Ç–æ–∫ ${(mat.balance * 1000).toFixed(2)} –≥.`);
    }
  }
  
  let finalTimeOperator = (parallelMode === "yes") ? maxPrinterTime : finalTimeAllPrinters;
  const totalOperatorCost = finalTimeOperator * opRate;
  
  let sumGlobalAdd = 0;
  let globalAdditionalDetails = [];
  appData.additionalGlobal.forEach(g => {
    if (!g.useInCalc) return;
    const costPerHour = (g.hoursToRecoup > 0) ? g.cost / g.hoursToRecoup : 0;
    const cVal = costPerHour * finalTimeOperator;
    sumGlobalAdd += cVal;
    globalAdditionalDetails.push({
      id: g.id,
      description: g.description,
      baseCost: g.cost,
      hoursToRecoup: g.hoursToRecoup,
      costDistributed: cVal
    });
  });
  
    let totalLabelsCost = 0;
  if(appData.labelSettings.printLabels) {
    const labelCost = appData.labelSettings.costPerLabel || 0;
    const totalModels = Object.values(calcData).reduce((acc, models) => acc + models.length, 0);
    totalLabelsCost = totalModels * labelCost;
  }

  
  let subtotal = sumWithoutTax + sumGlobalAdd + ship + totalOperatorCost + totalLabelsCost;
  
  if (markupPercent > 0) {
    subtotal *= (1 + markupPercent / 100);
  }
  const finalSum = subtotal / (1 - tPercent / 100);
  const taxAmount = finalSum - subtotal;
  
  let finDateStr = calcFinishDate(sDate, Math.ceil(finalTimeOperator / (whDay || 8)));
  
  let htmlRes = `<strong>–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:<\/strong><br/>`;
  htmlRes += `–ù–∞–∑–≤–∞–Ω–∏–µ: ${calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}, –ö–ª–∏–µ–Ω—Ç: ${clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}, –°—Ç–∞—Ç—É—Å: ${orderStatus}<br/>`;
  htmlRes += `–£—á–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–µ—á–∞—Ç–∏: ${(parallelMode === "yes") ? "–î–∞" : "–ù–µ—Ç"}<br/>`;
  htmlRes += `–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${formatTimeForDisplay(finalTimeOperator)} —á.<br/>`;
  htmlRes += `–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${totalOperatorCost.toFixed(2)} ‚ÇΩ<br/>`;
  htmlRes += `–ù–∞—Ü–µ–Ω–∫–∞: ${markupPercent}%.<br/>`;
  htmlRes += `–£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞: ${ship.toFixed(2)} ‚ÇΩ<br/>`;
  htmlRes += `–°—Ç–æ–∏–º–æ—Å—Ç—å —ç—Ç–∏–∫–µ—Ç–æ–∫: ${totalLabelsCost.toFixed(2)} ‚ÇΩ<br/>`;
  htmlRes += `–ü–æ–¥–∏—Ç–æ–≥: ${subtotal.toFixed(2)} ‚ÇΩ<br/>`;
  htmlRes += `–û–±—â–∏–π –Ω–∞–ª–æ–≥ (${tPercent}%): ${taxAmount.toFixed(2)} ‚ÇΩ<br/>`;
  htmlRes += `<strong>–ò—Ç–æ–≥–æ (—Å —É—á–µ—Ç–æ–º –Ω–∞—Ü–µ–Ω–∫–∏, –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –Ω–∞–ª–æ–≥–∞): ${finalSum.toFixed(2)} ‚ÇΩ<\/strong><br/>`;
 
  // –í—ã–≤–æ–¥ —Ü–µ–Ω—ã –∑–∞ 1 –≥—Ä–∞–º–º
  const totalWeight = detailsByPrinter.reduce((acc, printer) => 
    acc + printer.linesDetail.reduce((sum, line) => sum + line.realWeight, 0), 0);
  const pricePerGram = totalWeight > 0 ? finalSum / totalWeight : 0;
  htmlRes += `<strong>–¶–µ–Ω–∞ –∑–∞ 1 –≥—Ä–∞–º–º: ${pricePerGram.toFixed(2)} ‚ÇΩ<\/strong><br/>`;

 if (finDateStr) {
    htmlRes += `–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä–Ω–æ): ${finDateStr}<br/>`;
  }
  if (warnings.length > 0) {
    htmlRes += `<div class="alert alert-warning mt-2">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:<br/>` + warnings.join("<br/>") + `<\/div>`;
  }
  htmlRes += `<hr/><strong>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º:<\/strong><br/>`;
  detailsByPrinter.forEach(d => {

if ((d.linesDetail.length === 0 || !d.linesDetail) && d.printerTime <= 0) {
  return;
}


	  
    htmlRes += `<div style="margin-top:1em;">`;
    htmlRes += `<strong>${d.printerName} (ID: ${d.printerId})<\/strong><br/>`;
    htmlRes += `–í—Ä–µ–º—è: ${d.printerTime.toFixed(2)} —á; –°—É–º–º–∞: ${d.subTotal.toFixed(2)} ‚ÇΩ<br/>`;
    if (d.linesDetail.length > 0) {
      htmlRes += `<div class="table-responsive"><table class="table table-sm table-bordered mt-1" style="max-width:800px;">`;
      htmlRes += `<thead><tr>
        <th>–ú–æ–¥–µ–ª—å<\/th>
        <th>–°—Ç–∞—Ç—É—Å<\/th>
        <th>–ß–∞—Å—ã<\/th>
        <th>–í–µ—Å (–≥)<\/th>
        <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
        <th>–í–µ—Å+–æ—Ç—Ö–æ–¥<\/th>
        <th>–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ (‚ÇΩ)<\/th>
        <th>–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (‚ÇΩ)<\/th>
        <th>–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ (‚ÇΩ)<\/th>
        <th>–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (‚ÇΩ)<\/th>
        <th>–ò—Ç–æ–≥–æ (‚ÇΩ)<\/th>
        <th>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/th>
      <\/tr><\/thead><tbody>`;
      d.linesDetail.forEach(ln => {
        htmlRes += `<tr>
          <td>${ln.name}<\/td>
          <td>${ln.status}<\/td>
          <td>${formatTimeForDisplay(ln.hours)}<\/td>
          <td>${ln.weight.toFixed(2)}<\/td>
          <td>${ln.matName}<\/td>
          <td>${ln.realWeight.toFixed(2)}<\/td>
          <td>${ln.costPrinterPart.toFixed(2)}<\/td>
          <td>${ln.costMaterial.toFixed(2)}<\/td>
          <td>${ln.costElectric.toFixed(2)}<\/td>
          <td>${ln.costMaintenance.toFixed(2)}<\/td>
          <td>${ln.subTotalModel.toFixed(2)}<\/td>
          <td>
            <button class="btn btn-sm btn-outline-secondary"
              onclick="downloadThermoLabelHtml('${ln.name}', '${d.printerName}', '${ln.matName}', '${ln.hours.toFixed(2)}', '${ln.weight.toFixed(2)}')">
              –≠—Ç–∏–∫–µ—Ç–∫–∞
            <\/button>
          <\/td>
        <\/tr>`;
      });
      htmlRes += `<\/tbody><\/table></div>`;
    }

    // –í—ã–≤–æ–¥ —Ç–∞–±–ª–∏—Ü—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ —Å –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º–æ–π
    if (d.additionalDetails && d.additionalDetails.length > 0) {
      let htmlResadditionalDetails = `<hr/><strong>–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞:<\/strong>`;
      htmlResadditionalDetails += `<table class="table table-sm table-bordered mt-1" style="max-width:600px;">`;
      htmlResadditionalDetails += `<thead><tr><th>–û–ø–∏—Å–∞–Ω–∏–µ<\/th><th>–ò—Å—Ö. —Å—Ç–æ–∏–º.<\/th><th>–ß–∞—Å—ã –æ–∫—É–ø.<\/th><th>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (‚ÇΩ)<\/th><\/tr><\/thead><tbody>`;
      let sumPrinterAdditional = 0;
      d.additionalDetails.forEach(ad => {
        sumPrinterAdditional += ad.costDistributed;
        htmlResadditionalDetails += `<tr>
          <td>${ad.description}<\/td>
          <td>${ad.baseCost.toFixed(2)}<\/td>
          <td>${ad.hoursToRecoup}<\/td>
          <td>${ad.costDistributed.toFixed(2)}<\/td>
        <\/tr>`;
      });
      htmlResadditionalDetails += `<\/tbody><\/table>`;
      htmlResadditionalDetails += `–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞: ${sumPrinterAdditional.toFixed(2)} ‚ÇΩ<br/>`;
	    if(sumPrinterAdditional > 0)
	    htmlRes += htmlResadditionalDetails;
    }
	  
    htmlRes += `<\/div>`;
  });
  
  if (globalAdditionalDetails.length > 0) {
    htmlRes += `<hr/><strong>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ):<\/strong>`;
    htmlRes += `<table class="table table-sm table-bordered mt-1" style="max-width:600px;">`;
    htmlRes += `<thead><tr><th>–û–ø–∏—Å–∞–Ω–∏–µ<\/th><th>–ò—Å—Ö. —Å—Ç–æ–∏–º.<\/th><th>–ß–∞—Å—ã –æ–∫—É–ø.<\/th><th>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (‚ÇΩ)<\/th><\/tr><\/thead><tbody>`;
    globalAdditionalDetails.forEach(gd => {
      htmlRes += `<tr>
        <td>${gd.description}<\/td>
        <td>${gd.baseCost.toFixed(2)}<\/td>
        <td>${gd.hoursToRecoup}<\/td>
        <td>${gd.costDistributed.toFixed(2)}<\/td>
      <\/tr>`;
    });
    htmlRes += `<\/tbody><\/table>`;
    htmlRes += `–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: ${sumGlobalAdd.toFixed(2)} ‚ÇΩ<br/>`;
  }
  
  document.getElementById("calcResult").style.display = "block";
  document.getElementById("calcResult").innerHTML = htmlRes;
  
  lastCalcFullData = {
    calcName,
    clientName,
    orderStatus,
    total: finalSum,
    totalHours: finalTimeOperator,
    taxPercent: tPercent,
    shipping: ship,
    detailsByPrinter,
    costKwh: cKwh,
    operatorRate: opRate,
    totalOperatorCost: totalOperatorCost,
    calcData,
    globalAdditional: {
      sumGlobalAdd,
      taxAmount,
      details: globalAdditionalDetails
    },
    parallelMode,
    markupPercent
  };
  
  lastCalcFullData.totalLabelsCost = totalLabelsCost;
  
  const dtStr = new Date().toLocaleString("ru-RU");
  const existingIndex = appData.calcHistory.findIndex(entry => entry.calcName === calcName);
  const newEntry = {
    timestamp: Date.now(),
    dateStr: dtStr,
    calcName,
    clientName,
    orderStatus,
    total: finalSum,
    totalHours: finalTimeOperator,
    taxPercent: tPercent,
    shipping: ship,
    operatorRate: opRate,
    costKwh: cKwh,
    totalOperatorCost: totalOperatorCost,
    details: detailsByPrinter,
    calcData,
    globalAdditional: {
      sumGlobalAdd,
      taxAmount,
      details: globalAdditionalDetails
    },
    parallelMode,
    markupPercent
  };
  if (existingIndex !== -1) {
    appData.calcHistory[existingIndex] = newEntry;
  } else {
    appData.calcHistory.push(newEntry);
  }
  saveToLocalStorage();
  renderHistoryTable();
}

function findMaterialById(mid) {
  let mat = appData.materials.find(m => m.id === mid);
  if (mat) return mat;
  for (let p of appData.printers) {
    mat = p.materials.find(m => m.id === mid);
    if (mat) return mat;
  }
  return null;
}

function calcFinishDate(sv, days){
  if(!sv) return "";
  try{
    const d = new Date(sv);
    d.setDate(d.getDate()+days);
    return d.toLocaleDateString("ru-RU");
  } catch(e){
    return "";
  }
}
function renderHistoryTable(){
  const tb = document.querySelector("#historyTable tbody");
  tb.innerHTML = "";
  appData.calcHistory.forEach(h => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${h.dateStr}<\/td>
      <td>${h.calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}<\/td>
      <td>${h.clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}<\/td>
      <td>
        <select class="form-select form-select-sm" onchange="onChangeCalcHistoryStatus(${h.timestamp}, this.value)">
          <option value="new" ${h.orderStatus==="new"?"selected":""}>–ù–æ–≤—ã–π<\/option>
          <option value="inprogress" ${h.orderStatus==="inprogress"?"selected":""}>–í —Ä–∞–±–æ—Ç–µ<\/option>
          <option value="done" ${h.orderStatus==="done"?"selected":""}>–ó–∞–≤–µ—Ä—à—ë–Ω<\/option>
          <option value="canceled" ${h.orderStatus==="canceled"?"selected":""}>–û—Ç–º–µ–Ω—ë–Ω<\/option>
        <\/select>
      <\/td>
      <td>${h.total.toFixed(2)}<\/td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="onEditCalcHistory(${h.timestamp})">–†–µ–¥–∞–∫—Ç.<\/button>
        <button class="btn btn-sm btn-danger" onclick="onDeleteCalcHistoryEntry(${h.timestamp})">–£–¥–∞–ª–∏—Ç—å<\/button>
      <\/td>
    `;
    tb.appendChild(tr);
  });
}
function onDeleteCalcHistoryEntry(timestamp) {
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?")) return;
  appData.calcHistory = appData.calcHistory.filter(entry => entry.timestamp !== timestamp);
  saveToLocalStorage();
  renderHistoryTable();
}
function onClearCalcHistory(){
  if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?")) return;
  appData.calcHistory = [];
  saveToLocalStorage();
  renderHistoryTable();
}
function onExportHistory(){
  const js = JSON.stringify(appData.calcHistory, null, 2);
  document.getElementById("exportArea").value = js;
}
function onImportHistory(){
  const s = document.getElementById("importArea").value.trim();
  if(!s) {
    if(confirm("–ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
    return;
  }
  try{
    const obj = JSON.parse(s);
    if(!Array.isArray(obj)){
      alert("–û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤.");
      return;
    }
    appData.calcHistory = obj;
    saveToLocalStorage();
    renderHistoryTable();
    alert("–ò–º–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à—ë–Ω.");
  } catch(e){
    alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏: " + e);
  }
}

function onChangeCalcHistoryStatus(timestamp, newStatus){
  const it = appData.calcHistory.find(x => x.timestamp === timestamp);
  if(!it) return;
  it.orderStatus = newStatus;
  saveToLocalStorage();
}

/* –§—É–Ω–∫—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ JSON */
function onExportJson(){
  const s = JSON.stringify(appData, null, 2);
  document.getElementById("exportArea").value = s;
}
function onImportJson(){
  const s = document.getElementById("importArea").value.trim();
  if(!s){
    if(confirm("–ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
    return;
  }
  try{
    const obj = JSON.parse(s);
    appData = obj;
    saveToLocalStorage();
    initAll();
    alert("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.");
  } catch(e){
    alert("–û—à–∏–±–∫–∞: " + e);
  }
}
function saveLabelSettings(){
  const cn = document.getElementById("companyNameInput").value.trim();
  const cl = document.getElementById("chatLinkInput").value.trim();
  const cost = parseFloat(document.getElementById("labelCostInput").value) || 0;
  const print = document.getElementById("printLabelsCheckbox").checked;
  
  appData.labelSettings = {
    companyName: cn || "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è",
    chatLink: cl || "https://t.me/example",
    costPerLabel: cost,
    printLabels: print
  };
  saveToLocalStorage();
  alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
}

/* –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞ */
function generateQRCodeCanvas(data, size, callback){
  const tempDiv = document.createElement("div");
  new QRCode(tempDiv, {
    text: data,
    width: size,
    height: size,
    correctLevel: QRCode.CorrectLevel.H
  });
  setTimeout(() => {
    const qrCanvas = tempDiv.querySelector("canvas");
    callback(qrCanvas);
  }, 100);
}

function downloadThermoLabelHtml(modelName, printerName, materialName, hours, weight) {
  const qrSize = 100;
  generateQRCodeCanvas(appData.labelSettings.chatLink, qrSize, function(qrCanvas) {
    const qrDataUrl = qrCanvas ? qrCanvas.toDataURL("image/png") : "";
    const htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=58mm, initial-scale=1">
  <title>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/title>
  <style>
    body { width: 58mm; height: 40mm; margin: 0; padding: 0; font-family: sans-serif; }
    #labelContainer {
      width: 58mm;
      height: 40mm;
      padding: 2mm;
      box-sizing: border-box;
      position: relative;
    }
    .label-header {
      text-align: center;
      font-size: 12pt;
      font-weight: bold;
      margin-bottom: 2mm;
    }
    .label-content {
      font-size: 10pt;
      line-height: 1.2;
    }
    .label-content div { margin-bottom: 1mm; }
    .qr-code {
      position: absolute;
      bottom: 2mm;
      right: 2mm;
      width: 20mm;
      height: 20mm;
    }
  <\/style>
<\/head>
<body>
<div id="labelContainer">
  <div class="label-header">${appData.labelSettings.companyName}<\/div>
  <div class="label-content">
    <div style="text-align: center;">${modelName}<\/div>
    <div>${printerName}<\/div>
    <div>${materialName}<\/div>
    <div>${formatTimeForDisplay(hours)}<\/div>
    <div>${weight} –≥<\/div>
    <div>${new Date().toLocaleDateString("ru-RU")}<\/div>
  <\/div>
  <img class="qr-code" src="${qrDataUrl}" alt="QR-–∫–æ–¥">
<\/div>
<\/body>
<\/html>
    `.trim();
    const blob = new Blob([htmlContent], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `ThermoLabel_${modelName}_${Date.now()}.html`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  });
}

/* –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç—Ç–∏–∫–µ—Ç–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 30x20 –º–º */
function downloadMaterialLabelHtml(materialId) {
  // –ò—â–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª —Å–Ω–∞—á–∞–ª–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö, –∑–∞—Ç–µ–º –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
  let mat = appData.materials.find(m => m.id === materialId);
  if(!mat) {
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö, –ø—Ä–æ–≤–µ—Ä—è–µ–º —É –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
    for(let p of appData.printers) {
      mat = p.materials.find(m => m.id === materialId);
      if(mat) break;
    }
  }
  if(!mat) { alert("–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω."); return; }
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —ç—Ç–∏–∫–µ—Ç–∫–∏ (30x20 –º–º)
  const htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=30mm, initial-scale=1">
  <title>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/title>
  <style>
    body { width: 30mm; height: 20mm; margin: 0; padding: 0; font-family: sans-serif; font-size: 8pt; }
    #labelContainer {
      width: 30mm;
      height: 20mm;
      padding: 1mm;
      box-sizing: border-box;
      position: relative;
      border: 1px solid #000;
    }
    .label-header { text-align: center; font-weight: bold; margin-bottom: 1mm; }
    .label-content div { margin-bottom: 0.5mm; }
  <\/style>
<\/head>
<body>
  <div id="labelContainer">
    <div class="label-header">${mat.name}<\/div>
    <div class="label-content">
      <div>${mat.declaredWeight || "-"} –∫–≥<\/div>
      <div>${mat.manufacturer || "-"}<\/div>
      <div>${mat.productionDate || "-"}<\/div>
    <\/div>
  <\/div>
<\/body>
<\/html>
  `.trim();
  
  const blob = new Blob([htmlContent], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `MaterialLabel_${mat.name}_${Date.now()}.html`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function downloadFullDetailedCalculation(){
  if(!lastCalcFullData){ alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–∞."); return; }
  const h = generateMaxDetailedCalcHtml(lastCalcFullData);
  const b = new Blob([h], {type:"text/html"});
  const u = URL.createObjectURL(b);
  const l = document.createElement("a");
  l.href = u;
  l.download = `FullDetailedCalc_${Date.now()}.html`;
  document.body.appendChild(l);
  l.click();
  document.body.removeChild(l);
  URL.revokeObjectURL(u);
}
function generateMaxDetailedCalcHtml(d) {
  let s = `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç<\/title>
  <style>
    body { font-family: sans-serif; margin:20px; }
    .printer-block { margin:10px 0; padding:5px; border:1px dashed #999; }
    table { border-collapse: collapse; }
    td, th { border:1px solid #999; padding:4px 6px; }
  <\/style>
<\/head>
<body>
  <h1>–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç<\/h1>
  <p>–ù–∞–∑–≤–∞–Ω–∏–µ: ${d.calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}, –ö–ª–∏–µ–Ω—Ç: ${d.clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}, –°—Ç–∞—Ç—É—Å: ${d.orderStatus || "?"}<\/p>
  <p>–ò—Ç–æ–≥: <strong>${d.total.toFixed(2)} ‚ÇΩ<\/strong><\/p>
  <p>–û–ø–µ—Ä–∞—Ç–æ—Ä —á.: ${formatTimeForDisplay(d.totalHours)} —á, –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${d.totalOperatorCost.toFixed(2)} ‚ÇΩ, –ù–∞–ª–æ–≥: ${d.taxPercent}%, –£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞: ${d.shipping}‚ÇΩ, –≠–ª.: ${d.costKwh}‚ÇΩ/–∫–í—Ç‚ãÖ—á<\/p>
  <p>–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø–µ—á–∞—Ç—å: ${d.parallelMode}, –ù–∞—Ü–µ–Ω–∫–∞: ${d.markupPercent || 0}%<\/p>
  <p>–ü–æ–¥–∏—Ç–æ–≥: ${(d.total - d.globalAdditional.taxAmount).toFixed(2)} ‚ÇΩ, –û–±—â–∏–π –Ω–∞–ª–æ–≥: ${d.globalAdditional.taxAmount.toFixed(2)} ‚ÇΩ<\/p>
  <hr/>
`;
  d.detailsByPrinter.forEach(pr => {
    s += `<div class="printer-block">
      <strong>–ü—Ä–∏–Ω—Ç–µ—Ä: ${pr.printerName} (ID: ${pr.printerId})<\/strong><br/>
      –í—Ä–µ–º—è: ${formatTimeForDisplay(pr.printerTime)} —á<br/>
    `;
    if(pr.linesDetail && pr.linesDetail.length>0){
      s += `<table style="margin-top:5px;">
        <thead><tr>
          <th>–ú–æ–¥–µ–ª—å<\/th>
          <th>–°—Ç–∞—Ç—É—Å<\/th>
          <th>–ß–∞—Å—ã<\/th>
          <th>–í–µ—Å (–≥)<\/th>
          <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
          <th>–í–µ—Å —Å –±—Ä–∞–∫–æ–º<\/th>
          <th>–°—É–º–º–∞<\/th>
        <\/tr><\/thead>
        <tbody>`;
      pr.linesDetail.forEach(ln => {
        s += `<tr>
          <td>${ln.name}<\/td>
          <td>${ln.status}<\/td>
          <td>${ln.hours.toFixed(2)}<\/td>
          <td>${ln.weight.toFixed(2)}<\/td>
          <td>${ln.matName}<\/td>
          <td>${ln.realWeight.toFixed(2)}<\/td>
          <td>${ln.subTotalModel.toFixed(2)}<\/td>
        <\/tr>`;
      });
      s += `<\/tbody><\/table>`;
    }
    s += `<\/div>`;
  });
  s += `<\/body><\/html>`;
  return s;
}
function onEditCalcHistory(timestamp){
  const it = appData.calcHistory.find(x => x.timestamp === timestamp);
  if(!it){ alert("–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏"); return; }
  document.getElementById("calcName").value = it.calcName || "";
  document.getElementById("calcClientName").value = it.clientName || "";
  document.getElementById("calcOrderStatus").value = it.orderStatus || "new";
  document.getElementById("calcOperatorRate").value = it.operatorRate || "";
  document.getElementById("calcWorkHoursDay").value = appData.calcSettings.workHoursDay || "";
  document.getElementById("calcCostKwh").value = it.costKwh || "";
  document.getElementById("calcTaxPercent").value = it.taxPercent || "";
  document.getElementById("calcShipping").value = it.shipping || "";
  document.getElementById("calcStartDate").value = appData.calcSettings.startDate || "";
  document.getElementById("calcParallelPrinting").value = it.parallelMode || "no";
  document.getElementById("calcMarkupPercent").value = it.markupPercent || 0;
  
  if(it.calcData){
    for(const printerId in it.calcData){
      const table = document.getElementById(`calcModelsTable_${printerId}`);
      if(!table) continue;
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";
      it.calcData[printerId].forEach(model => {
        addModelRow(parseInt(printerId, 10), model);
      });
    }
  }
  const tabEl = document.querySelector('#calculate-tab');
  const tab = new bootstrap.Tab(tabEl);
  tab.show();
}

function ensureIconsLoaded() {
  if (!document.querySelector('link[href*="bootstrap-icons"]')) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css';
    document.head.appendChild(link);
  }
}

	
function renderSummary() {
ensureIconsLoaded();
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const formatCurrency = (value) => new Intl.NumberFormat('ru-RU', { 
    style: 'currency', 
    currency: 'RUB',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value);

  const formatNumber = (value, decimals = 2) => 
    new Intl.NumberFormat('ru-RU', { 
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals 
    }).format(value);

  // 1. –†–∞—Å—á–µ—Ç –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π
  const calculateCapitalInvestments = () => {
    const capital = {
      printersCost: appData.printers.reduce((sum, p) => sum + p.cost, 0),
      printersAdds: appData.printers.reduce(
        (sum, p) => sum + p.additional.reduce((aSum, a) => aSum + a.cost, 0), 0),
      printersMats: appData.printers.reduce(
        (sum, p) => sum + p.materials.reduce((mSum, m) => mSum + (m.costPerKg * m.declaredWeight), 0), 0),
      globalMats: appData.materials.reduce(
        (sum, m) => sum + (m.costPerKg * m.declaredWeight), 0),
      globalAdds: appData.additionalGlobal.reduce((sum, a) => sum + a.cost, 0)
    };

    capital.total = Object.values(capital).reduce((sum, val) => sum + val, 0);
    return capital;
  };

  // 2. –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
  const analyzeCompletedOrders = () => {
    const completedOrders = appData.calcHistory.filter(o => o.orderStatus === "done");
    const results = {
      totalRevenue: 0,
      totalTax: 0,
      totalCost: 0,
      totalPrintHours: 0,
      totalElectricityCost: 0,
      totalOperatorExpenses: 0,
      materialStats: {},
      printerStats: {},
      completedOrdersCount: completedOrders.length
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
    appData.printers.forEach(p => {
      results.printerStats[p.id] = {
        name: p.name,
        hours: 0,
        cost: 0,
        prints: 0
      };
    });

    completedOrders.forEach(order => {
      results.totalRevenue += order.total || 0;
      
      // –†–∞—Å—á–µ—Ç –Ω–∞–ª–æ–≥–æ–≤
      if (order.taxAmount !== undefined) {
        results.totalTax += order.taxAmount;
      } else if (order.taxPercent !== undefined && order.taxPercent > 0) {
        results.totalTax += order.total * (order.taxPercent / 100);
      }

      // –£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
      results.totalOperatorExpenses += order.totalOperatorCost || 0;

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
      order.details?.forEach(printer => {
        const printerId = printer.printerId;
        
        if (!results.printerStats[printerId]) {
          results.printerStats[printerId] = {
            name: printer.printerName,
            hours: 0,
            cost: 0,
            prints: 0
          };
        }
        
        printer.linesDetail?.forEach(model => {
          if (model.materialData?.id) {
            const materialId = model.materialData.id;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
            if (!results.materialStats[materialId]) {
              const mat = findMaterialById(materialId);
              results.materialStats[materialId] = {
                name: mat ? `${mat.name} | ${mat.manufacturer}` : 
                          `${model.matName} | ${model.materialData?.manufacturer || 'N/A'}`,
                totalGrams: 0,
                totalCost: 0
              };
            }
            
            results.materialStats[materialId].totalGrams += model.realWeight || 0;
            results.materialStats[materialId].totalCost += model.costMaterial || 0;
            
            // –£—á–µ—Ç –∑–∞—Ç—Ä–∞—Ç
            results.totalCost += model.costPrinterPart || 0;
            results.totalCost += model.costElectric || 0;
            results.totalCost += model.costMaintenance || 0;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º
            results.printerStats[printerId].hours += model.hours || 0;
            results.printerStats[printerId].cost += model.costPrinterPart || 0;
            results.printerStats[printerId].prints++;
            
            results.totalElectricityCost += model.costElectric || 0;
            results.totalPrintHours += model.hours || 0;
          }
        });
      });
      
      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
      results.totalCost += order.globalAdditional?.sumGlobalAdd || 0;
      results.totalCost += order.shipping || 0;
      results.totalCost += order.totalOperatorCost || 0;
    });

    return results;
  };

  // 3. –†–∞—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
  const calculateKPIs = (capital, ordersAnalysis) => {
    const {
      totalRevenue,
      totalCost,
      totalTax,
      totalPrintHours,
      totalElectricityCost,
      materialStats,
      completedOrdersCount
    } = ordersAnalysis;
    
    const netProfit = totalRevenue - totalCost - totalTax;
    const profitability = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
    
    // –†–∞—Å—á–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
    const totalMaterialCost = Object.values(materialStats).reduce(
      (sum, m) => sum + m.totalCost, 0);
    const totalGrams = Object.values(materialStats).reduce(
      (sum, m) => sum + m.totalGrams, 0);

    return {
      netProfit,
      profitability,
      profitPerHour: totalPrintHours > 0 ? netProfit / totalPrintHours : 0,
      payback: netProfit - capital.total,
      avgOrderRevenue: completedOrdersCount > 0 ? totalRevenue / completedOrdersCount : 0,
      netProfitPerOrder: completedOrdersCount > 0 ? netProfit / completedOrdersCount : 0,
      materialCostPerRevenue: totalRevenue > 0 ? (totalMaterialCost / totalRevenue) * 100 : 0,
      marginPercent: totalRevenue > 0 ? 
        ((totalRevenue - totalMaterialCost - totalElectricityCost) / totalRevenue) * 100 : 0,
      netProfitPerGram: totalGrams > 0 ? netProfit / (totalGrams / 1000) : 0,
      costPerGram: totalGrams > 0 ? totalCost / (totalGrams / 1000) : 0,
      printerUtilization: appData.printers.length > 0 ? 
        (totalPrintHours / (appData.printers.length * 24 * 30)) * 100 : 0,
      costPerHour: totalPrintHours > 0 ? totalCost / totalPrintHours : 0,
      materialCostPerHour: totalPrintHours > 0 ? totalMaterialCost / totalPrintHours : 0,
      totalMaterialCost,
      totalGrams
    };
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML
  const generateHTML = (capital, ordersAnalysis, kpis) => {
    const {
      completedOrdersCount,
      totalRevenue,
      totalTax,
      totalCost,
      totalOperatorExpenses,
      materialStats,
      printerStats
    } = ordersAnalysis;

    const {
      netProfit,
      profitability,
      profitPerHour,
      payback,
      avgOrderRevenue,
      netProfitPerOrder,
      materialCostPerRevenue,
      marginPercent,
      netProfitPerGram,
      costPerGram,
      printerUtilization,
      costPerHour,
      materialCostPerHour
    } = kpis;

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∞–±–ª–∏—Ü
    const materialRows = Object.values(materialStats).map(m => `
      <tr>
        <td>${m.name}</td>
        <td class="text-end">${formatNumber(m.totalGrams / 1000, 3)} –∫–≥</td>
        <td class="text-end">${formatCurrency(m.totalCost)}</td>
        <td class="text-end">${m.totalGrams > 0 ? 
          formatCurrency(m.totalCost / (m.totalGrams / 1000)) : '0.00'} ‚ÇΩ/–∫–≥</td>
      </tr>
    `).join('');

    const printerRows = Object.values(printerStats).map(p => `
      <tr>
        <td>${p.name}</td>
        <td class="text-end">${formatNumber(p.hours, 1)} —á</td>
        <td class="text-end">${formatCurrency(p.cost)}</td>
        <td class="text-end">${p.hours > 0 ? 
          formatCurrency(p.cost / p.hours) : '0.00'} ‚ÇΩ/—á</td>
        <td class="text-end">${p.prints}</td>
      </tr>
    `).join('');

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ KPI
    const kpiCards = [
      {title: '–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å', value: profitability, unit: '%', 
       desc: '(–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –í—ã—Ä—É—á–∫–∞)', icon: 'bi-graph-up'},
      {title: '–ü—Ä–∏–±—ã–ª—å –≤ —á–∞—Å', value: profitPerHour, unit: '‚ÇΩ/—á', 
       desc: '(–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –ß–∞—Å—ã –ø–µ—á–∞—Ç–∏)', icon: 'bi-speedometer2'},
      {title: '–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å', value: marginPercent, unit: '%', 
       desc: '(–í—ã—Ä—É—á–∫–∞ - –ú–∞—Ç–µ—Ä–∏–∞–ª—ã - –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ)', icon: 'bi-percent'},
      {title: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã / –í—ã—Ä—É—á–∫–∞', value: materialCostPerRevenue, unit: '%', 
       desc: '–î–æ–ª—è –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã', icon: 'bi-coin'},
      {title: '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫', value: avgOrderRevenue, unit: '‚ÇΩ', 
       desc: '(–í—ã—Ä—É—á–∫–∞ / –ó–∞–∫–∞–∑—ã)', icon: 'bi-receipt'},
      {title: '–ü—Ä–∏–±—ã–ª—å / –∑–∞–∫–∞–∑', value: netProfitPerOrder, unit: '‚ÇΩ', 
       desc: '(–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –ó–∞–∫–∞–∑—ã)', icon: 'bi-box-seam'},
      {title: '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏', value: costPerGram, unit: '‚ÇΩ/–∫–≥', 
       desc: '(–û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã / –ú–∞—Ç–µ—Ä–∏–∞–ª—ã)', icon: 'bi-printer'},
      {title: '–ü—Ä–∏–±—ã–ª—å / –∫–≥', value: netProfitPerGram, unit: '‚ÇΩ/–∫–≥', 
       desc: '(–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –ú–∞—Ç–µ—Ä–∏–∞–ª—ã)', icon: 'bi-box'},
      {title: '–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', value: ordersAnalysis.totalElectricityCost, unit: '‚ÇΩ', 
       desc: '–û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã', icon: 'bi-lightning'},
      {title: '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞', value: costPerHour, unit: '‚ÇΩ/—á', 
       desc: '(–ó–∞—Ç—Ä–∞—Ç—ã / –ß–∞—Å—ã –ø–µ—á–∞—Ç–∏)', icon: 'bi-clock'},
      {title: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã / —á–∞—Å', value: materialCostPerHour, unit: '‚ÇΩ/—á', 
       desc: '–†–∞—Å—Ö–æ–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤', icon: 'bi-hourglass-split'},
      {title: '–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', value: printerUtilization, unit: '%', 
       desc: '(–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ / –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª)', icon: 'bi-cpu'}
    ].map(card => `
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100 shadow-sm">
          <div class="card-body p-3">
            <div class="d-flex align-items-center">
              <i class="bi ${card.icon} fs-3 text-primary me-3"></i>
              <div>
                <h5 class="mb-0">${formatNumber(card.value, 1)}${card.unit}</h5>
                <small class="text-muted">${card.title}</small>
              </div>
            </div>
            <div class="mt-2 text-muted small">${card.desc}</div>
          </div>
        </div>
      </div>
    `).join('');

    return `
    <div class="container-fluid p-0">
      <!-- –ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>–ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <h6>–ü—Ä–∏–Ω—Ç–µ—Ä—ã:</h6>
              <p>–í—Å–µ–≥–æ: ${appData.printers.length} —à—Ç</p>
              <p>–°—É–º–º–∞: <strong>${formatCurrency(capital.printersCost)}</strong></p>
            </div>
            <div class="col-md-4">
              <h6>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</h6>
              <p>–ü—Ä–∏–Ω—Ç–µ—Ä–Ω—ã–µ: <strong>${formatCurrency(capital.printersMats)}</strong></p>
              <p>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ: <strong>${formatCurrency(capital.globalMats)}</strong></p>
            </div>
            <div class="col-md-4">
              <h6>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</h6>
              <p>–ü—Ä–∏–Ω—Ç–µ—Ä–Ω—ã–µ: <strong>${formatCurrency(capital.printersAdds)}</strong></p>
              <p>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ: <strong>${formatCurrency(capital.globalAdds)}</strong></p>
            </div>
          </div>
          <div class="alert alert-primary mt-3 mb-0">
            <div class="d-flex justify-content-between align-items-center">
              <span>–û–±—â–∏–µ –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è:</span>
              <strong class="fs-5">${formatCurrency(capital.total)}</strong>
            </div>
          </div>
        </div>
      </div>
      
      <!-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏. 
            <a href="https://github.com/nazbav/3d-price/issues/1" class="alert-link">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –∑–¥–µ—Å—å</a>
          </div>
          
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</h6>
                <h3 class="text-center">${completedOrdersCount}</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</h6>
                <h3 class="text-center text-success">${formatCurrency(totalRevenue)}</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</h6>
                <h3 class="text-center text-danger">${formatCurrency(totalCost)}</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</h6>
                <h3 class="text-center ${netProfit >= 0 ? 'text-success' : 'text-danger'}">
                  ${formatCurrency(netProfit)}
                </h3>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤</h6>
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–ù–∞–ª–æ–≥–∏:</span>
                      <span>${formatCurrency(totalTax)}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–†–∞—Å—Ö–æ–¥—ã –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</span>
                      <span>${formatCurrency(totalOperatorExpenses)}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å (–ø—Ä–∏–±—ã–ª—å - –≤–ª–æ–∂–µ–Ω–∏—è):</span>
                      <span class="${payback >= 0 ? 'text-success' : 'text-danger'}">
                        ${formatCurrency(payback)}
                      </span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h6>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h6>
                  <div class="progress mb-2" style="height: 25px">
                    <div class="progress-bar" role="progressbar" 
                         style="width: ${Math.min(100, profitability)}%" 
                         aria-valuenow="${profitability}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                      –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å: ${formatNumber(profitability, 1)}%
                    </div>
                  </div>
                  <div class="progress mb-2" style="height: 25px">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: ${Math.min(100, marginPercent)}%" 
                         aria-valuenow="${marginPercent}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                      –ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å: ${formatNumber(marginPercent, 1)}%
                    </div>
                  </div>
                  <div class="progress" style="height: 25px">
                    <div class="progress-bar bg-info" role="progressbar" 
                         style="width: ${Math.min(100, printerUtilization)}%" 
                         aria-valuenow="${printerUtilization}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                      –ó–∞–≥—Ä—É–∑–∫–∞: ${formatNumber(printerUtilization, 1)}%
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-boxes me-2"></i>–†–∞—Å—Ö–æ–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="">
                    <tr>
                      <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                      <th class="text-end">–†–∞—Å—Ö–æ–¥</th>
                      <th class="text-end">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                      <th class="text-end">‚ÇΩ/–∫–≥</th>
                    </tr>
                  </thead>
                  <tbody>${materialRows}</tbody>
                  <tfoot class="">
                    <tr>
                      <th>–ò—Ç–æ–≥–æ</th>
                      <th class="text-end">${formatNumber(kpis.totalGrams / 1000, 3)} –∫–≥</th>
                      <th class="text-end">${formatCurrency(kpis.totalMaterialCost)}</th>
                      <th class="text-end">${kpis.totalGrams > 0 ? 
                        formatCurrency(kpis.totalMaterialCost / (kpis.totalGrams / 1000)) : '0.00'} ‚ÇΩ/–∫–≥</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-printer me-2"></i>–ó–∞—Ç—Ä–∞—Ç—ã –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="">
                    <tr>
                      <th>–ü—Ä–∏–Ω—Ç–µ—Ä</th>
                      <th class="text-end">–í—Ä–µ–º—è</th>
                      <th class="text-end">–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è</th>
                      <th class="text-end">‚ÇΩ/—á–∞—Å</th>
                      <th class="text-end">–ú–æ–¥–µ–ª–µ–π</th>
                    </tr>
                  </thead>
                  <tbody>${printerRows}</tbody>
                  <tfoot class="">
                    <tr>
                      <th>–ò—Ç–æ–≥–æ</th>
                      <th class="text-end">${formatNumber(ordersAnalysis.totalPrintHours, 1)} —á</th>
                      <th class="text-end">${formatCurrency(Object.values(printerStats).reduce((sum, p) => sum + p.cost, 0))}</th>
                      <th class="text-end">${ordersAnalysis.totalPrintHours > 0 ? 
                        formatCurrency(Object.values(printerStats).reduce((sum, p) => sum + p.cost, 0) / ordersAnalysis.totalPrintHours) : '0.00'} ‚ÇΩ/—á</th>
                      <th class="text-end">${Object.values(printerStats).reduce((sum, p) => sum + p.prints, 0)}</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- KPI -->
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h5>
        </div>
        <div class="card-body">
          <div class="row">
            ${kpiCards}
          </div>
        </div>
      </div>
    </div>`;
  };

  // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–æ–≤
  const capital = calculateCapitalInvestments();
  const ordersAnalysis = analyzeCompletedOrders();
  const kpis = calculateKPIs(capital, ordersAnalysis);

  // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  const summaryContent = document.getElementById("summaryContent");
  summaryContent.innerHTML = generateHTML(capital, ordersAnalysis, kpis);
}

</script>

<!-- Supabase & QR -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const SUPABASE_URL = "https://kvvxfytrlgihewmsvwkj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2dnhmeXRybGdpaGV3bXN2d2tqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5NDExMzIsImV4cCI6MjA2MTUxNzEzMn0.bvXmrh3XZivLVyg4irGo82pLAhlrSapzmxcDKLEAjLo";

const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // ‚úÖ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

let syncId = localStorage.getItem("sync_id") || crypto.randomUUID();
let encryptionKey = localStorage.getItem("encryption_key") || crypto.randomUUID() + crypto.randomUUID();
localStorage.setItem("sync_id", syncId);
localStorage.setItem("encryption_key", encryptionKey);

async function encryptData(data, key) {
  const text = JSON.stringify(data);
  const enc = new TextEncoder().encode(text);
  const cryptoKey = await crypto.subtle.importKey("raw", new TextEncoder().encode(key.slice(0, 32)), "AES-GCM", false, ["encrypt"]);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const cipher = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, enc);
  return btoa(JSON.stringify({ iv: Array.from(iv), data: Array.from(new Uint8Array(cipher)) }));
}

async function decryptData(encrypted, key) {
  const parsed = JSON.parse(atob(encrypted));
  const iv = new Uint8Array(parsed.iv);
  const data = new Uint8Array(parsed.data);
  const cryptoKey = await crypto.subtle.importKey("raw", new TextEncoder().encode(key.slice(0, 32)), "AES-GCM", false, ["decrypt"]);
  const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, cryptoKey, data);
  return JSON.parse(new TextDecoder().decode(decrypted));
}

async function saveSettingsToCloud() {
  const encrypted = await encryptData(appData, encryptionKey);
  const { error } = await _supabase
    .from('user_settings')
    .upsert({
      sync_id: syncId,
      encrypted_data: encrypted,
      updated_at: new Date().toISOString()
    }, { onConflict: 'sync_id' });

  if (error) alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + error.message);
  else alert("‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ.");
}

async function loadSettingsFromCloud() {
  const { data, error } = await _supabase
    .from('user_settings')
    .select('*')
    .eq('sync_id', syncId)
    .single();

  if (error || !data) {
    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + error?.message);
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
  const createdAt = new Date(data.created_at);
  const now = new Date();
  if ((now - createdAt) > 5 * 60 * 1000) { // 5 –º–∏–Ω—É—Ç
    alert("–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã");
    await _supabase.from('user_settings').delete().eq('sync_id', syncId);
    return;
  }

  try {
    const decrypted = await decryptData(data.encrypted_data, encryptionKey);
    appData = decrypted;
    saveToLocalStorage();
    initAll();
    alert("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
  } catch (e) {
    alert("–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏.");
  }
}

function generateSyncLinkAndQR() {
  const url = new URL(window.location.href);
  url.searchParams.set("sync_id", syncId);
  url.searchParams.set("key", encryptionKey);
  const link = url.toString();
  document.getElementById("syncLinkDisplay").value = link;
  const qrcodeDiv = document.getElementById("qrcode");
  qrcodeDiv.innerHTML = "";
  new QRCode(qrcodeDiv, {
    text: link,
    width: 256,
    height: 256,
    colorDark: "#000000",
    colorLight: "#ffffff"
  });
}

document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(window.location.search);
  const incomingId = params.get("sync_id");
  const incomingKey = params.get("key");

  if (incomingId && incomingKey) {
    localStorage.setItem("sync_id", incomingId);
    localStorage.setItem("encryption_key", incomingKey);
    syncId = incomingId;
    encryptionKey = incomingKey;
    await loadSettingsFromCloud();
    window.history.replaceState({}, document.title, window.location.pathname);
  }
});
</script>

</body>
</html>
