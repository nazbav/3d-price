<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 3D-–ø–µ—á–∞—Ç–∏ (v3)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    .container { margin-top: 20px; margin-bottom: 20px; }
    .nav-tabs .nav-link.active { font-weight: bold; }
    .small-text { font-size: 0.9rem; color: #555; }
    .footer { margin-top: 40px; font-size: 0.9rem; border-top: 1px solid var(--bs-border-color); padding-top: 10px; }
    table td, table th { vertical-align: middle; white-space: nowrap; }
    .btn-group-sm > .btn { font-size: 0.8rem; padding: 2px 6px; margin-left: 2px; }
    thead th { background-color: var(--bs-table-bg) !important; color: var(--bs-body-color) !important; }
    [data-bs-theme="dark"] thead th { background-color: var(--bs-dark-bg-subtle) !important; color: var(--bs-light) !important; }
    @media (max-width: 576px) {
      .d-flex { flex-wrap: wrap !important; }
      .d-flex > * { margin-top: .5rem; }
    }
    .form-select.form-select-sm { min-width: 120px; }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–∏–∫–µ—Ç–∫–∏ */
    .label-preview { border: 1px solid #000; width: 30mm; height: 20mm; padding: 2mm; font-family: sans-serif; }
  </style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="my-4">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 3D-–ø–µ—á–∞—Ç–∏ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)</h1>
    <div class="d-flex gap-2">
      <a href="https://github.com/nazbav/3d-price/blob/main/README.md" class="btn btn-outline-primary" target="_blank">README</a>
      <button class="btn btn-outline-secondary" id="themeToggle">üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</button>
    </div>
  </div>
  <ul class="nav nav-tabs" id="mainTab" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="printers-tab" data-bs-toggle="tab"
              data-bs-target="#printersPane" type="button" role="tab" aria-controls="printersPane" 
              aria-selected="true">
        –ü—Ä–∏–Ω—Ç–µ—Ä—ã
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="globalMaterials-tab" data-bs-oggle="tab"
              data-bs-target="#globalMaterialsPane" type="button" role="tab"
              aria-controls="globalMaterialsPane" aria-selected="false">
        –û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="globalAdditional-tab" data-bs-toggle="tab"
              data-bs-target="#globalAdditionalPane" type="button" role="tab"
              aria-controls="globalAdditionalPane" aria-selected="false">
        –û–±—â–∏–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="calculate-tab" data-bs-toggle="tab"
              data-bs-target="#calculatePane" type="button" role="tab"
              aria-controls="calculatePane" aria-selected="false">
        –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="history-tab" data-bs-toggle="tab"
              data-bs-target="#historyPane" type="button" role="tab"
              aria-controls="historyPane" aria-selected="false">
        –ò—Å—Ç–æ—Ä–∏—è
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="importexport-tab" data-bs-toggle="tab"
              data-bs-target="#importexportPane" type="button" role="tab"
              aria-controls="importexportPane" aria-selected="false">
        –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="labelsettings-tab" data-bs-toggle="tab"
              data-bs-target="#labelsettingsPane" type="button" role="tab"
              aria-controls="labelsettingsPane" aria-selected="false">
        –≠—Ç–∏–∫–µ—Ç–∫–∞
      </button>
    </li>
	<li class="nav-item">
      <button class="nav-link" id="summary-tab" data-bs-toggle="tab"
              data-bs-target="#summaryPane" type="button" role="tab"
              aria-controls="summaryPane" aria-selected="false">
        –ò—Ç–æ–≥–∏
      </button>
    </li>
  </ul>

  <div class="tab-content" id="mainTabContent">
    <!-- –ü—Ä–∏–Ω—Ç–µ—Ä—ã -->
    <div class="tab-pane fade show active" id="printersPane" role="tabpanel" aria-labelledby="printers-tab">
      <div class="mt-4">
        <h3>–°–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</h3>
        <p class="small-text">
          –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–ª—è –Ω–µ–≥–æ.
        </p>
        <div class="mb-2">
          <button class="btn btn-primary btn-sm" onclick="onAddPrinter()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä</button>
          <button class="btn btn-danger btn-sm" onclick="massDelete('printers')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
          <button class="btn btn-warning btn-sm" onclick="massEdit('printers')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="printersTable">
            <thead class="table-light">
              <tr>
                <th><input type="checkbox" id="selectAll_printers" onchange="selectAll(this, 'printers')"></th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</th>
                <th>–ß–∞—Å—ã –æ–∫—É–ø.</th>
                <th>–ú–æ—â–Ω. (–í—Ç)</th>
                <th>–û–±—Å–ª. (‚ÇΩ/—á)</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <hr/>
      <div id="printerDetails" style="display: none;">
        <h4>–†–∞—Å—Ö–æ–¥—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ <span id="printerDetailsName"></span> (ID: <span id="printerDetailsId"></span>)</h4>
        <div class="row">
          <div class="col-md-6">
            <h5>–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ)</h5>
            <p class="small-text">–£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å, —á–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ –∏ –æ—Ç–º–µ—Ç—å—Ç–µ, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ —Ä–∞—Å—Ö–æ–¥ –≤ —Ä–∞—Å—á—ë—Ç–µ.</p>
            <div class="mb-2">
              <button class="btn btn-sm btn-success" id="btnAddPrinterAdditional">–î–æ–±–∞–≤–∏—Ç—å</button>
              <button class="btn btn-danger btn-sm" onclick="massDelete('printerAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
              <button class="btn btn-warning btn-sm" onclick="massEdit('printerAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-hover" id="printerAdditionalTable">
                <thead>
                  <tr>
                    <th><input type="checkbox" id="selectAll_printerAdditional" onchange="selectAll(this, 'printerAdditional')"></th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–°—Ç–æ–∏–º. (‚ÇΩ)</th>
                    <th>–ß–∞—Å—ã –æ–∫—É–ø.</th>
                    <th>–í–∫–ª. –≤ —Ä–∞—Å—á—ë—Ç?</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="col-md-6">
            <h5>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ)</h5>
            <p class="small-text">–£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥, –æ—Å—Ç–∞—Ç–æ–∫ (–≤ –∫–≥), –∑–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å, –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Ö–æ–¥–æ–≤, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –∏ –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.</p>
            <div class="mb-2">
              <button class="btn btn-sm btn-success" id="btnAddPrinterMaterial">–î–æ–±–∞–≤–∏—Ç—å</button>
              <button class="btn btn-danger btn-sm" onclick="massDelete('printerMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
              <button class="btn btn-warning btn-sm" onclick="massEdit('printerMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-hover" id="printerMaterialsTable">
                <thead>
                  <tr>
                    <th><input type="checkbox" id="selectAll_printerMaterials" onchange="selectAll(this, 'printerMaterials')"></th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–°—Ç–æ–∏–º./–∫–≥</th>
                    <th>–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥)</th>
                    <th>–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥)</th>
                    <th>–û—Ç—Ö–æ–¥ (%)</th>
                    <th>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</th>
                    <th>–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤.</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã -->
    <div class="tab-pane fade" id="globalMaterialsPane" role="tabpanel" aria-labelledby="globalMaterials-tab">
      <div class="mt-4">
        <h3>–û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
        <p class="small-text">–≠—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º ¬´–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é¬ª. –£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥, –æ—Å—Ç–∞—Ç–æ–∫, –∑–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –∏ –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.</p>
        <div class="mb-2">
          <button class="btn btn-primary btn-sm" onclick="onAddGlobalMaterial()">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
          <button class="btn btn-danger btn-sm" onclick="massDelete('globalMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
          <button class="btn btn-warning btn-sm" onclick="massEdit('globalMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="materialsTable">
            <thead class="table-light">
              <tr>
                <th><input type="checkbox" id="selectAll_globalMaterials" onchange="selectAll(this, 'globalMaterials')"></th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–°—Ç–æ–∏–º./–∫–≥</th>
                <th>–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥)</th>
                <th>–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥)</th>
                <th>–û—Ç—Ö–æ–¥ (%)</th>
                <th>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</th>
                <th>–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤.</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –û–±—â–∏–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã -->
    <div class="tab-pane fade" id="globalAdditionalPane" role="tabpanel" aria-labelledby="globalAdditional-tab">
      <div class="mt-4">
        <h3>–û–±—â–∏–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã</h3>
        <div class="mb-2">
          <button class="btn btn-primary btn-sm" onclick="onAddGlobalAdditional()">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
          <button class="btn btn-danger btn-sm" onclick="massDelete('globalAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
          <button class="btn btn-warning btn-sm" onclick="massEdit('globalAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="additionalGlobalTable">
            <thead class="table-light">
              <tr>
                <th><input type="checkbox" id="selectAll_globalAdditional" onchange="selectAll(this, 'globalAdditional')"></th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–°—Ç–æ–∏–º. (‚ÇΩ)</th>
                <th>–ß–∞—Å—ã –æ–∫—É–ø.</th>
                <th>–í–∫–ª. –≤ —Ä–∞—Å—á—ë—Ç?</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
    <div class="tab-pane fade" id="calculatePane" role="tabpanel" aria-labelledby="calculate-tab">
      <div class="my-4">
        <h3>–†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–æ—á–µ—Ä–µ–¥—å –ø–µ—á–∞—Ç–∏)</h3>
        <p class="small-text">
          –î–æ 10 –º–æ–¥–µ–ª–µ–π –Ω–∞ –∫–∞–∂–¥—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞, –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞.
        </p>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="calcName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞:</label>
          <input type="text" id="calcName" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫–∞–∑ 123" />
        </div>
        <div class="col-md-4">
          <label for="calcClientName" class="form-label">–ö–ª–∏–µ–Ω—Ç (–§–ò–û/–∫–æ–º–ø–∞–Ω–∏—è):</label>
          <input type="text" id="calcClientName" class="form-control" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" />
        </div>
        <div class="col-md-4">
          <label for="calcOrderStatus" class="form-label">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:</label>
          <select id="calcOrderStatus" class="form-select">
            <option value="new">–ù–æ–≤—ã–π</option>
            <option value="inprogress">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
            <option value="canceled">–û—Ç–º–µ–Ω—ë–Ω</option>
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="calcOperatorRate" class="form-label">–°—Ç–∞–≤–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (‚ÇΩ/—á):</label>
          <input type="number" step="0.01" id="calcOperatorRate" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcWorkHoursDay" class="form-label">–†–∞–±. —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å:</label>
          <input type="number" id="calcWorkHoursDay" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcCostKwh" class="form-label">–¶–µ–Ω–∞ 1‚ÄØ–∫–í—Ç‚ãÖ—á (‚ÇΩ):</label>
          <input type="number" step="0.01" id="calcCostKwh" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcTaxPercent" class="form-label">–ù–∞–ª–æ–≥ (%):</label>
          <input type="number" step="1" id="calcTaxPercent" class="form-control" />
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="calcShipping" class="form-label">–£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞ (‚ÇΩ):</label>
          <input type="number" step="1" id="calcShipping" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcStartDate" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
          <input type="date" id="calcStartDate" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcParallelPrinting" class="form-label">–£—á—ë—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–µ—á–∞—Ç–∏?</label>
          <select id="calcParallelPrinting" class="form-select">
            <option value="no">–ù–µ—Ç</option>
            <option value="yes">–î–∞</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="calcMarkupPercent" class="form-label">–ù–∞—Ü–µ–Ω–∫–∞ (%):</label>
          <input type="number" step="1" id="calcMarkupPercent" class="form-control" />
        </div>
      </div>
      <hr/>
      <div id="calcPrintersContainer"></div>
      <div class="mt-3">
        <button class="btn btn-success" onclick="onCalculateAll()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Å—ë</button>
      </div>
      <div class="alert alert-info mt-3" id="calcResult" style="display: none;"></div>
    </div>

    <!-- –ò—Ç–æ–≥–∏ -->
    <div class="tab-pane fade" id="summaryPane" role="tabpanel" aria-labelledby="summary-tab">
      <div class="mt-4">
        <h3>–û–±—â–∏–π –æ–±–∑–æ—Ä (¬´–ò—Ç–æ–≥–∏¬ª)</h3>
        <p class="small-text">–°—É–º–º–∞—Ä–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º, –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º (–±–µ–∑. —É—á –æ—Å—Ç–∞—Ç–∫–∞).</p>
        <div id="summaryContent"></div>
      </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div class="tab-pane fade" id="historyPane" role="tabpanel" aria-labelledby="history-tab">
      <div class="mt-4">
        <h3>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤</h3>
        <p class="small-text">
          –ü—Ä–æ—à–ª—ã–µ —Ä–∞—Å—á—ë—Ç—ã. –ö–Ω–æ–ø–∫–∏: ¬´JSON¬ª ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ–±—ä–µ–∫—Ç, ¬´HTML¬ª ‚Äî —Å–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç, ¬´–†–µ–¥–∞–∫—Ç.¬ª ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.
        </p>
        <button class="btn btn-danger mb-3" onclick="onClearCalcHistory()">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <button class="btn btn-info mb-3" onclick="onViewFullHistoryHtml()">–ò—Å—Ç–æ—Ä–∏—è –≤ HTML</button>
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="historyTable">
            <thead class="table-light">
              <tr>
                <th>–î–∞—Ç–∞/–≤—Ä–µ–º—è</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞</th>
                <th>–ö–ª–∏–µ–Ω—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ò—Ç–æ–≥ (‚ÇΩ)</th>
                <th>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç -->
    <div class="tab-pane fade" id="importexportPane" role="tabpanel" aria-labelledby="importexport-tab">
      <div class="mt-4">
        <h3>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (–ø–æ–ª–Ω—ã–π) –≤ JSON</h3>
        <button class="btn btn-primary" onclick="onExportJson()">–í—ã–≥—Ä—É–∑–∏—Ç—å JSON</button>
		   <button class="btn btn-secondary" onclick="onExportHistory()">–í—ã–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>   
        <textarea id="exportArea" class="form-control mt-2" rows="5"></textarea>
      </div>
      <hr />
      <div class="mt-4">
        <h3>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (–ø–æ–ª–Ω—ã–π) –∏–∑ JSON</h3>
        <textarea id="importArea" class="form-control" rows="5"></textarea>
        <button class="btn btn-success mt-2" onclick="onImportJson()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
		<button class="btn btn-secondary mt-2" onclick="onImportHistory()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button> 
    </div>
	 
	
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ç–∏–∫–µ—Ç–∫–∏ -->
 <div class="tab-pane fade" id="labelsettingsPane" role="tabpanel" aria-labelledby="labelsettings-tab">
  <div class="mt-4">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç—Ç–∏–∫–µ—Ç–∫–∏</h3>
    <div class="mb-3">
      <label for="companyNameInput" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏:</label>
      <input type="text" id="companyNameInput" class="form-control"/>
    </div>
    <div class="mb-3">
      <label for="chatLinkInput" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç (QR):</label>
      <input type="text" id="chatLinkInput" class="form-control"/>
    </div>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è -->
    <div class="mb-3">
      <label for="labelCostInput" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å 1 —ç—Ç–∏–∫–µ—Ç–∫–∏ (‚ÇΩ):</label>
      <input type="number" step="0.01" id="labelCostInput" class="form-control"/>
    </div>
    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="printLabelsCheckbox">
      <label class="form-check-label" for="printLabelsCheckbox">–ü–µ—á–∞—Ç–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏</label>
    </div>
    <button class="btn btn-primary" onclick="saveLabelSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>
  </div>
  <div class="footer">
    <p class="mb-1">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ LocalStorage –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.</p>
    <p class="mb-0">–î–ª—è —Å–±—Ä–æ—Å–∞ –º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–π JSON –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å LocalStorage –≤—Ä—É—á–Ω—É—é.</p>
    <a href="index2.html"><h6>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è (v2)</h6></a>
    <a href="index.html"><h6>–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ (v4)</h6></a>
    <p class="mt-3"><span style="text-decoration:line-through">¬©</span>2025. –ù–∏—á—å–∏ –ø—Ä–∞–≤–∞ –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</div>
	
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const THEME_STORAGE_KEY = "themePreference";
function setTheme(theme) {
  document.documentElement.setAttribute("data-bs-theme", theme);
  localStorage.setItem(THEME_STORAGE_KEY, theme);
  const btn = document.getElementById("themeToggle");
  btn.innerText = theme==="dark" ? "‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞" : "üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞";
}
document.getElementById("themeToggle").addEventListener("click",()=>{
  const th = document.documentElement.getAttribute("data-bs-theme");
  setTheme(th==="dark"?"light":"dark");
});
const savedTheme = localStorage.getItem(THEME_STORAGE_KEY)||"light";
setTheme(savedTheme);

const STORAGE_KEY = "ThreeDPrintCalc_Extended_v5";
let appData = {
  printers: [
    {
      id: 1,
      name: "Ender 3 v3 se",
      cost: 20000,
      hoursToRecoup: 500,
      power: 350,
      maintCostHour: 5,
      additional: [],
      materials: []
    }
  ],
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã: –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è: balance (–æ—Å—Ç–∞—Ç–æ–∫), declaredWeight, manufacturer, productionDate
  materials: [
    // –ü—Ä–∏–º–µ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    // { id: 1001, name: "PLA", costPerKg: 150, balance: 10, declaredWeight: 1, wastePercent: 5, manufacturer: "XYZ", productionDate: "01.01.2025" }
  ],
  additionalGlobal: [],
  calcSettings: {
    operatorRate: 200,
    workHoursDay: 8,
    startDate: "",
    costKwh: 6,
    shipping: 300,
    taxPercent: 6,
    parallelPrinting: "no",
    markupPercent: 0
  },
  labelSettings: {
  companyName: "–ö–æ–º–ø–∞–Ω–∏—è",
  chatLink: "https://t.me/dur",
  costPerLabel: 0,   
  printLabels: false 
},
  calcHistory: []
};

function loadFromLocalStorage(){
  try{
    const s = localStorage.getItem(STORAGE_KEY);
    if(s){
      const p = JSON.parse(s);
      if(p) appData = p;
    }
  } catch(e){}
}
function saveToLocalStorage(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
}
function initAll(){
  loadFromLocalStorage();
  renderPrintersTable();
  renderGlobalMaterialsTable();
  renderGlobalAdditionalTable();
  renderCalcPrinters();
  renderHistoryTable();
  renderSummary();
  document.getElementById("calcOperatorRate").value = appData.calcSettings.operatorRate || "";
  document.getElementById("calcWorkHoursDay").value = appData.calcSettings.workHoursDay || "";
  document.getElementById("calcCostKwh").value = appData.calcSettings.costKwh || "";
  document.getElementById("calcTaxPercent").value = appData.calcSettings.taxPercent || "";
  document.getElementById("calcShipping").value = appData.calcSettings.shipping || "";
  document.getElementById("calcStartDate").value = appData.calcSettings.startDate || "";
  document.getElementById("calcParallelPrinting").value = appData.calcSettings.parallelPrinting || "no";
  document.getElementById("calcMarkupPercent").value = appData.calcSettings.markupPercent || 0;
  document.getElementById("companyNameInput").value = appData.labelSettings.companyName || "";
  document.getElementById("chatLinkInput").value = appData.labelSettings.chatLink || "";
  document.getElementById("labelCostInput").value = appData.labelSettings.costPerLabel || 0;
  document.getElementById("printLabelsCheckbox").checked = appData.labelSettings.printLabels || false;
}
document.addEventListener("DOMContentLoaded", initAll);

/* –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
function selectAll(source, type) {
  const checkboxes = document.querySelectorAll("."+type+"_chk");
  checkboxes.forEach(cb => cb.checked = source.checked);
}
function massDelete(type) {
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã?")) return;
  switch(type) {
    case 'printers':
      appData.printers = appData.printers.filter(p => {
        const chk = document.getElementById("chk_printers_"+p.id);
        return !(chk && chk.checked);
      });
      renderPrintersTable();
      break;
    case 'globalMaterials':
      appData.materials = appData.materials.filter(m => {
        const chk = document.getElementById("chk_globalMaterials_"+m.id);
        return !(chk && chk.checked);
      });
      renderGlobalMaterialsTable();
      break;
    case 'globalAdditional':
      appData.additionalGlobal = appData.additionalGlobal.filter(a => {
        const chk = document.getElementById("chk_globalAdditional_"+a.id);
        return !(chk && chk.checked);
      });
      renderGlobalAdditionalTable();
      break;
    case 'printerAdditional':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          printer.additional = printer.additional.filter(a => {
            const chk = document.getElementById("chk_printerAdditional_"+a.id);
            return !(chk && chk.checked);
          });
          onShowPrinterDetails(printerId);
        }
      }
      break;
    case 'printerMaterials':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          printer.materials = printer.materials.filter(m => {
            const chk = document.getElementById("chk_printerMaterials_"+m.id);
            return !(chk && chk.checked);
          });
          onShowPrinterDetails(printerId);
        }
      }
      break;
  }
  saveToLocalStorage();
}
function massEdit(type) {
  // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π (–∏—Å–∫–ª—é—á–∞—è –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ id)
  switch(type) {
    case 'printers':
      {
        let newCost = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):");
        let newHours = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —á–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:");
        let newPower = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –º–æ—â–Ω–æ—Å—Ç—å (–í—Ç):");
        let newMaint = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (‚ÇΩ/—á):");
        if(newCost===null || newHours===null || newPower===null || newMaint===null) return;
        appData.printers.forEach(p => {
          const chk = document.getElementById("chk_printers_"+p.id);
          if(chk && chk.checked) {
            p.cost = parseFloat(newCost) || p.cost;
            p.hoursToRecoup = parseFloat(newHours) || p.hoursToRecoup;
            p.power = parseFloat(newPower) || p.power;
            p.maintCostHour = parseFloat(newMaint) || p.maintCostHour;
          }
        });
        renderPrintersTable();
      }
      break;
    case 'globalMaterials':
      {
        let newCost = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:");
        let newBalance = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (–∫–≥):");
        let newDeclared = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥):");
        let newWaste = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Ö–æ–¥–æ–≤:");
        let newManuf = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è:");
        let newProdDate = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (DD.MM.YYYY):");
        if(newCost===null || newBalance===null || newDeclared===null || newWaste===null || newManuf===null || newProdDate===null) return;
        appData.materials.forEach(m => {
          const chk = document.getElementById("chk_globalMaterials_"+m.id);
          if(chk && chk.checked) {
            m.costPerKg = parseFloat(newCost) || m.costPerKg;
            m.balance = parseFloat(newBalance) || m.balance;
            m.declaredWeight = parseFloat(newDeclared) || m.declaredWeight;
            m.wastePercent = parseFloat(newWaste) || m.wastePercent;
            m.manufacturer = newManuf;
            m.productionDate = newProdDate;
          }
        });
        renderGlobalMaterialsTable();
      }
      break;
    case 'globalAdditional':
      {
        let newCost = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):");
        let newHours = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —á–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:");
        let newUse = confirm("–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö?");
        if(newCost===null || newHours===null) return;
        appData.additionalGlobal.forEach(a => {
          const chk = document.getElementById("chk_globalAdditional_"+a.id);
          if(chk && chk.checked) {
            a.cost = parseFloat(newCost) || a.cost;
            a.hoursToRecoup = parseFloat(newHours) || a.hoursToRecoup;
            a.useInCalc = newUse;
          }
        });
        renderGlobalAdditionalTable();
      }
      break;
    case 'printerAdditional':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          let newCost = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):");
          let newHours = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —á–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:");
          let newUse = confirm("–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö?");
          if(newCost===null || newHours===null) return;
          printer.additional.forEach(a => {
            const chk = document.getElementById("chk_printerAdditional_"+a.id);
            if(chk && chk.checked) {
              a.cost = parseFloat(newCost) || a.cost;
              a.hoursToRecoup = parseFloat(newHours) || a.hoursToRecoup;
              a.useInCalc = newUse;
            }
          });
          onShowPrinterDetails(printerId);
        }
      }
      break;
    case 'printerMaterials':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          let newCost = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:");
          let newBalance = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (–∫–≥):");
          let newDeclared = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥):");
          let newWaste = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Ö–æ–¥–æ–≤:");
          let newManuf = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è:");
          let newProdDate = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (DD.MM.YYYY):");
          if(newCost===null || newBalance===null || newDeclared===null || newWaste===null || newManuf===null || newProdDate===null) return;
          printer.materials.forEach(m => {
            const chk = document.getElementById("chk_printerMaterials_"+m.id);
            if(chk && chk.checked) {
              m.costPerKg = parseFloat(newCost) || m.costPerKg;
              m.balance = parseFloat(newBalance) || m.balance;
              m.declaredWeight = parseFloat(newDeclared) || m.declaredWeight;
              m.wastePercent = parseFloat(newWaste) || m.wastePercent;
              m.manufacturer = newManuf;
              m.productionDate = newProdDate;
            }
          });
          onShowPrinterDetails(printerId);
        }
      }
      break;
  }
  saveToLocalStorage();
}
function copyElement(type, id) {
  switch(type) {
    case 'printers':
      {
        const orig = appData.printers.find(p => p.id === id);
        if(orig){
          const copy = JSON.parse(JSON.stringify(orig));
          copy.id = Date.now();
          copy.name += " (–∫–æ–ø–∏—è)";
          appData.printers.push(copy);
          renderPrintersTable();
        }
      }
      break;
    case 'globalMaterials':
      {
        const orig = appData.materials.find(m => m.id === id);
        if(orig){
          const copy = JSON.parse(JSON.stringify(orig));
          copy.id = Date.now();
          copy.name += " (–∫–æ–ø–∏—è)";
          appData.materials.push(copy);
          renderGlobalMaterialsTable();
        }
      }
      break;
    case 'globalAdditional':
      {
        const orig = appData.additionalGlobal.find(a => a.id === id);
        if(orig){
          const copy = JSON.parse(JSON.stringify(orig));
          copy.id = Date.now();
          copy.description += " (–∫–æ–ø–∏—è)";
          appData.additionalGlobal.push(copy);
          renderGlobalAdditionalTable();
        }
      }
      break;
    case 'printerAdditional':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          const orig = printer.additional.find(a => a.id === id);
          if(orig){
            const copy = JSON.parse(JSON.stringify(orig));
            copy.id = Date.now();
            copy.description += " (–∫–æ–ø–∏—è)";
            printer.additional.push(copy);
            onShowPrinterDetails(printerId);
          }
        }
      }
      break;
    case 'printerMaterials':
      {
        const printerId = getCurrentPrinterId();
        const printer = appData.printers.find(p => p.id === printerId);
        if(printer){
          const orig = printer.materials.find(m => m.id === id);
          if(orig){
            const copy = JSON.parse(JSON.stringify(orig));
            copy.id = Date.now();
            copy.name += " (–∫–æ–ø–∏—è)";
            printer.materials.push(copy);
            onShowPrinterDetails(printerId);
          }
        }
      }
      break;
  }
  saveToLocalStorage();
}
function getCurrentPrinterId(){
  // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  return parseInt(document.getElementById("printerDetailsId").textContent, 10);
}

/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ */
function renderPrintersTable(){
  const tbody = document.querySelector("#printersTable tbody");
  tbody.innerHTML = "";
  appData.printers.forEach(printer => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_printers_${printer.id}" class="printers_chk"><\/td>
      <td>${printer.name}<\/td>
      <td>${printer.cost}<\/td>
      <td>${printer.hoursToRecoup}<\/td>
      <td>${printer.power}<\/td>
      <td>${printer.maintCostHour}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditPrinter(${printer.id})">–†–µ–¥.<\/button>
          <button class="btn btn-info" onclick="onShowPrinterDetails(${printer.id})">–î–µ—Ç–∞–ª–∏<\/button>
          <button class="btn btn-warning" onclick="copyElement('printers', ${printer.id})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeletePrinter(${printer.id})">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tbody.appendChild(tr);
  });
}
function onAddPrinter(){
  const newId = Date.now();
  const p = {
    id: newId,
    name: "–ù–æ–≤—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä",
    cost: 0,
    hoursToRecoup: 1000,
    power: 0,
    maintCostHour: 0,
    additional: [],
    materials: []
  };
  appData.printers.push(p);
  saveToLocalStorage();
  renderPrintersTable();
}
function onEditPrinter(id){
  const p = appData.printers.find(x => x.id === id);
  if(!p) return;
  const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—Ç–µ—Ä–∞:", p.name);
  if(n === null) return;
  const c = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):", p.cost);
  if(c === null) return;
  const h = prompt("–ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:", p.hoursToRecoup);
  if(h === null) return;
  const pw = prompt("–ú–æ—â–Ω–æ—Å—Ç—å (–í—Ç):", p.power);
  if(pw === null) return;
  const m = prompt("–û–±—Å–ª. (‚ÇΩ/—á):", p.maintCostHour);
  if(m === null) return;
  p.name = n;
  p.cost = parseFloat(c) || 0;
  p.hoursToRecoup = parseFloat(h) || 1000;
  p.power = parseFloat(pw) || 0;
  p.maintCostHour = parseFloat(m) || 0;
  saveToLocalStorage();
  renderPrintersTable();
}
function onDeletePrinter(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä?")) return;
  appData.printers = appData.printers.filter(x => x.id !== id);
  saveToLocalStorage();
  renderPrintersTable();
  document.getElementById("printerDetails").style.display = "none";
}
function onShowPrinterDetails(id){
  const printer = appData.printers.find(p => p.id === id);
  if(!printer) return;
  document.getElementById("printerDetails").style.display = "block";
  document.getElementById("printerDetailsName").textContent = printer.name;
  document.getElementById("printerDetailsId").textContent = printer.id;
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  const tbodyAdd = document.querySelector("#printerAdditionalTable tbody");
  tbodyAdd.innerHTML = "";
  printer.additional.forEach(a => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_printerAdditional_${a.id}" class="printerAdditional_chk"><\/td>
      <td>${a.description}<\/td>
      <td>${a.cost}<\/td>
      <td>${a.hoursToRecoup}<\/td>
      <td>${a.useInCalc ? "–î–∞" : "–ù–µ—Ç"}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditPrinterAdditional(${printer.id}, ${a.id})">–†–µ–¥.<\/button>
          <button class="btn btn-warning" onclick="copyElement('printerAdditional', ${a.id})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeletePrinterAdditional(${printer.id}, ${a.id})">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tbodyAdd.appendChild(tr);
  });
  
  // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  const tbodyMat = document.querySelector("#printerMaterialsTable tbody");
  tbodyMat.innerHTML = "";
  printer.materials.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_printerMaterials_${m.id}" class="printerMaterials_chk"><\/td>
      <td>${m.name}<\/td>
      <td>${m.costPerKg}<\/td>
      <td>${m.balance}<\/td>
      <td>${m.declaredWeight || "-"}<\/td>
      <td>${m.wastePercent}<\/td>
      <td>${m.manufacturer || "-"}<\/td>
      <td>${m.productionDate || "-"}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditPrinterMaterial(${printer.id}, ${m.id})">–†–µ–¥.<\/button>
          <button class="btn btn-info" onclick="downloadMaterialLabelHtml(${m.id})">–≠—Ç–∏–∫–µ—Ç–∫–∞<\/button>
          <button class="btn btn-warning" onclick="copyElement('printerMaterials', ${m.id})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeletePrinterMaterial(${printer.id}, ${m.id})">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tbodyMat.appendChild(tr);
  });
  
  document.getElementById("btnAddPrinterAdditional").onclick = () => onAddPrinterAdditional(printer.id);
  document.getElementById("btnAddPrinterMaterial").onclick = () => onAddPrinterMaterial(printer.id);
}
function onAddPrinterAdditional(printerId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  const nid = Date.now();
  pr.additional.push({
    id: nid,
    description: "–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è",
    cost: 0,
    hoursToRecoup: 1000,
    useInCalc: true
  });
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}
function onEditPrinterAdditional(printerId, addId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  const it = pr.additional.find(a => a.id === addId);
  if(!it) return;
  const d = prompt("–û–ø–∏—Å–∞–Ω–∏–µ:", it.description);
  if(d === null) return;
  const c = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):", it.cost);
  if(c === null) return;
  const h = prompt("–ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:", it.hoursToRecoup);
  if(h === null) return;
  const used = confirm("–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç?");
  it.description = d;
  it.cost = parseFloat(c) || 0;
  it.hoursToRecoup = parseFloat(h) || 1000;
  it.useInCalc = used;
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}
function onDeletePrinterAdditional(printerId, addId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é?")) return;
  pr.additional = pr.additional.filter(a => a.id !== addId);
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}
function onAddPrinterMaterial(printerId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  const nid = Date.now();
  pr.materials.push({
    id: nid,
    name: "–ù–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª",
    costPerKg: 0,
    balance: 0,
    declaredWeight: 0,
    wastePercent: 0,
    manufacturer: "",
    productionDate: ""
  });
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}
function onEditPrinterMaterial(printerId, matId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  const mat = pr.materials.find(m => m.id === matId);
  if(!mat) return;
  const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ:", mat.name);
  if(n === null) return;
  const c = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:", mat.costPerKg);
  if(c === null) return;
  const b = prompt("–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥):", mat.balance);
  if(b === null) return;
  const dW = prompt("–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥):", mat.declaredWeight);
  if(dW === null) return;
  const w = prompt("–û—Ç—Ö–æ–¥ (%):", mat.wastePercent);
  if(w === null) return;
  const manuf = prompt("–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:", mat.manufacturer || "");
  if(manuf === null) return;
  const prodDate = prompt("–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (DD.MM.YYYY):", mat.productionDate || "");
  if(prodDate === null) return;
  mat.name = n;
  mat.costPerKg = parseFloat(c) || 0;
  mat.balance = parseFloat(b) || 0;
  mat.declaredWeight = parseFloat(dW) || 0;
  mat.wastePercent = parseFloat(w) || 0;
  mat.manufacturer = manuf;
  mat.productionDate = prodDate;
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}
function onDeletePrinterMaterial(printerId, matId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return;
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª?")) return;
  pr.materials = pr.materials.filter(m => m.id !== matId);
  saveToLocalStorage();
  onShowPrinterDetails(printerId);
}

/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ */
function renderGlobalMaterialsTable(){
  const tb = document.querySelector("#materialsTable tbody");
  tb.innerHTML = "";
  appData.materials.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_globalMaterials_${m.id}" class="globalMaterials_chk"><\/td>
      <td>${m.name}<\/td>
      <td>${m.costPerKg}<\/td>
      <td>${m.balance}<\/td>
      <td>${m.declaredWeight || "-"}<\/td>
      <td>${m.wastePercent}<\/td>
      <td>${m.manufacturer || "-"}<\/td>
      <td>${m.productionDate || "-"}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditGlobalMaterial(${m.id})">–†–µ–¥.<\/button>
          <button class="btn btn-info" onclick="downloadMaterialLabelHtml(${m.id})">–≠—Ç–∏–∫–µ—Ç–∫–∞<\/button>
          <button class="btn btn-warning" onclick="copyElement('globalMaterials', ${m.id})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeleteGlobalMaterial(${m.id})">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tb.appendChild(tr);
  });
}
function onAddGlobalMaterial(){
  const nid = Date.now();
  let name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞:", "–ù–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª");
  if(name === null) return;
  let cost = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:", "0");
  if(cost === null) return;
  let balance = prompt("–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥):", "0");
  if(balance === null) return;
  let declared = prompt("–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥):", "0");
  if(declared === null) return;
  let waste = prompt("–û—Ç—Ö–æ–¥ (%):", "0");
  if(waste === null) return;
  let manuf = prompt("–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:", "");
  if(manuf === null) return;
  let prodDate = prompt("–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (DD.MM.YYYY):", "");
  if(prodDate === null) return;
  appData.materials.push({
    id: nid,
    name: name,
    costPerKg: parseFloat(cost) || 0,
    balance: parseFloat(balance) || 0,
    declaredWeight: parseFloat(declared) || 0,
    wastePercent: parseFloat(waste) || 0,
    manufacturer: manuf,
    productionDate: prodDate
  });
  saveToLocalStorage();
  renderGlobalMaterialsTable();
}
function onEditGlobalMaterial(id){
  const m = appData.materials.find(x => x.id === id);
  if(!m) return;
  const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞:", m.name);
  if(n === null) return;
  const c = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥:", m.costPerKg);
  if(c === null) return;
  const b = prompt("–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥):", m.balance);
  if(b === null) return;
  const d = prompt("–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥):", m.declaredWeight);
  if(d === null) return;
  const w = prompt("–û—Ç—Ö–æ–¥ (%):", m.wastePercent);
  if(w === null) return;
  const manuf = prompt("–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:", m.manufacturer || "");
  if(manuf === null) return;
  const prodDate = prompt("–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (DD.MM.YYYY):", m.productionDate || "");
  if(prodDate === null) return;
  m.name = n;
  m.costPerKg = parseFloat(c) || 0;
  m.balance = parseFloat(b) || 0;
  m.declaredWeight = parseFloat(d) || 0;
  m.wastePercent = parseFloat(w) || 0;
  m.manufacturer = manuf;
  m.productionDate = prodDate;
  saveToLocalStorage();
  renderGlobalMaterialsTable();
}
function onDeleteGlobalMaterial(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª?")) return;
  appData.materials = appData.materials.filter(x => x.id !== id);
  saveToLocalStorage();
  renderGlobalMaterialsTable();
}

/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥–æ–≤ */
function renderGlobalAdditionalTable(){
  const tb = document.querySelector("#additionalGlobalTable tbody");
  tb.innerHTML = "";
  appData.additionalGlobal.forEach(a => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_globalAdditional_${a.id}" class="globalAdditional_chk"><\/td>
      <td>${a.description}<\/td>
      <td>${a.cost}<\/td>
      <td>${a.hoursToRecoup || 1000}<\/td>
      <td>${a.useInCalc ? "–î–∞" : "–ù–µ—Ç"}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditGlobalAdditional(${a.id})">–†–µ–¥.<\/button>
          <button class="btn btn-warning" onclick="copyElement('globalAdditional', ${a.id})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeleteGlobalAdditional(${a.id})">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tb.appendChild(tr);
  });
}
function onAddGlobalAdditional(){
  const nid = Date.now();
  appData.additionalGlobal.push({
    id: nid,
    description: "–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è",
    cost: 0,
    hoursToRecoup: 1000,
    useInCalc: true
  });
  saveToLocalStorage();
  renderGlobalAdditionalTable();
}
function onEditGlobalAdditional(id){
  const x = appData.additionalGlobal.find(a => a.id === id);
  if(!x) return;
  const d = prompt("–û–ø–∏—Å–∞–Ω–∏–µ:", x.description);
  if(d === null) return;
  const c = prompt("–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ):", x.cost);
  if(c === null) return;
  const hh = prompt("–ß–∞—Å—ã –æ–∫—É–ø.", x.hoursToRecoup || 1000);
  if(hh === null) return;
  const used = confirm("–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç?");
  x.description = d;
  x.cost = parseFloat(c) || 0;
  x.hoursToRecoup = parseFloat(hh) || 1000;
  x.useInCalc = used;
  saveToLocalStorage();
  renderGlobalAdditionalTable();
}
function onDeleteGlobalAdditional(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é?")) return;
  appData.additionalGlobal = appData.additionalGlobal.filter(a => a.id !== id);
  saveToLocalStorage();
  renderGlobalAdditionalTable();
}

/* –§—É–Ω–∫—Ü–∏–∏ –∫–∞–ª—å–∫—É–ª—è—Ü–∏–∏ */
function renderCalcPrinters(){
  const c = document.getElementById("calcPrintersContainer");
  c.innerHTML = "";
  appData.printers.forEach(pr => {
    const block = document.createElement("div");
    block.className = "border p-3 mb-3";
    block.innerHTML = `
      <h5>–ü—Ä–∏–Ω—Ç–µ—Ä: ${pr.name} (ID: ${pr.id})<\/h5>
      <div class="small-text mb-2">
        –ú–æ—â–Ω–æ—Å—Ç—å: ${pr.power}–í—Ç, –û–±—Å–ª: ${pr.maintCostHour}‚ÇΩ/—á, –ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏: ${pr.hoursToRecoup}.
      <\/div>
      <table class="table table-bordered table-sm mb-2" id="calcModelsTable_${pr.id}">
        <thead>
          <tr>
            <th>–ò–º—è –º–æ–¥–µ–ª–∏<\/th>
            <th>–°—Ç–∞—Ç—É—Å<\/th>
            <th>–ß–∞—Å—ã –ø–µ—á–∞—Ç–∏<\/th>
            <th>–í–µ—Å (–≥)<\/th>
            <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
            <th>–î–µ–π—Å—Ç–≤–∏—è<\/th>
          <\/tr>
        <\/thead>
        <tbody><\/tbody>
      <\/table>
      <button class="btn btn-sm btn-primary" onclick="addModelRow(${pr.id}, {})">–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å<\/button>
    `;
    c.appendChild(block);
  });
}
function addModelRow(printerId, modelData) {
  const table = document.getElementById(`calcModelsTable_${printerId}`);
  if(!table) return;
  const tbody = table.querySelector("tbody");
  const idx = tbody.rows.length + 1;
  const statuses = [
    {val:"new", text:"–ù–æ–≤–∞—è"},
    {val:"inprogress", text:"–ü–µ—á–∞—Ç—å"},
    {val:"done", text:"–ì–æ—Ç–æ–≤–∞"},
    {val:"canceled", text:"–û—Ç–º–µ–Ω–µ–Ω–∞"}
  ];
  const optsStatus = statuses.map(s =>
    `<option value="${s.val}" ${(modelData.status === s.val) ? "selected" : ""}>${s.text}<\/option>`
  ).join("");
  const mats = getAllMaterialsForPrinter(printerId);
  const optsMat = mats.map(m =>
    `<option value="${m.id}" ${(modelData.materialId == m.id) ? "selected" : ""}>${m.name}<\/option>`
  ).join("");
  const uniqueId = Date.now() + Math.floor(Math.random()*1000);
  const nameId = `modelName_${printerId}_${uniqueId}`;
  const statusId = `modelStatus_${printerId}_${uniqueId}`;
  const hoursId = `modelHours_${printerId}_${uniqueId}`;
  const weightId = `modelWeight_${printerId}_${uniqueId}`;
  const materialId = `modelMaterial_${printerId}_${uniqueId}`;
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="text" class="form-control form-control-sm" id="${nameId}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${modelData.name || ''}" /><\/td>
    <td>
      <select class="form-select form-select-sm" id="${statusId}">
        ${optsStatus}
      <\/select>
    <\/td>
    <td><input type="number" step="0.1" class="form-control form-control-sm" id="${hoursId}" placeholder="—á" value="${modelData.hours || ''}" /><\/td>
    <td><input type="number" step="0.1" class="form-control form-control-sm" id="${weightId}" placeholder="–≥" value="${modelData.weight || ''}" /><\/td>
    <td>
      <select class="form-select form-select-sm" id="${materialId}">
        <option value="">-–ú–∞—Ç–µ—Ä–∏–∞–ª-<\/option>
        ${optsMat}
      <\/select>
    <\/td>
    <td><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">–£–¥–ª.<\/button><\/td>
  `;
  tbody.appendChild(tr);
}
function getAllMaterialsForPrinter(printerId){
  const pr = appData.printers.find(p => p.id === printerId);
  if(!pr) return [];
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º –æ—Å—Ç–∞—Ç–∫–æ–º
  const globalMats = appData.materials.filter(m => m.balance > 0);
  const printerMats = pr.materials.filter(m => m.balance > 0);
  return [...globalMats, ...printerMats];
}

let lastCalcFullData = null;


function onCalculateAll() {
  const calcName = document.getElementById("calcName").value.trim();
  const clientName = document.getElementById("calcClientName").value.trim();
  const orderStatus = document.getElementById("calcOrderStatus").value;
  const opRate = parseFloat(document.getElementById("calcOperatorRate").value) || 0;
  const whDay = parseFloat(document.getElementById("calcWorkHoursDay").value) || 8;
  const cKwh = parseFloat(document.getElementById("calcCostKwh").value) || 0;
  const tPercent = parseFloat(document.getElementById("calcTaxPercent").value) || 0;
  const ship = parseFloat(document.getElementById("calcShipping").value) || 0;
  const sDate = document.getElementById("calcStartDate").value;
  const parallelMode = document.getElementById("calcParallelPrinting").value;
  const markupPercent = parseFloat(document.getElementById("calcMarkupPercent").value) || 0;
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–∞—Å—á—ë—Ç–∞
  appData.calcSettings.operatorRate = opRate;
  appData.calcSettings.workHoursDay = whDay;
  appData.calcSettings.costKwh = cKwh;
  appData.calcSettings.taxPercent = tPercent;
  appData.calcSettings.shipping = ship;
  appData.calcSettings.startDate = sDate;
  appData.calcSettings.parallelPrinting = parallelMode;
  appData.calcSettings.markupPercent = markupPercent;
  
  saveToLocalStorage();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  let calcData = {};
  appData.printers.forEach(pr => {
    const table = document.getElementById(`calcModelsTable_${pr.id}`);
    if (!table) return;
    const rows = table.querySelectorAll("tbody tr");
    let modelsData = [];
    rows.forEach(row => {
      const inpName = row.querySelectorAll("input")[0];
      const selStatus = row.querySelectorAll("select")[0];
      const inpH = row.querySelectorAll("input")[1];
      const inpW = row.querySelectorAll("input")[2];
      const selM = row.querySelectorAll("select")[1];
      const h = parseFloat(inpH.value) || 0;
      const w = parseFloat(inpW.value) || 0;
      modelsData.push({
        name: inpName.value.trim() || "–ú–æ–¥–µ–ª—å",
        status: selStatus.value || "new",
        hours: h,
        weight: w,
        materialId: parseInt(selM.value, 10)
      });
    });
    calcData[pr.id] = modelsData;
  });
  
  // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º —Å—É–º–º–∞—Ä–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–ª–∞—Å—Ç–∏–∫–∞ (–≤ –≥—Ä–∞–º–º–∞—Ö) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø–æ –≤—Å–µ–º—É —Ä–∞—Å—á—ë—Ç—É
  let materialConsumption = {};
  
  // –†–∞—Å—á—ë—Ç –∑–∞—Ç—Ä–∞—Ç –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º
  let detailsByPrinter = [];
  let sumWithoutTax = 0;
  let finalTimeAllPrinters = 0;
  let maxPrinterTime = 0;
  
  appData.printers.forEach(pr => {
    const table = document.getElementById(`calcModelsTable_${pr.id}`);
    if (!table) return;
    
    let prTime = 0;
    let prCostNoTax = 0;
    let lines = [];
    const rows = table.querySelectorAll("tbody tr");
    rows.forEach(row => {
      const inpName = row.querySelectorAll("input")[0];
      const selStatus = row.querySelectorAll("select")[0];
      const inpH = row.querySelectorAll("input")[1];
      const inpW = row.querySelectorAll("input")[2];
      const selM = row.querySelectorAll("select")[1];
      const h = parseFloat(inpH.value) || 0;
      const w = parseFloat(inpW.value) || 0;
      const mid = parseInt(selM.value, 10);
      if (!mid || h <= 0 || w <= 0) return;
      
      prTime += h;
      
      const mat = getAllMaterialsForPrinter(pr.id).find(x => x.id === mid);
      if (!mat) return;
      
      const costPH = (pr.hoursToRecoup > 0) ? pr.cost / pr.hoursToRecoup : 0;
      const costPrinterPart = h * costPH;
      // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—Ö–æ–¥ –ø–ª–∞—Å—Ç–∏–∫–∞ —Å —É—á—ë—Ç–æ–º –æ—Ç—Ö–æ–¥–æ–≤ (–≤ –≥—Ä–∞–º–º–∞—Ö)
      const realW = w * (1 + (mat.wastePercent / 100));
      // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
      materialConsumption[mid] = (materialConsumption[mid] || 0) + realW;
      
      const costPerGram = mat.costPerKg / 1000;
      const costMaterial = realW * costPerGram;
      
      const costElectric = (pr.power / 1000) * h * cKwh;
      const costMaint = pr.maintCostHour * h;
      const subTotalModel = costPrinterPart + costMaterial + costElectric + costMaint;
      
      prCostNoTax += subTotalModel;
      
      lines.push({
        name: inpName.value.trim() || "–ú–æ–¥–µ–ª—å",
        status: selStatus.value || "new",
        hours: h,
        weight: w,
        matName: mat.name,
        realWeight: realW,
        costPrinterPart: costPrinterPart,
        costMaterial: costMaterial,
        costElectric: costElectric,
        costMaintenance: costMaint,
        subTotalModel: subTotalModel,
        materialData: {
          id: mat.id,
          declaredWeight: mat.declaredWeight,
          manufacturer: mat.manufacturer,
          productionDate: mat.productionDate
        }
      });
    });
    
    // –†–∞—Å—á—ë—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ (–ø–æ –≤—Å–µ–º –µ–≥–æ —Ä–∞—Å—Ö–æ–¥–Ω—ã–º —Å—Ç–∞—Ç—å—è–º)
    let printerAdditionalDetails = [];
    let sumPrAddFull = 0;
    pr.additional.filter(a => a.useInCalc !== false).forEach(a => { sumPrAddFull += a.cost; });
    pr.additional.filter(a => a.useInCalc !== false).forEach(a => {
      let costDistributed = 0;
      if (pr.hoursToRecoup > 0) {
        costDistributed = (a.cost / pr.hoursToRecoup) * prTime;
      }
      printerAdditionalDetails.push({
         description: a.description,
         baseCost: a.cost,
         hoursToRecoup: a.hoursToRecoup,
         costDistributed: costDistributed
      });
    });
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—É–º–º—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –∫ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
    if (pr.hoursToRecoup > 0 && sumPrAddFull > 0) {
      prCostNoTax += (sumPrAddFull / pr.hoursToRecoup) * prTime;
    }
    
    if (parallelMode === "no") {
      finalTimeAllPrinters += prTime;
    } else {
      if (prTime > maxPrinterTime) maxPrinterTime = prTime;
    }
    
    sumWithoutTax += prCostNoTax;
    detailsByPrinter.push({
      printerId: pr.id,
      printerName: pr.name,
      linesDetail: lines,
      printerTime: prTime,
      subTotal: prCostNoTax,
      additionalDetails: printerAdditionalDetails
    });
  });
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –æ—Å—Ç–∞—Ç–∫–∞
  let warnings = [];
  for (let mid in materialConsumption) {
    const required = materialConsumption[mid];
    const mat = findMaterialById(parseInt(mid, 10));
    if (mat && required > (mat.balance * 1000)) {
      warnings.push(`–ú–∞—Ç–µ—Ä–∏–∞–ª–∞ "${mat.name}" –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: —Ç—Ä–µ–±—É–µ—Ç—Å—è ${required.toFixed(2)} –≥, –æ—Å—Ç–∞—Ç–æ–∫ ${(mat.balance * 1000).toFixed(2)} –≥.`);
    }
  }
  
  let finalTimeOperator = (parallelMode === "yes") ? maxPrinterTime : finalTimeAllPrinters;
  const totalOperatorCost = finalTimeOperator * opRate;
  
  let sumGlobalAdd = 0;
  let globalAdditionalDetails = [];
  appData.additionalGlobal.forEach(g => {
    if (!g.useInCalc) return;
    const costPerHour = (g.hoursToRecoup > 0) ? g.cost / g.hoursToRecoup : 0;
    const cVal = costPerHour * finalTimeOperator;
    sumGlobalAdd += cVal;
    globalAdditionalDetails.push({
      id: g.id,
      description: g.description,
      baseCost: g.cost,
      hoursToRecoup: g.hoursToRecoup,
      costDistributed: cVal
    });
  });
  
    let totalLabelsCost = 0;
  if(appData.labelSettings.printLabels) {
    const labelCost = appData.labelSettings.costPerLabel || 0;
    const totalModels = Object.values(calcData).reduce((acc, models) => acc + models.length, 0);
    totalLabelsCost = totalModels * labelCost;
  }

  
  let subtotal = sumWithoutTax + sumGlobalAdd + ship + totalOperatorCost + totalLabelsCost;
  
  if (markupPercent > 0) {
    subtotal *= (1 + markupPercent / 100);
  }
  const finalSum = subtotal / (1 - tPercent / 100);
  const taxAmount = finalSum - subtotal;
  
  let finDateStr = calcFinishDate(sDate, Math.ceil(finalTimeOperator / (whDay || 8)));
  
  let htmlRes = `<strong>–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:<\/strong><br/>`;
  htmlRes += `–ù–∞–∑–≤–∞–Ω–∏–µ: ${calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}, –ö–ª–∏–µ–Ω—Ç: ${clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}, –°—Ç–∞—Ç—É—Å: ${orderStatus}<br/>`;
  htmlRes += `–£—á–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–µ—á–∞—Ç–∏: ${(parallelMode === "yes") ? "–î–∞" : "–ù–µ—Ç"}<br/>`;
  htmlRes += `–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${finalTimeOperator.toFixed(2)} —á.<br/>`;
  htmlRes += `–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${totalOperatorCost.toFixed(2)} ‚ÇΩ<br/>`;
  htmlRes += `–ù–∞—Ü–µ–Ω–∫–∞: ${markupPercent}%.<br/>`;
  htmlRes += `–£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞: ${ship.toFixed(2)} ‚ÇΩ<br/>`;
  htmlRes += `–°—Ç–æ–∏–º–æ—Å—Ç—å —ç—Ç–∏–∫–µ—Ç–æ–∫: ${totalLabelsCost.toFixed(2)} ‚ÇΩ<br/>`;
  htmlRes += `–ü–æ–¥–∏—Ç–æ–≥ (–±–µ–∑ –Ω–∞–ª–æ–≥–∞): ${subtotal.toFixed(2)} ‚ÇΩ<br/>`;
  htmlRes += `–û–±—â–∏–π –Ω–∞–ª–æ–≥ (${tPercent}%): ${taxAmount.toFixed(2)} ‚ÇΩ<br/>`;
  htmlRes += `<strong>–ò—Ç–æ–≥–æ (—Å —É—á–µ—Ç–æ–º –Ω–∞—Ü–µ–Ω–∫–∏, –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –Ω–∞–ª–æ–≥–∞): ${finalSum.toFixed(2)} ‚ÇΩ<\/strong><br/>`;
  if (finDateStr) {
    htmlRes += `–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä–Ω–æ): ${finDateStr}<br/>`;
  }
  if (warnings.length > 0) {
    htmlRes += `<div class="alert alert-warning mt-2">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:<br/>` + warnings.join("<br/>") + `<\/div>`;
  }
  htmlRes += `<hr/><strong>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º:<\/strong><br/>`;
  detailsByPrinter.forEach(d => {
    htmlRes += `<div style="margin-top:1em;">`;
    htmlRes += `<strong>${d.printerName} (ID: ${d.printerId})<\/strong><br/>`;
    htmlRes += `–í—Ä–µ–º—è: ${d.printerTime.toFixed(2)} —á; –ë–µ–∑ –Ω–∞–ª–æ–≥–∞: ${d.subTotal.toFixed(2)} ‚ÇΩ<br/>`;
    if (d.linesDetail.length > 0) {
      htmlRes += `<table class="table table-sm table-bordered mt-1" style="max-width:800px;">`;
      htmlRes += `<thead><tr>
        <th>–ú–æ–¥–µ–ª—å<\/th>
        <th>–°—Ç–∞—Ç—É—Å<\/th>
        <th>–ß–∞—Å—ã<\/th>
        <th>–í–µ—Å (–≥)<\/th>
        <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
        <th>–í–µ—Å+–æ—Ç—Ö–æ–¥<\/th>
        <th>–ë–µ–∑ –Ω–∞–ª–æ–≥–∞ (‚ÇΩ)<\/th>
        <th>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/th>
      <\/tr><\/thead><tbody>`;
      d.linesDetail.forEach(ln => {
        htmlRes += `<tr>
          <td>${ln.name}<\/td>
          <td>${ln.status}<\/td>
          <td>${ln.hours.toFixed(2)}<\/td>
          <td>${ln.weight.toFixed(2)}<\/td>
          <td>${ln.matName}<\/td>
          <td>${ln.realWeight.toFixed(2)}<\/td>
          <td>${ln.subTotalModel.toFixed(2)}<\/td>
          <td>
            <button class="btn btn-sm btn-outline-secondary"
              onclick="downloadThermoLabelHtml('${ln.name}', '${d.printerName}', '${ln.matName}', '${ln.hours.toFixed(2)}', '${ln.weight.toFixed(2)}')">
              –≠—Ç–∏–∫–µ—Ç–∫–∞
            <\/button>
          <\/td>
        <\/tr>`;
      });
      htmlRes += `<\/tbody><\/table>`;
    }
    // –í—ã–≤–æ–¥ —Ç–∞–±–ª–∏—Ü—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ —Å –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º–æ–π
    if (d.additionalDetails && d.additionalDetails.length > 0) {
      htmlRes += `<hr/><strong>–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞:<\/strong>`;
      htmlRes += `<table class="table table-sm table-bordered mt-1" style="max-width:600px;">`;
      htmlRes += `<thead><tr><th>–û–ø–∏—Å–∞–Ω–∏–µ<\/th><th>–ò—Å—Ö. —Å—Ç–æ–∏–º.<\/th><th>–ß–∞—Å—ã –æ–∫—É–ø.<\/th><th>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (‚ÇΩ)<\/th><\/tr><\/thead><tbody>`;
      let sumPrinterAdditional = 0;
      d.additionalDetails.forEach(ad => {
        sumPrinterAdditional += ad.costDistributed;
        htmlRes += `<tr>
          <td>${ad.description}<\/td>
          <td>${ad.baseCost.toFixed(2)}<\/td>
          <td>${ad.hoursToRecoup}<\/td>
          <td>${ad.costDistributed.toFixed(2)}<\/td>
        <\/tr>`;
      });
      htmlRes += `<\/tbody><\/table>`;
      htmlRes += `–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –±–µ–∑ –Ω–∞–ª–æ–≥–∞: ${sumPrinterAdditional.toFixed(2)} ‚ÇΩ<br/>`;
    }
    htmlRes += `<\/div>`;
  });
  
  if (globalAdditionalDetails.length > 0) {
    htmlRes += `<hr/><strong>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ):<\/strong>`;
    htmlRes += `<table class="table table-sm table-bordered mt-1" style="max-width:600px;">`;
    htmlRes += `<thead><tr><th>–û–ø–∏—Å–∞–Ω–∏–µ<\/th><th>–ò—Å—Ö. —Å—Ç–æ–∏–º.<\/th><th>–ß–∞—Å—ã –æ–∫—É–ø.<\/th><th>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (‚ÇΩ)<\/th><\/tr><\/thead><tbody>`;
    globalAdditionalDetails.forEach(gd => {
      htmlRes += `<tr>
        <td>${gd.description}<\/td>
        <td>${gd.baseCost.toFixed(2)}<\/td>
        <td>${gd.hoursToRecoup}<\/td>
        <td>${gd.costDistributed.toFixed(2)}<\/td>
      <\/tr>`;
    });
    htmlRes += `<\/tbody><\/table>`;
    htmlRes += `–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –±–µ–∑ –Ω–∞–ª–æ–≥–∞: ${sumGlobalAdd.toFixed(2)} ‚ÇΩ<br/>`;
  }
  
  document.getElementById("calcResult").style.display = "block";
  document.getElementById("calcResult").innerHTML = htmlRes;
  
  lastCalcFullData = {
    calcName,
    clientName,
    orderStatus,
    total: finalSum,
    totalHours: finalTimeOperator,
    taxPercent: tPercent,
    shipping: ship,
    detailsByPrinter,
    costKwh: cKwh,
    operatorRate: opRate,
    totalOperatorCost: totalOperatorCost,
    calcData,
    globalAdditional: {
      sumGlobalAdd,
      taxAmount,
      details: globalAdditionalDetails
    },
    parallelMode,
    markupPercent
  };
  
  lastCalcFullData.totalLabelsCost = totalLabelsCost;
  
  const dtStr = new Date().toLocaleString("ru-RU");
  const existingIndex = appData.calcHistory.findIndex(entry => entry.calcName === calcName);
  const newEntry = {
    timestamp: Date.now(),
    dateStr: dtStr,
    calcName,
    clientName,
    orderStatus,
    total: finalSum,
    totalHours: finalTimeOperator,
    taxPercent: tPercent,
    shipping: ship,
    operatorRate: opRate,
    costKwh: cKwh,
    totalOperatorCost: totalOperatorCost,
    details: detailsByPrinter,
    calcData,
    globalAdditional: {
      sumGlobalAdd,
      taxAmount,
      details: globalAdditionalDetails
    },
    parallelMode,
    markupPercent
  };
  if (existingIndex !== -1) {
    appData.calcHistory[existingIndex] = newEntry;
  } else {
    appData.calcHistory.push(newEntry);
  }
  saveToLocalStorage();
  renderHistoryTable();
}

function findMaterialById(mid) {
  let mat = appData.materials.find(m => m.id === mid);
  if (mat) return mat;
  for (let p of appData.printers) {
    mat = p.materials.find(m => m.id === mid);
    if (mat) return mat;
  }
  return null;
}


function findMaterialById(mid) {
  let mat = appData.materials.find(m => m.id === mid);
  if (mat) return mat;
  for (let p of appData.printers) {
    mat = p.materials.find(m => m.id === mid);
    if (mat) return mat;
  }
  return null;
}


function calcFinishDate(sv, days){
  if(!sv) return "";
  try{
    const d = new Date(sv);
    d.setDate(d.getDate()+days);
    return d.toLocaleDateString("ru-RU");
  } catch(e){
    return "";
  }
}
function renderHistoryTable(){
  const tb = document.querySelector("#historyTable tbody");
  tb.innerHTML = "";
  appData.calcHistory.forEach(h => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${h.dateStr}<\/td>
      <td>${h.calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}<\/td>
      <td>${h.clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}<\/td>
      <td>
        <select class="form-select form-select-sm" onchange="onChangeCalcHistoryStatus(${h.timestamp}, this.value)">
          <option value="new" ${h.orderStatus==="new"?"selected":""}>–ù–æ–≤—ã–π<\/option>
          <option value="inprogress" ${h.orderStatus==="inprogress"?"selected":""}>–í —Ä–∞–±–æ—Ç–µ<\/option>
          <option value="done" ${h.orderStatus==="done"?"selected":""}>–ó–∞–≤–µ—Ä—à—ë–Ω<\/option>
          <option value="canceled" ${h.orderStatus==="canceled"?"selected":""}>–û—Ç–º–µ–Ω—ë–Ω<\/option>
        <\/select>
      <\/td>
      <td>${h.total.toFixed(2)}<\/td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="onEditCalcHistory(${h.timestamp})">–†–µ–¥–∞–∫—Ç.<\/button>
        <button class="btn btn-sm btn-danger" onclick="onDeleteCalcHistoryEntry(${h.timestamp})">–£–¥–∞–ª–∏—Ç—å<\/button>
      <\/td>
    `;
    tb.appendChild(tr);
  });
}
function onDeleteCalcHistoryEntry(timestamp) {
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?")) return;
  appData.calcHistory = appData.calcHistory.filter(entry => entry.timestamp !== timestamp);
  saveToLocalStorage();
  renderHistoryTable();
}
function onClearCalcHistory(){
  if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?")) return;
  appData.calcHistory = [];
  saveToLocalStorage();
  renderHistoryTable();
}
function onExportHistory(){
  const js = JSON.stringify(appData.calcHistory, null, 2);
  document.getElementById("exportArea").value = js;
}
function onImportHistory(){
  const s = document.getElementById("importArea").value.trim();
  if(!s) {
    if(confirm("–ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
    return;
  }
  try{
    const obj = JSON.parse(s);
    if(!Array.isArray(obj)){
      alert("–û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤.");
      return;
    }
    appData.calcHistory = obj;
    saveToLocalStorage();
    renderHistoryTable();
    alert("–ò–º–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à—ë–Ω.");
  } catch(e){
    alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏: " + e);
  }
}
function onViewFullHistoryHtml(){
  const html = generateFullHistoryHtml();
  const w = window.open("", "_blank", "width=900,height=600");
  w.document.write(html);
  w.document.close();
}
function generateFullHistoryHtml(){
  let s = `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á—ë—Ç–æ–≤<\/title>
  <style>
    body { font-family: sans-serif; margin:20px; }
    h1 { margin-bottom:0.5em; }
    .entry { border:1px solid #ccc; padding:10px; margin-bottom:10px; }
    table { border-collapse: collapse; }
    td, th { border:1px solid #999; padding:4px 6px; }
    .printer-block { margin-top:10px; padding:5px; border:1px dashed #999; }
  <\/style>
<\/head>
<body>
  <h1>–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á—ë—Ç–æ–≤<\/h1>
`;
  if(appData.calcHistory.length === 0){
    s += `<p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.<\/p>`;
  } else {
    appData.calcHistory.forEach(h => {
      s += `<div class="entry">
        <h3>–†–∞—Å—á—ë—Ç –æ—Ç ${h.dateStr}, –∏—Ç–æ–≥: ${h.total.toFixed(2)} ‚ÇΩ<\/h3>
        <p>–ù–∞–∑–≤–∞–Ω–∏–µ: ${h.calcName || "(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}, –ö–ª–∏–µ–Ω—Ç: ${h.clientName || "(–Ω–µ —É–∫–∞–∑–∞–Ω)"}, –°—Ç–∞—Ç—É—Å: ${h.orderStatus || "(–Ω–µ—Ç)"}<\/p>
        <p>–û–ø–µ—Ä–∞—Ç–æ—Ä —á.: ${h.totalHours.toFixed(2)}, –ù–∞–ª–æ–≥: ${h.taxPercent}%, –£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞: ${h.shipping}, –û–ø–µ—Ä–∞—Ç–æ—Ä: ${h.operatorRate}‚ÇΩ/—á, –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ: ${h.costKwh}‚ÇΩ/–∫–í—Ç‚ãÖ—á<\/p>
        <p>–£—á–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–µ—á–∞—Ç–∏: ${h.parallelMode}, –ù–∞—Ü–µ–Ω–∫–∞: ${h.markupPercent}%<\/p>
      `;
      if(h.details && Array.isArray(h.details)){
        h.details.forEach(pr => {
          s += `<div class="printer-block">
            <strong>–ü—Ä–∏–Ω—Ç–µ—Ä: ${pr.printerName} (ID: ${pr.printerId})<\/strong><br/>
            –í—Ä–µ–º—è: ${pr.printerTime.toFixed(2)} —á, –ò—Ç–æ–≥–æ (—Å –Ω–∞–ª–æ–≥–æ–º): ${(pr.totalWithTax||0).toFixed(2)} ‚ÇΩ<br/>
          `;
          if(pr.linesDetail && pr.linesDetail.length>0){
            s += `<table style="margin-top:5px;">
              <thead><tr>
                <th>–ú–æ–¥–µ–ª—å<\/th>
                <th>–°—Ç–∞—Ç—É—Å<\/th>
                <th>–ß–∞—Å—ã<\/th>
                <th>–í–µ—Å (–≥)<\/th>
                <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
                <th>–í–µ—Å —Å –±—Ä–∞–∫–æ–º<\/th>
                <th>–°—É–º–º–∞ (–±–µ–∑ –Ω–∞–ª–æ–≥–∞)<\/th>
              <\/tr><\/thead>
              <tbody>`;
            pr.linesDetail.forEach(ln => {
              s += `<tr>
                <td>${ln.name}<\/td>
                <td>${ln.status}<\/td>
                <td>${ln.hours.toFixed(2)}<\/td>
                <td>${ln.weight.toFixed(2)}<\/td>
                <td>${ln.matName}<\/td>
                <td>${ln.realWeight.toFixed(2)}<\/td>
                <td>${ln.subTotalModel.toFixed(2)}<\/td>
              <\/tr>`;
            });
            s += `<\/tbody><\/table>`;
          }
          s += `<\/div>`;
        });
      }
      if(h.globalAdditional && h.globalAdditional.details && h.globalAdditional.details.length>0){
        s += `<div class="printer-block">
          <strong>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã:<\/strong><br/>
          <table style="margin-top:5px;">
            <thead><tr>
              <th>–û–ø–∏—Å–∞–Ω–∏–µ<\/th><th>–ò—Å—Ö. —Å—Ç–æ–∏–º.<\/th><th>–ß–∞—Å—ã –æ–∫—É–ø.<\/th><th>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ<\/th>
            <\/tr><\/thead>
            <tbody>`;
        h.globalAdditional.details.forEach(gd => {
          s += `<tr>
            <td>${gd.description}<\/td>
            <td>${gd.baseCost.toFixed(2)}<\/td>
            <td>${gd.hoursToRecoup}<\/td>
            <td>${gd.costDistributed.toFixed(2)}<\/td>
          <\/tr>`;
        });
        s += `<\/tbody><\/table>
        –ë–µ–∑ –Ω–∞–ª–æ–≥–∞: ${h.globalAdditional.sumGlobalAdd.toFixed(2)} ‚ÇΩ, –Ω–∞–ª–æ–≥ –Ω–∞ –Ω–∏—Ö: ${h.globalAdditional.sumTaxGlobal?.toFixed(2) || "0.00"} ‚ÇΩ
        <\/div>`;
      }
      s += `<\/div>`;
    });
  }
  s += `<\/body><\/html>`;
  return s;
}
function onChangeCalcHistoryStatus(timestamp, newStatus){
  const it = appData.calcHistory.find(x => x.timestamp === timestamp);
  if(!it) return;
  it.orderStatus = newStatus;
  saveToLocalStorage();
}

/* –§—É–Ω–∫—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ JSON */
function onExportJson(){
  const s = JSON.stringify(appData, null, 2);
  document.getElementById("exportArea").value = s;
}
function onImportJson(){
  const s = document.getElementById("importArea").value.trim();
  if(!s){
    if(confirm("–ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
    return;
  }
  try{
    const obj = JSON.parse(s);
    appData = obj;
    saveToLocalStorage();
    initAll();
    alert("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.");
  } catch(e){
    alert("–û—à–∏–±–∫–∞: " + e);
  }
}
function saveLabelSettings(){
  const cn = document.getElementById("companyNameInput").value.trim();
  const cl = document.getElementById("chatLinkInput").value.trim();
  const cost = parseFloat(document.getElementById("labelCostInput").value) || 0;
  const print = document.getElementById("printLabelsCheckbox").checked;
  
  appData.labelSettings = {
    companyName: cn || "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è",
    chatLink: cl || "https://t.me/example",
    costPerLabel: cost,
    printLabels: print
  };
  saveToLocalStorage();
  alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
}

/* –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞ */
function generateQRCodeCanvas(data, size, callback){
  const tempDiv = document.createElement("div");
  new QRCode(tempDiv, {
    text: data,
    width: size,
    height: size,
    correctLevel: QRCode.CorrectLevel.H
  });
  setTimeout(() => {
    const qrCanvas = tempDiv.querySelector("canvas");
    callback(qrCanvas);
  }, 100);
}

function downloadThermoLabelHtml(modelName, printerName, materialName, hours, weight) {
  const qrSize = 100;
  generateQRCodeCanvas(appData.labelSettings.chatLink, qrSize, function(qrCanvas) {
    const qrDataUrl = qrCanvas ? qrCanvas.toDataURL("image/png") : "";
    const htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=58mm, initial-scale=1">
  <title>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/title>
  <style>
    body { width: 58mm; height: 40mm; margin: 0; padding: 0; font-family: sans-serif; }
    #labelContainer {
      width: 58mm;
      height: 40mm;
      padding: 2mm;
      box-sizing: border-box;
      position: relative;
    }
    .label-header {
      text-align: center;
      font-size: 12pt;
      font-weight: bold;
      margin-bottom: 2mm;
    }
    .label-content {
      font-size: 10pt;
      line-height: 1.2;
    }
    .label-content div { margin-bottom: 1mm; }
    .qr-code {
      position: absolute;
      bottom: 2mm;
      right: 2mm;
      width: 20mm;
      height: 20mm;
    }
  <\/style>
<\/head>
<body>
<div id="labelContainer">
  <div class="label-header">${appData.labelSettings.companyName}<\/div>
  <div class="label-content">
    <div style="text-align: center;">${modelName}<\/div>
    <div>${printerName}<\/div>
    <div>–ú: ${materialName}<\/div>
    <div>–ß: ${hours} —á<\/div>
    <div>–í: ${weight} –≥<\/div>
    <div>–î: ${new Date().toLocaleDateString("ru-RU")}<\/div>
  <\/div>
  <img class="qr-code" src="${qrDataUrl}" alt="QR-–∫–æ–¥">
<\/div>
<\/body>
<\/html>
    `.trim();
    const blob = new Blob([htmlContent], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `ThermoLabel_${modelName}_${Date.now()}.html`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  });
}

/* –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç—Ç–∏–∫–µ—Ç–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 30x20 –º–º */
function downloadMaterialLabelHtml(materialId) {
  // –ò—â–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª —Å–Ω–∞—á–∞–ª–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö, –∑–∞—Ç–µ–º –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
  let mat = appData.materials.find(m => m.id === materialId);
  if(!mat) {
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö, –ø—Ä–æ–≤–µ—Ä—è–µ–º —É –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
    for(let p of appData.printers) {
      mat = p.materials.find(m => m.id === materialId);
      if(mat) break;
    }
  }
  if(!mat) { alert("–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω."); return; }
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —ç—Ç–∏–∫–µ—Ç–∫–∏ (30x20 –º–º)
  const htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=30mm, initial-scale=1">
  <title>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/title>
  <style>
    body { width: 30mm; height: 20mm; margin: 0; padding: 0; font-family: sans-serif; font-size: 8pt; }
    #labelContainer {
      width: 30mm;
      height: 20mm;
      padding: 1mm;
      box-sizing: border-box;
      position: relative;
      border: 1px solid #000;
    }
    .label-header { text-align: center; font-weight: bold; margin-bottom: 1mm; }
    .label-content div { margin-bottom: 0.5mm; }
  <\/style>
<\/head>
<body>
  <div id="labelContainer">
    <div class="label-header">${mat.name}<\/div>
    <div class="label-content">
      <div>${mat.declaredWeight || "-"} –∫–≥<\/div>
      <div>${mat.manufacturer || "-"}<\/div>
      <div>${mat.productionDate || "-"}<\/div>
    <\/div>
  <\/div>
<\/body>
<\/html>
  `.trim();
  
  const blob = new Blob([htmlContent], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `MaterialLabel_${mat.name}_${Date.now()}.html`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function downloadFullDetailedCalculation(){
  if(!lastCalcFullData){ alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–∞."); return; }
  const h = generateMaxDetailedCalcHtml(lastCalcFullData);
  const b = new Blob([h], {type:"text/html"});
  const u = URL.createObjectURL(b);
  const l = document.createElement("a");
  l.href = u;
  l.download = `FullDetailedCalc_${Date.now()}.html`;
  document.body.appendChild(l);
  l.click();
  document.body.removeChild(l);
  URL.revokeObjectURL(u);
}
function generateMaxDetailedCalcHtml(d) {
  let s = `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç<\/title>
  <style>
    body { font-family: sans-serif; margin:20px; }
    .printer-block { margin:10px 0; padding:5px; border:1px dashed #999; }
    table { border-collapse: collapse; }
    td, th { border:1px solid #999; padding:4px 6px; }
  <\/style>
<\/head>
<body>
  <h1>–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç<\/h1>
  <p>–ù–∞–∑–≤–∞–Ω–∏–µ: ${d.calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}, –ö–ª–∏–µ–Ω—Ç: ${d.clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}, –°—Ç–∞—Ç—É—Å: ${d.orderStatus || "?"}<\/p>
  <p>–ò—Ç–æ–≥: <strong>${d.total.toFixed(2)} ‚ÇΩ<\/strong><\/p>
  <p>–û–ø–µ—Ä–∞—Ç–æ—Ä —á.: ${d.totalHours.toFixed(2)} —á, –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${d.totalOperatorCost.toFixed(2)} ‚ÇΩ, –ù–∞–ª–æ–≥: ${d.taxPercent}%, –£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞: ${d.shipping}‚ÇΩ, –≠–ª.: ${d.costKwh}‚ÇΩ/–∫–í—Ç‚ãÖ—á<\/p>
  <p>–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø–µ—á–∞—Ç—å: ${d.parallelMode}, –ù–∞—Ü–µ–Ω–∫–∞: ${d.markupPercent || 0}%<\/p>
  <p>–ü–æ–¥–∏—Ç–æ–≥ (–±–µ–∑ –Ω–∞–ª–æ–≥–∞): ${(d.total - d.globalAdditional.taxAmount).toFixed(2)} ‚ÇΩ, –û–±—â–∏–π –Ω–∞–ª–æ–≥: ${d.globalAdditional.taxAmount.toFixed(2)} ‚ÇΩ<\/p>
  <hr/>
`;
  d.detailsByPrinter.forEach(pr => {
    s += `<div class="printer-block">
      <strong>–ü—Ä–∏–Ω—Ç–µ—Ä: ${pr.printerName} (ID: ${pr.printerId})<\/strong><br/>
      –í—Ä–µ–º—è: ${pr.printerTime.toFixed(2)} —á<br/>
    `;
    if(pr.linesDetail && pr.linesDetail.length>0){
      s += `<table style="margin-top:5px;">
        <thead><tr>
          <th>–ú–æ–¥–µ–ª—å<\/th>
          <th>–°—Ç–∞—Ç—É—Å<\/th>
          <th>–ß–∞—Å—ã<\/th>
          <th>–í–µ—Å (–≥)<\/th>
          <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
          <th>–í–µ—Å —Å –±—Ä–∞–∫–æ–º<\/th>
          <th>–°—É–º–º–∞ (–±–µ–∑ –Ω–∞–ª–æ–≥–∞)<\/th>
        <\/tr><\/thead>
        <tbody>`;
      pr.linesDetail.forEach(ln => {
        s += `<tr>
          <td>${ln.name}<\/td>
          <td>${ln.status}<\/td>
          <td>${ln.hours.toFixed(2)}<\/td>
          <td>${ln.weight.toFixed(2)}<\/td>
          <td>${ln.matName}<\/td>
          <td>${ln.realWeight.toFixed(2)}<\/td>
          <td>${ln.subTotalModel.toFixed(2)}<\/td>
        <\/tr>`;
      });
      s += `<\/tbody><\/table>`;
    }
    s += `<\/div>`;
  });
  s += `<\/body><\/html>`;
  return s;
}
function onEditCalcHistory(timestamp){
  const it = appData.calcHistory.find(x => x.timestamp === timestamp);
  if(!it){ alert("–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏"); return; }
  document.getElementById("calcName").value = it.calcName || "";
  document.getElementById("calcClientName").value = it.clientName || "";
  document.getElementById("calcOrderStatus").value = it.orderStatus || "new";
  document.getElementById("calcOperatorRate").value = it.operatorRate || "";
  document.getElementById("calcWorkHoursDay").value = appData.calcSettings.workHoursDay || "";
  document.getElementById("calcCostKwh").value = it.costKwh || "";
  document.getElementById("calcTaxPercent").value = it.taxPercent || "";
  document.getElementById("calcShipping").value = it.shipping || "";
  document.getElementById("calcStartDate").value = appData.calcSettings.startDate || "";
  document.getElementById("calcParallelPrinting").value = it.parallelMode || "no";
  document.getElementById("calcMarkupPercent").value = it.markupPercent || 0;
  
  if(it.calcData){
    for(const printerId in it.calcData){
      const table = document.getElementById(`calcModelsTable_${printerId}`);
      if(!table) continue;
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";
      it.calcData[printerId].forEach(model => {
        addModelRow(parseInt(printerId, 10), model);
      });
    }
  }
  const tabEl = document.querySelector('#calculate-tab');
  const tab = new bootstrap.Tab(tabEl);
  tab.show();
}
function renderSummary(){
  let totalPrintersCost = 0;
  appData.printers.forEach(p => { totalPrintersCost += p.cost; });
  
  let totalPrintersAdds = 0;
  let totalPrintersMats = 0;
  appData.printers.forEach(p => {
    p.additional.forEach(a => { totalPrintersAdds += a.cost; });
    p.materials.forEach(m => { totalPrintersMats += (m.costPerKg * m.declaredWeight); });
  });
  
  let totalGlobalMats = 0;
  appData.materials.forEach(m => { totalGlobalMats += (m.costPerKg * m.declaredWeight); });
  
  let totalGlobalAdds = 0;
  appData.additionalGlobal.forEach(a => { totalGlobalAdds += a.cost; });
  
  let summ = totalPrintersCost + totalPrintersAdds + totalPrintersMats + totalGlobalMats + totalGlobalAdds;
  
  const el = document.getElementById("summaryContent");
  let h = `
  <div class="mt-3">
    <h5>–ü—Ä–∏–Ω—Ç–µ—Ä—ã:<\/h5>
    <p>–í—Å–µ–≥–æ: ${appData.printers.length}. –°—É–º–º–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏: <strong>${totalPrintersCost}<\/strong> ‚ÇΩ<\/p>
    <p>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –¥–æ–ø.—Ä–∞—Å—Ö–æ–¥—ã: <strong>${totalPrintersAdds}<\/strong> ‚ÇΩ<\/p>
    <p>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (—Å—É–º–º–∞): <strong>${totalPrintersMats}<\/strong> ‚ÇΩ<\/p>
    <hr/>
    <h5>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:<\/h5>
    <p>–í—Å–µ–≥–æ: ${appData.materials.length}, —Å—É–º–º–∞: <strong>${totalGlobalMats}<\/strong> ‚ÇΩ<\/p>
    <hr/>
    <h5>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã:<\/h5>
    <p>–í—Å–µ–≥–æ: ${appData.additionalGlobal.length}, —Å—É–º–º–∞: <strong>${totalGlobalAdds}<\/strong> ‚ÇΩ<\/p>
    <hr/>
    <p>–ò—Ç–æ–≥–æ: <strong>${summ}<\/strong> ‚ÇΩ<\/p>
  <\/div>
  `;
  el.innerHTML = h;
}
</script>
</body>
</html>
