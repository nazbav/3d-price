# Изменения в тестовой версии

## Поддержка нескольких профилей Orca для одного принтера
- В объект принтера добавлено поле `orcaProfiles`.
- Миграция старых данных: при загрузке старого формата данные из `orca` переносятся в массив `orcaProfiles`, поле `orca` удаляется.
- В модальном окне настроек принтера теперь можно выбирать, добавлять и удалять профили Orca.

## Скрипт синхронизации `sync_orca.py`
- При чтении конфигураций Orca профили группируются по `print_host` (или `inherits`).
- Для каждого принтера формируется список `orcaProfiles`, поле `orca` больше не используется.
- Если у нескольких принтеров обнаружены профили с одинаковыми `print_host` или `inherits`,
  они объединяются. Скрипт выбирает принтер с максимально заполненными полями
  (`cost`, `hoursToRecoup`, `power`, `maintCostHour`) и переносит в него все
  профили без повторений.


## Импорт моделей через ссылку
- Поиск нужного принтера выполняется по `printer_settings_id` из профилей Orca.


## Обновление истории расчётов
- При миграции данных проверяется поле `calcHistory`.
- Если запись ссылается на удалённый `printerId`, подбирается наиболее подходящий принтер по `print_host` или названию.
- Найденный идентификатор подставляется во все блоки `details` и `calcData`.
- При отсутствии совпадений создаётся временный принтер, чтобы история не терялась.
- Созданные временные принтеры помечаются для последующей проверки.

## Дополнительные проверки при миграции
- Если в исходных списках встречаются дубликаты принтеров, материалов или расходов,
  они объединяются на основе совпадающих ключевых полей.
- Все числовые значения нормализуются: пустые строки и `null` заменяются на `0`.
- В старых записях истории при отсутствии `clientId`, `markupPercent` или `globalAdditional`
  добавляются значения по умолчанию.
- Если `calcData` отсутствует, информация восстанавливается из массива `details`.

## Исправления и чистка кода
- Исправлена обработка выбора профиля Orca в модальном окне принтера. Теперь при смене профиля в `orcaProfileSelect` данные в полях и JSON-блоках обновляются корректно.
- Удалены неиспользуемые массивы `additional` и `materials` из структуры принтера. Все связанные функции удалены. При импорте старых настроек значения этих полей переносятся в глобальные списки.
- В функции `onShowPrinterDetails` оставлено только отображение названия принтера.

- При расчёте стоимость доп. расходов берётся только из глобального списка `additionalGlobal`.
- Устранены ошибки при чтении профилей материалов в `sync_orca.py` если встречаются некорректные данные.

## План по материалам
- Реализована отдельная коллекция `materialProfiles`. В материалах хранится массив `profileIds`.
- При открытии настроек материала можно добавлять, удалять и выбирать несколько профилей Orca.
- Добавлена кнопка полного удаления профиля из системы.
- Функция миграции `migrateOldData` переносит поля `orca` и `orcaInfo` материалов в новые объекты профилей.
- Скрипт `sync_orca.py` также формирует `materialProfiles` при чтении конфигураций Orca и связывает их с материалами по имени.
- Исправлено падение на странице итогов при отсутствии устаревших массивов в принтерах.

## Исправления импорта принтеров и восстановление из истории
- При загрузке настроек из файлов больше не создаются "пустые" принтеры. Все профили печати объединяются с основным принтером по `print_host` и имени. Дубликаты сливаются, а временные принтеры без использования удаляются.

## Улучшения управления списками
- Исправлено обновление интерфейса после удаления и копирования элементов.
- Массовое и одиночное удаление корректно пересчитывают сводные данные и список принтеров в калькуляции.
- Поле выбора принтера при восстановлении истории отображается выпадающим списком.

## Документация и инструкции
- Проект получил каталог `docs/wiki` с руководством и справочными материалами.
- Добавлен файл `AGENTS.md` с правилами для участников.
- Инструкции обновлены: все правки фиксируются в `CHANGELOG.md`, `FEATURE_LIST.md` и `TEST_CHANGE_LOG.MD`.

## Новые функции
- Система профилей материалов стала общей, синхронизация `sync_orca.py` не добавляет лишние материалы.
- Профиль Orca можно выбрать из общего списка при редактировании любого материала.
- Выпадающий список в окне профиля материала сразу содержит все созданные профили.
- При запуске страницы проверяются расчёты с отсутствующими принтерами и предлагается указать замену.
- Создание новых принтеров по записям истории отключено; их можно добавить вручную или импортировать.
- `sync_orca.py` игнорирует конфигурации Orca без соответствующего принтера.
- Временные принтеры при импорте истории больше не создаются, список для сопоставления появляется автоматически.
- Таблица сопоставления принтеров показывает модель и поддерживает массовое переназначение.
- При удалении принтера, если он упоминается в истории, открывается окно для переноса моделей на существующее устройство.
- README дополнено описанием переноса моделей при удалении принтера.
- Функция сопоставления удалённых принтеров более не поддерживается.
- Исправлена ошибка загрузки скрипта из-за некорректного showMultiPrompt; кнопка сохранения настроек Orca работает.
- В AGENTS.md описан процесс проверки test.html в консоли Ubuntu перед коммитом
- Импорт моделей по ссылке ищет материалы по профилю печати и предлагает выбор при нескольких совпадениях.
- Удалено сложное окно настроек материала; добавлено модальное связывание с профилем Orca и менеджер профилей.
- Исправлена ошибка "Cannot read properties of undefined" при импорте моделей.
- Добавлена кнопка "Применить" в модальном окне связи профилей, устраняя ошибку null onclick.
- Проверка наличия элементов перед привязкой обработчиков избавила от ошибки при импорте новой модели.
- Проверка показала: модальное окно OrcaPrinter открывается и отображает содержимое профиля.
- Тестирование импорта JSON: загруженный профиль добавляется к списку и его можно связать или удалить.
- Проверено: выбор профилей отображает предупреждение при пустом списке, таблица выводит названия профилей.
- Тесты компиляции Python выполнены успешно после обновления sync_orca.py.
- Визуально проверено: кнопка "Детали" отсутствует, цвет материала подсвечивается.
- В `sync_orca.py` исправлено удаление принтера при совпадении хоста с конфигурацией Orca.
- Проверка показала: модальное окно OrcaPrinter содержит поля после первого открытия.
- Проверено: окна связывания профилей отображаются после исправления разметки test.html
- Проверено: менеджер профилей принтеров открывается и показывает список связей
- Отсутствуют кнопки импорта и скачивания профилей в интерфейсе
- Скрипт sync_orca.py включает интерактив и не дублирует профили принтеров
- Проверено: интерактив sync_orca предлагает изменить связь только при её наличии
- Переназначение профиля на другой принтер работает через диалог
- tested import link with numeric profile id: material matched without errors
- Проверено: иконка в таблице моделей позволяет загрузить PNG, который ужимается до 140x110 и сохраняется в Base64.
- Исправлено: детализация по принтерам снова отображается после добавления колонки иконок.

- Verified drag-and-drop gcode parsing adds models without errors
- Проверено: кнопка "Скачать все этикетки" генерирует один HTML-файл со всеми моделями
- Проверено: кнопка "Скачать итоговую карточку" создаёт HTML с данными заказа и сеткой моделей
- Проверено: сводка отображает суммарный вес, итоговую стоимость и корректное название поля 'Требуется'
- Исправлено: при расчёте не возникает ошибки "htmlRes is not defined"
- Проверено: общий результат отображается в виде карточки с данными заказа и сеткой моделей
- Проверено: кнопка "Новый расчёт" удаляет модели и сбрасывает ключевые поля
- Проверено: скидка корректно уменьшает стоимость, старая цена отображается зачеркнутой, финальная цена может быть переопределена
- Проверено: кнопка "Новый расчёт" очищает форму и скрывает результаты
- Проверено: загрузка миниатюры теперь обрезает изображение по центру и сжимает его в JPEG
- Проверено: кнопка отправки чека в 'Мой Налог' появляется после расчёта
- Проверено: сохранение токена и проверка статуса в разделе настроек 'Мой Налог'
- Проверено: кнопка формирования счёта отправляет данные заказа в 'Мой Налог'

- Проверено: после отправки чека и счёта выводятся ответы сервиса
- Проверено: получение токена через вход по телефону и СМС в разделе настроек
- Проверено: авторизация и отправка данных работает через API lknpd.nalog.ru с автоматическим обновлением токена
- Проверено: SMS-подтверждение через api/v2 и константу MY_NALOG_API
- Исправлена ошибка дублирования переменной phone в test.html
- Исправлена синтаксическая ошибка: обработчики DOM теперь назначаются без optional chaining
- Проверено: запрос SMS не требует ввода пароля, поле удалено
- Проверено: сервис принимает запросы с добавленными полями client и ignoreMaxTotalIncomeRestriction
- Проверено: двойное срабатывание кнопок устранено, запрос к "Мой Налог" отправляется один раз
- Проверено: HTML-счёт содержит реквизиты из настроек
- Проверено: после отправки чека заказ переводится в статус "Оплачен" и отображается ссылка на чек
- Проверено: выбор метода оплаты влияет на QR-код в счёте (банковский или СБП)
- Проверено: запросы SMS и подтверждения выполняются один раз
- Проверено: ReferenceError при расчёте не возникает
- Проверено: счёт показывает банковские реквизиты и корректный QR для СБП
- Проверено: при выборе СБП QR ведёт на чат поддержки
- Проверено: при запросе можно принудительно перегенерировать чек
- Проверено: при перегенерации ссылка на предыдущий чек остаётся и помечается красным
- Проверено: QR-код всегда указывает на чат поддержки
- Проверено: банковские реквизиты выводятся из многострочного поля

- Проверено: оплаченные заказы входят в расчёт завершённых в разделе Итоги
- Проверено: в истории расчётов отображается ссылка на чек при его наличии
- Проверено: кнопка «Отменить чек» успешно отменяет последний чек через API
- Проверено: при повторной отправке старый чек автоматически отменяется с причиной «ошибочное формирование», ссылка становится красной

## Переработка интеграции со Spoolman (2024)

### Проведенные тесты:
1. **Синтаксис Python**: Проверено компилирование open_calc.py и sync_orca.py - успешно
2. **Структура HTML**: Проверена корректность модификации test.html - валидна
3. **Функциональность JavaScript**: 
   - Убраны функции создания external_id в Spoolman
   - Переработана логика импорта как основного метода синхронизации
   - Обновлен UI для отражения новых приоритетов

### Требуется дополнительное тестирование:
1. Интеграция с реальным экземпляром Spoolman
2. Проверка корректности импорта данных из Spoolman
3. Тестирование обновления использования материалов
4. Проверка функции очистки дубликатов

### Изменения в интерфейсе:
- Кнопка "Экспорт в Spoolman" скрыта и помечена как устаревшая
- Кнопка "Импорт из Spoolman" переименована в "Синхронизация с Spoolman"
- Добавлено предупреждение о новом подходе в описании
- Функции экспорта помечены как deprecated в коде
