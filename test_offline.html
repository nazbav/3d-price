<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 3D-–ø–µ—á–∞—Ç–∏ (TEST)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --app-navbar-bg: #f1f3f6;
            --app-navbar-border: rgba(15, 23, 42, 0.08);
        }

        [data-bs-theme="dark"] {
            --app-navbar-bg: #1F2533;
            --app-navbar-border: rgba(255, 255, 255, 0.12);
        }
        body { margin: 0; padding: 0; }

        .app-navbar {
            background: var(--app-navbar-bg);
            border: 1px solid var(--app-navbar-border);
            border-radius: 1rem;
            padding: 1rem 1.5rem;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }

        .app-navbar .navbar-brand {
            font-weight: 600;
            font-size: clamp(1.25rem, 2vw, 1.65rem);
            color: var(--bs-body-color);
        }

        .app-navbar .navbar-actions {
            gap: 0.75rem;
        }

        .app-panel {
            background: var(--app-navbar-bg);
            border: 1px solid var(--app-navbar-border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .container { margin-top: 20px; margin-bottom: 20px; }
        .nav-tabs .nav-link.active { font-weight: bold; }
        .small-text { font-size: 0.9rem; color: #555; }
        .footer { margin-top: 40px; font-size: 0.9rem; border-top: 1px solid var(--bs-border-color); padding-top: 10px; }
        table td, table th { vertical-align: middle; white-space: nowrap; }
        .btn-group-sm > .btn { font-size: 0.8rem; padding: 2px 6px; margin-left: 2px; }
        thead th { background-color: var(--bs-table-bg) !important; color: var(--bs-body-color) !important; }
        [data-bs-theme="dark"] thead th { background-color: var(--bs-dark-bg-subtle) !important; color: var(--bs-light) !important; }
        @media (max-width: 576px) {
            .d-flex { flex-wrap: wrap !important; }
            .d-flex > * { margin-top: .5rem; }
        }
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            th, td {
                min-width: 100px;
            }
        }
        .form-select.form-select-sm { min-width: 120px; }

        #calcClientDropdownWrapper {
            position: relative;
        }

        #calcClientDropdownWrapper .dropdown-menu {
            width: 100%;
        }

        #calcClientDropdownMenu {
            max-height: 240px;
            overflow-y: auto;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–∏–∫–µ—Ç–∫–∏ */
        .label-preview { border: 1px solid #000; width: 30mm; height: 20mm; padding: 2mm; font-family: sans-serif; }

        .timeline-day-container {
            border-left: 4px solid rgba(0, 0, 0, 0.1);
            padding: 0.75rem;
            margin-bottom: 1.25rem;
            border-radius: 0.5rem;
            background-color: rgba(0, 0, 0, 0.015);
        }

        .timeline-day-current {
            border-left-color: var(--bs-primary);
            background-color: rgba(13, 110, 253, 0.05);
        }

        .timeline-day-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: capitalize;
        }

        .timeline-printer-row {
            background-color: rgba(0, 0, 0, 0.015);
            font-weight: 600;
        }

        .timeline-model-row {
            background-color: rgba(0, 0, 0, 0.01);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .timeline-model-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: none;
        }

        .timeline-model-id {
            font-size: 0.8rem;
            color: var(--bs-secondary-color);
            margin-left: 0.35rem;
            font-weight: normal;
        }

        .timeline-model-thumb {
            width: 28px;
            height: 28px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.12);
            background: #fff;
        }

        .timeline-slot-current {
            background-color: var(--bs-warning-bg-subtle) !important;
            color: var(--bs-warning-text-emphasis);
            font-weight: 600;
        }
        .timeline-break-row {
            background-color: rgba(255, 193, 7, 0.15);
            color: var(--bs-body-color);
            font-style: italic;
            border-left: 3px solid rgba(255, 193, 7, 0.6);
        }
        .timeline-break-row td {
            border-top: none !important;
        }

        .timeline-day-summary {
            margin-top: 0.5rem;
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 0.4rem;
            background-color: rgba(255, 193, 7, 0.25);
            font-weight: 600;
        }
        .schema-migration-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 1rem;
        }
        .schema-migration-overlay.show {
            display: flex;
        }
        .schema-migration-card {
            width: min(560px, 100%);
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 0.75rem 2rem rgba(0, 0, 0, 0.35);
        }
        .schema-migration-card h2 {
            font-size: 1.35rem;
            margin-bottom: 0.5rem;
        }
        .schema-migration-card ol {
            padding-left: 1.25rem;
        }
        .schema-migration-card li + li {
            margin-top: 0.75rem;
        }
        .schema-migration-card .status {
            font-size: 0.9rem;
        }

        [data-bs-theme="dark"] .timeline-day-container {
            border-left-color: rgba(255, 255, 255, 0.25);
            background-color: rgba(255, 255, 255, 0.05);
        }

        [data-bs-theme="dark"] .timeline-day-current {
            background-color: rgba(13, 110, 253, 0.18);
        }

        [data-bs-theme="dark"] .timeline-printer-row {
            background-color: rgba(255, 255, 255, 0.05);
        }

        [data-bs-theme="dark"] .timeline-model-row {
            background-color: rgba(255, 255, 255, 0.04);
        }

        [data-bs-theme="dark"] .timeline-model-title {
            color: var(--bs-body-color);
        }

        [data-bs-theme="dark"] .timeline-model-id {
            color: var(--bs-secondary-color);
        }

        [data-bs-theme="dark"] .timeline-model-thumb {
            border-color: rgba(255, 255, 255, 0.25);
            background: var(--bs-dark-bg-subtle);
        }

        [data-bs-theme="dark"] .timeline-slot-current {
            background-color: rgba(255, 193, 7, 0.45) !important;
            color: var(--bs-body-color);
        }

        [data-bs-theme="dark"] .timeline-day-summary {
            background-color: rgba(255, 193, 7, 0.28);
        }
        [data-bs-theme="dark"] .timeline-break-row {
            background-color: rgba(255, 193, 7, 0.22);
            border-left-color: rgba(255, 193, 7, 0.85);
            color: rgba(255,255,255,0.9);
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∏—Ç–æ–≥–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ */
        .order-summary-card {
            max-width: 1200px;
            margin: 1rem auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-wrap: wrap;
        }
        .order-summary-card .order-info {
            flex: 1 1 300px;
            background: #f9fafb;
            padding: 1.5rem;
        }
        .order-summary-card .order-info h2 {
            font-size: 1.4rem;
            margin-bottom: 1rem;
            color: #4a90e2;
        }
        .order-summary-card .order-info .qr {
            text-align: center;
            margin-bottom: 1rem;
        }
        .order-summary-card .order-info .qr img {
            width: 120px;
            height: 120px;
        }
        .order-summary-card .info-item { margin-bottom: 0.5rem; font-size: 0.95rem; }
        .order-summary-card .info-item .label { font-weight: 600; color: #666; }
        .order-summary-card .info-item .value { margin-left: 0.5rem; font-weight: 500; }

        .order-summary-card .models { flex: 2 1 600px; padding: 1.5rem; }
        .models-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        .model-card { background: #fff; border-radius: 8px; padding: 1rem; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform .3s ease, box-shadow .3s ease; }
        .model-card:hover { transform: translateY(-4px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .model-card img { width: 48px; height: 48px; margin-bottom: 0.5rem; }
        .model-card h3 { font-size: 1rem; margin-bottom: 0.5rem; color: #4a90e2; }
        .model-card p { font-size: 0.9rem; margin: 0.25rem 0; color: #666; }
        .model-card p strong { color: #333; }

        @media (max-width: 800px) {
            .order-summary-card { flex-direction: column; }
            .order-summary-card .order-info, .order-summary-card .models { flex: 1 1 auto; }
        }
    </style>
</head>
<body>
<div id="schemaMigrationOverlay" class="schema-migration-overlay">
    <div class="schema-migration-card">
        <h2>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
        <p>–ú—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è. –ß—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å, —Å–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä, –∑–∞—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏–º –∏—Ö. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑.</p>
        <ol>
            <li>
                <button id="schemaMigrationBackupBtn" class="btn btn-primary btn-sm">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</button>
                <div id="schemaMigrationBackupStatus" class="status mt-1 text-muted">–®–∞–≥ 1: —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.</div>
            </li>
            <li>
                <button id="schemaMigrationStartBtn" class="btn btn-success btn-sm mt-2" disabled>–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <div id="schemaMigrationProgress" class="status mt-1 text-muted"></div>
            </li>
        </ol>
        <div id="schemaMigrationError" class="text-danger small mt-2"></div>
    </div>
</div>

<div class="container-fluid">

    <div class="app-panel">
        <!-- –û–î–ù–ê –°–¢–†–û–ö–ê: —Ç–∞–±—ã —Å–ª–µ–≤–∞ (—Ä–∞—Å—Ç—è–≥–∏–≤–∞—é—Ç—Å—è), –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ (–ø–æ —à–∏—Ä–∏–Ω–µ) -->
        <div class="row align-items-center g-2">

            <!-- TABLIST -->
            <div class="col">
                <ul class="nav nav-tabs flex-nowrap" id="mainTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="calculate-tab" data-bs-toggle="tab"
                                data-bs-target="#calculatePane" type="button" role="tab"
                                aria-controls="calculatePane" aria-selected="true">
                            –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
                        </button>
                    </li>

                    <li class="nav-item">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab"
                                data-bs-target="#historyPane" type="button" role="tab"
                                aria-controls="historyPane" aria-selected="false">
                            –ò—Å—Ç–æ—Ä–∏—è
                        </button>
                    </li>

                    <li class="nav-item">
                        <button class="nav-link" id="clients-tab" data-bs-toggle="tab"
                                data-bs-target="#clientsPane" type="button" role="tab"
                                aria-controls="clientsPane" aria-selected="false">
                            –ö–ª–∏–µ–Ω—Ç—ã
                        </button>
                    </li>

                    <li class="nav-item">
                        <button class="nav-link" id="printers-tab" data-bs-toggle="tab"
                                data-bs-target="#printersPane" type="button" role="tab"
                                aria-controls="printersPane" aria-selected="false">
                            –ü—Ä–∏–Ω—Ç–µ—Ä—ã
                        </button>
                    </li>

                    <li class="nav-item">
                        <button class="nav-link" id="globalMaterials-tab" data-bs-toggle="tab"
                                data-bs-target="#globalMaterialsPane" type="button" role="tab"
                                aria-controls="globalMaterialsPane" aria-selected="false">
                            –û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                        </button>
                    </li>

                    <li class="nav-item">
                        <button class="nav-link" id="globalAdditional-tab" data-bs-toggle="tab"
                                data-bs-target="#globalAdditionalPane" type="button" role="tab"
                                aria-controls="globalAdditionalPane" aria-selected="false">
                            –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
                        </button>
                    </li>

                    <li class="nav-item d-none">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="tab"
                                data-bs-target="#settingsPane" type="button" role="tab"
                                aria-controls="settingsPane" aria-selected="false">
                            –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                        </button>
                    </li>

                    <li class="nav-item">
                        <button class="nav-link" id="summary-tab" data-bs-toggle="tab"
                                data-bs-target="#summaryPane" type="button" role="tab"
                                aria-controls="summaryPane" aria-selected="false">
                            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </button>
                    </li>
                </ul>
            </div>

            <!-- ACTIONS -->
            <div class="col-auto">
                <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                    <button class="btn btn-outline-primary d-flex align-items-center gap-1" onclick="openSettingsTab()">
                        <span>‚öôÔ∏è</span><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </button>
                    <button class="btn btn-outline-secondary" id="themeToggle">üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</button>
                </div>
            </div>

        </div>




        <div class="tab-content" id="mainTabContent">
            <!-- –ü—Ä–∏–Ω—Ç–µ—Ä—ã -->
            <div class="tab-pane fade" id="printersPane" role="tabpanel" aria-labelledby="printers-tab">
                <div class="mt-4">
                    <h3>–°–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</h3>
                    <p class="small-text">
                        –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–ª—è –Ω–µ–≥–æ.
                    </p>
                    <div class="mb-2">
                        <button class="btn btn-primary btn-sm" onclick="onAddPrinter()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä</button>
                        <button class="btn btn-danger btn-sm" onclick="massDelete('printers')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
                        <button class="btn btn-warning btn-sm" onclick="massEdit('printers')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
                        <button class="btn btn-info btn-sm" id="managePrinterProfilesBtn">–ü—Ä–æ—Ñ–∏–ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</button>
                    </div>
                    <div class="table-responsive">
                        <input type="text" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable('printersTable', this.value)">
                        <table class="table table-bordered table-hover" id="printersTable">
                            <thead class="">
                            <tr>
                                <th><input type="checkbox" id="selectAll_printers" onchange="selectAll(this, 'printers')"></th>
                                <th onclick="sortTable('printersTable',1)">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th onclick="sortTable('printersTable',2)">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</th>
                                <th onclick="sortTable('printersTable',3)">–ß–∞—Å—ã –æ–∫—É–ø.</th>
                                <th onclick="sortTable('printersTable',4)">–ú–æ—â–Ω. (–í—Ç)</th>
                                <th onclick="sortTable('printersTable',5)">–û–±—Å–ª. (‚ÇΩ/—á)</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <hr/>
            </div>

            <!-- –û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã -->
            <div class="tab-pane fade" id="globalMaterialsPane" role="tabpanel" aria-labelledby="globalMaterials-tab">
                <div class="mt-4">
                    <h3>–û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
                    <p class="small-text">–≠—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º ¬´–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é¬ª. –£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥, –æ—Å—Ç–∞—Ç–æ–∫, –∑–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –∏ –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.</p>
                    <div class="mb-2">
                        <button class="btn btn-primary btn-sm" onclick="onAddGlobalMaterial()">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
                        <button class="btn btn-danger btn-sm" onclick="massDelete('globalMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
                        <button class="btn btn-warning btn-sm" onclick="massEdit('globalMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
                        <button class="btn btn-info btn-sm" id="manageMaterialProfilesBtn">–ü—Ä–æ—Ñ–∏–ª–∏ Orca</button>
                    </div>
                    <div class="table-responsive">
                        <input type="text" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable('materialsTable', this.value)">
                        <table class="table table-bordered table-hover" id="materialsTable">
                            <thead class="">
                            <tr>
                                <th><input type="checkbox" id="selectAll_globalMaterials" onchange="selectAll(this, 'globalMaterials')"></th>
                                <th onclick="sortTable('materialsTable',1)">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th onclick="sortTable('materialsTable',1)">–¢–∏–ø</th>
                                <th onclick="sortTable('materialsTable',2)">–°—Ç–æ–∏–º./–∫–≥</th>
                                <th onclick="sortTable('materialsTable',3)">–û—Å—Ç–∞—Ç–æ–∫ (–≥—Ä)</th>
                                <th onclick="sortTable('materialsTable',4)">–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥)</th>
                                <th onclick="sortTable('materialsTable',5)">–í—Ä–µ–º—è –æ—Å—Ç—ã–≤. (–º–∏–Ω)</th>
                                <th onclick="sortTable('materialsTable',6)">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–º–∏–Ω)</th>
                                <th onclick="sortTable('materialsTable',7)">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</th>
                                <th onclick="sortTable('materialsTable',8)">–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤.</th>
                                <th>–ü—Ä–∏–Ω—Ç–µ—Ä—ã</th>
                                <th>–ü—Ä–æ—Ñ–∏–ª–∏</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã -->
            <div class="tab-pane fade" id="globalAdditionalPane" role="tabpanel" aria-labelledby="globalAdditional-tab">
                <div class="mt-4">
                    <h3>–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</h3>
                    <div class="mb-2">
                        <button class="btn btn-primary btn-sm" onclick="onAddGlobalAdditional()">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
                        <button class="btn btn-danger btn-sm" onclick="massDelete('globalAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
                        <button class="btn btn-warning btn-sm" onclick="massEdit('globalAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
                    </div>
                    <div class="table-responsive">
                        <input type="text" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable('additionalGlobalTable', this.value)">
                        <table class="table table-bordered table-hover" id="additionalGlobalTable">
                            <thead class="">
                            <tr>
                                <th><input type="checkbox" id="selectAll_globalAdditional" onchange="selectAll(this, 'globalAdditional')"></th>
                                <th onclick="sortTable('additionalGlobalTable',1)">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th onclick="sortTable('additionalGlobalTable',2)">–°—Ç–æ–∏–º. (‚ÇΩ)</th>
                                <th onclick="sortTable('additionalGlobalTable',3)">–ß–∞—Å—ã –æ–∫—É–ø.</th>
                                <th onclick="sortTable('additionalGlobalTable',4)">–í–∫–ª. –≤ —Ä–∞—Å—á—ë—Ç?</th>
                                <th>–ü—Ä–∏–Ω—Ç–µ—Ä—ã</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
            <div class="tab-pane fade show active" id="calculatePane" role="tabpanel" aria-labelledby="calculate-tab">
                <div class="my-4">
                    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                        <h3 class="mb-2 mb-md-0">–†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–æ—á–µ—Ä–µ–¥—å –ø–µ—á–∞—Ç–∏)</h3>
                        <div class="text-muted small">–ö–æ–¥ –∑–∞–∫–∞–∑–∞: <span class="fw-semibold" id="calcOrderIdText">‚Äî</span>
                        </div>
                    </div>
                    <p class="small-text mb-0">
                        –î–æ 10 –º–æ–¥–µ–ª–µ–π –Ω–∞ –∫–∞–∂–¥—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞, –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞.
                    </p>
                    <input type="hidden" id="calcOrderId"/>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="calcName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞:</label>
                        <input type="text" id="calcName" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫–∞–∑ 123" />
                    </div>
                    <div class="col-md-4">
                        <label for="calcClientName" class="form-label">–ö–ª–∏–µ–Ω—Ç (–§–ò–û/–∫–æ–º–ø–∞–Ω–∏—è):</label>
                        <div class="dropdown w-100" id="calcClientDropdownWrapper">
                            <div class="input-group">
                                <input type="text"
                                       id="calcClientName"
                                       class="form-control"
                                       placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω"
                                       autocomplete="off"
                                       onfocus="onClientFieldFocus()"
                                       oninput="onCalcClientInput()"
                                       onkeydown="onClientFieldKeydown(event)"/>
                            </div>
                            <div class="dropdown-menu w-100 p-0" id="calcClientDropdownMenu"></div>
                        </div>
                        <div class="form-text">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤–æ–µ –∏–º—è –≤—Ä—É—á–Ω—É—é. –ù–∞–∂–º–∏—Ç–µ
                            Enter, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="calcOrderStatus" class="form-label">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:</label>
                        <select id="calcOrderStatus" class="form-select" onchange="toggleFinalFields(this.value)">
                            <option value="new">–ù–æ–≤—ã–π</option>
                            <option value="inprogress">–í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
                            <option value="paid">–û–ø–ª–∞—á–µ–Ω</option>
                            <option value="canceled">–û—Ç–º–µ–Ω—ë–Ω</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="calcUrgencyProfile" class="form-label">–°—Ä–æ—á–Ω–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞:</label>
                        <select id="calcUrgencyProfile" class="form-select"></select>
                    </div>
                    <div class="col-md-8 d-flex align-items-end">
                        <div class="small-text" id="calcUrgencySummary"></div>
                    </div>
                </div>
                <div class="row mb-3" id="calcAdvancedSettings" style="display:none"></div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="calcShipping" class="form-label">–£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞ (‚ÇΩ):</label>
                        <input type="number" step="1" id="calcShipping" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label for="calcStartDate" class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</label>
                        <input type="datetime-local" id="calcStartDate" class="form-control"/>
                    </div>
                    <div class="col-md-3">
                        <label for="calcDeadlineDate" class="form-label">–¢—Ä–µ–±—É–µ–º–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                        <input type="datetime-local" id="calcDeadlineDate" class="form-control"/>
                        <div class="form-text">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞, –ø—Ä–æ—Ñ–∏–ª—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
                    </div>
                    <div class="col-md-3">
                        <label for="calcParallelPrinting" class="form-label">–£—á—ë—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–µ—á–∞—Ç–∏?</label>
                        <select id="calcParallelPrinting" class="form-select">
                            <option value="no">–ù–µ—Ç</option>
                            <option value="yes">–î–∞</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="calcMarkupPercent" class="form-label">–ù–∞—Ü–µ–Ω–∫–∞ (%):</label>
                        <input type="number" step="1" id="calcMarkupPercent" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label for="calcDiscountPercent" class="form-label">–°–∫–∏–¥–∫–∞ (%):</label>
                        <input type="number" step="1" id="calcDiscountPercent" class="form-control" />
                    </div>
                    <div class="col-md-3 d-none" id="finalCostGroup">
                        <label for="calcFinalCost" class="form-label">–§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (‚ÇΩ):</label>
                        <input type="number" step="0.01" id="calcFinalCost" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label for="calcPreparationTime" class="form-label">–ß–∞—Å—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (—á:–º):</label>
                        <input type="text" id="calcPreparationTime" class="form-control" onblur="this.value = formatTimeForDisplay(handleTimeInput({target:{value:this.value}}))" />
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">–£—Å–ª—É–≥–∏:</label>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered" id="customServicesTable">
                                <thead>
                                <tr>
                                    <th>–í–∫–ª.</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥.</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–¢–∏–ø</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="addCustomService()">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</button>
                    </div>
                </div>
                <hr/>
                <div id="calcPrintersContainer"></div>
                <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3 mt-3">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <button class="btn btn-success" onclick="onCalculateAll()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Å—ë</button>
                        <button class="btn btn-warning ms-2 me-lg-5" id="downloadSummaryCardBtn" style="display:none">–°–∫–∞—á–∞—Ç—å —Å–º–µ—Ç—É</button>
                    </div>
                    <button class="btn btn-secondary" onclick="startNewCalculation()">–ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</button>
                </div>
                <div class="alert alert-info mt-3" id="calcResult" style="display: none;"></div>


            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="tab-pane fade" id="summaryPane" role="tabpanel" aria-labelledby="summary-tab">
                <div class="mt-4">
                    <h3>–û–±—â–∏–π –æ–±–∑–æ—Ä (¬´–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞¬ª)</h3>
                    <p class="small-text">–°—É–º–º–∞—Ä–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º, –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º (–±–µ–∑. —É—á –æ—Å—Ç–∞—Ç–∫–∞).</p>
                    <div class="d-flex align-items-center mb-3">
                        <select id="summaryPeriod" class="form-select form-select-sm w-auto me-2">
                            <option value="all">–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</option>
                            <option value="week">–ù–µ–¥–µ–ª—è</option>
                            <option value="month">–ú–µ—Å—è—Ü</option>
                            <option value="year">–ì–æ–¥</option>
                            <option value="custom">–†—É—á–Ω–æ–π</option>
                        </select>
                        <input type="date" id="summaryFrom" class="form-control form-control-sm w-auto me-2 d-none">
                        <input type="date" id="summaryTo" class="form-control form-control-sm w-auto me-2 d-none">
                        <button class="btn btn-primary btn-sm d-none" id="summaryApplyBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                    <div id="summaryContent"></div>
                </div>
            </div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è -->
            <div class="tab-pane fade" id="historyPane" role="tabpanel" aria-labelledby="history-tab">
                <div class="mt-4">
                    <h3>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤</h3>
                    <p class="small-text">
                        –ü—Ä–æ—à–ª—ã–µ —Ä–∞—Å—á—ë—Ç—ã. ¬´–†–µ–¥–∞–∫—Ç.¬ª ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.
                    </p>
                    <div class="table-responsive">
                        <input type="text" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable('historyTable', this.value)">
                        <table class="table table-bordered table-hover" id="historyTable">
                            <thead class="">
                            <tr>
                                <th onclick="sortTable('historyTable',0)">–î–∞—Ç–∞/–≤—Ä–µ–º—è</th>
                                <th onclick="sortTable('historyTable',1)">–ö–æ–¥</th>
                                <th onclick="sortTable('historyTable',2)">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞</th>
                                <th onclick="sortTable('historyTable',3)">–ö–ª–∏–µ–Ω—Ç</th>
                                <th onclick="sortTable('historyTable',4)">–°—Ç–∞—Ç—É—Å</th>
                                <th onclick="sortTable('historyTable',5)">–ò—Ç–æ–≥ (‚ÇΩ)</th>
                                <th>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div class="row g-2 mt-3">
                            <div class="col-auto">
                                <input type="date" class="form-control" id="histFrom">
                            </div>
                            <div class="col-auto">
                                <input type="date" class="form-control" id="histTo">
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-primary" onclick="updateHistoryStats()">–§–∏–ª—å—Ç—Ä</button>
                            </div>
                        </div>
                        <div id="historyStats" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- –ö–ª–∏–µ–Ω—Ç—ã -->
            <div class="tab-pane fade" id="clientsPane" role="tabpanel" aria-labelledby="clients-tab">
                <div class="mt-4">
                    <h3>–ö–ª–∏–µ–Ω—Ç—ã</h3>
                    <div class="mb-2">
                        <button class="btn btn-primary btn-sm" onclick="onAddClient()">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
                    </div>
                    <div class="table-responsive">
                        <input type="text" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable('clientsTable', this.value)">
                        <table class="table table-bordered table-hover" id="clientsTable">
                            <thead>
                            <tr>
                                <th onclick="sortTable('clientsTable',0)">–ò–º—è</th>
                                <th onclick="sortTable('clientsTable',1)">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th onclick="sortTable('clientsTable',2)">–°—Å—ã–ª–∫–∏</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="tab-pane fade" id="settingsPane" role="tabpanel" aria-labelledby="settings-tab">
            <div class="row mt-4">
                <div class="col-md-3 mb-3">
                    <div class="nav flex-column nav-pills" id="settingsSubTab" role="tablist">
                        <button class="nav-link active" id="brand-set-tab" data-bs-toggle="pill" data-bs-target="#brandSet" type="button" role="tab">–ë—Ä–µ–Ω–¥–∏–Ω–≥</button>
                        <button class="nav-link" id="calc-set-tab" data-bs-toggle="pill" data-bs-target="#calcSet" type="button" role="tab">–ö–∞–ª—å–∫—É–ª—è—Ü–∏—è</button>
                        <button class="nav-link" id="cloud-set-tab" data-bs-toggle="pill" data-bs-target="#cloudSet" type="button" role="tab">–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç</button>
                        <button class="nav-link" id="about-set-tab" data-bs-toggle="pill" data-bs-target="#aboutSet"
                                type="button" role="tab">–û –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
                        </button>
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="tab-content" id="settingsSubTabContent">
                        <div class="tab-pane fade show active" id="brandSet" role="tabpanel">
                            <h3>–ë—Ä–µ–Ω–¥–∏–Ω–≥</h3>
                            <div class="mb-3">
                                <label for="companyNameInput" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏:</label>
                                <input type="text" id="companyNameInput" class="form-control"/>
                            </div>
                            <div class="mb-3">
                                <label for="chatLinkInput" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç (QR):</label>
                                <input type="text" id="chatLinkInput" class="form-control"/>
                            </div>
                            <div class="mb-3">
                                <label for="bankDetailsInput" class="form-label">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã (—Ä/—Å):</label>
                                <textarea id="bankDetailsInput" class="form-control" rows="4"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–ü—Ä–æ—Ñ–∏–ª–∏ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤:</label>
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-5">
                                        <select id="urgencyProfileSelect" class="form-select"></select>
                                    </div>
                                    <div class="col-md-7 text-md-end">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="addUrgencyProfileBtn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="deleteUrgencyProfileBtn">–£–¥–∞–ª–∏—Ç—å</button>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-4">
                                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</label>
                                        <input type="text" id="urgencyProfileName" class="form-control"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">–ù–∞—Ü–µ–Ω–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (%)</label>
                                        <input type="number" step="1" id="urgencyProfileMarkup" class="form-control"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                        <input type="text" id="urgencyProfileDescription" class="form-control"/>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">–†–∞–±–æ—á–∏–π –≥—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏:</label>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#workdayTemplateModal">–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–Ω—è</button>
                                </div>
                                <ul class="nav nav-tabs mb-3" id="operatorWeekTabs" role="tablist"></ul>
                                <div class="tab-content border rounded p-3" id="operatorWeekContent"></div>
                                <div class="form-text" id="urgencyScheduleHint"></div>
                                <div class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫–∏ –ø—É—Å—Ç—ã–º–∏, –µ—Å–ª–∏ –¥–µ–Ω—å –Ω–µ—Ä–∞–±–æ—á–∏–π. –ü–µ—Ä–µ—Ä—ã–≤—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç. 108 –∏ 109 –¢–ö –†–§.</div>
                                <div class="form-text">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –∑–∞–¥–∞—Ç—å —à–∞–±–ª–æ–Ω (6/8/12 —á–∞—Å–æ–≤—ã–µ —Å–º–µ–Ω—ã, –æ–±–µ–¥ –∏ —Å–ø–µ—Ü–ø–µ—Ä–µ—Ä—ã–≤—ã). –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</div>
                            </div>
                            <button class="btn btn-primary" onclick="saveBrandingSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </div>
                        <div class="tab-pane fade" id="calcSet" role="tabpanel">
                            <h3>–ö–∞–ª—å–∫—É–ª—è—Ü–∏—è</h3>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="printLabelsCheckbox">
                                <label class="form-check-label" for="printLabelsCheckbox">–ü–µ—á–∞—Ç–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏</label>
                            </div>
                            <div class="mb-3">
                                <label for="labelCostInput" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å 1 —ç—Ç–∏–∫–µ—Ç–∫–∏ (‚ÇΩ):</label>
                                <input type="number" step="0.01" id="labelCostInput" class="form-control"/>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="printEstimateCheckbox">
                                <label class="form-check-label" for="printEstimateCheckbox">–£—á–∏—Ç—ã–≤–∞—Ç—å –ø–µ—á–∞—Ç—å —Å–º–µ—Ç—ã</label>
                            </div>
                            <div class="mb-3">
                                <label for="estimatePrintCostInput" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏ —Å–º–µ—Ç—ã (‚ÇΩ):</label>
                                <input type="number" step="0.01" id="estimatePrintCostInput" class="form-control"/>
                            </div>
                            <div class="mb-3">
                                <label for="calcOperatorRate" class="form-label">–°—Ç–∞–≤–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (‚ÇΩ/—á):</label>
                                <input type="number" step="0.01" id="calcOperatorRate" class="form-control" />
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="calcOperatorReject">
                                <label class="form-check-label" for="calcOperatorReject">–£—á–µ—Å—Ç—å —Å—Ç–∞–≤–∫—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –±—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π</label>
                            </div>
                            <div class="mb-3">
                                <label for="calcDowntimeCost" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∏–Ω—É—Ç—ã –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ/–º–∏–Ω):</label>
                                <input type="number" step="0.01" id="calcDowntimeCost" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label for="calcPreparationRate" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (‚ÇΩ/—á):</label>
                                <input type="number" step="0.01" id="calcPreparationRate" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label for="calcCostKwh" class="form-label">–¶–µ–Ω–∞ 1‚ÄØ–∫–í—Ç‚ãÖ—á (‚ÇΩ):</label>
                                <input type="number" step="0.01" id="calcCostKwh" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label for="calcTaxPercent" class="form-label">–ù–∞–ª–æ–≥ (%):</label>
                                <input type="number" step="1" id="calcTaxPercent" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label for="calcRoundingMode" class="form-label">–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏:</label>
                                <select id="calcRoundingMode" class="form-select">
                                    <option value="none">–ë–µ–∑ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è</option>
                                    <option value="round10">–î–æ 10 ‚ÇΩ (–≤–≤–µ—Ä—Ö)</option>
                                    <option value="round100">–î–æ 100 ‚ÇΩ (–≤–≤–µ—Ä—Ö)</option>
                                </select>
                                <div class="form-text">–î–æ–ø–ª–∞—Ç–∞ –∑–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Ü–µ–Ω–∫–∞.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-block">–†–∞—Å—á—ë—Ç–Ω—ã–µ –æ–ø—Ü–∏–∏:</label>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="settingsIncludeAmortization">
                                    <label class="form-check-label" for="settingsIncludeAmortization">–£—á–∏—Ç—ã–≤–∞—Ç—å –∞–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—é –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="settingsIncludeRejects">
                                    <label class="form-check-label" for="settingsIncludeRejects">–£—á–∏—Ç—ã–≤–∞—Ç—å –±—Ä–∞–∫ –≤ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="settingsIncludeOverheads">
                                    <label class="form-check-label" for="settingsIncludeOverheads">–£—á–∏—Ç—ã–≤–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="settingsIgnoreCoolingRejects">
                                    <label class="form-check-label" for="settingsIgnoreCoolingRejects">–ù–µ —É—á–∏—Ç—ã–≤–∞—Ç—å –æ—Å—Ç—ã–≤–∞–Ω–∏–µ –¥–ª—è –±—Ä–∞–∫–∞</label>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="saveCalcSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </div>
                        <div class="tab-pane fade" id="cloudSet" role="tabpanel">
                            <div class="mt-4">
                                <h3>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                                <button class="btn btn-primary" onclick="onExportJson()">–í—ã–≥—Ä—É–∑–∏—Ç—å JSON</button>
                                <button class="btn btn-info" id="downloadJsonFileBtn">–°–∫–∞—á–∞—Ç—å JSON —Ñ–∞–π–ª</button>
                                <textarea id="exportArea" class="form-control mt-2" rows="5"></textarea>
                            </div>
                            <div class="mt-4">
                                <h3>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                                <textarea id="importArea" class="form-control" rows="5"></textarea>
                                <input type="file" id="importJsonFile" class="form-control mt-2" accept=".json">
                                <button class="btn btn-success mt-2" onclick="onImportJson()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button class="btn btn-info mt-2" onclick="importFromFile()">–ò–º–ø–æ—Ä—Ç –∏–∑ —Ñ–∞–π–ª–∞</button>

                                <div class="mt-3 p-3 border rounded bg-light">
                                    <h5 class="mb-2">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –º–æ–¥–∞–ª–æ–∫ –∏–º–ø–æ—Ä—Ç–∞</h5>
                                    <div class="small text-muted mb-2">
                                        –ó–¥–µ—Å—å —Ö—Ä–∞–Ω—è—Ç—Å—è –≤–∞—à–∏ —Ä–µ—à–µ–Ω–∏—è ¬´—Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å ‚Üí –ø—Ä–∏–Ω—Ç–µ—Ä/–º–∞—Ç–µ—Ä–∏–∞–ª/–∑–∞–∫–∞–∑¬ª (–µ—Å–ª–∏ –≤—ã –≤–∫–ª—é—á–∞–ª–∏ –≥–∞–ª–æ—á–∫—É ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª).
                                    </div>
                                    <div class="d-flex gap-2 align-items-center flex-wrap">
                                        <button class="btn btn-outline-danger btn-sm" type="button" id="clearPromptMemoryBtn">–û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</button>
                                        <div class="small text-muted" id="promptMemoryStats"></div>
                                    </div>
                                </div>

                                <div class="alert alert-secondary mt-3 mb-0 small">
                                    <p class="mb-1">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ LocalStorage –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.</p>
                                    <p class="mb-0">–ß—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø—É—Å—Ç–æ–π JSON –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç–µ
                                        LocalStorage –≤—Ä—É—á–Ω—É—é.</p>
                                </div>
                            </div>

                        </div>
                        <div class="tab-pane fade" id="aboutSet" role="tabpanel">
                            <div class="mt-4">
                                <h3>–û –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ</h3>
                                <p class="mb-0"> –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ–±—Ä–∞–Ω –Ω–∞
                                    Bootstrap 5, –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —á–∏—Å—Ç–æ–º JavaScript –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏, –¥–∞–Ω–Ω—ã–µ –∂–∏–≤—É—Ç –≤
                                    LocalStorage –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
<div class="modal fade" id="workdayTemplateModal" tabindex="-1" aria-labelledby="workdayTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="workdayTemplateModalLabel">–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="workdayTemplateSelect" class="form-label">–®–∞–±–ª–æ–Ω</label>
                        <select id="workdayTemplateSelect" class="form-select">
                            <option value="custom" data-hours="" data-lunch="" data-offset="">–°–≤–æ–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</option>
                            <option value="6h_center" data-hours="6" data-lunch="30" data-offset="180">6 —á ¬∑ –æ–±–µ–¥ 30 –º–∏–Ω (–ø–æ —Ü–µ–Ω—Ç—Ä—É)</option>
                            <option value="8h_classic" data-hours="8" data-lunch="60" data-offset="240">8 —á ¬∑ –æ–±–µ–¥ 1 —á–∞—Å</option>
                            <option value="8h_short" data-hours="8" data-lunch="30" data-offset="270">8 —á ¬∑ –æ–±–µ–¥ 30 –º–∏–Ω</option>
                            <option value="12h_long" data-hours="12" data-lunch="60" data-offset="240">12 —á ¬∑ –æ–±–µ–¥ 1 —á–∞—Å</option>
                            <option value="12h_short" data-hours="12" data-lunch="30" data-offset="360">12 —á ¬∑ –æ–±–µ–¥ 30 –º–∏–Ω</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="workdayStartTime" class="form-label">–ù–∞—á–∞–ª–æ —Å–º–µ–Ω—ã</label>
                        <input type="time" id="workdayStartTime" class="form-control" value="09:00">
                    </div>
                    <div class="col-md-3">
                        <label for="workdayTotalHours" class="form-label">–†–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤</label>
                        <input type="number" step="0.5" min="1" max="16" id="workdayTotalHours" class="form-control" value="8">
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label for="workdayLunchStart" class="form-label">–ù–∞—á–∞–ª–æ –æ–±–µ–¥–∞</label>
                        <input type="time" id="workdayLunchStart" class="form-control" value="13:00">
                    </div>
                    <div class="col-md-4">
                        <label for="workdayLunchDuration" class="form-label">–û–±–µ–¥, –º–∏–Ω—É—Ç</label>
                        <input type="number" min="30" max="120" step="5" id="workdayLunchDuration" class="form-control" value="60">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="workdaySkipLunch">
                            <label class="form-check-label" for="workdaySkipLunch">–ë–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –æ–±–µ–¥–∞ (—Å–º–µ–Ω—ã ‚â§ 4 —á)</label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">–°–ø–µ—Ü–ø–µ—Ä–µ—Ä—ã–≤—ã (—Å—Ç.109 –¢–ö –†–§)</label>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary" id="addSpecialBreakBtn">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ—Ä—ã–≤</button>
                            <button type="button" class="btn btn-outline-secondary" id="addPresetBreaksBtn">+2 √ó 10 –º–∏–Ω</button>
                        </div>
                    </div>
                    <div id="specialBreaksContainer" class="small"></div>
                    <div class="form-text">–ü–µ—Ä–µ—Ä—ã–≤—ã –Ω–∞ –æ–±–æ–≥—Ä–µ–≤ –∏ –æ—Ç–¥—ã—Ö –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è, –Ω–æ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏.</div>
                </div>
                <div class="mt-3">
                    <label class="form-label">–î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
                    <div class="d-flex flex-wrap gap-2" id="workdayDaysContainer">
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" value="1"> –ü–Ω</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" value="2"> –í—Ç</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" value="3"> –°—Ä</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" value="4"> –ß—Ç</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" value="5"> –ü—Ç</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" value="6"> –°–±</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" value="0"> –í—Å</label>
                    </div>
                </div>
                <div class="alert alert-secondary mt-3 mb-0 small">
                    <p class="mb-1"><strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¢–ö –†–§:</strong> –æ–±–µ–¥ 30‚Äì120 –º–∏–Ω—É—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø—Ä–∏ —Å–º–µ–Ω–∞—Ö —Å–≤—ã—à–µ 4 —á–∞—Å–æ–≤ (—Å—Ç.108), —Å–ø–µ—Ü–ø–µ—Ä–µ—Ä—ã–≤—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ü–í–¢–† –∏ –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è (—Å—Ç.109).</p>
                    <p class="mb-0">–®–∞–±–ª–æ–Ω—ã —É—á–∏—Ç—ã–≤–∞—é—Ç –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è 6/8/12-—á–∞—Å–æ–≤—ã—Ö —Å–º–µ–Ω. –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–Ω—è–º, –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–∞–∑–¥–µ–ª ¬´–ë—Ä–µ–Ω–¥–∏–Ω–≥¬ª.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" id="applyWorkdayTemplateBtn">–ó–∞–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Å—ã–ª–∫–∏ -->
<div class="modal fade" id="incomingDataModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Å—ã–ª–∫–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="targetOrderSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—á—ë—Ç</label>
                    <select id="targetOrderSelect" class="form-select">
                        <option value="new">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="importLinkApplyBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ OrcaSlicer -->
<div class="modal fade" id="orcaPrinterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ OrcaSlicer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex mb-2">
                    <select id="orcaProfileSelect" class="form-select me-2"></select>
                    <button type="button" class="btn btn-danger btn-sm" id="delOrcaProfileBtn">‚úñ</button>
                </div>
                <pre id="orcaPrinterJsonView" class="p-2 border mt-2"></pre>
                <pre id="orcaPrinterInfoView" class="p-2 border mt-2"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ -->
<div class="modal fade" id="printerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü—Ä–∏–Ω—Ç–µ—Ä</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" id="printerNameInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>
                    <input type="number" class="form-control" id="printerCostInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏</label>
                    <input type="number" class="form-control" id="printerHoursInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–ú–æ—â–Ω–æ—Å—Ç—å (–í—Ç)</label>
                    <input type="number" class="form-control" id="printerPowerInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–û–±—Å–ª. (‚ÇΩ/—á)</label>
                    <input type="number" class="form-control" id="printerMaintInput">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="savePrinterBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
<div class="modal fade" id="materialModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ú–∞—Ç–µ—Ä–∏–∞–ª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div class="mb-2">
                    <label class="form-label">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (PLA, PETG –∏ —Ç.–¥.)</label>
                    <input type="text" class="form-control" id="matMaterialTypeInput">
                </div>

                <div class="mb-2">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" id="matNameInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥</label>
                    <input type="number" class="form-control" id="matCostInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥)</label>
                    <input type="number" class="form-control" id="matBalanceInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥)</label>
                    <input type="number" class="form-control" id="matDeclaredInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–í—Ä–µ–º—è –æ—Å—Ç—ã–≤–∞–Ω–∏—è (–º–∏–Ω)</label>
                    <input type="number" class="form-control" id="matCoolingTimeInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—á–∞—Ç—å—é (–º–∏–Ω)</label>
                    <input type="number" class="form-control" id="matPrepTimeInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–¶–≤–µ—Ç</label>
                    <input type="color" class="form-control form-control-color" id="matColorInput" value="#ffffff">
                </div>
                <div class="mb-2">
                    <label class="form-label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
                    <input type="text" class="form-control" id="matManufInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</label>
                    <input type="text" class="form-control" id="matProdDateInput">
                </div>
                <div class="mb-2">
                    <label class="form-label">–ü—Ä–∏–Ω—Ç–µ—Ä—ã</label>
                    <select multiple class="form-select" id="matPrintersSelect"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveMaterialBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏ -->
<div class="modal fade" id="materialProfileLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü—Ä–æ—Ñ–∏–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <select multiple class="form-select" id="materialProfileLinkSelect"></select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="applyMaterialProfileLinkBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π Orca -->
<div class="modal fade" id="manageMaterialProfilesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü—Ä–æ—Ñ–∏–ª–∏ Orca</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                </div>
                <table class="table table-bordered table-sm">
                    <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody id="materialProfilesTable"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ -->
<div class="modal fade" id="managePrinterProfilesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü—Ä–æ—Ñ–∏–ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-sm">
                    <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ü—Ä–∏–Ω—Ç–µ—Ä</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody id="printerProfilesTable"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

</div>

<!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö -->
<div class="modal fade" id="multiPromptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="multiPromptTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="multiPromptBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="multiPromptOk">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ —á–µ–∫ -->
<div class="modal fade" id="checkLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–°—Å—ã–ª–∫–∞ –Ω–∞ —á–µ–∫</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
                <label for="checkLinkInput" class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
                <div class="input-group mb-3">
                    <input type="text" readonly class="form-control" id="checkLinkInput">
                    <button class="btn btn-outline-secondary" type="button" id="copyCheckLinkBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /**
     * Embedded utilities (previously )
     * –í–∞–∂–Ω–æ: —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ù–ï –∑–∞–≤–∏—Å—è—Ç –æ—Ç Electron –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –æ–±—ã—á–Ω–æ–º —Å–∞–π—Ç–µ.
     */
    (function(){
        function _asArr(x){ return Array.isArray(x) ? x : []; }
        function _s(v){ return (v===undefined || v===null) ? '' : String(v); }
        function _isEmptyId(id){ const s=_s(id).trim(); return !s || s.toLowerCase()==='nan' || s.toLowerCase()==='undefined' || s.toLowerCase()==='null'; }
        function _maxNumericId(arr){
            let max=0;
            for(const it of _asArr(arr)){
                const n = parseInt(it && it.id, 10);
                if(!isNaN(n)) max = Math.max(max, n);
            }
            return max;
        }
        function _normalizeCollection(appData, arrName, counterKey){
            const arr = _asArr(appData[arrName]);
            const seen = new Set();
            const map = {}; // oldIdStr -> newIdStr
            let next = _maxNumericId(arr) + 1;

            for(const it of arr){
                if(!it) continue;
                const oldStr = _s(it.id).trim();
                if(_isEmptyId(oldStr) || seen.has(oldStr)){
                    const newId = String(next++);
                    if(!_isEmptyId(oldStr)) map[oldStr] = newId;
                    it.id = newId;
                    seen.add(newId);
                } else {
                    seen.add(oldStr);
                }
            }

            // counters: –¥–µ—Ä–∂–∏–º –Ω–∞ –º–∞–∫—Å–∏–º—É–º–µ, —á—Ç–æ–±—ã getNextId() –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∞ –∫–æ–ª–ª–∏–∑–∏–∏
            appData.counters = appData.counters || {};
            const maxNow = _maxNumericId(arr);
            const current = parseInt(appData.counters[counterKey] || 0, 10);
            appData.counters[counterKey] = Math.max(isNaN(current)?0:current, maxNow);

            // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ, –µ—Å–ª–∏ –±—ã–ª–æ –Ω–µ –º–∞—Å—Å–∏–≤–æ–º
            appData[arrName] = arr;
            return map;
        }

        function validateUniqueIds(appData){
            const errors = [];
            function checkCollection(arr, label){
                if(!Array.isArray(arr)){
                    errors.push(`${label}: not_array`);
                    return;
                }
                const seen = new Set();
                arr.forEach((it, idx)=>{
                    const id = it ? _s(it.id).trim() : '';
                    if(_isEmptyId(id)){
                        errors.push(`${label}[${idx}]: missing_id`);
                        return;
                    }
                    if(seen.has(id)){
                        errors.push(`${label}: duplicate_id ${id}`);
                    }
                    seen.add(id);
                });
            }

            checkCollection(appData.printers, 'printers');
            checkCollection(appData.materials, 'materials');
            checkCollection(appData.clients, 'clients');
            checkCollection(appData.additionalGlobal, 'additionalGlobal');
            checkCollection(appData.printerProfiles, 'printerProfiles');
            checkCollection(appData.materialProfiles, 'materialProfiles');


            const printerIds = new Set(_asArr(appData.printers).map(p=>_s(p.id)));
            const ppIds = new Set(_asArr(appData.printerProfiles).map(p=>_s(p.id)));
            const mpIds = new Set(_asArr(appData.materialProfiles).map(p=>_s(p.id)));

            _asArr(appData.printerProfiles).forEach((pf)=>{
                const prId = _s(pf && pf.printerId).trim();
                if(prId && !printerIds.has(prId)){
                    errors.push(`printerProfiles(${_s(pf.id)}): bad_printerId ${prId}`);
                }
            });

            _asArr(appData.printers).forEach((pr)=>{
                const pids = _asArr(pr && pr.profileIds).map(_s);
                const seenLocal = new Set();
                for(const pid of pids){
                    if(_isEmptyId(pid)) continue;
                    if(seenLocal.has(pid)) errors.push(`printers(${_s(pr.id)}).profileIds: duplicate ${pid}`);
                    seenLocal.add(pid);
                    if(!ppIds.has(pid)) errors.push(`printers(${_s(pr.id)}).profileIds: missing_ref ${pid}`);
                }
            });

            _asArr(appData.materials).forEach((m)=>{
                const pids = _asArr(m && m.profileIds).map(_s);
                const seenLocal = new Set();
                for(const pid of pids){
                    if(_isEmptyId(pid)) continue;
                    if(seenLocal.has(pid)) errors.push(`materials(${_s(m.id)}).profileIds: duplicate ${pid}`);
                    seenLocal.add(pid);
                    if(!mpIds.has(pid)) errors.push(`materials(${_s(m.id)}).profileIds: missing_ref ${pid}`);
                }
            });

            return { success: errors.length === 0, errors };
        }

        function normalizeIds(appData){
            if(!appData || typeof appData !== 'object') return;


            if(!Array.isArray(appData.printers)) appData.printers = [];
            if(!Array.isArray(appData.materials)) appData.materials = [];
            if(!Array.isArray(appData.clients)) appData.clients = [];
            if(!Array.isArray(appData.additionalGlobal)) appData.additionalGlobal = [];
            if(!Array.isArray(appData.printerProfiles)) appData.printerProfiles = [];
            if(!Array.isArray(appData.materialProfiles)) appData.materialProfiles = [];

            const mapPrinters = _normalizeCollection(appData, 'printers', 'printers');
            const mapMaterials = _normalizeCollection(appData, 'materials', 'materials');
            const mapClients = _normalizeCollection(appData, 'clients', 'clients');
            const mapAdd = _normalizeCollection(appData, 'additionalGlobal', 'globalAdditional');
            const mapPP = _normalizeCollection(appData, 'printerProfiles', 'printerProfiles');
            const mapMP = _normalizeCollection(appData, 'materialProfiles', 'materialProfiles');


            appData.printerProfiles.forEach(pf=>{
                const prId = _s(pf && pf.printerId).trim();
                if(prId && mapPrinters[prId]) pf.printerId = mapPrinters[prId];
            });


            appData.printers.forEach(pr=>{
                if(!Array.isArray(pr.profileIds)) pr.profileIds = [];
                pr.profileIds = pr.profileIds.map(pid=>{
                    const s=_s(pid).trim();
                    return mapPP[s] ? mapPP[s] : pid;
                }).filter(pid=>!_isEmptyId(pid));

                pr.profileIds = Array.from(new Set(pr.profileIds.map(_s)));
            });


            appData.materials.forEach(m=>{
                if(!Array.isArray(m.profileIds)) m.profileIds = [];
                m.profileIds = m.profileIds.map(pid=>{
                    const s=_s(pid).trim();
                    return mapMP[s] ? mapMP[s] : pid;
                }).filter(pid=>!_isEmptyId(pid));
                m.profileIds = Array.from(new Set(m.profileIds.map(_s)));
            });


            if(Array.isArray(appData.calcHistory)){
                appData.calcHistory.forEach(h=>{

                    if(Array.isArray(h.details)){
                        h.details.forEach(d=>{
                            if(d && d.printerId!=null){
                                const old=_s(d.printerId);
                                if(mapPrinters[old]) d.printerId = mapPrinters[old];
                            }
                            if(d && d.materialId!=null){
                                const old=_s(d.materialId);
                                if(mapMaterials[old]) d.materialId = mapMaterials[old];
                            }
                        });
                    }


                    if(h && h.calcData && typeof h.calcData === 'object'){
                        const newCD = {};
                        Object.keys(h.calcData).forEach(pid=>{
                            const newPid = mapPrinters[_s(pid)] ? mapPrinters[_s(pid)] : pid;
                            const arr = h.calcData[pid];
                            if(Array.isArray(arr)){
                                arr.forEach(model=>{
                                    if(model && model.materialId!=null){
                                        const old=_s(model.materialId);
                                        if(mapMaterials[old]) model.materialId = mapMaterials[old];
                                    }
                                });
                            }
                            if(newCD[newPid]){

                                if(Array.isArray(newCD[newPid]) && Array.isArray(arr)) newCD[newPid] = newCD[newPid].concat(arr);
                            } else {
                                newCD[newPid] = arr;
                            }
                        });
                        h.calcData = newCD;
                    }
                });
            }

            appData.counters = appData.counters || {};
        }

        window.normalizeIds = normalizeIds;
        window.validateUniqueIds = validateUniqueIds;
    })();
</script>
<script>
    const _instrumentInitialKeys = new Set(Object.keys(window));

    function instrumentFunctions(){
        const newKeys = Object.keys(window).filter(k=>!_instrumentInitialKeys.has(k) && typeof window[k]==='function');
        newKeys.forEach(fnName=>{
            const original = window[fnName];
            window[fnName] = function(...args){
                console.log('‚ñ∂', fnName, 'called with', args);
                try{
                    const result = original.apply(this,args);
                    if(result instanceof Promise){
                        return result.then(r=>{console.log('‚úî', fnName, 'resolved with', r); return r;})
                            .catch(err=>{console.error('‚úñ', fnName, 'rejected with', err); throw err;});
                    }
                    console.log('‚úî', fnName, 'returned', result);
                    return result;
                }catch(e){
                    console.error('‚úñ', fnName, 'threw', e);
                    throw e;
                }
            };
        });
        console.log('Instrumented functions:', newKeys);
    }
    const THEME_STORAGE_KEY = "themePreference";
    function setTheme(theme) {
        document.documentElement.setAttribute("data-bs-theme", theme);
        localStorage.setItem(THEME_STORAGE_KEY, theme);
        const btn = document.getElementById("themeToggle");
        btn.innerText = theme==="dark" ? "‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞" : "üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞";
    }
    document.getElementById("themeToggle").addEventListener("click",()=>{
        const th = document.documentElement.getAttribute("data-bs-theme");
        setTheme(th==="dark"?"light":"dark");
    });
    const savedTheme = localStorage.getItem(THEME_STORAGE_KEY)||"light";
    setTheme(savedTheme);

    function getNextId(type) {
        if (!appData.counters) appData.counters = {};
        if (!appData.counters[type]) appData.counters[type] = 0;
        return ++appData.counters[type];
    }

    function getNextOrderId() {
        if (!appData.counters) appData.counters = {};
        const maxExisting = Array.isArray(appData.calcHistory)
            ? appData.calcHistory.reduce((max, h) => {
                const id = parseInt(h.id, 10);
                return isNaN(id) ? max : Math.max(max, id);
            }, 0)
            : 0;
        const current = appData.counters.orders || 0;
        const next = Math.max(current, maxExisting) + 1;
        appData.counters.orders = next;
        return String(next);
    }

    const LEGACY_CALC_SETTINGS_FIELDS = ['workHoursDay', 'startDate', 'modelingRate', 'modelingCost'];
    const LEGACY_MATERIAL_FIELDS = ['waste_percent', 'spoolmanId'];
    const LEGACY_HISTORY_FIELDS = [
        'timelineScheduleSummary',
        'actualFinishDate',
        'deadlineMet',
        'autoSelectedUrgencyId',
        'urgencyProfileTitle',
        'profileMarkupPercent',
        'priceBeforeDiscount',
        'rounding',
        'operatorWorkCost',
        'downtimeCost',
        'preparationCost',
        'preparationTime',
        'rejectHours',
        'rejectWeight'
    ];
    const LEGACY_GLOBAL_ADDITIONAL_FIELDS = ['sumGlobalAdd', 'taxAmount'];

    function stripLegacyHistoryFields(entry) {
        if (!entry || typeof entry !== 'object') return entry;
        LEGACY_HISTORY_FIELDS.forEach(key => {
            if (key in entry) delete entry[key];
        });
        if (entry.globalAdditional && typeof entry.globalAdditional === 'object') {
            LEGACY_GLOBAL_ADDITIONAL_FIELDS.forEach(key => {
                if (key in entry.globalAdditional) delete entry.globalAdditional[key];
            });
        }
        return entry;
    }

    function cleanupCalcSettings(settings) {
        if (!settings || typeof settings !== 'object') return;
        LEGACY_CALC_SETTINGS_FIELDS.forEach(key => {
            if (key in settings) delete settings[key];
        });
    }

    function cleanupMaterialFields(material) {
        if (!material || typeof material !== 'object') return;
        LEGACY_MATERIAL_FIELDS.forEach(key => {
            if (key in material) delete material[key];
        });
    }

    /* –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ */
    function migrateOldData(obj){
        if(!obj || typeof obj !== 'object') obj = {};
        if(!Array.isArray(obj.printers)) obj.printers = [];
        if(!Array.isArray(obj.materials)) obj.materials = [];
        if(!Array.isArray(obj.additionalGlobal)) obj.additionalGlobal = [];
        if(!Array.isArray(obj.clients)) obj.clients = [];
        if(!Array.isArray(obj.calcHistory)) obj.calcHistory = [];

        if(!obj.calcSettings) obj.calcSettings = {};
        cleanupCalcSettings(obj.calcSettings);
        if(typeof obj.calcSettings.downtimeCost !== 'number') obj.calcSettings.downtimeCost = 0;
        if(typeof obj.calcSettings.preparationRate !== 'number') obj.calcSettings.preparationRate = 0;
        if(typeof obj.calcSettings.preparationTime !== 'number') obj.calcSettings.preparationTime = 0;
        if(typeof obj.calcSettings.roundingMode !== 'string') obj.calcSettings.roundingMode = 'none';
        if(typeof obj.calcSettings.includeOperatorForRejects !== 'boolean') obj.calcSettings.includeOperatorForRejects = false;
        if (typeof obj.calcSettings.includeEstimatePrint !== 'boolean') obj.calcSettings.includeEstimatePrint = false;
        if (typeof obj.calcSettings.estimatePrintCost !== 'number') obj.calcSettings.estimatePrintCost = 0;
        if(typeof obj.calcSettings.includeAmortization !== 'boolean') obj.calcSettings.includeAmortization = true;
        if(typeof obj.calcSettings.includeRejects !== 'boolean') obj.calcSettings.includeRejects = true;
        if(typeof obj.calcSettings.includeOverheads !== 'boolean') obj.calcSettings.includeOverheads = true;
        if(typeof obj.calcSettings.ignoreCoolingRejects !== 'boolean') obj.calcSettings.ignoreCoolingRejects = false;

        if (!obj.counters) {
            obj.counters = {
                printers: obj.printers.length,
                clients: obj.clients.length,
                materials: obj.materials.length,
                additionalGlobal: obj.additionalGlobal.length
            };
        }

        const unresolved = [];

        // –ü–µ—Ä–µ–Ω–æ—Å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏–∑ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
        obj.printers.forEach(pr=>{
            if(Array.isArray(pr.materials)){
                pr.materials.forEach(m=>{
                    if(!obj.materials.some(g=>g.id===m.id)){
                        m.printers = [String(pr.id)];
                        obj.materials.push(m);
                    }
                });
            }
            if(Array.isArray(pr.additional)){
                pr.additional.forEach(a=>{
                    if(!obj.additionalGlobal.some(g=>g.id===a.id)){
                        a.printers = [String(pr.id)];
                        obj.additionalGlobal.push(a);
                    }
                });
            }
            delete pr.materials;
            delete pr.additional;


        });

        // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –∞–¥—Ä–µ—Å—É
        const uniqList = [];
        const pMap = {};
        if(!Array.isArray(obj.printerProfiles)) obj.printerProfiles=[];
        obj.printers.forEach(pr=>{
            if(!Array.isArray(pr.profileIds)) pr.profileIds=[];
            if(Array.isArray(pr.orcaProfiles)){
                pr.orcaProfiles.forEach(op=>{
                    const pid=op.id||getNextId('printerProfiles');
                    obj.printerProfiles.push({id:pid,config:op.config||{},info:op.info||'',printerId:String(pr.id)});
                    if(!pr.profileIds.includes(pid)) pr.profileIds.push(pid);
                });
            } else if(pr.orca || pr.orcaInfo){
                const pid=getNextId('printerProfiles');
                obj.printerProfiles.push({id:pid,config:pr.orca||{},info:pr.orcaInfo||'',printerId:String(pr.id)});
                pr.profileIds.push(pid);
            }
            delete pr.orcaProfiles;
            delete pr.orca;
            delete pr.orcaInfo;
        });
        obj.printers.forEach(pr=>{
            const key = (pr.print_host||'').toLowerCase() + '|' + (pr.name||'').toLowerCase();
            const existing = pMap[key];
            if(existing){
                pr.profileIds.forEach(pid=>{
                    if(!existing.profileIds.includes(pid)){
                        existing.profileIds.push(pid);
                        const pf=obj.printerProfiles.find(x=>String(x.id)===String(pid));
                        if(pf) pf.printerId=String(existing.id);
                    }
                });
                ['cost','hoursToRecoup','power','maintCostHour'].forEach(f=>{ if(!existing[f] && pr[f]) existing[f]=pr[f]; });
            } else {
                pMap[key]=pr; uniqList.push(pr);
            }
        });
        obj.printers = uniqList;

        // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        const uniqMat = [];
        const mMap = {};
        obj.materials.forEach(m=>{
            const key = String(m.id||'') + '|' + (m.name||'');
            if(!mMap[key]){ mMap[key]=m; uniqMat.push(m); }
        });
        obj.materials = uniqMat;

        // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
        const uniqAdd = [];
        const aMap = {};
        obj.additionalGlobal.forEach(a=>{
            const key = String(a.id||'') + '|' + (a.description||'');
            if(!aMap[key]){ aMap[key]=a; uniqAdd.push(a); }
        });
        obj.additionalGlobal = uniqAdd;

        // –ö–∞—Ä—Ç–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–º–µ–Ω—ã
        const idMap = {};
        obj.printers.forEach(pr=>{
            idMap[String(pr.id).toLowerCase()] = pr;
            if(pr.print_host) idMap[String(pr.print_host).toLowerCase()] = pr;
            if(pr.name) idMap[pr.name.toLowerCase()] = pr;
            (pr.profileIds||[]).forEach(pid=>{
                const pf=obj.printerProfiles.find(x=>String(x.id)===String(pid));
                const cfg=pf?pf.config||{}:{};
                if(cfg.printer_settings_id) idMap[String(cfg.printer_settings_id).toLowerCase()] = pr;
                if(cfg.name) idMap[String(cfg.name).toLowerCase()] = pr;
            });
        });
        function ensurePrinter(ref){
            if(!ref) return null;
            return idMap[String(ref).toLowerCase()] || null;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—á—ë—Ç–æ–≤ –∏ calcData
        obj.calcHistory.forEach(h=>{
            if(h.nalogInn) delete h.nalogInn;
            if(Array.isArray(h.nalogReceipts)){
                h.nalogReceipts = h.nalogReceipts.map(r=>({uuid:r.uuid, canceled: !!r.canceled}));
            }
            if(!h.markupPercent) h.markupPercent = 0;
            if(!h.discountPercent) h.discountPercent = 0;
            if(!h.globalAdditional) h.globalAdditional = {sumGlobalAdd:0,taxAmount:0,details:[]};
            if(typeof h.downtimeMinutes !== 'number') h.downtimeMinutes = 0;
            if(typeof h.coolingMinutes !== 'number') h.coolingMinutes = h.downtimeMinutes || 0;
            if(typeof h.printerPrepMinutes !== 'number') h.printerPrepMinutes = 0;
            if(typeof h.downtimeCost !== 'number') h.downtimeCost = 0;
            if(typeof h.preparationTime !== 'number') h.preparationTime = 0;
            if(typeof h.preparationCost !== 'number') h.preparationCost = 0;
            if(Array.isArray(h.details)){
                h.details.forEach(d=>{
                    let pr = ensurePrinter(d.printerId) || ensurePrinter(d.printerName?.toLowerCase());
                    if(pr){
                        d.printerId = pr.id;
                        d.printerName = pr.name;
                    } else {
                        unresolved.push({history:h,ref:d.printerId,origName:d.printerName||d.printerId,model:d.modelName||''});
                    }
                });
            }
            if(h.calcData){
                const newCD = {};
                for(const pid in h.calcData){
                    let pr = ensurePrinter(pid);
                    if(!pr){
                        const det = (h.details||[]).find(d=>String(d.printerId)===String(pid));
                        pr = det? ensurePrinter(det.printerId) : null;
                    }
                    if(pr){
                        newCD[pr.id] = h.calcData[pid];
                    } else {
                        const det = (h.details||[]).find(d=>String(d.printerId)===String(pid));
                        unresolved.push({history:h,ref:pid,origName:pid,model:det?det.modelName||'':''});
                        newCD[pid] = h.calcData[pid];
                    }
                }
                h.calcData = newCD;
            }
        });

        // –ü–µ—Ä–µ–Ω–æ—Å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        const nameMap = {};
        obj.calcHistory.forEach(h=>{
            const nm = h.clientName;
            if(!nm) return;
            let c = obj.clients.find(x=>x.name===nm);
            if(!c){
                if(nameMap[nm]){
                    c = nameMap[nm];
                }else{
                    c = {id: getNextId('clients'), name: nm};
                    obj.clients.push(c);
                    nameMap[nm] = c;
                }
            }
            if(!h.clientId) h.clientId = c.id;
        });

        obj.materials.forEach(m=>{ if(!m.printers) m.printers=[]; cleanupMaterialFields(m); });
        if(!Array.isArray(obj.materialProfiles)) obj.materialProfiles=[];
        obj.materials.forEach(m=>{
            if(typeof m.coolingTime !== 'number') m.coolingTime = 0;
            if(typeof m.printerPrepMinutes !== 'number') m.printerPrepMinutes = 0;
            if(!Array.isArray(m.profileIds)) m.profileIds=[];
            if(m.orca || m.orcaInfo){
                const pf={id:getNextId('materialProfiles'),config:m.orca||{},info:m.orcaInfo||''};
                obj.materialProfiles.push(pf);
                m.profileIds.push(pf.id);
            }
            delete m.orca;
            delete m.orcaInfo;
        });
        obj.additionalGlobal.forEach(a=>{ if(!a.printers) a.printers=[]; });
        if(!Array.isArray(obj.printerProfiles)) obj.printerProfiles=[];
        obj.printers.forEach(p=>{ if(!Array.isArray(p.profileIds)) p.profileIds=[]; });

        // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏–Ω—Ç–µ—Ä—ã –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        const used = new Set();
        obj.calcHistory.forEach(h=>{
            if(Array.isArray(h.details)) h.details.forEach(d=> used.add(String(d.printerId)) );
            if(h.calcData) Object.keys(h.calcData).forEach(pid=> used.add(String(pid)) );
        });
        obj.printers = obj.printers.filter(p=> !p.isTemp || used.has(String(p.id)) );
        if(Array.isArray(obj.calcHistory)) obj.calcHistory.forEach(stripLegacyHistoryFields);
        obj.schemaVersion = CURRENT_SCHEMA_VERSION;
        obj.migrationInfo = obj.migrationInfo || {};
        return obj;
    }

    const __modalQueue = (() => {
        let chain = Promise.resolve();
        return {
            run(task){
                const next = chain.then(task, task);
                chain = next.catch(()=>{});
                return next;
            }
        };
    })();

    function __cleanupModalArtifacts() {
        try {
            const backdrops = Array.from(document.querySelectorAll('.modal-backdrop'));
            if (backdrops.length > 1) backdrops.slice(1).forEach(b => b.remove());

            const anyShown = document.querySelector('.modal.show');
            if (!anyShown) {
                // hard reset if nothing is open
                backdrops.forEach(b => b.remove());
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
            }
        } catch (e) {
            console.warn('cleanupModalArtifacts failed', e);
        }
    }

    function __waitModalHidden(modalEl) {
        return new Promise(resolve => {
            const handler = () => {
                modalEl.removeEventListener('hidden.bs.modal', handler);
                __cleanupModalArtifacts();
                resolve();
            };
            modalEl.addEventListener('hidden.bs.modal', handler);
        });
    }

    const PromptMemory = (() => {
        const KEY = 'gcodecalc_prompt_memory_v1';
        let data = { printerMap: {}, materialMap: {}, orderAuto: null };

        function load() {
            try {
                const raw = localStorage.getItem(KEY);
                if (!raw) return;
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed === 'object') {
                    data.printerMap = parsed.printerMap && typeof parsed.printerMap === 'object' ? parsed.printerMap : {};
                    data.materialMap = parsed.materialMap && typeof parsed.materialMap === 'object' ? parsed.materialMap : {};
                    data.orderAuto = parsed.orderAuto && typeof parsed.orderAuto === 'object' ? parsed.orderAuto : null;
                }
            } catch (e) {
                console.warn('PromptMemory load failed', e);
            }
        }
        function save() {
            try { localStorage.setItem(KEY, JSON.stringify(data)); } catch (e) {}
        }
        function clear() {
            data = { printerMap: {}, materialMap: {}, orderAuto: null };
            try { localStorage.removeItem(KEY); } catch(e) {}
        }

        function getPrinter(key) {
            if (!key) return '';
            return data.printerMap[key] ? String(data.printerMap[key]) : '';
        }
        function setPrinter(key, printerId) {
            if (!key || !printerId) return;
            data.printerMap[key] = String(printerId);
            save();
        }
        function forgetPrinter(key) {
            if (!key) return;
            delete data.printerMap[key];
            save();
        }

        function getMaterial(profile) {
            if (!profile) return '';
            return data.materialMap[profile] ? String(data.materialMap[profile]) : '';
        }
        function setMaterial(profile, materialId) {
            if (!profile || !materialId) return;
            data.materialMap[profile] = String(materialId);
            save();
        }
        function forgetMaterial(profile) {
            if (!profile) return;
            delete data.materialMap[profile];
            save();
        }

        function getOrderAuto() {
            return data.orderAuto && typeof data.orderAuto === 'object' ? data.orderAuto : null;
        }
        function setOrderAuto(orderAuto) {
            data.orderAuto = orderAuto || null;
            save();
        }
        function consumeOrderAuto() {
            if (!data.orderAuto) return;
            if (typeof data.orderAuto.remaining !== 'number') { data.orderAuto = null; save(); return; }
            data.orderAuto.remaining -= 1;
            if (data.orderAuto.remaining <= 0) data.orderAuto = null;
            save();
        }

        function stats() {
            const printers = Object.keys(data.printerMap || {}).length;
            const materials = Object.keys(data.materialMap || {}).length;
            const order = data.orderAuto ? `, –∞–≤—Ç–æ-–∑–∞–∫–∞–∑: ${data.orderAuto.kind || '‚Äî'} (${data.orderAuto.remaining || 0})` : '';
            return `–ü—Ä–∏–Ω—Ç–µ—Ä—ã: ${printers}, –º–∞—Ç–µ—Ä–∏–∞–ª—ã: ${materials}${order}`;
        }

        load();
        return {
            clear, stats,
            getPrinter, setPrinter, forgetPrinter,
            getMaterial, setMaterial, forgetMaterial,
            getOrderAuto, setOrderAuto, consumeOrderAuto
        };
    })()

    function renderPromptMemoryStats(){
        const el = document.getElementById('promptMemoryStats');
        if(el) el.textContent = PromptMemory.stats();
    }

    function initPromptMemoryUi(){
        const btn = document.getElementById('clearPromptMemoryBtn');
        if(btn && !btn.__bound){
            btn.__bound = true;
            btn.addEventListener('click', () => {
                PromptMemory.clear();
                renderPromptMemoryStats();
                alert('–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –º–æ–¥–∞–ª–æ–∫ –∏–º–ø–æ—Ä—Ç–∞ –æ—á–∏—â–µ–Ω—ã.');
            });
        }
        renderPromptMemoryStats();
    }

    ;


    function showMultiPrompt(title, fields){
        return __modalQueue.run(() => new Promise(res=>{
            const body = document.getElementById('multiPromptBody');
            body.innerHTML = '';
            document.getElementById('multiPromptTitle').textContent = title;

            const elements = [];

            (fields||[]).forEach(f=>{
                if(!f) return;

                if(f.type==='html'){
                    const div=document.createElement('div');
                    div.className = f.className || 'mb-3';
                    div.innerHTML = f.html || '';
                    body.appendChild(div);
                    return;
                }

                const wrap=document.createElement('div');
                wrap.className = (f.type==='checkbox') ? 'form-check mb-2' : 'mb-2';

                const id = 'mp_' + f.id;

                let el=null;

                if(f.type==='checkbox'){
                    el=document.createElement('input');
                    el.type='checkbox';
                    el.className='form-check-input';
                    el.id=id;
                    el.checked=!!f.value;

                    const lbl=document.createElement('label');
                    lbl.className='form-check-label ms-2';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    wrap.appendChild(el);
                    wrap.appendChild(lbl);
                } else if(f.type==='multiselect'){
                    const lbl=document.createElement('label');
                    lbl.className='form-label';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    el=document.createElement('select');
                    el.className='form-select';
                    el.multiple=true;
                    el.id=id;
                    (f.options||[]).forEach(opt=>{
                        const o=document.createElement('option');
                        o.value=opt.value;
                        o.textContent=opt.label;
                        if(Array.isArray(f.value) && f.value.includes(opt.value)) o.selected=true;
                        el.appendChild(o);
                    });

                    wrap.appendChild(lbl);
                    wrap.appendChild(el);
                } else if(f.type==='select'){
                    const lbl=document.createElement('label');
                    lbl.className='form-label';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    el=document.createElement('select');
                    el.className='form-select';
                    el.id=id;

                    (f.options||[]).forEach(opt=>{
                        const o=document.createElement('option');
                        o.value=opt.value;
                        o.textContent=opt.label;
                        if(String(f.value ?? '') === String(opt.value)) o.selected=true;
                        el.appendChild(o);
                    });

                    wrap.appendChild(lbl);
                    wrap.appendChild(el);
                } else if(f.type==='textarea'){
                    const lbl=document.createElement('label');
                    lbl.className='form-label';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    el=document.createElement('textarea');
                    el.className='form-control';
                    el.id=id;
                    el.rows=f.rows||3;
                    el.value=f.value||'';

                    wrap.appendChild(lbl);
                    wrap.appendChild(el);
                } else if(f.type==='number'){
                    const lbl=document.createElement('label');
                    lbl.className='form-label';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    el=document.createElement('input');
                    el.type='number';
                    el.className='form-control';
                    el.id=id;
                    if (f.min !== undefined) el.min = String(f.min);
                    if (f.max !== undefined) el.max = String(f.max);
                    if (f.step !== undefined) el.step = String(f.step);
                    el.value = (f.value !== undefined && f.value !== null) ? String(f.value) : '';

                    wrap.appendChild(lbl);
                    wrap.appendChild(el);
                } else {
                    const lbl=document.createElement('label');
                    lbl.className='form-label';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    el=document.createElement('input');
                    el.type=f.type||'text';
                    el.className='form-control';
                    el.id=id;
                    el.value=f.value||'';
                    if (f.placeholder) el.placeholder = f.placeholder;

                    wrap.appendChild(lbl);
                    wrap.appendChild(el);
                }

                if (el && f.disabled) el.disabled = true;

                if (f.help) {
                    const help=document.createElement('div');
                    help.className='form-text';
                    help.textContent = f.help;
                    wrap.appendChild(help);
                }

                if (el && typeof f.onChange === 'function') {
                    el.addEventListener('change', () => f.onChange(el));
                }

                body.appendChild(wrap);

                if(el) elements.push({field:f, el});
            });

            const modalEl = document.getElementById('multiPromptModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

            let finalResult = null;

            const okBtn = document.getElementById('multiPromptOk');
            const prevOnClick = okBtn.onclick;

            function cleanup(){
                okBtn.onclick = prevOnClick;
                __cleanupModalArtifacts();
            }

            modalEl.addEventListener('hidden.bs.modal', () => {
                cleanup();
                res(finalResult);
            }, { once: true });

            okBtn.onclick = () => {
                const result = {};
                elements.forEach(({field, el})=>{
                    if (!field || field.type === 'html') return;
                    if(field.type==='checkbox') result[field.id] = el.checked;
                    else if(field.type==='multiselect') result[field.id] = Array.from(el.selectedOptions).map(o=>o.value);
                    else if(field.type==='select') result[field.id] = el.value;
                    else if(field.type==='textarea') result[field.id] = el.value;
                    else if(field.type==='number') result[field.id] = el.value === '' ? '' : Number(el.value);
                    else result[field.id] = el.value;
                });
                finalResult = result;
                modal.hide();
            };

            __cleanupModalArtifacts();

            modal.show();
        }));
    }

    function showMaterialSelectionForGcode(fileName, thumbnail, materialOptions, profile){
        const safeProfile = (profile || '').trim();
        const infoHtml = (() => {
            const thumb = thumbnail ? `<img src="data:image/png;base64,${thumbnail}" style="width:80px;height:80px;object-fit:contain;border:1px solid #ccc;border-radius:4px;margin-bottom:10px;display:block;">` : '';
            const prof = safeProfile ? `<div class="small text-muted"><strong>–ü—Ä–æ—Ñ–∏–ª—å:</strong> ${escapeHtml(safeProfile)}</div>` : '';
            return `
                <div class="mb-2 p-3 border rounded bg-light">
                    ${thumb}
                    <div class="mb-1"><strong>–§–∞–π–ª:</strong> ${escapeHtml(fileName||'')}</div>
                    ${prof}
                </div>`;
        })();

        const options = [{value:'', label:'-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª --'}].concat(materialOptions||[]);

        const rememberLabel = safeProfile
            ? `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è ¬´${safeProfile}¬ª`
            : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è';

        return showMultiPrompt('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –º–æ–¥–µ–ª–∏', [
            { type:'html', html: infoHtml },
            { id:'materialId', label:'–ú–∞—Ç–µ—Ä–∏–∞–ª', type:'select', options, value:'' },
            { id:'remember', label: rememberLabel, type:'checkbox', value:false }
        ]).then(r=>{
            if(!r || !r.materialId) return null;
            return { materialId: r.materialId, remember: !!r.remember };
        });
    }

    function populatePrintersSelect(sel, selected){
        sel.innerHTML='';
        appData.printers.forEach(p=>{
            const opt=document.createElement('option');
            opt.value=p.id;
            opt.textContent=p.name;
            if(selected && selected.some(id => String(id) === String(p.id))) opt.selected=true;
            sel.appendChild(opt);
        });
    }

    function collectUnresolvedPrinters(){
        const idSet=new Set(appData.printers.map(p=>String(p.id)));
        const list=[];
        appData.calcHistory.forEach(h=>{
            if(Array.isArray(h.details)) h.details.forEach(d=>{
                if(!idSet.has(String(d.printerId))){
                    list.push({history:h,ref:d.printerId,origName:d.printerName||d.printerId,model:d.modelName||''});
                }
            });
            if(h.calcData){
                for(const pid in h.calcData){
                    if(!idSet.has(String(pid))){
                        const det=(h.details||[]).find(dd=>String(dd.printerId)===String(pid));
                        list.push({history:h,ref:pid,origName:pid,model:det?det.modelName||'':''});
                    }
                }
            }
        });
        return list;
    }

    function showPrinterMapModal(list){
        if(!list || list.length===0) return;
        const tbody=document.querySelector('#printerMapTable tbody');
        tbody.innerHTML='';
        list.forEach((rec,i)=>{
            const h=rec.history;
            const tr=document.createElement('tr');
            tr.dataset.index=i;
            tr.innerHTML=`<td><input type="checkbox" class="form-check-input"></td>`+
                `<td>${new Date(h.timestamp||0).toLocaleString()}</td>`+
                `<td>${h.id||''}</td>`+
                `<td>${h.calcName||''}</td>`+
                `<td>${h.clientName||''}</td>`+
                `<td>${h.orderStatus||''}</td>`+
                `<td>${safeFixed(h.total||0)}</td>`+
                `<td>${rec.model||''}</td>`+
                `<td>${rec.origName}</td>`+
                '<td></td>';
            const sel=document.createElement('select');
            populatePrintersSelect(sel);
            tr.lastChild.appendChild(sel);
            tbody.appendChild(tr);
        });
        const bulkSel=document.getElementById('bulkPrinterSelect');
        populatePrintersSelect(bulkSel);
        document.getElementById('applyBulkMap').onclick=()=>{
            const rows=tbody.querySelectorAll('tr');
            rows.forEach(row=>{
                if(row.querySelector('input[type=checkbox]').checked){
                    const sel=row.querySelector('select');
                    sel.value=bulkSel.value;
                }
            });
        };
        const modal=new bootstrap.Modal(document.getElementById('printerMapModal'));
        document.getElementById('printerMapSave').onclick=()=>{
            const rows=tbody.querySelectorAll('tr');
            rows.forEach(row=>{
                const idx=parseInt(row.dataset.index,10);
                const sel=row.querySelector('select');
                const entry=list[idx];
                const target=appData.printers.find(p=>String(p.id)===String(sel.value));
                if(target){
                    const hist=entry.history;
                    if(Array.isArray(hist.details)) hist.details.forEach(d=>{
                        if(String(d.printerId)===String(entry.ref) || d.printerName===entry.origName){
                            d.printerId=target.id; d.printerName=target.name;
                        }
                    });
                    if(hist.calcData && hist.calcData[entry.ref]){
                        hist.calcData[target.id]=hist.calcData[entry.ref];
                        delete hist.calcData[entry.ref];
                    }
                }
            });
            modal.hide();
            renderHistoryTable();
            renderPrintersTable();
            saveToLocalStorage();
        };
        modal.show();
    }

    function printerNameById(id){
        const p=appData.printers.find(pr=>String(pr.id)===String(id));
        return p? p.name : id;
    }

    function profileNameById(pid){
        const pf=appData.materialProfiles.find(p=>String(p.id)===String(pid));
        if(!pf) return pid;
        const cfg=pf.config||{};
        return String(cfg.filament_settings_id||cfg.name||pid);
    }

    function textColorForBg(hex){
        if(!hex) return '#000';
        hex=hex.replace('#','');
        if(hex.length===3){ hex=hex.split('').map(c=>c+c).join(''); }
        const r=parseInt(hex.substr(0,2),16);
        const g=parseInt(hex.substr(2,2),16);
        const b=parseInt(hex.substr(4,2),16);
        const yiq=(r*299+g*587+b*114)/1000;
        return yiq>128?'#000':'#fff';
    }

    const STORAGE_KEY = "ThreeDPrintCalc_Extended_v5";
    const STORAGE_HISTORY_KEY = STORAGE_KEY + "_history";
    const CURRENT_SCHEMA_VERSION = 2;
    const migrationState = {
        needsMigration: false,
        rawData: null,
        backupDone: false,
        inProgress: false
    };
    const OPERATOR_PERIOD_ROWS = 5;
    const DEFAULT_OPERATOR_PERIODS = [
        {start: "10:00", end: "13:00"},
        {start: "14:00", end: "17:00"}
    ];
    const FAST_OPERATOR_PERIODS = [
        {start: "09:00", end: "13:00"},
        {start: "13:30", end: "18:30"}
    ];
    const RUSH_OPERATOR_PERIODS = [
        {start: "08:00", end: "14:00"},
        {start: "14:30", end: "20:30"}
    ];
    const DEFAULT_WORKING_DAYS = [1, 2, 3, 4, 5];
    const WEEKDAY_LABELS = [
        {value: 1, label: '–ü–Ω'},
        {value: 2, label: '–í—Ç'},
        {value: 3, label: '–°—Ä'},
        {value: 4, label: '–ß—Ç'},
        {value: 5, label: '–ü—Ç'},
        {value: 6, label: '–°–±'},
        {value: 0, label: '–í—Å'}
    ];
    const createScheduleFromPeriods = (periods, workingDays = DEFAULT_WORKING_DAYS) => {
        const map = {};
        WEEKDAY_LABELS.forEach(day => {
            map[day.value] = workingDays.includes(day.value)
                ? periods.map(p => ({start: p.start, end: p.end}))
                : [];
        });
        return map;
    };
    const DEFAULT_URGENCY_PROFILES = [
        {
            id: 'standard',
            title: '–°—Ç–∞–Ω–¥–∞—Ä—Ç',
            markupPercent: 0,
            description: '–û–±—ã—á–Ω—ã–µ —Å—Ä–æ–∫–∏, –ø—è—Ç–∏–¥–Ω–µ–≤–∫–∞',
            schedule: createScheduleFromPeriods(DEFAULT_OPERATOR_PERIODS),
            workingDays: [...DEFAULT_WORKING_DAYS]
        },
        {
            id: 'fast',
            title: '–ë—ã—Å—Ç—Ä—ã–π',
            markupPercent: 30,
            description: '–£—Å–∫–æ—Ä–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º, —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π –æ–±–µ–¥',
            schedule: createScheduleFromPeriods(FAST_OPERATOR_PERIODS),
            workingDays: [...DEFAULT_WORKING_DAYS]
        },
        {
            id: 'rush',
            title: '–°—Ä–æ—á–Ω—ã–π',
            markupPercent: 100,
            description: '–†–∞–±–æ—Ç–∞–µ–º 12 —á–∞—Å–æ–≤ –≤ —Å—É—Ç–∫–∏, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ä—ã–≤—ã',
            schedule: createScheduleFromPeriods(RUSH_OPERATOR_PERIODS, [1,2,3,4,5,6]),
            workingDays: [1,2,3,4,5,6]
        }
    ];
    let urgencyProfilesDraft = [];
    let currentUrgencyProfileId = null;
    let appData = {
        printers: [
            {
                id: 1,
                name: "FF5M",
                cost: 35000,
                hoursToRecoup: 500,
                power: 350,
                maintCostHour: 5,
                profileIds: []
            }
        ],
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã: –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è: balance (–æ—Å—Ç–∞—Ç–æ–∫), declaredWeight, manufacturer, productionDate
        materials: [
            // –ü—Ä–∏–º–µ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–∞
            // { id: 1001, name: "PLA", costPerKg: 150, balance: 10, declaredWeight: 1, waste_percent: 5, manufacturer: "XYZ", productionDate: "01.01.2025", printers: [] }
        ],
        materialProfiles: [],
        printerProfiles: [],
        additionalGlobal: [],
        calcSettings: {
            operatorRate: 200,
            costKwh: 6,
            shipping: 300,
            taxPercent: 6,
            parallelPrinting: "no",
            deadlineDate: "",
            markupPercent: 0,
            discountPercent: 0,
            downtimeCost: 0,
            preparationRate: 0,
            preparationTime: 0,
            includeOperatorForRejects: false,
            includeAmortization: true,
            includeRejects: true,
            includeOverheads: true,
            ignoreCoolingRejects: false,
            includeEstimatePrint: false,
            estimatePrintCost: 0,
            customServices: [],
            currentUrgencyId: 'standard'
        },
        labelSettings: {
            companyName: "–ö–æ–º–ø–∞–Ω–∏—è",
            chatLink: "https://t.me/dur",
            bankDetails: "",
            costPerLabel: 0,
            printLabels: false,
            urgencyProfiles: DEFAULT_URGENCY_PROFILES.map(p => ({
                id: p.id,
                title: p.title,
                markupPercent: p.markupPercent,
                description: p.description,
                schedule: JSON.parse(JSON.stringify(p.schedule)),
                workingDays: [...p.workingDays]
            }))
        },
        clients: [],
        calcHistory: [],
        migrationInfo: {},
        schemaVersion: CURRENT_SCHEMA_VERSION
    };

    function isLegacySchema(obj){
        if(!obj || typeof obj !== 'object') return false;
        const version = parseInt(obj.schemaVersion, 10);
        if(!version || version < CURRENT_SCHEMA_VERSION) return true;
        const calcSettings = obj.calcSettings || {};
        if('workHoursDay' in calcSettings || 'modelingRate' in calcSettings || 'modelingCost' in calcSettings) return true;
        if(Array.isArray(obj.calcHistory)){
            for(const entry of obj.calcHistory){
                if(!entry || typeof entry !== 'object') continue;
                if('timelineScheduleSummary' in entry ||
                    'actualFinishDate' in entry ||
                    'deadlineMet' in entry ||
                    'priceBeforeDiscount' in entry ||
                    'rounding' in entry ||
                    'operatorWorkCost' in entry ||
                    'downtimeCost' in entry ||
                    'preparationCost' in entry ||
                    'rejectHours' in entry ||
                    'rejectWeight' in entry ||
                    'autoSelectedUrgencyId' in entry){
                    return true;
                }
            }
        }
        return false;
    }

    function ensureAppDataDefaults(obj){
        if(!obj || typeof obj !== 'object') obj = {};
        if(!Array.isArray(obj.printers)) obj.printers = [];
        if(!Array.isArray(obj.materials)) obj.materials = [];
        if(!Array.isArray(obj.materialProfiles)) obj.materialProfiles = [];
        if(!Array.isArray(obj.additionalGlobal)) obj.additionalGlobal = [];
        if(!Array.isArray(obj.clients)) obj.clients = [];
        if(!Array.isArray(obj.calcHistory)) obj.calcHistory = [];
        obj.materials.forEach(m=>{if(!m.printers) m.printers=[];});
        obj.additionalGlobal.forEach(a=>{if(!a.printers) a.printers=[];});
        if(!obj.labelSettings) obj.labelSettings = {};
        if('paymentInfo' in obj.labelSettings && !('bankDetails' in obj.labelSettings)){
            obj.labelSettings.bankDetails = obj.labelSettings.paymentInfo;
            delete obj.labelSettings.paymentInfo;
        }
        if(!('bankDetails' in obj.labelSettings)) obj.labelSettings.bankDetails = '';
        if (!Array.isArray(obj.labelSettings.urgencyProfiles) || !obj.labelSettings.urgencyProfiles.length) {
            const legacySchedule = obj.labelSettings.operatorSchedule || createScheduleFromPeriods(DEFAULT_OPERATOR_PERIODS);
            const legacyWorking = Array.isArray(obj.labelSettings.operatorWorkingDays) && obj.labelSettings.operatorWorkingDays.length
                ? obj.labelSettings.operatorWorkingDays
                : [...DEFAULT_WORKING_DAYS];
            const fallback = {
                id: 'standard',
                title: '–°—Ç–∞–Ω–¥–∞—Ä—Ç',
                markupPercent: 0,
                description: '–û–±—ã—á–Ω—ã–µ —Å—Ä–æ–∫–∏, –ø—è—Ç–∏–¥–Ω–µ–≤–∫–∞',
                schedule: Object.keys(legacySchedule).length ? legacySchedule : createScheduleFromPeriods(DEFAULT_OPERATOR_PERIODS),
                workingDays: legacyWorking
            };
            const extra = DEFAULT_URGENCY_PROFILES.filter(p => p.id !== 'standard').map(p => ({
                id: p.id,
                title: p.title,
                markupPercent: p.markupPercent,
                description: p.description,
                schedule: JSON.parse(JSON.stringify(p.schedule)),
                workingDays: [...p.workingDays]
            }));
            obj.labelSettings.urgencyProfiles = [fallback, ...extra];
        }
        delete obj.labelSettings.operatorSchedule;
        delete obj.labelSettings.operatorWorkingDays;
        if(!obj.calcSettings) obj.calcSettings = {};
        if(!obj.calcSettings.currentUrgencyId){
            const firstProfile = Array.isArray(obj.labelSettings.urgencyProfiles) && obj.labelSettings.urgencyProfiles.length
                ? obj.labelSettings.urgencyProfiles[0].id
                : 'standard';
            obj.calcSettings.currentUrgencyId = firstProfile;
        }
        if(!Array.isArray(obj.calcSettings.customServices)) obj.calcSettings.customServices = [];
        return obj;
    }

    function buildConfigSnapshotForStorage(data){
        try{
            const snapshot = JSON.parse(JSON.stringify(data || {}));
            if(snapshot && snapshot.calcHistory) delete snapshot.calcHistory;
            return snapshot;
        } catch (e){
            console.warn('buildConfigSnapshotForStorage.failed', e);
            const fallback = Object.assign({}, data);
            if(fallback && fallback.calcHistory) delete fallback.calcHistory;
            return fallback;
        }
    }

    function loadHistoryLayer(){
        try{
            const raw = localStorage.getItem(STORAGE_HISTORY_KEY);
            if(!raw) return null;
            const parsed = JSON.parse(raw);
            if(Array.isArray(parsed)) return parsed;
            if(parsed && Array.isArray(parsed.calcHistory)) return parsed.calcHistory;
        } catch(e){
            console.warn('historyLayer.load.failed', e);
        }
        return null;
    }

    function persistHistoryLayer(history){
        try{
            const payload = Array.isArray(history) ? history : [];
            localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(payload));
        } catch(e){
            console.warn('historyLayer.save.failed', e);
        }
    }

    function hydrateCalcHistoryFromLayers(debugInfo){
        let historySource = 'inline';
        let historyData = Array.isArray(appData && appData.calcHistory) ? appData.calcHistory : [];
        const layer = loadHistoryLayer();
        if(Array.isArray(layer)){
            historyData = layer;
            historySource = 'layer';
        } else if(historyData.length){
            persistHistoryLayer(historyData);
        }
        if(!Array.isArray(historyData)) historyData = [];
        appData.calcHistory = historyData;
        if(debugInfo){
            debugInfo.historyLen = historyData.length;
            debugInfo.historySource = historySource;
        }
    }

    function loadFromLocalStorage(){
        const debugInfo = {
            rawLen: 0,
            parsed: false,
            legacy: false,
            schemaVersion: null,
            error: null,
            needsMigration: false,
            historySource: 'none',
            historyLen: 0
        };
        try{
            const s = localStorage.getItem(STORAGE_KEY);
            debugInfo.rawLen = s ? s.length : 0;
            if(s){
                const p = JSON.parse(s);
                debugInfo.parsed = true;
                debugInfo.schemaVersion = (p && p.schemaVersion !== undefined) ? p.schemaVersion : null;
                migrationState.needsMigration = false;
                migrationState.rawData = null;
                migrationState.backupDone = false;
                migrationState.inProgress = false;
                if(p && isLegacySchema(p)){
                    migrationState.needsMigration = true;
                    migrationState.rawData = s;
                    debugInfo.legacy = true;
                    debugInfo.needsMigration = true;
                    appData = ensureAppDataDefaults(p);
                    hydrateCalcHistoryFromLayers(debugInfo);
                    window.__migrationDebug = debugInfo;
                    return;
                }
                if(p){
                    appData = ensureAppDataDefaults(migrateOldData(p));
                }
                debugInfo.needsMigration = false;
            }
        } catch(e){
            debugInfo.error = e && e.message ? e.message : String(e);
        }
        if(!appData.schemaVersion){
            appData.schemaVersion = CURRENT_SCHEMA_VERSION;
            appData.migrationInfo = appData.migrationInfo || {};
        }
        hydrateCalcHistoryFromLayers(debugInfo);
        window.__migrationDebug = debugInfo;
    }

    function saveToLocalStorage(options = {}){
        if(appData && typeof appData === 'object'){
            appData.schemaVersion = CURRENT_SCHEMA_VERSION;
            appData.migrationInfo = appData.migrationInfo || {};
        }
        const historySnapshot = Array.isArray(appData && appData.calcHistory) ? appData.calcHistory : [];
        const configSnapshot = buildConfigSnapshotForStorage(appData);
        try{
            localStorage.setItem(STORAGE_KEY, JSON.stringify(configSnapshot));
        } catch(e){
            console.error('saveToLocalStorage.config.failed', e);
        }
        if(options && options.skipHistory === true) return;
        persistHistoryLayer(historySnapshot);
    }
    function showSchemaMigrationOverlay(){
        const overlay = document.getElementById('schemaMigrationOverlay');
        if(!overlay) return;
        overlay.classList.add('show');
        updateSchemaMigrationUi();
    }
    function hideSchemaMigrationOverlay(){
        const overlay = document.getElementById('schemaMigrationOverlay');
        if(!overlay) return;
        overlay.classList.remove('show');
    }
    function updateSchemaMigrationUi(){
        const backupStatus = document.getElementById('schemaMigrationBackupStatus');
        const progress = document.getElementById('schemaMigrationProgress');
        const errorEl = document.getElementById('schemaMigrationError');
        const backupBtn = document.getElementById('schemaMigrationBackupBtn');
        const startBtn = document.getElementById('schemaMigrationStartBtn');
        if(backupStatus){
            backupStatus.textContent = migrationState.backupDone
                ? '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —à–∞–≥—É 2.'
                : '–®–∞–≥ 1: —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.';
        }
        if(progress){
            progress.textContent = migrationState.inProgress ? '–ò–¥—ë—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –æ–∫–Ω–æ.' : '';
        }
        if(backupBtn){
            backupBtn.disabled = migrationState.inProgress;
        }
        if(startBtn){
            startBtn.disabled = !migrationState.backupDone || migrationState.inProgress;
            startBtn.textContent = migrationState.inProgress ? '–û–±–Ω–æ–≤–ª—è–µ–º...' : '–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
        }
        if(errorEl && errorEl.dataset.dismissOnUpdate === 'true'){
            errorEl.textContent = '';
            delete errorEl.dataset.dismissOnUpdate;
        }
    }
    function handleSchemaMigrationBackup(){
        if(!migrationState.rawData) return;
        const errorEl = document.getElementById('schemaMigrationError');
        if(errorEl){
            errorEl.textContent = '';
        }
        try{
            const stamp = new Date().toISOString().replace(/[:.]/g,'-');
            const blob = new Blob([migrationState.rawData], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `gcodecalc_backup_${stamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(()=>URL.revokeObjectURL(url), 500);
            migrationState.backupDone = true;
            updateSchemaMigrationUi();
        } catch (e){
            if(errorEl){
                errorEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é: ' + (e && e.message ? e.message : String(e));
            }
        }
    }
    function handleSchemaMigrationStart(){
        const errorEl = document.getElementById('schemaMigrationError');
        if(errorEl) errorEl.textContent = '';
        if(!migrationState.backupDone){
            if(errorEl){
                errorEl.textContent = '–°–Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é.';
                errorEl.dataset.dismissOnUpdate = 'true';
            }
            return;
        }
        if(!migrationState.rawData){
            if(errorEl){
                errorEl.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏.';
            }
            return;
        }
        migrationState.inProgress = true;
        updateSchemaMigrationUi();
        setTimeout(()=>{
            try{
                const parsed = JSON.parse(migrationState.rawData);
                let next = ensureAppDataDefaults(migrateOldData(parsed));
                next.schemaVersion = CURRENT_SCHEMA_VERSION;
                next.migrationInfo = next.migrationInfo || {};
                next.migrationInfo.lastMigrationAt = new Date().toISOString();
                normalizeIds(next);
                appData = next;
                saveToLocalStorage();
                migrationState.needsMigration = false;
                migrationState.rawData = null;
                migrationState.backupDone = false;
                migrationState.inProgress = false;
                hideSchemaMigrationOverlay();
                completeAppInitialization();
                if(window.backupBridge && typeof window.backupBridge.notify === 'function'){
                    window.backupBridge.notify({ type: 'migrationComplete' });
                }
        } catch (e){
            console.error('schema migration failed', e);
            window.__lastMigrationError = {
                message: (e && e.message) ? e.message : String(e),
                stack: e && e.stack ? e.stack : null
            };
            migrationState.inProgress = false;
            if(errorEl){
                errorEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ' + (e && e.message ? e.message : String(e)) + '. –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —É –≤–∞—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é.';
            }
            try{
                localStorage.removeItem(STORAGE_HISTORY_KEY);
                if(migrationState.rawData) localStorage.setItem(STORAGE_KEY, migrationState.rawData);
            } catch {}
            updateSchemaMigrationUi();
        }
        }, 50);
    }
    function initAll(){
        loadFromLocalStorage();
        if(migrationState.needsMigration){
            showSchemaMigrationOverlay();
            return;
        }
        completeAppInitialization();
    }

    function completeAppInitialization(){
        hideSchemaMigrationOverlay();
        const validationResult = validateUniqueIds(appData);
        if (!validationResult.success) {
            console.log("ID validation failed, auto-normalizing:", validationResult.errors);
            normalizeIds(appData);
            saveToLocalStorage();
        }

        renderPrintersTable();
        renderGlobalMaterialsTable();
        renderGlobalAdditionalTable();
        renderClientsTable();
        renderCalcPrinters();
        renderCustomServicesTable();
        renderHistoryTable();
        updateHistoryStats();
        renderSummary();
        const periodSelect = document.getElementById("summaryPeriod");
        periodSelect.addEventListener("change", onSummaryPeriodChange);
        document.getElementById("summaryApplyBtn").addEventListener("click", renderSummary);
        onSummaryPeriodChange();
        document.getElementById("calcOperatorRate").value = appData.calcSettings.operatorRate || "";
        document.getElementById("calcOperatorReject").checked = appData.calcSettings.includeOperatorForRejects || false;
        document.getElementById("calcDowntimeCost").value = appData.calcSettings.downtimeCost || "";
        document.getElementById("calcPreparationRate").value = appData.calcSettings.preparationRate || "";
        document.getElementById("calcPreparationTime").value = appData.calcSettings.preparationTime ? formatTimeForDisplay(appData.calcSettings.preparationTime) : "";
        document.getElementById("calcCostKwh").value = appData.calcSettings.costKwh || "";
        document.getElementById("calcTaxPercent").value = appData.calcSettings.taxPercent || "";
        document.getElementById("calcRoundingMode").value = appData.calcSettings.roundingMode || "none";
        document.getElementById("calcShipping").value = appData.calcSettings.shipping || "";
        ensureCalcStartDate();
        const deadlineInput = document.getElementById("calcDeadlineDate");
        if (deadlineInput) {
            deadlineInput.value = appData.calcSettings.deadlineDate || "";
        }
        document.getElementById("calcParallelPrinting").value = appData.calcSettings.parallelPrinting || "no";
        document.getElementById("calcMarkupPercent").value = appData.calcSettings.markupPercent || 0;
        document.getElementById("calcDiscountPercent").value = appData.calcSettings.discountPercent || 0;
        document.getElementById("settingsIncludeAmortization").checked = appData.calcSettings.includeAmortization !== false;
        document.getElementById("settingsIncludeRejects").checked = appData.calcSettings.includeRejects !== false;
        document.getElementById("settingsIncludeOverheads").checked = appData.calcSettings.includeOverheads !== false;
        document.getElementById("settingsIgnoreCoolingRejects").checked = appData.calcSettings.ignoreCoolingRejects || false;
        document.getElementById("calcFinalCost").value = '';
        toggleFinalFields(document.getElementById("calcOrderStatus").value);
        document.getElementById("companyNameInput").value = appData.labelSettings.companyName || "";
        document.getElementById("chatLinkInput").value = appData.labelSettings.chatLink || "";
        document.getElementById("bankDetailsInput").value = appData.labelSettings.bankDetails || "";
        document.getElementById("labelCostInput").value = appData.labelSettings.costPerLabel || 0;
        document.getElementById("printLabelsCheckbox").checked = appData.labelSettings.printLabels || false;
        document.getElementById("printEstimateCheckbox").checked = appData.calcSettings.includeEstimatePrint || false;
        document.getElementById("estimatePrintCostInput").value = appData.calcSettings.estimatePrintCost || 0;
        initUrgencyProfilesDraft();
        buildOperatorScheduleUI();
        renderUrgencyProfileOptions();
        renderCalcUrgencySelect();


        window.__gcodecalc_ready = true;
        if (window.__gcodecalc_readyResolve) {
            window.__gcodecalc_readyResolve();
            window.__gcodecalc_readyResolve = null;
        }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏
    function parseTimeInput(input) {
        if (input.includes(":")) {
            const [hours, minutes] = input.split(":").map(Number);
            return hours + (minutes / 60);
        }
        return parseFloat(input) || 0;
    }

    function formatTimeForDisplay(time) {
        if (time === undefined || time === null) return "";
        const hours = Math.floor(time);
        const minutes = Math.round((time - hours) * 60);
        return `${hours}:${minutes.toString().padStart(2, '0')}`;
    }

    function safeFixed(val, digits = 2) {
        const num = Number(val);
        return isNaN(num) ? '0.00' : num.toFixed(digits);
    }

    function handleTimeInput(event) {
        const input = event.target.value;
        // –ü–æ–∑–≤–æ–ª—è–µ–º –≤–≤–æ–¥–∏—Ç—å –∫–∞–∫ –ß:–ú, —Ç–∞–∫ –∏ –¥–µ—Å—è—Ç–∏—á–Ω–æ–µ —á–∏—Å–ª–æ
        if (input.includes(":")) {
            const [hours, minutes] = input.split(":").map(Number);
            if (!isNaN(hours) && !isNaN(minutes)) {
                return hours + (minutes / 60);
            }
        }
        return parseFloat(input) || 0;
    }

    function parseTimeFromLink(str){
        if(!str) return 0;
        let m = str.match(/(\d+)h\s*(\d+)m/);
        if(m) return parseInt(m[1],10) + parseInt(m[2],10)/60;
        m = str.match(/(\d+)h/);
        if(m) return parseInt(m[1],10);
        m = str.match(/(\d+)m/);
        if(m) return parseInt(m[1],10)/60;
        return parseTimeInput(str);
    }

    function getTodayIsoDate() {
        const now = new Date();
        const tzOffset = now.getTimezoneOffset();
        const local = new Date(now.getTime() - tzOffset * 60000);
        return local.toISOString().slice(0, 16);
    }

    function normalizeDateTimeLocal(value) {
        if (!value) return getTodayIsoDate();
        if (value.includes("T")) {
            return value.slice(0, 16);
        }
        return `${value}T08:00`;
    }

    function parseDateTimeLocalToDate(value) {
        if (!value) return null;
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) return null;
        return parsed;
    }

    function ensureCalcStartDate() {
        const inp = document.getElementById("calcStartDate");
        if (inp) {
            inp.value = normalizeDateTimeLocal(inp.value);
        }
    }

    function initUrgencyProfilesDraft() {
        if (Array.isArray(appData.labelSettings.urgencyProfiles) && appData.labelSettings.urgencyProfiles.length) {
            urgencyProfilesDraft = JSON.parse(JSON.stringify(appData.labelSettings.urgencyProfiles));
        } else {
            urgencyProfilesDraft = JSON.parse(JSON.stringify(DEFAULT_URGENCY_PROFILES));
        }
        if (!urgencyProfilesDraft.length) {
            urgencyProfilesDraft = JSON.parse(JSON.stringify(DEFAULT_URGENCY_PROFILES));
        }
        currentUrgencyProfileId = urgencyProfilesDraft[0] ? urgencyProfilesDraft[0].id : null;
    }

    function getEditingProfileById(pid) {
        return urgencyProfilesDraft.find(p => String(p.id) === String(pid));
    }

    function renderUrgencyProfileOptions() {
        const select = document.getElementById('urgencyProfileSelect');
        if (!select) return;
        select.innerHTML = '';
        urgencyProfilesDraft.forEach(profile => {
            const option = document.createElement('option');
            option.value = profile.id;
            const suffix = profile.markupPercent ? ` (+${profile.markupPercent}% )` : '';
            option.textContent = `${profile.title}${suffix}`;
            select.appendChild(option);
        });
        if (!getEditingProfileById(currentUrgencyProfileId) && urgencyProfilesDraft.length) {
            currentUrgencyProfileId = urgencyProfilesDraft[0].id;
        }
        if (currentUrgencyProfileId) {
            select.value = currentUrgencyProfileId;
        }
        renderCurrentUrgencyMeta();
        renderOperatorScheduleInputsForProfile(currentUrgencyProfileId);
    }

    function renderCurrentUrgencyMeta() {
        const profile = getEditingProfileById(currentUrgencyProfileId);
        const nameInput = document.getElementById('urgencyProfileName');
        const markupInput = document.getElementById('urgencyProfileMarkup');
        const descInput = document.getElementById('urgencyProfileDescription');
        if (!profile) {
            if (nameInput) nameInput.value = '';
            if (markupInput) markupInput.value = '';
            if (descInput) descInput.value = '';
            updateUrgencyScheduleHint(null);
            return;
        }
        if (nameInput) nameInput.value = profile.title || '';
        if (markupInput) markupInput.value = profile.markupPercent || 0;
        if (descInput) descInput.value = profile.description || '';
        updateUrgencyScheduleHint(profile);
    }

    function captureScheduleFromInputs(profileId) {
        const profile = getEditingProfileById(profileId);
        if (!profile) return;
        const scheduleMap = {};
        WEEKDAY_LABELS.forEach(day => {
            const rows = [];
            for (let i = 0; i < OPERATOR_PERIOD_ROWS; i++) {
                const startInput = document.querySelector(`.operator-period-input[data-day="${day.value}"][data-index="${i}"][data-type="start"]`);
                const endInput = document.querySelector(`.operator-period-input[data-day="${day.value}"][data-index="${i}"][data-type="end"]`);
                if (!startInput || !endInput) continue;
                if (!startInput.value && !endInput.value) continue;
                rows.push({ start: startInput.value, end: endInput.value });
            }
            scheduleMap[day.value] = rows;
        });
        profile.schedule = scheduleMap;
    }

    function renderOperatorScheduleInputsForProfile(profileId) {
        const profile = getEditingProfileById(profileId);
        const scheduleMap = profile && profile.schedule ? profile.schedule : {};
        WEEKDAY_LABELS.forEach(day => {
            const daySchedule = Array.isArray(scheduleMap[day.value]) ? scheduleMap[day.value] : [];
            for (let i = 0; i < OPERATOR_PERIOD_ROWS; i++) {
                const startInput = document.querySelector(`.operator-period-input[data-day="${day.value}"][data-index="${i}"][data-type="start"]`);
                const endInput = document.querySelector(`.operator-period-input[data-day="${day.value}"][data-index="${i}"][data-type="end"]`);
                if (!startInput || !endInput) continue;
                const period = daySchedule[i];
                startInput.value = period && period.start ? period.start : '';
                endInput.value = period && period.end ? period.end : '';
            }
        });
        updateUrgencyScheduleHint(profile);
    }

    function updateUrgencyScheduleHint(profile) {
        const hint = document.getElementById('urgencyScheduleHint');
        if (!hint) return;
        if (!profile) {
            hint.textContent = '';
            return;
        }
        const summary = buildScheduleSummary(normalizeScheduleMap(profile.schedule || {}));
        if (!summary.length) {
            hint.textContent = '–ì—Ä–∞—Ñ–∏–∫ –Ω–µ –∑–∞–¥–∞–Ω.';
            return;
        }
        const parts = summary.map(item => `${item.dayLabel}: ${item.windowLabel}`);
        hint.textContent = `–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å: ${profile.title || ''}. ${parts.join('; ')}`;
    }

    function addUrgencyProfile() {
        captureScheduleFromInputs(currentUrgencyProfileId);
        const newProfile = {
            id: `urg_${Date.now()}`,
            title: '–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å',
            markupPercent: 0,
            description: '',
            schedule: createScheduleFromPeriods(DEFAULT_OPERATOR_PERIODS),
            workingDays: [...DEFAULT_WORKING_DAYS]
        };
        urgencyProfilesDraft.push(newProfile);
        currentUrgencyProfileId = newProfile.id;
        renderUrgencyProfileOptions();
    }

    function deleteCurrentUrgencyProfile() {
        if (urgencyProfilesDraft.length <= 1) {
            alert('–î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ—Ñ–∏–ª—å.');
            return;
        }
        const targetId = currentUrgencyProfileId;
        urgencyProfilesDraft = urgencyProfilesDraft.filter(p => p.id !== targetId);
        currentUrgencyProfileId = urgencyProfilesDraft[0] ? urgencyProfilesDraft[0].id : null;
        if (appData.calcSettings.currentUrgencyId === targetId) {
            appData.calcSettings.currentUrgencyId = currentUrgencyProfileId;
        }
        renderUrgencyProfileOptions();
    }

    function refreshUrgencyProfileSelectLabels() {
        const select = document.getElementById('urgencyProfileSelect');
        if (!select) return;
        Array.from(select.options).forEach(option => {
            const profile = getEditingProfileById(option.value);
            if (profile) {
                const suffix = profile.markupPercent ? ` (+${profile.markupPercent}% )` : '';
                option.textContent = `${profile.title}${suffix}`;
            }
        });
    }

    function getUrgencyProfileById(pid) {
        if (!Array.isArray(appData.labelSettings.urgencyProfiles)) return null;
        return appData.labelSettings.urgencyProfiles.find(p => String(p.id) === String(pid)) || null;
    }

    function getScheduleMinutesForProfile(profile) {
        if (!profile) return normalizeScheduleMap({});
        return normalizeScheduleMap(profile.schedule || {});
    }

    function buildOperatorScheduleUI() {
        const tabs = document.getElementById("operatorWeekTabs");
        const content = document.getElementById("operatorWeekContent");
        if (!tabs || !content) return;
        tabs.innerHTML = "";
        content.innerHTML = "";
        WEEKDAY_LABELS.forEach((day, idx) => {
            const li = document.createElement("li");
            li.className = "nav-item";
            const btn = document.createElement("button");
            btn.className = "nav-link" + (idx === 0 ? " active" : "");
            btn.type = "button";
            btn.id = `day-tab-${day.value}`;
            btn.setAttribute("data-bs-toggle", "tab");
            btn.setAttribute("data-bs-target", `#day-pane-${day.value}`);
            btn.setAttribute("role", "tab");
            btn.setAttribute("data-day", String(day.value));
            btn.textContent = day.label;
            li.appendChild(btn);
            tabs.appendChild(li);

            const pane = document.createElement("div");
            pane.className = "tab-pane fade" + (idx === 0 ? " show active" : "");
            pane.id = `day-pane-${day.value}`;
            pane.setAttribute("role", "tabpanel");

            const tableWrapper = document.createElement("div");
            tableWrapper.className = "table-responsive";
            const table = document.createElement("table");
            table.className = "table table-sm align-middle mb-0";
            table.innerHTML = `
        <thead>
          <tr>
            <th style="width:5%">#</th>
            <th>–ù–∞—á–∞–ª–æ</th>
            <th>–ö–æ–Ω–µ—Ü</th>
          </tr>
        </thead>
        <tbody></tbody>`;
            const tbody = table.querySelector("tbody");
            for (let i = 0; i < OPERATOR_PERIOD_ROWS; i++) {
                const tr = document.createElement("tr");
                const tdIndex = document.createElement("td");
                tdIndex.textContent = i + 1;
                const tdStart = document.createElement("td");
                const tdEnd = document.createElement("td");
                const startInput = document.createElement("input");
                startInput.type = "time";
                startInput.className = "form-control operator-period-input";
                startInput.dataset.day = String(day.value);
                startInput.dataset.index = String(i);
                startInput.dataset.type = "start";
                startInput.step = "300";
                const endInput = document.createElement("input");
                endInput.type = "time";
                endInput.className = "form-control operator-period-input";
                endInput.dataset.day = String(day.value);
                endInput.dataset.index = String(i);
                endInput.dataset.type = "end";
                endInput.step = "300";
                tdStart.appendChild(startInput);
                tdEnd.appendChild(endInput);
                tr.appendChild(tdIndex);
                tr.appendChild(tdStart);
                tr.appendChild(tdEnd);
                tbody.appendChild(tr);
            }
            tableWrapper.appendChild(table);
            pane.appendChild(tableWrapper);
            content.appendChild(pane);
        });
    }


    let workdayLunchOffsetMinutes = 240;
    let lunchStartManual = false;

    function getActiveScheduleDayValue() {
        const activeTab = document.querySelector('#operatorWeekTabs .nav-link.active');
        if (activeTab) {
            const dayAttr = activeTab.getAttribute('data-day');
            if (dayAttr !== null) return Number(dayAttr);
            const target = activeTab.getAttribute('data-bs-target');
            if (target) {
                const match = target.match(/day-pane-(\d)/);
                if (match) return Number(match[1]);
            }
        }
        return WEEKDAY_LABELS[0]?.value ?? 1;
    }

    function setScheduleForDay(dayValue, segments) {
        for (let i = 0; i < OPERATOR_PERIOD_ROWS; i++) {
            const startInput = document.querySelector(`.operator-period-input[data-day="${dayValue}"][data-index="${i}"][data-type="start"]`);
            const endInput = document.querySelector(`.operator-period-input[data-day="${dayValue}"][data-index="${i}"][data-type="end"]`);
            if (!startInput || !endInput) continue;
            if (segments[i]) {
                startInput.value = minutesToTimeString(segments[i].start);
                endInput.value = minutesToTimeString(segments[i].end);
            } else {
                startInput.value = '';
                endInput.value = '';
            }
        }
    }

    function clearSpecialBreaks() {
        const container = document.getElementById('specialBreaksContainer');
        if (container) container.innerHTML = '';
    }

    function addSpecialBreakRow(defaultStart = '', defaultDuration = 10) {
        const container = document.getElementById('specialBreaksContainer');
        if (!container) return;
        const row = document.createElement('div');
        row.className = 'row g-2 align-items-center special-break-row mb-2';
        row.innerHTML = `
        <div class="col-md-5">
            <input type="time" class="form-control form-control-sm special-break-start" value="${defaultStart}">
        <\/div>
        <div class="col-md-4">
            <input type="number" class="form-control form-control-sm special-break-duration" min="5" max="60" step="5" value="${defaultDuration}">
        <\/div>
        <div class="col-md-3 text-end">
            <button type="button" class="btn btn-link text-danger p-0 remove-break-row">&times;<\/button>
        <\/div>`;
        container.appendChild(row);
    }

    function updateLunchStartByOffset() {
        if (lunchStartManual) return;
        const skip = document.getElementById('workdaySkipLunch');
        if (skip && skip.checked) return;
        const startInput = document.getElementById('workdayStartTime');
        const lunchInput = document.getElementById('workdayLunchStart');
        if (!startInput || !lunchInput) return;
        const startMin = timeStringToMinutes(startInput.value || '');
        if (Number.isNaN(startMin)) return;
        const normalized = startMin + workdayLunchOffsetMinutes;
        if (normalized >= 0 && normalized < 24 * 60) {
            lunchInput.value = minutesToTimeString(normalized);
        }
    }

    function presetWorkdayTemplateModal() {
        const templateSelect = document.getElementById('workdayTemplateSelect');
        if (templateSelect) {
            templateSelect.value = '8h_classic';
        }
        const startInput = document.getElementById('workdayStartTime');
        if (startInput) startInput.value = '09:00';
        const totalHoursInput = document.getElementById('workdayTotalHours');
        if (totalHoursInput) totalHoursInput.value = '8';
        const lunchDurationInput = document.getElementById('workdayLunchDuration');
        if (lunchDurationInput) {
            lunchDurationInput.value = '60';
            lunchDurationInput.disabled = false;
        }
        const lunchInput = document.getElementById('workdayLunchStart');
        if (lunchInput) {
            lunchInput.value = '13:00';
            lunchInput.disabled = false;
        }
        const skipLunch = document.getElementById('workdaySkipLunch');
        if (skipLunch) skipLunch.checked = false;
        workdayLunchOffsetMinutes = 240;
        lunchStartManual = false;
        clearSpecialBreaks();
        const activeDay = getActiveScheduleDayValue();
        const dayCheckboxes = document.querySelectorAll('#workdayDaysContainer input[type="checkbox"]');
        dayCheckboxes.forEach(chk => {
            chk.checked = Number(chk.value) === activeDay;
        });
    }

    function gatherSelectedWorkdays() {
        const boxes = document.querySelectorAll('#workdayDaysContainer input[type="checkbox"]:checked');
        if (boxes.length) {
            return Array.from(boxes).map(b => Number(b.value));
        }
        return [getActiveScheduleDayValue()];
    }

    function collectSpecialBreaks(startMinutes, totalWorkMinutes) {
        const breaks = [];
        const container = document.getElementById('specialBreaksContainer');
        if (!container) return breaks;
        container.querySelectorAll('.special-break-row').forEach(row => {
            const startField = row.querySelector('.special-break-start');
            const durationField = row.querySelector('.special-break-duration');
            if (!startField || !durationField) return;
            if (!startField.value) return;
            const s = timeStringToMinutes(startField.value);
            const d = parseInt(durationField.value, 10);
            if (Number.isNaN(s) || Number.isNaN(d) || d <= 0) return;
            breaks.push({start: s, duration: d, label: '–°–ø–µ—Ü–ø–µ—Ä–µ—Ä—ã–≤'});
        });
        return breaks;
    }

    function buildTemplateSegments(startMinutes, totalWorkMinutes, breaks) {
        const sortedBreaks = breaks.slice().sort((a, b) => a.start - b.start);
        let cursor = startMinutes;
        let consumed = 0;
        const segments = [];
        for (const br of sortedBreaks) {
            if (consumed >= totalWorkMinutes) break;
            if (br.start < cursor) {
                throw new Error('–ü–µ—Ä–µ—Ä—ã–≤—ã –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è –∏–ª–∏ —É–∫–∞–∑–∞–Ω—ã —Ä–∞–Ω—å—à–µ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã.');
            }
            const available = br.start - cursor;
            if (available > 0 && consumed < totalWorkMinutes) {
                const chunk = Math.min(available, totalWorkMinutes - consumed);
                if (chunk > 0) {
                    segments.push({start: cursor, end: cursor + chunk});
                    consumed += chunk;
                }
            }
            cursor = br.start + br.duration;
        }
        if (consumed < totalWorkMinutes) {
            segments.push({start: cursor, end: cursor + (totalWorkMinutes - consumed)});
            cursor += totalWorkMinutes - consumed;
            consumed = totalWorkMinutes;
        }
        if (!segments.length) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏.');
        }
        return {segments, end: cursor};
    }

    function applyWorkdayTemplateFromModal() {
        try {
            const totalHours = parseFloat(document.getElementById('workdayTotalHours').value) || 0;
            if (totalHours <= 0) {
                alert('–£–∫–∞–∂–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–º–µ–Ω—ã.');
                return;
            }
            const startValue = document.getElementById('workdayStartTime').value;
            const startMinutes = timeStringToMinutes(startValue);
            if (Number.isNaN(startMinutes)) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞.');
                return;
            }
            const skipLunch = document.getElementById('workdaySkipLunch').checked;
            const lunchDuration = parseInt(document.getElementById('workdayLunchDuration').value, 10) || 0;
            const totalWorkMinutes = totalHours * 60;
            const breaks = [];
            if (!skipLunch) {
                const lunchStart = timeStringToMinutes(document.getElementById('workdayLunchStart').value);
                if (Number.isNaN(lunchStart)) {
                    alert('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –æ–±–µ–¥–∞.');
                    return;
                }
                if (lunchStart < startMinutes) {
                    alert('–û–±–µ–¥ –Ω–µ –º–æ–∂–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Ä–∞–Ω—å—à–µ —Å–º–µ–Ω—ã.');
                    return;
                }
                if (lunchStart >= startMinutes + totalWorkMinutes) {
                    alert('–û–±–µ–¥ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è.');
                    return;
                }
                if (totalWorkMinutes > 240 && (lunchDuration < 30 || lunchDuration > 120)) {
                    alert('–û–±–µ–¥ –ø—Ä–∏ —Å–º–µ–Ω–∞—Ö >4 —á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 30‚Äì120 –º–∏–Ω—É—Ç.');
                    return;
                }
                if (lunchDuration > 0) {
                    breaks.push({start: lunchStart, duration: lunchDuration, label: '–û–±–µ–¥'});
                }
            } else if (totalWorkMinutes > 240) {
                alert('–°–º–µ–Ω–∞ —Å–≤—ã—à–µ 4 —á–∞—Å–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –æ–±–µ–¥–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞ –ø–æ —Å—Ç.108 –¢–ö –†–§.');
                return;
            }
            const specialBreaks = collectSpecialBreaks(startMinutes, totalWorkMinutes);
            breaks.push(...specialBreaks);
            const limit = startMinutes + totalWorkMinutes;
            const validBreaks = [];
            for (const br of breaks) {
                if (br.start < startMinutes) {
                    alert(`${br.label || '–ü–µ—Ä–µ—Ä—ã–≤'} –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ —Å–º–µ–Ω—ã.`);
                    return;
                }
                if (br.start >= limit) {
                    continue;
                }
                validBreaks.push(br);
            }
            const {segments, end} = buildTemplateSegments(startMinutes, totalWorkMinutes, validBreaks);
            if (end > 24 * 60) {
                alert('–°–º–µ–Ω–∞ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –æ–¥–Ω–∏—Ö —Å—É—Ç–æ–∫. –û—Ç—Ä–µ–≥—É–ª–∏—Ä—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.');
                return;
            }
            const days = gatherSelectedWorkdays();
            if (!days.length) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏.');
                return;
            }
            days.forEach(day => setScheduleForDay(day, segments));
            const modalEl = document.getElementById('workdayTemplateModal');
            if (modalEl) {
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
            alert('–ì—Ä–∞—Ñ–∏–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.');
        } catch (error) {
            alert(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω.');
        }
    }

    async function parseGcodeText(text) {
        const lines = text.split(/\r?\n/);
        let code = '', timeStr = '', weight = '', printer = 'Unknown', matProfile = '', thumb = '';
        let plateNameFound = false;
        let plateName = '';
        let afterExecStart = false, afterExecEnd = false, inConfig = false, inThumb = false;
        let thumbnailFound = false;
        let linesAfterExecStart = 0;

        for (let raw of lines) {
            const line = raw.trim();

            if (line.startsWith('; MODEL_CODE:')) {
                code = line.split(':')[1].trim();
                continue;
            }

            if (line === '; EXECUTABLE_BLOCK_START') {
                afterExecStart = true;
                continue;
            }

            if (line === '; EXECUTABLE_BLOCK_END') {
                afterExecEnd = true;
                continue;
            }

            if (afterExecStart && !plateNameFound && linesAfterExecStart < 50) {
                linesAfterExecStart++;

                if (line.includes('plate_name=')) {
                    const match = line.match(/plate_name=\s*([^;]+)/);
                    if (match && match[1]) {
                        plateName = match[1].trim();
                        plateNameFound = true;
                    }
                }
            }

            if (line.startsWith('; THUMBNAIL_BLOCK_START')) {
                continue;
            }

            if (line.startsWith('; thumbnail begin')) {
                if (!thumbnailFound) {
                    inThumb = true;
                    thumbnailFound = true;
                }
                continue;
            }

            if (line.startsWith('; thumbnail end')) {
                if (inThumb) {
                    inThumb = false;
                }
                continue;
            }

            if (inThumb && thumbnailFound) {
                if (line.startsWith(';')) {
                    thumb += line.slice(1).trim();
                } else {
                    thumb += line.trim();
                }
                continue;
            }

            if (line.startsWith('; THUMBNAIL_BLOCK_END')) {
                continue;
            }

            if (line === '; CONFIG_BLOCK_START') {
                inConfig = true;
                continue;
            }

            if (line === '; CONFIG_BLOCK_END') {
                inConfig = false;
                continue;
            }

            if (inConfig) {
                if (line.includes('printer_settings_id') && line.includes('=')) {
                    printer = line.split('=')[1].replace(/"/g, '').trim();
                } else if (line.startsWith('; filament_settings_id') && line.includes('=')) {
                    matProfile = line.split('=')[1].replace(/"/g, '').trim();
                }
            }

            if (line.startsWith('; estimated printing time') && line.includes('=')) {
                timeStr = line.split('=')[1].trim();
            }
            else if (line.startsWith('; total filament used [g]') && line.includes('=')) {
                weight = line.split('=')[1].trim();
            }
        }

        if (!code) code = getNextId('gcodeModels');

        const modelName = plateNameFound ? plateName : code;

        return { code, modelName, timeStr, weight, printer, matProfile, thumb };
    }

    async function addModelFromGcode(parsed){
        const pr = await resolvePrinterForLink(parsed.printer);
        if(!pr){
            alert('–ù–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏–Ω—Ç–µ—Ä '+parsed.printer);
            return;
        }
        const mid = await resolveMaterialIdByProfile(parsed.matProfile);
        addModelRow(pr.id, {
            id: parsed.code,
            name: parsed.modelName || parsed.code,
            thumbnail: parsed.thumb,
            status: 'new',
            hours: parseTimeFromLink(parsed.timeStr),
            weight: parseFloat(parsed.weight) || 0,
            materialId: mid
        });
    }

    function setupGcodeDrop() {
        window.addEventListener('dragover', e => {
            e.preventDefault();
        });

        window.addEventListener('drop', async e => {
            e.preventDefault();

            let printerId = null;
            let target = e.target;

            while (target && !printerId) {
                if (target.id && target.id.startsWith('calcModelsTable_')) {
                    printerId = target.id.split('_')[1];
                    break;
                }
                target = target.parentElement;
            }

            if (!printerId) {
                alert('Please drop the G-code file over a printer\'s table.');
                return;
            }

            const files = Array.from(e.dataTransfer.files).filter(f =>
                f.name.toLowerCase().endsWith('.gcode')
            );

            for (const f of files) {
                const txt = await f.text();
                const parsed = await parseGcodeText(txt);
                let mid = await resolveMaterialIdByProfile(parsed.matProfile);

                const modelName = parsed.modelName || f.name.replace(/\.gcode$/i, '');

                if (!mid) {
                    const materialOptions = appData.materials.map(m => ({
                        value: String(m.id),
                        label: `${m.name} (ID: ${m.id}${m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : ''})`
                    }));

                    if (materialOptions.length > 0) {
                        const result = await showMaterialSelectionForGcode(f.name, parsed.thumb, materialOptions);

                        if (result && result.materialId) {
                            mid = result.materialId;
                            if (result.remember && (parsed.matProfile||'').trim()) {
                                PromptMemory.setMaterial(parsed.matProfile.trim(), mid);
                            }
                        } else {
                            continue;
                        }
                    } else {
                        alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã".');
                        continue;
                    }
                }

                addModelRow(printerId, {
                    id: parsed.code,
                    name: modelName,
                    thumbnail: parsed.thumb,
                    status: 'new',
                    hours: parseTimeFromLink(parsed.timeStr),
                    weight: parseFloat(parsed.weight) || 0,
                    materialId: mid
                });
            }
        });
    }


    function waitForAppReady(){
        if (window.__gcodecalc_ready) return Promise.resolve();
        return new Promise(resolve => {
            window.__gcodecalc_readyResolve = resolve;
        });
    }

    const __importQueue = (() => {
        let chain = Promise.resolve();
        return {
            enqueue(task){
                const next = chain.then(task, task);
                chain = next.catch(e => console.error('Import task failed', e));
                return next;
            }
        };
    })();

    const __recentImports = new Map();
    function __isDuplicateImportKey(key){
        const now = Date.now();
        const last = __recentImports.get(key) || 0;
        __recentImports.set(key, now);

        for (const [k,t] of __recentImports.entries()){
            if (now - t > 10000) __recentImports.delete(k);
        }
        return (now - last) < 1200;
    }

    async function ensureTargetOrderForImport(){
        const auto = PromptMemory.getOrderAuto();
        if(auto && typeof auto.remaining === 'number' && auto.remaining > 0){
            if(auto.kind === 'history'){
                const ts = parseInt(auto.value, 10);
                const exists = (appData.calcHistory||[]).some(h => String(h.timestamp) === String(ts));
                if(exists){
                    onEditCalcHistory(ts);
                    PromptMemory.consumeOrderAuto();
                    await new Promise(r => setTimeout(r, 0));
                    return true;
                }
                PromptMemory.setOrderAuto(null);
            } else if(auto.kind === 'current'){
                PromptMemory.consumeOrderAuto();
                return true;
            }
        }

        const options = [
            { value:'current', label:'–¢–µ–∫—É—â–∏–π —Ä–∞—Å—á—ë—Ç' },
            { value:'new', label:'–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç' },
        ].concat((appData.calcHistory||[]).map(h => ({
            value: String(h.timestamp),
            label: (h.calcName || h.dateStr || String(h.timestamp))
        })));

        const res = await showMultiPrompt('–ö—É–¥–∞ –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å?', [
            { id:'targetOrder', label:'–†–∞—Å—á—ë—Ç', type:'select', options, value:'current' },
            { id:'remember', label:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤', type:'checkbox', value:false,
                help:'–ü–æ–ª–µ–∑–Ω–æ, –∫–æ–≥–¥–∞ Orca —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–∞—á–∫—É –º–æ–¥–µ–ª–µ–π –ø–æ–¥—Ä—è–¥.' ,
                onChange:(el)=>{ const cnt=document.getElementById('mp_rememberCount'); if(cnt) cnt.disabled=!el.checked; } },
            { id:'rememberCount', label:'–°–∫–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–∏—Ö –º–æ–¥–µ–ª–µ–π', type:'number', min:1, max:999, step:1, value:5, disabled:true }
        ]);

        if(!res) return false;

        const val = String(res.targetOrder || 'current');

        if(val === 'new'){
            startNewCalculation();
        } else if(val !== 'current'){
            onEditCalcHistory(parseInt(val,10));
        }

        if(res.remember){
            const remaining = Math.max(1, parseInt(res.rememberCount || 1, 10));
            const kind = (val !== 'current' && val !== 'new') ? 'history' : 'current';
            const value = kind === 'history' ? val : 'current';
            PromptMemory.setOrderAuto({ kind, value, remaining });
        } else {
            PromptMemory.setOrderAuto(null);
        }

        await new Promise(r => setTimeout(r, 0));
        return true;
    }

    async function importGcodeTextFlow(gcodeText, fileName){
        await waitForAppReady();

        const txt = String(gcodeText || '');
        const fn = String(fileName || '').trim() || 'model.gcode';

        const parsed = await parseGcodeText(txt);

        const dedupeKey = [
            fn,
            parsed.code || '',
            parsed.modelName || '',
            parsed.printer || '',
            parsed.matProfile || '',
            parsed.timeStr || '',
            parsed.weight || ''
        ].join('|');

        if(__isDuplicateImportKey(dedupeKey)){
            console.warn('Duplicate import suppressed', dedupeKey);
            return;
        }

        const pr = await resolvePrinterForLink(parsed.printer);
        if(!pr){
            alert('–ù–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏–Ω—Ç–µ—Ä –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è: ' + (parsed.printer || 'Unknown'));
            return;
        }

        let mid = await resolveMaterialIdByProfile(parsed.matProfile);

        if(!mid){
            const materialOptions = (appData.materials||[]).map(m => ({
                value: String(m.id),
                label: `${m.name} (ID: ${m.id}${m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : ''})`
            }));

            if(materialOptions.length === 0){
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã".');
                return;
            }

            const pick = await showMaterialSelectionForGcode(fn, parsed.thumb, materialOptions, parsed.matProfile);
            if(!pick || !pick.materialId) return;

            mid = pick.materialId;

            if(pick.remember && (parsed.matProfile||'').trim()){
                PromptMemory.setMaterial(parsed.matProfile.trim(), mid);
            }
        }

        const ok = await ensureTargetOrderForImport();
        if(!ok) return;

        const modelName = parsed.modelName || fn.replace(/\.gcode$/i,'') || parsed.code;

        addModelRow(pr.id, {
            id: parsed.code,
            name: modelName,
            thumbnail: parsed.thumb,
            status: 'new',
            hours: parseTimeFromLink(parsed.timeStr),
            weight: parseFloat(parsed.weight) || 0,
            materialId: mid
        });
    }

    function attachExternalImportBridge(){
        if(window.__gcodecalc_externalImportAttached) return;
        window.__gcodecalc_externalImportAttached = true;

        window.__gcodecalcImportGcodeText = (payload) => {
            if(!payload) return;
            __importQueue.enqueue(() => importGcodeTextFlow(payload.text || '', payload.fileName || payload.filePath || 'model.gcode'));
        };

        if(window.gcodeBridge && typeof window.gcodeBridge.onGcodeFile === 'function'){
            try {
                window.gcodeBridge.onGcodeFile((payload) => {
                    window.__gcodecalcImportGcodeText(payload);
                });
            } catch (e) {
                console.warn('Failed to attach gcodeBridge', e);
            }
        }
    }


    document.addEventListener("DOMContentLoaded", () => {
        instrumentFunctions();
        const backupBtn = document.getElementById('schemaMigrationBackupBtn');
        if(backupBtn) backupBtn.addEventListener('click', handleSchemaMigrationBackup);
        const startBtn = document.getElementById('schemaMigrationStartBtn');
        if(startBtn) startBtn.addEventListener('click', handleSchemaMigrationStart);
        initAll();
    });

    /* –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
    function selectAll(source, type) {
        const checkboxes = document.querySelectorAll("."+type+"_chk");
        checkboxes.forEach(cb => cb.checked = source.checked);
    }

    function filterTable(tableId, query){
        const tb = document.getElementById(tableId);
        if(!tb) return;
        const val = query.toLowerCase();
        tb.querySelectorAll('tbody tr').forEach(tr=>{
            tr.style.display = tr.innerText.toLowerCase().includes(val)?'' :'none';
        });
    }

    function sortTable(tableId, col){
        const tb=document.getElementById(tableId);
        if(!tb) return;
        const rows=Array.from(tb.querySelectorAll('tbody tr'));
        const asc=tb.dataset.sortCol==col && tb.dataset.sortDir==='asc'?false:true;
        rows.sort((a,b)=>{
            const va=a.children[col].innerText;
            const vb=b.children[col].innerText;
            return asc?va.localeCompare(vb,'ru',{numeric:true}):vb.localeCompare(va,'ru',{numeric:true});
        });
        const tbody=tb.querySelector('tbody');
        rows.forEach(r=>tbody.appendChild(r));
        tb.dataset.sortCol=col;
        tb.dataset.sortDir=asc?'asc':'desc';
    }
    function massDelete(type) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã?")) return;
        switch(type) {
            case 'printers':
                const removed = [];
                appData.printers = appData.printers.filter(p => {
                    const chk = document.getElementById("chk_printers_"+p.id);
                    const del = chk && chk.checked;
                    if(del) removed.push(String(p.id));
                    return !del;
                });
                renderPrintersTable();
                renderCalcPrinters();
                renderSummary();
                if(removed.length){
                    const unresolved = collectUnresolvedPrinters();
                    if(unresolved.length) showPrinterMapModal(unresolved);
                }
                break;
            case 'globalMaterials':
                appData.materials = appData.materials.filter(m => {
                    const chk = document.getElementById("chk_globalMaterials_"+m.id);
                    return !(chk && chk.checked);
                });
                renderGlobalMaterialsTable();
                renderSummary();
                break;
            case 'globalAdditional':
                appData.additionalGlobal = appData.additionalGlobal.filter(a => {
                    const chk = document.getElementById("chk_globalAdditional_"+a.id);
                    return !(chk && chk.checked);
                });
                renderGlobalAdditionalTable();
                renderSummary();
                break;
        }
        saveToLocalStorage();
    }
    async function massEdit(type) {
        switch(type) {
            case 'printers': {
                const vals = await showMultiPrompt('–ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤', [
                    {id:'cost',label:'–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)',type:'number'},
                    {id:'hours',label:'–ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏',type:'number'},
                    {id:'power',label:'–ú–æ—â–Ω–æ—Å—Ç—å (–í—Ç)',type:'number'},
                    {id:'maint',label:'–†–∞—Å—Ö–æ–¥ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (‚ÇΩ/—á)',type:'number'}
                ]);
                if(!vals) return;
                appData.printers.forEach(p=>{
                    const chk=document.getElementById('chk_printers_'+p.id);
                    if(chk&&chk.checked){
                        if(vals.cost) p.cost=parseFloat(vals.cost)||p.cost;
                        if(vals.hours) p.hoursToRecoup=parseFloat(vals.hours)||p.hoursToRecoup;
                        if(vals.power) p.power=parseFloat(vals.power)||p.power;
                        if(vals.maint) p.maintCostHour=parseFloat(vals.maint)||p.maintCostHour;
                    }
                });
                renderPrintersTable();
                renderCalcPrinters();
                renderSummary();
            }
                break;
            case 'globalMaterials':
            {
                const vals = await showMultiPrompt('–ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤',[
                    {id: 'materialType', label: '–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞'},
                    {id:'cost',label:'–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥',type:'number'},
                    {id:'balance',label:'–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥)',type:'number'},
                    {id:'declared',label:'–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥)',type:'number'},
                    {id:'prepMinutes',label:'–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–º–∏–Ω)',type:'number'},
                    {id:'manuf',label:'–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å'},
                    {id:'prodDate',label:'–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞'},
                    {id:'printers',label:'–ü—Ä–∏–Ω—Ç–µ—Ä—ã',type:'multiselect',options:appData.printers.map(p=>({value:String(p.id),label:p.name}))},
                    {
                        id: 'profiles',
                        label: '–ü—Ä–æ—Ñ–∏–ª–∏',
                        type: 'multiselect',
                        options: (appData.materialProfiles || []).map(p => ({
                            value: String(p.id),
                            label: profileNameById(p.id) || `–ü—Ä–æ—Ñ–∏–ª—å ${p.id}`
                        }))
                    }
                ]);
                if(!vals) return;
                appData.materials.forEach(m=>{
                    const chk=document.getElementById('chk_globalMaterials_'+m.id);
                    if(chk&&chk.checked){
                        if(vals.materialType) m.materialType=vals.materialType;
                        if(vals.cost) m.costPerKg=parseFloat(vals.cost)||m.costPerKg;
                        if(vals.balance) m.balance=parseFloat(vals.balance)||m.balance;
                        if(vals.declared) m.declaredWeight=parseFloat(vals.declared)||m.declaredWeight;
                        if(vals.prepMinutes) m.printerPrepMinutes=parseFloat(vals.prepMinutes)||m.printerPrepMinutes;
                        if(vals.manuf) m.manufacturer=vals.manuf;
                        if(vals.prodDate) m.productionDate=vals.prodDate;
                        if(vals.printers && vals.printers.length) m.printers=vals.printers;
                        if(vals.profiles && vals.profiles.length) {
                            if(!Array.isArray(m.profileIds)) m.profileIds = [];
                            m.profileIds = vals.profiles;
                        }
                    }
                });
                renderGlobalMaterialsTable();
                renderSummary();
            }
                break;
            case 'globalAdditional':
            {
                const vals = await showMultiPrompt('–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã',[
                    {id:'cost',label:'–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)',type:'number'},
                    {id:'hours',label:'–ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏',type:'number'},
                    {id:'use',label:'–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç',type:'checkbox',value:true},
                    {id:'printers',label:'–ü—Ä–∏–Ω—Ç–µ—Ä—ã',type:'multiselect',options:appData.printers.map(p=>({value:String(p.id),label:p.name}))}
                ]);
                if(!vals) return;
                appData.additionalGlobal.forEach(a=>{
                    const chk=document.getElementById('chk_globalAdditional_'+a.id);
                    if(chk&&chk.checked){
                        if(vals.cost) a.cost=parseFloat(vals.cost)||a.cost;
                        if(vals.hours) a.hoursToRecoup=parseFloat(vals.hours)||a.hoursToRecoup;
                        a.useInCalc=vals.use;
                        if(vals.printers && vals.printers.length) a.printers=vals.printers;
                    }
                });
                renderGlobalAdditionalTable();
                renderSummary();
            }
                break;
        }
        saveToLocalStorage();
    }
    function copyElement(type, id) {
        switch(type) {
            case 'printers':
            {
                const orig = appData.printers.find(p => String(p.id) === String(id));
                if(orig){
                    const copy = JSON.parse(JSON.stringify(orig));
                    copy.id = getNextId('printers');
                    copy.name += " (–∫–æ–ø–∏—è)";
                    appData.printers.push(copy);
                    renderPrintersTable();
                    renderCalcPrinters();
                    renderSummary();
                }
            }
                break;
            case 'globalMaterials':
            {
                const orig = appData.materials.find(m => String(m.id) === String(id));
                if(orig){
                    const copy = JSON.parse(JSON.stringify(orig));
                    copy.id = getNextId('materials');
                    copy.name += " (–∫–æ–ø–∏—è)";
                    appData.materials.push(copy);
                    renderGlobalMaterialsTable();
                    renderSummary();
                }
            }
                break;
            case 'globalAdditional':
            {
                const orig = appData.additionalGlobal.find(a => String(a.id) === String(id));
                if(orig){
                    const copy = JSON.parse(JSON.stringify(orig));
                    copy.id = getNextId('additionalGlobal');
                    copy.description += " (–∫–æ–ø–∏—è)";
                    appData.additionalGlobal.push(copy);
                    renderGlobalAdditionalTable();
                    renderSummary();
                }
            }
                break;
        }
        saveToLocalStorage();
    }
    /* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ */
    function renderPrintersTable(){
        const tbody = document.querySelector("#printersTable tbody");
        tbody.innerHTML = "";
        appData.printers.forEach(printer => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td><input type="checkbox" id="chk_printers_${printer.id}" class="printers_chk"><\/td>
      <td>${printer.name}<\/td>
      <td>${printer.cost}<\/td>
      <td>${printer.hoursToRecoup}<\/td>
      <td>${printer.power}<\/td>
      <td>${printer.maintCostHour}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditPrinter('${printer.id}')">–†–µ–¥.<\/button>
          <button class="btn btn-success" onclick="openPrinterOrca('${printer.id}')">Orca<\/button>
          <button class="btn btn-warning" onclick="copyElement('printers', '${printer.id}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeletePrinter('${printer.id}')">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
            tbody.appendChild(tr);
        });
    }
    function onAddPrinter(){
        const newId = getNextId('printers');
        const p = {
            id: newId,
            name: "–ù–æ–≤—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä",
            cost: 0,
            hoursToRecoup: 1000,
            power: 0,
            maintCostHour: 0,
            profileIds: []
        };
        appData.printers.push(p);
        saveToLocalStorage();
        renderPrintersTable();
        renderCalcPrinters();
        renderSummary();
    }
    let currentPrinterEditId = null;
    function onEditPrinter(id){
        const p = appData.printers.find(x => String(x.id) === String(id));
        if(!p) return;
        currentPrinterEditId = id;
        document.getElementById('printerNameInput').value = p.name;
        document.getElementById('printerCostInput').value = p.cost;
        document.getElementById('printerHoursInput').value = p.hoursToRecoup;
        document.getElementById('printerPowerInput').value = p.power;
        document.getElementById('printerMaintInput').value = p.maintCostHour;
        new bootstrap.Modal(document.getElementById('printerModal')).show();
    }
    function savePrinterFromModal(){
        const p = appData.printers.find(x => String(x.id) === String(currentPrinterEditId));
        if(!p) return;
        p.name = document.getElementById('printerNameInput').value;
        p.cost = parseFloat(document.getElementById('printerCostInput').value) || 0;
        p.hoursToRecoup = parseFloat(document.getElementById('printerHoursInput').value) || 1000;
        p.power = parseFloat(document.getElementById('printerPowerInput').value) || 0;
        p.maintCostHour = parseFloat(document.getElementById('printerMaintInput').value) || 0;
        saveToLocalStorage();
        renderPrintersTable();
        renderCalcPrinters();
        renderSummary();
        bootstrap.Modal.getInstance(document.getElementById('printerModal')).hide();
    }
    function onDeletePrinter(id){
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä?")) return;
        appData.printers = appData.printers.filter(x => String(x.id) !== String(id));
        saveToLocalStorage();
        renderPrintersTable();
        renderCalcPrinters();
        renderSummary();
        const unresolved = collectUnresolvedPrinters();
        if(unresolved.length) showPrinterMapModal(unresolved);
    }
    /* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ */
    function renderGlobalMaterialsTable(){
        const tb = document.querySelector("#materialsTable tbody");
        tb.innerHTML = "";
        appData.materials.forEach(m => {
            const tr = document.createElement("tr");
            let col = m.color || '#ffffff';
            console.log(m.color);
            if (!col.startsWith('#')) {
                col = '#' + col;
            }

            const spoolmanText = m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : '';


            const tc = textColorForBg(col);
            tr.innerHTML = `
      <td><input type="checkbox" id="chk_globalMaterials_${m.id}" class="globalMaterials_chk"><\/td>
      <td style="background-color:${col};color:${tc};">${m.name} (ID: ${m.id}${spoolmanText})<\/td>
      <td>${m.materialType}<\/td>
      <td>${m.costPerKg}<\/td>
      <td>${m.balance * 1000}<\/td>
      <td>${m.declaredWeight || "-"}<\/td>
      <td>${m.coolingTime || 0}<\/td>
      <td>${m.printerPrepMinutes || 0}<\/td>
      <td>${m.manufacturer || "-"}<\/td>
      <td>${m.productionDate || "-"}<\/td>
      <td>${(m.printers && m.printers.length) ? m.printers.map(printerNameById).join(', ') : '–í—Å–µ'}<\/td>
      <td>${(m.profileIds && m.profileIds.length) ? m.profileIds.map(profileNameById).join(', ') : '-'}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditGlobalMaterial('${m.id}')">–†–µ–¥.<\/button>
          <button class="btn btn-success" onclick="openMaterialProfileLink('${m.id}')">–ü—Ä–æ—Ñ–∏–ª—å<\/button>
          <button class="btn btn-info" onclick="downloadMaterialLabelHtml('${m.id}')">–≠—Ç–∏–∫–µ—Ç–∫–∞<\/button>
          <button class="btn btn-warning" onclick="copyElement('globalMaterials', '${m.id}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeleteGlobalMaterial('${m.id}')">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
            tb.appendChild(tr);
        });
    }
    let currentMaterialEditId = null;
    function onAddGlobalMaterial(){
        currentMaterialEditId = null;
        document.getElementById('matNameInput').value = '';
        document.getElementById('matMaterialTypeInput').value = '';
        document.getElementById('matCostInput').value = '0';
        document.getElementById('matBalanceInput').value = '0';
        document.getElementById('matDeclaredInput').value = '0';
        document.getElementById('matColorInput').value = '#ffffff';
        document.getElementById('matPrepTimeInput').value = '0';
        document.getElementById('matManufInput').value = '';
        document.getElementById('matProdDateInput').value = '';
        populatePrintersSelect(document.getElementById('matPrintersSelect'), []);
        new bootstrap.Modal(document.getElementById('materialModal')).show();
    }
    function onEditGlobalMaterial(id){
        const m = appData.materials.find(x => String(x.id) === String(id));
        if(!m) return;
        currentMaterialEditId = id;
        document.getElementById('matNameInput').value = m.name;
        document.getElementById('matMaterialTypeInput').value = m.materialType;
        document.getElementById('matCostInput').value = m.costPerKg;
        document.getElementById('matBalanceInput').value = m.balance;
        document.getElementById('matDeclaredInput').value = m.declaredWeight;
        document.getElementById('matCoolingTimeInput').value = m.coolingTime || 0;
        document.getElementById('matPrepTimeInput').value = m.printerPrepMinutes || 0;
        document.getElementById('matColorInput').value = m.color || '#ffffff';
        document.getElementById('matManufInput').value = m.manufacturer || '';
        document.getElementById('matProdDateInput').value = m.productionDate || '';
        populatePrintersSelect(document.getElementById('matPrintersSelect'), m.printers||[]);
        new bootstrap.Modal(document.getElementById('materialModal')).show();
    }
    function saveMaterialFromModal(){
        const isNew = currentMaterialEditId === null;
        let m = isNew ? {id: getNextId('materials'), profileIds: [], printers: []} : appData.materials.find(x=>x.id==currentMaterialEditId);
        if(!m) return;
        m.name = document.getElementById('matNameInput').value;
        m.materialType = document.getElementById('matMaterialTypeInput').value || '';
        m.costPerKg = parseFloat(document.getElementById('matCostInput').value) || 0;
        m.balance = parseFloat(document.getElementById('matBalanceInput').value) || 0;
        m.declaredWeight = parseFloat(document.getElementById('matDeclaredInput').value) || 0;
        m.coolingTime = parseFloat(document.getElementById('matCoolingTimeInput').value) || 0;
        m.printerPrepMinutes = parseFloat(document.getElementById('matPrepTimeInput').value) || 0;
        m.color = document.getElementById('matColorInput').value;
        m.manufacturer = document.getElementById('matManufInput').value;
        m.productionDate = document.getElementById('matProdDateInput').value;
        m.printers = Array.from(document.getElementById('matPrintersSelect').selectedOptions).map(o=>o.value);
        if(isNew) appData.materials.push(m);
        saveToLocalStorage();
        renderGlobalMaterialsTable();
        renderSummary();
        bootstrap.Modal.getInstance(document.getElementById('materialModal')).hide();
    }
    function onDeleteGlobalMaterial(id){
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª?")) return;
        appData.materials = appData.materials.filter(x => String(x.id) !== String(id));
        saveToLocalStorage();
        renderGlobalMaterialsTable();
        renderSummary();
    }

    /* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥–æ–≤ */
    function renderGlobalAdditionalTable(){
        const tb = document.querySelector("#additionalGlobalTable tbody");
        tb.innerHTML = "";
        appData.additionalGlobal.forEach(a => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td><input type="checkbox" id="chk_globalAdditional_${a.id}" class="globalAdditional_chk"><\/td>
      <td>${a.description}<\/td>
      <td>${a.cost}<\/td>
      <td>${a.hoursToRecoup || 1000}<\/td>
      <td>${a.useInCalc ? "–î–∞" : "–ù–µ—Ç"}<\/td>
      <td>${(a.printers && a.printers.length)? a.printers.map(printerNameById).join(', '): '–í—Å–µ'}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditGlobalAdditional('${a.id}')">–†–µ–¥.<\/button>
          <button class="btn btn-warning" onclick="copyElement('globalAdditional', '${a.id}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeleteGlobalAdditional('${a.id}')">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
            tb.appendChild(tr);
        });
    }
    function onAddGlobalAdditional(){
        const nid = getNextId('additionalGlobal');
        appData.additionalGlobal.push({
            id: nid,
            description: "–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è",
            cost: 0,
            hoursToRecoup: 1000,
            useInCalc: true,
            printers: []
        });
        saveToLocalStorage();
        renderGlobalAdditionalTable();
        renderSummary();
    }
    async function onEditGlobalAdditional(id){
        const x = appData.additionalGlobal.find(a => String(a.id) === String(id));
        if(!x) return;
        const vals = await showMultiPrompt('–†–∞—Å—Ö–æ–¥',[
            {id:'desc',label:'–û–ø–∏—Å–∞–Ω–∏–µ',value:x.description},
            {id:'cost',label:'–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)',type:'number',value:x.cost},
            {id:'hours',label:'–ß–∞—Å—ã –æ–∫—É–ø.',type:'number',value:x.hoursToRecoup||1000},
            {id:'use',label:'–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç',type:'checkbox',value:x.useInCalc},
            {id:'printers',label:'–ü—Ä–∏–Ω—Ç–µ—Ä—ã',type:'multiselect',options:appData.printers.map(p=>({value:String(p.id),label:p.name})),value:x.printers||[]}
        ]);
        if(!vals) return;
        x.description = vals.desc;
        x.cost = parseFloat(vals.cost)||0;
        x.hoursToRecoup = parseFloat(vals.hours)||1000;
        x.useInCalc = vals.use;
        x.printers = vals.printers || [];
        saveToLocalStorage();
        renderGlobalAdditionalTable();
        renderSummary();
    }
    function onDeleteGlobalAdditional(id){
        if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é?")) return;
        appData.additionalGlobal = appData.additionalGlobal.filter(a => String(a.id) !== String(id));
        saveToLocalStorage();
        renderGlobalAdditionalTable();
        renderSummary();
    }

    /* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥ */
    function renderCustomServicesTable(){
        const tb = document.querySelector('#customServicesTable tbody');
        if(!tb) return;
        tb.innerHTML='';
        (appData.calcSettings.customServices||[]).forEach(s=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`
      <td><input type="checkbox" ${s.use?'checked':''} onchange="updateService('${s.id}','use',this.checked)"></td>
      <td><input type="text" class="form-control form-control-sm" value="${s.name}" onchange="updateService('${s.id}','name',this.value)"></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${s.cost}" onchange="updateService('${s.id}','cost',this.value)"></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${s.qty}" onchange="updateService('${s.id}','qty',this.value)"></td>
      <td>
        <select class="form-select form-select-sm" onchange="updateService('${s.id}','mode',this.value)">
          <option value="per_unit" ${s.mode==='per_unit'?'selected':''}>–∑–∞ –µ–¥–∏–Ω–∏—Ü—É</option>
          <option value="per_service" ${s.mode==='per_service'?'selected':''}>–∑–∞ —É—Å–ª—É–≥—É</option>
          <option value="per_hour" ${s.mode==='per_hour'?'selected':''}>–∑–∞ —á–∞—Å</option>
        </select>
      </td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteCustomService('${s.id}')">–£–¥–∞–ª–∏—Ç—å</button></td>
    `;
            tb.appendChild(tr);
        });
    }

    function addCustomService(){
        if(!Array.isArray(appData.calcSettings.customServices)) appData.calcSettings.customServices=[];
        appData.calcSettings.customServices.push({id:getNextId('services'),name:'',cost:0,qty:1,mode:'per_service',use:true});
        saveToLocalStorage();
        renderCustomServicesTable();
    }

    function deleteCustomService(id){
        appData.calcSettings.customServices=(appData.calcSettings.customServices||[]).filter(s=>String(s.id)!==String(id));
        saveToLocalStorage();
        renderCustomServicesTable();
    }

    function updateService(id,field,value){
        const s=(appData.calcSettings.customServices||[]).find(x=>String(x.id)===String(id));
        if(!s) return;
        if(field==='cost'||field==='qty') s[field]=parseFloat(value)||0;
        else if(field==='use') s[field]=value;
        else s[field]=value;
        saveToLocalStorage();
    }

    /* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ */
    function renderClientsTable(){
        const tb = document.querySelector("#clientsTable tbody");
        if(!tb) return;
        tb.innerHTML="";
        appData.clients.forEach(c=>{
            const tr=document.createElement("tr");
            tr.innerHTML=`
      <td>${c.name}</td>
      <td>${c.phone||""}</td>
      <td>${c.links||""}</td>
      <td><div class="btn-group-sm">
        <button class="btn btn-secondary" onclick="onEditClient('${c.id}')">–†–µ–¥.</button>
        <button class="btn btn-danger" onclick="onDeleteClient('${c.id}')">–£–¥–ª.</button>
      </div></td>`;
            tb.appendChild(tr);
        });
        renderClientOptions();
    }

    function renderClientOptions(filterText) {
        const menu = document.getElementById('calcClientDropdownMenu');
        if (!menu) return;
        const input = document.getElementById('calcClientName');
        const term = typeof filterText === 'string' ? filterText : (input ? input.value : '');
        const search = (term || '').toLowerCase();
        const list = appData.clients.filter(c => {
            if (!search) return true;
            const haystack = `${c.name || ''} ${(c.phone || '')} ${(c.links || '')}`.toLowerCase();
            return haystack.includes(search);
        });
        if (!list.length) {
            menu.innerHTML = `<div class="dropdown-item text-muted small">–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π. –ù–∞–∂–º–∏—Ç–µ Enter, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞.</div>`;
            return;
        }
        menu.innerHTML = list.map(c => {
            const safeName = escapeHtml(c.name || '');
            const safePhone = escapeHtml(c.phone || '');
            const phone = c.phone ? `<span class="text-muted small ms-2">${safePhone}</span>` : '';
            return `<button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="onCalcClientSelect('${c.id}')">
        <span>${safeName}</span>
        ${phone}
      </button>`;
        }).join('');
    }

    function getClientById(clientId) {
        if (!clientId && clientId !== 0) return null;
        return appData.clients.find(c => String(c.id) === String(clientId)) || null;
    }

    function findClientByName(name) {
        if (!name) return null;
        const lower = name.trim().toLowerCase();
        return appData.clients.find(c => (c.name || '').trim().toLowerCase() === lower) || null;
    }

    function escapeHtml(str) {
        return (str || '').replace(/[&<>"']/g, ch => {
            switch (ch) {
                case '&':
                    return '&amp;';
                case '<':
                    return '&lt;';
                case '>':
                    return '&gt;';
                case '"':
                    return '&quot;';
                case "'":
                    return '&#39;';
                default:
                    return ch;
            }
        });
    }

    function getClientDropdownElements() {
        return {
            wrapper: document.getElementById('calcClientDropdownWrapper'),
            menu: document.getElementById('calcClientDropdownMenu')
        };
    }

    function showClientDropdown() {
        const {wrapper, menu} = getClientDropdownElements();
        if (!wrapper || !menu) return;
        menu.classList.add('show');
        wrapper.classList.add('show');
        clientDropdownVisible = true;
    }

    function hideClientDropdown() {
        const {wrapper, menu} = getClientDropdownElements();
        if (!wrapper || !menu) return;
        menu.classList.remove('show');
        wrapper.classList.remove('show');
        clientDropdownVisible = false;
    }

    document.addEventListener('click', event => {
        if (!clientDropdownVisible) return;
        const {wrapper} = getClientDropdownElements();
        if (!wrapper) return;
        if (wrapper.contains(event.target)) return;
        hideClientDropdown();
    });

    function onClientFieldFocus() {
        renderClientOptions();
        showClientDropdown();
    }

    async function onClientFieldKeydown(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const value = event.target.value.trim();
            if (!value) {
                onCalcClientSelect('');
                hideClientDropdown();
                return;
            }
            const existing = findClientByName(value);
            if (existing) {
                onCalcClientSelect(existing.id);
                hideClientDropdown();
            } else {
                const created = await openClientModalAndSave({name: value});
                if (created) onCalcClientSelect(created.id);
            }
        } else if (event.key === 'Escape') {
            hideClientDropdown();
        } else if (event.key === 'Tab') {
            hideClientDropdown();
        }
    }

    async function promptClientData(defaults = {}) {
        return await showMultiPrompt('–ö–ª–∏–µ–Ω—Ç', [
            {id: 'name', label: '–ò–º—è', value: defaults.name || ''},
            {id: 'phone', label: '–¢–µ–ª–µ—Ñ–æ–Ω', value: defaults.phone || ''},
            {id: 'links', label: '–°—Å—ã–ª–∫–∏', value: defaults.links || ''}
        ]);
    }

    async function openClientModalAndSave(defaults = {}) {
        const vals = await promptClientData(defaults);
        if (!vals) return null;
        const normalizedName = (vals.name || '').trim();
        if (!normalizedName) return null;
        let client = null;
        if (defaults.id) {
            client = getClientById(defaults.id);
        }
        if (!client) {
            client = findClientByName(normalizedName);
        }
        if (!client) {
            client = {id: getNextId('clients')};
            appData.clients.push(client);
        }
        client.name = normalizedName;
        client.phone = (vals.phone || '').trim();
        client.links = (vals.links || '').trim();
        saveToLocalStorage();
        renderClientsTable();
        return client;
    }

    async function onAddClient() {
        await openClientModalAndSave();
    }

    async function onEditClient(id){
        const c=appData.clients.find(x=>x.id==id);
        if(!c) return;
        await openClientModalAndSave({id: c.id, name: c.name, phone: c.phone || '', links: c.links || ''});
    }

    function onDeleteClient(id){
        if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?')) return;
        appData.clients=appData.clients.filter(c=>c.id!=id);
        saveToLocalStorage();
        renderClientsTable();
    }

    function applyClientSelection(clientId, fallbackName = '') {
        const input = document.getElementById('calcClientName');
        let client = null;
        if (clientId) {
            client = getClientById(clientId);
        }
        if (!client && fallbackName) {
            client = findClientByName(fallbackName);
        }
        currentCalcClientId = client ? client.id : '';
        if (input) {
            input.value = client ? client.name : (fallbackName || '');
        }
        renderClientOptions(input ? input.value : '');
    }

    function resetCalcClientSelector() {
        currentCalcClientId = '';
        const input = document.getElementById('calcClientName');
        if (input) input.value = '';
        renderClientOptions('');
        hideClientDropdown();
    }

    function onCalcClientSelect(clientId) {
        applyClientSelection(clientId || '');
        hideClientDropdown();
    }

    function onCalcClientInput() {
        const input = document.getElementById('calcClientName');
        if (!input) return;
        const value = input.value.trim();
        const client = findClientByName(value);
        currentCalcClientId = client ? client.id : '';
        renderClientOptions(value);
        showClientDropdown();
    }

    const ORDER_STATUS_LABELS = {
        new: '–ù–æ–≤—ã–π',
        inprogress: '–í —Ä–∞–±–æ—Ç–µ',
        done: '–ó–∞–≤–µ—Ä—à—ë–Ω',
        paid: '–û–ø–ª–∞—á–µ–Ω',
        canceled: '–û—Ç–º–µ–Ω—ë–Ω'
    };

    const MODEL_STATUS_LABELS = {
        new: '–ù–æ–≤–∞—è',
        inprogress: '–ü–µ—á–∞—Ç—å',
        done: '–ì–æ—Ç–æ–≤–∞',
        reject: '–ë—Ä–∞–∫',
        canceled: '–û—Ç–º–µ–Ω–µ–Ω–∞'
    };

    const getOrderStatusLabel = (status) => ORDER_STATUS_LABELS[status] || status || '‚Äî';
    const getModelStatusLabel = (status) => MODEL_STATUS_LABELS[status] || status || '‚Äî';
    const getModelQualityLabel = (status) => status === 'reject' ? '–ë—Ä–∞–∫' : '';

    const TIMELINE_STAGE_LABELS = {
        prep: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞',
        print: '–ü–µ—á–∞—Ç—å',
        cool: '–û—Å—Ç—ã–≤–∞–Ω–∏–µ'
    };
    const TIMELINE_ACTIONS = {
        prep: '–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä –∏ –º–∞—Ç–µ—Ä–∏–∞–ª',
        print: '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–µ—á–∞—Ç—å –∏ –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –≤—ã–≥—Ä—É–∑–∫–µ',
        cool: '–°–Ω—è—Ç—å –º–æ–¥–µ–ª—å, –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Å—Ç–æ–ª'
    };
    const minutesToDuration = (minutes) => {
        const hrs = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        if (hrs > 0 && mins > 0) return `${hrs} —á ${mins} –º–∏–Ω`;
        if (hrs > 0) return `${hrs} —á`;
        return `${mins} –º–∏–Ω`;
    };
    const minutesToTimeString = (minutes) => {
        if (Number.isNaN(minutes)) return '';
        const normalized = ((minutes % (24 * 60)) + (24 * 60)) % (24 * 60);
        const hrs = Math.floor(normalized / 60);
        const mins = Math.round(normalized % 60);
        return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    };
    const timeStringToMinutes = (value) => {
        if (!value || !value.includes(":")) return NaN;
        const [hours, minutes] = value.split(":").map(Number);
        if (Number.isNaN(hours) || Number.isNaN(minutes)) return NaN;
        return hours * 60 + minutes;
    };
    const formatTimelineTime = (date) => date.toLocaleString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit',
        day: '2-digit',
        month: '2-digit'
    });
    const formatTimeOnly = (date) => date.toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });
    const normalizeScheduleMap = (schedule) => {
        const map = {};
        WEEKDAY_LABELS.forEach(day => {
            const periods = schedule && Array.isArray(schedule[day.value]) ? schedule[day.value] : [];
            map[day.value] = periods
                .map(period => {
                    const startMin = timeStringToMinutes(period.start);
                    const endMin = timeStringToMinutes(period.end);
                    if (Number.isNaN(startMin) || Number.isNaN(endMin) || startMin >= endMin) return null;
                    return {
                        start: period.start,
                        end: period.end,
                        startMinutes: startMin,
                        endMinutes: endMin,
                        startLabel: period.start || minutesToTimeString(startMin),
                        endLabel: period.end || minutesToTimeString(endMin)
                    };
                })
                .filter(Boolean)
                .sort((a, b) => a.startMinutes - b.startMinutes);
        });
        return map;
    };
    const getWorkingDaysSet = (scheduleMap) => {
        const set = new Set();
        WEEKDAY_LABELS.forEach(day => {
            const periods = scheduleMap && Array.isArray(scheduleMap[day.value]) ? scheduleMap[day.value] : [];
            if (periods.length) {
                set.add(day.value);
            }
        });
        if (!set.size) {
            DEFAULT_WORKING_DAYS.forEach(day => set.add(day));
        }
        return set;
    };
    const hasScheduleWindows = (scheduleMap) => {
        return Object.values(scheduleMap || {}).some(periods =>
            Array.isArray(periods) && periods.length > 0
        );
    };
    const getScheduleWindowsForWeekday = (weekday, scheduleMap) => {
        if (!scheduleMap) return [];
        const windows = scheduleMap[weekday];
        return Array.isArray(windows) ? windows : [];
    };
    const isWorkingDay = (date, workingDaysSet) => workingDaysSet.has(date.getDay());
    const getNextWorkingWindow = (cursor, scheduleMap, workingDaysSet) => {
        const hasSchedule = hasScheduleWindows(scheduleMap);
        if (!hasSchedule) {
            const start = new Date(cursor);
            return {start, end: new Date(start.getTime() + 24 * 60 * 60000)};
        }
        const workingDays = (workingDaysSet && workingDaysSet.size) ? workingDaysSet : getWorkingDaysSet(scheduleMap);
        if (!workingDays.size) {
            const start = new Date(cursor);
            return {start, end: new Date(start.getTime() + 24 * 60 * 60000)};
        }
        let probe = new Date(cursor);
        while (true) {
            const dayStart = new Date(probe);
            dayStart.setHours(0, 0, 0, 0);
            if (!isWorkingDay(dayStart, workingDays)) {
                probe = new Date(dayStart.getTime() + 24 * 60 * 60000);
                continue;
            }
            const weekday = dayStart.getDay();
            const windows = getScheduleWindowsForWeekday(weekday, scheduleMap);
            if (!windows.length) {
                probe = new Date(dayStart.getTime() + 24 * 60 * 60000);
                continue;
            }
            for (const window of windows) {
                const windowStart = new Date(dayStart.getTime() + window.startMinutes * 60000);
                const windowEnd = new Date(dayStart.getTime() + window.endMinutes * 60000);
                if (probe <= windowEnd) {
                    const slotStart = probe < windowStart ? windowStart : probe;
                    if (slotStart < windowEnd) {
                        return {start: slotStart, end: windowEnd};
                    }
                }
            }
            probe = new Date(dayStart.getTime() + 24 * 60 * 60000);
        }
    };
    const DAY_MS = 24 * 60 * 60000;
    const getDayStart = (value) => {
        const date = new Date(value);
        date.setHours(0, 0, 0, 0);
        return date;
    };
    const getDayEnd = (value) => {
        const start = getDayStart(value);
        return new Date(start.getTime() + DAY_MS);
    };
    const alignToWorkingMoment = (cursor, scheduleMap, workingDaysSet) => {
        const hasSchedule = hasScheduleWindows(scheduleMap);
        if (!hasSchedule) {
            const point = new Date(cursor);
            const dayStart = getDayStart(point);
            const dayEnd = getDayEnd(point);
            if (point >= dayEnd) {
                const next = dayEnd;
                return {instant: next, dayStart: getDayStart(next)};
            }
            return {instant: point, dayStart};
        }
        let probe = new Date(cursor);
        const workingDays = (workingDaysSet && workingDaysSet.size) ? workingDaysSet : getWorkingDaysSet(scheduleMap);
        for (let guard = 0; guard < 14; guard++) {
            const dayStart = getDayStart(probe);
            const weekday = dayStart.getDay();
            if (!isWorkingDay(dayStart, workingDays)) {
                probe = new Date(dayStart.getTime() + DAY_MS);
                continue;
            }
            const windows = getScheduleWindowsForWeekday(weekday, scheduleMap);
            if (!windows.length) {
                probe = new Date(dayStart.getTime() + DAY_MS);
                continue;
            }
            for (const window of windows) {
                const winStart = new Date(dayStart.getTime() + window.startMinutes * 60000);
                const winEnd = new Date(dayStart.getTime() + window.endMinutes * 60000);
                if (probe > winEnd) continue;
                const instant = probe < winStart ? winStart : probe;
                if (instant < winEnd) {
                    return {instant, dayStart};
                }
            }
            probe = new Date(dayStart.getTime() + DAY_MS);
        }
        return null;
    };
    const scheduleOperatorStage = (cursor, minutes, scheduleMap, workingDaysSet) => {
        const hasSchedule = hasScheduleWindows(scheduleMap);
        let attempt = new Date(cursor);
        let guard = 0;
        while (guard < 40) {
            if (!hasSchedule) {
                const dayStart = getDayStart(attempt);
                const dayEnd = getDayEnd(attempt);
                if (attempt >= dayEnd) {
                    attempt = dayEnd;
                    guard++;
                    continue;
                }
                if (minutes === 0) {
                    return {intervals: [], start: new Date(attempt), end: new Date(attempt), dayStart};
                }
                const end = new Date(attempt.getTime() + minutes * 60000);
                if (end > dayEnd) {
                    attempt = dayEnd;
                    guard++;
                    continue;
                }
                return {
                    intervals: [{start: new Date(attempt), end}],
                    start: new Date(attempt),
                    end,
                    dayStart
                };
            }
            const aligned = alignToWorkingMoment(attempt, scheduleMap, workingDaysSet);
            if (!aligned) return null;
            const {instant, dayStart} = aligned;
            const dayEnd = getDayEnd(dayStart);
            const windows = getScheduleWindowsForWeekday(dayStart.getDay(), scheduleMap);
            if (minutes === 0) {
                return {intervals: [], start: instant, end: instant, dayStart};
            }
            const intervals = [];
            let remaining = minutes;
            let cursorPoint = new Date(instant);
            for (const window of windows) {
                const winStart = new Date(dayStart.getTime() + window.startMinutes * 60000);
                const winEnd = new Date(dayStart.getTime() + window.endMinutes * 60000);
                if (winEnd <= cursorPoint) continue;
                const slotStart = cursorPoint > winStart ? cursorPoint : winStart;
                if (slotStart >= winEnd) continue;
                const available = (winEnd - slotStart) / 60000;
                const used = Math.min(remaining, available);
                const segEnd = new Date(slotStart.getTime() + used * 60000);
                intervals.push({start: slotStart, end: segEnd});
                remaining -= used;
                cursorPoint = new Date(segEnd.getTime());
                if (remaining <= 0) break;
            }
            if (remaining <= 0) {
                return {
                    intervals,
                    start: intervals[0].start,
                    end: intervals[intervals.length - 1].end,
                    dayStart
                };
            }
            attempt = dayEnd;
            guard++;
        }
        return null;
    };
    const schedulePrintJob = (printerCursor, operatorCursor, prepMinutes, printMinutes, scheduleMap, workingDaysSet) => {
        let guard = 0;
        let attempt = new Date(Math.max(printerCursor.getTime(), operatorCursor.getTime()));
        while (guard < 60) {
            const prepBlock = scheduleOperatorStage(attempt, prepMinutes, scheduleMap, workingDaysSet);
            if (!prepBlock) return null;
            const dayStart = prepBlock.dayStart;
            const dayEnd = getDayEnd(dayStart);
            const earliestPrintStart = prepBlock.end;
            const readyTime = Math.max(earliestPrintStart.getTime(), printerCursor.getTime());
            if (readyTime >= dayEnd.getTime()) {
                attempt = new Date(Math.max(dayEnd.getTime(), printerCursor.getTime(), operatorCursor.getTime()));
                guard++;
                continue;
            }
            const printEnd = new Date(readyTime + printMinutes * 60000);
            if (printEnd > dayEnd) {
                attempt = new Date(Math.max(dayEnd.getTime(), printerCursor.getTime(), operatorCursor.getTime()));
                guard++;
                continue;
            }
            return {
                prepBlock,
                printStart: new Date(readyTime),
                printEnd,
                dayStart
            };
        }
        return null;
    };
    const buildScheduleSummary = (scheduleMap, breaksMap = {}) => {
        if (!hasScheduleWindows(scheduleMap)) return [];
        const summary = [];
        WEEKDAY_LABELS.forEach(day => {
            const windows = getScheduleWindowsForWeekday(day.value, scheduleMap);
            const breaks = Array.isArray(breaksMap[day.value]) ? breaksMap[day.value] : [];
            if (!windows.length && !breaks.length) return;
            const workLabel = windows.length
                ? windows.map(window => `${window.startLabel} ‚Äî ${window.endLabel}`).join(', ')
                : '';
            const breakLabel = breaks.length
                ? breaks.map(br => `${br.startLabel} ‚Äî ${br.endLabel}`).join(', ')
                : '';
            summary.push({
                dayLabel: day.label,
                weekdayValue: day.value,
                windowLabel: workLabel,
                breaksLabel: breakLabel,
                breaksRaw: breaks
            });
        });
        return summary;
    };
    const computeBreaksMap = (scheduleMap) => {
        const breaksMap = {};
        WEEKDAY_LABELS.forEach(day => {
            const periods = Array.isArray(scheduleMap[day.value]) ? scheduleMap[day.value] : [];
            const sorted = periods.slice().sort((a, b) => a.startMinutes - b.startMinutes);
            const dayBreaks = [];
            for (let i = 0; i < sorted.length - 1; i++) {
                const gapStart = sorted[i].endMinutes;
                const gapEnd = sorted[i + 1].startMinutes;
                if (gapEnd > gapStart) {
                    dayBreaks.push({
                        startMinutes: gapStart,
                        endMinutes: gapEnd,
                        duration: gapEnd - gapStart,
                        startLabel: minutesToTimeString(gapStart),
                        endLabel: minutesToTimeString(gapEnd)
                    });
                }
            }
            breaksMap[day.value] = dayBreaks;
        });
        return breaksMap;
    };
    const buildTimelineEvents = (printers, startDateStr, scheduleMap, breaksMap = {}) => {
        if (!Array.isArray(printers) || printers.length === 0) {
            return {events: [], scheduleSummary: []};
        }
        let base = startDateStr ? new Date(startDateStr) : new Date();
        if (Number.isNaN(base.getTime())) {
            base = new Date();
        }
        const workingDaysSet = getWorkingDaysSet(scheduleMap);
        const scheduleSummary = buildScheduleSummary(scheduleMap, breaksMap);
        const events = [];
        printers.forEach(pr => {
            let cursor = new Date(base.getTime());
            let operatorCursor = new Date(cursor.getTime());
            (pr.linesDetail || []).filter(ln => !ln.excludedFromTotals).forEach(line => {
                const prepMinutes = Math.max(0, line.printerPrepMinutes || 0);
                const printMinutes = Math.max(0, (line.hours || 0) * 60);
                const coolingMinutes = Math.max(0, line.coolingMinutes || 0);
                if (prepMinutes === 0 && printMinutes === 0 && coolingMinutes === 0) return;
                const jobSchedule = schedulePrintJob(cursor, operatorCursor, prepMinutes, printMinutes, scheduleMap, workingDaysSet);
                if (!jobSchedule) return;
                const {prepBlock, printStart, printEnd} = jobSchedule;
                if (prepMinutes > 0 && prepBlock && Array.isArray(prepBlock.intervals) && prepBlock.intervals.length) {
                    events.push({
                        printer: pr.printerName,
                        modelName: line.displayName || line.name,
                        modelId: line.id,
                        thumbnail: line.thumbnail || '',
                        type: 'prep',
                        status: line.status,
                        intervals: prepBlock.intervals.map(interval => ({start: new Date(interval.start), end: new Date(interval.end)})),
                        duration: prepMinutes,
                        start: prepBlock.intervals[0].start,
                        end: prepBlock.intervals[prepBlock.intervals.length - 1].end
                    });
                }
                if (printMinutes > 0) {
                    events.push({
                        printer: pr.printerName,
                        modelName: line.displayName || line.name,
                        modelId: line.id,
                        thumbnail: line.thumbnail || '',
                        type: 'print',
                        status: line.status,
                        intervals: [{start: printStart, end: printEnd}],
                        duration: printMinutes,
                        start: printStart,
                        end: printEnd
                    });
                }
                operatorCursor = prepBlock ? new Date(Math.max(operatorCursor.getTime(), prepBlock.end.getTime())) : operatorCursor;
                cursor = new Date(printEnd.getTime());
                if (coolingMinutes > 0) {
                    const coolEvent = {
                        printer: pr.printerName,
                        modelName: line.displayName || line.name,
                        modelId: line.id,
                        thumbnail: line.thumbnail || '',
                        type: 'cool',
                        status: line.status,
                        intervals: [],
                        duration: 0,
                        start: null,
                        end: null
                    };
                    let remaining = coolingMinutes;
                    let coolCursor = new Date(printEnd.getTime());
                    while (remaining > 0) {
                        const chunk = Math.min(remaining, 60);
                        const segStart = new Date(coolCursor.getTime());
                        const segEnd = new Date(segStart.getTime() + chunk * 60000);
                        coolEvent.intervals.push({start: segStart, end: segEnd});
                        coolEvent.duration += chunk;
                        remaining -= chunk;
                        coolCursor = new Date(segEnd.getTime());
                    }
                    if (coolEvent.intervals.length) {
                        coolEvent.start = coolEvent.intervals[0].start;
                        coolEvent.end = coolEvent.intervals[coolEvent.intervals.length - 1].end;
                        events.push(coolEvent);
                        cursor = new Date(coolEvent.end.getTime());
                    }
                }
            });
        });
        events.sort((a, b) => a.start - b.start);
        return {
            events,
            scheduleSummary
        };
    };

    /* –§—É–Ω–∫—Ü–∏–∏ –∫–∞–ª—å–∫—É–ª—è—Ü–∏–∏ */
    function renderCalcPrinters(){
        const c = document.getElementById("calcPrintersContainer");
        c.innerHTML = "";
        appData.printers.forEach(pr => {
            const block = document.createElement("div");

            block.className = "border p-3 mb-3";
            block.innerHTML = `
      <h5>–ü—Ä–∏–Ω—Ç–µ—Ä: ${pr.name} (ID: ${pr.id})<\/h5>
      <div class="small-text mb-2">
        –ú–æ—â–Ω–æ—Å—Ç—å: ${pr.power}–í—Ç, –û–±—Å–ª: ${pr.maintCostHour}‚ÇΩ/—á, –ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏: ${pr.hoursToRecoup}.
      <\/div>
      <table class="table table-bordered table-sm mb-2" id="calcModelsTable_${pr.id}">
        <thead>
          <tr>
            <th>–ò–º—è –º–æ–¥–µ–ª–∏<\/th>
            <th>–ò–∫–æ–Ω–∫–∞<\/th>
            <th>–°—Ç–∞—Ç—É—Å<\/th>
            <th>–ß–∞—Å—ã –ø–µ—á–∞—Ç–∏<\/th>
            <th>–í–µ—Å (–≥)<\/th>
            <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
            <th>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/th>
            <th>–î–µ–π—Å—Ç–≤–∏—è<\/th>
          <\/tr>
        <\/thead>
        <tbody><\/tbody>
      <\/table>
      <button class="btn btn-sm btn-primary" onclick="addModelRow(${pr.id}, {})">–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å<\/button>
    `;
            c.appendChild(block);
        });
    }

    // --- Model ID hygiene -------------------------------------------------
    // –í —Ä–∞—Å—á—ë—Ç–µ –º–æ–¥–µ–ª—å–Ω—ã–π id –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö (—Ç–∞–π–º–ª–∞–π–Ω, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏, —ç—Ç–∏–∫–µ—Ç–∫–∏ –∏ —Ç.–¥.).
    // –ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –ø–æ—è–≤–ª—è—é—Ç—Å—è –¥—É–±–ª–∏ (—á–∞—Å—Ç–æ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –ø–∞—á–∫–∏ G-code —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∫–æ–¥–æ–º),
    // —Ç–æ –ª–æ–º–∞—é—Ç—Å—è DOM-id (thumb_*), –∞ —Ç–∞–∫–∂–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö.
    // –ü–æ—ç—Ç–æ–º—É: (1) –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏ —Å—Ç–∞—Ä–∞–µ–º—Å—è –Ω–µ –¥–æ–ø—É—Å–∫–∞—Ç—å –¥—É–±–ª–µ–π; (2) –ø–µ—Ä–µ–¥ —Ä–∞—Å—á—ë—Ç–æ–º
    // –¥–µ–ª–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –∏ ¬´–ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º¬ª id, –µ—Å–ª–∏ –Ω–∞—à–ª–∏ –∫–æ–ª–ª–∏–∑–∏—é.

    function __cssEscape(val){
        try { return (window.CSS && typeof window.CSS.escape === 'function') ? window.CSS.escape(String(val)) : String(val).replace(/[^a-zA-Z0-9_\-]/g, '\\$&'); }
        catch(e){ return String(val).replace(/[^a-zA-Z0-9_\-]/g, '\\$&'); }
    }

    function ensureUniqueModelId(desiredId, excludeRow){
        const id = String(desiredId);
        const sel = `[data-model-id="${__cssEscape(id)}"]`;
        const existing = document.querySelectorAll(sel);
        if (!existing || existing.length === 0) return id;
        if (excludeRow && existing.length === 1 && existing[0] === excludeRow) return id;
        // –∫–æ–ª–ª–∏–∑–∏—è -> –≤—ã–¥–∞—ë–º –Ω–æ–≤—ã–π id –∏–∑ models
        return String(getNextId('models'));
    }

    function __updateRowModelIdArtifacts(row, oldId, newId){
        if(!row || String(oldId) === String(newId)) return;
        row.dataset.modelId = String(newId);

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å (–≤ –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–µ small: (id))
        try {
            const small = row.querySelector('td small');
            if(small) small.textContent = `(${newId})`;
        } catch(e) {}

        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã –∏ file input id/handlers –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏
        const thumb = row.querySelector(`#thumb_${__cssEscape(oldId)}`);
        if(thumb){
            thumb.id = `thumb_${newId}`;
            thumb.setAttribute('onclick', `document.getElementById('thumbFile_${newId}').click()`);
        }
        const file = row.querySelector(`#thumbFile_${__cssEscape(oldId)}`);
        if(file){
            file.id = `thumbFile_${newId}`;
            file.setAttribute('onchange', `onModelThumbnailChange(event, '${newId}')`);
        }
    }

    function normalizeCalcModelIds(){
        const seen = new Set();
        appData.printers.forEach(pr => {
            const table = document.getElementById(`calcModelsTable_${pr.id}`);
            if(!table) return;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const raw = row.dataset.modelId;
                let id = (raw !== undefined && raw !== null && String(raw).trim() !== '') ? String(raw) : String(getNextId('models'));
                if(seen.has(id)){
                    const oldId = id;
                    id = String(getNextId('models'));
                    __updateRowModelIdArtifacts(row, oldId, id);
                } else {
                    // —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–∏–∑–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ DOM (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                    const unique = ensureUniqueModelId(id, row);
                    if(unique !== id){
                        const oldId = id;
                        id = unique;
                        __updateRowModelIdArtifacts(row, oldId, id);
                    }
                }
                seen.add(id);
            });
        });
    }

    function renderCalcUrgencySelect(){
        const select = document.getElementById('calcUrgencyProfile');
        const summary = document.getElementById('calcUrgencySummary');
        if (!select) return;
        const profiles = Array.isArray(appData.labelSettings.urgencyProfiles) ? appData.labelSettings.urgencyProfiles : [];
        select.innerHTML = '';
        profiles.forEach(profile => {
            const option = document.createElement('option');
            option.value = profile.id;
            const markupText = profile.markupPercent ? ` (+${profile.markupPercent}% )` : '';
            option.textContent = `${profile.title}${markupText}`;
            select.appendChild(option);
        });
        let currentId = appData.calcSettings.currentUrgencyId;
        if (!profiles.some(p => String(p.id) === String(currentId)) && profiles.length) {
            currentId = profiles[0].id;
        }
        if (profiles.length && !currentId) {
            currentId = profiles[0].id;
        }
        if (currentId) {
            select.value = currentId;
            appData.calcSettings.currentUrgencyId = currentId;
        }
        const updateSummary = () => {
            const profile = profiles.find(p => String(p.id) === String(select.value));
            let text = '';
            if (profile) {
                const markupText = profile.markupPercent ? ` +${profile.markupPercent}% –∫ —Ü–µ–Ω–µ` : ' –±–µ–∑ –¥–æ–ø.–Ω–∞—Ü–µ–Ω–∫–∏';
                const desc = profile.description ? ` ‚Äî ${profile.description}` : '';
                const manualMarkup = appData.calcSettings.markupPercent || 0;
                const manualText = manualMarkup ? `, —Ä—É—á–Ω–∞—è +${manualMarkup}%` : '';
                text = `${profile.title}${markupText}${manualText}${desc}`;
            }
            if (summary) summary.textContent = text;
            appData.calcSettings.currentUrgencyId = select.value;
        };
        select.onchange = updateSummary;
        const markupInputEl = document.getElementById('calcMarkupPercent');
        if (markupInputEl) markupInputEl.oninput = updateSummary;
        updateSummary();
    }
    function addModelRow(printerId, modelData) {
        ensureIconsLoaded();
        const table = document.getElementById(`calcModelsTable_${printerId}`);
        if(!table) return;
        const tbody = table.querySelector("tbody");
        const idx = tbody.rows.length + 1;
        const statuses = [
            {val:"new", text:"–ù–æ–≤–∞—è"},
            {val:"inprogress", text:"–ü–µ—á–∞—Ç—å"},
            {val:"done", text:"–ì–æ—Ç–æ–≤–∞"},
            {val:"reject", text:"–ë—Ä–∞–∫"},
            {val:"canceled", text:"–û—Ç–º–µ–Ω–µ–Ω–∞"}
        ];
        const optsStatus = statuses.map(s =>
            `<option value="${s.val}" ${(modelData.status === s.val) ? "selected" : ""}>${s.text}<\/option>`
        ).join("");
        const mats = getAllMaterialsForPrinter(printerId, true);
        const optsMat = mats.map(m => {
            const spoolmanText = m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : '';
            return `<option value="${m.id}" ${(modelData.materialId == m.id) ? "selected" : ""}>
    ${m.name} (ID: ${m.id}${spoolmanText})
  </option>`;
        }).join("");
        // –í–ê–ñ–ù–û: —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ id –º–æ–¥–µ–ª–µ–π –∏ DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã –∂–∏—Ç—å –≤ –æ–¥–Ω–æ–º –Ω–µ–π–º—Å–ø–µ–π—Å–µ.
        // –†–∞–Ω—å—à–µ —Ç—É—Ç –æ—à–∏–±–æ—á–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Å—á—ë—Ç—á–∏–∫ clients, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –∫–æ–ª–ª–∏–∑–∏—è–º/–¥—É–±–ª—è–º.
        const uniqueId = getNextId('models');
        const nameId = `modelName_${printerId}_${uniqueId}`;
        const statusId = `modelStatus_${printerId}_${uniqueId}`;
        const hoursId = `modelHours_${printerId}_${uniqueId}`;
        const weightId = `modelWeight_${printerId}_${uniqueId}`;
        const materialId = `modelMaterial_${printerId}_${uniqueId}`;
        const labelId = `modelLabel_${printerId}_${uniqueId}`;
        const includeLabel = modelData.includeLabel !== false;
        const tr = document.createElement('tr');
        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å modelId (–≤–∞–∂–Ω–æ –¥–ª—è —Ç–∞–π–º–ª–∞–π–Ω–∞/—ç—Ç–∏–∫–µ—Ç–æ–∫/–º–∏–Ω–∏–∞—Ç—é—Ä).
        let code = (modelData && modelData.id !== undefined && modelData.id !== null && String(modelData.id).trim() !== '')
            ? String(modelData.id)
            : String(uniqueId);
        code = ensureUniqueModelId(code);
        tr.dataset.modelId = code;
        tr.dataset.thumbnail = modelData.thumbnail || '';
        tr.innerHTML = `
    <td><input type="text" class="form-control form-control-sm" id="${nameId}" data-role="model-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${modelData.name || ''}" /> <small>(${code})<\/small><\/td>
    <td>
      ${modelData.thumbnail ? `<img id="thumb_${code}" src="data:image/png;base64,${modelData.thumbnail}" style="height:40px;width:40px;object-fit:contain;border:1px solid #ccc;cursor:pointer" onclick="document.getElementById('thumbFile_${code}').click()"/>` : `<i id="thumb_${code}" class="bi bi-image" style="font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('thumbFile_${code}').click()"></i>`}
      <input type="file" id="thumbFile_${code}" accept="image/png" class="d-none" onchange="onModelThumbnailChange(event, '${code}')">
    <\/td>
    <td>
      <select class="form-select form-select-sm" id="${statusId}" data-role="model-status">
        ${optsStatus}
      <\/select>
    <\/td>
    <td><input type="text" class="form-control form-control-sm time-input"
             id="${hoursId}" data-role="model-hours" placeholder="—á:–º"
             value="${modelData.hours ? formatTimeForDisplay(modelData.hours) : ''}"
             onblur="this.value = formatTimeForDisplay(handleTimeInput({target: {value: this.value}}))" /><\/td>
    <td><input type="number" step="0.1" class="form-control form-control-sm" id="${weightId}" data-role="model-weight" placeholder="–≥" value="${modelData.weight || ''}" /><\/td>
    <td>
      <select class="form-select form-select-sm" id="${materialId}" data-role="model-material">
        <option value="">-–ú–∞—Ç–µ—Ä–∏–∞–ª-<\/option>
        ${optsMat}
      <\/select>
    <\/td>
    <td>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="${labelId}" data-role="model-label" ${includeLabel ? 'checked' : ''}>
        <label class="form-check-label small" for="${labelId}">–ü–µ—á–∞—Ç–∞—Ç—å<\/label>
      </div>
    <\/td>
    <td><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">–£–¥–ª.<\/button><\/td>
  `;
        tbody.appendChild(tr);
    }
    function getAllMaterialsForPrinter(printerId, includeAll=false){
        return appData.materials.filter(m => {
            if(!includeAll && m.balance <= 0) return false;
            if(!Array.isArray(m.printers) || m.printers.length===0) return true;
            return m.printers.some(pid => String(pid) === String(printerId));
        });
    }

    let lastCalcFullData = null;

    let incomingLinkData = null;

    let lastSummaryCardHtml = '';

    let myNalogChallengeToken = '';

    let clientDropdownVisible = false;
    let currentCalcClientId = "";
    const MY_NALOG_API = 'https://lknpd.nalog.ru';


    function setCalcOrderId(value) {
        const input = document.getElementById("calcOrderId");
        if (input) input.value = value || "";
        const text = document.getElementById("calcOrderIdText");
        if (text) {
            const displayValue = value && String(value).trim() ? value : "‚Äî";
            text.textContent = displayValue;
        }
    }

    function openSettingsTab() {
        const tabTrigger = document.getElementById('settings-tab');
        if (!tabTrigger) return;
        const tab = new bootstrap.Tab(tabTrigger);
        tab.show();
        const settingsSection = document.getElementById('settingsPane');
        if (settingsSection) {
            settingsSection.scrollIntoView({behavior: 'smooth', block: 'start'});
        }
    }

    function getCalcOrderId() {
        const input = document.getElementById("calcOrderId");
        return input ? input.value.trim() : "";
    }

    function onCalculateAll() {
        const calcName = document.getElementById("calcName").value.trim();
        let clientName = document.getElementById("calcClientName").value.trim();
        let clientId = currentCalcClientId || "";
        if(clientName){
            let c = clientId ? getClientById(clientId) : null;
            if (!c) {
                c = appData.clients.find(x => x.name === clientName);
            }
            if(!c){
                c = {id: getNextId('clients'), name: clientName};
                appData.clients.push(c);
                renderClientsTable();
                saveToLocalStorage();
            }
            clientId = c.id;
            currentCalcClientId = c.id;
        } else {
            currentCalcClientId = "";
        }
        const orderStatus = document.getElementById("calcOrderStatus").value;
        const opRate = parseFloat(document.getElementById("calcOperatorRate").value) || 0;
        const cKwh = parseFloat(document.getElementById("calcCostKwh").value) || 0;
        const tPercent = parseFloat(document.getElementById("calcTaxPercent").value) || 0;
        const roundingMode = document.getElementById("calcRoundingMode").value || "none";
        const ship = parseFloat(document.getElementById("calcShipping").value) || 0;
        const startDateInput = document.getElementById("calcStartDate");
        let sDate = startDateInput ? startDateInput.value : "";
        if (sDate) {
            sDate = normalizeDateTimeLocal(sDate);
            if (startDateInput) startDateInput.value = sDate;
        } else {
            sDate = getTodayIsoDate();
            if (startDateInput) startDateInput.value = sDate;
        }
        const deadlineInputEl = document.getElementById("calcDeadlineDate");
        const rawDeadline = deadlineInputEl ? deadlineInputEl.value : "";
        const normalizedDeadline = rawDeadline && rawDeadline.trim() ? normalizeDateTimeLocal(rawDeadline) : "";
        if (deadlineInputEl && rawDeadline && normalizedDeadline !== rawDeadline) {
            deadlineInputEl.value = normalizedDeadline;
        }
        const deadlineDate = normalizedDeadline ? parseDateTimeLocalToDate(normalizedDeadline) : null;
        const parallelMode = document.getElementById("calcParallelPrinting").value;
        const urgencySelectEl = document.getElementById("calcUrgencyProfile");
        let urgencyId = urgencySelectEl ? urgencySelectEl.value : (appData.calcSettings.currentUrgencyId || '');
        let urgencyProfile = getUrgencyProfileById(urgencyId);
        if (!urgencyProfile) {
            const allProfiles = appData.labelSettings.urgencyProfiles || [];
            urgencyProfile = allProfiles.find(p => p.id === appData.calcSettings.currentUrgencyId) || allProfiles[0] || null;
            if (urgencyProfile) {
                urgencyId = urgencyProfile.id;
            }
        }
        const initialUrgencyId = urgencyProfile ? urgencyProfile.id : null;
        let profileMarkupPercent = urgencyProfile ? (parseFloat(urgencyProfile.markupPercent) || 0) : 0;
        const userMarkupPercent = parseFloat(document.getElementById("calcMarkupPercent").value) || 0;
        let markupPercent = userMarkupPercent + profileMarkupPercent;
        const discountPercent = parseFloat(document.getElementById("calcDiscountPercent").value) || 0;
        const manualFinalCost = parseFloat(document.getElementById("calcFinalCost").value) || 0;
        const downtimeRate = parseFloat(document.getElementById("calcDowntimeCost").value) || 0;
        const prepRate = parseFloat(document.getElementById("calcPreparationRate").value) || 0;
        const prepTime = handleTimeInput({target:{value: document.getElementById("calcPreparationTime").value}});
        const includeOpRejects = document.getElementById("calcOperatorReject").checked;
        const includeAmortization = document.getElementById("settingsIncludeAmortization").checked;
        const includeRejectsInCost = document.getElementById("settingsIncludeRejects").checked;
        const includeOverheads = document.getElementById("settingsIncludeOverheads").checked;
        const ignoreCoolingRejects = document.getElementById("settingsIgnoreCoolingRejects").checked;
        const servicesArr = appData.calcSettings.customServices || [];
        const includeEstimatePrint = appData.calcSettings.includeEstimatePrint;
        const estimatePrintCost = includeEstimatePrint ? (parseFloat(appData.calcSettings.estimatePrintCost) || 0) : 0;
        let servicesTotal = 0;
        const servicesUsed = [];
        servicesArr.forEach(s=>{
            if(!s.use) return;
            const cost=parseFloat(s.cost)||0;
            const qty=parseFloat(s.qty)||0;
            let total=0;
            if(s.mode==='per_service') total=cost; else total=cost*qty;
            servicesTotal+=total;
            servicesUsed.push({id:s.id,name:s.name,cost:cost,qty:qty,mode:s.mode,use:true,total});
        });
        appData.calcSettings.deadlineDate = normalizedDeadline;
        let orderId = getCalcOrderId();
        let existingIndex = appData.calcHistory.findIndex(entry => entry.calcName === calcName);
        if (!orderId) {
            orderId = getNextOrderId();
        } else {
            const conflict = appData.calcHistory.some((entry, idx) => String(entry.id) === String(orderId) && idx !== existingIndex);
            if (conflict) {
                orderId = getNextOrderId();
            } else {
                const numericId = parseInt(orderId, 10);
                if (!isNaN(numericId)) {
                    if (!appData.counters) appData.counters = {};
                    if (!appData.counters.orders || appData.counters.orders < numericId) {
                        appData.counters.orders = numericId;
                    }
                }
            }
        }
        setCalcOrderId(orderId);

        // –∏—Ç–æ–≥–æ–≤—ã–π HTML –¥–ª—è –≤—ã–≤–æ–¥–∞
        var htmlRes = '';

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–∞—Å—á—ë—Ç–∞
        appData.calcSettings.operatorRate = opRate;
        appData.calcSettings.includeOperatorForRejects = includeOpRejects;
        appData.calcSettings.costKwh = cKwh;
        appData.calcSettings.taxPercent = tPercent;
        appData.calcSettings.roundingMode = roundingMode;
        appData.calcSettings.shipping = ship;
        appData.calcSettings.parallelPrinting = parallelMode;
        appData.calcSettings.markupPercent = userMarkupPercent;
        appData.calcSettings.discountPercent = discountPercent;
        appData.calcSettings.downtimeCost = downtimeRate;
        appData.calcSettings.preparationRate = prepRate;
        appData.calcSettings.preparationTime = prepTime;
        appData.calcSettings.includeAmortization = includeAmortization;
        appData.calcSettings.includeRejects = includeRejectsInCost;
        appData.calcSettings.includeOverheads = includeOverheads;
        appData.calcSettings.ignoreCoolingRejects = ignoreCoolingRejects;
        appData.calcSettings.currentUrgencyId = urgencyId || (urgencyProfile ? urgencyProfile.id : appData.calcSettings.currentUrgencyId);

        saveToLocalStorage();

        // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è id –º–æ–¥–µ–ª–µ–π: —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏ –∏ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ —Å–æ–±—Ä–∞—Ç—å calcData –∏ —Å—Ç—Ä–æ–∏—Ç—å —Ä–∞—Å—á—ë—Ç.
        // –≠—Ç–æ ¬´–ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç¬ª id –Ω–∞ –ª–µ—Ç—É, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/–∏–º–ø–æ—Ä—Ç –ø—Ä–∏–Ω–µ—Å–ª–∏ –∫–æ–ª–ª–∏–∑–∏–∏.
        normalizeCalcModelIds();

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
        let calcData = {};
        appData.printers.forEach(pr => {
            const table = document.getElementById(`calcModelsTable_${pr.id}`);
            if (!table) return;
            const rows = table.querySelectorAll("tbody tr");
            let modelsData = [];
            rows.forEach(row => {
                const inpName = row.querySelector('input[data-role="model-name"]');
                const selStatus = row.querySelector('select[data-role="model-status"]');
                const inpH = row.querySelector('input[data-role="model-hours"]');
                const inpW = row.querySelector('input[data-role="model-weight"]');
                const selM = row.querySelector('select[data-role="model-material"]');
                const labelToggle = row.querySelector('input[data-role="model-label"]');
                if (!inpName || !selStatus || !inpH || !inpW || !selM) return;
                const h = handleTimeInput({target: {value: inpH.value}}); // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥
                const w = parseFloat(inpW.value) || 0;
                let midVal = row.dataset.modelId;
                if (midVal === undefined || midVal === null || String(midVal).trim() === '') {
                    midVal = String(getNextId('models'));
                    row.dataset.modelId = midVal;
                }
                modelsData.push({
                    id: String(midVal),
                    thumbnail: row.dataset.thumbnail || '',
                    name: inpName.value.trim() || "–ú–æ–¥–µ–ª—å",
                    status: selStatus.value || "new",
                    hours: h,
                    weight: w,
                    materialId: selM.value,
                    includeLabel: !labelToggle || labelToggle.checked
                });
            });
            calcData[pr.id] = modelsData;
        });

        // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º —Å—É–º–º–∞—Ä–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–ª–∞—Å—Ç–∏–∫–∞ (–≤ –≥—Ä–∞–º–º–∞—Ö) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø–æ –≤—Å–µ–º—É —Ä–∞—Å—á—ë—Ç—É
        let materialConsumption = {};

        // –†–∞—Å—á—ë—Ç –∑–∞—Ç—Ä–∞—Ç –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º
        let detailsByPrinter = [];
        let sumWithoutTax = 0;
        let finalTimeAllPrinters = 0;
        let finalOpTimeAllPrinters = 0;
        let maxPrinterTime = 0;
        let maxOpPrinterTime = 0;
        let totalCoolingMinutes = 0;
        let totalPrinterPrepMinutes = 0;
        let totalRejectHours = 0;
        let totalRejectWeight = 0;

        appData.printers.forEach(pr => {
            const table = document.getElementById(`calcModelsTable_${pr.id}`);
            if (!table) return;

            let prTime = 0;
            let prOpTime = 0;
            let prCostNoTax = 0;
            let prPrepMinutes = 0;
            let lines = [];
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach(row => {
                const inpName = row.querySelector('input[data-role="model-name"]');
                const selStatus = row.querySelector('select[data-role="model-status"]');
                const inpH = row.querySelector('input[data-role="model-hours"]');
                const inpW = row.querySelector('input[data-role="model-weight"]');
                const selM = row.querySelector('select[data-role="model-material"]');
                const labelToggle = row.querySelector('input[data-role="model-label"]');
                if (!inpName || !selStatus || !inpH || !inpW || !selM) return;
                const h = handleTimeInput({target: {value: inpH.value}}); // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥
                const w = parseFloat(inpW.value) || 0;
                const mid = selM.value;
                if (!mid || h <= 0 || w <= 0) return;

                const status = selStatus.value || "new";
                const isReject = status === "reject";
                if (isReject) {
                    totalRejectHours += h;
                }

                const mat = getAllMaterialsForPrinter(pr.id).find(x => String(x.id) === String(mid));
                if (!mat) return;

                const realW = w;
                if (isReject) {
                    totalRejectWeight += realW;
                }
                // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
                materialConsumption[mid] = (materialConsumption[mid] || 0) + realW;

                const includeModelTotals = includeRejectsInCost || !isReject;
                const matCoolingMinutes = parseFloat(mat.coolingTime) || 0;
                const matPrepMinutes = parseFloat(mat.printerPrepMinutes) || 0;
                if (includeModelTotals) {
                    prTime += h;
                    if (!isReject || includeOpRejects) prOpTime += h;
                    if (!(ignoreCoolingRejects && isReject)) {
                        totalCoolingMinutes += matCoolingMinutes;
                    }
                    if (matPrepMinutes > 0) {
                        prPrepMinutes += matPrepMinutes;
                        totalPrinterPrepMinutes += matPrepMinutes;
                    }
                }

                const costPH = (pr.hoursToRecoup > 0) ? pr.cost / pr.hoursToRecoup : 0;
                const rawPrinterPart = includeAmortization ? h * costPH : 0;
                const costPerGram = mat.costPerKg / 1000;
                const rawMaterialCost = realW * costPerGram;
                const rawElectric = (pr.power / 1000) * h * cKwh;
                const rawMaintenance = includeAmortization ? pr.maintCostHour * h : 0;

                const costPrinterPart = includeModelTotals ? rawPrinterPart : 0;
                const costMaterial = includeModelTotals ? rawMaterialCost : 0;
                const costElectric = includeModelTotals ? rawElectric : 0;
                const costMaint = includeModelTotals ? rawMaintenance : 0;
                const subTotalModel = costPrinterPart + costMaterial + costElectric + costMaint;

                prCostNoTax += subTotalModel;

                const normalizedName = inpName.value.trim();
                const effectiveName = normalizedName || row.dataset.modelId || `–ú–æ–¥–µ–ª—å ${lines.length + 1}`;
                lines.push({
                    id: row.dataset.modelId || getNextId('models'),
                    thumbnail: row.dataset.thumbnail || '',
                    name: effectiveName,
                    displayName: normalizedName,
                    status: selStatus.value || "new",
                    hours: h,
                    weight: w,
                    matName: `${mat.name} (ID: ${mat.id})`,
                    realWeight: realW,
                    costPrinterPart: costPrinterPart,
                    costMaterial: costMaterial,
                    costElectric: costElectric,
                    costMaintenance: costMaint,
                    subTotalModel: subTotalModel,
                    excludedFromTotals: !includeModelTotals,
                    printerPrepMinutes: includeModelTotals ? matPrepMinutes : 0,
                    coolingMinutes: includeModelTotals ? matCoolingMinutes : 0,
                    includeLabel: !labelToggle || labelToggle.checked,
                    materialData: {
                        id: mat.id,
                        declaredWeight: mat.declaredWeight,
                        manufacturer: mat.manufacturer,
                        productionDate: mat.productionDate
                    }
                });
            });

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞ —É–¥–∞–ª–µ–Ω—ã, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            let printerAdditionalDetails = [];

            if (parallelMode === "no") {
                finalTimeAllPrinters += prTime;
                finalOpTimeAllPrinters += prOpTime;
            } else {
                if (prTime > maxPrinterTime) maxPrinterTime = prTime;
                if (prOpTime > maxOpPrinterTime) maxOpPrinterTime = prOpTime;
            }

            sumWithoutTax += prCostNoTax;
            detailsByPrinter.push({
                printerId: pr.id,
                printerName: pr.name,
                linesDetail: lines,
                printerTime: prTime,
                printerPrepMinutes: prPrepMinutes,
                subTotal: prCostNoTax,
                additionalDetails: printerAdditionalDetails
            });
        });

        const hasSelectableProfiles = Array.isArray(appData.labelSettings.urgencyProfiles) && appData.labelSettings.urgencyProfiles.length;
        const profilePool = hasSelectableProfiles ? appData.labelSettings.urgencyProfiles : DEFAULT_URGENCY_PROFILES;
        let scheduleMinutesMap = getScheduleMinutesForProfile(urgencyProfile);
        let breaksMap = computeBreaksMap(scheduleMinutesMap || {});
        let timelineComputation = null;
        let autoSelectedProfileId = null;
        if (deadlineDate && profilePool.length) {
            const sortedProfiles = profilePool.slice().sort((a, b) => {
                const aMarkup = parseFloat(a.markupPercent) || 0;
                const bMarkup = parseFloat(b.markupPercent) || 0;
                return aMarkup - bMarkup;
            });
            let fallbackCandidate = null;
            for (const profile of sortedProfiles) {
                const candidateSchedule = getScheduleMinutesForProfile(profile);
                const candidateBreaks = computeBreaksMap(candidateSchedule || {});
                const candidateTimeline = buildTimelineEvents(detailsByPrinter, sDate, candidateSchedule, candidateBreaks);
                const candidateFinish = getTimelineEndDate(candidateTimeline.events);
                if (!fallbackCandidate || (candidateFinish && (!fallbackCandidate.finish || candidateFinish < fallbackCandidate.finish))) {
                    fallbackCandidate = {
                        profile,
                        schedule: candidateSchedule,
                        breaks: candidateBreaks,
                        timeline: candidateTimeline,
                        finish: candidateFinish
                    };
                }
                if (candidateFinish && candidateFinish <= deadlineDate) {
                    urgencyProfile = profile;
                    scheduleMinutesMap = candidateSchedule;
                    breaksMap = candidateBreaks;
                    timelineComputation = candidateTimeline;
                    autoSelectedProfileId = profile.id;
                    break;
                }
            }
            if (!timelineComputation && fallbackCandidate) {
                urgencyProfile = fallbackCandidate.profile;
                scheduleMinutesMap = fallbackCandidate.schedule;
                breaksMap = fallbackCandidate.breaks;
                timelineComputation = fallbackCandidate.timeline;
                autoSelectedProfileId = fallbackCandidate.profile.id;
            }
            if (autoSelectedProfileId) {
                if (hasSelectableProfiles && urgencySelectEl) {
                    const hasOption = Array.from(urgencySelectEl.options).some(opt => String(opt.value) === String(autoSelectedProfileId));
                    if (hasOption) {
                        urgencySelectEl.value = autoSelectedProfileId;
                        urgencySelectEl.dispatchEvent(new Event('change'));
                    }
                }
                appData.calcSettings.currentUrgencyId = autoSelectedProfileId;
            }
        }
        if (!timelineComputation) {
            timelineComputation = buildTimelineEvents(detailsByPrinter, sDate, scheduleMinutesMap, breaksMap);
        }
        const {
            events: timelineEvents,
            scheduleSummary: timelineScheduleSummary
        } = timelineComputation;
        profileMarkupPercent = urgencyProfile ? (parseFloat(urgencyProfile.markupPercent) || 0) : 0;
        markupPercent = userMarkupPercent + profileMarkupPercent;
        const timelineEndDate = getTimelineEndDate(timelineEvents);
        const deadlineMet = deadlineDate && timelineEndDate ? timelineEndDate <= deadlineDate : null;
        const autoDeadlineApplied = Boolean(deadlineDate && autoSelectedProfileId);
        const autoDeadlineChangedProfile = Boolean(autoDeadlineApplied && autoSelectedProfileId !== initialUrgencyId);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –æ—Å—Ç–∞—Ç–∫–∞
        let warnings = [];
        for (let mid in materialConsumption) {
            const required = materialConsumption[mid];
            const mat = findMaterialById(mid);
            if (mat && required > (mat.balance * 1000)) {
                warnings.push(`–ú–∞—Ç–µ—Ä–∏–∞–ª–∞ "${mat.name}" –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: —Ç—Ä–µ–±—É–µ—Ç—Å—è ${safeFixed(required)} –≥, –æ—Å—Ç–∞—Ç–æ–∫ ${safeFixed(mat.balance * 1000)} –≥.`);
            }
        }

        const totalCoolingHours = totalCoolingMinutes / 60;
        const totalPrepHours = totalPrinterPrepMinutes / 60;
        const totalDowntimeMinutes = totalCoolingMinutes + totalPrinterPrepMinutes;
        const totalDowntimeHours = totalDowntimeMinutes / 60;
        let baseOperatorTime = (parallelMode === "yes") ? maxOpPrinterTime : finalOpTimeAllPrinters;
        let finalTimeOperator = baseOperatorTime;
        const operatorWorkCost = baseOperatorTime * opRate;
        const downtimeCost = totalDowntimeMinutes * downtimeRate;
        const preparationCost = prepTime * prepRate;
        const totalOperatorCost = operatorWorkCost + downtimeCost + preparationCost;

        let sumGlobalAdd = 0;
        let globalAdditionalDetails = [];
        if (includeOverheads) {
            appData.additionalGlobal.forEach(g => {
                if (!g.useInCalc) return;
                let hours = 0;
                detailsByPrinter.forEach(d=>{
                    if(!g.printers || g.printers.length===0 || g.printers.some(pid => String(pid) === String(d.printerId))){
                        const prepHours = (d.printerPrepMinutes || 0) / 60;
                        hours += d.printerTime + prepHours;
                    }
                });
                const costPerHour = (g.hoursToRecoup > 0) ? g.cost / g.hoursToRecoup : 0;
                const cVal = costPerHour * hours;
                sumGlobalAdd += cVal;
                globalAdditionalDetails.push({
                    id: g.id,
                    description: g.description,
                    baseCost: g.cost,
                    hoursToRecoup: g.hoursToRecoup,
                    costDistributed: cVal
                });
            });
        }

        let totalLabelsCost = 0;
        if(appData.labelSettings.printLabels) {
            const labelCost = appData.labelSettings.costPerLabel || 0;
            const totalModels = Object.values(calcData).reduce((acc, models) => {
                const allowedModels = models.filter(m =>
                    (includeRejectsInCost || (m.status !== 'reject')) &&
                    (m.includeLabel !== false)
                );
                return acc + allowedModels.length;
            }, 0);
            totalLabelsCost = totalModels * labelCost;
        }


        let subtotalBeforeTax = sumWithoutTax + sumGlobalAdd + ship + totalOperatorCost + totalLabelsCost + estimatePrintCost;
        if (markupPercent > 0) {
            subtotalBeforeTax *= (1 + markupPercent / 100);
        }
        subtotalBeforeTax += servicesTotal;
        const totalBeforeDiscount = tPercent > 0 ? subtotalBeforeTax / (1 - tPercent / 100) : subtotalBeforeTax;
        let finalSum = totalBeforeDiscount;
        if(discountPercent > 0){
            finalSum = finalSum * (1 - discountPercent / 100);
        }
        const totalBeforeRounding = finalSum;
        let roundingInfo = { mode: roundingMode || "none", step: 0, adjustment: 0 };
        if (manualFinalCost > 0) {
            finalSum = manualFinalCost;
        } else if (roundingMode !== "none") {
            const step = roundingMode === "round100" ? 100 : 10;
            const rounded = Math.ceil(finalSum / step) * step;
            const adjustment = rounded - finalSum;
            if (adjustment > 0.0001) {
                roundingInfo = { mode: roundingMode, step, adjustment };
                finalSum = rounded;
            }
        }
        const taxAmount = tPercent > 0 ? finalSum * (tPercent / 100) : 0;
        const subtotal = finalSum - taxAmount;
        const modelsRevenue = Math.max(0, finalSum - ship - servicesTotal);

        let finDateStr = calcFinishDate(timelineEvents, sDate);

        htmlRes = `<strong>–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:<\/strong><br/>`;
        htmlRes += `–ö–æ–¥: ${orderId}<br/>`;
        htmlRes += `–ù–∞–∑–≤–∞–Ω–∏–µ: ${calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}, –ö–ª–∏–µ–Ω—Ç: ${clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}, –°—Ç–∞—Ç—É—Å: ${getOrderStatusLabel(orderStatus)}<br/>`;
        const urgencyLabel = urgencyProfile ? `${urgencyProfile.title}${profileMarkupPercent ? ` (+${profileMarkupPercent}% )` : ''}` : '‚Äî';
        htmlRes += `–°—Ä–æ—á–Ω–æ—Å—Ç—å: ${urgencyLabel}<br/>`;
        if (deadlineDate) {
            const deadlineLabel = deadlineDate.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            htmlRes += `–¢—Ä–µ–±—É–µ–º–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: ${deadlineLabel}<br/>`;
        }
        htmlRes += `–£—á–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–µ—á–∞—Ç–∏: ${(parallelMode === "yes") ? "–î–∞" : "–ù–µ—Ç"}<br/>`;
        const downtimeParts = [];
        if (totalCoolingHours > 0) {
            downtimeParts.push(`—É—Å–∞–¥–∫–∞: ${formatTimeForDisplay(totalCoolingHours)} —á.`);
        }
        if (totalPrepHours > 0) {
            downtimeParts.push(`–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞: ${formatTimeForDisplay(totalPrepHours)} —á.`);
        }
        const downtimeLabel = downtimeParts.length ? ` (${downtimeParts.join(' ')})` : '';
        htmlRes += `–ü—Ä–æ—Å—Ç–æ–π: ${formatTimeForDisplay(totalDowntimeHours)} —á.${downtimeLabel} (${safeFixed(downtimeCost)} ‚ÇΩ)<br/>`;
        htmlRes += `–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: ${formatTimeForDisplay(prepTime)} —á. (${safeFixed(preparationCost)} ‚ÇΩ)<br/>`;
        htmlRes += `–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${formatTimeForDisplay(finalTimeOperator+prepTime + totalDowntimeHours)} —á. (${formatTimeForDisplay(finalTimeOperator)} + ${formatTimeForDisplay(prepTime + totalDowntimeHours)} —á.)<br/>`;
        htmlRes += `–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${safeFixed(totalOperatorCost)} ‚ÇΩ (${safeFixed(operatorWorkCost)} ‚ÇΩ + ${safeFixed(downtimeCost)} ‚ÇΩ + ${safeFixed(preparationCost)} ‚ÇΩ)<br/>`;
        if (roundingInfo.adjustment > 0) {
            htmlRes += `–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ ${roundingInfo.step} ‚ÇΩ: +${safeFixed(roundingInfo.adjustment)} ‚ÇΩ<br/>`;
        }
        htmlRes += `–ù–∞—Ü–µ–Ω–∫–∞: ${markupPercent}% (–ø—Ä–æ—Ñ–∏–ª—å ${profileMarkupPercent}%, —Ä—É—á–Ω–∞—è ${userMarkupPercent}%).<br/>`;
        htmlRes += `–£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞: ${safeFixed(ship)} ‚ÇΩ<br/>`;
        htmlRes += `–°—Ç–æ–∏–º–æ—Å—Ç—å —ç—Ç–∏–∫–µ—Ç–æ–∫: ${safeFixed(totalLabelsCost)} ‚ÇΩ<br/>`;
        if(servicesUsed.length>0){
            htmlRes += `–£—Å–ª—É–≥–∏:<br/>`;
            servicesUsed.forEach(s=>{htmlRes += `${s.name}: ${safeFixed(s.total)} ‚ÇΩ<br/>`;});
            htmlRes += `–ò—Ç–æ–≥–æ —É—Å–ª—É–≥–∏: ${safeFixed(servicesTotal)} ‚ÇΩ<br/>`;
        }
        htmlRes += `–ü–æ–¥–∏—Ç–æ–≥: ${safeFixed(subtotal)} ‚ÇΩ<br/>`;
        htmlRes += `–û–±—â–∏–π –Ω–∞–ª–æ–≥ (${tPercent}%): ${safeFixed(taxAmount)} ‚ÇΩ<br/>`;


        // –í—ã–≤–æ–¥ —Ü–µ–Ω—ã –∑–∞ 1 –≥—Ä–∞–º–º
        const totalWeight = detailsByPrinter.reduce((acc, printer) =>
            acc + printer.linesDetail.reduce((sum, line) => sum + (line.excludedFromTotals ? 0 : line.realWeight), 0), 0);
        const pricePerGram = totalWeight > 0 ? modelsRevenue / totalWeight : 0;


        if(discountPercent > 0){
            htmlRes += `–ò—Ç–æ–≥–æ –±–µ–∑ —Å–∫–∏–¥–∫–∏: <del>${safeFixed(totalBeforeDiscount)} ‚ÇΩ<\/del><br/>`;
            htmlRes += `<strong>–ò—Ç–æ–≥–æ —Å–æ —Å–∫–∏–¥–∫–æ–π (${discountPercent}%) (–¥–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è): ${safeFixed(totalBeforeRounding)} ‚ÇΩ<\/strong><br/>`;
        } else {
            htmlRes += `<strong>–ò—Ç–æ–≥–æ (–¥–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è, —Å —É—á—ë—Ç–æ–º –Ω–∞—Ü–µ–Ω–∫–∏, –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –Ω–∞–ª–æ–≥–∞): ${safeFixed(totalBeforeRounding)} ‚ÇΩ<\/strong><br/>`;
        }
        htmlRes += `<strong>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ (–ø–æ—Å–ª–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è): ${safeFixed(finalSum)} ‚ÇΩ<\/strong><br/>`;

        htmlRes += `–¶–µ–Ω–∞ –∑–∞ 1 –≥—Ä–∞–º–º: ${safeFixed(pricePerGram)}<br/>`;

        if (finDateStr) {
            const finishStatus = deadlineDate && timelineEndDate
                ? (deadlineMet ? ' (—É—Å–ø–µ–≤–∞–µ–º –∫ —Å—Ä–æ–∫—É)' : ' (‚ö†Ô∏è –Ω–µ —É–∫–ª–∞–¥—ã–≤–∞–µ–º—Å—è)')
                : '';
            htmlRes += `–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä–Ω–æ): ${finDateStr}${finishStatus}<br/>`;
        }
        if (deadlineDate && autoDeadlineApplied) {
            if (autoDeadlineChangedProfile && urgencyProfile) {
                htmlRes += `<span class="text-muted">–ü—Ä–æ—Ñ–∏–ª—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ "${urgencyProfile.title}".<\/span><br/>`;
            }
            if (deadlineMet === false) {
                htmlRes += `<span class="text-danger">‚ö†Ô∏è –î–∞–∂–µ –ø—Ä–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ–º –ø—Ä–æ—Ñ–∏–ª–µ —Å—Ä–æ–∫ –Ω–µ —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è ‚Äî —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –æ–±—ä—ë–º –∏–ª–∏ —Ä–∞—Å—à–∏—Ä—å—Ç–µ –≥—Ä–∞—Ñ–∏–∫.<\/span><br/>`;
            }
        } else if (deadlineDate && deadlineMet === false) {
            htmlRes += `<span class="text-danger">‚ö†Ô∏è –î–µ–¥–ª–∞–π–Ω –Ω–µ —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –±–æ–ª–µ–µ —Å—Ä–æ—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫.<\/span><br/>`;
        }

        // —Ñ–æ—Ä–º–∏—Ä—É–µ–º HTML –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Ç–æ–≥–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        let summaryModels = '';
        detailsByPrinter.forEach(pr => {
            pr.linesDetail.forEach(ln => {
                if (ln.excludedFromTotals) return;
                const statusLabel = getModelStatusLabel(ln.status);
                const qualityLabel = getModelQualityLabel(ln.status);
                const statusDisplay = qualityLabel ? `${statusLabel} ‚Äî ${qualityLabel}` : statusLabel;
                summaryModels += `<div class="model-card">` +
                    (ln.thumbnail ? `<img src="data:image/png;base64,${ln.thumbnail}" alt="icon">` : '') +
                    `<h3>${ln.name}<\/h3>` +
                    `<p><strong>–¢—Ä–µ–±—É–µ—Ç—Å—è:<\/strong> ${formatTimeForDisplay(ln.hours)}<\/p>` +
                    `<p><strong>–í–µ—Å:<\/strong> ${safeFixed(ln.realWeight)} –≥<\/p>` +
                    `<p><strong>–ú–∞—Ç–µ—Ä–∏–∞–ª:<\/strong> ${ln.matName}<\/p>` +
                    `<p><strong>–°—Ç–∞—Ç—É—Å:<\/strong> ${statusDisplay}<\/p>` +
                    `</div>`;
            });
        });
        const qrText = buildPaymentQrString();
        generateQRCodeCanvas(qrText, 120, function(qrCanvas){
            const qrDataUrl = qrCanvas ? qrCanvas.toDataURL('image/png') : '';
            const roundingNote = roundingInfo.adjustment > 0
                ? `+${safeFixed(roundingInfo.adjustment)} ‚ÇΩ –¥–æ ${roundingInfo.step} ‚ÇΩ`
                : '';
            lastSummaryCardHtml = buildSummaryCardHtml({
                company: appData.labelSettings.companyName,
                orderId,
                orderName: calcName || '(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)',
                client: clientName || '(–ù–µ —É–∫–∞–∑–∞–Ω)',
                status: getOrderStatusLabel(orderStatus),
                totalTime: formatTimeForDisplay(finalTimeOperator) + ' —á',
                totalTimeOperator: formatTimeForDisplay(finalTimeOperator + prepTime + totalDowntimeHours) + ' —á',
                downtimeTotalHours: formatTimeForDisplay(totalDowntimeHours),
                downtimeCoolingHours: formatTimeForDisplay(totalCoolingHours),
                downtimePrepHours: formatTimeForDisplay(totalPrepHours),
                downtimeCost: safeFixed(downtimeCost),

                prepTime: formatTimeForDisplay(prepTime),
                preparationCost: safeFixed(preparationCost),
                roundingNote,


                totalWeight: safeFixed(totalWeight),
                totalCost: safeFixed(finalSum),
                priceOld: discountPercent > 0 ? safeFixed(totalBeforeDiscount) : '',
                discountPercent,
                pricePerGram: safeFixed(pricePerGram),
                finDate: finDateStr,
                modelsHtml: summaryModels,
                qr: qrDataUrl,
                paymentInfo: appData.labelSettings.bankDetails,
                services: servicesUsed,
                servicesTotal: safeFixed(servicesTotal),
                estimatePrintCost: includeEstimatePrint && estimatePrintCost > 0 ? safeFixed(estimatePrintCost) : '',
                urgencyTitle: urgencyProfile ? urgencyProfile.title : '',
                urgencyProfileMarkup: profileMarkupPercent,
                urgencyUserMarkup: userMarkupPercent
            });
        });
        if (warnings.length > 0) {
            htmlRes += `<div class="alert alert-warning mt-2">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:<br/>` + warnings.join("<br/>") + `<\/div>`;
        }
        if (timelineEvents.length > 0) {
            htmlRes += `<hr/><strong>–ì—Ä–∞—Ñ–∏–∫ –ø–µ—á–∞—Ç–∏<\/strong>`;
            const timelineGroups = [];
            const printerOrder = [];
            const now = new Date();
            timelineEvents.forEach(evt => {
                const anchor = evt.start || (Array.isArray(evt.intervals) && evt.intervals.length ? evt.intervals[0].start : null);
                const baseDate = anchor instanceof Date ? anchor : (evt.intervals && evt.intervals[0] && evt.intervals[0].start instanceof Date ? evt.intervals[0].start : null);
                if (!baseDate) return;
                const dayDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
                const dayKey = dayDate.getTime();
                let group = timelineGroups.find(g => g.key === dayKey);
                if (!group) {
                    const dayLabel = dayDate.toLocaleDateString('ru-RU', {
                        weekday: 'long',
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    const isCurrentDay = dayDate.toDateString() === now.toDateString();
                    group = {key: dayKey, label: dayLabel, printers: [], isCurrentDay};
                    timelineGroups.push(group);
                }
                let printerGroup = group.printers.find(p => p.printer === (evt.printer || '‚Äî'));
                if (!printerGroup) {
                    printerGroup = {printer: evt.printer || '‚Äî', models: []};
                    group.printers.push(printerGroup);
                    if (!printerOrder.includes(printerGroup.printer)) printerOrder.push(printerGroup.printer);
                }
                const rawModelName = evt.modelName && evt.modelName.trim() ? evt.modelName.trim() : '';
                const fallbackModelId = evt.modelId || '';
                const modelLabel = rawModelName || fallbackModelId || '‚Äî';
                const modelKey = fallbackModelId || modelLabel;
                let modelGroup = printerGroup.models.find(m => m.key === modelKey);
                if (!modelGroup) {
                    modelGroup = {
                        key: modelKey,
                        modelLabel,
                        modelName: rawModelName,
                        modelId: fallbackModelId,
                        thumbnail: evt.thumbnail || '',
                        slots: []
                    };
                    printerGroup.models.push(modelGroup);
                } else if (!modelGroup.thumbnail && evt.thumbnail) {
                    modelGroup.thumbnail = evt.thumbnail;
                }
                modelGroup.slots.push(evt);
            });
            timelineGroups.sort((a, b) => a.key - b.key);
            printerOrder.sort((a, b) => a.localeCompare(b));

            timelineGroups.forEach(group => {
                const containerClass = group.isCurrentDay ? 'timeline-day-container timeline-day-current' : 'timeline-day-container';
                const dayDateObj = new Date(group.key);
                const getPrinterFirstEvent = (printerGroup) => printerGroup.models
                    .flatMap(model => model.slots)
                    .map(slot => slot.start || (slot.intervals && slot.intervals[0] && slot.intervals[0].start))
                    .filter(Boolean)
                    .sort((a, b) => a - b)[0] || null;
                const dayPrinters = group.printers
                    .slice()
                    .sort((a, b) => {
                        const firstA = getPrinterFirstEvent(a);
                        const firstB = getPrinterFirstEvent(b);
                        if (firstA && firstB) return firstA - firstB;
                        if (firstA) return -1;
                        if (firstB) return 1;
                        return printerOrder.indexOf(a.printer) - printerOrder.indexOf(b.printer);
                    });
                const dayBreakInfo = (timelineScheduleSummary || []).find(entry => entry.weekdayValue === dayDateObj.getDay());
                const breakRows = dayBreakInfo && Array.isArray(dayBreakInfo.breaksRaw) ? dayBreakInfo.breaksRaw : [];
                const dayBreakEntries = breakRows
                    .map(br => ({
                        ...br,
                        startDate: new Date(dayDateObj.getTime() + (br.startMinutes || 0) * 60000),
                        endDate: new Date(dayDateObj.getTime() + (br.endMinutes || 0) * 60000)
                    }))
                    .sort((a, b) => a.startDate - b.startDate);
                let breakPointer = 0;
                const dayTableRows = [];
                const renderBreaksUpTo = (limitDate) => {
                    while (breakPointer < dayBreakEntries.length && dayBreakEntries[breakPointer].startDate <= limitDate) {
                        const br = dayBreakEntries[breakPointer];
                        const timeRange = `${formatTimeOnly(br.startDate)} ‚Äî ${formatTimeOnly(br.endDate)}`;
                        const durationLabel = br.duration ? minutesToDuration(br.duration) : '‚Äî';
                        const actionText = br.duration >= 55
                            ? '–û–±–µ–¥–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤'
                            : '–ü–µ—Ä–µ—Ä—ã–≤ (–æ–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)';
                        const note = '–ü—Ä–∏–Ω—Ç–µ—Ä—ã –º–æ–≥—É—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ç–µ–∫—É—â—É—é –ø–µ—á–∞—Ç—å';
                        dayTableRows.push(`<tr class="timeline-break-row">
            <td>${timeRange}</td>
            <td>${durationLabel}</td>
            <td>–ü–µ—Ä–µ—Ä—ã–≤</td>
            <td>${actionText}. ${note}.</td>
          </tr>`);
                        breakPointer++;
                    }
                };
                let dayTotalMinutes = 0;
                dayPrinters.forEach(prGroup => {
                    dayTableRows.push(`<tr class="timeline-printer-row"><td colspan="5" class="text-center"><strong>–ü—Ä–∏–Ω—Ç–µ—Ä: ${prGroup.printer}</strong></td></tr>`);
                    prGroup.models.forEach(modelGroup => {
                        const hasReject = modelGroup.slots.some(slot => slot.status === 'reject');
                        const modelQuality = hasReject ? ' ‚Äî –ë—Ä–∞–∫' : '';
                        const modelIcon = modelGroup.thumbnail
                            ? `<img src="data:image/png;base64,${modelGroup.thumbnail}" alt="${modelGroup.modelLabel}" class="timeline-model-thumb">`
                            : `<i class="bi bi-box text-primary"></i>`;
                        const secondaryId = modelGroup.modelName && modelGroup.modelId && modelGroup.modelId !== modelGroup.modelLabel
                            ? `<span class="timeline-model-id">${modelGroup.modelId}</span>`
                            : '';
                        dayTableRows.push(`<tr class="timeline-model-row"><td colspan="5"><div class="timeline-model-title">${modelIcon}<strong>${modelGroup.modelLabel}${modelQuality}</strong>${secondaryId}</div></td></tr>`);
                        modelGroup.slots.forEach(evt => {
                            const intervals = Array.isArray(evt.intervals) && evt.intervals.length ? evt.intervals : [{
                                start: evt.start,
                                end: evt.end
                            }];
                            const eventStart = intervals[0].start || evt.start || new Date(group.key);
                            renderBreaksUpTo(eventStart);
                            const stage = TIMELINE_STAGE_LABELS[evt.type] || evt.type;
                            const action = TIMELINE_ACTIONS[evt.type] || '';
                            const timeRange = intervals.map(interval => `${formatTimeOnly(interval.start)} ‚Äî ${formatTimeOnly(interval.end)}`).join('<br/>');
                            const isCurrentSlot = intervals.some(interval => now >= interval.start && now <= interval.end);
                            const slotClass = isCurrentSlot ? 'timeline-slot-current' : '';
                            const nowBadge = isCurrentSlot ? ' <span class="badge bg-warning text-dark ms-2">–°–µ–π—á–∞—Å</span>' : '';
                            dayTableRows.push(`<tr class="${slotClass}">
                    <td>${timeRange}${nowBadge}</td>
          <td>${minutesToDuration(evt.duration || 0)}</td>
          <td>${stage}</td>
          <td>${action}</td>
        </tr>`);
                            dayTotalMinutes += evt.duration || 0;
                            const eventEnd = intervals[intervals.length - 1].end || evt.end || eventStart;
                            renderBreaksUpTo(eventEnd);
                        });
                    });
                });
                renderBreaksUpTo(new Date(dayDateObj.getTime() + 24 * 60 * 60000 - 1));
                const dayBodyHtml = dayTableRows.join('');
                htmlRes += `<div class="${containerClass}">
        <div class="timeline-day-title">${group.label}<\/div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle mb-0">
            <thead>
              <tr>
                <th style="width:35%;">–í—Ä–µ–º—è<\/th>
                <th style="width:15%;">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å<\/th>
                <th style="width:20%;">–≠—Ç–∞–ø<\/th>
                <th>–ó–∞–¥–∞—á–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É<\/th>
              <\/tr>
            <\/thead>
            <tbody>${dayBodyHtml}<\/tbody>
          <\/table>
        <\/div>
        <div class="timeline-day-summary">–ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å: ${minutesToDuration(dayTotalMinutes)}<\/div>
      <\/div>`;
            });
            const scheduleSummaryText = (timelineScheduleSummary || []).map(window => `${window.dayLabel}: ${window.windowLabel}`).join('; ');
            const scheduleText = scheduleSummaryText ? `–†–∞–±–æ—á–∏–µ –æ–∫–Ω–∞: ${scheduleSummaryText}. ` : '';
            const scheduleStartDate = new Date(sDate);
            const startLabel = Number.isNaN(scheduleStartDate.getTime()) ? sDate : formatTimelineTime(scheduleStartDate);
            htmlRes += `<div class="text-muted small">${scheduleText}–ì—Ä–∞—Ñ–∏–∫ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ –ø–µ—Ä–∏–æ–¥—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ ${startLabel}.<\/div>`;
        }
        htmlRes += `<hr/><strong>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º:<\/strong><br/>`;
        detailsByPrinter.forEach(d => {

            if ((d.linesDetail.length === 0 || !d.linesDetail) && d.printerTime <= 0) {
                return;
            }



            htmlRes += `<div style="margin-top:1em;">`;
            htmlRes += `<strong>${d.printerName} (ID: ${d.printerId})<\/strong><br/>`;
            htmlRes += `–í—Ä–µ–º—è: ${safeFixed(d.printerTime)} —á; –°—É–º–º–∞: ${safeFixed(d.subTotal)} ‚ÇΩ<br/>`;
            if (d.linesDetail.length > 0) {
                htmlRes += `<div class="table-responsive"><table class="table table-sm table-bordered mt-1" style="max-width:800px;">`;
                htmlRes += `<thead><tr>
        <th>–ú–æ–¥–µ–ª—å<\/th>
        <th>–ò–∫–æ–Ω–∫–∞<\/th>
        <th>–°—Ç–∞—Ç—É—Å<\/th>
        <th>–ß–∞—Å—ã<\/th>
        <th>–í–µ—Å (–≥)<\/th>
        <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
        <th>–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ (‚ÇΩ)<\/th>
        <th>–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (‚ÇΩ)<\/th>
        <th>–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ (‚ÇΩ)<\/th>
        <th>–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (‚ÇΩ)<\/th>
        <th>–ò—Ç–æ–≥–æ (‚ÇΩ)<\/th>
        <th>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/th>
      <\/tr><\/thead><tbody>`;
                d.linesDetail.forEach(ln => {
                    htmlRes += `<tr>
          <td>${ln.name} (${ln.id || ''})${ln.excludedFromTotals ? ' <span class="badge bg-secondary">–Ω–µ –≤ —Ä–∞—Å—á—ë—Ç–µ<\/span>' : ''}<\/td>
          <td>${ln.thumbnail ? `<img src="data:image/png;base64,${ln.thumbnail}" style="height:40px;"/>` : ''}<\/td>
          <td>${getModelStatusLabel(ln.status)}${getModelQualityLabel(ln.status) ? ` ‚Äî ${getModelQualityLabel(ln.status)}` : ''}<\/td>
          <td>${formatTimeForDisplay(ln.hours)}<\/td>
          <td>${safeFixed(ln.realWeight)}<\/td>
          <td>${ln.matName}<\/td>
          <td>${safeFixed(ln.costPrinterPart)}<\/td>
          <td>${safeFixed(ln.costMaterial)}<\/td>
          <td>${safeFixed(ln.costElectric)}<\/td>
          <td>${safeFixed(ln.costMaintenance)}<\/td>
          <td>${safeFixed(ln.subTotalModel)}<\/td>
          <td>
            <button class="btn btn-sm btn-outline-secondary"
              onclick="downloadThermoLabelHtml('${ln.name}', '${d.printerName}', '${ln.matName}', '${safeFixed(ln.hours)}', '${safeFixed(ln.realWeight)}', '${ln.thumbnail || ''}')"
              ${ln.excludedFromTotals ? 'disabled title="–ú–æ–¥–µ–ª—å –∏—Å–∫–ª—é—á–µ–Ω–∞ –∏–∑ —Ä–∞—Å—á—ë—Ç–∞"' : ''}>
              –≠—Ç–∏–∫–µ—Ç–∫–∞
            <\/button>
          <\/td>
        <\/tr>`;
                });
                htmlRes += `<\/tbody><\/table></div>`;
            }

            // –í—ã–≤–æ–¥ —Ç–∞–±–ª–∏—Ü—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ —Å –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º–æ–π
            if (d.additionalDetails && d.additionalDetails.length > 0) {
                let htmlResadditionalDetails = `<hr/><strong>–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞:<\/strong>`;
                htmlResadditionalDetails += `<table class="table table-sm table-bordered mt-1" style="max-width:600px;">`;
                htmlResadditionalDetails += `<thead><tr><th>–û–ø–∏—Å–∞–Ω–∏–µ<\/th><th>–ò—Å—Ö. —Å—Ç–æ–∏–º.<\/th><th>–ß–∞—Å—ã –æ–∫—É–ø.<\/th><th>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (‚ÇΩ)<\/th><\/tr><\/thead><tbody>`;
                let sumPrinterAdditional = 0;
                d.additionalDetails.forEach(ad => {
                    sumPrinterAdditional += ad.costDistributed;
                    htmlResadditionalDetails += `<tr>
          <td>${ad.description}<\/td>
          <td>${safeFixed(ad.baseCost)}<\/td>
          <td>${ad.hoursToRecoup}<\/td>
          <td>${safeFixed(ad.costDistributed)}<\/td>
        <\/tr>`;
                });
                htmlResadditionalDetails += `<\/tbody><\/table>`;
                htmlResadditionalDetails += `–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞: ${safeFixed(sumPrinterAdditional)} ‚ÇΩ<br/>`;
                if(sumPrinterAdditional > 0)
                    htmlRes += htmlResadditionalDetails;
            }

            htmlRes += `<\/div>`;
        });

        if (globalAdditionalDetails.length > 0) {
            htmlRes += `<hr/><strong>–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ):<\/strong>`;
            htmlRes += `<table class="table table-sm table-bordered mt-1" style="max-width:600px;">`;
            htmlRes += `<thead><tr><th>–û–ø–∏—Å–∞–Ω–∏–µ<\/th><th>–ò—Å—Ö. —Å—Ç–æ–∏–º.<\/th><th>–ß–∞—Å—ã –æ–∫—É–ø.<\/th><th>–í –∑–∞–∫–∞–∑–µ (‚ÇΩ)<\/th><\/tr><\/thead><tbody>`;
            globalAdditionalDetails.forEach(gd => {
                htmlRes += `<tr>
        <td>${gd.description}<\/td>
        <td>${safeFixed(gd.baseCost)}<\/td>
        <td>${gd.hoursToRecoup}<\/td>
        <td>${safeFixed(gd.costDistributed)}<\/td>
      <\/tr>`;
            });
            htmlRes += `<\/tbody><\/table>`;
            htmlRes += `–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: ${safeFixed(sumGlobalAdd)} ‚ÇΩ<br/>`;
        }

        if(lastCalcFullData && Array.isArray(lastCalcFullData.nalogReceipts) && lastCalcFullData.nalogReceipts.length){
            const links = lastCalcFullData.nalogReceipts.map((r,i)=>{
                const inn = localStorage.getItem('my_nalog_inn') || '';
                const url = `https://lknpd.nalog.ru/api/v1/receipt/${inn}/${r.uuid}/print`;
                const cls = (r.canceled || i < lastCalcFullData.nalogReceipts.length-1) ? 'class="text-danger"' : '';
                return `<a href="${url}" target="_blank" ${cls}>–ß–µ–∫${lastCalcFullData.nalogReceipts.length>1?' '+(i+1):''}<\/a>`;
            }).join('<br/>');
            htmlRes += '<br/>'+links;
        }

        document.getElementById("calcResult").style.display = "block";
        document.getElementById("calcResult").innerHTML = htmlRes;
        const qrTarget=document.getElementById("orderSummaryQr");
        if(qrTarget){
            new QRCode(qrTarget,{text:appData.labelSettings.chatLink,width:120,height:120,correctLevel:QRCode.CorrectLevel.H});
        }
        const summaryBtn=document.getElementById("downloadSummaryCardBtn");
        if(summaryBtn) summaryBtn.style.display='inline-block';
        const myNalogBtn=document.getElementById("sendMyNalogBtn");
        if(myNalogBtn) myNalogBtn.style.display='inline-block';
        const myNalogBillBtn=document.getElementById("sendMyNalogBillBtn");
        if(myNalogBillBtn) myNalogBillBtn.style.display='inline-block';
        const myNalogCancelBtn=document.getElementById("cancelMyNalogBtn");
        if(myNalogCancelBtn) myNalogCancelBtn.style.display='none';

        lastCalcFullData = stripLegacyHistoryFields({
            id: orderId,
            calcName,
            clientName,
            clientId,
            orderStatus,
            total: finalSum,
            totalHours: finalTimeOperator,
            taxPercent: tPercent,
            taxAmount,
            shipping: ship,
            includeEstimatePrint,
            estimatePrintCost,
            services: servicesUsed,
            servicesTotal,
            detailsByPrinter,
            costKwh: cKwh,
            operatorRate: opRate,
            totalOperatorCost: totalOperatorCost,
            downtimeMinutes: totalDowntimeMinutes,
            coolingMinutes: totalCoolingMinutes,
            printerPrepMinutes: totalPrinterPrepMinutes,
            preparationCost: preparationCost,
            preparationTime: prepTime,
            calcData,
            globalAdditional: {
                details: globalAdditionalDetails
            },
            parallelMode,
            startDate: sDate,
            markupPercent,
            discountPercent,
            realTotal: manualFinalCost > 0 ? manualFinalCost : null,
            totalLabelsCost,
            modelsRevenue,
            urgencyProfileId: urgencyProfile ? urgencyProfile.id : '',
            userMarkupPercent,
            requiredFinishDate: normalizedDeadline || "",
            nalogReceipts: []
        });
        if(existingIndex !== -1){
            const ex = appData.calcHistory[existingIndex];
            if(Array.isArray(ex.nalogReceipts)){
                lastCalcFullData.nalogReceipts = ex.nalogReceipts.map(r=>({uuid:r.uuid, canceled: !!r.canceled}));
            }else if(ex.nalogReceiptUuid){
                lastCalcFullData.nalogReceipts = [{uuid: ex.nalogReceiptUuid, canceled: !!ex.nalogCanceled}];
            }
            if(Array.isArray(lastCalcFullData.nalogReceipts) && lastCalcFullData.nalogReceipts.length){
                const last = lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1];
                lastCalcFullData.receiptUuid = last.uuid;
            }
            const cancelBtn=document.getElementById('cancelMyNalogBtn');
            const showCancel = Array.isArray(lastCalcFullData.nalogReceipts) && lastCalcFullData.nalogReceipts.length && !lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1].canceled;
            if(cancelBtn) cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
        }

        const dtStr = new Date().toLocaleString("ru-RU");
        const newEntry = stripLegacyHistoryFields({
            id: orderId,
            timestamp: Date.now(),
            dateStr: dtStr,
            calcName,
            clientName,
            clientId,
            orderStatus,
            total: finalSum,
            totalHours: finalTimeOperator,
            taxPercent: tPercent,
            taxAmount,
            shipping: ship,
            includeEstimatePrint,
            estimatePrintCost,
            services: servicesUsed,
            servicesTotal,
            operatorRate: opRate,
            costKwh: cKwh,
            totalOperatorCost: totalOperatorCost,
            downtimeMinutes: totalDowntimeMinutes,
            coolingMinutes: totalCoolingMinutes,
            printerPrepMinutes: totalPrinterPrepMinutes,
            preparationCost: preparationCost,
            preparationTime: prepTime,
            details: detailsByPrinter,
            calcData,
            globalAdditional: {
                details: globalAdditionalDetails
            },
            parallelMode,
            startDate: sDate,
            markupPercent,
            discountPercent,
            realTotal: manualFinalCost > 0 ? manualFinalCost : null,
            urgencyProfileId: urgencyProfile ? urgencyProfile.id : '',
            userMarkupPercent,
            requiredFinishDate: normalizedDeadline || "",
            nalogReceipts: Array.isArray(lastCalcFullData.nalogReceipts)
                ? lastCalcFullData.nalogReceipts.map(r=>({uuid:r.uuid, canceled:!!r.canceled}))
                : [],
            nalogReceiptUuid: lastCalcFullData.receiptUuid || null,
            totalLabelsCost,
            modelsRevenue
        });
        if (existingIndex !== -1) {
            appData.calcHistory[existingIndex] = newEntry;
        } else {
            appData.calcHistory.push(newEntry);
        }
        saveToLocalStorage();
        renderHistoryTable();
        updateHistoryStats();
    }

    function findMaterialById(mid) {
        let mat = appData.materials.find(m => String(m.id) === String(mid));
        if (mat) return mat;
        for (let p of appData.printers) {
            if (Array.isArray(p.materials)) {
                mat = p.materials.find(m => String(m.id) === String(mid));
                if (mat) return mat;
            }
        }
        return null;
    }

    function findMaterialByName(name) {
        if (!name) return null;
        let mat = appData.materials.find(m => m.name === name);
        if (mat) return mat;
        for (let p of appData.printers) {
            if(Array.isArray(p.materials)){
                mat = p.materials.find(m => m.name === name);
                if (mat) return mat;
            }
        }
        return null;
    }

    function findMaterialsByProfile(profile){
        if(!profile) return [];
        const key=String(profile).toLowerCase();
        const ids = appData.materialProfiles
            .filter(p=>{
                const cfg=p.config||{};
                const nm=String(cfg.filament_settings_id||cfg.name||'').toLowerCase();
                return nm===key;
            })
            .map(p=>String(p.id));
        if(ids.length===0) return [];
        const list=[];
        const check=(m)=>Array.isArray(m.profileIds) && m.profileIds.some(id=>ids.includes(String(id)));
        appData.materials.forEach(m=>{ if(check(m)) list.push(m); });
        appData.printers.forEach(pr=>{ (pr.materials||[]).forEach(m=>{ if(check(m)) list.push(m); }); });
        return list;
    }

    async function resolveMaterialIdByProfile(profile){
        const safeProfile = (profile || '').trim();
        if(!safeProfile) return '';

        const rememberedId = PromptMemory.getMaterial(safeProfile);
        if(rememberedId){
            const mm = (appData.materials||[]).find(m=>String(m.id)===String(rememberedId));
            if(mm) return String(mm.id);
            PromptMemory.forgetMaterial(safeProfile);
        }

        const mats = findMaterialsByProfile(safeProfile);
        if(mats.length===1) return String(mats[0].id);

        if(mats.length>1){
            const options = mats.map(m => ({
                value: String(m.id),
                label: `${m.name} (ID: ${m.id}${m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : ''})`
            }));

            const res=await showMultiPrompt('–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è '+safeProfile,[
                {id:'mid',label:'–ú–∞—Ç–µ—Ä–∏–∞–ª',type:'select',options,value:options[0]?.value||''},
                {id:'remember',label:`–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è ¬´${safeProfile}¬ª`,type:'checkbox',value:false,help:'–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞/–∫–æ–º–ø—å—é—Ç–µ—Ä–∞ (LocalStorage).'}
            ]);

            if(res && res.mid){
                if(res.remember) PromptMemory.setMaterial(safeProfile, res.mid);
                return String(res.mid);
            }
        }
        return '';
    }

    function defaultOrcaConfig(){
        return {};
    }

    let currentMaterialForProfiles = null;
    function populateProfileSelect(selected){
        const sel=document.getElementById('materialProfileLinkSelect');
        sel.innerHTML='';
        appData.materialProfiles.forEach(p=>{
            const cfg=p.config||{};
            const name=String(cfg.filament_settings_id||cfg.name||p.id);
            const opt=document.createElement('option');
            opt.value=p.id;
            opt.textContent=name;
            if(selected.includes(String(p.id))) opt.selected=true;
            sel.appendChild(opt);
        });
        if(sel.options.length===0){
            const opt=document.createElement('option');
            opt.textContent='–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π';
            opt.disabled=true;
            sel.appendChild(opt);
        }
    }
    function openMaterialProfileLink(mid){
        const mat=findMaterialById(mid);
        if(!mat) return;
        if(appData.materialProfiles.length===0){
            alert('–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π Orca. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ.');
            return;
        }
        currentMaterialForProfiles=String(mid);
        populateProfileSelect((mat.profileIds||[]).map(String));
        new bootstrap.Modal(document.getElementById('materialProfileLinkModal')).show();
    }
    function applyMaterialProfileLink(){
        if(currentMaterialForProfiles===null) return;
        const mat=findMaterialById(currentMaterialForProfiles);
        if(!mat) return;
        const sel=document.getElementById('materialProfileLinkSelect');
        mat.profileIds=Array.from(sel.selectedOptions).map(o=>o.value);
        saveToLocalStorage();
        bootstrap.Modal.getInstance(document.getElementById('materialProfileLinkModal')).hide();
    }
    function renderMaterialProfilesTable(){
        const tb=document.getElementById('materialProfilesTable');
        tb.innerHTML='';
        appData.materialProfiles.forEach(p=>{
            const cfg=p.config||{};
            const name=String(cfg.filament_settings_id||cfg.name||p.id);
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${name}</td><td><button class="btn btn-sm btn-info" onclick="downloadProfileJson('${p.id}')">JSON</button> <button class="btn btn-sm btn-info ms-1" onclick="downloadProfileInfo('${p.id}')">INFO</button> <button class="btn btn-sm btn-danger ms-1" onclick="deleteMaterialProfileGlobal('${p.id}')">‚úñ</button></td>`;
            tb.appendChild(tr);
        });
    }
    function openMaterialProfilesManager(){
        renderMaterialProfilesTable();
        new bootstrap.Modal(document.getElementById('manageMaterialProfilesModal')).show();
    }
    function deleteMaterialProfileGlobal(pid){
        appData.materials.forEach(m=>{if(Array.isArray(m.profileIds)) m.profileIds=m.profileIds.filter(id=>String(id)!==String(pid));});
        appData.materialProfiles=appData.materialProfiles.filter(p=>String(p.id)!==String(pid));
        saveToLocalStorage();
        renderMaterialProfilesTable();
    }

    function renderPrinterProfilesTable(){
        const tb=document.getElementById('printerProfilesTable');
        tb.innerHTML='';
        appData.printerProfiles.forEach(p=>{
            const cfg=p.config||{};
            const pr=appData.printers.find(x=>String(x.id)===String(p.printerId));
            const prName=pr?pr.name:'?';
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${cfg.printer_settings_id||cfg.name||p.id}</td><td>${prName}</td><td><button class="btn btn-sm btn-warning me-1" onclick="reassignPrinterProfile('${p.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button><button class="btn btn-sm btn-danger" onclick="deletePrinterProfileGlobal('${p.id}')">‚úñ</button></td>`;
            tb.appendChild(tr);
        });
    }
    function openPrinterProfilesManager(){
        renderPrinterProfilesTable();
        new bootstrap.Modal(document.getElementById('managePrinterProfilesModal')).show();
    }
    async function reassignPrinterProfile(pid){
        const pf=appData.printerProfiles.find(p=>String(p.id)===String(pid));
        if(!pf) return;
        const options=appData.printers.map(pr=>({value:String(pr.id),label:pr.name}));
        const res=await showMultiPrompt('–ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å',[{id:'prid',label:'–ü—Ä–∏–Ω—Ç–µ—Ä',type:'select',options,value:pf.printerId}]);
        if(!res || !res.prid) return;
        const newPr=appData.printers.find(pr=>String(pr.id)===String(res.prid));
        if(!newPr) return;
        const oldPr=appData.printers.find(pr=>String(pr.id)===String(pf.printerId));
        if(oldPr) oldPr.profileIds=oldPr.profileIds.filter(id=>String(id)!==String(pid));
        if(!Array.isArray(newPr.profileIds)) newPr.profileIds=[];
        if(!newPr.profileIds.includes(pid)) newPr.profileIds.push(pid);
        pf.printerId=newPr.id;
        saveToLocalStorage();
        renderPrinterProfilesTable();
    }
    function deletePrinterProfileGlobal(pid){
        appData.printers.forEach(pr=>{ if(Array.isArray(pr.profileIds)) pr.profileIds=pr.profileIds.filter(id=>String(id)!==String(pid)); });
        appData.printerProfiles=appData.printerProfiles.filter(p=>String(p.id)!==String(pid));
        saveToLocalStorage();
        renderPrinterProfilesTable();
    }
    function downloadProfileJson(pid){
        const prof=appData.materialProfiles.find(p=>String(p.id)===String(pid));
        if(!prof) return;
        const cfg=prof.config||{};
        downloadBlob(new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'}),(cfg.name||cfg.filament_settings_id||'filament')+'.json');
    }
    function downloadProfileInfo(pid){
        const prof=appData.materialProfiles.find(p=>String(p.id)===String(pid));
        if(!prof) return;
        const info=prof.info||'';
        const cfg=prof.config||{};
        downloadBlob(new Blob([info],{type:'text/plain'}),(cfg.name||cfg.filament_settings_id||'filament')+'.info');
    }
    function importProfileFile(file){
        if(!file) return;
        const reader=new FileReader();
        reader.onload=()=>{
            try{ const data=JSON.parse(reader.result); appData.materialProfiles.push({id:getNextId('materialProfiles'),config:data,info:''}); saveToLocalStorage(); renderMaterialProfilesTable(); }
            catch(e){ alert('–û—à–∏–±–∫–∞: '+e); }
        };
        reader.readAsText(file);
    }

    function getTimelineEndDate(events){
        if (!Array.isArray(events) || !events.length) return null;
        let maxDate = null;
        events.forEach(evt => {
            if (evt && evt.end instanceof Date) {
                if (!maxDate || evt.end > maxDate) {
                    maxDate = evt.end;
                }
            } else if (Array.isArray(evt?.intervals) && evt.intervals.length) {
                const lastInterval = evt.intervals[evt.intervals.length - 1];
                if (lastInterval?.end && (!maxDate || lastInterval.end > maxDate)) {
                    maxDate = lastInterval.end;
                }
            }
        });
        return maxDate;
    }

    function calcFinishDate(events, fallbackStart){
        try{
            const maxDate = getTimelineEndDate(events);
            if (maxDate) {
                return maxDate.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            if (fallbackStart) {
                const d = new Date(fallbackStart);
                if (!Number.isNaN(d.getTime())) {
                    return d.toLocaleDateString('ru-RU');
                }
            }
        } catch (e) {
            console.warn('calcFinishDate error', e);
        }
        return '';
    }
    function renderHistoryTable(){
        const tb = document.querySelector("#historyTable tbody");
        tb.innerHTML = "";
        appData.calcHistory.forEach(h => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td>${h.dateStr}<\/td>
      <td>${h.id || ''}<\/td>
      <td>${h.calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}<\/td>
      <td>${h.clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}<\/td>
      <td>
        <select class="form-select form-select-sm" onchange="onChangeCalcHistoryStatus(${h.timestamp}, this.value)">
          <option value="new" ${h.orderStatus==="new"?"selected":""}>–ù–æ–≤—ã–π<\/option>
          <option value="inprogress" ${h.orderStatus==="inprogress"?"selected":""}>–í —Ä–∞–±–æ—Ç–µ<\/option>
          <option value="done" ${h.orderStatus==="done"?"selected":""}>–ó–∞–≤–µ—Ä—à—ë–Ω<\/option>
          <option value="paid" ${h.orderStatus==="paid"?"selected":""}>–û–ø–ª–∞—á–µ–Ω<\/option>
          <option value="canceled" ${h.orderStatus==="canceled"?"selected":""}>–û—Ç–º–µ–Ω—ë–Ω<\/option>
        <\/select>
      <\/td>
      <td>${safeFixed(h.total)}<\/td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="onEditCalcHistory(${h.timestamp})">–†–µ–¥–∞–∫—Ç.<\/button>
        <button class="btn btn-sm btn-danger" onclick="onDeleteCalcHistoryEntry(${h.timestamp})">–£–¥–∞–ª–∏—Ç—å<\/button>
      <\/td>
    `;
            tb.appendChild(tr);
        });
    }

    function parseHistoryDate(str){
        const [d,t] = str.split(',');
        const [day,mon,year] = d.trim().split('.');
        return new Date(`${year}-${mon}-${day}T${(t||'00:00:00').trim()}`);
    }

    function updateHistoryStats(){
        const fromVal = document.getElementById('histFrom').value;
        const toVal = document.getElementById('histTo').value;
        const from = fromVal ? new Date(fromVal) : new Date('1970-01-01');
        const to = toVal ? new Date(toVal) : new Date();
        to.setDate(to.getDate()+1);
        const list = appData.calcHistory.filter(h=>{
            const d = parseHistoryDate(h.dateStr);
            return d>=from && d<to;
        });
        const sum = list.reduce((s,h)=>s+h.total,0);
        const hrs = list.reduce((s,h)=>s+h.totalHours,0);
        const div = document.getElementById('historyStats');
        div.textContent = `–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: ${list.length}, —Å—É–º–º–∞: ${safeFixed(sum)} ‚ÇΩ, —á–∞—Å—ã –ø–µ—á–∞—Ç–∏: ${safeFixed(hrs)}`;
    }
    function onDeleteCalcHistoryEntry(timestamp) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?")) return;
        appData.calcHistory = appData.calcHistory.filter(entry => entry.timestamp !== timestamp);
        saveToLocalStorage();
        renderHistoryTable();
        updateHistoryStats();
    }

    function onChangeCalcHistoryStatus(timestamp, newStatus){
        const it = appData.calcHistory.find(x => x.timestamp === timestamp);
        if(!it) return;
        it.orderStatus = newStatus;
        saveToLocalStorage();
    }

    /* –§—É–Ω–∫—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ JSON */
    function onExportJson(){
        const s = JSON.stringify(appData, null, 2);
        document.getElementById("exportArea").value = s;
    }

    function downloadJsonFile(){
        const blob = new Blob([JSON.stringify(appData,null,2)],{type:'application/json'});
        downloadBlob(blob,'calc_data.json');
    }

    function importFromFile(){
        const inp=document.getElementById('importJsonFile');
        if(!inp.files.length) return;
        const file=inp.files[0];
        const reader=new FileReader();
        reader.onload=()=>{
            document.getElementById('importArea').value=reader.result;
            onImportJson();
        };
        reader.readAsText(file);
    }
    function onImportJson(){
        const s = document.getElementById("importArea").value.trim();
        if(!s){
            if(confirm("–ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")){
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
            return;
        }
        try{
            const obj = JSON.parse(s);
            appData = migrateOldData(obj);

            normalizeIds(appData);

            const validationResult = validateUniqueIds(appData);
            let alertMessage = "–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.";

            if (!validationResult.success) {
                alertMessage += "\n\n–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å ID, –Ω–æ –æ–Ω–∏ –±—ã–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã.";
            } else {
                alertMessage += " –í—Å–µ ID –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.";
            }

            saveToLocalStorage();
            initAll();
            alert(alertMessage);
        } catch(e){
            alert("–û—à–∏–±–∫–∞: " + e);
        }
    }
    function sanitizeProfileSchedule(profileLabel, rawSchedule) {
        const schedule = {};
        const workingDays = [];
        const errors = [];
        WEEKDAY_LABELS.forEach(day => {
            const entries = Array.isArray(rawSchedule && rawSchedule[day.value]) ? rawSchedule[day.value] : [];
            const normalized = entries
                .map((period, idx) => {
                    if (!period || (!period.start && !period.end)) return null;
                    if (!period.start || !period.end) {
                        errors.push(`${profileLabel}: ${day.label} —Å—Ç—Ä–æ–∫–∞ ${idx + 1} –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ`);
                        return null;
                    }
                    const startMin = timeStringToMinutes(period.start);
                    const endMin = timeStringToMinutes(period.end);
                    if (Number.isNaN(startMin) || Number.isNaN(endMin) || startMin >= endMin) {
                        errors.push(`${profileLabel}: ${day.label} —Å—Ç—Ä–æ–∫–∞ ${idx + 1} –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ`);
                        return null;
                    }
                    return {startMinutes: startMin, endMinutes: endMin};
                })
                .filter(Boolean)
                .sort((a, b) => a.startMinutes - b.startMinutes);
            const sanitizedDay = [];
            let dayMinutes = 0;
            let hasBreak = false;
            normalized.forEach((segment, idx) => {
                if (idx > 0 && segment.startMinutes < normalized[idx - 1].endMinutes) {
                    errors.push(`${profileLabel}: ${day.label} –∏–º–µ–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ #${idx} –∏ #${idx + 1}`);
                }
                if (idx > 0) {
                    const gap = segment.startMinutes - normalized[idx - 1].endMinutes;
                    if (gap >= 30 && gap <= 120) {
                        hasBreak = true;
                    }
                }
                sanitizedDay.push({
                    start: minutesToTimeString(segment.startMinutes),
                    end: minutesToTimeString(segment.endMinutes)
                });
                dayMinutes += segment.endMinutes - segment.startMinutes;
            });
            if (sanitizedDay.length) {
                workingDays.push(day.value);
                if (dayMinutes > 240 && !hasBreak) {
                    errors.push(`${profileLabel}: ${day.label} —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—Ä—ã–≤ 30‚Äì120 –º–∏–Ω—É—Ç –ø–æ —Å—Ç. 108 –¢–ö –†–§`);
                }
            }
            schedule[day.value] = sanitizedDay;
        });
        return {schedule, workingDays, errors};
    }

    function saveBrandingSettings(){
        captureScheduleFromInputs(currentUrgencyProfileId);
        const cn = document.getElementById("companyNameInput").value.trim();
        const cl = document.getElementById("chatLinkInput").value.trim();
        const pay = document.getElementById("bankDetailsInput").value.trim();
        const sanitizedProfiles = [];
        const errors = [];
        urgencyProfilesDraft.forEach(profile => {
            const cleanName = (profile.title || '').trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            const markup = parseFloat(profile.markupPercent) || 0;
            const description = (profile.description || '').trim();
            const {schedule, workingDays, errors: profileErrors} = sanitizeProfileSchedule(cleanName, profile.schedule || {});
            if (profileErrors.length) {
                errors.push(...profileErrors);
            }
            sanitizedProfiles.push({
                id: profile.id || `urg_${Date.now()}`,
                title: cleanName,
                markupPercent: markup,
                description,
                schedule,
                workingDays
            });
        });
        if (errors.length) {
            alert(`–ò—Å–ø—Ä–∞–≤—å—Ç–µ –≥—Ä–∞—Ñ–∏–∫:\n${errors.join('\n')}`);
            return;
        }
        appData.labelSettings.companyName = cn || "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è";
        appData.labelSettings.chatLink = cl || "https://t.me/example";
        appData.labelSettings.bankDetails = pay;
        appData.labelSettings.urgencyProfiles = sanitizedProfiles;
        if (!appData.labelSettings.urgencyProfiles.some(p => String(p.id) === String(appData.calcSettings.currentUrgencyId))) {
            appData.calcSettings.currentUrgencyId = appData.labelSettings.urgencyProfiles[0] ? appData.labelSettings.urgencyProfiles[0].id : '';
        }
        saveToLocalStorage();
        initUrgencyProfilesDraft();
        renderUrgencyProfileOptions();
        renderCalcUrgencySelect();
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
    }

    function saveCalcSettings(){
        appData.labelSettings.printLabels = document.getElementById("printLabelsCheckbox").checked;
        appData.labelSettings.costPerLabel = parseFloat(document.getElementById("labelCostInput").value) || 0;
        appData.calcSettings.operatorRate = parseFloat(document.getElementById("calcOperatorRate").value) || 0;
        appData.calcSettings.includeOperatorForRejects = document.getElementById("calcOperatorReject").checked;
        appData.calcSettings.downtimeCost = parseFloat(document.getElementById("calcDowntimeCost").value) || 0;
        appData.calcSettings.preparationRate = parseFloat(document.getElementById("calcPreparationRate").value) || 0;
        appData.calcSettings.costKwh = parseFloat(document.getElementById("calcCostKwh").value) || 0;
        appData.calcSettings.taxPercent = parseFloat(document.getElementById("calcTaxPercent").value) || 0;
        appData.calcSettings.includeEstimatePrint = document.getElementById("printEstimateCheckbox").checked;
        appData.calcSettings.estimatePrintCost = parseFloat(document.getElementById("estimatePrintCostInput").value) || 0;
        appData.calcSettings.roundingMode = document.getElementById("calcRoundingMode").value || "none";
        appData.calcSettings.includeAmortization = document.getElementById("settingsIncludeAmortization").checked;
        appData.calcSettings.includeRejects = document.getElementById("settingsIncludeRejects").checked;
        appData.calcSettings.includeOverheads = document.getElementById("settingsIncludeOverheads").checked;
        appData.calcSettings.ignoreCoolingRejects = document.getElementById("settingsIgnoreCoolingRejects").checked;
        saveToLocalStorage();
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
    }

    function onModelThumbnailChange(e, code){
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 140;
                canvas.height = 110;
                const ctx = canvas.getContext('2d');

                const targetRatio = canvas.width / canvas.height;
                const imgRatio = img.width / img.height;
                let sx, sy, sw, sh;
                if(imgRatio > targetRatio){
                    sh = img.height;
                    sw = sh * targetRatio;
                    sx = (img.width - sw) / 2;
                    sy = 0;
                } else {
                    sw = img.width;
                    sh = sw / targetRatio;
                    sx = 0;
                    sy = (img.height - sh) / 2;
                }

                ctx.drawImage(img, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                const base64 = dataUrl.split(',')[1];
                const tr = e.target.closest('tr');
                if(tr) tr.dataset.thumbnail = base64;
                let imgEl = document.getElementById('thumb_'+code);
                if(imgEl){
                    if(imgEl.tagName.toLowerCase() === 'img'){
                        imgEl.src = dataUrl;
                    } else {
                        imgEl.outerHTML = `<img id="thumb_${code}" src="${dataUrl}" style="height:40px;width:40px;object-fit:contain;border:1px solid #ccc;cursor:pointer" onclick=\"document.getElementById('thumbFile_${code}').click()\">`;
                    }
                }
                saveToLocalStorage();
            };
            img.src = reader.result;
        };
        reader.readAsDataURL(file);
    }

    /* –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞ */
    function generateQRCodeCanvas(data, size, callback){
        const tempDiv = document.createElement("div");
        new QRCode(tempDiv, {
            text: data,
            width: size,
            height: size,
            correctLevel: QRCode.CorrectLevel.H
        });
        setTimeout(() => {
            const qrCanvas = tempDiv.querySelector("canvas");
            callback(qrCanvas);
        }, 100);
    }

    function downloadThermoLabelHtml(modelName, printerName, materialName, hours, weight, thumbnail) {
        const qrSize = 100;
        generateQRCodeCanvas(appData.labelSettings.chatLink, qrSize, function(qrCanvas) {
            const qrDataUrl = qrCanvas ? qrCanvas.toDataURL("image/png") : "";
            const htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=58mm, initial-scale=1">
  <title>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/title>
  <style>
    body { width: 58mm; height: 40mm; margin: 0; padding: 0; font-family: sans-serif; }
    #labelContainer {
      width: 58mm;
      height: 40mm;
      padding: 2mm;
      box-sizing: border-box;
      position: relative;
    }
    .label-header {
      text-align: center;
      font-size: 12pt;
      font-weight: bold;
      margin-bottom: 2mm;
    }
    .label-content {
      font-size: 10pt;
      line-height: 1.2;
    }
    .label-content div { margin-bottom: 1mm; }
    .qr-code {
      position: absolute;
      bottom: 2mm;
      right: 2mm;
      width: 15mm;
      height: 15mm;
    }
    .thumb {
      position: absolute;
      bottom: 2mm;
      right: 20mm;
      width: 15mm;
      height: 15mm;
    }
  <\/style>
<\/head>
<body>
<div id="labelContainer">
  <div class="label-header">${appData.labelSettings.companyName}<\/div>
  <div class="label-content">
    <div style="text-align: center;">${modelName}<\/div>
    <div>${printerName}<\/div>
    <div>${materialName}<\/div>
    <div>${formatTimeForDisplay(hours)}<\/div>
    <div>${weight} –≥<\/div>
    <div>${new Date().toLocaleDateString("ru-RU")}<\/div>
  <\/div>
  ${thumbnail ? `<img class="thumb" src="data:image/png;base64,${thumbnail}">` : ''}
  <img class="qr-code" src="${qrDataUrl}" alt="QR-–∫–æ–¥">
  <\/div>
  <\/body>
<\/html>
    `.trim();
            const blob = new Blob([htmlContent], { type: "text/html" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `ThermoLabel_${modelName}_${Date.now()}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });
    }

    /* –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç—Ç–∏–∫–µ—Ç–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 30x20 –º–º */
    function downloadMaterialLabelHtml(materialId) {
        // –ò—â–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª —Å–Ω–∞—á–∞–ª–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö, –∑–∞—Ç–µ–º –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
        let mat = appData.materials.find(m => String(m.id) === String(materialId));
        if(!mat) {
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö, –ø—Ä–æ–≤–µ—Ä—è–µ–º —É –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
            for(let p of appData.printers) {
                if (Array.isArray(p.materials)) {
                    mat = p.materials.find(m => String(m.id) === String(materialId));
                    if(mat) break;
                }
            }
        }
        if(!mat) { alert("–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω."); return; }

        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —ç—Ç–∏–∫–µ—Ç–∫–∏ (30x20 –º–º)
        const htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=30mm, initial-scale=1">
  <title>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/title>
  <style>
    body { width: 30mm; height: 20mm; margin: 0; padding: 0; font-family: sans-serif; font-size: 8pt; }
    #labelContainer {
      width: 30mm;
      height: 20mm;
      padding: 1mm;
      box-sizing: border-box;
      position: relative;
      border: 1px solid #000;
    }
    .label-header { text-align: center; font-weight: bold; margin-bottom: 1mm; }
    .label-content div { margin-bottom: 0.5mm; }
  <\/style>
<\/head>
<body>
  <div id="labelContainer">
    <div class="label-header">${mat.name}<\/div>
    <div class="label-content">
      <div>${mat.declaredWeight || "-"} –∫–≥<\/div>
      <div>${mat.manufacturer || "-"}<\/div>
      <div>${mat.productionDate || "-"}<\/div>
    <\/div>
  <\/div>
<\/body>
<\/html>
  `.trim();

        const blob = new Blob([htmlContent], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `MaterialLabel_${mat.name}_${Date.now()}.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function buildSummaryCardHtml(data){
        return `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–°–º–µ—Ç–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:var(--bs-body-bg);color:var(--bs-body-color);font-family:'Segoe UI',Tahoma,sans-serif;padding:2rem;background-image:radial-gradient(circle at 20% 20%,var(--bs-primary-bg-subtle),transparent 60%),radial-gradient(circle at 80% 0,var(--bs-success-bg-subtle),transparent 60%);}
    .order-summary-card{max-width:1200px;margin:0 auto;background:var(--bs-light-bg-subtle);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.1);overflow:hidden;display:flex;flex-wrap:wrap;}
    .order-info{flex:1 1 300px;padding:1.5rem;background:var(--bs-secondary-bg);}
    .order-info h2{font-size:1.4rem;margin-bottom:1rem;color:var(--bs-primary);}
    .order-info .info-item{margin-bottom:.5rem;font-size:.95rem;}
    .order-info .label{font-weight:600;color:var(--bs-secondary-color);}
    .order-info .value{margin-left:.5rem;font-weight:500;}
    .order-info .qr{text-align:center;margin-bottom:1rem;}
    .order-info .qr img{width:120px;height:120px;}
    .models{flex:2 1 600px;padding:1.5rem;}
    .models-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem;}
    .model-card{background:var(--bs-light-bg-subtle);border-radius:8px;padding:1rem;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.05);transition:transform .3s ease,box-shadow .3s ease;}
    .model-card:hover{transform:translateY(-4px);box-shadow:0 4px 16px rgba(0,0,0,0.1);}
    .model-card img{width:48px;height:48px;margin-bottom:.5rem;}
    .model-card h3{font-size:1rem;margin-bottom:.5rem;color:var(--bs-primary);}
    .model-card p{font-size:.9rem;margin:.25rem 0;color:var(--bs-secondary-color);}
    .model-card p strong{color:var(--bs-body-color);}
    @media (max-width:800px){.order-summary-card{flex-direction:column;}.order-info,.models{flex:1 1 auto;}}
  </style>
</head>
<body>
<div class="order-summary-card">
  <div class="order-info">
    <h2>${data.company}</h2>
    <div class="qr"><img src="${data.qr}" alt="QR"></div>
    <div class="info-item"><span class="label">–ö–æ–¥ –∑–∞–∫–∞–∑–∞:<\/span><span class="value">${data.orderId}<\/span></div>
    <div class="info-item"><span class="label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:<\/span><span class="value">${data.orderName}<\/span></div>
    <div class="info-item"><span class="label">–ö–ª–∏–µ–Ω—Ç:<\/span><span class="value">${data.client}<\/span></div>
    <div class="info-item"><span class="label">–°—Ç–∞—Ç—É—Å:<\/span><span class="value">${data.status}<\/span></div>
    ${data.urgencyTitle ? `<div class="info-item"><span class="label">–°—Ä–æ—á–Ω–æ—Å—Ç—å:<\/span><span class="value">${data.urgencyTitle}${data.urgencyProfileMarkup ? ` (+${data.urgencyProfileMarkup}% )` : ''}${data.urgencyUserMarkup ? `, —Ä—É—á–Ω–∞—è ${data.urgencyUserMarkup}%` : ''}<\/span></div>` : ''}
    <div class="info-item"><span class="label">–û–±—â–µ–µ –≤—Ä–µ–º—è –ø–µ—á–∞—Ç–∏:<\/span><span class="value">${data.totalTime}<\/span></div>
	<div class="info-item"><span class="label">–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:<\/span><span class="value">${data.totalTimeOperator}<\/span></div>
    <div class="info-item"><span class="label">–°—É–º–º–∞—Ä–Ω—ã–π –≤–µ—Å:</span><span class="value">${data.totalWeight} –≥</span></div>
    ${data.services && data.services.length ? data.services.map(s => `<div class="info-item"><span class="label">${s.name}:<\/span><span class="value">${s.total} ‚ÇΩ<\/span></div>`).join('') + `<div class="info-item"><span class="label">–ò—Ç–æ–≥–æ —É—Å–ª—É–≥–∏:<\/span><span class="value">${data.servicesTotal} ‚ÇΩ<\/span></div>` : ''}
    <div class="info-item"><span class="label">–ò—Ç–æ–≥–æ:<\/span><span class="value">${data.priceOld ? `<del>${data.priceOld} ‚ÇΩ<\/del> ${data.totalCost} ‚ÇΩ (-${data.discountPercent}% )` : `${data.totalCost} ‚ÇΩ`}<\/span></div>
    <div class="info-item"><span class="label">–¶–µ–Ω–∞ –∑–∞ 1 –≥—Ä–∞–º–º:<\/span><span class="value">${data.pricePerGram} ‚ÇΩ<\/span></div>
    ${data.paymentInfo ? `<div class="info-item"><span class="label">–û–ø–ª–∞—Ç–∞:<\/span><span class="value">${data.paymentInfo}<\/span></div>` : ''}
    ${data.finDate ? `<div class="info-item"><span class="label">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:<\/span><span class="value">${data.finDate}<\/span></div>` : ''}
  <\/div>
  <div class="models">
    <div class="models-grid">${data.modelsHtml}<\/div>
  <\/div>
<\/div>
</body>
</html>`;
    }

    function downloadSummaryCardHtml(){
        if(!lastSummaryCardHtml){alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.');return;}
        const blob=new Blob([lastSummaryCardHtml],{type:'text/html'});
        downloadBlob(blob, `Estimate_${Date.now()}.html`);
    }

    function generateDeviceId(len=16){
        const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let out='';
        for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
        return out;
    }

    function buildPaymentQrString(){
        return appData.labelSettings.chatLink || '';
    }

    async function refreshMyNalogToken(){
        const refresh = localStorage.getItem('my_nalog_refresh');
        const deviceId = localStorage.getItem('my_nalog_device_id');
        if(!refresh || !deviceId) return false;
        const body={
            refreshToken: refresh,
            deviceInfo:{
                sourceDeviceId: deviceId,
                sourceType:'WEB',
                appVersion:'1.0.0',
                metaDetails:{userAgent:navigator.userAgent}
            }
        };
        try{
            const resp = await fetch(MY_NALOG_API+'/api/v1/auth/token',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
            if(resp.ok){
                const data = await resp.json();
                if(data.token){
                    localStorage.setItem('my_nalog_token', data.token);
                    if(data.refreshToken) localStorage.setItem('my_nalog_refresh', data.refreshToken);
                    return true;
                }
            }
        }catch(e){
            console.error('token refresh failed');
        }
        return false;
    }

    async function sendMyNalogRequest(method,url,body){
        let token = localStorage.getItem('my_nalog_token');
        if(!token) throw new Error('no token');
        const opt={method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}};
        if(body) opt.body=JSON.stringify(body);
        let resp = await fetch(url,opt);
        if(resp.status===401){
            const ok = await refreshMyNalogToken();
            if(ok){
                token = localStorage.getItem('my_nalog_token');
                opt.headers['Authorization']='Bearer '+token;
                resp = await fetch(url,opt);
            }
        }
        return resp;
    }

    async function cancelReceiptInternal(receipt, comment){
        if(!receipt || !receipt.uuid) return false;
        const payload = {
            receiptUuid: receipt.uuid,
            comment: comment || '',
            partnerCode: null,
            requestTime: new Date().toISOString()
        };
        try{
            const resp = await sendMyNalogRequest('POST',MY_NALOG_API+'/api/v1/cancel',payload);
            if(resp.ok){
                receipt.canceled = true;
                const idx = appData.calcHistory.findIndex(e=>String(e.id)===String(lastCalcFullData.id));
                if(idx!==-1 && Array.isArray(appData.calcHistory[idx].nalogReceipts)){
                    const arr = appData.calcHistory[idx].nalogReceipts;
                    const j = arr.findIndex(r=>r.uuid===receipt.uuid);
                    if(j!==-1) arr[j].canceled = true;
                    saveToLocalStorage();
                    renderHistoryTable();
                }
                return true;
            }
        }catch(e){
        }
        return false;
    }

    function showCheckLinkModal(checkUrl) {
        document.getElementById('checkLinkInput').value = checkUrl;
        const modal = new bootstrap.Modal(document.getElementById('checkLinkModal'));
        modal.show();
    }

    async function sendMyNalogReceipt(){
        if(!lastCalcFullData){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–∞.'); return; }
        if(!Array.isArray(lastCalcFullData.nalogReceipts)) lastCalcFullData.nalogReceipts = [];
        if(lastCalcFullData.nalogReceipts.length){
            const last = lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1];
            const inn = localStorage.getItem('my_nalog_inn') || '';
            const url = inn ? `https://lknpd.nalog.ru/api/v1/receipt/${inn}/${last.uuid}/print` : '';
            const force = confirm('–ß–µ–∫ —É–∂–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω' + (url ? '\n'+url : '') + '\n–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å?');
            if(!force) return;
            await cancelReceiptInternal(last, '–æ—à–∏–±–æ—á–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ');
        }
        const btn = document.getElementById('sendMyNalogBtn');
        if(btn) btn.disabled = true;
        const payload = {
            operationTime: new Date().toISOString(),
            requestTime: new Date().toISOString(),
            services: [{ name: `–ü–µ—á–∞—Ç—å –Ω–∞ 3–¥-–ø—Ä–∏–Ω—Ç–µ—Ä–µ "${lastCalcFullData.calcName || ''}" #${lastCalcFullData.id || ''}`, amount: lastCalcFullData.total, quantity: 1 }],
            totalAmount: lastCalcFullData.total,
            paymentType: 'CASH',
            ignoreMaxTotalIncomeRestriction: false,
            client: { contactPhone: null, displayName: null, incomeType: 'FROM_INDIVIDUAL', inn: null }
        };
        try {
            const resp = await sendMyNalogRequest('POST',MY_NALOG_API+'/api/v1/income',payload);
            if(resp.ok){
                const data = await resp.json().catch(()=>null);
                if(data?.approvedReceiptUuid){
                    console.log(data);
                    const inn = localStorage.getItem('my_nalog_inn') || '';
                    lastCalcFullData.receiptUuid = data.approvedReceiptUuid;
                    lastCalcFullData.orderStatus = 'paid';
                    document.getElementById('calcOrderStatus').value = 'paid';
                    toggleFinalFields('paid');
                    const idx = appData.calcHistory.findIndex(e=>String(e.id)===String(lastCalcFullData.id));
                    if(idx!==-1){
                        const recList = Array.isArray(appData.calcHistory[idx].nalogReceipts)
                            ? appData.calcHistory[idx].nalogReceipts.map(r=>({uuid:r.uuid, canceled:!!r.canceled}))
                            : [];
                        recList.push({uuid:data.approvedReceiptUuid, canceled:false});
                        appData.calcHistory[idx].nalogReceipts = recList;
                        appData.calcHistory[idx].nalogReceiptUuid = data.approvedReceiptUuid;
                        appData.calcHistory[idx].orderStatus = 'paid';
                    }
                    if(!Array.isArray(lastCalcFullData.nalogReceipts)) lastCalcFullData.nalogReceipts = [];
                    lastCalcFullData.nalogReceipts.push({uuid:data.approvedReceiptUuid,canceled:false});


                    saveToLocalStorage();
                    if(idx!==-1){
                        renderHistoryTable();
                    }
                    const cancelBtn=document.getElementById('cancelMyNalogBtn');
                    if(cancelBtn) cancelBtn.style.display='inline-block';
                    if(btn) btn.disabled = false;
                    alert('–ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
                    const receiptUrl = inn ? `https://lknpd.nalog.ru/api/v1/receipt/${inn}/${data.approvedReceiptUuid}/print` : '';
                    showCheckLinkModal(receiptUrl);

                }else{
                    alert('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ú–æ–π –ù–∞–ª–æ–≥');
                }
            }else{
                const text = await resp.text().catch(()=>resp.status);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: '+text);
            }
        }catch(e){
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–∏—Å—É –ú–æ–π –ù–∞–ª–æ–≥');
        }finally{
            if(btn) btn.disabled = false;
        }
    }

    async function cancelMyNalogReceipt(){
        if(!lastCalcFullData || !Array.isArray(lastCalcFullData.nalogReceipts) || !lastCalcFullData.nalogReceipts.length){
            alert('–ù–µ—Ç —á–µ–∫–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã.');
            return;
        }
        const last = lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1];
        const comment = prompt('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã —á–µ–∫a:','');
        if (!comment || !comment.trim()) {
            alert('–ù–µ —É–∫–∞–∑–∞–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã —á–µ–∫–∞.\n–ß–µ–∫ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω—ë–Ω.');
            return;
        }
        const btn=document.getElementById('cancelMyNalogBtn');
        if(btn) btn.disabled=true;
        const ok = await cancelReceiptInternal(last, comment || '');
        if(ok){
            lastCalcFullData.orderStatus='canceled';
            const idx=appData.calcHistory.findIndex(e=>String(e.id)===String(lastCalcFullData.id));
            if(idx!==-1){
                appData.calcHistory[idx].orderStatus='canceled';
                saveToLocalStorage();
                renderHistoryTable();
            }
            const cancelBtn=document.getElementById('cancelMyNalogBtn');
            const showCancel = lastCalcFullData.nalogReceipts.length && !lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1].canceled;
            if(cancelBtn) cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
            alert('–ß–µ–∫ –æ—Ç–º–µ–Ω—ë–Ω.');
        }else{
            alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã —á–µ–∫–∞');
        }
        if(btn) btn.disabled=false;
    }

    function saveMyNalogSettings(){
        const token = document.getElementById('myNalogToken').value.trim();
        localStorage.setItem('my_nalog_token', token);
        const phoneEl = document.getElementById('myNalogPhone');
        if(phoneEl) localStorage.setItem('my_nalog_phone', phoneEl.value.trim());
        alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    }

    async function checkMyNalogStatus() {
        const token = localStorage.getItem('my_nalog_token');
        const statusEl = document.getElementById('myNalogStatus');
        if (!token) {
            statusEl.textContent = '–¢–æ–∫–µ–Ω –Ω–µ –∑–∞–¥–∞–Ω';
            return;
        }
        statusEl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
        try {
            const resp = await sendMyNalogRequest('GET', MY_NALOG_API + '/api/v1/user');
            if (resp.ok) {
                const data = await resp.json();
                if (data.health === "false") {

                    statusEl.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.message}`;
                } else if(data.displayName) {
                    statusEl.innerHTML = `<i class="bi bi-check-square me-2"></i>–ò–ù–ù ${data.inn} ${data.displayName}`;
                    localStorage.setItem('my_nalog_inn', data.inn || '');
                } else {
                    statusEl.textContent = '–°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω';
                }
            } else {
                statusEl.textContent = '–û—à–∏–±–∫–∞: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å';
            }
        } catch (e) {
            statusEl.textContent = '–û—à–∏–±–∫–∞: –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
        }
    }

    async function requestMyNalogSms(){
        const phoneNum = document.getElementById('myNalogPhone').value.trim();
        const statusEl = document.getElementById('myNalogStatus');
        if(!phoneNum){
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω');
            return;
        }
        statusEl.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ SMS...';
        try{
            const resp = await fetch(MY_NALOG_API+'/api/v1/auth/challenge/sms/start', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({phone: phoneNum, requireTpToBeActive: true})
            });
            if(resp.ok){
                const data = await resp.json();
                myNalogChallengeToken = data.challengeToken;
                statusEl.textContent = 'SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
            }else{
                const text = await resp.text().catch(()=>resp.status);
                statusEl.textContent = '–û—à–∏–±–∫–∞: ' + text;
            }
        }catch(e){
            statusEl.textContent = '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
        }
    }

    async function confirmMyNalogSms(){
        const phoneNum = document.getElementById('myNalogPhone').value.trim();
        const code = document.getElementById('myNalogSms').value.trim();
        const statusEl = document.getElementById('myNalogStatus');
        if(!phoneNum || !code){
            alert('–ù—É–∂–µ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –∫–æ–¥');
            return;
        }
        statusEl.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ...';
        try{
            const challenge = myNalogChallengeToken || '';
            const deviceId = localStorage.getItem('my_nalog_device_id') || generateDeviceId();
            localStorage.setItem('my_nalog_device_id', deviceId);
            const body = {
                phone: phoneNum,
                code,
                challengeToken: challenge,
                deviceInfo:{
                    sourceDeviceId: deviceId,
                    sourceType:'WEB',
                    appVersion:'1.0.0',
                    metaDetails:{userAgent:navigator.userAgent}
                }
            };
            const resp = await fetch(MY_NALOG_API+'/api/v1/auth/challenge/sms/verify', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(body)
            });
            if(resp.ok){
                const data = await resp.json().catch(()=>null);
                if(data?.token){
                    localStorage.setItem('my_nalog_token', data.token);
                    localStorage.setItem('my_nalog_refresh', data.refreshToken || '');
                    document.getElementById('myNalogToken').value = data.token;
                    if(data.inn){
                        localStorage.setItem('my_nalog_inn', data.inn);
                    } else {
                        await checkMyNalogStatus();
                    }
                    statusEl.textContent = '–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω';
                }else{
                    statusEl.textContent = '–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
                }
            }else{
                const text = await resp.text().catch(()=>resp.status);
                statusEl.textContent = '–û—à–∏–±–∫–∞: ' + text;
            }
        }catch(e){
            statusEl.textContent = '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
        }
    }

    function loadMyNalogSettings(){
        const token = localStorage.getItem('my_nalog_token') || '';
        const inp = document.getElementById('myNalogToken');
        if(inp) inp.value = token;
        const savedPhone = localStorage.getItem('my_nalog_phone') || '';
        const phoneInp = document.getElementById('myNalogPhone');
        if(phoneInp) phoneInp.value = savedPhone;
        if(token) checkMyNalogStatus();
    }
    function downloadBlob(blob, filename){
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
    function startNewCalculation(){
        document.getElementById("calcName").value="";
        resetCalcClientSelector();
        document.getElementById("calcOrderStatus").value="new";
        setCalcOrderId("");
        document.getElementById("calcDiscountPercent").value = 0;
        document.getElementById("calcFinalCost").value = "";
        toggleFinalFields('new');
        document.getElementById("calcStartDate").value = getTodayIsoDate();
        const deadlineInput = document.getElementById("calcDeadlineDate");
        if (deadlineInput) {
            deadlineInput.value = "";
        }
        appData.calcSettings.deadlineDate = "";
        document.getElementById("calcPreparationTime").value = appData.calcSettings.preparationTime ? formatTimeForDisplay(appData.calcSettings.preparationTime) : "";
        lastCalcFullData = null;
        appData.printers.forEach(pr=>{
            const table=document.getElementById(`calcModelsTable_${pr.id}`);
            if(table) table.querySelector("tbody").innerHTML="";
        });
        ['downloadSummaryCardBtn','sendMyNalogBtn','cancelMyNalogBtn'].forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.style.display = 'none';
        });
    }

    function toggleFinalFields(val){
        const group=document.getElementById('finalCostGroup');
        if(group){
            group.classList.toggle('d-none', val !== 'done' && val !== 'paid');
        }
    }


    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OrcaSlicer –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ */
    let currentOrcaPrinterId = null;
    let currentOrcaProfileIndex = 0;
    const ORCA_PRINTER_FIELDS = [];

    function populateOrcaProfileSelect(pr){
        const sel=document.getElementById('orcaProfileSelect');
        sel.innerHTML='';
        (pr.profileIds||[]).forEach((pid,i)=>{
            const pf=appData.printerProfiles.find(p=>String(p.id)===String(pid));
            const cfg=pf?pf.config||{}:{};
            const opt=document.createElement('option');
            opt.value=i;
            opt.textContent=cfg.printer_settings_id||cfg.name||('–ü—Ä–æ—Ñ–∏–ª—å '+(i+1));
            sel.appendChild(opt);
        });
    }

    function loadOrcaProfile(pr,index){
        currentOrcaProfileIndex=index;
        const pid=pr.profileIds[index];
        const profile=appData.printerProfiles.find(p=>String(p.id)===String(pid));
        const cfg=profile?profile.config||{}:{};
        document.getElementById('orcaPrinterJsonView').textContent=JSON.stringify(cfg,null,2);
        document.getElementById('orcaPrinterInfoView').textContent=profile?profile.info||'':'';
        document.getElementById('orcaProfileSelect').value=index;
    }

    function openPrinterOrca(id){
        const pr=appData.printers.find(p=>String(p.id)===String(id));
        if(!pr) return;
        currentOrcaPrinterId=String(id);
        if(!Array.isArray(pr.profileIds)) pr.profileIds=[];
        if(pr.profileIds.length===0){
            const pf={id:getNextId('printerProfiles'),config:{},info:'',printerId:String(pr.id)};
            appData.printerProfiles.push(pf);
            pr.profileIds.push(pf.id);
        }
        populateOrcaProfileSelect(pr);
        loadOrcaProfile(pr,0);
        new bootstrap.Modal(document.getElementById('orcaPrinterModal')).show();
    }




    function deleteOrcaProfile(){
        if(currentOrcaPrinterId===null) return;
        const pr=appData.printers.find(p=>String(p.id)===String(currentOrcaPrinterId));
        if(!pr) return;
        if(pr.profileIds.length<=1) return;
        const pid=pr.profileIds.splice(currentOrcaProfileIndex,1)[0];
        appData.printerProfiles=appData.printerProfiles.filter(p=>String(p.id)!==String(pid));
        const idx=Math.max(0,currentOrcaProfileIndex-1);
        populateOrcaProfileSelect(pr);
        loadOrcaProfile(pr,idx);
    }

    function downloadFullDetailedCalculation(){
        if(!lastCalcFullData){ alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–∞."); return; }
        const h = generateMaxDetailedCalcHtml(lastCalcFullData);
        const b = new Blob([h], {type:"text/html"});
        const u = URL.createObjectURL(b);
        const l = document.createElement("a");
        l.href = u;
        l.download = `FullDetailedCalc_${Date.now()}.html`;
        document.body.appendChild(l);
        l.click();
        document.body.removeChild(l);
        URL.revokeObjectURL(u);
    }
    function generateMaxDetailedCalcHtml(d) {
        const totalCost = typeof d.total === 'number' ? d.total : parseFloat(d.total) || 0;
        const discountPercent = typeof d.discountPercent === 'number' ? d.discountPercent : 0;
        const hasDiscount = discountPercent > 0 && discountPercent < 100;
        const computedPriceBeforeDiscount = hasDiscount ? totalCost / (1 - discountPercent / 100) : null;
        const priceBeforeDiscount = computedPriceBeforeDiscount || d.priceBeforeDiscount || null;
        const totalTaxAmount = typeof d.taxAmount === 'number' ? d.taxAmount : 0;
        const subtotalWithoutTax = totalCost - totalTaxAmount;
        const urgencyProfiles = (appData.labelSettings && Array.isArray(appData.labelSettings.urgencyProfiles))
            ? appData.labelSettings.urgencyProfiles
            : [];
        const matchedProfile = urgencyProfiles.find(p => String(p.id) === String(d.urgencyProfileId));
        const profileTitle = matchedProfile ? matchedProfile.title : (d.urgencyProfileTitle || '');
        const profileMarkupPercent = matchedProfile
            ? (parseFloat(matchedProfile.markupPercent) || 0)
            : (typeof d.profileMarkupPercent === 'number' ? d.profileMarkupPercent : 0);
        const manualMarkupPercent = typeof d.userMarkupPercent === 'number' ? d.userMarkupPercent : 0;
        let s = `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç<\/title>
  <style>
    body { font-family: sans-serif; margin:20px; }
    .printer-block { margin:10px 0; padding:5px; border:1px dashed #999; }
    table { border-collapse: collapse; }
    td, th { border:1px solid #999; padding:4px 6px; }
  <\/style>
<\/head>
<body>
  <h1>–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç<\/h1>
  <p>–ù–∞–∑–≤–∞–Ω–∏–µ: ${d.calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}, –ö–ª–∏–µ–Ω—Ç: ${d.clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}, –°—Ç–∞—Ç—É—Å: ${getOrderStatusLabel(d.orderStatus)}<\/p>
  <p>–°—Ä–æ—á–Ω–æ—Å—Ç—å: ${profileTitle || '‚Äî'}${profileMarkupPercent ? ` (+${profileMarkupPercent}% )` : ''}${manualMarkupPercent ? `, —Ä—É—á–Ω–∞—è ${manualMarkupPercent}%` : ''}<\/p>
  <p>–ò—Ç–æ–≥: <strong>${safeFixed(totalCost)} ‚ÇΩ<\/strong>${priceBeforeDiscount ? ` (—Å–∫–∏–¥–∫–∞ ${discountPercent}% –æ—Ç ${safeFixed(priceBeforeDiscount)} ‚ÇΩ)` : ''}<\/p>
  <p>–û–ø–µ—Ä–∞—Ç–æ—Ä —á.: ${formatTimeForDisplay(d.totalHours)} —á, –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${safeFixed(d.totalOperatorCost)} ‚ÇΩ, –ù–∞–ª–æ–≥: ${d.taxPercent}%, –£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞: ${d.shipping}‚ÇΩ, –≠—Ç–∏–∫–µ—Ç–∫–∏: ${safeFixed(d.totalLabelsCost || 0)} ‚ÇΩ, –≠–ª.: ${d.costKwh}‚ÇΩ/–∫–í—Ç‚ãÖ—á<\/p>
  <p>–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø–µ—á–∞—Ç—å: ${d.parallelMode}, –ù–∞—Ü–µ–Ω–∫–∞: ${d.markupPercent || 0}%<\/p>
  <p>–ü–æ–¥–∏—Ç–æ–≥: ${safeFixed(subtotalWithoutTax)} ‚ÇΩ, –û–±—â–∏–π –Ω–∞–ª–æ–≥: ${safeFixed(totalTaxAmount)} ‚ÇΩ<\/p>
  <hr/>
`;
        d.detailsByPrinter.forEach(pr => {
            s += `<div class="printer-block">
      <strong>–ü—Ä–∏–Ω—Ç–µ—Ä: ${pr.printerName} (ID: ${pr.printerId})<\/strong><br/>
      –í—Ä–µ–º—è: ${formatTimeForDisplay(pr.printerTime)} —á<br/>
    `;
            if(pr.linesDetail && pr.linesDetail.length>0){
                s += `<table style="margin-top:5px;">
        <thead><tr>
          <th>–ú–æ–¥–µ–ª—å<\/th>
          <th>–ò–∫–æ–Ω–∫–∞<\/th>
          <th>–°—Ç–∞—Ç—É—Å<\/th>
          <th>–ß–∞—Å—ã<\/th>
          <th>–í–µ—Å (–≥)<\/th>
          <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
          <th>–°—É–º–º–∞<\/th>
        <\/tr><\/thead>
        <tbody>`;
                pr.linesDetail.forEach(ln => {
                    s += `<tr>
          <td>${ln.name} (${ln.id || ''})${ln.excludedFromTotals ? ' <span style="color:#999;">(–Ω–µ –≤ —Ä–∞—Å—á—ë—Ç–µ)<\/span>' : ''}<\/td>
          <td>${ln.thumbnail ? `<img src="data:image/png;base64,${ln.thumbnail}" style="height:40px;"/>` : ''}<\/td>
          <td>${getModelStatusLabel(ln.status)}${getModelQualityLabel(ln.status) ? ` ‚Äî ${getModelQualityLabel(ln.status)}` : ''}<\/td>
          <td>${safeFixed(ln.hours)}<\/td>
          <td>${safeFixed(ln.realWeight)}<\/td>
          <td>${ln.matName}<\/td>
          <td>${safeFixed(ln.subTotalModel)}<\/td>
        <\/tr>`;
                });
                s += `<\/tbody><\/table>`;
            }
            s += `<\/div>`;
        });
        s += `<\/body><\/html>`;
        return s;
    }
    function onEditCalcHistory(timestamp){
        const it = appData.calcHistory.find(x => x.timestamp === timestamp);
        if(!it){ alert("–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏"); return; }

        const missing = [];
        if(it.calcData){
            for(const pid in it.calcData){
                if(!appData.printers.find(p=>String(p.id)===String(pid))) missing.push(pid);
            }
        }
        if(missing.length){
            const opts = appData.printers.map(p=>({value:String(p.id),label:p.name||p.id}));
            const fields = missing.map(id=>({id:id,label:`–ü—Ä–∏–Ω—Ç–µ—Ä –¥–ª—è ${id}`,type:'select',options:opts}));
            showMultiPrompt('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∏–Ω—Ç–µ—Ä—ã', fields).then(vals=>{
                if(!vals) return;
                missing.forEach(id=>{
                    const newId = vals[id];
                    if(newId && it.calcData[id]){
                        it.calcData[newId] = (it.calcData[newId]||[]).concat(it.calcData[id]);
                    }
                    delete it.calcData[id];
                });
                onEditCalcHistory(timestamp);
            });
            return;
        }
        setCalcOrderId(it.id || "");
        document.getElementById("calcName").value = it.calcName || "";
        applyClientSelection(it.clientId || '', it.clientName || "");
        document.getElementById("calcOrderStatus").value = it.orderStatus || "new";
        document.getElementById("calcOperatorRate").value = it.operatorRate || "";
        document.getElementById("calcCostKwh").value = it.costKwh || "";
        document.getElementById("calcTaxPercent").value = it.taxPercent || "";
        document.getElementById("calcShipping").value = it.shipping || "";
        document.getElementById("calcStartDate").value = normalizeDateTimeLocal(it.startDate);
        const deadlineInput = document.getElementById("calcDeadlineDate");
        if (deadlineInput) {
            deadlineInput.value = it.requiredFinishDate ? normalizeDateTimeLocal(it.requiredFinishDate) : "";
        }
        document.getElementById("calcParallelPrinting").value = it.parallelMode || "no";
        const manualMarkup = typeof it.userMarkupPercent === 'number' ? it.userMarkupPercent : (it.markupPercent || 0);
        document.getElementById("calcMarkupPercent").value = manualMarkup;
        const urgencySelectEl = document.getElementById('calcUrgencyProfile');
        if (urgencySelectEl && it.urgencyProfileId) {
            urgencySelectEl.value = it.urgencyProfileId;
            appData.calcSettings.currentUrgencyId = it.urgencyProfileId;
            urgencySelectEl.dispatchEvent(new Event('change'));
        }
        document.getElementById("calcDiscountPercent").value = it.discountPercent || 0;
        document.getElementById("calcFinalCost").value = it.realTotal || '';
        toggleFinalFields(it.orderStatus || 'new');
        appData.calcSettings.customServices = it.services ? it.services.map(s=>({...s})) : [];
        renderCustomServicesTable();

        if(it.calcData){
            for(const printerId in it.calcData){
                const table = document.getElementById(`calcModelsTable_${printerId}`);
                if(!table) continue;
                const tbody = table.querySelector("tbody");
                tbody.innerHTML = "";
                const prIdNum = isNaN(printerId) ? printerId : parseInt(printerId, 10);
                it.calcData[printerId].forEach(model => {
                    addModelRow(prIdNum, model);
                });
            }
        }
        const tabEl = document.querySelector('#calculate-tab');
        const tab = new bootstrap.Tab(tabEl);
        tab.show();
    }

    function ensureIconsLoaded() {
        if (!document.querySelector('link[href*="bootstrap-icons"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css';
            document.head.appendChild(link);
        }
    }

    function onSummaryPeriodChange(){
        const val = document.getElementById('summaryPeriod').value;
        const fromInput = document.getElementById('summaryFrom');
        const toInput = document.getElementById('summaryTo');
        const applyBtn = document.getElementById('summaryApplyBtn');
        const showCustom = val === 'custom';
        fromInput.classList.toggle('d-none', !showCustom);
        toInput.classList.toggle('d-none', !showCustom);
        applyBtn.classList.toggle('d-none', !showCustom);
        if(!showCustom){
            renderSummary();
        }
    }

    function renderSummary() {
        ensureIconsLoaded();
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const formatCurrency = (value) => new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);

        const formatNumber = (value, decimals = 2) =>
            new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);

        const period = document.getElementById('summaryPeriod').value;
        let to = new Date();
        let from = new Date(to);
        if(period === 'week'){
            from.setDate(from.getDate() - 7);
        } else if(period === 'month'){
            from.setMonth(from.getMonth() - 1);
        } else if(period === 'year'){
            from.setFullYear(from.getFullYear() - 1);
        } else if(period === 'custom'){
            const fv = document.getElementById('summaryFrom').value;
            const tv = document.getElementById('summaryTo').value;
            if(fv) from = new Date(fv);
            if(tv){ to = new Date(tv); to.setDate(to.getDate()+1); }
        } else if(period === 'all'){
            from = new Date('1970-01-01');
        }

        const periodMs = Math.max(1, to.getTime() - from.getTime());
        const periodDays = periodMs / (1000 * 60 * 60 * 24);

        // 1. –†–∞—Å—á–µ—Ç –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π
        const calculateCapitalInvestments = () => {
            const printersCost = appData.printers.reduce((sum, p) => sum + (p.cost || 0), 0);
            const materials = appData.materials.reduce((acc, m) => {
                const weight = m.declaredWeight || 0;
                const cost = (m.costPerKg || 0) * weight;
                acc.cost += cost;
                acc.weight += weight;
                return acc;
            }, { cost: 0, weight: 0 });
            const additional = appData.additionalGlobal.reduce((sum, a) => sum + (a.cost || 0), 0);
            const total = printersCost + materials.cost + additional;
            return {
                printersCost,
                materialsCost: materials.cost,
                materialsWeight: materials.weight,
                additionalCost: additional,
                total
            };
        };

        // 2. –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        const analyzeCompletedOrders = (fromDate, toDate) => {
            const completedOrders = appData.calcHistory
                .filter(o => {
                    const ts = o.timestamp || (o.dateStr ? parseHistoryDate(o.dateStr).getTime() : 0);
                    return (o.orderStatus === "done" || o.orderStatus === "paid") && ts >= fromDate.getTime() && ts < toDate.getTime();
                })
                .sort((a, b) => {
                    const tsA = a.timestamp || (a.dateStr ? parseHistoryDate(a.dateStr).getTime() : 0);
                    const tsB = b.timestamp || (b.dateStr ? parseHistoryDate(b.dateStr).getTime() : 0);
                    return tsA - tsB;
                });
            const results = {
                totalRevenue: 0,
                totalTax: 0,
                totalCost: 0,
                totalPrintHours: 0,
                totalElectricityCost: 0,
                totalOperatorExpenses: 0,
                totalServiceCost: 0,
                totalShippingCost: 0,
                totalAdditionalCost: 0,
                totalLabelsCost: 0,
                totalMaterialCost: 0,
                totalPrinterCost: 0,
                totalMaintenanceCost: 0,
                totalRejectHours: 0,
                totalRejectGrams: 0,
                totalDowntimeMinutes: 0,
                totalCoolingMinutes: 0,
                totalModels: 0,
                smallBatchOrders: 0,
                batchSizes: [],
                materialStats: {},
                printerStats: {},
                clientStats: {},
                additionalStats: {},
                completedOrdersCount: completedOrders.length,
                totalPrepMinutes: 0
            };

            const ensureAdditionalStat = (source) => {
                if (!source) return null;
                const rawId = source.id ?? source;
                if (rawId === undefined || rawId === null || rawId === '') return null;
                const id = String(rawId);
                if (!results.additionalStats[id]) {
                    const baseCost = parseFloat(source.cost ?? source.baseCost) || 0;
                    results.additionalStats[id] = {
                        id,
                        name: source.description || source.name || `–†–∞—Å—Ö–æ–¥ #${id}`,
                        baseCost,
                        distributed: 0,
                        orders: 0
                    };
                } else if ((source.cost !== undefined || source.baseCost !== undefined) && results.additionalStats[id].baseCost === 0) {
                    const baseCost = parseFloat(source.cost ?? source.baseCost);
                    if (!isNaN(baseCost)) {
                        results.additionalStats[id].baseCost = baseCost;
                    }
                }
                return results.additionalStats[id];
            };

            (appData.additionalGlobal || []).forEach(add => ensureAdditionalStat(add));

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
            appData.printers.forEach(p => {
                results.printerStats[p.id] = {
                    name: p.name,
                    hours: 0,
                    amortization: 0,
                    energy: 0,
                    material: 0,
                    maintenance: 0,
                    revenue: 0,
                    prints: 0,
                    grams: 0,
                    rejectHours: 0,
                    rejectGrams: 0,
                    prepMinutes: 0
                };
            });

            completedOrders.forEach(order => {
                results.totalRevenue += order.total || 0;
                let orderCost = 0;
                let orderGrams = 0;
                let orderModelCount = 0;
                const orderMaterialGrams = {};

                // –†–∞—Å—á–µ—Ç –Ω–∞–ª–æ–≥–æ–≤
                if (order.taxAmount !== undefined) {
                    results.totalTax += order.taxAmount;
                } else if (order.taxPercent !== undefined && order.taxPercent > 0) {
                    results.totalTax += order.total * (order.taxPercent / 100);
                }

                // –£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                results.totalOperatorExpenses += order.totalOperatorCost || 0;

                // –£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ —É—Å–ª—É–≥–∏
                const serviceCost = order.servicesTotal || 0;
                results.totalServiceCost += serviceCost;

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
                order.details?.forEach(printer => {
                    const printerId = printer.printerId;

                    if (!results.printerStats[printerId]) {
                        results.printerStats[printerId] = {
                            name: printer.printerName,
                            hours: 0,
                            amortization: 0,
                            energy: 0,
                            material: 0,
                            maintenance: 0,
                            revenue: 0,
                            prints: 0,
                            grams: 0,
                            rejectHours: 0,
                            rejectGrams: 0
                        };
                    }

                    printer.linesDetail?.forEach(model => {
                        const materialId = model.materialData?.id;
                        const materialCost = model.costMaterial || 0;
                        const amortization = model.costPrinterPart || 0;
                        const electric = model.costElectric || 0;
                        const maintenance = model.costMaintenance || 0;
                        const modelRevenue = model.subTotalModel || 0;
                        const hours = model.hours || 0;
                        const status = model.status;
                        const ps = results.printerStats[printerId];
                        if (status === 'reject') {
                            results.totalRejectHours += hours;
                            results.totalRejectGrams += model.realWeight || 0;
                            ps.rejectHours += hours;
                            ps.rejectGrams += model.realWeight || 0;
                        }

                        if (model.excludedFromTotals) {
                            return;
                        }
                        const prepMinutes = model.printerPrepMinutes || 0;

                        orderModelCount += 1;
                        orderGrams += model.realWeight || 0;
                        if (materialId) {
                            orderMaterialGrams[materialId] = (orderMaterialGrams[materialId] || 0) + (model.realWeight || 0);
                        }

                        if (materialId) {
                            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
                            if (!results.materialStats[materialId]) {
                                const mat = findMaterialById(materialId);
                                results.materialStats[materialId] = {
                                    name: mat ? `${mat.name} (ID: ${mat.id}) | ${mat.manufacturer}` :
                                        `${model.matName} | ${model.materialData?.manufacturer || 'N/A'}`,
                                    type: mat?.materialType || model.materialData?.materialType || '',
                                    manufacturer: mat?.manufacturer || model.materialData?.manufacturer || '',
                                    totalGrams: 0,
                                    totalCost: 0,
                                    totalRevenue: 0,
                                    clientRevenue: 0
                                };
                            }

                            results.materialStats[materialId].totalGrams += model.realWeight || 0;
                            results.materialStats[materialId].totalCost += materialCost;
                            results.materialStats[materialId].totalRevenue += modelRevenue;
                        }

                        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã
                        results.totalMaterialCost += materialCost;
                        results.totalPrinterCost += amortization;
                        results.totalMaintenanceCost += maintenance;
                        results.totalElectricityCost += electric;
                        results.totalCost += materialCost + amortization + electric + maintenance;
                        orderCost += materialCost + amortization + electric + maintenance;
                        results.totalPrintHours += hours;

                        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º
                        ps.hours += hours;
                        ps.amortization += amortization;
                        ps.energy += electric;
                        ps.material += materialCost;
                        ps.maintenance += maintenance;
                        ps.revenue += modelRevenue;
                        ps.prepMinutes += prepMinutes;
                        results.totalPrepMinutes += prepMinutes;
                        ps.prints++;
                        ps.grams += model.realWeight || 0;
                    });
                });

                if (orderModelCount > 0) {
                    results.totalModels += orderModelCount;
                    results.batchSizes.push(orderModelCount);
                    if (orderModelCount <= 3) {
                        results.smallBatchOrders += 1;
                    }
                }

                const additionsInOrder = new Set();
                let orderAdditionalCost = 0;
                order.globalAdditional?.details?.forEach(det => {
                    const stat = ensureAdditionalStat({
                        id: det.id,
                        description: det.description,
                        cost: det.baseCost
                    });
                    if (!stat) return;
                    const distributed = det.costDistributed || 0;
                    const remaining = stat.baseCost > 0 ? Math.max(0, stat.baseCost - stat.distributed) : Infinity;
                    const applied = Math.min(distributed, remaining);
                    stat.distributed += applied;
                    if (applied > 0) {
                        orderAdditionalCost += applied;
                        additionsInOrder.add(stat.id);
                    }
                });

                // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
                const addCost = orderAdditionalCost;
                const shipping = order.shipping || 0;
                const labelsCost = order.totalLabelsCost || 0;
                const estimateCostHistory = order.estimatePrintCost || 0;
                const globalCosts = addCost + labelsCost + estimateCostHistory + shipping + (order.totalOperatorCost || 0) + serviceCost;
                results.totalAdditionalCost += addCost + labelsCost + estimateCostHistory;
                results.totalShippingCost += shipping;
                results.totalLabelsCost += labelsCost;
                if (estimateCostHistory > 0) {
                    results.additionalStats['estimatePrint'] = results.additionalStats['estimatePrint'] || {
                        id: 'estimatePrint',
                        name: '–ü–µ—á–∞—Ç—å —Å–º–µ—Ç—ã',
                        baseCost: parseFloat(order.estimatePrintCost) || 0,
                        distributed: 0,
                        orders: 0
                    };
                    results.additionalStats['estimatePrint'].distributed += estimateCostHistory;
                    results.additionalStats['estimatePrint'].orders += 1;
                }
                results.totalCost += globalCosts;
                orderCost += globalCosts;

                const orderDowntimeMinutes = order.downtimeMinutes || 0;
                const orderCoolingMinutes = order.coolingMinutes !== undefined
                    ? order.coolingMinutes
                    : Math.max(0, orderDowntimeMinutes - (order.printerPrepMinutes || 0));
                results.totalDowntimeMinutes += orderDowntimeMinutes;
                results.totalCoolingMinutes += orderCoolingMinutes;

                const orderModelsRevenue = typeof order.modelsRevenue === 'number'
                    ? order.modelsRevenue
                    : Math.max(0, (order.total || 0) - (order.shipping || 0) - (order.servicesTotal || 0));
                if (orderGrams > 0 && orderModelsRevenue > 0) {
                    const orderRevenueShare = orderModelsRevenue;
                    Object.entries(orderMaterialGrams).forEach(([materialId, grams]) => {
                        const stat = results.materialStats[materialId];
                        if (!stat) return;
                        stat.clientRevenue += orderRevenueShare * (grams / orderGrams);
                    });
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
                const clientName = order.clientName || '(–ù–µ —É–∫–∞–∑–∞–Ω)';
                if (!results.clientStats[clientName]) {
                    results.clientStats[clientName] = { name: clientName, revenue: 0, cost: 0, grams: 0, orders: 0 };
                }
                const cs = results.clientStats[clientName];
                cs.revenue += order.total || 0;
                cs.cost += orderCost;
                cs.grams += orderGrams;
                cs.orders += 1;

                additionsInOrder.forEach(id => {
                    const stat = results.additionalStats[id];
                    if (!stat) return;
                    stat.orders += 1;
                });
            });

            const sortedBatch = results.batchSizes.slice().sort((a, b) => a - b);
            const batchCount = sortedBatch.length;
            const medianBatch = batchCount
                ? (batchCount % 2
                    ? sortedBatch[(batchCount - 1) / 2]
                    : (sortedBatch[batchCount / 2 - 1] + sortedBatch[batchCount / 2]) / 2)
                : 0;

            results.batchStats = {
                avgModelsPerOrder: results.completedOrdersCount > 0 ? results.totalModels / results.completedOrdersCount : 0,
                medianBatchSize: medianBatch,
                smallBatchShare: results.completedOrdersCount > 0 ? (results.smallBatchOrders / results.completedOrdersCount) * 100 : 0,
                totalModels: results.totalModels
            };
            delete results.batchSizes;

            return results;
        };

        // 3. –†–∞—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
        const calculateKPIs = (capital, ordersAnalysis) => {
            const {
                totalRevenue,
                totalCost,
                totalTax,
                totalElectricityCost,
                totalOperatorExpenses,
                totalPrintHours: summaryPrintHours,
                totalServiceCost,
                totalShippingCost,
                totalAdditionalCost,
                totalMaterialCost,
                totalPrinterCost,
                totalMaintenanceCost,
                materialStats,
                completedOrdersCount
            } = ordersAnalysis;

            const grossProfit = totalRevenue - totalCost;
            const netProfit = grossProfit - totalTax;
            const netMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
            const grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;
            const roi = capital.total > 0 ? (netProfit / capital.total) * 100 : 0;
            const avgOrderCost = completedOrdersCount > 0 ? totalCost / completedOrdersCount : 0;

            const paybackOrders = completedOrdersCount > 0 && netProfit !== 0
                ? capital.total / (netProfit / completedOrdersCount)
                : 0;

            const totalGrams = Object.values(materialStats).reduce(
                (sum, m) => sum + m.totalGrams, 0);

            const ebitda = netProfit + totalTax + totalPrinterCost;
            const breakEvenRevenue = capital.total + (totalCost - totalPrinterCost) + totalTax;
            const revenueGap = breakEvenRevenue - totalRevenue;
            const profitabilityIndex = capital.total > 0 ? (netProfit + capital.total) / capital.total : 0;
            const depreciationRate = capital.printersCost > 0 ? (totalPrinterCost / capital.printersCost) * 100 : 0;

            return {
                grossProfit,
                netProfit,
                netMargin,
                grossMargin,
                roi,
                paybackOrders,
                profitPerHour: summaryPrintHours > 0 ? netProfit / summaryPrintHours : 0,
                avgOrderRevenue: completedOrdersCount > 0 ? totalRevenue / completedOrdersCount : 0,
                avgOrderProfit: completedOrdersCount > 0 ? netProfit / completedOrdersCount : 0,
                avgOrderCost,
                avgPrintHoursPerOrder: completedOrdersCount > 0 ? summaryPrintHours / completedOrdersCount : 0,
                avgMaterialPerOrder: completedOrdersCount > 0 ? totalGrams / completedOrdersCount : 0,
                costPerKg: totalGrams > 0 ? totalCost / (totalGrams / 1000) : 0,
                netProfitPerKg: totalGrams > 0 ? netProfit / (totalGrams / 1000) : 0,
                avgCostPerGram: totalGrams > 0 ? totalCost / totalGrams : 0,
                avgRevenuePerGram: totalGrams > 0 ? totalRevenue / totalGrams : 0,
                costStructure: {
                    material: totalCost > 0 ? (totalMaterialCost / totalCost) * 100 : 0,
                    electricity: totalCost > 0 ? (totalElectricityCost / totalCost) * 100 : 0,
                    operator: totalCost > 0 ? (totalOperatorExpenses / totalCost) * 100 : 0,
                    services: totalCost > 0 ? (totalServiceCost / totalCost) * 100 : 0,
                    shipping: totalCost > 0 ? (totalShippingCost / totalCost) * 100 : 0,
                    additional: totalCost > 0 ? (totalAdditionalCost / totalCost) * 100 : 0,
                    amortization: totalCost > 0 ? (totalPrinterCost / totalCost) * 100 : 0,
                    maintenance: totalCost > 0 ? (totalMaintenanceCost / totalCost) * 100 : 0
                },
                totalMaterialCost,
                totalGrams,
                ebitda,
                breakEvenRevenue,
                revenueGap,
                profitabilityIndex,
                depreciationRate
            };
        };



        const generateHTML = (capital, ordersAnalysis, kpis, meta = {}) => {
            const {
                completedOrdersCount,
                totalRevenue,
                totalTax,
                totalCost,
                totalOperatorExpenses,
                totalServiceCost,
                totalElectricityCost,
                totalMaterialCost,
                totalShippingCost,
                totalAdditionalCost,
                totalPrinterCost,
                totalMaintenanceCost,
                totalRejectHours,
                totalRejectGrams,
                totalPrepMinutes,
                totalDowntimeMinutes,
                totalCoolingMinutes,
                totalModels,
                materialStats,
                printerStats,
                clientStats,
                batchStats = { avgModelsPerOrder: 0, medianBatchSize: 0, smallBatchShare: 0 },
                additionalStats = {}
            } = ordersAnalysis;
            const totalPrintHours = ordersAnalysis.totalPrintHours || 0;

            const {
                grossProfit,
                netProfit,
                netMargin,
                paybackOrders,
                avgOrderRevenue,
                avgOrderProfit,
                avgOrderCost,
                avgPrintHoursPerOrder,
                avgMaterialPerOrder,
                costPerKg,
                netProfitPerKg,
                avgCostPerGram,
                avgRevenuePerGram,
                costStructure,
                ebitda,
                breakEvenRevenue,
                revenueGap,
                depreciationRate
            } = kpis;

            const { periodDays = 1 } = meta;

            const paybackAbs = netProfit - capital.total;
            const avgModelsPerOrder = batchStats.avgModelsPerOrder || 0;
            const totalOutputMass = (kpis.totalGrams || 0) + (totalRejectGrams || 0);
            const yieldRate = totalOutputMass > 0 ? ((kpis.totalGrams || 0) / totalOutputMass) * 100 : 0;
            const periodHours = Math.max(1, periodDays) * 24;

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∞–±–ª–∏—Ü
            const totalMaterialRevenue = Object.values(materialStats).reduce((sum, m) => sum + (m.totalRevenue || 0), 0);
            const totalMaterialClientRevenue = Object.values(materialStats).reduce((sum, m) => sum + (m.clientRevenue || 0), 0);
            const totalMaterialMargin = totalMaterialRevenue - totalMaterialCost;
            const avgClientPricePerGram = kpis.totalGrams > 0 ? totalMaterialClientRevenue / kpis.totalGrams : 0;
            const materialRows = Object.values(materialStats).map(m => {
                const margin = (m.totalRevenue || 0) - (m.totalCost || 0);
                const share = kpis.totalGrams > 0 ? (m.totalGrams / kpis.totalGrams) * 100 : 0;
                const costPerKg = m.totalGrams > 0 ? m.totalCost / (m.totalGrams / 1000) : 0;
                const clientPricePerGram = m.totalGrams > 0 ? (m.clientRevenue || 0) / m.totalGrams : 0;
                return `
      <tr>
        <td>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${m.name}</strong>
              <div class="text-muted small">${m.type || '‚Äî'} | ${m.manufacturer || '‚Äî'}</div>
              <div class="text-muted small">–†–∞—Å—Ö–æ–¥: ${formatNumber(m.totalGrams / 1000, 3)} –∫–≥</div>
              <div class="text-muted small">‚ÇΩ/–∫–≥: ${costPerKg > 0 ? `${formatCurrency(costPerKg)}/–∫–≥` : '0.00 ‚ÇΩ/–∫–≥'}</div>
            </div>
            <div class="text-end">
              <span class="${margin >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(margin)}</span>
              <div class="small text-muted">–ú–∞—Ä–∂–∞</div>
            </div>
          </div>
          <div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar bg-info" style="width: ${Math.min(100, Math.max(0, share))}%"></div>
          </div>
        </td>
        <td class="text-end">${formatCurrency(m.totalCost)}</td>
        <td class="text-end">${formatCurrency(m.totalRevenue || 0)}</td>
        <td class="text-end">${formatNumber(clientPricePerGram, 2)} ‚ÇΩ/–≥</td>
      </tr>
    `;
            }).join('') || `<tr><td colspan="4" class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º</td></tr>`;
            const downtimeHours = (totalDowntimeMinutes || 0) / 60;
            const coolingHours = (totalCoolingMinutes || 0) / 60;
            const prepHours = (totalPrepMinutes || 0) / 60;
            const productionHours = totalPrintHours + downtimeHours;
            const downtimeShare = productionHours > 0 ? (downtimeHours / productionHours) * 100 : 0;
            const prepShare = downtimeHours > 0 ? (prepHours / downtimeHours) * 100 : 0;
            const printerRows = Object.values(printerStats).map(p => {
                const expenses = p.amortization + p.energy + p.material + p.maintenance;
                const prepHours = (p.prepMinutes || 0) / 60;
                return `
      <tr>
        <td>${p.name}</td>
        <td class="text-end">${formatNumber(p.hours, 1)} —á</td>
        <td class="text-end">${formatNumber(prepHours, 2)} —á</td>
        <td class="text-end">${formatCurrency(p.revenue)}</td>
        <td class="text-end">${formatCurrency(expenses)}</td>
        <td class="text-end">${p.prints}</td>
      </tr>`;
            }).join('') || `<tr><td colspan="6" class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º</td></tr>`;

            const totalPrinterRevenue = Object.values(printerStats).reduce((sum, p) => sum + p.revenue, 0);
            const totalPrinterExpenses = Object.values(printerStats).reduce((sum, p) => sum + p.amortization + p.energy + p.material + p.maintenance, 0);
            const totalPrinterPrints = Object.values(printerStats).reduce((sum, p) => sum + p.prints, 0);

            const clientRows = Object.values(clientStats).map(c => {
                const profit = c.revenue - c.cost;
                return `
      <tr>
        <td>${c.name}</td>
        <td class="text-end">${formatCurrency(c.revenue)}</td>
        <td class="text-end">${formatCurrency(c.cost)}</td>
        <td class="text-end ${profit >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(profit)}</td>
        <td class="text-end">${c.orders}</td>
      </tr>`;
            }).join('') || `<tr><td colspan="5" class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º</td></tr>`;
            const totalClientRevenue = Object.values(clientStats).reduce((sum, c) => sum + c.revenue, 0);
            const totalClientCost = Object.values(clientStats).reduce((sum, c) => sum + c.cost, 0);
            const totalClientProfit = totalClientRevenue - totalClientCost;
            const totalClientOrders = Object.values(clientStats).reduce((sum, c) => sum + c.orders, 0);

            const activeAdditional = Object.values(additionalStats).filter(stat =>
                stat.baseCost <= 0 || stat.distributed < stat.baseCost
            );
            const additionalRows = activeAdditional.map(stat => {
                const progress = stat.baseCost > 0 ? Math.min(100, (stat.distributed / stat.baseCost) * 100) : 0;
                const paidOff = stat.baseCost > 0 && stat.distributed >= stat.baseCost;
                return `
      <tr>
        <td>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${stat.name}</strong>
              <div class="text-muted small">–ë–∞–∑–∞: ${formatCurrency(stat.baseCost)}</div>
            </div>
            <span class="${paidOff ? 'text-success' : 'text-warning'}">${paidOff ? '–û–∫—É–ø–∏–ª—Å—è' : '–í —Ä–∞–±–æ—Ç–µ'}</span>
          </div>
          <div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar ${paidOff ? 'bg-success' : 'bg-warning'}" style="width: ${Math.min(100, Math.max(0, progress))}%"></div>
          </div>
        </td>
        <td class="text-end">${formatCurrency(stat.distributed)}</td>
        <td class="text-end">${formatCurrency(Math.max(0, stat.baseCost - stat.distributed))}</td>
        <td class="text-end">${stat.orders || 0}</td>
      </tr>`;
            }).join('') || `<tr><td colspan="4" class="text-center text-muted py-4">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤</td></tr>`;

            const kpiCardItems = [
                {title: '–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤', value: completedOrdersCount, desc: '–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥', icon: 'bi-check2-square', decimals: 0},
                {title: '–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞', value: totalRevenue, desc: '–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã', icon: 'bi-cash-stack', format: formatCurrency},
                {title: '–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã', value: totalCost, desc: '–í—Å–µ –∑–∞—Ç—Ä–∞—Ç—ã', icon: 'bi-receipt-cutoff', format: formatCurrency},
                {title: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å', value: netProfit, desc: '–ü–æ—Å–ª–µ –Ω–∞–ª–æ–≥–æ–≤', icon: 'bi-graph-up-arrow', format: formatCurrency, valueClass: netProfit >= 0 ? 'text-success' : 'text-danger'},
                {title: '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫', value: avgOrderRevenue, desc: '‚ÇΩ –∑–∞ –∑–∞–∫–∞–∑', icon: 'bi-receipt', format: formatCurrency},
                {title: '–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥', value: avgMaterialPerOrder / 1000, unit: ' –∫–≥', desc: '–ú–∞—Ç–µ—Ä–∏–∞–ª / –∑–∞–∫–∞–∑', icon: 'bi-bezier', decimals: 2},
                {title: '–ß–∏—Å—Ç–∞—è –º–∞—Ä–∂–∞', value: netMargin, unit: ' %', desc: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –≤—ã—Ä—É—á–∫–∞', icon: 'bi-graph-down', decimals: 1},
                {title: '–¶–µ–Ω–∞ –ø–µ—á–∞—Ç–∏', value: avgClientPricePerGram, unit: ' ‚ÇΩ/–≥', desc: '–°—Ä–µ–¥–Ω—è—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ü–µ–Ω–∞ –∑–∞ –≥—Ä–∞–º–º', icon: 'bi-currency-ruble', decimals: 2},
                {title: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø–µ—á–∞—Ç–∏', value: avgPrintHoursPerOrder, unit: ' —á', desc: '–ß–∞—Å–æ–≤ –ø–µ—á–∞—Ç–∏ / –∑–∞–∫–∞–∑', icon: 'bi-clock-history', decimals: 1},
                {title: '–°—Ä–µ–¥–Ω—è—è –ø–∞—Ä—Ç–∏—è', value: avgModelsPerOrder, unit: ' –º–æ–¥–µ–ª–µ–π', desc: '–ú–æ–¥–µ–ª–µ–π –≤ –∑–∞–∫–∞–∑–µ', icon: 'bi-layers', decimals: 1},
                {title: '–í—ã—Ö–æ–¥ –≥–æ–¥–Ω—ã—Ö', value: yieldRate, unit: '%', desc: '–ì–æ–¥–Ω—ã–µ –±–µ–∑ –±—Ä–∞–∫–∞', icon: 'bi-check-circle', decimals: 1},
                {
                    title: '–ë—Ä–∞–∫ (–∫–≥)',
                    value: totalRejectGrams / 1000,
                    unit: ' –∫–≥',
                    desc: '–í–µ—Å –±—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π',
                    icon: 'bi-x-circle',
                    decimals: 3
                }
            ];
            const formatCardValue = (card) => {
                if (typeof card.format === 'function') {
                    return card.format(card.value);
                }
                const decimals = Object.prototype.hasOwnProperty.call(card, 'decimals') ? card.decimals : 1;
                const unit = card.unit || '';
                return `${formatNumber(card.value, decimals)}${unit}`;
            };
            const kpiCards = kpiCardItems.map(card => `
      <div class="col-xl-3 col-md-4 col-sm-6 mb-3">
        <div class="card h-100 shadow-sm">
          <div class="card-body p-3">
            <div class="d-flex align-items-center">
              <i class="bi ${card.icon} fs-3 text-primary me-3"></i>
              <div>
                <h5 class="mb-0 ${card.valueClass || ''}">${formatCardValue(card)}</h5>
                <small class="text-muted">${card.title}</small>
              </div>
            </div>
            <div class="mt-2 text-muted small">${card.desc}</div>
          </div>
        </div>
      </div>
    `).join('');

            return `
    <div class="container-fluid p-0">
      <!-- –ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>–ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <h6>–ü—Ä–∏–Ω—Ç–µ—Ä—ã:</h6>
              <p>–í—Å–µ–≥–æ: ${appData.printers.length} —à—Ç</p>
              <p>–°—É–º–º–∞: <strong>${formatCurrency(capital.printersCost)}</strong></p>
            </div>
            <div class="col-md-4">
              <h6>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</h6>
              <p class="mb-1">–°—É–º–º–∞: <strong>${formatCurrency(capital.materialsCost)}</strong></p>
              <p class="mb-1">–í–µ—Å: <strong>${formatNumber(capital.materialsWeight, 2)} –∫–≥</strong></p>
            </div>
            <div class="col-md-4">
              <h6>–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:</h6>
              <p class="mb-1">–°—É–º–º–∞: <strong>${formatCurrency(capital.additionalCost)}</strong></p>
            </div>
          </div>
          <div class="alert alert-primary mt-3 mb-0">
            <div class="d-flex justify-content-between align-items-center">
              <span>–û–±—â–∏–µ –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è:</span>
              <strong class="fs-5">${formatCurrency(capital.total)}</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h5>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-4">
            ${kpiCards}
          </div>

          <div class="row mb-4">
            <div class="col-12">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤</h6>
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</span>
                      <span>${formatCurrency(totalMaterialCost)} (${formatNumber(costStructure.material,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ:</span>
                      <span>${formatCurrency(totalElectricityCost)} (${formatNumber(costStructure.electricity,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–û–ø–µ—Ä–∞—Ç–æ—Ä:</span>
                      <span>${formatCurrency(totalOperatorExpenses)} (${formatNumber(costStructure.operator,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–£—Å–ª—É–≥–∏:</span>
                      <span>${formatCurrency(totalServiceCost)} (${formatNumber(costStructure.services,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                      <span>${formatCurrency(totalShippingCost)} (${formatNumber(costStructure.shipping,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:</span>
                      <span>${formatCurrency(totalAdditionalCost)} (${formatNumber(costStructure.additional,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è:</span>
                      <span>${formatCurrency(totalPrinterCost)} (${formatNumber(costStructure.amortization,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ:</span>
                      <span>${formatCurrency(totalMaintenanceCost)} (${formatNumber(costStructure.maintenance,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–ù–∞–ª–æ–≥–∏:</span>
                      <span>${formatCurrency(totalTax)}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å (–ø—Ä–∏–±—ã–ª—å - –≤–ª–æ–∂–µ–Ω–∏—è):</span>
                      <span class="${paybackAbs >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(paybackAbs)}</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-12">
          <div class="card mb-3 h-100">
            <div class="card-body">
              <h6>–í—Ä–µ–º—è –∏ –ø—Ä–æ—Å—Ç–æ–∏</h6>
              <div class="d-flex justify-content-between mb-2">
                <span>–í—Ä–µ–º—è –ø–µ—á–∞—Ç–∏</span>
                <strong>${formatNumber(totalPrintHours, 1)} —á</strong>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>–ü—Ä–æ—Å—Ç–æ–π –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</span>
                <strong>${formatNumber(downtimeHours, 2)} —á</strong>
              </div>
              <div class="text-muted small mb-2">–û—Å—Ç—ã–≤–∞–Ω–∏–µ: ${formatNumber(coolingHours, 2)} —á ¬∑ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: ${formatNumber(prepHours, 2)} —á (${formatNumber(prepShare, 1)}% –ø—Ä–æ—Å—Ç–æ—è)</div>
              <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar bg-warning" style="width: ${Math.min(100, Math.max(0, downtimeShare))}%"></div>
              </div>
              <div class="text-muted small">–ü—Ä–æ—Å—Ç–æ–π ${formatNumber(downtimeShare, 1)}% –æ—Ç —Ü–∏–∫–ª–∞ –ø–µ—á–∞—Ç–∏</div>
            </div>
          </div>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-boxes me-2"></i>–†–∞—Å—Ö–æ–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="">
                    <tr>
                      <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                      <th class="text-end">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                      <th class="text-end">–í—ã—Ä—É—á–∫–∞</th>
                      <th class="text-end">–°—Ä. —Ü–µ–Ω–∞ (‚ÇΩ/–≥)</th>
                    </tr>
                  </thead>
                  <tbody>${materialRows}</tbody>
                  <tfoot class="">
                    <tr>
                      <th>–ò—Ç–æ–≥–æ: ${formatNumber(kpis.totalGrams / 1000, 3)} –∫–≥</th>
                      <th class="text-end">${formatCurrency(kpis.totalMaterialCost)}</th>
                      <th class="text-end">${formatCurrency(totalMaterialRevenue)}</th>
                      <th class="text-end">${formatNumber(avgClientPricePerGram, 2)} ‚ÇΩ/–≥</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-printer me-2"></i>–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="">
                    <tr>
                      <th>–ü—Ä–∏–Ω—Ç–µ—Ä</th>
                      <th class="text-end">–í—Ä–µ–º—è</th>
                      <th class="text-end">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</th>
                      <th class="text-end">–í—ã—Ä—É—á–∫–∞</th>
                      <th class="text-end">–†–∞—Å—Ö–æ–¥—ã</th>
                      <th class="text-end">–ö–æ–ª-–≤–æ –º–æ–¥–µ–ª–µ–π</th>
                    </tr>
                  </thead>
                  <tbody>${printerRows}</tbody>
                  <tfoot class="">
                    <tr>
                      <th>–ò—Ç–æ–≥–æ</th>
                      <th class="text-end">${formatNumber(ordersAnalysis.totalPrintHours, 1)} —á</th>
                      <th class="text-end">${formatNumber((ordersAnalysis.totalPrepMinutes || 0) / 60, 2)} —á</th>
                      <th class="text-end">${formatCurrency(totalPrinterRevenue)}</th>
                      <th class="text-end">${formatCurrency(totalPrinterExpenses)}</th>
                      <th class="text-end">${totalPrinterPrints}</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-people me-2"></i>–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="">
                    <tr>
                      <th>–ö–ª–∏–µ–Ω—Ç</th>
                      <th class="text-end">–í—ã—Ä—É—á–∫–∞</th>
                      <th class="text-end">–†–∞—Å—Ö–æ–¥—ã</th>
                      <th class="text-end">–ü—Ä–∏–±—ã–ª—å</th>
                      <th class="text-end">–ó–∞–∫–∞–∑—ã</th>
                    </tr>
                  </thead>
                  <tbody>${clientRows}</tbody>
                  <tfoot class="">
                    <tr>
                      <th>–ò—Ç–æ–≥–æ</th>
                      <th class="text-end">${formatCurrency(totalClientRevenue)}</th>
                      <th class="text-end">${formatCurrency(totalClientCost)}</th>
                      <th class="text-end">${formatCurrency(totalClientProfit)}</th>
                      <th class="text-end">${totalClientOrders}</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-diagram-2"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead>
                    <tr>
                      <th>–°—Ç–∞—Ç—å—è</th>
                      <th class="text-end">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ</th>
                      <th class="text-end">–û—Å—Ç–∞—Ç–æ–∫</th>
                      <th class="text-end">–ó–∞–∫–∞–∑—ã</th>
                    </tr>
                  </thead>
                  <tbody>${additionalRows}</tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>`;
        };

        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–æ–≤
        const capital = calculateCapitalInvestments();
        const ordersAnalysis = analyzeCompletedOrders(from, to);
        const kpis = calculateKPIs(capital, ordersAnalysis);

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        const summaryContent = document.getElementById("summaryContent");
        summaryContent.innerHTML = generateHTML(capital, ordersAnalysis, kpis, { periodDays });
    }

    function parseIncomingLinkParams(params){
        const prName = params.get('printer');
        if(!prName) return;
        const statuses = params.getAll('model_status[]');
        const names = params.getAll('model_name[]');
        const ids = params.getAll('model_id[]');
        const thumbs = params.getAll('model_thumbnail[]');
        const times = params.getAll('model_time[]');
        const weights = params.getAll('model_weight[]');
        const mats = params.getAll('model_filament[]');
        const models = [];
        for(let i=0;i<names.length;i++){
            models.push({
                id: ids[i] || getNextId('models'),
                name: names[i] || '',
                thumbnail: thumbs[i] || '',
                status: statuses[i] || 'new',
                timeStr: times[i] || '',
                weight: weights[i] || '',
                matName: mats[i] || ''
            });
        }
        incomingLinkData = {printerKey: prName, models};
        showIncomingDataModal();
    }

    async function resolvePrinterForLink(key){
        const safeKey = (key || 'Unknown').trim();
        const printers = Array.isArray(appData.printers) ? appData.printers : [];

        const list = printers.filter(p=>{
            if(p.name===safeKey) return true;
            return (p.profileIds||[]).some(pid=>{
                const pf=appData.printerProfiles.find(x=>String(x.id)===String(pid));
                return pf && pf.config && pf.config.printer_settings_id===safeKey;
            });
        });

        if(list.length===1) return list[0];

        const rememberedId = PromptMemory.getPrinter(safeKey);
        if(rememberedId){
            const remembered = printers.find(p=>String(p.id)===String(rememberedId));
            if(remembered) return remembered;
            PromptMemory.forgetPrinter(safeKey);
        }

        if(list.length===0 && printers.length===1) return printers[0];

        const candidates = (list.length>0 ? list : printers);
        if(candidates.length<=0) return null;

        const options=candidates.map(p=>({value:String(p.id),label:p.name}));
        const res=await showMultiPrompt('–ü—Ä–∏–Ω—Ç–µ—Ä –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è '+safeKey,[
            {id:'pid',label:'–ü—Ä–∏–Ω—Ç–µ—Ä',type:'select',options,value:options[0]?.value||''},
            {id:'remember',label:`–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è ¬´${safeKey}¬ª`,type:'checkbox',value:false,help:'–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞/–∫–æ–º–ø—å—é—Ç–µ—Ä–∞ (LocalStorage).'}
        ]);

        if(res && res.pid){
            if(res.remember) PromptMemory.setPrinter(safeKey, res.pid);
            return printers.find(p=>String(p.id)===String(res.pid)) || null;
        }
        return null;
    }

    function showIncomingDataModal(){
        const sel = document.getElementById('targetOrderSelect');
        sel.innerHTML = '<option value="new">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</option>';
        appData.calcHistory.forEach(h=>{
            const opt = document.createElement('option');
            opt.value = h.timestamp;
            opt.textContent = h.calcName || h.dateStr;
            sel.appendChild(opt);
        });
        const modal = new bootstrap.Modal(document.getElementById('incomingDataModal'));
        document.getElementById('importLinkApplyBtn').onclick = applyIncomingData;
        modal.show();
    }

    async function applyIncomingData(){
        const sel = document.getElementById('targetOrderSelect');
        const val = sel ? sel.value : 'new';

        const modalEl = document.getElementById('incomingDataModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || bootstrap.Modal.getOrCreateInstance(modalEl);

        modal.hide();
        await __waitModalHidden(modalEl);

        if(val !== 'new'){
            onEditCalcHistory(parseInt(val,10));
        } else {
            startNewCalculation();
        }

        await new Promise(r=>setTimeout(r,0));

        if(incomingLinkData){
            const pr = await resolvePrinterForLink(incomingLinkData.printerKey);
            if(!pr){
                alert('–ù–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏–Ω—Ç–µ—Ä '+incomingLinkData.printerKey);
            } else {
                for(const m of incomingLinkData.models){
                    const mid = await resolveMaterialIdByProfile(m.matName);
                    addModelRow(pr.id, {
                        id: m.id,
                        name: m.name,
                        thumbnail: m.thumbnail,
                        status: m.status,
                        hours: parseTimeFromLink(m.timeStr),
                        weight: parseFloat(m.weight)||0,
                        materialId: mid
                    });
                }
            }
        }
        const tabEl = document.querySelector('#calculate-tab');
        const tab = new bootstrap.Tab(tabEl);
        tab.show();
        incomingLinkData = null;

    }

</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    const SUPABASE_URL = "https://kvvxfytrlgihewmsvwkj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2dnhmeXRybGdpaGV3bXN2d2tqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5NDExMzIsImV4cCI6MjA2MTUxNzEzMn0.bvXmrh3XZivLVyg4irGo82pLAhlrSapzmxcDKLEAjLo";

    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // ‚úÖ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

    let syncId = localStorage.getItem("sync_id") || crypto.randomUUID();
    let encryptionKey = localStorage.getItem("encryption_key") || crypto.randomUUID() + crypto.randomUUID();
    localStorage.setItem("sync_id", syncId);
    localStorage.setItem("encryption_key", encryptionKey);

    async function encryptData(data, key) {
        const text = JSON.stringify(data);
        const enc = new TextEncoder().encode(text);
        const cryptoKey = await crypto.subtle.importKey("raw", new TextEncoder().encode(key.slice(0, 32)), "AES-GCM", false, ["encrypt"]);
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const cipher = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, enc);
        return btoa(JSON.stringify({ iv: Array.from(iv), data: Array.from(new Uint8Array(cipher)) }));
    }

    async function decryptData(encrypted, key) {
        const parsed = JSON.parse(atob(encrypted));
        const iv = new Uint8Array(parsed.iv);
        const data = new Uint8Array(parsed.data);
        const cryptoKey = await crypto.subtle.importKey("raw", new TextEncoder().encode(key.slice(0, 32)), "AES-GCM", false, ["decrypt"]);
        const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, cryptoKey, data);
        return JSON.parse(new TextDecoder().decode(decrypted));
    }

    async function saveSettingsToCloud() {
        const encrypted = await encryptData(appData, encryptionKey);
        const { error } = await _supabase
            .from('user_settings')
            .upsert({
                sync_id: syncId,
                encrypted_data: encrypted,
                updated_at: new Date().toISOString()
            }, { onConflict: 'sync_id' });

        if (error) alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + error.message);
        else alert("‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ.");
    }

    async function loadSettingsFromCloud() {
        const { data, error } = await _supabase
            .from('user_settings')
            .select('*')
            .eq('sync_id', syncId)
            .single();

        if (error || !data) {
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + error?.message);
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
        const createdAt = new Date(data.created_at);
        const now = new Date();
        if ((now - createdAt) > 5 * 60 * 1000) { // 5 –º–∏–Ω—É—Ç
            alert("–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã");
            await _supabase.from('user_settings').delete().eq('sync_id', syncId);
            return;
        }

        try {
            const decrypted = await decryptData(data.encrypted_data, encryptionKey);
            appData = decrypted;
            saveToLocalStorage();
            initAll();
            alert("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏.");
        }
    }

    function generateSyncLinkAndQR() {
        const url = new URL(window.location.href);
        url.searchParams.set("sync_id", syncId);
        url.searchParams.set("key", encryptionKey);
        const link = url.toString();
        document.getElementById("syncLinkDisplay").value = link;
        const qrcodeDiv = document.getElementById("qrcode");
        qrcodeDiv.innerHTML = "";
        new QRCode(qrcodeDiv, {
            text: link,
            width: 256,
            height: 256,
            colorDark: "#000000",
            colorLight: "#ffffff"
        });
    }

    document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const incomingId = params.get("sync_id");
        const incomingKey = params.get("key");

        if (incomingId && incomingKey) {
            localStorage.setItem("sync_id", incomingId);
            localStorage.setItem("encryption_key", incomingKey);
            syncId = incomingId;
            encryptionKey = incomingKey;
            await loadSettingsFromCloud();
        }
        document.getElementById('delOrcaProfileBtn').onclick = ()=>deleteOrcaProfile();
        document.getElementById('orcaProfileSelect').addEventListener('change',e=>{
            const pr=appData.printers.find(p=>String(p.id)===String(currentOrcaPrinterId));
            if(pr) loadOrcaProfile(pr,parseInt(e.target.value,10));
        });
        document.getElementById('saveMaterialBtn').onclick = saveMaterialFromModal;
        document.getElementById('savePrinterBtn').onclick = savePrinterFromModal;
        const jsonBtn = document.getElementById('downloadJsonFileBtn');
        if (jsonBtn) jsonBtn.addEventListener('click', downloadJsonFile);
        const summaryBtn = document.getElementById('downloadSummaryCardBtn');
        if (summaryBtn) summaryBtn.addEventListener('click', downloadSummaryCardHtml);
        const myNalogBtn = document.getElementById('sendMyNalogBtn');
        if (myNalogBtn) myNalogBtn.addEventListener('click', sendMyNalogReceipt);
        const myNalogBillBtn = document.getElementById('sendMyNalogBillBtn');
        if (myNalogBillBtn) myNalogBillBtn.addEventListener('click', sendMyNalogBill);
        const myNalogCancelBtn = document.getElementById('cancelMyNalogBtn');
        if (myNalogCancelBtn) myNalogCancelBtn.addEventListener('click', cancelMyNalogReceipt);
        const phoneInput = document.getElementById('myNalogPhone');
        if (phoneInput) {
            phoneInput.addEventListener('change', e => {
                localStorage.setItem('my_nalog_phone', e.target.value.trim());
            });
        }
        const workdayModal = document.getElementById('workdayTemplateModal');
        if (workdayModal) {
            workdayModal.addEventListener('show.bs.modal', () => {
                presetWorkdayTemplateModal();
                updateLunchStartByOffset();
            });
        }
        const templateSelect = document.getElementById('workdayTemplateSelect');
        if (templateSelect) {
            templateSelect.addEventListener('change', () => {
                const option = templateSelect.options[templateSelect.selectedIndex];
                const hours = parseFloat(option.dataset.hours);
                if (!Number.isNaN(hours)) {
                    document.getElementById('workdayTotalHours').value = hours;
                }
                const lunch = parseInt(option.dataset.lunch, 10);
                const skipLunch = document.getElementById('workdaySkipLunch');
                if (!Number.isNaN(lunch) && lunch > 0) {
                    document.getElementById('workdayLunchDuration').value = lunch;
                    if (skipLunch) skipLunch.checked = false;
                }
                const offset = parseInt(option.dataset.offset, 10);
                if (!Number.isNaN(offset)) {
                    workdayLunchOffsetMinutes = offset;
                    lunchStartManual = false;
                    updateLunchStartByOffset();
                }
            });
        }
        const startTimeInput = document.getElementById('workdayStartTime');
        if (startTimeInput) {
            startTimeInput.addEventListener('change', () => {
                lunchStartManual = false;
                updateLunchStartByOffset();
            });
        }
        const lunchStartInput = document.getElementById('workdayLunchStart');
        if (lunchStartInput) {
            lunchStartInput.addEventListener('input', () => {
                lunchStartManual = true;
            });
        }
        const skipLunchCheckbox = document.getElementById('workdaySkipLunch');
        if (skipLunchCheckbox) {
            skipLunchCheckbox.addEventListener('change', e => {
                const disabled = e.target.checked;
                document.getElementById('workdayLunchStart').disabled = disabled;
                document.getElementById('workdayLunchDuration').disabled = disabled;
                if (disabled) {
                    lunchStartManual = true;
                } else {
                    lunchStartManual = false;
                    updateLunchStartByOffset();
                }
            });
        }
        const addBreakBtn = document.getElementById('addSpecialBreakBtn');
        if (addBreakBtn) {
            addBreakBtn.addEventListener('click', () => addSpecialBreakRow());
        }
        const addPresetBreaksBtn = document.getElementById('addPresetBreaksBtn');
        if (addPresetBreaksBtn) {
            addPresetBreaksBtn.addEventListener('click', () => {
                const startVal = document.getElementById('workdayStartTime').value;
                const startMin = timeStringToMinutes(startVal || '');
                if (!Number.isNaN(startMin)) {
                    addSpecialBreakRow(minutesToTimeString(startMin + 120), 10);
                    addSpecialBreakRow(minutesToTimeString(startMin + 360), 10);
                } else {
                    addSpecialBreakRow('', 10);
                    addSpecialBreakRow('', 10);
                }
            });
        }
        const breaksContainer = document.getElementById('specialBreaksContainer');
        if (breaksContainer) {
            breaksContainer.addEventListener('click', event => {
                const removeBtn = event.target.closest('.remove-break-row');
                if (removeBtn) {
                    event.preventDefault();
                    const row = removeBtn.closest('.special-break-row');
                    if (row) row.remove();
                }
            });
        }
        const applyTemplateBtn = document.getElementById('applyWorkdayTemplateBtn');
        if (applyTemplateBtn) {
            applyTemplateBtn.addEventListener('click', applyWorkdayTemplateFromModal);
        }
        const urgencySelectEl = document.getElementById('urgencyProfileSelect');
        if (urgencySelectEl) {
            urgencySelectEl.addEventListener('change', () => {
                captureScheduleFromInputs(currentUrgencyProfileId);
                currentUrgencyProfileId = urgencySelectEl.value;
                renderCurrentUrgencyMeta();
                renderOperatorScheduleInputsForProfile(currentUrgencyProfileId);
            });
        }
        const urgencyNameInput = document.getElementById('urgencyProfileName');
        if (urgencyNameInput) {
            urgencyNameInput.addEventListener('input', e => {
                const profile = getEditingProfileById(currentUrgencyProfileId);
                if (!profile) return;
                profile.title = e.target.value;
                refreshUrgencyProfileSelectLabels();
            });
        }
        const urgencyMarkupInput = document.getElementById('urgencyProfileMarkup');
        if (urgencyMarkupInput) {
            urgencyMarkupInput.addEventListener('input', e => {
                const profile = getEditingProfileById(currentUrgencyProfileId);
                if (!profile) return;
                profile.markupPercent = parseFloat(e.target.value) || 0;
                refreshUrgencyProfileSelectLabels();
            });
        }
        const urgencyDescInput = document.getElementById('urgencyProfileDescription');
        if (urgencyDescInput) {
            urgencyDescInput.addEventListener('input', e => {
                const profile = getEditingProfileById(currentUrgencyProfileId);
                if (!profile) return;
                profile.description = e.target.value;
            });
        }
        const addUrgencyBtn = document.getElementById('addUrgencyProfileBtn');
        if (addUrgencyBtn) addUrgencyBtn.addEventListener('click', addUrgencyProfile);
        const deleteUrgencyBtn = document.getElementById('deleteUrgencyProfileBtn');
        if (deleteUrgencyBtn) deleteUrgencyBtn.addEventListener('click', deleteCurrentUrgencyProfile);
        [
            {id: 'settingsIncludeAmortization', key: 'includeAmortization'},
            {id: 'settingsIncludeRejects', key: 'includeRejects'},
            {id: 'settingsIncludeOverheads', key: 'includeOverheads'},
            {id: 'settingsIgnoreCoolingRejects', key: 'ignoreCoolingRejects'}
        ].forEach(({id, key}) => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', () => {
                    if(!appData.calcSettings) appData.calcSettings = {};
                    appData.calcSettings[key] = el.checked;
                    saveToLocalStorage();
                });
            }
        });
        const requestSmsBtn = document.getElementById('requestSmsBtn');
        if (requestSmsBtn) requestSmsBtn.addEventListener('click', requestMyNalogSms);
        const confirmSmsBtn = document.getElementById('confirmSmsBtn');
        if (confirmSmsBtn) confirmSmsBtn.addEventListener('click', confirmMyNalogSms);
        const importFileInput = document.getElementById('importJsonFile');
        if (importFileInput) importFileInput.addEventListener('change', importFromFile);
        const applyLinkBtn=document.getElementById("applyMaterialProfileLinkBtn");
        if(applyLinkBtn) applyLinkBtn.onclick = applyMaterialProfileLink;
        const manageProfilesBtn=document.getElementById("manageMaterialProfilesBtn");
        if(manageProfilesBtn) manageProfilesBtn.onclick = openMaterialProfilesManager;
        const managePrProfilesBtn=document.getElementById("managePrinterProfilesBtn");
        if(managePrProfilesBtn) managePrProfilesBtn.onclick = openPrinterProfilesManager;
        loadMyNalogSettings();

        parseIncomingLinkParams(params);
        if(params.toString()){
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        setupGcodeDrop();
        attachExternalImportBridge();
        initPromptMemoryUi();
    });


    const SPOOLMAN_CONFIG_KEY = "spoolman_config";

    function getSpoolmanConfig() {
        const configStr = localStorage.getItem(SPOOLMAN_CONFIG_KEY);
        if (!configStr) return { enabled: false, url: '', autoSync: false, lastSync: null };
        try {
            return JSON.parse(configStr);
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Spoolman –∏–∑ localStorage:", e);
            return { enabled: false, url: '', autoSync: false, lastSync: null };
        }
    }

    function saveSpoolmanConfig(config) {
        localStorage.setItem(SPOOLMAN_CONFIG_KEY, JSON.stringify(config));
        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        populateSpoolmanUIFromConfig();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ UI –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    function populateSpoolmanUIFromConfig() {
        const cfg = getSpoolmanConfig();
        const cbEnabled = document.getElementById("spoolmanEnabledCheckbox");
        const inpUrl = document.getElementById("spoolmanUrlInput");
        const cbAuto = document.getElementById("spoolmanAutoSyncCheckbox");
        const lastSync = document.getElementById("spoolmanLastSync");

        if (cbEnabled) cbEnabled.checked = !!cfg.enabled;
        if (inpUrl) inpUrl.value = cfg.url || "";
        if (cbAuto) cbAuto.checked = !!cfg.autoSync;
        if (lastSync) {
            lastSync.textContent = cfg.lastSync
                ? new Date(cfg.lastSync).toLocaleString()
                : "–ù–∏–∫–æ–≥–¥–∞";
        }
    }

    async function spoolmanApiRequest(endpoint, method = 'GET', body = null) {
        const config = getSpoolmanConfig();
        if (!config.enabled || !config.url) {
            throw new Error('Spoolman is not configured');
        }

        const baseUrl = config.url.endsWith('/') ? config.url.slice(0, -1) : config.url;
        const url = `${baseUrl}/api/v1/${endpoint}`;

        const options = {
            method,
            headers: { 'Content-Type': 'application/json' }
        };

        if (body) {
            options.body = JSON.stringify(body);
        }

        try {
            console.log(`Sending ${method} request to ${url}`, body || '');
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API error response:`, errorText);
                throw new Error(`API error (${response.status}): ${errorText}`);
            }

            if (response.status === 204) return null;

            const responseData = await response.json();
            console.log(`Response from ${endpoint}:`, responseData);
            return responseData;
        } catch (error) {
            console.error('Spoolman API error:', error);
            throw error;
        }
    }

    async function fetchSpoolmanFilaments() {
        return await spoolmanApiRequest('filament');
    }

    async function fetchSpoolmanSpools() {
        return await spoolmanApiRequest('spool');
    }

    function prepareExtraForSpoolman(extra) {
        const prepared = {};
        for (const [key, value] of Object.entries(extra)) {
            prepared[key] = JSON.stringify(value);
        }
        return prepared;
    }

    function mapSpoolmanToMaterial(spool, filament) {
        let extraFields = {};
        if (spool.extra) {
            for (const [key, value] of Object.entries(spool.extra)) {
                try {
                    if (typeof value === 'string') {

                        if (value.startsWith('"') && value.endsWith('"')) {
                            extraFields[key] = JSON.parse(value);
                        } else {

                            extraFields[key] = value;
                        }
                    } else {
                        extraFields[key] = value;
                    }
                } catch (e) {
                    console.log(`Error parsing extra field ${key}:`, e);
                    extraFields[key] = value;
                }
            }
        }

        return {
            id: getNextId('materials'),
            materialType: filament.material || '',
            name:  filament.vendor?.name+'- '+filament.name || spool.comment || `${filament.material || 'Unknown'} (${spool.id})`,
            costPerKg: spool.price || 0,
            balance: spool.remaining_weight ? spool.remaining_weight / 1000 : 0,
            declaredWeight: spool.initial_weight ? spool.initial_weight / 1000 :
                (filament.weight ? filament.weight / 1000 : 1),
            manufacturer: filament.vendor?.name ,
            productionDate: spool.lot_nr || '',
            printers: [],
            profileIds: [],
            color: filament.color_hex || '#ffffff',
            spoolmanSpoolId: spool.id,
            printerPrepMinutes: parseFloat(extraFields.printerPrepMinutes ?? extraFields.prepMinutes ?? 0) || 0
        };
    }

    async function importAllMaterialsFromSpoolman(statusCallback) {
        const config = getSpoolmanConfig();
        if (!config.enabled || !config.url) {
            return { success: false, message: 'Spoolman is not configured' };
        }

        try {
            statusCallback('Connecting to Spoolman...');
            await spoolmanApiRequest('info');

            statusCallback('Fetching data from Spoolman...');
            const filaments = await fetchSpoolmanFilaments();
            const spools = await fetchSpoolmanSpools();
            const filamentMap = {};
            filaments.forEach(filament => {
                filamentMap[filament.id] = filament;
            });

            const importedMaterials = [];
            const updatedMaterials = [];
            const errors = [];

            const activeSpools = spools.filter(spool => !spool.archived);

            statusCallback(`Processing ${activeSpools.length} spools...`);

            const existingBySpoolmanId = {};
            appData.materials.forEach(material => {
                if (material.spoolmanSpoolId) {
                    existingBySpoolmanId[material.spoolmanSpoolId] = material;
                }
            });

            for (const spool of activeSpools) {
                try {
                    if (!spool.filament) {
                        errors.push(`Spool ${spool.id} has no valid filament reference`);
                        continue;
                    }

                    const filament = filamentMap[spool.filament.id];
                    if (!filament) {
                        errors.push(`Spool ${spool.id} references unknown filament ID ${spool.filament.id}`);
                        continue;
                    }

                    const existingMaterial = existingBySpoolmanId[spool.id];

                    if (existingMaterial) {
                        const updatedData = mapSpoolmanToMaterial(spool, filament);

                        updatedData.id = existingMaterial.id;
                        updatedData.printers = existingMaterial.printers || [];
                        updatedData.profileIds = existingMaterial.profileIds || [];

                        Object.assign(existingMaterial, updatedData);
                        updatedMaterials.push(existingMaterial);
                    } else {
                        const material = mapSpoolmanToMaterial(spool, filament);
                        appData.materials.push(material);
                        importedMaterials.push(material);
                        existingBySpoolmanId[spool.id] = material;
                    }

                } catch (error) {
                    console.error(`Error importing spool ${spool.id}:`, error);
                    errors.push(`Spool ${spool.id}: ${error.message}`);
                }
            }

            saveToLocalStorage();
            renderGlobalMaterialsTable();

            config.lastSync = new Date().toISOString();
            saveSpoolmanConfig(config);

            const totalProcessed = importedMaterials.length + updatedMaterials.length;
            return {
                success: true,
                message: `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${totalProcessed} –∫–∞—Ç—É—à–µ–∫ –∏–∑ Spoolman (${importedMaterials.length} –Ω–æ–≤—ã—Ö, ${updatedMaterials.length} –æ–±–Ω–æ–≤–ª–µ–Ω–æ)`,
                materials: importedMaterials,
                updated: updatedMaterials,
                errors: errors.length ? errors : null
            };
        } catch (error) {
            console.error('Import error:', error);
            return { success: false, message: `–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${error.message}` };
        }
    }

    async function updateSpoolUsageInSpoolman(materialId, usedWeight) {
        const material = appData.materials.find(m => String(m.id) === String(materialId));
        if (!material || !material.spoolmanSpoolId) {
            console.log(`Material ${materialId} not linked to Spoolman, skipping usage update`);
            return;
        }

        try {
            console.log(`Updating Spoolman spool ${material.spoolmanSpoolId} with used weight: ${usedWeight}kg`);
            await spoolmanApiRequest(`spool/${material.spoolmanSpoolId}/use`, 'PUT', {
                use_weight: usedWeight * 1000
            });

            material.balance -= usedWeight;
            if (material.balance < 0) material.balance = 0;

            saveToLocalStorage();
            console.log(`Successfully updated usage for spool ${material.spoolmanSpoolId}`);
        } catch (error) {
            console.error('Failed to update spool usage in Spoolman:', error);
        }
    }

    async function testSpoolmanConnection(url) {
        try {
            const baseUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            const response = await fetch(`${baseUrl}/api/v1/info`);

            if (!response.ok) {
                throw new Error(`Server returned ${response.status}`);
            }

            const data = await response.json();
            return {
                success: true,
                version: data.version || 'Unknown',
                message: `Connected to Spoolman ${data.version || 'Unknown'}`
            };
        } catch (error) {
            return { success: false, message: `Connection failed: ${error.message}` };
        }
    }

    function hookMaterialUsage() {
        const originalCalculateAll = window.onCalculateAll;
        window.onCalculateAll = function() {
            const result = originalCalculateAll.apply(this, arguments);

            const config = getSpoolmanConfig();
            if (config.enabled && config.autoSync && lastCalcFullData) {
                const materialUsage = {};

                lastCalcFullData.detailsByPrinter.forEach(printer => {
                    printer.linesDetail.forEach(model => {
                        if (model.materialData && model.materialData.id) {
                            const materialId = model.materialData.id;
                            const usedWeight = (model.realWeight || 0) / 1000;

                            if (!materialUsage[materialId]) materialUsage[materialId] = 0;
                            materialUsage[materialId] += usedWeight;
                        }
                    });
                });

                Object.keys(materialUsage).forEach(materialId => {
                    updateSpoolUsageInSpoolman(materialId, materialUsage[materialId]);
                });
            }

            return result;
        };
    }

    function createSpoolmanSettingsUI() {
        const config = getSpoolmanConfig();

        return `
    <div class="mt-4">
    <h3>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ Spoolman</h3>
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i>
      –ü—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Spoolman –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (–≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É).
    </div>

    <div class="alert alert-warning">
      <h5><i class="bi bi-exclamation-triangle-fill"></i> –í–∞–∂–Ω–æ: –û–±—Ö–æ–¥ CORS –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ Spoolman</h5>
      <p>–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–æ–∫–∞–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º Spoolman –≤–∞–º –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –æ–±–æ–π—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è CORS. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:</p>
      <ol>
        <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ <a href="https://chromewebstore.google.com/detail/cors-unblock/lfhmikememgdcahcdlaciloancbhjino" target="_blank">CORS Unblock</a> –¥–ª—è Chrome</li>
        <li>–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤–∫–ª—é—á–∏—Ç–µ <em>Access-Control-Request-Headers</em></li>
        <li>–í–∫–ª—é—á–∏—Ç–µ –æ–ø—Ü–∏—é <em>Overwrite 4xx status codes with 200</em></li>
        <li>–ù–∞–∂–º–∏—Ç–µ ¬´Start¬ª</li>
      </ol>
      <p><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ —ç—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω—É–∂–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API Spoolman.</p>
    </div>

    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="spoolmanEnabledCheckbox">
      <label class="form-check-label" for="spoolmanEnabledCheckbox">–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Spoolman</label>
    </div>
    <div class="mb-3">
      <label for="spoolmanUrlInput" class="form-label">URL —Å–µ—Ä–≤–µ—Ä–∞ Spoolman:</label>
      <div class="input-group">
        <input type="text" id="spoolmanUrlInput" class="form-control" placeholder="http://localhost:7912">
        <button class="btn btn-outline-secondary" type="button" id="testSpoolmanConnectionBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      </div>
      <div class="form-text">–ü—Ä–∏–º–µ—Ä—ã: http://localhost:7912 –∏–ª–∏ https://127.0.0.1:7912</div>
    </div>
    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="spoolmanAutoSyncCheckbox">
      <label class="form-check-label" for="spoolmanAutoSyncCheckbox">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</label>
    </div>
    <div class="mb-3">
      <p>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: <span id="spoolmanLastSync">–ù–∏–∫–æ–≥–¥–∞</span></p>
    </div>
    <div id="spoolmanSyncStatus" class="alert alert-success" style="display: none; opacity: 1;"></div>
    <div class="mb-3">
      <button class="btn btn-primary" id="saveSpoolmanSettingsBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="btn btn-success" id="importFromSpoolmanBtn">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Spoolman</button>
      <button class="btn btn-warning" id="syncToSpoolmanBtn" style="display: none;">–≠–∫—Å–ø–æ—Ä—Ç (—É—Å—Ç–∞—Ä–µ–ª)</button>
      <button class="btn btn-danger" id="clearSpoolmanDuplicatesBtn">–û—á–∏—Å—Ç–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
      <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#instructionModal">
        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
      </button>
    </div>
  </div>
  <div class="modal fade" id="instructionModal" tabindex="-1" aria-labelledby="instructionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="instructionModalLabel">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ HTTPS –¥–ª—è Spoolman (–ª–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          <ol>

           <li><strong>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Spoolman –Ω–∞ –≤–Ω–µ—à–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å Ubuntu –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏</strong> <a href="https://github.com/Donkie/Spoolman/wiki/Installation">https://github.com/Donkie/Spoolman/wiki/Installation</a></li>

            <li>
              <strong>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</strong><br>
              <pre><code>sudo mkdir -p /etc/ssl/spoolman
sudo openssl req -x509 -nodes -days 365 \
  -newkey rsa:2048 \
  -keyout /etc/ssl/spoolman/spoolman.key \
  -out /etc/ssl/spoolman/spoolman.crt \
  -subj "/CN=127.0.0.1" \
  -addext "subjectAltName=IP:127.0.0.1"

sudo chmod 600 /etc/ssl/spoolman/spoolman.key
sudo chmod 644 /etc/ssl/spoolman/spoolman.crt</code></pre><br/>
spoolman.crt –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ü–µ–Ω—Ç—Ä–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
            </li>
            <li>
              <strong>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx</strong><br>
              <pre><code>sudo apt update
sudo apt install -y nginx
sudo rm /etc/nginx/sites-enabled/default
sudo ln -s /etc/nginx/sites-available/spoolman /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx</code></pre>
            </li>
            <li>
              <strong>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx (HTTPS + CORS + PNA + proxy_pass)</strong><br>
              –°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª <code>/etc/nginx/sites-available/spoolman</code>:
              <pre><code>
server {
    listen 443 ssl;
    server_name 127.0.0.1;

    ssl_certificate     /etc/ssl/spoolman/spoolman.crt;
    ssl_certificate_key /etc/ssl/spoolman/spoolman.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_tickets off;

    location / {
        # –û–±—â–∏–µ CORS + –º–µ—Ç–æ–¥ PATCH
        add_header Access-Control-Allow-Origin         "https://nazbav.github.io" always;
        add_header Access-Control-Allow-Credentials    "true" always;
        add_header Access-Control-Allow-Private-Network "true" always;
        add_header Access-Control-Allow-Methods        "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers        "Origin, X-Requested-With, Content-Type, Accept" always;

        # Preflight OPTIONS
        if ($request_method = OPTIONS) {
            return 204;
        }

        proxy_pass         http://127.0.0.1:7912;
        proxy_http_version 1.1;
        proxy_set_header   Host            $host;
        proxy_set_header   X-Real-IP       $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
</code></pre> <br/>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
            </li>
            <li>
              <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞ (UFW)</strong><br>
              <pre><code>sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload</code></pre>
            </li>
            <li>
              <strong>–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞</strong><br>
              <pre><code>sudo systemctl restart Spoolman
sudo systemctl status Spoolman

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å HTTPS:
curl -vk https://127.0.0.1/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å preflight CORS/PNA:
curl -vk -X OPTIONS https://127.0.0.1/api/v1/info \
  -H "Origin: https://nazbav.github.io" \
  -H "Access-Control-Request-Method: GET" \
  -H "Access-Control-Request-Headers: Content-Type" \
  -H "Access-Control-Request-Private-Network: true"</code></pre>
              –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –±—É–¥–µ—Ç:
              <ul>
                <li><code>HTTP/1.1 204 No Content</code></li>
                <li><code>Access-Control-Allow-Private-Network: true</code></li>
              </ul>
            </li>
          </ol>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
  `;
    }

    function setupSpoolmanUI() {
        document.getElementById('saveSpoolmanSettingsBtn').addEventListener('click', function() {
            const config = {
                enabled: document.getElementById('spoolmanEnabledCheckbox').checked,
                url: document.getElementById('spoolmanUrlInput').value.trim(),
                autoSync: document.getElementById('spoolmanAutoSyncCheckbox').checked,
                lastSync: getSpoolmanConfig().lastSync
            };

            saveSpoolmanConfig(config);
            showSpoolmanStatus('success', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        });

        document.getElementById('testSpoolmanConnectionBtn').addEventListener('click', async function() {
            const url = document.getElementById('spoolmanUrlInput').value.trim();
            if (!url) {
                showSpoolmanStatus('danger', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å URL');
                return;
            }

            showSpoolmanStatus('info', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
            const result = await testSpoolmanConnection(url);
            if (result.success) {
                showSpoolmanStatus('success', result.message);
            } else {
                showSpoolmanStatus('danger', `${result.message}. –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å CORS Unblock.`);
            }
        });

        document.getElementById('importFromSpoolmanBtn').addEventListener('click', async function() {
            showSpoolmanStatus('info', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Spoolman...');
            this.disabled = true;

            const result = await importAllMaterialsFromSpoolman(msg => showSpoolmanStatus('info', msg));

            this.disabled = false;
            if (result.success) {
                showSpoolmanStatus('success', result.message);
                if (result.errors && result.errors.length > 0) {
                    console.warn('Import completed with errors:', result.errors);
                }
            } else {
                showSpoolmanStatus('danger', result.message);
            }
        });

        document.getElementById('syncToSpoolmanBtn').addEventListener('click', async function() {
            const result = await syncAllMaterialsToSpoolman();
            showSpoolmanStatus('warning', result.message);
        });

        if (document.getElementById('clearSpoolmanDuplicatesBtn')) {
            document.getElementById('clearSpoolmanDuplicatesBtn').addEventListener('click', function() {
                clearSpoolmanDuplicates();
            });
        }
    }

    function clearSpoolmanDuplicates() {
        showSpoolmanStatus('info', '–ü–æ–∏—Å–∫ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤...');

        try {
            const materialsBySpoolmanId = {};
            const duplicates = [];
            appData.materials.forEach(material => {
                if (material.spoolmanSpoolId) {
                    const spoolId = material.spoolmanSpoolId;

                    if (!materialsBySpoolmanId[spoolId]) {
                        materialsBySpoolmanId[spoolId] = [];
                    }

                    materialsBySpoolmanId[spoolId].push(material);
                }
            });

            for (const [spoolId, materials] of Object.entries(materialsBySpoolmanId)) {
                if (materials.length > 1) {
                    console.log(`Found ${materials.length} materials referencing Spoolman spool ${spoolId}`);
                    for (let i = 1; i < materials.length; i++) {
                        duplicates.push(materials[i]);
                    }
                }
            }

            if (duplicates.length > 0) {
                const duplicateIds = new Set(duplicates.map(m => m.id));

                appData.materials = appData.materials.filter(m => !duplicateIds.has(m.id));

                saveToLocalStorage();
                renderGlobalMaterialsTable();

                showSpoolmanStatus('success', `–£–¥–∞–ª–µ–Ω–æ ${duplicates.length} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.`);
            } else {
                showSpoolmanStatus('info', '–î—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.');
            }
        } catch (error) {
            console.error('Error cleaning up duplicates:', error);
            showSpoolmanStatus('danger', `–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${error.message}`);
        }
    }

    function showSpoolmanStatus(type, message) {
        const statusEl = document.getElementById('spoolmanSyncStatus');
        if (!statusEl) return;

        statusEl.className = `alert alert-${type}`;
        statusEl.style.display = 'block';
        statusEl.textContent = message;

        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                    statusEl.style.opacity = '1';
                }, 500);
            }, 5000);
        }
    }

    function initSpoolmanIntegration() {
        const container = document.getElementById('spoolmanSettingsContainer');
        if (!container) return;

        container.innerHTML = createSpoolmanSettingsUI();

        saveToLocalStorage();
        hookMaterialUsage();

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ localStorage
        setTimeout(() => {
            populateSpoolmanUIFromConfig();
        }, 200);
    }

    function scheduleSpoolmanSetup(){
        if(migrationState.needsMigration){
            setTimeout(scheduleSpoolmanSetup, 1000);
            return;
        }
        initSpoolmanIntegration();
        setTimeout(() => {
            setupSpoolmanUI();
        }, 500);
    }

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            scheduleSpoolmanSetup();
        }, 1000);


        console.log(appData);
    });

    const copyCheckBtn = document.getElementById('copyCheckLinkBtn');
    if(copyCheckBtn){
        copyCheckBtn.onclick = function() {
            const linkInput = document.getElementById('checkLinkInput');
            if(linkInput){
                navigator.clipboard.writeText(linkInput.value);
            }
        };
    }

</script>

</body>
</html>
