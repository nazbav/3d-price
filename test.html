<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 3D-–ø–µ—á–∞—Ç–∏ (TEST)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; padding: 0; }totalWeight
    .container { margin-top: 20px; margin-bottom: 20px; }
    .nav-tabs .nav-link.active { font-weight: bold; }
    .small-text { font-size: 0.9rem; color: #555; }
    .footer { margin-top: 40px; font-size: 0.9rem; border-top: 1px solid var(--bs-border-color); padding-top: 10px; }
    table td, table th { vertical-align: middle; white-space: nowrap; }
    .btn-group-sm > .btn { font-size: 0.8rem; padding: 2px 6px; margin-left: 2px; }
    thead th { background-color: var(--bs-table-bg) !important; color: var(--bs-body-color) !important; }
    [data-bs-theme="dark"] thead th { background-color: var(--bs-dark-bg-subtle) !important; color: var(--bs-light) !important; }
    @media (max-width: 576px) {
      .d-flex { flex-wrap: wrap !important; }
      .d-flex > * { margin-top: .5rem; }
    }
@media (max-width: 768px) {
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
  th, td {
    min-width: 100px;
  }
}
    .form-select.form-select-sm { min-width: 120px; }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–∏–∫–µ—Ç–∫–∏ */
    .label-preview { border: 1px solid #000; width: 30mm; height: 20mm; padding: 2mm; font-family: sans-serif; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∏—Ç–æ–≥–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ */
    .order-summary-card {
      max-width: 1200px;
      margin: 1rem auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-wrap: wrap;
    }
    .order-summary-card .order-info {
      flex: 1 1 300px;
      background: #f9fafb;
      padding: 1.5rem;
    }
    .order-summary-card .order-info h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: #4a90e2;
    }
    .order-summary-card .order-info .qr {
      text-align: center;
      margin-bottom: 1rem;
    }
    .order-summary-card .order-info .qr img {
      width: 120px;
      height: 120px;
    }
    .order-summary-card .info-item { margin-bottom: 0.5rem; font-size: 0.95rem; }
    .order-summary-card .info-item .label { font-weight: 600; color: #666; }
    .order-summary-card .info-item .value { margin-left: 0.5rem; font-weight: 500; }

    .order-summary-card .models { flex: 2 1 600px; padding: 1.5rem; }
    .models-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
    .model-card { background: #fff; border-radius: 8px; padding: 1rem; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform .3s ease, box-shadow .3s ease; }
    .model-card:hover { transform: translateY(-4px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    .model-card img { width: 48px; height: 48px; margin-bottom: 0.5rem; }
    .model-card h3 { font-size: 1rem; margin-bottom: 0.5rem; color: #4a90e2; }
    .model-card p { font-size: 0.9rem; margin: 0.25rem 0; color: #666; }
    .model-card p strong { color: #333; }

    @media (max-width: 800px) {
      .order-summary-card { flex-direction: column; }
      .order-summary-card .order-info, .order-summary-card .models { flex: 1 1 auto; }
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="my-4">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 3D-–ø–µ—á–∞—Ç–∏ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)</h1>
    <div class="d-flex gap-2">
      <a href="https://github.com/nazbav/3d-price/blob/master/README.md" class="btn btn-outline-primary" target="_blank">README</a>
      <button class="btn btn-outline-secondary" id="themeToggle">üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</button>
    </div>
  </div>
  <ul class="nav nav-tabs" id="mainTab" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="calculate-tab" data-bs-toggle="tab"
              data-bs-target="#calculatePane" type="button" role="tab" aria-selected="true"
              aria-controls="calculatePane" aria-selected="false">
        –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="history-tab" data-bs-toggle="tab"
              data-bs-target="#historyPane" type="button" role="tab"
              aria-controls="historyPane" aria-selected="false">
        –ò—Å—Ç–æ—Ä–∏—è
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="clients-tab" data-bs-toggle="tab"
              data-bs-target="#clientsPane" type="button" role="tab"
              aria-controls="clientsPane" aria-selected="false">
        –ö–ª–∏–µ–Ω—Ç—ã
      </button>
    </li>

    <li class="nav-item">
      <button class="nav-link" id="printers-tab" data-bs-toggle="tab"
              data-bs-target="#printersPane" type="button" role="tab" aria-controls="printersPane" >
        –ü—Ä–∏–Ω—Ç–µ—Ä—ã
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="globalMaterials-tab" data-bs-toggle="tab"
              data-bs-target="#globalMaterialsPane" type="button" role="tab"
              aria-controls="globalMaterialsPane" aria-selected="false">
        –û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="globalAdditional-tab" data-bs-toggle="tab"
              data-bs-target="#globalAdditionalPane" type="button" role="tab"
              aria-controls="globalAdditionalPane" aria-selected="false">
        –û–±—â–∏–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="settings-tab" data-bs-toggle="tab"
              data-bs-target="#settingsPane" type="button" role="tab"
              aria-controls="settingsPane" aria-selected="false">
        –ù–∞—Å—Ç—Ä–æ–π–∫–∏
      </button>
    </li>
	<li class="nav-item">
      <button class="nav-link" id="summary-tab" data-bs-toggle="tab"
              data-bs-target="#summaryPane" type="button" role="tab"
              aria-controls="summaryPane" aria-selected="false">
        –ò—Ç–æ–≥–∏
      </button>
    </li>

<!--     <li class="nav-item">
      <button class="nav-link" id="importexport-tab" data-bs-toggle="tab"
              data-bs-target="#importexportPane" type="button" role="tab"
              aria-controls="importexportPane" aria-selected="false">
        –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç
      </button>
    </li> -->

  </ul>

  <div class="tab-content" id="mainTabContent">
    <!-- –ü—Ä–∏–Ω—Ç–µ—Ä—ã -->
    <div class="tab-pane fade" id="printersPane" role="tabpanel" aria-labelledby="printers-tab">
      <div class="mt-4">
        <h3>–°–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</h3>
        <p class="small-text">
          –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–ª—è –Ω–µ–≥–æ.
        </p>
        <div class="mb-2">
          <button class="btn btn-primary btn-sm" onclick="onAddPrinter()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä</button>
          <button class="btn btn-danger btn-sm" onclick="massDelete('printers')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
          <button class="btn btn-warning btn-sm" onclick="massEdit('printers')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
          <button class="btn btn-info btn-sm" id="managePrinterProfilesBtn">–ü—Ä–æ—Ñ–∏–ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</button>
        </div>
        <div class="table-responsive">
          <input type="text" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable('printersTable', this.value)">
          <table class="table table-bordered table-hover" id="printersTable">
            <thead class="">
              <tr>
                <th><input type="checkbox" id="selectAll_printers" onchange="selectAll(this, 'printers')"></th>
                <th onclick="sortTable('printersTable',1)">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th onclick="sortTable('printersTable',2)">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</th>
                <th onclick="sortTable('printersTable',3)">–ß–∞—Å—ã –æ–∫—É–ø.</th>
                <th onclick="sortTable('printersTable',4)">–ú–æ—â–Ω. (–í—Ç)</th>
                <th onclick="sortTable('printersTable',5)">–û–±—Å–ª. (‚ÇΩ/—á)</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <hr/>
    </div>

    <!-- –û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã -->
    <div class="tab-pane fade" id="globalMaterialsPane" role="tabpanel" aria-labelledby="globalMaterials-tab">
      <div class="mt-4">
        <h3>–û–±—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
        <p class="small-text">–≠—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º ¬´–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é¬ª. –£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥, –æ—Å—Ç–∞—Ç–æ–∫, –∑–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –∏ –¥–∞—Ç—É –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.</p>
        <div class="mb-2">
          <button class="btn btn-primary btn-sm" onclick="onAddGlobalMaterial()">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
          <button class="btn btn-danger btn-sm" onclick="massDelete('globalMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
          <button class="btn btn-warning btn-sm" onclick="massEdit('globalMaterials')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
          <button class="btn btn-info btn-sm" id="manageMaterialProfilesBtn">–ü—Ä–æ—Ñ–∏–ª–∏ Orca</button>
        </div>
        <div class="table-responsive">
          <input type="text" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable('materialsTable', this.value)">
          <table class="table table-bordered table-hover" id="materialsTable">
            <thead class="">
              <tr>
                <th><input type="checkbox" id="selectAll_globalMaterials" onchange="selectAll(this, 'globalMaterials')"></th>
                <th onclick="sortTable('materialsTable',1)">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th onclick="sortTable('materialsTable',1)">–¢–∏–ø</th>
                <th onclick="sortTable('materialsTable',2)">–°—Ç–æ–∏–º./–∫–≥</th>
                <th onclick="sortTable('materialsTable',3)">–û—Å—Ç–∞—Ç–æ–∫ (–≥—Ä)</th>
                <th onclick="sortTable('materialsTable',4)">–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥)</th>
                <th onclick="sortTable('materialsTable',5)">–í—Ä–µ–º—è –æ—Å—Ç—ã–≤. (–º–∏–Ω)</th>
                <th onclick="sortTable('materialsTable',6)">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</th>
                 <th onclick="sortTable('materialsTable',7)">–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤.</th>
                 <th>–ü—Ä–∏–Ω—Ç–µ—Ä—ã</th>
                 <th>–ü—Ä–æ—Ñ–∏–ª–∏</th>
                 <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –û–±—â–∏–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã -->
    <div class="tab-pane fade" id="globalAdditionalPane" role="tabpanel" aria-labelledby="globalAdditional-tab">
      <div class="mt-4">
        <h3>–û–±—â–∏–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã</h3>
        <div class="mb-2">
          <button class="btn btn-primary btn-sm" onclick="onAddGlobalAdditional()">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
          <button class="btn btn-danger btn-sm" onclick="massDelete('globalAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ</button>
          <button class="btn btn-warning btn-sm" onclick="massEdit('globalAdditional')">–ú–∞—Å—Å–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</button>
        </div>
        <div class="table-responsive">
          <input type="text" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable('additionalGlobalTable', this.value)">
          <table class="table table-bordered table-hover" id="additionalGlobalTable">
            <thead class="">
              <tr>
                <th><input type="checkbox" id="selectAll_globalAdditional" onchange="selectAll(this, 'globalAdditional')"></th>
                <th onclick="sortTable('additionalGlobalTable',1)">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th onclick="sortTable('additionalGlobalTable',2)">–°—Ç–æ–∏–º. (‚ÇΩ)</th>
                <th onclick="sortTable('additionalGlobalTable',3)">–ß–∞—Å—ã –æ–∫—É–ø.</th>
                <th onclick="sortTable('additionalGlobalTable',4)">–í–∫–ª. –≤ —Ä–∞—Å—á—ë—Ç?</th>
                <th>–ü—Ä–∏–Ω—Ç–µ—Ä—ã</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
    <div class="tab-pane fade show active" id="calculatePane" role="tabpanel" aria-labelledby="calculate-tab">
      <div class="my-4">
        <h3>–†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–æ—á–µ—Ä–µ–¥—å –ø–µ—á–∞—Ç–∏)</h3>
        <p class="small-text">
          –î–æ 10 –º–æ–¥–µ–ª–µ–π –Ω–∞ –∫–∞–∂–¥—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞, –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞.
        </p>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="calcName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞:</label>
          <input type="text" id="calcName" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫–∞–∑ 123" />
        </div>
        <div class="col-md-4">
          <label for="calcClientName" class="form-label">–ö–ª–∏–µ–Ω—Ç (–§–ò–û/–∫–æ–º–ø–∞–Ω–∏—è):</label>
          <div class="input-group">
            <input type="text" id="calcClientName" list="clientsList" class="form-control" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" />
            <button class="btn btn-outline-secondary" type="button" onclick="quickAddClient()">+</button>
          </div>
          <datalist id="clientsList"></datalist>
        </div>
        <div class="col-md-4">
          <label for="calcOrderStatus" class="form-label">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:</label>
          <select id="calcOrderStatus" class="form-select" onchange="toggleFinalFields(this.value)">
            <option value="new">–ù–æ–≤—ã–π</option>
            <option value="inprogress">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
            <option value="paid">–û–ø–ª–∞—á–µ–Ω</option>
            <option value="canceled">–û—Ç–º–µ–Ω—ë–Ω</option>
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="calcOrderId" class="form-label">–ö–æ–¥ –∑–∞–∫–∞–∑–∞:</label>
          <input type="text" id="calcOrderId" class="form-control" readonly />
        </div>
      </div>
      <div class="row mb-3" id="calcAdvancedSettings" style="display:none"></div>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="calcShipping" class="form-label">–£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞ (‚ÇΩ):</label>
          <input type="number" step="1" id="calcShipping" class="form-control" />
        </div>
        <div class="col-md-4">
          <label for="calcStartDate" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
          <input type="date" id="calcStartDate" class="form-control" />
        </div>
        <div class="col-md-4">
          <label for="calcParallelPrinting" class="form-label">–£—á—ë—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–µ—á–∞—Ç–∏?</label>
          <select id="calcParallelPrinting" class="form-select">
            <option value="no">–ù–µ—Ç</option>
            <option value="yes">–î–∞</option>
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="calcMarkupPercent" class="form-label">–ù–∞—Ü–µ–Ω–∫–∞ (%):</label>
          <input type="number" step="1" id="calcMarkupPercent" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcDiscountPercent" class="form-label">–°–∫–∏–¥–∫–∞ (%):</label>
          <input type="number" step="1" id="calcDiscountPercent" class="form-control" />
        </div>
        <div class="col-md-3 d-none" id="finalCostGroup">
          <label for="calcFinalCost" class="form-label">–§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (‚ÇΩ):</label>
          <input type="number" step="0.01" id="calcFinalCost" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="calcPreparationTime" class="form-label">–ß–∞—Å—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (—á:–º):</label>
          <input type="text" id="calcPreparationTime" class="form-control" onblur="this.value = formatTimeForDisplay(handleTimeInput({target:{value:this.value}}))" />
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-12">
          <label class="form-label">–£—Å–ª—É–≥–∏:</label>
          <div class="table-responsive">
            <table class="table table-sm table-bordered" id="customServicesTable">
              <thead>
                <tr>
                  <th>–í–∫–ª.</th>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥.</th>
                  <th>–ö–æ–ª-–≤–æ</th>
                  <th>–¢–∏–ø</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <button class="btn btn-sm btn-primary" onclick="addCustomService()">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</button>
        </div>
      </div>
      <hr/>
      <div id="calcPrintersContainer"></div>
        <div class="d-flex mt-3" style="justify-content: space-between;">
        <button class="btn btn-success" onclick="onCalculateAll()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Å—ë</button>
        <button class="btn btn-secondary ms-2" onclick="startNewCalculation()">–ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</button>
      </div>
      <div class="alert alert-info mt-3" id="calcResult" style="display: none;"></div>
      <div class="mt-2">
        <button class="btn btn-secondary" id="downloadAllLabelsBtn" style="display:none">–°–∫–∞—á–∞—Ç—å –≤—Å–µ —ç—Ç–∏–∫–µ—Ç–∫–∏</button>
        <button class="btn btn-secondary ms-2" id="downloadSummaryCardBtn" style="display:none">–°–∫–∞—á–∞—Ç—å —Å—á—ë—Ç</button>
        <button class="btn btn-primary ms-2" id="sendMyNalogBtn" style="display:none">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫</button>
        <button class="btn btn-danger ms-2" id="cancelMyNalogBtn" style="display:none">–û—Ç–º–µ–Ω–∏—Ç—å —á–µ–∫</button>
      </div>
    </div>

    <!-- –ò—Ç–æ–≥–∏ -->
    <div class="tab-pane fade" id="summaryPane" role="tabpanel" aria-labelledby="summary-tab">
      <div class="mt-4">
        <h3>–û–±—â–∏–π –æ–±–∑–æ—Ä (¬´–ò—Ç–æ–≥–∏¬ª)</h3>
        <p class="small-text">–°—É–º–º–∞—Ä–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º, –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º (–±–µ–∑. —É—á –æ—Å—Ç–∞—Ç–∫–∞).</p>
        <div class="d-flex align-items-center mb-3">
          <select id="summaryPeriod" class="form-select form-select-sm w-auto me-2">
            <option value="all">–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</option>
            <option value="week">–ù–µ–¥–µ–ª—è</option>
            <option value="month">–ú–µ—Å—è—Ü</option>
            <option value="year">–ì–æ–¥</option>
            <option value="custom">–†—É—á–Ω–æ–π</option>
          </select>
          <input type="date" id="summaryFrom" class="form-control form-control-sm w-auto me-2 d-none">
          <input type="date" id="summaryTo" class="form-control form-control-sm w-auto me-2 d-none">
          <button class="btn btn-primary btn-sm d-none" id="summaryApplyBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div id="summaryContent"></div>
      </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div class="tab-pane fade" id="historyPane" role="tabpanel" aria-labelledby="history-tab">
      <div class="mt-4">
        <h3>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤</h3>
        <p class="small-text">
          –ü—Ä–æ—à–ª—ã–µ —Ä–∞—Å—á—ë—Ç—ã. –ö–Ω–æ–ø–∫–∏: ¬´JSON¬ª ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ–±—ä–µ–∫—Ç, ¬´HTML¬ª ‚Äî —Å–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç, ¬´–†–µ–¥–∞–∫—Ç.¬ª ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.
        </p>
        <button class="btn btn-danger mb-3" onclick="onClearCalcHistory()">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <div class="table-responsive">
          <input type="text" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable('historyTable', this.value)">
          <table class="table table-bordered table-hover" id="historyTable">
            <thead class="">
              <tr>
                <th onclick="sortTable('historyTable',0)">–î–∞—Ç–∞/–≤—Ä–µ–º—è</th>
                <th onclick="sortTable('historyTable',1)">–ö–æ–¥</th>
                <th onclick="sortTable('historyTable',2)">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞</th>
                <th onclick="sortTable('historyTable',3)">–ö–ª–∏–µ–Ω—Ç</th>
                <th onclick="sortTable('historyTable',4)">–°—Ç–∞—Ç—É—Å</th>
                <th onclick="sortTable('historyTable',5)">–ò—Ç–æ–≥ (‚ÇΩ)</th>
                <th>–ß–µ–∫</th>
                <th>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="row g-2 mt-3">
            <div class="col-auto">
              <input type="date" class="form-control" id="histFrom">
            </div>
            <div class="col-auto">
              <input type="date" class="form-control" id="histTo">
            </div>
            <div class="col-auto">
              <button class="btn btn-primary" onclick="updateHistoryStats()">–§–∏–ª—å—Ç—Ä</button>
            </div>
          </div>
          <div id="historyStats" class="mt-2"></div>
        </div>
      </div>
    </div>

    <!-- –ö–ª–∏–µ–Ω—Ç—ã -->
    <div class="tab-pane fade" id="clientsPane" role="tabpanel" aria-labelledby="clients-tab">
      <div class="mt-4">
        <h3>–ö–ª–∏–µ–Ω—Ç—ã</h3>
        <div class="mb-2">
          <button class="btn btn-primary btn-sm" onclick="onAddClient()">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
        </div>
        <div class="table-responsive">
          <input type="text" class="form-control form-control-sm mb-2" placeholder="–ü–æ–∏—Å–∫..." oninput="filterTable('clientsTable', this.value)">
          <table class="table table-bordered table-hover" id="clientsTable">
            <thead>
              <tr>
                <th onclick="sortTable('clientsTable',0)">–ò–º—è</th>
                <th onclick="sortTable('clientsTable',1)">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                <th onclick="sortTable('clientsTable',2)">–°—Å—ã–ª–∫–∏</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç -->
<!-- <div class="tab-pane fade" id="importexportPane" role="tabpanel" aria-labelledby="importexport-tab">
        <div class="mt-4">
<h3>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>

    <button class="btn btn-primary" onclick="onExportJson()">–í—ã–≥—Ä—É–∑–∏—Ç—å JSON</button>
    <button class="btn btn-info" id="downloadJsonFileBtn">–°–∫–∞—á–∞—Ç—å JSON —Ñ–∞–π–ª</button>
    <button class="btn btn-secondary" onclick="onExportHistory()">–í—ã–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <textarea id="exportArea" class="form-control mt-2" rows="5"></textarea>

  <hr>
  <div class="mt-4">
    <h3>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
    <textarea id="importArea" class="form-control" rows="5"></textarea>
    <input type="file" id="importJsonFile" class="form-control mt-2" accept=".json">
    <button class="btn btn-success mt-2" onclick="onImportJson()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button class="btn btn-info mt-2" onclick="importFromFile()">–ò–º–ø–æ—Ä—Ç –∏–∑ —Ñ–∞–π–ª–∞</button>
    <button class="btn btn-secondary mt-2" onclick="onImportHistory()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
  </div>
</div>
  </div>  -->
  </div>
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<div class="tab-pane fade" id="settingsPane" role="tabpanel" aria-labelledby="settings-tab">
  <div class="row mt-4">
    <div class="col-md-3 mb-3">
      <div class="nav flex-column nav-pills" id="settingsSubTab" role="tablist">
        <button class="nav-link active" id="brand-set-tab" data-bs-toggle="pill" data-bs-target="#brandSet" type="button" role="tab">–ë—Ä–µ–Ω–¥–∏–Ω–≥</button>
        <button class="nav-link" id="calc-set-tab" data-bs-toggle="pill" data-bs-target="#calcSet" type="button" role="tab">–ö–∞–ª—å–∫—É–ª—è—Ü–∏—è</button>
        <button class="nav-link" id="cloud-set-tab" data-bs-toggle="pill" data-bs-target="#cloudSet" type="button" role="tab">–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="nav-link" id="nalog-set-tab" data-bs-toggle="pill" data-bs-target="#nalogSet" type="button" role="tab">–ú–æ–π –ù–∞–ª–æ–≥</button>
      </div>
    </div>
    <div class="col-md-9">
      <div class="tab-content" id="settingsSubTabContent">
        <div class="tab-pane fade show active" id="brandSet" role="tabpanel">
          <h3>–ë—Ä–µ–Ω–¥–∏–Ω–≥</h3>
          <div class="mb-3">
            <label for="companyNameInput" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏:</label>
            <input type="text" id="companyNameInput" class="form-control"/>
          </div>
          <div class="mb-3">
            <label for="chatLinkInput" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç (QR):</label>
            <input type="text" id="chatLinkInput" class="form-control"/>
          </div>
          <div class="mb-3">
            <label for="bankDetailsInput" class="form-label">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã (—Ä/—Å):</label>
            <textarea id="bankDetailsInput" class="form-control" rows="4"></textarea>
          </div>
          <div class="mb-3">
            <label for="calcWorkHoursDay" class="form-label">–†–∞–±. —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å:</label>
            <input type="number" id="calcWorkHoursDay" class="form-control" />
          </div>
          <button class="btn btn-primary" onclick="saveBrandingSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="tab-pane fade" id="calcSet" role="tabpanel">
          <h3>–ö–∞–ª—å–∫—É–ª—è—Ü–∏—è</h3>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="printLabelsCheckbox">
            <label class="form-check-label" for="printLabelsCheckbox">–ü–µ—á–∞—Ç–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏</label>
          </div>
          <div class="mb-3">
            <label for="labelCostInput" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å 1 —ç—Ç–∏–∫–µ—Ç–∫–∏ (‚ÇΩ):</label>
            <input type="number" step="0.01" id="labelCostInput" class="form-control"/>
          </div>
          <div class="mb-3">
            <label for="calcOperatorRate" class="form-label">–°—Ç–∞–≤–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (‚ÇΩ/—á):</label>
            <input type="number" step="0.01" id="calcOperatorRate" class="form-control" />
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="calcOperatorReject">
            <label class="form-check-label" for="calcOperatorReject">–£—á–µ—Å—Ç—å —Å—Ç–∞–≤–∫—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –±—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π</label>
          </div>
          <div class="mb-3">
            <label for="calcDowntimeCost" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∏–Ω—É—Ç—ã –ø—Ä–æ—Å—Ç–æ—è (‚ÇΩ/–º–∏–Ω):</label>
            <input type="number" step="0.01" id="calcDowntimeCost" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="calcPreparationRate" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å —á–∞—Å–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (‚ÇΩ/—á):</label>
            <input type="number" step="0.01" id="calcPreparationRate" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="calcCostKwh" class="form-label">–¶–µ–Ω–∞ 1‚ÄØ–∫–í—Ç‚ãÖ—á (‚ÇΩ):</label>
            <input type="number" step="0.01" id="calcCostKwh" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="calcTaxPercent" class="form-label">–ù–∞–ª–æ–≥ (%):</label>
            <input type="number" step="1" id="calcTaxPercent" class="form-control" />
          </div>
          <button class="btn btn-primary" onclick="saveCalcSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    <div class="tab-pane fade" id="cloudSet" role="tabpanel">
<div class="mt-4">
          <h3>–û–±–ª–∞—á–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç</h3>
          <button class="btn btn-primary mt-2" onclick="generateSyncLinkAndQR()">üîó –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –∏ QR</button>
          <button class="btn btn-warning mt-2" onclick="saveSettingsToCloud()">‚òÅÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ (–Ω–∞ 5 –º–∏–Ω—É—Ç)</button>
          <button class="btn btn-info mt-2" onclick="loadSettingsFromCloud()">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
          <input type="text" id="syncLinkDisplay" class="form-control mt-2" readonly>
          <div id="qrcode" class="mt-2"></div>
</div>
<div class="mt-4">
<h3>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
    <button class="btn btn-primary" onclick="onExportJson()">–í—ã–≥—Ä—É–∑–∏—Ç—å JSON</button>
    <button class="btn btn-info" id="downloadJsonFileBtn">–°–∫–∞—á–∞—Ç—å JSON —Ñ–∞–π–ª</button>
    <button class="btn btn-secondary" onclick="onExportHistory()">–í—ã–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <textarea id="exportArea" class="form-control mt-2" rows="5"></textarea>
</div>
<div class="mt-4">
    <h3>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
    <textarea id="importArea" class="form-control" rows="5"></textarea>
    <input type="file" id="importJsonFile" class="form-control mt-2" accept=".json">
    <button class="btn btn-success mt-2" onclick="onImportJson()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button class="btn btn-info mt-2" onclick="importFromFile()">–ò–º–ø–æ—Ä—Ç –∏–∑ —Ñ–∞–π–ª–∞</button>
    <button class="btn btn-secondary mt-2" onclick="onImportHistory()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
</div>

        </div>
        <div class="tab-pane fade" id="nalogSet" role="tabpanel">
          <h3>–ú–æ–π –ù–∞–ª–æ–≥</h3>
          <div class="mb-3">
            <label for="myNalogToken" class="form-label">–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞:</label>
            <input type="text" id="myNalogToken" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="myNalogPhone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
            <input type="text" id="myNalogPhone" class="form-control" />
          </div>
          <div class="mb-3">
            <button class="btn btn-secondary" id="requestSmsBtn">–ó–∞–ø—Ä–æ—Å–∏—Ç—å SMS</button>
          </div>
          <div class="mb-3">
            <label for="myNalogSms" class="form-label">–ö–æ–¥ –∏–∑ SMS:</label>
            <input type="text" id="myNalogSms" class="form-control" />
            <button class="btn btn-primary mt-2" id="confirmSmsBtn">–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
          </div>
          <div class="mb-3">
            <button class="btn btn-primary" onclick="saveMyNalogSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-info ms-2" onclick="checkMyNalogStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
          </div>
          <div id="myNalogStatus" class="small-text"></div>
        </div>
      </div>
    </div>
  </div>
</div>
  </div>
  <div class="footer" style="text-align:center">
    <p class="mb-1">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ LocalStorage –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.</p>
    <p class="mb-0">–î–ª—è —Å–±—Ä–æ—Å–∞ –º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–π JSON –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å LocalStorage –≤—Ä—É—á–Ω—É—é.</p>
    <a href="index2.html"><h6>–ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ (—Ç—ã–∫)</h6></a>
    <p class="mt-3"><span style="text-decoration:line-through">¬©</span>2025. –ù–∏—á—å–∏ –ø—Ä–∞–≤–∞ –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã. –°–¥–µ–ª–∞–Ω–æ –ø—Ä–∏ —É—á–∞—Å—Ç–∏–∏ –ò–ò</p>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Å—ã–ª–∫–∏ -->
<div class="modal fade" id="incomingDataModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Å—ã–ª–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="targetOrderSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—á—ë—Ç</label>
          <select id="targetOrderSelect" class="form-select">
            <option value="new">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="importLinkApplyBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ OrcaSlicer -->
<div class="modal fade" id="orcaPrinterModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ OrcaSlicer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex mb-2">
          <select id="orcaProfileSelect" class="form-select me-2"></select>
          <button type="button" class="btn btn-danger btn-sm" id="delOrcaProfileBtn">‚úñ</button>
        </div>
        <pre id="orcaPrinterJsonView" class="p-2 border mt-2"></pre>
        <pre id="orcaPrinterInfoView" class="p-2 border mt-2"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ -->
<div class="modal fade" id="printerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ü—Ä–∏–Ω—Ç–µ—Ä</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" class="form-control" id="printerNameInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>
          <input type="number" class="form-control" id="printerCostInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏</label>
          <input type="number" class="form-control" id="printerHoursInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–ú–æ—â–Ω–æ—Å—Ç—å (–í—Ç)</label>
          <input type="number" class="form-control" id="printerPowerInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–û–±—Å–ª. (‚ÇΩ/—á)</label>
          <input type="number" class="form-control" id="printerMaintInput">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="savePrinterBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
<div class="modal fade" id="materialModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ú–∞—Ç–µ—Ä–∏–∞–ª</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <div class="mb-2">
          <label class="form-label">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (PLA, PETG –∏ —Ç.–¥.)</label>
          <input type="text" class="form-control" id="matMaterialTypeInput">
        </div>

        <div class="mb-2">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" class="form-control" id="matNameInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥</label>
          <input type="number" class="form-control" id="matCostInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥)</label>
          <input type="number" class="form-control" id="matBalanceInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥)</label>
          <input type="number" class="form-control" id="matDeclaredInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–í—Ä–µ–º—è –æ—Å—Ç—ã–≤–∞–Ω–∏—è (–º–∏–Ω)</label>
          <input type="number" class="form-control" id="matCoolingTimeInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–¶–≤–µ—Ç</label>
          <input type="color" class="form-control form-control-color" id="matColorInput" value="#ffffff">
        </div>
        <div class="mb-2">
          <label class="form-label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
          <input type="text" class="form-control" id="matManufInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</label>
          <input type="text" class="form-control" id="matProdDateInput">
        </div>
        <div class="mb-2">
          <label class="form-label">–ü—Ä–∏–Ω—Ç–µ—Ä—ã</label>
          <select multiple class="form-select" id="matPrintersSelect"></select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="saveMaterialBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
    </div>
  </div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏ -->
<div class="modal fade" id="materialProfileLinkModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ü—Ä–æ—Ñ–∏–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <select multiple class="form-select" id="materialProfileLinkSelect"></select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="applyMaterialProfileLinkBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π Orca -->
<div class="modal fade" id="manageMaterialProfilesModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ü—Ä–æ—Ñ–∏–ª–∏ Orca</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
        </div>
        <table class="table table-bordered table-sm">
          <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
          <tbody id="materialProfilesTable"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ -->
<div class="modal fade" id="managePrinterProfilesModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ü—Ä–æ—Ñ–∏–ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered table-sm">
          <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ü—Ä–∏–Ω—Ç–µ—Ä</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
          <tbody id="printerProfilesTable"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

</div>

<!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö -->
<div class="modal fade" id="multiPromptModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="multiPromptTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="multiPromptBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="multiPromptOk">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ —á–µ–∫ -->
<div class="modal fade" id="checkLinkModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–°—Å—ã–ª–∫–∞ –Ω–∞ —á–µ–∫</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <label for="checkLinkInput" class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
        <div class="input-group mb-3">
          <input type="text" readonly class="form-control" id="checkLinkInput">
          <button class="btn btn-outline-secondary" type="button" id="copyCheckLinkBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="modelingCalculatorModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="modelingRateInput" class="form-label">–°—Ç–∞–≤–∫–∞ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è (‚ÇΩ/—á):</label>
          <input type="number" step="0.01" class="form-control" id="modelingRateInput" />
        </div>
        <div class="mb-3">
          <label for="modelingTimeInput" class="form-label">–í—Ä–µ–º—è –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è (—á):</label>
          <input type="number" step="0.1" class="form-control" id="modelingTimeInput" />
        </div>
        <div class="mb-3">
          <label for="modelingComplexityInput" class="form-label">–ú–Ω–æ–∂–∏—Ç–µ–ª—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</label>
          <select class="form-select" id="modelingComplexityInput">
            <option value="1">–ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å (x1.0)</option>
            <option value="1.5">–°—Ä–µ–¥–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å (x1.5)</option>
            <option value="2">–°–ª–æ–∂–Ω–∞—è –º–æ–¥–µ–ª—å (x2.0)</option>
            <option value="2.5">–û—á–µ–Ω—å —Å–ª–æ–∂–Ω–∞—è (x2.5)</option>
            <option value="3">–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ —Å–ª–æ–∂–Ω–∞—è (x3.0)</option>
          </select>
        </div>
        <div class="alert alert-info">
          <strong>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç:</strong>
          <div id="modelingPreview">0.00 ‚ÇΩ</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" onclick="calculateModelingCost()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="utils/normalizeIds.js"></script>
<script>
const _instrumentInitialKeys = new Set(Object.keys(window));

function instrumentFunctions(){
  const newKeys = Object.keys(window).filter(k=>!_instrumentInitialKeys.has(k) && typeof window[k]==='function');
  newKeys.forEach(fnName=>{
    const original = window[fnName];
    window[fnName] = function(...args){
      console.log('‚ñ∂', fnName, 'called with', args);
      try{
        const result = original.apply(this,args);
        if(result instanceof Promise){
          return result.then(r=>{console.log('‚úî', fnName, 'resolved with', r); return r;})
                       .catch(err=>{console.error('‚úñ', fnName, 'rejected with', err); throw err;});
        }
        console.log('‚úî', fnName, 'returned', result);
        return result;
      }catch(e){
        console.error('‚úñ', fnName, 'threw', e);
        throw e;
      }
    };
  });
  console.log('Instrumented functions:', newKeys);
}
const THEME_STORAGE_KEY = "themePreference";
function setTheme(theme) {
  document.documentElement.setAttribute("data-bs-theme", theme);
  localStorage.setItem(THEME_STORAGE_KEY, theme);
  const btn = document.getElementById("themeToggle");
  btn.innerText = theme==="dark" ? "‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞" : "üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞";
}
document.getElementById("themeToggle").addEventListener("click",()=>{
  const th = document.documentElement.getAttribute("data-bs-theme");
  setTheme(th==="dark"?"light":"dark");
});
const savedTheme = localStorage.getItem(THEME_STORAGE_KEY)||"light";
setTheme(savedTheme);

function getNextId(type) {
  if (!appData.counters) appData.counters = {};
  if (!appData.counters[type]) appData.counters[type] = 0;
  return ++appData.counters[type];
}

function getNextOrderId() {
  if (!appData.counters) appData.counters = {};
  const maxExisting = Array.isArray(appData.calcHistory)
    ? appData.calcHistory.reduce((max, h) => {
        const id = parseInt(h.id, 10);
        return isNaN(id) ? max : Math.max(max, id);
      }, 0)
    : 0;
  const current = appData.counters.orders || 0;
  const next = Math.max(current, maxExisting) + 1;
  appData.counters.orders = next;
  return String(next);
}

/* –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ */
function migrateOldData(obj){
  if(!Array.isArray(obj.printers)) obj.printers = [];
  if(!Array.isArray(obj.materials)) obj.materials = [];
  if(!Array.isArray(obj.additionalGlobal)) obj.additionalGlobal = [];
  if(!Array.isArray(obj.clients)) obj.clients = [];
  if(!Array.isArray(obj.calcHistory)) obj.calcHistory = [];

  if(!obj.calcSettings) obj.calcSettings = {};
  if(typeof obj.calcSettings.downtimeCost !== 'number') obj.calcSettings.downtimeCost = 0;
  if(typeof obj.calcSettings.preparationRate !== 'number') obj.calcSettings.preparationRate = 0;
  if(typeof obj.calcSettings.preparationTime !== 'number') obj.calcSettings.preparationTime = 0;
  if(typeof obj.calcSettings.includeOperatorForRejects !== 'boolean') obj.calcSettings.includeOperatorForRejects = false;

  if (!obj.counters) {
    obj.counters = {
      printers: obj.printers.length,
      clients: obj.clients.length,
      materials: obj.materials.length,
      additionalGlobal: obj.additionalGlobal.length
    };
  }

  const unresolved = [];

  // –ü–µ—Ä–µ–Ω–æ—Å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏–∑ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
  obj.printers.forEach(pr=>{
    if(Array.isArray(pr.materials)){
      pr.materials.forEach(m=>{
        if(!obj.materials.some(g=>g.id===m.id)){
          m.printers = [String(pr.id)];
          obj.materials.push(m);
        }
      });
    }
    if(Array.isArray(pr.additional)){
      pr.additional.forEach(a=>{
        if(!obj.additionalGlobal.some(g=>g.id===a.id)){
          a.printers = [String(pr.id)];
          obj.additionalGlobal.push(a);
        }
      });
    }
    delete pr.materials;
    delete pr.additional;


  });

  // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –∞–¥—Ä–µ—Å—É
  const uniqList = [];
  const pMap = {};
  if(!Array.isArray(obj.printerProfiles)) obj.printerProfiles=[];
  obj.printers.forEach(pr=>{
    if(!Array.isArray(pr.profileIds)) pr.profileIds=[];
    if(Array.isArray(pr.orcaProfiles)){
      pr.orcaProfiles.forEach(op=>{
        const pid=op.id||getNextId('printerProfiles');
        obj.printerProfiles.push({id:pid,config:op.config||{},info:op.info||'',printerId:String(pr.id)});
        if(!pr.profileIds.includes(pid)) pr.profileIds.push(pid);
      });
    } else if(pr.orca || pr.orcaInfo){
      const pid=getNextId('printerProfiles');
      obj.printerProfiles.push({id:pid,config:pr.orca||{},info:pr.orcaInfo||'',printerId:String(pr.id)});
      pr.profileIds.push(pid);
    }
    delete pr.orcaProfiles;
    delete pr.orca;
    delete pr.orcaInfo;
  });
  obj.printers.forEach(pr=>{
    const key = (pr.print_host||'').toLowerCase() + '|' + (pr.name||'').toLowerCase();
    const existing = pMap[key];
    if(existing){
      pr.profileIds.forEach(pid=>{
        if(!existing.profileIds.includes(pid)){
          existing.profileIds.push(pid);
          const pf=obj.printerProfiles.find(x=>String(x.id)===String(pid));
          if(pf) pf.printerId=String(existing.id);
        }
      });
      ['cost','hoursToRecoup','power','maintCostHour'].forEach(f=>{ if(!existing[f] && pr[f]) existing[f]=pr[f]; });
    } else {
      pMap[key]=pr; uniqList.push(pr);
    }
  });
  obj.printers = uniqList;

  // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
  const uniqMat = [];
  const mMap = {};
  obj.materials.forEach(m=>{
    const key = String(m.id||'') + '|' + (m.name||'');
    if(!mMap[key]){ mMap[key]=m; uniqMat.push(m); }
  });
  obj.materials = uniqMat;

  // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
  const uniqAdd = [];
  const aMap = {};
  obj.additionalGlobal.forEach(a=>{
    const key = String(a.id||'') + '|' + (a.description||'');
    if(!aMap[key]){ aMap[key]=a; uniqAdd.push(a); }
  });
  obj.additionalGlobal = uniqAdd;

  // –ö–∞—Ä—Ç–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–º–µ–Ω—ã
  const idMap = {};
  obj.printers.forEach(pr=>{
    idMap[String(pr.id).toLowerCase()] = pr;
    if(pr.print_host) idMap[String(pr.print_host).toLowerCase()] = pr;
    if(pr.name) idMap[pr.name.toLowerCase()] = pr;
    (pr.profileIds||[]).forEach(pid=>{
      const pf=obj.printerProfiles.find(x=>String(x.id)===String(pid));
      const cfg=pf?pf.config||{}:{};
      if(cfg.printer_settings_id) idMap[String(cfg.printer_settings_id).toLowerCase()] = pr;
      if(cfg.name) idMap[String(cfg.name).toLowerCase()] = pr;
    });
  });
  function ensurePrinter(ref){
    if(!ref) return null;
    return idMap[String(ref).toLowerCase()] || null;
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—á—ë—Ç–æ–≤ –∏ calcData
  obj.calcHistory.forEach(h=>{
    if(h.nalogInn) delete h.nalogInn;
    if(Array.isArray(h.nalogReceipts)){
      h.nalogReceipts = h.nalogReceipts.map(r=>({uuid:r.uuid, canceled: !!r.canceled}));
    }
    if(!h.markupPercent) h.markupPercent = 0;
    if(!h.discountPercent) h.discountPercent = 0;
    if(!h.globalAdditional) h.globalAdditional = {sumGlobalAdd:0,taxAmount:0,details:[]};
    if(typeof h.downtimeMinutes !== 'number') h.downtimeMinutes = 0;
    if(typeof h.downtimeCost !== 'number') h.downtimeCost = 0;
    if(typeof h.preparationTime !== 'number') h.preparationTime = 0;
    if(typeof h.preparationCost !== 'number') h.preparationCost = 0;
    if(Array.isArray(h.details)){
      h.details.forEach(d=>{
        let pr = ensurePrinter(d.printerId) || ensurePrinter(d.printerName?.toLowerCase());
        if(pr){
          d.printerId = pr.id;
          d.printerName = pr.name;
        } else {
          unresolved.push({history:h,ref:d.printerId,origName:d.printerName||d.printerId,model:d.modelName||''});
        }
      });
    }
    if(h.calcData){
      const newCD = {};
      for(const pid in h.calcData){
        let pr = ensurePrinter(pid);
        if(!pr){
          const det = (h.details||[]).find(d=>String(d.printerId)===String(pid));
          pr = det? ensurePrinter(det.printerId) : null;
        }
        if(pr){
          newCD[pr.id] = h.calcData[pid];
        } else {
          const det = (h.details||[]).find(d=>String(d.printerId)===String(pid));
          unresolved.push({history:h,ref:pid,origName:pid,model:det?det.modelName||'':''});
          newCD[pid] = h.calcData[pid];
        }
      }
      h.calcData = newCD;
    }
  });

  // –ü–µ—Ä–µ–Ω–æ—Å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
  const nameMap = {};
  obj.calcHistory.forEach(h=>{
    const nm = h.clientName;
    if(!nm) return;
    let c = obj.clients.find(x=>x.name===nm);
    if(!c){
      if(nameMap[nm]){
        c = nameMap[nm];
      }else{
        c = {id: getNextId('clients'), name: nm};
        obj.clients.push(c);
        nameMap[nm] = c;
      }
    }
    if(!h.clientId) h.clientId = c.id;
  });

  obj.materials.forEach(m=>{ if(!m.printers) m.printers=[]; });
  if(!Array.isArray(obj.materialProfiles)) obj.materialProfiles=[];
  obj.materials.forEach(m=>{
    if(typeof m.coolingTime !== 'number') m.coolingTime = 0;
    if(!Array.isArray(m.profileIds)) m.profileIds=[];
    if(m.orca || m.orcaInfo){
      const pf={id:getNextId('materialProfiles'),config:m.orca||{},info:m.orcaInfo||''};
      obj.materialProfiles.push(pf);
      m.profileIds.push(pf.id);
    }
    delete m.orca;
    delete m.orcaInfo;
  });
  obj.additionalGlobal.forEach(a=>{ if(!a.printers) a.printers=[]; });
  if(!Array.isArray(obj.printerProfiles)) obj.printerProfiles=[];
  obj.printers.forEach(p=>{ if(!Array.isArray(p.profileIds)) p.profileIds=[]; });

  // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏–Ω—Ç–µ—Ä—ã –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  const used = new Set();
  obj.calcHistory.forEach(h=>{
    if(Array.isArray(h.details)) h.details.forEach(d=> used.add(String(d.printerId)) );
    if(h.calcData) Object.keys(h.calcData).forEach(pid=> used.add(String(pid)) );
  });
  obj.printers = obj.printers.filter(p=> !p.isTemp || used.has(String(p.id)) );
  return obj;
}

function showMultiPrompt(title, fields){
  return new Promise(res=>{
    const body = document.getElementById('multiPromptBody');
    body.innerHTML = '';
    document.getElementById('multiPromptTitle').textContent = title;
    fields.forEach(f=>{
      if(f.type==='checkbox'){
        const div=document.createElement('div');
        div.className='form-check mb-2';
        const inp=document.createElement('input');
        inp.type='checkbox';
        inp.className='form-check-input';
        inp.id='mp_'+f.id;
        inp.checked=!!f.value;
        const lbl=document.createElement('label');
        lbl.className='form-check-label ms-2';
        lbl.setAttribute('for','mp_'+f.id);
        lbl.textContent=f.label;
        div.appendChild(inp); div.appendChild(lbl); body.appendChild(div);
      } else if(f.type==='multiselect'){
        const div=document.createElement('div');
        div.className='mb-2';
        const lbl=document.createElement('label');
        lbl.className='form-label';
        lbl.textContent=f.label;
        const sel=document.createElement('select');
        sel.className='form-select';
        sel.multiple=true;
        sel.id='mp_'+f.id;
        (f.options||[]).forEach(opt=>{
          const o=document.createElement('option');
          o.value=opt.value;
          o.textContent=opt.label;
          if(f.value&&f.value.includes(opt.value)) o.selected=true;
          sel.appendChild(o);
        });
        div.appendChild(lbl); div.appendChild(sel); body.appendChild(div);
      } else if(f.type==='select'){
        const div=document.createElement('div');
        div.className='mb-2';
        const lbl=document.createElement('label');
        lbl.className='form-label';
        lbl.textContent=f.label;
        const sel=document.createElement('select');
        sel.className='form-select';
        sel.id='mp_'+f.id;
        (f.options||[]).forEach(opt=>{
          const o=document.createElement('option');
          o.value=opt.value;
          o.textContent=opt.label;
          if(f.value==opt.value) o.selected=true;
          sel.appendChild(o);
        });
        div.appendChild(lbl); div.appendChild(sel); body.appendChild(div);
      } else if(f.type==='textarea'){
        const div=document.createElement('div');
        div.className='mb-2';
        const lbl=document.createElement('label');
        lbl.className='form-label';
        lbl.textContent=f.label;
        const area=document.createElement('textarea');
        area.className='form-control';
        area.rows=f.rows||3;
        area.id='mp_'+f.id;
        area.value=f.value||'';
        div.appendChild(lbl); div.appendChild(area); body.appendChild(div);
      } else {
        const div=document.createElement('div');
        div.className='mb-2';
        const lbl=document.createElement('label');
        lbl.className='form-label';
        lbl.textContent=f.label;
        const inp=document.createElement('input');
        inp.className='form-control';
        inp.type=f.type||'text';
        inp.id='mp_'+f.id;
        inp.value=f.value||'';
        div.appendChild(lbl); div.appendChild(inp); body.appendChild(div);
      }
    });
    const modal = new bootstrap.Modal(document.getElementById('multiPromptModal'));
    document.getElementById('multiPromptOk').onclick = () => {
      const result={};
      fields.forEach(f=>{
        const el=document.getElementById('mp_'+f.id);
        if(f.type==='checkbox') result[f.id] = el.checked;
        else if(f.type==='multiselect') result[f.id] = Array.from(el.selectedOptions).map(o=>o.value);
        else if(f.type==='select') result[f.id] = el.value;
        else if(f.type==='textarea') result[f.id] = el.value;
        else result[f.id] = el.value;
      });
      modal.hide();
      res(result);
    };
    modal.show();
  });
}

function showMaterialSelectionForGcode(fileName, thumbnail, materialOptions) {
  return new Promise(res => {
    const body = document.getElementById('multiPromptBody');
    body.innerHTML = '';
    document.getElementById('multiPromptTitle').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –º–æ–¥–µ–ª–∏';
    
    // Create container for model info
    const modelInfoDiv = document.createElement('div');
    modelInfoDiv.className = 'mb-3 p-3 border rounded bg-light';
    
    // Add thumbnail if available
    if (thumbnail) {
      const thumbImg = document.createElement('img');
      thumbImg.src = `data:image/png;base64,${thumbnail}`;
      thumbImg.style.cssText = 'width: 80px; height: 80px; object-fit: contain; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; display: block;';
      modelInfoDiv.appendChild(thumbImg);
    }
    
    // Add filename
    const fileNameDiv = document.createElement('div');
    fileNameDiv.innerHTML = `<strong>–§–∞–π–ª:</strong> ${fileName}`;
    fileNameDiv.className = 'mb-2';
    modelInfoDiv.appendChild(fileNameDiv);
    
    body.appendChild(modelInfoDiv);
    
    // Add material selection
    const materialDiv = document.createElement('div');
    materialDiv.className = 'mb-2';
    
    const label = document.createElement('label');
    label.className = 'form-label';
    label.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª:';
    
    const select = document.createElement('select');
    select.className = 'form-select';
    select.id = 'mp_materialId';
    
    // Add default option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª --';
    select.appendChild(defaultOption);
    
    // Add material options
    materialOptions.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt.value;
      option.textContent = opt.label;
      select.appendChild(option);
    });
    
    materialDiv.appendChild(label);
    materialDiv.appendChild(select);
    body.appendChild(materialDiv);
    
    const modal = new bootstrap.Modal(document.getElementById('multiPromptModal'));
    document.getElementById('multiPromptOk').onclick = () => {
      const materialId = document.getElementById('mp_materialId').value;
      modal.hide();
      res(materialId ? { materialId } : null);
    };
    modal.show();
  });
}

function populatePrintersSelect(sel, selected){
  sel.innerHTML='';
  appData.printers.forEach(p=>{
    const opt=document.createElement('option');
    opt.value=p.id;
    opt.textContent=p.name;
    if(selected && selected.some(id => String(id) === String(p.id))) opt.selected=true;
    sel.appendChild(opt);
  });
}

function collectUnresolvedPrinters(){
  const idSet=new Set(appData.printers.map(p=>String(p.id)));
  const list=[];
  appData.calcHistory.forEach(h=>{
    if(Array.isArray(h.details)) h.details.forEach(d=>{
      if(!idSet.has(String(d.printerId))){
        list.push({history:h,ref:d.printerId,origName:d.printerName||d.printerId,model:d.modelName||''});
      }
    });
    if(h.calcData){
      for(const pid in h.calcData){
        if(!idSet.has(String(pid))){
          const det=(h.details||[]).find(dd=>String(dd.printerId)===String(pid));
          list.push({history:h,ref:pid,origName:pid,model:det?det.modelName||'':''});
        }
      }
    }
  });
  return list;
}

function showPrinterMapModal(list){
  if(!list || list.length===0) return;
  const tbody=document.querySelector('#printerMapTable tbody');
  tbody.innerHTML='';
  list.forEach((rec,i)=>{
    const h=rec.history;
    const tr=document.createElement('tr');
    tr.dataset.index=i;
    tr.innerHTML=`<td><input type="checkbox" class="form-check-input"></td>`+
                 `<td>${new Date(h.timestamp||0).toLocaleString()}</td>`+
                 `<td>${h.id||''}</td>`+
                 `<td>${h.calcName||''}</td>`+
                 `<td>${h.clientName||''}</td>`+
                 `<td>${h.orderStatus||''}</td>`+
                 `<td>${safeFixed(h.total||0)}</td>`+
                 `<td>${rec.model||''}</td>`+
                 `<td>${rec.origName}</td>`+
                 '<td></td>';
    const sel=document.createElement('select');
    populatePrintersSelect(sel);
    tr.lastChild.appendChild(sel);
    tbody.appendChild(tr);
  });
  const bulkSel=document.getElementById('bulkPrinterSelect');
  populatePrintersSelect(bulkSel);
  document.getElementById('applyBulkMap').onclick=()=>{
    const rows=tbody.querySelectorAll('tr');
    rows.forEach(row=>{
      if(row.querySelector('input[type=checkbox]').checked){
        const sel=row.querySelector('select');
        sel.value=bulkSel.value;
      }
    });
  };
  const modal=new bootstrap.Modal(document.getElementById('printerMapModal'));
  document.getElementById('printerMapSave').onclick=()=>{
    const rows=tbody.querySelectorAll('tr');
    rows.forEach(row=>{
      const idx=parseInt(row.dataset.index,10);
      const sel=row.querySelector('select');
      const entry=list[idx];
      const target=appData.printers.find(p=>String(p.id)===String(sel.value));
      if(target){
        const hist=entry.history;
        if(Array.isArray(hist.details)) hist.details.forEach(d=>{
          if(String(d.printerId)===String(entry.ref) || d.printerName===entry.origName){
            d.printerId=target.id; d.printerName=target.name;
          }
        });
        if(hist.calcData && hist.calcData[entry.ref]){
          hist.calcData[target.id]=hist.calcData[entry.ref];
          delete hist.calcData[entry.ref];
        }
      }
    });
    modal.hide();
    renderHistoryTable();
    renderPrintersTable();
    saveToLocalStorage();
  };
  modal.show();
}

function printerNameById(id){
  const p=appData.printers.find(pr=>String(pr.id)===String(id));
  return p? p.name : id;
}

function profileNameById(pid){
  const pf=appData.materialProfiles.find(p=>String(p.id)===String(pid));
  if(!pf) return pid;
  const cfg=pf.config||{};
  return String(cfg.filament_settings_id||cfg.name||pid);
}

function textColorForBg(hex){
  if(!hex) return '#000';
  hex=hex.replace('#','');
  if(hex.length===3){ hex=hex.split('').map(c=>c+c).join(''); }
  const r=parseInt(hex.substr(0,2),16);
  const g=parseInt(hex.substr(2,2),16);
  const b=parseInt(hex.substr(4,2),16);
  const yiq=(r*299+g*587+b*114)/1000;
  return yiq>128?'#000':'#fff';
}

const STORAGE_KEY = "ThreeDPrintCalc_Extended_v5";
let appData = {
  printers: [
    {
      id: 1,
      name: "FF5M",
      cost: 35000,
      hoursToRecoup: 500,
      power: 350,
      maintCostHour: 5,
      profileIds: []
    }
  ],
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã: –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è: balance (–æ—Å—Ç–∞—Ç–æ–∫), declaredWeight, manufacturer, productionDate
  materials: [
    // –ü—Ä–∏–º–µ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    // { id: 1001, name: "PLA", costPerKg: 150, balance: 10, declaredWeight: 1, waste_percent: 5, manufacturer: "XYZ", productionDate: "01.01.2025", printers: [] }
  ],
  materialProfiles: [],
  printerProfiles: [],
  additionalGlobal: [],
  calcSettings: {
    operatorRate: 200,
    workHoursDay: 8,
    startDate: "",
    costKwh: 6,
    shipping: 300,
    taxPercent: 6,
    parallelPrinting: "no",
    markupPercent: 0,
    discountPercent: 0,
    downtimeCost: 0,
    preparationRate: 0,
    preparationTime: 0,
    includeOperatorForRejects: false,
    customServices: []
  },
  labelSettings: {
  companyName: "–ö–æ–º–ø–∞–Ω–∏—è",
  chatLink: "https://t.me/dur",
  bankDetails: "",
  costPerLabel: 0,
  printLabels: false
},
  clients: [],
  calcHistory: []
};

function loadFromLocalStorage(){
  try{
    const s = localStorage.getItem(STORAGE_KEY);
    if(s){
      const p = JSON.parse(s);
      if(p) appData = migrateOldData(p);
      // ensure arrays exist
      if(!Array.isArray(appData.printers)) appData.printers = [];
      if(!Array.isArray(appData.materials)) appData.materials = [];
      if(!Array.isArray(appData.materialProfiles)) appData.materialProfiles = [];
      if(!Array.isArray(appData.additionalGlobal)) appData.additionalGlobal = [];
      if(!Array.isArray(appData.clients)) appData.clients = [];
      if(!Array.isArray(appData.calcHistory)) appData.calcHistory = [];
      appData.materials.forEach(m=>{if(!m.printers) m.printers=[];});
      appData.additionalGlobal.forEach(a=>{if(!a.printers) a.printers=[];});
      if(!appData.labelSettings) appData.labelSettings = {};
      if('paymentInfo' in appData.labelSettings && !('bankDetails' in appData.labelSettings)){
        appData.labelSettings.bankDetails = appData.labelSettings.paymentInfo;
        delete appData.labelSettings.paymentInfo;
      }
      if(!('bankDetails' in appData.labelSettings)) appData.labelSettings.bankDetails = '';
      if(!appData.calcSettings) appData.calcSettings = {};
      if(!Array.isArray(appData.calcSettings.customServices)) appData.calcSettings.customServices = [];
    }
  } catch(e){}
}
function saveToLocalStorage(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
}
function initAll(){
  loadFromLocalStorage();
  
  // Validate and auto-normalize IDs if validation fails
  const validationResult = validateUniqueIds(appData);
  if (!validationResult.success) {
    console.log("ID validation failed, auto-normalizing:", validationResult.errors);
    normalizeIds(appData);
    saveToLocalStorage();
  }
  
  renderPrintersTable();
  renderGlobalMaterialsTable();
  renderGlobalAdditionalTable();
  renderClientsTable();
  renderCalcPrinters();
  renderCustomServicesTable();
  renderHistoryTable();
  updateHistoryStats();
  renderSummary();
  const periodSelect = document.getElementById("summaryPeriod");
  periodSelect.addEventListener("change", onSummaryPeriodChange);
  document.getElementById("summaryApplyBtn").addEventListener("click", renderSummary);
  onSummaryPeriodChange();
  document.getElementById("calcOperatorRate").value = appData.calcSettings.operatorRate || "";
  document.getElementById("calcOperatorReject").checked = appData.calcSettings.includeOperatorForRejects || false;
  document.getElementById("calcDowntimeCost").value = appData.calcSettings.downtimeCost || "";
  document.getElementById("calcPreparationRate").value = appData.calcSettings.preparationRate || "";
  document.getElementById("calcPreparationTime").value = appData.calcSettings.preparationTime ? formatTimeForDisplay(appData.calcSettings.preparationTime) : "";
  document.getElementById("calcWorkHoursDay").value = appData.calcSettings.workHoursDay || "";
  document.getElementById("calcCostKwh").value = appData.calcSettings.costKwh || "";
  document.getElementById("calcTaxPercent").value = appData.calcSettings.taxPercent || "";
  document.getElementById("calcShipping").value = appData.calcSettings.shipping || "";
  document.getElementById("calcStartDate").value = appData.calcSettings.startDate || "";
  document.getElementById("calcParallelPrinting").value = appData.calcSettings.parallelPrinting || "no";
  document.getElementById("calcMarkupPercent").value = appData.calcSettings.markupPercent || 0;
  document.getElementById("calcDiscountPercent").value = appData.calcSettings.discountPercent || 0;
  document.getElementById("calcFinalCost").value = '';
  toggleFinalFields(document.getElementById("calcOrderStatus").value);
  document.getElementById("companyNameInput").value = appData.labelSettings.companyName || "";
  document.getElementById("chatLinkInput").value = appData.labelSettings.chatLink || "";
  document.getElementById("bankDetailsInput").value = appData.labelSettings.bankDetails || "";
  document.getElementById("labelCostInput").value = appData.labelSettings.costPerLabel || 0;
  document.getElementById("printLabelsCheckbox").checked = appData.labelSettings.printLabels || false;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏
function parseTimeInput(input) {
  if (input.includes(":")) {
    const [hours, minutes] = input.split(":").map(Number);
    return hours + (minutes / 60);
  }
  return parseFloat(input) || 0;
}

function formatTimeForDisplay(time) {
  if (time === undefined || time === null) return "";
  const hours = Math.floor(time);
  const minutes = Math.round((time - hours) * 60);
  return `${hours}:${minutes.toString().padStart(2, '0')}`;
}

function safeFixed(val, digits = 2) {
  const num = Number(val);
  return isNaN(num) ? '0.00' : num.toFixed(digits);
}

function handleTimeInput(event) {
  const input = event.target.value;
  // –ü–æ–∑–≤–æ–ª—è–µ–º –≤–≤–æ–¥–∏—Ç—å –∫–∞–∫ –ß:–ú, —Ç–∞–∫ –∏ –¥–µ—Å—è—Ç–∏—á–Ω–æ–µ —á–∏—Å–ª–æ
  if (input.includes(":")) {
    const [hours, minutes] = input.split(":").map(Number);
    if (!isNaN(hours) && !isNaN(minutes)) {
      return hours + (minutes / 60);
    }
  }
  return parseFloat(input) || 0;
}

function parseTimeFromLink(str){
  if(!str) return 0;
  let m = str.match(/(\d+)h\s*(\d+)m/);
  if(m) return parseInt(m[1],10) + parseInt(m[2],10)/60;
  m = str.match(/(\d+)h/);
  if(m) return parseInt(m[1],10);
  m = str.match(/(\d+)m/);
  if(m) return parseInt(m[1],10)/60;
  return parseTimeInput(str);
}

async function parseGcodeText(text) {
  const lines = text.split(/\r?\n/);
  let code = '', timeStr = '', weight = '', printer = 'Unknown', matProfile = '', thumb = '';
  let plateNameFound = false;
  let plateName = '';
  let afterExecStart = false, afterExecEnd = false, inConfig = false, inThumb = false;
  let thumbnailFound = false; // Flag to track if we already found a thumbnail
  let linesAfterExecStart = 0;
  
  for (let raw of lines) {
    const line = raw.trim();
    
    // Parse model code
    if (line.startsWith('; MODEL_CODE:')) {
      code = line.split(':')[1].trim();
      continue;
    }

    // Track EXECUTABLE_BLOCK_START to count lines for plate_name
    if (line === '; EXECUTABLE_BLOCK_START') {
      afterExecStart = true;
      continue;
    }
    
    // Handle executable block end
    if (line === '; EXECUTABLE_BLOCK_END') {
      afterExecEnd = true;
      continue;
    }

    // Count lines after EXECUTABLE_BLOCK_START for plate_name search
    if (afterExecStart && !plateNameFound && linesAfterExecStart < 50) {
      linesAfterExecStart++;
      
      // Search for plate_name
      if (line.includes('plate_name=')) {
        const match = line.match(/plate_name=\s*([^;]+)/);
        if (match && match[1]) {
          plateName = match[1].trim();
          plateNameFound = true;
        }
      }
    }
    
    // Handle thumbnail blocks - only process the first one
    if (line.startsWith('; THUMBNAIL_BLOCK_START')) {
      continue;
    }
    
    if (line.startsWith('; thumbnail begin')) {
      if (!thumbnailFound) {
        inThumb = true;
        thumbnailFound = true;
      }
      continue;
    }
    
    if (line.startsWith('; thumbnail end')) {
      if (inThumb) {
        inThumb = false;
      }
      continue;
    }
    
    // Process thumbnail data only for the first thumbnail
    if (inThumb && thumbnailFound) {
      if (line.startsWith(';')) {
        thumb += line.slice(1).trim();
      } else {
        thumb += line.trim();
      }
      continue;
    }
    
    // Handle THUMBNAIL_BLOCK_END
    if (line.startsWith('; THUMBNAIL_BLOCK_END')) {
      continue;
    }
    
    // Handle config blocks - they can appear anywhere in the file
    if (line === '; CONFIG_BLOCK_START') {
      inConfig = true;
      continue;
    }
    
    if (line === '; CONFIG_BLOCK_END') {
      inConfig = false;
      continue;
    }
    
    // Parse config parameters - now independent of EXECUTABLE_BLOCK position
    if (inConfig) {
      if (line.includes('printer_settings_id') && line.includes('=')) {
        printer = line.split('=')[1].replace(/"/g, '').trim();
      } else if (line.startsWith('; filament_settings_id') && line.includes('=')) {
        matProfile = line.split('=')[1].replace(/"/g, '').trim();
      }
    }
    
    // Parse printing time and weight - now independent of EXECUTABLE_BLOCK position
    if (line.startsWith('; estimated printing time') && line.includes('=')) {
      timeStr = line.split('=')[1].trim();
    }
    else if (line.startsWith('; total filament used [g]') && line.includes('=')) {
      weight = line.split('=')[1].trim();
    }
  }
  
  // Generate code if not found
  if (!code) code = getNextId('gcodeModels');
  
  // Use plate_name if found
  const modelName = plateNameFound ? plateName : code;
  
  return { code, modelName, timeStr, weight, printer, matProfile, thumb };
}

// Update the addModelFromGcode function to use the new modelName
async function addModelFromGcode(parsed){
  const pr = await resolvePrinterForLink(parsed.printer);
  if(!pr){
    alert('–ù–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏–Ω—Ç–µ—Ä '+parsed.printer);
    return;
  }
  const mid = await resolveMaterialIdByProfile(parsed.matProfile);
  addModelRow(pr.id, {
    id: parsed.code,
    name: parsed.modelName || parsed.code, // Use the parsed modelName or fall back to code
    thumbnail: parsed.thumb,
    status: 'new',
    hours: parseTimeFromLink(parsed.timeStr),
    weight: parseFloat(parsed.weight) || 0,
    materialId: mid
  });
}

// Update file drop handler to use the model name from parsed data
function setupGcodeDrop() {
  window.addEventListener('dragover', e => {
    e.preventDefault(); // Allow drop
  });

  window.addEventListener('drop', async e => {
    e.preventDefault();

    // Find the target printer table
    let printerId = null;
    let target = e.target;

    // Traverse up the DOM tree to find a table with ID like "calcModelsTable_123"
    while (target && !printerId) {
      if (target.id && target.id.startsWith('calcModelsTable_')) {
        printerId = target.id.split('_')[1];
        break;
      }
      target = target.parentElement;
    }

    if (!printerId) {
      alert('Please drop the G-code file over a printer\'s table.');
      return;
    }

    // Process G-code files
    const files = Array.from(e.dataTransfer.files).filter(f => 
      f.name.toLowerCase().endsWith('.gcode')
    );

    for (const f of files) {
      const txt = await f.text();
      const parsed = await parseGcodeText(txt);
      let mid = await resolveMaterialIdByProfile(parsed.matProfile);

      // Get the model name from parsed data or use file name without extension
      const modelName = parsed.modelName || f.name.replace(/\.gcode$/i, '');

      // If no material found, prompt user to select from all available materials
      if (!mid) {
        const materialOptions = appData.materials.map(m => ({
          value: String(m.id),
          label: `${m.name} (ID: ${m.id}${m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : ''})`
        }));
        
        if (materialOptions.length > 0) {
          const result = await showMaterialSelectionForGcode(f.name, parsed.thumb, materialOptions);
          
          if (result && result.materialId) {
            mid = result.materialId;
          } else {
            // User cancelled, skip this file
            continue;
          }
        } else {
          alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ú–∞—Ç–µ—Ä–∏–∞–ª—ã".');
          continue;
        }
      }
      
      addModelRow(printerId, {
        id: parsed.code,
        name: modelName, 
        thumbnail: parsed.thumb,
        status: 'new',
        hours: parseTimeFromLink(parsed.timeStr),
        weight: parseFloat(parsed.weight) || 0,
        materialId: mid
      });
    }
  });
}

document.addEventListener("DOMContentLoaded", () => { instrumentFunctions(); initAll(); });

/* –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
function selectAll(source, type) {
  const checkboxes = document.querySelectorAll("."+type+"_chk");
  checkboxes.forEach(cb => cb.checked = source.checked);
}

function filterTable(tableId, query){
  const tb = document.getElementById(tableId);
  if(!tb) return;
  const val = query.toLowerCase();
  tb.querySelectorAll('tbody tr').forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(val)?'' :'none';
  });
}

function sortTable(tableId, col){
  const tb=document.getElementById(tableId);
  if(!tb) return;
  const rows=Array.from(tb.querySelectorAll('tbody tr'));
  const asc=tb.dataset.sortCol==col && tb.dataset.sortDir==='asc'?false:true;
  rows.sort((a,b)=>{
    const va=a.children[col].innerText;
    const vb=b.children[col].innerText;
    return asc?va.localeCompare(vb,'ru',{numeric:true}):vb.localeCompare(va,'ru',{numeric:true});
  });
  const tbody=tb.querySelector('tbody');
  rows.forEach(r=>tbody.appendChild(r));
  tb.dataset.sortCol=col;
  tb.dataset.sortDir=asc?'asc':'desc';
}
function massDelete(type) {
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã?")) return;
  switch(type) {
    case 'printers':
      const removed = [];
      appData.printers = appData.printers.filter(p => {
        const chk = document.getElementById("chk_printers_"+p.id);
        const del = chk && chk.checked;
        if(del) removed.push(String(p.id));
        return !del;
      });
      renderPrintersTable();
      renderCalcPrinters();
      renderSummary();
      if(removed.length){
        const unresolved = collectUnresolvedPrinters();
        if(unresolved.length) showPrinterMapModal(unresolved);
      }
      break;
    case 'globalMaterials':
      appData.materials = appData.materials.filter(m => {
        const chk = document.getElementById("chk_globalMaterials_"+m.id);
        return !(chk && chk.checked);
      });
      renderGlobalMaterialsTable();
      renderSummary();
      break;
    case 'globalAdditional':
      appData.additionalGlobal = appData.additionalGlobal.filter(a => {
        const chk = document.getElementById("chk_globalAdditional_"+a.id);
        return !(chk && chk.checked);
      });
      renderGlobalAdditionalTable();
      renderSummary();
      break;
  }
  saveToLocalStorage();
}
async function massEdit(type) {
  switch(type) {
    case 'printers': {
        const vals = await showMultiPrompt('–ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤', [
          {id:'cost',label:'–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)',type:'number'},
          {id:'hours',label:'–ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏',type:'number'},
          {id:'power',label:'–ú–æ—â–Ω–æ—Å—Ç—å (–í—Ç)',type:'number'},
          {id:'maint',label:'–†–∞—Å—Ö–æ–¥ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (‚ÇΩ/—á)',type:'number'}
        ]);
        if(!vals) return;
        appData.printers.forEach(p=>{
          const chk=document.getElementById('chk_printers_'+p.id);
          if(chk&&chk.checked){
            if(vals.cost) p.cost=parseFloat(vals.cost)||p.cost;
            if(vals.hours) p.hoursToRecoup=parseFloat(vals.hours)||p.hoursToRecoup;
            if(vals.power) p.power=parseFloat(vals.power)||p.power;
            if(vals.maint) p.maintCostHour=parseFloat(vals.maint)||p.maintCostHour;
          }
        });
        renderPrintersTable();
        renderCalcPrinters();
        renderSummary();
      }
      break;
    case 'globalMaterials':
      {
        const vals = await showMultiPrompt('–ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤',[
          {id: 'materialType', label: '–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞'},
          {id:'cost',label:'–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥',type:'number'},
          {id:'balance',label:'–û—Å—Ç–∞—Ç–æ–∫ (–∫–≥)',type:'number'},
          {id:'declared',label:'–ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –≤–µ—Å (–∫–≥)',type:'number'},
          {id:'manuf',label:'–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å'},
          {id:'prodDate',label:'–î–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞'},
          {id:'printers',label:'–ü—Ä–∏–Ω—Ç–µ—Ä—ã',type:'multiselect',options:appData.printers.map(p=>({value:String(p.id),label:p.name}))},
          {
            id: 'profiles',
            label: '–ü—Ä–æ—Ñ–∏–ª–∏',
            type: 'multiselect',
            options: (appData.materialProfiles || []).map(p => ({
              value: String(p.id),
              label: profileNameById(p.id) || `–ü—Ä–æ—Ñ–∏–ª—å ${p.id}`
            }))
          }
        ]);
        if(!vals) return;
        appData.materials.forEach(m=>{
          const chk=document.getElementById('chk_globalMaterials_'+m.id);
          if(chk&&chk.checked){
            if(vals.materialType) m.materialType=vals.materialType;
            if(vals.cost) m.costPerKg=parseFloat(vals.cost)||m.costPerKg;
            if(vals.balance) m.balance=parseFloat(vals.balance)||m.balance;
            if(vals.declared) m.declaredWeight=parseFloat(vals.declared)||m.declaredWeight;
            if(vals.manuf) m.manufacturer=vals.manuf;
            if(vals.prodDate) m.productionDate=vals.prodDate;
            if(vals.printers && vals.printers.length) m.printers=vals.printers;
            if(vals.profiles && vals.profiles.length) {
              if(!Array.isArray(m.profileIds)) m.profileIds = [];
              m.profileIds = vals.profiles;
            }
          }
        });
        renderGlobalMaterialsTable();
        renderSummary();
      }
      break;
    case 'globalAdditional':
      {
        const vals = await showMultiPrompt('–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã',[
          {id:'cost',label:'–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)',type:'number'},
          {id:'hours',label:'–ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏',type:'number'},
          {id:'use',label:'–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç',type:'checkbox',value:true},
          {id:'printers',label:'–ü—Ä–∏–Ω—Ç–µ—Ä—ã',type:'multiselect',options:appData.printers.map(p=>({value:String(p.id),label:p.name}))}
        ]);
        if(!vals) return;
        appData.additionalGlobal.forEach(a=>{
          const chk=document.getElementById('chk_globalAdditional_'+a.id);
          if(chk&&chk.checked){
            if(vals.cost) a.cost=parseFloat(vals.cost)||a.cost;
            if(vals.hours) a.hoursToRecoup=parseFloat(vals.hours)||a.hoursToRecoup;
            a.useInCalc=vals.use;
            if(vals.printers && vals.printers.length) a.printers=vals.printers;
          }
        });
        renderGlobalAdditionalTable();
        renderSummary();
      }
      break;
  }
  saveToLocalStorage();
}
function copyElement(type, id) {
  switch(type) {
    case 'printers':
      {
        const orig = appData.printers.find(p => String(p.id) === String(id));
        if(orig){
          const copy = JSON.parse(JSON.stringify(orig));
          copy.id = getNextId('printers');
          copy.name += " (–∫–æ–ø–∏—è)";
          appData.printers.push(copy);
          renderPrintersTable();
          renderCalcPrinters();
          renderSummary();
        }
      }
      break;
    case 'globalMaterials':
      {
        const orig = appData.materials.find(m => String(m.id) === String(id));
        if(orig){
          const copy = JSON.parse(JSON.stringify(orig));
          copy.id = getNextId('materials');
          copy.name += " (–∫–æ–ø–∏—è)";
          appData.materials.push(copy);
          renderGlobalMaterialsTable();
          renderSummary();
        }
      }
      break;
    case 'globalAdditional':
      {
        const orig = appData.additionalGlobal.find(a => String(a.id) === String(id));
        if(orig){
          const copy = JSON.parse(JSON.stringify(orig));
          copy.id = getNextId('additionalGlobal');
          copy.description += " (–∫–æ–ø–∏—è)";
          appData.additionalGlobal.push(copy);
          renderGlobalAdditionalTable();
          renderSummary();
        }
      }
      break;
  }
  saveToLocalStorage();
}
/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ */
function renderPrintersTable(){
  const tbody = document.querySelector("#printersTable tbody");
  tbody.innerHTML = "";
  appData.printers.forEach(printer => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_printers_${printer.id}" class="printers_chk"><\/td>
      <td>${printer.name}<\/td>
      <td>${printer.cost}<\/td>
      <td>${printer.hoursToRecoup}<\/td>
      <td>${printer.power}<\/td>
      <td>${printer.maintCostHour}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditPrinter('${printer.id}')">–†–µ–¥.<\/button>
          <button class="btn btn-success" onclick="openPrinterOrca('${printer.id}')">Orca<\/button>
          <button class="btn btn-warning" onclick="copyElement('printers', '${printer.id}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeletePrinter('${printer.id}')">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tbody.appendChild(tr);
  });
}
function onAddPrinter(){
const newId = getNextId('printers');
  const p = {
    id: newId,
    name: "–ù–æ–≤—ã–π –ø—Ä–∏–Ω—Ç–µ—Ä",
    cost: 0,
    hoursToRecoup: 1000,
    power: 0,
    maintCostHour: 0,
    profileIds: []
  };
  appData.printers.push(p);
  saveToLocalStorage();
  renderPrintersTable();
  renderCalcPrinters();
  renderSummary();
}
let currentPrinterEditId = null;
function onEditPrinter(id){
  const p = appData.printers.find(x => String(x.id) === String(id));
  if(!p) return;
  currentPrinterEditId = id;
  document.getElementById('printerNameInput').value = p.name;
  document.getElementById('printerCostInput').value = p.cost;
  document.getElementById('printerHoursInput').value = p.hoursToRecoup;
  document.getElementById('printerPowerInput').value = p.power;
  document.getElementById('printerMaintInput').value = p.maintCostHour;
  new bootstrap.Modal(document.getElementById('printerModal')).show();
}
function savePrinterFromModal(){
  const p = appData.printers.find(x => String(x.id) === String(currentPrinterEditId));
  if(!p) return;
  p.name = document.getElementById('printerNameInput').value;
  p.cost = parseFloat(document.getElementById('printerCostInput').value) || 0;
  p.hoursToRecoup = parseFloat(document.getElementById('printerHoursInput').value) || 1000;
  p.power = parseFloat(document.getElementById('printerPowerInput').value) || 0;
  p.maintCostHour = parseFloat(document.getElementById('printerMaintInput').value) || 0;
  saveToLocalStorage();
  renderPrintersTable();
  renderCalcPrinters();
  renderSummary();
  bootstrap.Modal.getInstance(document.getElementById('printerModal')).hide();
}
function onDeletePrinter(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä?")) return;
  appData.printers = appData.printers.filter(x => String(x.id) !== String(id));
  saveToLocalStorage();
  renderPrintersTable();
  renderCalcPrinters();
  renderSummary();
  const unresolved = collectUnresolvedPrinters();
  if(unresolved.length) showPrinterMapModal(unresolved);
}
/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ */
function renderGlobalMaterialsTable(){
  const tb = document.querySelector("#materialsTable tbody");
  tb.innerHTML = "";
  appData.materials.forEach(m => {
    const tr = document.createElement("tr");
    let col = m.color || '#ffffff';
	  console.log(m.color);
	if (!col.startsWith('#')) {
 	 col = '#' + col;
	}

	      const spoolmanText = m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : '';
    

    const tc = textColorForBg(col);
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_globalMaterials_${m.id}" class="globalMaterials_chk"><\/td>
      <td style="background-color:${col};color:${tc};">${m.name} (ID: ${m.id}${spoolmanText})<\/td>
      <td>${m.materialType}<\/td>
      <td>${m.costPerKg}<\/td>
      <td>${m.balance * 1000}<\/td>
      <td>${m.declaredWeight || "-"}<\/td>
      <td>${m.coolingTime || 0}<\/td>
      <td>${m.manufacturer || "-"}<\/td>
      <td>${m.productionDate || "-"}<\/td>
      <td>${(m.printers && m.printers.length) ? m.printers.map(printerNameById).join(', ') : '–í—Å–µ'}<\/td>
      <td>${(m.profileIds && m.profileIds.length) ? m.profileIds.map(profileNameById).join(', ') : '-'}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditGlobalMaterial('${m.id}')">–†–µ–¥.<\/button>
          <button class="btn btn-success" onclick="openMaterialProfileLink('${m.id}')">–ü—Ä–æ—Ñ–∏–ª—å<\/button>
          <button class="btn btn-info" onclick="downloadMaterialLabelHtml('${m.id}')">–≠—Ç–∏–∫–µ—Ç–∫–∞<\/button>
          <button class="btn btn-warning" onclick="copyElement('globalMaterials', '${m.id}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeleteGlobalMaterial('${m.id}')">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tb.appendChild(tr);
  });
}
let currentMaterialEditId = null;
function onAddGlobalMaterial(){
  currentMaterialEditId = null;
  document.getElementById('matNameInput').value = '';
  document.getElementById('matMaterialTypeInput').value = '';
  document.getElementById('matCostInput').value = '0';
  document.getElementById('matBalanceInput').value = '0';
  document.getElementById('matDeclaredInput').value = '0';
  document.getElementById('matColorInput').value = '#ffffff';
  document.getElementById('matManufInput').value = '';
  document.getElementById('matProdDateInput').value = '';
  populatePrintersSelect(document.getElementById('matPrintersSelect'), []);
  new bootstrap.Modal(document.getElementById('materialModal')).show();
}
function onEditGlobalMaterial(id){
  const m = appData.materials.find(x => String(x.id) === String(id));
  if(!m) return;
  currentMaterialEditId = id;
  document.getElementById('matNameInput').value = m.name;
  document.getElementById('matMaterialTypeInput').value = m.materialType;
  document.getElementById('matCostInput').value = m.costPerKg;
  document.getElementById('matBalanceInput').value = m.balance;
  document.getElementById('matDeclaredInput').value = m.declaredWeight;
  document.getElementById('matCoolingTimeInput').value = m.coolingTime || 0;
  document.getElementById('matColorInput').value = m.color || '#ffffff';
  document.getElementById('matManufInput').value = m.manufacturer || '';
  document.getElementById('matProdDateInput').value = m.productionDate || '';
  populatePrintersSelect(document.getElementById('matPrintersSelect'), m.printers||[]);
  new bootstrap.Modal(document.getElementById('materialModal')).show();
}
function saveMaterialFromModal(){
  const isNew = currentMaterialEditId === null;
  let m = isNew ? {id: getNextId('materials'), profileIds: [], printers: []} : appData.materials.find(x=>x.id==currentMaterialEditId);
  if(!m) return;
  m.name = document.getElementById('matNameInput').value;
  m.materialType = document.getElementById('matMaterialTypeInput').value || '';
  m.costPerKg = parseFloat(document.getElementById('matCostInput').value) || 0;
  m.balance = parseFloat(document.getElementById('matBalanceInput').value) || 0;
  m.declaredWeight = parseFloat(document.getElementById('matDeclaredInput').value) || 0;
  m.coolingTime = parseFloat(document.getElementById('matCoolingTimeInput').value) || 0;
  m.color = document.getElementById('matColorInput').value;
  m.manufacturer = document.getElementById('matManufInput').value;
  m.productionDate = document.getElementById('matProdDateInput').value;
  m.printers = Array.from(document.getElementById('matPrintersSelect').selectedOptions).map(o=>o.value);
  if(isNew) appData.materials.push(m);
  saveToLocalStorage();
  renderGlobalMaterialsTable();
  renderSummary();
  bootstrap.Modal.getInstance(document.getElementById('materialModal')).hide();
}
function onDeleteGlobalMaterial(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª?")) return;
  appData.materials = appData.materials.filter(x => String(x.id) !== String(id));
  saveToLocalStorage();
  renderGlobalMaterialsTable();
  renderSummary();
}

/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥–æ–≤ */
function renderGlobalAdditionalTable(){
  const tb = document.querySelector("#additionalGlobalTable tbody");
  tb.innerHTML = "";
  appData.additionalGlobal.forEach(a => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" id="chk_globalAdditional_${a.id}" class="globalAdditional_chk"><\/td>
      <td>${a.description}<\/td>
      <td>${a.cost}<\/td>
      <td>${a.hoursToRecoup || 1000}<\/td>
      <td>${a.useInCalc ? "–î–∞" : "–ù–µ—Ç"}<\/td>
      <td>${(a.printers && a.printers.length)? a.printers.map(printerNameById).join(', '): '–í—Å–µ'}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditGlobalAdditional('${a.id}')">–†–µ–¥.<\/button>
          <button class="btn btn-warning" onclick="copyElement('globalAdditional', '${a.id}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å<\/button>
          <button class="btn btn-danger" onclick="onDeleteGlobalAdditional('${a.id}')">–£–¥–ª.<\/button>
        <\/div>
      <\/td>
    `;
    tb.appendChild(tr);
  });
}
function onAddGlobalAdditional(){
const nid = getNextId('additionalGlobal');
  appData.additionalGlobal.push({
    id: nid,
    description: "–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è",
    cost: 0,
    hoursToRecoup: 1000,
    useInCalc: true,
    printers: []
  });
  saveToLocalStorage();
  renderGlobalAdditionalTable();
  renderSummary();
}
async function onEditGlobalAdditional(id){
  const x = appData.additionalGlobal.find(a => String(a.id) === String(id));
  if(!x) return;
  const vals = await showMultiPrompt('–†–∞—Å—Ö–æ–¥',[
    {id:'desc',label:'–û–ø–∏—Å–∞–Ω–∏–µ',value:x.description},
    {id:'cost',label:'–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)',type:'number',value:x.cost},
    {id:'hours',label:'–ß–∞—Å—ã –æ–∫—É–ø.',type:'number',value:x.hoursToRecoup||1000},
    {id:'use',label:'–í–∫–ª—é—á–∞—Ç—å –≤ —Ä–∞—Å—á—ë—Ç',type:'checkbox',value:x.useInCalc},
    {id:'printers',label:'–ü—Ä–∏–Ω—Ç–µ—Ä—ã',type:'multiselect',options:appData.printers.map(p=>({value:String(p.id),label:p.name})),value:x.printers||[]}
  ]);
  if(!vals) return;
  x.description = vals.desc;
  x.cost = parseFloat(vals.cost)||0;
  x.hoursToRecoup = parseFloat(vals.hours)||1000;
  x.useInCalc = vals.use;
  x.printers = vals.printers || [];
  saveToLocalStorage();
  renderGlobalAdditionalTable();
  renderSummary();
}
function onDeleteGlobalAdditional(id){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é?")) return;
  appData.additionalGlobal = appData.additionalGlobal.filter(a => String(a.id) !== String(id));
  saveToLocalStorage();
  renderGlobalAdditionalTable();
  renderSummary();
}

/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —É—Å–ª—É–≥ */
function renderCustomServicesTable(){
  const tb = document.querySelector('#customServicesTable tbody');
  if(!tb) return;
  tb.innerHTML='';
  (appData.calcSettings.customServices||[]).forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="checkbox" ${s.use?'checked':''} onchange="updateService('${s.id}','use',this.checked)"></td>
      <td><input type="text" class="form-control form-control-sm" value="${s.name}" onchange="updateService('${s.id}','name',this.value)"></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${s.cost}" onchange="updateService('${s.id}','cost',this.value)"></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${s.qty}" onchange="updateService('${s.id}','qty',this.value)"></td>
      <td>
        <select class="form-select form-select-sm" onchange="updateService('${s.id}','mode',this.value)">
          <option value="per_unit" ${s.mode==='per_unit'?'selected':''}>–∑–∞ –µ–¥–∏–Ω–∏—Ü—É</option>
          <option value="per_service" ${s.mode==='per_service'?'selected':''}>–∑–∞ —É—Å–ª—É–≥—É</option>
          <option value="per_hour" ${s.mode==='per_hour'?'selected':''}>–∑–∞ —á–∞—Å</option>
        </select>
      </td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteCustomService('${s.id}')">–£–¥–∞–ª–∏—Ç—å</button></td>
    `;
    tb.appendChild(tr);
  });
}

function addCustomService(){
  if(!Array.isArray(appData.calcSettings.customServices)) appData.calcSettings.customServices=[];
  appData.calcSettings.customServices.push({id:getNextId('services'),name:'',cost:0,qty:1,mode:'per_service',use:true});
  saveToLocalStorage();
  renderCustomServicesTable();
}

function deleteCustomService(id){
  appData.calcSettings.customServices=(appData.calcSettings.customServices||[]).filter(s=>String(s.id)!==String(id));
  saveToLocalStorage();
  renderCustomServicesTable();
}

function updateService(id,field,value){
  const s=(appData.calcSettings.customServices||[]).find(x=>String(x.id)===String(id));
  if(!s) return;
  if(field==='cost'||field==='qty') s[field]=parseFloat(value)||0;
  else if(field==='use') s[field]=value;
  else s[field]=value;
  saveToLocalStorage();
}

/* –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ */
function renderClientsTable(){
  const tb = document.querySelector("#clientsTable tbody");
  if(!tb) return;
  tb.innerHTML="";
  appData.clients.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${c.name}</td>
      <td>${c.phone||""}</td>
      <td>${c.links||""}</td>
      <td><div class="btn-group-sm">
        <button class="btn btn-secondary" onclick="onEditClient('${c.id}')">–†–µ–¥.</button>
        <button class="btn btn-danger" onclick="onDeleteClient('${c.id}')">–£–¥–ª.</button>
      </div></td>`;
    tb.appendChild(tr);
  });
  renderClientOptions();
}

function renderClientOptions(){
  const dl=document.getElementById('clientsList');
  if(!dl) return;
  dl.innerHTML='';
  appData.clients.forEach(c=>{
    const opt=document.createElement('option');
    opt.value=c.name;
    dl.appendChild(opt);
  });
}

async function onAddClient(){
  const vals=await showMultiPrompt('–ö–ª–∏–µ–Ω—Ç',[
    {id:'name',label:'–ò–º—è'},
    {id:'phone',label:'–¢–µ–ª–µ—Ñ–æ–Ω'},
    {id:'links',label:'–°—Å—ã–ª–∫–∏'}
  ]);
  if(!vals) return;
  appData.clients.push({id:getNextId('clients'),name:vals.name,phone:vals.phone,links:vals.links});
  saveToLocalStorage();
  renderClientsTable();
}

async function onEditClient(id){
  const c=appData.clients.find(x=>x.id==id);
  if(!c) return;
  const vals=await showMultiPrompt('–ö–ª–∏–µ–Ω—Ç',[{id:'name',label:'–ò–º—è',value:c.name},{id:'phone',label:'–¢–µ–ª–µ—Ñ–æ–Ω',value:c.phone||''},{id:'links',label:'–°—Å—ã–ª–∫–∏',value:c.links||''}]);
  if(!vals) return;
  c.name=vals.name;
  c.phone=vals.phone;
  c.links=vals.links;
  saveToLocalStorage();
  renderClientsTable();
}

function onDeleteClient(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?')) return;
  appData.clients=appData.clients.filter(c=>c.id!=id);
  saveToLocalStorage();
  renderClientsTable();
}

function quickAddClient(){
  const name=document.getElementById('calcClientName').value.trim();
  if(!name) return;
  if(!appData.clients.find(c=>c.name===name)){
    appData.clients.push({id:getNextId('clients'),name});
    saveToLocalStorage();
    renderClientsTable();
  }
  renderClientOptions();
}

/* –§—É–Ω–∫—Ü–∏–∏ –∫–∞–ª—å–∫—É–ª—è—Ü–∏–∏ */
function renderCalcPrinters(){
  const c = document.getElementById("calcPrintersContainer");
  c.innerHTML = "";
  appData.printers.forEach(pr => {
    const block = document.createElement("div");

    block.className = "border p-3 mb-3";
    block.innerHTML = `
      <h5>–ü—Ä–∏–Ω—Ç–µ—Ä: ${pr.name} (ID: ${pr.id})<\/h5>
      <div class="small-text mb-2">
        –ú–æ—â–Ω–æ—Å—Ç—å: ${pr.power}–í—Ç, –û–±—Å–ª: ${pr.maintCostHour}‚ÇΩ/—á, –ß–∞—Å—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏: ${pr.hoursToRecoup}.
      <\/div>
      <table class="table table-bordered table-sm mb-2" id="calcModelsTable_${pr.id}">
        <thead>
          <tr>
            <th>–ò–º—è –º–æ–¥–µ–ª–∏<\/th>
            <th>–ò–∫–æ–Ω–∫–∞<\/th>
            <th>–°—Ç–∞—Ç—É—Å<\/th>
            <th>–ß–∞—Å—ã –ø–µ—á–∞—Ç–∏<\/th>
            <th>–í–µ—Å (–≥)<\/th>
            <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
            <th>–î–µ–π—Å—Ç–≤–∏—è<\/th>
          <\/tr>
        <\/thead>
        <tbody><\/tbody>
      <\/table>
      <button class="btn btn-sm btn-primary" onclick="addModelRow(${pr.id}, {})">–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å<\/button>
    `;
    c.appendChild(block);
  });
}
function addModelRow(printerId, modelData) {
  ensureIconsLoaded();
  const table = document.getElementById(`calcModelsTable_${printerId}`);
  if(!table) return;
  const tbody = table.querySelector("tbody");
  const idx = tbody.rows.length + 1;
  const statuses = [
    {val:"new", text:"–ù–æ–≤–∞—è"},
    {val:"inprogress", text:"–ü–µ—á–∞—Ç—å"},
    {val:"done", text:"–ì–æ—Ç–æ–≤–∞"},
    {val:"reject", text:"–ë—Ä–∞–∫"},
    {val:"canceled", text:"–û—Ç–º–µ–Ω–µ–Ω–∞"}
  ];
  const optsStatus = statuses.map(s =>
    `<option value="${s.val}" ${(modelData.status === s.val) ? "selected" : ""}>${s.text}<\/option>`
  ).join("");
  const mats = getAllMaterialsForPrinter(printerId, true);
const optsMat = mats.map(m => {
  const spoolmanText = m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : '';
  return `<option value="${m.id}" ${(modelData.materialId == m.id) ? "selected" : ""}>
    ${m.name} (ID: ${m.id}${spoolmanText})
  </option>`;
}).join("");
  const uniqueId = getNextId('clients');
  const nameId = `modelName_${printerId}_${uniqueId}`;
  const statusId = `modelStatus_${printerId}_${uniqueId}`;
  const hoursId = `modelHours_${printerId}_${uniqueId}`;
  const weightId = `modelWeight_${printerId}_${uniqueId}`;
  const materialId = `modelMaterial_${printerId}_${uniqueId}`;
  const tr = document.createElement('tr');
  const code = modelData.id || uniqueId;
  tr.dataset.modelId = code;
  tr.dataset.thumbnail = modelData.thumbnail || '';
  tr.innerHTML = `
    <td><input type="text" class="form-control form-control-sm" id="${nameId}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${modelData.name || ''}" /> <small>(${code})<\/small><\/td>
    <td>
      ${modelData.thumbnail ? `<img id="thumb_${code}" src="data:image/png;base64,${modelData.thumbnail}" style="height:40px;width:40px;object-fit:contain;border:1px solid #ccc;cursor:pointer" onclick="document.getElementById('thumbFile_${code}').click()"/>` : `<i id="thumb_${code}" class="bi bi-image" style="font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('thumbFile_${code}').click()"></i>`}
      <input type="file" id="thumbFile_${code}" accept="image/png" class="d-none" onchange="onModelThumbnailChange(event, '${code}')">
    <\/td>
    <td>
      <select class="form-select form-select-sm" id="${statusId}">
        ${optsStatus}
      <\/select>
    <\/td>
    <td><input type="text" class="form-control form-control-sm time-input" 
             id="${hoursId}" placeholder="—á:–º" 
             value="${modelData.hours ? formatTimeForDisplay(modelData.hours) : ''}" 
             onblur="this.value = formatTimeForDisplay(handleTimeInput({target: {value: this.value}}))" /><\/td>
    <td><input type="number" step="0.1" class="form-control form-control-sm" id="${weightId}" placeholder="–≥" value="${modelData.weight || ''}" /><\/td>
    <td>
      <select class="form-select form-select-sm" id="${materialId}">
        <option value="">-–ú–∞—Ç–µ—Ä–∏–∞–ª-<\/option>
        ${optsMat}
      <\/select>
    <\/td>
    <td><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">–£–¥–ª.<\/button><\/td>
  `;
  tbody.appendChild(tr);
}
function getAllMaterialsForPrinter(printerId, includeAll=false){
  return appData.materials.filter(m => {
    if(!includeAll && m.balance <= 0) return false;
    if(!Array.isArray(m.printers) || m.printers.length===0) return true;
    return m.printers.some(pid => String(pid) === String(printerId));
  });
}

let lastCalcFullData = null;

let incomingLinkData = null;

let lastSummaryCardHtml = '';

let myNalogChallengeToken = '';
const MY_NALOG_API = 'https://lknpd.nalog.ru';




function onCalculateAll() {
  const calcName = document.getElementById("calcName").value.trim();
  let clientName = document.getElementById("calcClientName").value.trim();
  let clientId = "";
  if(clientName){
    let c = appData.clients.find(x=>x.name===clientName);
    if(!c){
      c = {id: getNextId('clients'), name: clientName};
      appData.clients.push(c);
      renderClientsTable();
      saveToLocalStorage();
    }
    clientId = c.id;
  }
  const orderStatus = document.getElementById("calcOrderStatus").value;
  const opRate = parseFloat(document.getElementById("calcOperatorRate").value) || 0;
  const whDay = parseFloat(document.getElementById("calcWorkHoursDay").value) || 8;
  const cKwh = parseFloat(document.getElementById("calcCostKwh").value) || 0;
  const tPercent = parseFloat(document.getElementById("calcTaxPercent").value) || 0;
  const ship = parseFloat(document.getElementById("calcShipping").value) || 0;
  const sDate = document.getElementById("calcStartDate").value;
  const parallelMode = document.getElementById("calcParallelPrinting").value;
  const markupPercent = parseFloat(document.getElementById("calcMarkupPercent").value) || 0;
  const discountPercent = parseFloat(document.getElementById("calcDiscountPercent").value) || 0;
  const manualFinalCost = parseFloat(document.getElementById("calcFinalCost").value) || 0;
  const downtimeRate = parseFloat(document.getElementById("calcDowntimeCost").value) || 0;
  const prepRate = parseFloat(document.getElementById("calcPreparationRate").value) || 0;
  const prepTime = handleTimeInput({target:{value: document.getElementById("calcPreparationTime").value}});
  const includeOpRejects = document.getElementById("calcOperatorReject").checked;
  const servicesArr = appData.calcSettings.customServices || [];
  let servicesTotal = 0;
  const servicesUsed = [];
  servicesArr.forEach(s=>{
    if(!s.use) return;
    const cost=parseFloat(s.cost)||0;
    const qty=parseFloat(s.qty)||0;
    let total=0;
    if(s.mode==='per_service') total=cost; else total=cost*qty;
    servicesTotal+=total;
    servicesUsed.push({id:s.id,name:s.name,cost:cost,qty:qty,mode:s.mode,use:true,total});
  });
    let orderId = document.getElementById("calcOrderId").value.trim();
    let existingIndex = appData.calcHistory.findIndex(entry => entry.calcName === calcName);
    if (!orderId) {
      orderId = getNextOrderId();
    } else {
      const conflict = appData.calcHistory.some((entry, idx) => String(entry.id) === String(orderId) && idx !== existingIndex);
      if (conflict) {
        orderId = getNextOrderId();
      } else {
        const numericId = parseInt(orderId, 10);
        if (!isNaN(numericId)) {
          if (!appData.counters) appData.counters = {};
          if (!appData.counters.orders || appData.counters.orders < numericId) {
            appData.counters.orders = numericId;
          }
        }
      }
    }
    document.getElementById("calcOrderId").value = orderId;

    // –∏—Ç–æ–≥–æ–≤—ã–π HTML –¥–ª—è –≤—ã–≤–æ–¥–∞
    var htmlRes = '';
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–∞—Å—á—ë—Ç–∞
  appData.calcSettings.operatorRate = opRate;
  appData.calcSettings.includeOperatorForRejects = includeOpRejects;
  appData.calcSettings.workHoursDay = whDay;
  appData.calcSettings.costKwh = cKwh;
  appData.calcSettings.taxPercent = tPercent;
  appData.calcSettings.shipping = ship;
  appData.calcSettings.startDate = sDate;
  appData.calcSettings.parallelPrinting = parallelMode;
  appData.calcSettings.markupPercent = markupPercent;
  appData.calcSettings.discountPercent = discountPercent;
  appData.calcSettings.downtimeCost = downtimeRate;
  appData.calcSettings.preparationRate = prepRate;
  appData.calcSettings.preparationTime = prepTime;
  
  saveToLocalStorage();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  let calcData = {};
  appData.printers.forEach(pr => {
    const table = document.getElementById(`calcModelsTable_${pr.id}`);
    if (!table) return;
    const rows = table.querySelectorAll("tbody tr");
    let modelsData = [];
    rows.forEach(row => {
      const inputs = Array.from(row.querySelectorAll('input')).filter(inp => inp.type !== 'file');
      const inpName = inputs[0];
      const selStatus = row.querySelectorAll("select")[0];
      const inpH = inputs[1];
      const inpW = inputs[2];
      const selM = row.querySelectorAll("select")[1];
      const h = handleTimeInput({target: {value: inpH.value}}); // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥
      const w = parseFloat(inpW.value) || 0;
      modelsData.push({
        id: row.dataset.modelId || getNextId('models'),
        thumbnail: row.dataset.thumbnail || '',
        name: inpName.value.trim() || "–ú–æ–¥–µ–ª—å",
        status: selStatus.value || "new",
        hours: h,
        weight: w,
        materialId: selM.value
      });
    });
    calcData[pr.id] = modelsData;
  });
  
  // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º —Å—É–º–º–∞—Ä–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–ª–∞—Å—Ç–∏–∫–∞ (–≤ –≥—Ä–∞–º–º–∞—Ö) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø–æ –≤—Å–µ–º—É —Ä–∞—Å—á—ë—Ç—É
  let materialConsumption = {};
  
  // –†–∞—Å—á—ë—Ç –∑–∞—Ç—Ä–∞—Ç –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º
  let detailsByPrinter = [];
  let sumWithoutTax = 0;
  let finalTimeAllPrinters = 0;
  let finalOpTimeAllPrinters = 0;
  let maxPrinterTime = 0;
  let maxOpPrinterTime = 0;
  let totalCoolingMinutes = 0;
  let totalRejectHours = 0;
  let totalRejectWeight = 0;
  
  appData.printers.forEach(pr => {
    const table = document.getElementById(`calcModelsTable_${pr.id}`);
    if (!table) return;
    
    let prTime = 0;
    let prOpTime = 0;
    let prCostNoTax = 0;
    let lines = [];
    const rows = table.querySelectorAll("tbody tr");
    rows.forEach(row => {
      const inputs = Array.from(row.querySelectorAll('input')).filter(inp => inp.type !== 'file');
      const inpName = inputs[0];
      const selStatus = row.querySelectorAll("select")[0];
      const inpH = inputs[1];
      const inpW = inputs[2];
      const selM = row.querySelectorAll("select")[1];
      const h = handleTimeInput({target: {value: inpH.value}}); // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–≤–æ–¥
      const w = parseFloat(inpW.value) || 0;
      const mid = selM.value;
      if (!mid || h <= 0 || w <= 0) return;

      const status = selStatus.value || "new";
      prTime += h;
      if (status !== "reject" || includeOpRejects) prOpTime += h;
      if (status === "reject") {
        totalRejectHours += h;
      }
      
      const mat = getAllMaterialsForPrinter(pr.id).find(x => String(x.id) === String(mid));
      if (!mat) return;

      totalCoolingMinutes += parseFloat(mat.coolingTime) || 0;
      
      const costPH = (pr.hoursToRecoup > 0) ? pr.cost / pr.hoursToRecoup : 0;
      const costPrinterPart = h * costPH;
      const realW = w;
      if (status === "reject") {
        totalRejectWeight += realW;
      }
      // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
      materialConsumption[mid] = (materialConsumption[mid] || 0) + realW;
      
      const costPerGram = mat.costPerKg / 1000;
      const costMaterial = realW * costPerGram;
      
      const costElectric = (pr.power / 1000) * h * cKwh;
      const costMaint = pr.maintCostHour * h;
      const subTotalModel = costPrinterPart + costMaterial + costElectric + costMaint;
      
      prCostNoTax += subTotalModel;
      
      lines.push({
        id: row.dataset.modelId || getNextId('models'),
        thumbnail: row.dataset.thumbnail || '',
        name: inpName.value.trim() || "–ú–æ–¥–µ–ª—å",
        status: selStatus.value || "new",
        hours: h,
        weight: w,
        matName: `${mat.name} (ID: ${mat.id})`,
        realWeight: realW,
        costPrinterPart: costPrinterPart,
        costMaterial: costMaterial,
        costElectric: costElectric,
        costMaintenance: costMaint,
        subTotalModel: subTotalModel,
        materialData: {
          id: mat.id,
          declaredWeight: mat.declaredWeight,
          manufacturer: mat.manufacturer,
          productionDate: mat.productionDate
        }
      });
    });
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏–Ω—Ç–µ—Ä–∞ —É–¥–∞–ª–µ–Ω—ã, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    let printerAdditionalDetails = [];
    
    if (parallelMode === "no") {
      finalTimeAllPrinters += prTime;
      finalOpTimeAllPrinters += prOpTime;
    } else {
      if (prTime > maxPrinterTime) maxPrinterTime = prTime;
      if (prOpTime > maxOpPrinterTime) maxOpPrinterTime = prOpTime;
    }
    
    sumWithoutTax += prCostNoTax;
    detailsByPrinter.push({
      printerId: pr.id,
      printerName: pr.name,
      linesDetail: lines,
      printerTime: prTime,
      subTotal: prCostNoTax,
      additionalDetails: printerAdditionalDetails
    });
  });
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –æ—Å—Ç–∞—Ç–∫–∞
  let warnings = [];
  for (let mid in materialConsumption) {
    const required = materialConsumption[mid];
    const mat = findMaterialById(mid);
    if (mat && required > (mat.balance * 1000)) {
      warnings.push(`–ú–∞—Ç–µ—Ä–∏–∞–ª–∞ "${mat.name}" –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: —Ç—Ä–µ–±—É–µ—Ç—Å—è ${safeFixed(required)} –≥, –æ—Å—Ç–∞—Ç–æ–∫ ${safeFixed(mat.balance * 1000)} –≥.`);
    }
  }
  
  const totalCoolingHours = totalCoolingMinutes / 60;
  let baseOperatorTime = (parallelMode === "yes") ? maxOpPrinterTime : finalOpTimeAllPrinters;
  let finalTimeOperator = baseOperatorTime + prepTime + totalCoolingHours;
  const operatorWorkCost = baseOperatorTime * opRate;
  const downtimeCost = totalCoolingMinutes * downtimeRate;
  const preparationCost = prepTime * prepRate;
  const totalOperatorCost = operatorWorkCost + downtimeCost + preparationCost;
  
  let sumGlobalAdd = 0;
  let globalAdditionalDetails = [];
  appData.additionalGlobal.forEach(g => {
    if (!g.useInCalc) return;
    let hours = 0;
    detailsByPrinter.forEach(d=>{
      if(!g.printers || g.printers.length===0 || g.printers.some(pid => String(pid) === String(d.printerId))){
        hours += d.printerTime;
      }
    });
    const costPerHour = (g.hoursToRecoup > 0) ? g.cost / g.hoursToRecoup : 0;
    const cVal = costPerHour * hours;
    sumGlobalAdd += cVal;
    globalAdditionalDetails.push({
      id: g.id,
      description: g.description,
      baseCost: g.cost,
      hoursToRecoup: g.hoursToRecoup,
      costDistributed: cVal
    });
  });
  
    let totalLabelsCost = 0;
  if(appData.labelSettings.printLabels) {
    const labelCost = appData.labelSettings.costPerLabel || 0;
    const totalModels = Object.values(calcData).reduce((acc, models) => acc + models.length, 0);
    totalLabelsCost = totalModels * labelCost;
  }

  
  let subtotal = sumWithoutTax + sumGlobalAdd + ship + totalOperatorCost + totalLabelsCost;
  if (markupPercent > 0) {
    subtotal *= (1 + markupPercent / 100);
  }
  subtotal += servicesTotal;
  const totalBeforeDiscount = subtotal / (1 - tPercent / 100);
  const taxAmount = totalBeforeDiscount - subtotal;
  let finalSum = totalBeforeDiscount;
  if(discountPercent > 0){
    finalSum = finalSum * (1 - discountPercent / 100);
  }
  if(manualFinalCost > 0){
    finalSum = manualFinalCost;
  }

  let finDateStr = calcFinishDate(sDate, Math.ceil(finalTimeOperator / (whDay || 8)));

    htmlRes = `<strong>–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:<\/strong><br/>`;
  htmlRes += `–ö–æ–¥: ${orderId}<br/>`;
  htmlRes += `–ù–∞–∑–≤–∞–Ω–∏–µ: ${calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}, –ö–ª–∏–µ–Ω—Ç: ${clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}, –°—Ç–∞—Ç—É—Å: ${orderStatus}<br/>`;
  htmlRes += `–£—á–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –ø–µ—á–∞—Ç–∏: ${(parallelMode === "yes") ? "–î–∞" : "–ù–µ—Ç"}<br/>`;
  htmlRes += `–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${formatTimeForDisplay(finalTimeOperator)} —á.<br/>`;
  htmlRes += `–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${safeFixed(totalOperatorCost)} ‚ÇΩ<br/>`;
  htmlRes += `–ü—Ä–æ—Å—Ç–æ–π: ${formatTimeForDisplay(totalCoolingHours)} —á. (${safeFixed(downtimeCost)} ‚ÇΩ)<br/>`;
  htmlRes += `–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: ${formatTimeForDisplay(prepTime)} —á. (${safeFixed(preparationCost)} ‚ÇΩ)<br/>`;
  htmlRes += `–ù–∞—Ü–µ–Ω–∫–∞: ${markupPercent}%.<br/>`;
  htmlRes += `–£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞: ${safeFixed(ship)} ‚ÇΩ<br/>`;
  htmlRes += `–°—Ç–æ–∏–º–æ—Å—Ç—å —ç—Ç–∏–∫–µ—Ç–æ–∫: ${safeFixed(totalLabelsCost)} ‚ÇΩ<br/>`;
  if(servicesUsed.length>0){
    htmlRes += `–£—Å–ª—É–≥–∏:<br/>`;
    servicesUsed.forEach(s=>{htmlRes += `${s.name}: ${safeFixed(s.total)} ‚ÇΩ<br/>`;});
    htmlRes += `–ò—Ç–æ–≥–æ —É—Å–ª—É–≥–∏: ${safeFixed(servicesTotal)} ‚ÇΩ<br/>`;
  }
  htmlRes += `–ü–æ–¥–∏—Ç–æ–≥: ${safeFixed(subtotal)} ‚ÇΩ<br/>`;
  htmlRes += `–û–±—â–∏–π –Ω–∞–ª–æ–≥ (${tPercent}%): ${safeFixed(taxAmount)} ‚ÇΩ<br/>`;
 
 
  // –í—ã–≤–æ–¥ —Ü–µ–Ω—ã –∑–∞ 1 –≥—Ä–∞–º–º
  const totalWeight = detailsByPrinter.reduce((acc, printer) => 
    acc + printer.linesDetail.reduce((sum, line) => sum + line.realWeight, 0), 0);
  const pricePerGram = totalWeight > 0 ? finalSum / totalWeight : 0;	
	
	
if(discountPercent > 0){
    htmlRes += `–ò—Ç–æ–≥–æ –±–µ–∑ —Å–∫–∏–¥–∫–∏: <del>${safeFixed(totalBeforeDiscount)} ‚ÇΩ<\/del><br/>`;
    htmlRes += `<strong>–ò—Ç–æ–≥–æ —Å–æ —Å–∫–∏–¥–∫–æ–π (${discountPercent}%): ${safeFixed(finalSum)} ‚ÇΩ<\/strong><br/>`;
  } else {
    htmlRes += `<strong>–ò—Ç–æ–≥–æ (—Å —É—á–µ—Ç–æ–º –Ω–∞—Ü–µ–Ω–∫–∏, –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –Ω–∞–ª–æ–≥–∞): ${safeFixed(finalSum)} ‚ÇΩ<\/strong><br/>`;
  }

  htmlRes += `–¶–µ–Ω–∞ –∑–∞ 1 –≥—Ä–∞–º–º: ${safeFixed(pricePerGram)}<br/>`;

  if (finDateStr) {
    htmlRes += `–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä–Ω–æ): ${finDateStr}<br/>`;
  }

  // —Ñ–æ—Ä–º–∏—Ä—É–µ–º HTML –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Ç–æ–≥–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
  let summaryModels = '';
  detailsByPrinter.forEach(pr => {
    pr.linesDetail.forEach(ln => {
      summaryModels += `<div class="model-card">` +
        (ln.thumbnail ? `<img src="data:image/png;base64,${ln.thumbnail}" alt="icon">` : '') +
        `<h3>${ln.name}<\/h3>` +
        `<p><strong>–¢—Ä–µ–±—É–µ—Ç—Å—è:<\/strong> ${formatTimeForDisplay(ln.hours)}<\/p>` +
        `<p><strong>–í–µ—Å:<\/strong> ${safeFixed(ln.realWeight)} –≥<\/p>` +
        `<p><strong>–ú–∞—Ç–µ—Ä–∏–∞–ª:<\/strong> ${ln.matName}<\/p>` +
      `</div>`;
    });
  });
  const qrText = buildPaymentQrString();
  generateQRCodeCanvas(qrText, 120, function(qrCanvas){
    const qrDataUrl = qrCanvas ? qrCanvas.toDataURL('image/png') : '';
    lastSummaryCardHtml = buildSummaryCardHtml({
      company: appData.labelSettings.companyName,
      orderId,
      orderName: calcName || '(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)',
      client: clientName || '(–ù–µ —É–∫–∞–∑–∞–Ω)',
      status: orderStatus,
      totalTime: formatTimeForDisplay(finalTimeOperator) + ' —á',
      totalWeight: safeFixed(totalWeight),
      totalCost: safeFixed(finalSum),
      priceOld: discountPercent > 0 ? safeFixed(totalBeforeDiscount) : '',
      discountPercent,
      pricePerGram: safeFixed(pricePerGram),
      finDate: finDateStr,
      modelsHtml: summaryModels,
      qr: qrDataUrl,
      paymentInfo: appData.labelSettings.bankDetails,
      services: servicesUsed,
      servicesTotal: safeFixed(servicesTotal)
    });
  });
  if (warnings.length > 0) {
    htmlRes += `<div class="alert alert-warning mt-2">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:<br/>` + warnings.join("<br/>") + `<\/div>`;
  }
  htmlRes += `<hr/><strong>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º:<\/strong><br/>`;
  detailsByPrinter.forEach(d => {

if ((d.linesDetail.length === 0 || !d.linesDetail) && d.printerTime <= 0) {
  return;
}


	  
    htmlRes += `<div style="margin-top:1em;">`;
    htmlRes += `<strong>${d.printerName} (ID: ${d.printerId})<\/strong><br/>`;
    htmlRes += `–í—Ä–µ–º—è: ${safeFixed(d.printerTime)} —á; –°—É–º–º–∞: ${safeFixed(d.subTotal)} ‚ÇΩ<br/>`;
    if (d.linesDetail.length > 0) {
      htmlRes += `<div class="table-responsive"><table class="table table-sm table-bordered mt-1" style="max-width:800px;">`;
      htmlRes += `<thead><tr>
        <th>–ú–æ–¥–µ–ª—å<\/th>
        <th>–ò–∫–æ–Ω–∫–∞<\/th>
        <th>–°—Ç–∞—Ç—É—Å<\/th>
        <th>–ß–∞—Å—ã<\/th>
        <th>–í–µ—Å (–≥)<\/th>
        <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
        <th>–í–µ—Å<\/th>
        <th>–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ (‚ÇΩ)<\/th>
        <th>–°—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (‚ÇΩ)<\/th>
        <th>–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ (‚ÇΩ)<\/th>
        <th>–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (‚ÇΩ)<\/th>
        <th>–ò—Ç–æ–≥–æ (‚ÇΩ)<\/th>
        <th>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/th>
      <\/tr><\/thead><tbody>`;
      d.linesDetail.forEach(ln => {
        htmlRes += `<tr>
          <td>${ln.name} (${ln.id || ''})<\/td>
          <td>${ln.thumbnail ? `<img src="data:image/png;base64,${ln.thumbnail}" style="height:40px;"/>` : ''}<\/td>
          <td>${ln.status}<\/td>
          <td>${formatTimeForDisplay(ln.hours)}<\/td>
          <td>${safeFixed(ln.weight)}<\/td>
          <td>${ln.matName}<\/td>
          <td>${safeFixed(ln.realWeight)}<\/td>
          <td>${safeFixed(ln.costPrinterPart)}<\/td>
          <td>${safeFixed(ln.costMaterial)}<\/td>
          <td>${safeFixed(ln.costElectric)}<\/td>
          <td>${safeFixed(ln.costMaintenance)}<\/td>
          <td>${safeFixed(ln.subTotalModel)}<\/td>
          <td>
            <button class="btn btn-sm btn-outline-secondary"
              onclick="downloadThermoLabelHtml('${ln.name}', '${d.printerName}', '${ln.matName}', '${safeFixed(ln.hours)}', '${safeFixed(ln.weight)}', '${ln.thumbnail || ''}')">
              –≠—Ç–∏–∫–µ—Ç–∫–∞
            <\/button>
          <\/td>
        <\/tr>`;
      });
      htmlRes += `<\/tbody><\/table></div>`;
    }

    // –í—ã–≤–æ–¥ —Ç–∞–±–ª–∏—Ü—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ —Å –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º–æ–π
    if (d.additionalDetails && d.additionalDetails.length > 0) {
      let htmlResadditionalDetails = `<hr/><strong>–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞:<\/strong>`;
      htmlResadditionalDetails += `<table class="table table-sm table-bordered mt-1" style="max-width:600px;">`;
      htmlResadditionalDetails += `<thead><tr><th>–û–ø–∏—Å–∞–Ω–∏–µ<\/th><th>–ò—Å—Ö. —Å—Ç–æ–∏–º.<\/th><th>–ß–∞—Å—ã –æ–∫—É–ø.<\/th><th>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (‚ÇΩ)<\/th><\/tr><\/thead><tbody>`;
      let sumPrinterAdditional = 0;
      d.additionalDetails.forEach(ad => {
        sumPrinterAdditional += ad.costDistributed;
        htmlResadditionalDetails += `<tr>
          <td>${ad.description}<\/td>
          <td>${safeFixed(ad.baseCost)}<\/td>
          <td>${ad.hoursToRecoup}<\/td>
          <td>${safeFixed(ad.costDistributed)}<\/td>
        <\/tr>`;
      });
      htmlResadditionalDetails += `<\/tbody><\/table>`;
      htmlResadditionalDetails += `–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞: ${safeFixed(sumPrinterAdditional)} ‚ÇΩ<br/>`;
	    if(sumPrinterAdditional > 0)
	    htmlRes += htmlResadditionalDetails;
    }
	  
    htmlRes += `<\/div>`;
  });
  
  if (globalAdditionalDetails.length > 0) {
    htmlRes += `<hr/><strong>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã (–≤–∫–ª—é—á—ë–Ω–Ω—ã–µ):<\/strong>`;
    htmlRes += `<table class="table table-sm table-bordered mt-1" style="max-width:600px;">`;
    htmlRes += `<thead><tr><th>–û–ø–∏—Å–∞–Ω–∏–µ<\/th><th>–ò—Å—Ö. —Å—Ç–æ–∏–º.<\/th><th>–ß–∞—Å—ã –æ–∫—É–ø.<\/th><th>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (‚ÇΩ)<\/th><\/tr><\/thead><tbody>`;
    globalAdditionalDetails.forEach(gd => {
      htmlRes += `<tr>
        <td>${gd.description}<\/td>
        <td>${safeFixed(gd.baseCost)}<\/td>
        <td>${gd.hoursToRecoup}<\/td>
        <td>${safeFixed(gd.costDistributed)}<\/td>
      <\/tr>`;
    });
    htmlRes += `<\/tbody><\/table>`;
    htmlRes += `–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: ${safeFixed(sumGlobalAdd)} ‚ÇΩ<br/>`;
  }

  if(lastCalcFullData && Array.isArray(lastCalcFullData.nalogReceipts) && lastCalcFullData.nalogReceipts.length){
    const links = lastCalcFullData.nalogReceipts.map((r,i)=>{
      const inn = localStorage.getItem('my_nalog_inn') || '';
      const url = `https://lknpd.nalog.ru/api/v1/receipt/${inn}/${r.uuid}/print`;
      const cls = (r.canceled || i < lastCalcFullData.nalogReceipts.length-1) ? 'class="text-danger"' : '';
      return `<a href="${url}" target="_blank" ${cls}>–ß–µ–∫${lastCalcFullData.nalogReceipts.length>1?' '+(i+1):''}<\/a>`;
    }).join('<br/>');
    htmlRes += '<br/>'+links;
  }
  
  document.getElementById("calcResult").style.display = "block";
  document.getElementById("calcResult").innerHTML = htmlRes;
  const qrTarget=document.getElementById("orderSummaryQr");
  if(qrTarget){
    new QRCode(qrTarget,{text:appData.labelSettings.chatLink,width:120,height:120,correctLevel:QRCode.CorrectLevel.H});
  }
  const allBtn=document.getElementById("downloadAllLabelsBtn");
  if(allBtn) allBtn.style.display='inline-block';
  const summaryBtn=document.getElementById("downloadSummaryCardBtn");
  if(summaryBtn) summaryBtn.style.display='inline-block';
  const myNalogBtn=document.getElementById("sendMyNalogBtn");
  if(myNalogBtn) myNalogBtn.style.display='inline-block';
  const myNalogBillBtn=document.getElementById("sendMyNalogBillBtn");
  if(myNalogBillBtn) myNalogBillBtn.style.display='inline-block';
  const myNalogCancelBtn=document.getElementById("cancelMyNalogBtn");
  if(myNalogCancelBtn) myNalogCancelBtn.style.display='none';

  lastCalcFullData = {
    id: orderId,
    calcName,
    clientName,
    clientId,
    orderStatus,
    total: finalSum,
    totalHours: finalTimeOperator,
    taxPercent: tPercent,
    shipping: ship,
    services: servicesUsed,
    servicesTotal,
    detailsByPrinter,
    costKwh: cKwh,
    operatorRate: opRate,
    totalOperatorCost: totalOperatorCost,
    operatorWorkCost: operatorWorkCost,
    downtimeCost: downtimeCost,
    downtimeMinutes: totalCoolingMinutes,
    preparationCost: preparationCost,
    preparationTime: prepTime,
    calcData,
    globalAdditional: {
      sumGlobalAdd,
      taxAmount,
      details: globalAdditionalDetails
    },
    parallelMode,
    markupPercent,
    discountPercent,
    priceBeforeDiscount: totalBeforeDiscount,
    realTotal: manualFinalCost > 0 ? manualFinalCost : null,
    nalogReceipts: []
  };
    if(existingIndex !== -1){
    const ex = appData.calcHistory[existingIndex];
    if(Array.isArray(ex.nalogReceipts)){
      lastCalcFullData.nalogReceipts = ex.nalogReceipts.map(r=>({uuid:r.uuid, canceled: !!r.canceled}));
    }else if(ex.nalogReceiptUuid){
      lastCalcFullData.nalogReceipts = [{uuid: ex.nalogReceiptUuid, canceled: !!ex.nalogCanceled}];
    }
    if(Array.isArray(lastCalcFullData.nalogReceipts) && lastCalcFullData.nalogReceipts.length){
      const last = lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1];
      lastCalcFullData.receiptUuid = last.uuid;
    }
    const cancelBtn=document.getElementById('cancelMyNalogBtn');
    const showCancel = Array.isArray(lastCalcFullData.nalogReceipts) && lastCalcFullData.nalogReceipts.length && !lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1].canceled;
    if(cancelBtn) cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
  }

  lastCalcFullData.totalLabelsCost = totalLabelsCost;
  lastCalcFullData.servicesTotal = servicesTotal;

  const dtStr = new Date().toLocaleString("ru-RU");
  const newEntry = {
    id: orderId,
    timestamp: Date.now(),
    dateStr: dtStr,
    calcName,
    clientName,
    clientId,
    orderStatus,
    total: finalSum,
    totalHours: finalTimeOperator,
    taxPercent: tPercent,
    shipping: ship,
    services: servicesUsed,
    servicesTotal,
    operatorRate: opRate,
    costKwh: cKwh,
    totalOperatorCost: totalOperatorCost,
    operatorWorkCost: operatorWorkCost,
    downtimeCost: downtimeCost,
    downtimeMinutes: totalCoolingMinutes,
    preparationCost: preparationCost,
    preparationTime: prepTime,
    details: detailsByPrinter,
    calcData,
    globalAdditional: {
      sumGlobalAdd,
      taxAmount,
      details: globalAdditionalDetails
    },
    parallelMode,
    markupPercent,
    discountPercent,
    priceBeforeDiscount: totalBeforeDiscount,
    realTotal: manualFinalCost > 0 ? manualFinalCost : null,
    nalogReceipts: Array.isArray(lastCalcFullData.nalogReceipts)
      ? lastCalcFullData.nalogReceipts.map(r=>({uuid:r.uuid, canceled:!!r.canceled}))
      : [],
    nalogReceiptUuid: lastCalcFullData.receiptUuid || null,
    rejectHours: totalRejectHours,
    rejectWeight: totalRejectWeight
  };
  if (existingIndex !== -1) {
    appData.calcHistory[existingIndex] = newEntry;
  } else {
    appData.calcHistory.push(newEntry);
  }
  saveToLocalStorage();
  renderHistoryTable();
  updateHistoryStats();
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è
function openModelingCalculatorModal() {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  document.getElementById('modelingRateInput').value = appData.calcSettings.modelingRate || 500;
  document.getElementById('modelingTimeInput').value = '';
  document.getElementById('modelingComplexityInput').value = '1';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç
  updateModelingPreview();
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é
  const inputs = ['modelingRateInput', 'modelingTimeInput', 'modelingComplexityInput'];
  inputs.forEach(id => {
    document.getElementById(id).addEventListener('input', updateModelingPreview);
  });
  
  const modal = new bootstrap.Modal(document.getElementById('modelingCalculatorModal'));
  modal.show();
}

function updateModelingPreview() {
  const rate = parseFloat(document.getElementById('modelingRateInput').value) || 0;
  const time = parseFloat(document.getElementById('modelingTimeInput').value) || 0;
  const complexity = parseFloat(document.getElementById('modelingComplexityInput').value) || 1;
  
  const total = rate * time * complexity;
  document.getElementById('modelingPreview').textContent = `${total.toFixed(2)} ‚ÇΩ`;
}

function calculateModelingCost() {
  const rate = parseFloat(document.getElementById('modelingRateInput').value) || 0;
  const time = parseFloat(document.getElementById('modelingTimeInput').value) || 0;
  const complexity = parseFloat(document.getElementById('modelingComplexityInput').value) || 1;
  
  if (time <= 0) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ–ª—å—à–µ 0.');
    return;
  }
  
  const totalCost = rate * time * complexity;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  appData.calcSettings.modelingRate = rate;
  saveToLocalStorage();

  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  const modal = bootstrap.Modal.getInstance(document.getElementById('modelingCalculatorModal'));
  modal.hide();
}

function findMaterialById(mid) {
  let mat = appData.materials.find(m => String(m.id) === String(mid));
  if (mat) return mat;
  for (let p of appData.printers) {
    if (Array.isArray(p.materials)) {
      mat = p.materials.find(m => String(m.id) === String(mid));
      if (mat) return mat;
    }
  }
  return null;
}

function findMaterialByName(name) {
  if (!name) return null;
  let mat = appData.materials.find(m => m.name === name);
  if (mat) return mat;
  for (let p of appData.printers) {
    if(Array.isArray(p.materials)){
      mat = p.materials.find(m => m.name === name);
      if (mat) return mat;
    }
  }
  return null;
}

function findMaterialsByProfile(profile){
  if(!profile) return [];
  const key=String(profile).toLowerCase();
  const ids = appData.materialProfiles
    .filter(p=>{
      const cfg=p.config||{};
      const nm=String(cfg.filament_settings_id||cfg.name||'').toLowerCase();
      return nm===key;
    })
    .map(p=>String(p.id));
  if(ids.length===0) return [];
  const list=[];
  const check=(m)=>Array.isArray(m.profileIds) && m.profileIds.some(id=>ids.includes(String(id)));
  appData.materials.forEach(m=>{ if(check(m)) list.push(m); });
  appData.printers.forEach(pr=>{ (pr.materials||[]).forEach(m=>{ if(check(m)) list.push(m); }); });
  return list;
}

async function resolveMaterialIdByProfile(profile){
  const mats=findMaterialsByProfile(profile);
  if(mats.length===1) return mats[0].id;
  if(mats.length>1){

const options = mats.map(m => ({
  value: String(m.id),
  label: `${m.name} (ID: ${m.id}${m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : ''})`
}));

    const res=await showMultiPrompt('–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è '+profile,[{id:'mid',label:'–ú–∞—Ç–µ—Ä–∏–∞–ª',type:'select',options}]);
    return res&&res.mid?res.mid:'';
  }
  return '';
}

function defaultOrcaConfig(){
  return {};
}

let currentMaterialForProfiles = null;
function populateProfileSelect(selected){
  const sel=document.getElementById('materialProfileLinkSelect');
  sel.innerHTML='';
  appData.materialProfiles.forEach(p=>{
    const cfg=p.config||{};
    const name=String(cfg.filament_settings_id||cfg.name||p.id);
    const opt=document.createElement('option');
    opt.value=p.id;
    opt.textContent=name;
    if(selected.includes(String(p.id))) opt.selected=true;
    sel.appendChild(opt);
  });
  if(sel.options.length===0){
    const opt=document.createElement('option');
    opt.textContent='–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π';
    opt.disabled=true;
    sel.appendChild(opt);
  }
}
function openMaterialProfileLink(mid){
  const mat=findMaterialById(mid);
  if(!mat) return;
  if(appData.materialProfiles.length===0){
    alert('–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π Orca. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ.');
    return;
  }
  currentMaterialForProfiles=String(mid);
  populateProfileSelect((mat.profileIds||[]).map(String));
  new bootstrap.Modal(document.getElementById('materialProfileLinkModal')).show();
}
function applyMaterialProfileLink(){
  if(currentMaterialForProfiles===null) return;
  const mat=findMaterialById(currentMaterialForProfiles);
  if(!mat) return;
  const sel=document.getElementById('materialProfileLinkSelect');
  mat.profileIds=Array.from(sel.selectedOptions).map(o=>o.value);
  saveToLocalStorage();
  bootstrap.Modal.getInstance(document.getElementById('materialProfileLinkModal')).hide();
}
function renderMaterialProfilesTable(){
  const tb=document.getElementById('materialProfilesTable');
  tb.innerHTML='';
  appData.materialProfiles.forEach(p=>{
    const cfg=p.config||{};
    const name=String(cfg.filament_settings_id||cfg.name||p.id);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${name}</td><td><button class="btn btn-sm btn-info" onclick="downloadProfileJson('${p.id}')">JSON</button> <button class="btn btn-sm btn-info ms-1" onclick="downloadProfileInfo('${p.id}')">INFO</button> <button class="btn btn-sm btn-danger ms-1" onclick="deleteMaterialProfileGlobal('${p.id}')">‚úñ</button></td>`;
    tb.appendChild(tr);
  });
}
function openMaterialProfilesManager(){
  renderMaterialProfilesTable();
  new bootstrap.Modal(document.getElementById('manageMaterialProfilesModal')).show();
}
function deleteMaterialProfileGlobal(pid){
  appData.materials.forEach(m=>{if(Array.isArray(m.profileIds)) m.profileIds=m.profileIds.filter(id=>String(id)!==String(pid));});
  appData.materialProfiles=appData.materialProfiles.filter(p=>String(p.id)!==String(pid));
  saveToLocalStorage();
  renderMaterialProfilesTable();
}

function renderPrinterProfilesTable(){
  const tb=document.getElementById('printerProfilesTable');
  tb.innerHTML='';
  appData.printerProfiles.forEach(p=>{
    const cfg=p.config||{};
    const pr=appData.printers.find(x=>String(x.id)===String(p.printerId));
    const prName=pr?pr.name:'?';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${cfg.printer_settings_id||cfg.name||p.id}</td><td>${prName}</td><td><button class="btn btn-sm btn-warning me-1" onclick="reassignPrinterProfile('${p.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button><button class="btn btn-sm btn-danger" onclick="deletePrinterProfileGlobal('${p.id}')">‚úñ</button></td>`;
    tb.appendChild(tr);
  });
}
function openPrinterProfilesManager(){
  renderPrinterProfilesTable();
  new bootstrap.Modal(document.getElementById('managePrinterProfilesModal')).show();
}
async function reassignPrinterProfile(pid){
  const pf=appData.printerProfiles.find(p=>String(p.id)===String(pid));
  if(!pf) return;
  const options=appData.printers.map(pr=>({value:String(pr.id),label:pr.name}));
  const res=await showMultiPrompt('–ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å',[{id:'prid',label:'–ü—Ä–∏–Ω—Ç–µ—Ä',type:'select',options,value:pf.printerId}]);
  if(!res || !res.prid) return;
  const newPr=appData.printers.find(pr=>String(pr.id)===String(res.prid));
  if(!newPr) return;
  const oldPr=appData.printers.find(pr=>String(pr.id)===String(pf.printerId));
  if(oldPr) oldPr.profileIds=oldPr.profileIds.filter(id=>String(id)!==String(pid));
  if(!Array.isArray(newPr.profileIds)) newPr.profileIds=[];
  if(!newPr.profileIds.includes(pid)) newPr.profileIds.push(pid);
  pf.printerId=newPr.id;
  saveToLocalStorage();
  renderPrinterProfilesTable();
}
function deletePrinterProfileGlobal(pid){
  appData.printers.forEach(pr=>{ if(Array.isArray(pr.profileIds)) pr.profileIds=pr.profileIds.filter(id=>String(id)!==String(pid)); });
  appData.printerProfiles=appData.printerProfiles.filter(p=>String(p.id)!==String(pid));
  saveToLocalStorage();
  renderPrinterProfilesTable();
}
function downloadProfileJson(pid){
  const prof=appData.materialProfiles.find(p=>String(p.id)===String(pid));
  if(!prof) return;
  const cfg=prof.config||{};
  downloadBlob(new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'}),(cfg.name||cfg.filament_settings_id||'filament')+'.json');
}
function downloadProfileInfo(pid){
  const prof=appData.materialProfiles.find(p=>String(p.id)===String(pid));
  if(!prof) return;
  const info=prof.info||'';
  const cfg=prof.config||{};
  downloadBlob(new Blob([info],{type:'text/plain'}),(cfg.name||cfg.filament_settings_id||'filament')+'.info');
}
function importProfileFile(file){
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{ const data=JSON.parse(reader.result); appData.materialProfiles.push({id:getNextId('materialProfiles'),config:data,info:''}); saveToLocalStorage(); renderMaterialProfilesTable(); }
    catch(e){ alert('–û—à–∏–±–∫–∞: '+e); }
  };
  reader.readAsText(file);
}

function calcFinishDate(sv, days){
  if(!sv) return "";
  try{
    const d = new Date(sv);
    d.setDate(d.getDate()+days);
    return d.toLocaleDateString("ru-RU");
  } catch(e){
    return "";
  }
}
function renderHistoryTable(){
  const tb = document.querySelector("#historyTable tbody");
  tb.innerHTML = "";
  appData.calcHistory.forEach(h => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${h.dateStr}<\/td>
      <td>${h.id || ''}<\/td>
      <td>${h.calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}<\/td>
      <td>${h.clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}<\/td>
      <td>
        <select class="form-select form-select-sm" onchange="onChangeCalcHistoryStatus(${h.timestamp}, this.value)">
          <option value="new" ${h.orderStatus==="new"?"selected":""}>–ù–æ–≤—ã–π<\/option>
          <option value="inprogress" ${h.orderStatus==="inprogress"?"selected":""}>–í —Ä–∞–±–æ—Ç–µ<\/option>
          <option value="done" ${h.orderStatus==="done"?"selected":""}>–ó–∞–≤–µ—Ä—à—ë–Ω<\/option>
          <option value="paid" ${h.orderStatus==="paid"?"selected":""}>–û–ø–ª–∞—á–µ–Ω<\/option>
          <option value="canceled" ${h.orderStatus==="canceled"?"selected":""}>–û—Ç–º–µ–Ω—ë–Ω<\/option>
        <\/select>
      <\/td>
      <td>${safeFixed(h.total)}<\/td>
      <td>
        ${Array.isArray(h.nalogReceipts) && h.nalogReceipts.length ?
          h.nalogReceipts.map((r,i)=>`<a href=\"https://lknpd.nalog.ru/api/v1/receipt/${localStorage.getItem('my_nalog_inn') || ''}/${r.uuid}/print\" target=\"_blank\" ${(r.canceled || i < h.nalogReceipts.length-1) ? 'class="text-danger"' : ''}>–ß–µ–∫${h.nalogReceipts.length>1 ? ' '+(i+1) : ''}<\/a>`).join('<br/>') :
          (h.nalogReceiptUuid ? `<a href=\"https://lknpd.nalog.ru/api/v1/receipt/${localStorage.getItem('my_nalog_inn') || ''}/${h.nalogReceiptUuid}/print\" target=\"_blank\">–ß–µ–∫<\/a>` : '')}
      <\/td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="onEditCalcHistory(${h.timestamp})">–†–µ–¥–∞–∫—Ç.<\/button>
        <button class="btn btn-sm btn-danger" onclick="onDeleteCalcHistoryEntry(${h.timestamp})">–£–¥–∞–ª–∏—Ç—å<\/button>
      <\/td>
    `;
  tb.appendChild(tr);
  });
}

function parseHistoryDate(str){
  const [d,t] = str.split(',');
  const [day,mon,year] = d.trim().split('.');
  return new Date(`${year}-${mon}-${day}T${(t||'00:00:00').trim()}`);
}

function updateHistoryStats(){
  const fromVal = document.getElementById('histFrom').value;
  const toVal = document.getElementById('histTo').value;
  const from = fromVal ? new Date(fromVal) : new Date('1970-01-01');
  const to = toVal ? new Date(toVal) : new Date();
  to.setDate(to.getDate()+1);
  const list = appData.calcHistory.filter(h=>{
    const d = parseHistoryDate(h.dateStr);
    return d>=from && d<to;
  });
  const sum = list.reduce((s,h)=>s+h.total,0);
  const hrs = list.reduce((s,h)=>s+h.totalHours,0);
  const div = document.getElementById('historyStats');
  div.textContent = `–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: ${list.length}, —Å—É–º–º–∞: ${safeFixed(sum)} ‚ÇΩ, —á–∞—Å—ã –ø–µ—á–∞—Ç–∏: ${safeFixed(hrs)}`;
}
function onDeleteCalcHistoryEntry(timestamp) {
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?")) return;
  appData.calcHistory = appData.calcHistory.filter(entry => entry.timestamp !== timestamp);
  saveToLocalStorage();
  renderHistoryTable();
  updateHistoryStats();
}
function onClearCalcHistory(){
  if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?")) return;
  appData.calcHistory = [];
  saveToLocalStorage();
  renderHistoryTable();
  updateHistoryStats();
}
function onExportHistory(){
  const js = JSON.stringify(appData.calcHistory, null, 2);
  document.getElementById("exportArea").value = js;
}
function onImportHistory(){
  const s = document.getElementById("importArea").value.trim();
  if(!s) {
    if(confirm("–ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
    return;
  }
  try{
    const obj = JSON.parse(s);
    if(!Array.isArray(obj)){
      alert("–û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤.");
      return;
    }
    appData.calcHistory = obj;
    saveToLocalStorage();
    renderHistoryTable();
    updateHistoryStats();
    alert("–ò–º–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à—ë–Ω.");
  } catch(e){
    alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏: " + e);
  }
}

function onChangeCalcHistoryStatus(timestamp, newStatus){
  const it = appData.calcHistory.find(x => x.timestamp === timestamp);
  if(!it) return;
  it.orderStatus = newStatus;
  saveToLocalStorage();
}

/* –§—É–Ω–∫—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ JSON */
function onExportJson(){
  const s = JSON.stringify(appData, null, 2);
  document.getElementById("exportArea").value = s;
}

function downloadJsonFile(){
  const blob = new Blob([JSON.stringify(appData,null,2)],{type:'application/json'});
  downloadBlob(blob,'calc_data.json');
}

function importFromFile(){
  const inp=document.getElementById('importJsonFile');
  if(!inp.files.length) return;
  const file=inp.files[0];
  const reader=new FileReader();
  reader.onload=()=>{
    document.getElementById('importArea').value=reader.result;
    onImportJson();
  };
  reader.readAsText(file);
}
function onImportJson(){
  const s = document.getElementById("importArea").value.trim();
  if(!s){
    if(confirm("–ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
    return;
  }
  try{
    const obj = JSON.parse(s);
    appData = migrateOldData(obj);
    
    // Normalize imported data (this handles both numeric conversion and sequential assignment)
    normalizeIds(appData);
    
    // Validate and alert if issues were found and fixed
    const validationResult = validateUniqueIds(appData);
    let alertMessage = "–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.";
    
    if (!validationResult.success) {
      alertMessage += "\n\n–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å ID, –Ω–æ –æ–Ω–∏ –±—ã–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã.";
    } else {
      alertMessage += " –í—Å–µ ID –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.";
    }
    
    saveToLocalStorage();
    initAll();
    alert(alertMessage);
  } catch(e){
    alert("–û—à–∏–±–∫–∞: " + e);
  }
}
function saveBrandingSettings(){
  const cn = document.getElementById("companyNameInput").value.trim();
  const cl = document.getElementById("chatLinkInput").value.trim();
  const pay = document.getElementById("bankDetailsInput").value.trim();
  const hours = parseFloat(document.getElementById("calcWorkHoursDay").value) || 0;
  appData.labelSettings.companyName = cn || "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è";
  appData.labelSettings.chatLink = cl || "https://t.me/example";
  appData.labelSettings.bankDetails = pay;
  appData.calcSettings.workHoursDay = hours;
  saveToLocalStorage();
  alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
}

function saveCalcSettings(){
  appData.labelSettings.printLabels = document.getElementById("printLabelsCheckbox").checked;
  appData.labelSettings.costPerLabel = parseFloat(document.getElementById("labelCostInput").value) || 0;
  appData.calcSettings.operatorRate = parseFloat(document.getElementById("calcOperatorRate").value) || 0;
  appData.calcSettings.includeOperatorForRejects = document.getElementById("calcOperatorReject").checked;
  appData.calcSettings.downtimeCost = parseFloat(document.getElementById("calcDowntimeCost").value) || 0;
  appData.calcSettings.preparationRate = parseFloat(document.getElementById("calcPreparationRate").value) || 0;
  appData.calcSettings.costKwh = parseFloat(document.getElementById("calcCostKwh").value) || 0;
  appData.calcSettings.taxPercent = parseFloat(document.getElementById("calcTaxPercent").value) || 0;
  saveToLocalStorage();
  alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
}

function onModelThumbnailChange(e, code){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = 140;
      canvas.height = 110;
      const ctx = canvas.getContext('2d');

      const targetRatio = canvas.width / canvas.height;
      const imgRatio = img.width / img.height;
      let sx, sy, sw, sh;
      if(imgRatio > targetRatio){
        sh = img.height;
        sw = sh * targetRatio;
        sx = (img.width - sw) / 2;
        sy = 0;
      } else {
        sw = img.width;
        sh = sw / targetRatio;
        sx = 0;
        sy = (img.height - sh) / 2;
      }

      ctx.drawImage(img, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      const base64 = dataUrl.split(',')[1];
      const tr = e.target.closest('tr');
      if(tr) tr.dataset.thumbnail = base64;
      let imgEl = document.getElementById('thumb_'+code);
      if(imgEl){
        if(imgEl.tagName.toLowerCase() === 'img'){
          imgEl.src = dataUrl;
        } else {
          imgEl.outerHTML = `<img id="thumb_${code}" src="${dataUrl}" style="height:40px;width:40px;object-fit:contain;border:1px solid #ccc;cursor:pointer" onclick=\"document.getElementById('thumbFile_${code}').click()\">`;
        }
      }
      saveToLocalStorage();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

/* –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞ */
function generateQRCodeCanvas(data, size, callback){
  const tempDiv = document.createElement("div");
  new QRCode(tempDiv, {
    text: data,
    width: size,
    height: size,
    correctLevel: QRCode.CorrectLevel.H
  });
  setTimeout(() => {
    const qrCanvas = tempDiv.querySelector("canvas");
    callback(qrCanvas);
  }, 100);
}

function downloadThermoLabelHtml(modelName, printerName, materialName, hours, weight, thumbnail) {
  const qrSize = 100;
  generateQRCodeCanvas(appData.labelSettings.chatLink, qrSize, function(qrCanvas) {
    const qrDataUrl = qrCanvas ? qrCanvas.toDataURL("image/png") : "";
    const htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=58mm, initial-scale=1">
  <title>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/title>
  <style>
    body { width: 58mm; height: 40mm; margin: 0; padding: 0; font-family: sans-serif; }
    #labelContainer {
      width: 58mm;
      height: 40mm;
      padding: 2mm;
      box-sizing: border-box;
      position: relative;
    }
    .label-header {
      text-align: center;
      font-size: 12pt;
      font-weight: bold;
      margin-bottom: 2mm;
    }
    .label-content {
      font-size: 10pt;
      line-height: 1.2;
    }
    .label-content div { margin-bottom: 1mm; }
    .qr-code {
      position: absolute;
      bottom: 2mm;
      right: 2mm;
      width: 15mm;
      height: 15mm;
    }
    .thumb {
      position: absolute;
      bottom: 2mm;
      right: 20mm;
      width: 15mm;
      height: 15mm;
    }
  <\/style>
<\/head>
<body>
<div id="labelContainer">
  <div class="label-header">${appData.labelSettings.companyName}<\/div>
  <div class="label-content">
    <div style="text-align: center;">${modelName}<\/div>
    <div>${printerName}<\/div>
    <div>${materialName}<\/div>
    <div>${formatTimeForDisplay(hours)}<\/div>
    <div>${weight} –≥<\/div>
    <div>${new Date().toLocaleDateString("ru-RU")}<\/div>
  <\/div>
  ${thumbnail ? `<img class="thumb" src="data:image/png;base64,${thumbnail}">` : ''}
  <img class="qr-code" src="${qrDataUrl}" alt="QR-–∫–æ–¥">
  <\/div>
  <\/body>
<\/html>
    `.trim();
    const blob = new Blob([htmlContent], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
  link.download = `ThermoLabel_${modelName}_${Date.now()}.html`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  });
}

function downloadAllThermoLabelsHtml(){
  if(!lastCalcFullData || !lastCalcFullData.detailsByPrinter){ alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö."); return; }
  const qrSize=100;
  generateQRCodeCanvas(appData.labelSettings.chatLink, qrSize, function(qrCanvas){
    const qrDataUrl=qrCanvas?qrCanvas.toDataURL("image/png"):"";
    let htmlContent=`<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–≠—Ç–∏–∫–µ—Ç–∫–∏<\/title>
  <style>
    body{font-family:sans-serif;}
    .label{width:58mm;height:40mm;margin:2mm;padding:2mm;box-sizing:border-box;position:relative;border:1px solid #000;display:inline-block;}
    .label-header{text-align:center;font-size:12pt;font-weight:bold;margin-bottom:2mm;}
    .label-content{font-size:10pt;line-height:1.2;}
    .label-content div{margin-bottom:1mm;}
    .qr-code{position:absolute;bottom:2mm;right:2mm;width:15mm;height:15mm;}
    .thumb{position:absolute;bottom:2mm;right:20mm;width:15mm;height:15mm;}
  <\/style>
<\/head>
<body>`;
    lastCalcFullData.detailsByPrinter.forEach(pr=>{
      pr.linesDetail.forEach(ln=>{
        htmlContent+=`<div class="label">
  <div class="label-header">${appData.labelSettings.companyName}<\/div>
  <div class="label-content">
    <div style="text-align: center;">${ln.name}<\/div>
    <div>${pr.printerName}<\/div>
    <div>${ln.matName}<\/div>
    <div>${formatTimeForDisplay(ln.hours)}<\/div>
    <div>${safeFixed(ln.weight)} –≥<\/div>
    <div>${new Date().toLocaleDateString('ru-RU')}<\/div>
  <\/div>
  ${ln.thumbnail ? `<img class="thumb" src="data:image/png;base64,${ln.thumbnail}">` : ''}
  <img class="qr-code" src="${qrDataUrl}" alt="QR-–∫–æ–¥">
<\/div>`;
      });
    });
    htmlContent+=`<\/body><\/html>`;
    const blob=new Blob([htmlContent],{type:'text/html'});
    downloadBlob(blob,`ThermoLabels_${Date.now()}.html`);
  });
}

/* –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç—Ç–∏–∫–µ—Ç–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 30x20 –º–º */
function downloadMaterialLabelHtml(materialId) {
  // –ò—â–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª —Å–Ω–∞—á–∞–ª–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö, –∑–∞—Ç–µ–º –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
  let mat = appData.materials.find(m => String(m.id) === String(materialId));
  if(!mat) {
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö, –ø—Ä–æ–≤–µ—Ä—è–µ–º —É –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
    for(let p of appData.printers) {
      if (Array.isArray(p.materials)) {
        mat = p.materials.find(m => String(m.id) === String(materialId));
        if(mat) break;
      }
    }
  }
  if(!mat) { alert("–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω."); return; }
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —ç—Ç–∏–∫–µ—Ç–∫–∏ (30x20 –º–º)
  const htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=30mm, initial-scale=1">
  <title>–≠—Ç–∏–∫–µ—Ç–∫–∞<\/title>
  <style>
    body { width: 30mm; height: 20mm; margin: 0; padding: 0; font-family: sans-serif; font-size: 8pt; }
    #labelContainer {
      width: 30mm;
      height: 20mm;
      padding: 1mm;
      box-sizing: border-box;
      position: relative;
      border: 1px solid #000;
    }
    .label-header { text-align: center; font-weight: bold; margin-bottom: 1mm; }
    .label-content div { margin-bottom: 0.5mm; }
  <\/style>
<\/head>
<body>
  <div id="labelContainer">
    <div class="label-header">${mat.name}<\/div>
    <div class="label-content">
      <div>${mat.declaredWeight || "-"} –∫–≥<\/div>
      <div>${mat.manufacturer || "-"}<\/div>
      <div>${mat.productionDate || "-"}<\/div>
    <\/div>
  <\/div>
<\/body>
<\/html>
  `.trim();
  
  const blob = new Blob([htmlContent], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `MaterialLabel_${mat.name}_${Date.now()}.html`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function buildSummaryCardHtml(data){
  return `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–°—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:var(--bs-body-bg);color:var(--bs-body-color);font-family:'Segoe UI',Tahoma,sans-serif;padding:2rem;background-image:radial-gradient(circle at 20% 20%,var(--bs-primary-bg-subtle),transparent 60%),radial-gradient(circle at 80% 0,var(--bs-success-bg-subtle),transparent 60%);} 
    .order-summary-card{max-width:1200px;margin:0 auto;background:var(--bs-light-bg-subtle);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.1);overflow:hidden;display:flex;flex-wrap:wrap;}
    .order-info{flex:1 1 300px;padding:1.5rem;background:var(--bs-secondary-bg);}
    .order-info h2{font-size:1.4rem;margin-bottom:1rem;color:var(--bs-primary);}
    .order-info .info-item{margin-bottom:.5rem;font-size:.95rem;}
    .order-info .label{font-weight:600;color:var(--bs-secondary-color);}
    .order-info .value{margin-left:.5rem;font-weight:500;}
    .order-info .qr{text-align:center;margin-bottom:1rem;}
    .order-info .qr img{width:120px;height:120px;}
    .models{flex:2 1 600px;padding:1.5rem;}
    .models-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem;}
    .model-card{background:var(--bs-light-bg-subtle);border-radius:8px;padding:1rem;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.05);transition:transform .3s ease,box-shadow .3s ease;}
    .model-card:hover{transform:translateY(-4px);box-shadow:0 4px 16px rgba(0,0,0,0.1);}
    .model-card img{width:48px;height:48px;margin-bottom:.5rem;}
    .model-card h3{font-size:1rem;margin-bottom:.5rem;color:var(--bs-primary);}
    .model-card p{font-size:.9rem;margin:.25rem 0;color:var(--bs-secondary-color);}
    .model-card p strong{color:var(--bs-body-color);}
    @media (max-width:800px){.order-summary-card{flex-direction:column;}.order-info,.models{flex:1 1 auto;}}
  </style>
</head>
<body>
<div class="order-summary-card">
  <div class="order-info">
    <h2>${data.company}</h2>
    <div class="qr"><img src="${data.qr}" alt="QR"></div>
    <div class="info-item"><span class="label">–ö–æ–¥ –∑–∞–∫–∞–∑–∞:<\/span><span class="value">${data.orderId}<\/span></div>
    <div class="info-item"><span class="label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:<\/span><span class="value">${data.orderName}<\/span></div>
    <div class="info-item"><span class="label">–ö–ª–∏–µ–Ω—Ç:<\/span><span class="value">${data.client}<\/span></div>
    <div class="info-item"><span class="label">–°—Ç–∞—Ç—É—Å:<\/span><span class="value">${data.status}<\/span></div>
    <div class="info-item"><span class="label">–û–±—â–µ–µ –≤—Ä–µ–º—è –ø–µ—á–∞—Ç–∏:<\/span><span class="value">${data.totalTime}<\/span></div>
    <div class="info-item"><span class="label">–°—É–º–º–∞—Ä–Ω—ã–π –≤–µ—Å:</span><span class="value">${data.totalWeight} –≥</span></div>
    ${data.services && data.services.length ? data.services.map(s => `<div class="info-item"><span class="label">${s.name}:<\/span><span class="value">${s.total} ‚ÇΩ<\/span></div>`).join('') + `<div class="info-item"><span class="label">–ò—Ç–æ–≥–æ —É—Å–ª—É–≥–∏:<\/span><span class="value">${data.servicesTotal} ‚ÇΩ<\/span></div>` : ''}
    <div class="info-item"><span class="label">–ò—Ç–æ–≥–æ:<\/span><span class="value">${data.priceOld ? `<del>${data.priceOld} ‚ÇΩ<\/del> ${data.totalCost} ‚ÇΩ (-${data.discountPercent}% )` : `${data.totalCost} ‚ÇΩ`}<\/span></div>
    <div class="info-item"><span class="label">–¶–µ–Ω–∞ –∑–∞ 1 –≥—Ä–∞–º–º:<\/span><span class="value">${data.pricePerGram} ‚ÇΩ<\/span></div>
    ${data.paymentInfo ? `<div class="info-item"><span class="label">–û–ø–ª–∞—Ç–∞:<\/span><span class="value">${data.paymentInfo}<\/span></div>` : ''}
    ${data.finDate ? `<div class="info-item"><span class="label">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:<\/span><span class="value">${data.finDate}<\/span></div>` : ''}
  <\/div>
  <div class="models">
    <div class="models-grid">${data.modelsHtml}<\/div>
  <\/div>
<\/div>
</body>
</html>`;
}

function downloadSummaryCardHtml(){
  if(!lastSummaryCardHtml){alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.');return;}
  const blob=new Blob([lastSummaryCardHtml],{type:'text/html'});
  downloadBlob(blob,`Invoice_${Date.now()}.html`);
}

function generateDeviceId(len=16){
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let out='';
  for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}

function buildPaymentQrString(){
  return appData.labelSettings.chatLink || '';
}

async function refreshMyNalogToken(){
  const refresh = localStorage.getItem('my_nalog_refresh');
  const deviceId = localStorage.getItem('my_nalog_device_id');
  if(!refresh || !deviceId) return false;
  const body={
    refreshToken: refresh,
    deviceInfo:{
      sourceDeviceId: deviceId,
      sourceType:'WEB',
      appVersion:'1.0.0',
      metaDetails:{userAgent:navigator.userAgent}
    }
  };
  try{
    const resp = await fetch(MY_NALOG_API+'/api/v1/auth/token',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(resp.ok){
      const data = await resp.json();
      if(data.token){
        localStorage.setItem('my_nalog_token', data.token);
        if(data.refreshToken) localStorage.setItem('my_nalog_refresh', data.refreshToken);
        return true;
      }
    }
  }catch(e){
    console.error('token refresh failed');
  }
  return false;
}

async function sendMyNalogRequest(method,url,body){
  let token = localStorage.getItem('my_nalog_token');
  if(!token) throw new Error('no token');
  const opt={method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}};
  if(body) opt.body=JSON.stringify(body);
  let resp = await fetch(url,opt);
  if(resp.status===401){
    const ok = await refreshMyNalogToken();
    if(ok){
      token = localStorage.getItem('my_nalog_token');
      opt.headers['Authorization']='Bearer '+token;
      resp = await fetch(url,opt);
    }
  }
  return resp;
}

async function cancelReceiptInternal(receipt, comment){
  if(!receipt || !receipt.uuid) return false;
  const payload = {
    receiptUuid: receipt.uuid,
    comment: comment || '',
    partnerCode: null,
    requestTime: new Date().toISOString()
  };
  try{
    const resp = await sendMyNalogRequest('POST',MY_NALOG_API+'/api/v1/cancel',payload);
    if(resp.ok){
      receipt.canceled = true;
      const idx = appData.calcHistory.findIndex(e=>String(e.id)===String(lastCalcFullData.id));
      if(idx!==-1 && Array.isArray(appData.calcHistory[idx].nalogReceipts)){
        const arr = appData.calcHistory[idx].nalogReceipts;
        const j = arr.findIndex(r=>r.uuid===receipt.uuid);
        if(j!==-1) arr[j].canceled = true;
        saveToLocalStorage();
        renderHistoryTable();
      }
      return true;
    }
  }catch(e){
  }
  return false;
}

function showCheckLinkModal(checkUrl) {
  document.getElementById('checkLinkInput').value = checkUrl;
  const modal = new bootstrap.Modal(document.getElementById('checkLinkModal'));
  modal.show();
}

async function sendMyNalogReceipt(){
  if(!lastCalcFullData){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–∞.'); return; }
  if(!Array.isArray(lastCalcFullData.nalogReceipts)) lastCalcFullData.nalogReceipts = [];
  if(lastCalcFullData.nalogReceipts.length){
    const last = lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1];
    const inn = localStorage.getItem('my_nalog_inn') || '';
    const url = inn ? `https://lknpd.nalog.ru/api/v1/receipt/${inn}/${last.uuid}/print` : '';
    const force = confirm('–ß–µ–∫ —É–∂–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω' + (url ? '\n'+url : '') + '\n–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å?');
    if(!force) return;
    await cancelReceiptInternal(last, '–æ—à–∏–±–æ—á–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ');
  }
  const btn = document.getElementById('sendMyNalogBtn');
  if(btn) btn.disabled = true;
  const payload = {
    operationTime: new Date().toISOString(),
    requestTime: new Date().toISOString(),
    services: [{ name: `–ü–µ—á–∞—Ç—å –Ω–∞ 3–¥-–ø—Ä–∏–Ω—Ç–µ—Ä–µ "${lastCalcFullData.calcName || ''}" #${lastCalcFullData.id || ''}`, amount: lastCalcFullData.total, quantity: 1 }],
    totalAmount: lastCalcFullData.total,
    paymentType: 'CASH',
    ignoreMaxTotalIncomeRestriction: false,
    client: { contactPhone: null, displayName: null, incomeType: 'FROM_INDIVIDUAL', inn: null }
  };
  try {
    const resp = await sendMyNalogRequest('POST',MY_NALOG_API+'/api/v1/income',payload);
    if(resp.ok){
      const data = await resp.json().catch(()=>null);
      if(data?.approvedReceiptUuid){
        console.log(data);
        const inn = localStorage.getItem('my_nalog_inn') || '';
        lastCalcFullData.receiptUuid = data.approvedReceiptUuid;
        lastCalcFullData.orderStatus = 'paid';
        document.getElementById('calcOrderStatus').value = 'paid';
        toggleFinalFields('paid');
        const idx = appData.calcHistory.findIndex(e=>String(e.id)===String(lastCalcFullData.id));
        if(idx!==-1){
          const recList = Array.isArray(appData.calcHistory[idx].nalogReceipts)
            ? appData.calcHistory[idx].nalogReceipts.map(r=>({uuid:r.uuid, canceled:!!r.canceled}))
            : [];
          recList.push({uuid:data.approvedReceiptUuid, canceled:false});
          appData.calcHistory[idx].nalogReceipts = recList;
          appData.calcHistory[idx].nalogReceiptUuid = data.approvedReceiptUuid;
          appData.calcHistory[idx].orderStatus = 'paid';
        }
        if(!Array.isArray(lastCalcFullData.nalogReceipts)) lastCalcFullData.nalogReceipts = [];
        lastCalcFullData.nalogReceipts.push({uuid:data.approvedReceiptUuid,canceled:false});
        
        // Save to localStorage after all updates are complete
        saveToLocalStorage();
        if(idx!==-1){
          renderHistoryTable();
        }
        const cancelBtn=document.getElementById('cancelMyNalogBtn');
        if(cancelBtn) cancelBtn.style.display='inline-block';
        if(btn) btn.disabled = false;
        alert('–ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
 	const receiptUrl = inn ? `https://lknpd.nalog.ru/api/v1/receipt/${inn}/${data.approvedReceiptUuid}/print` : '';
 	showCheckLinkModal(receiptUrl);
	      
      }else{
        alert('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ú–æ–π –ù–∞–ª–æ–≥');
      }
    }else{
      const text = await resp.text().catch(()=>resp.status);
      alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: '+text);
    }
  }catch(e){
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–∏—Å—É –ú–æ–π –ù–∞–ª–æ–≥');
  }finally{
    if(btn) btn.disabled = false;
  }
}

async function cancelMyNalogReceipt(){
  if(!lastCalcFullData || !Array.isArray(lastCalcFullData.nalogReceipts) || !lastCalcFullData.nalogReceipts.length){
    alert('–ù–µ—Ç —á–µ–∫–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã.');
    return;
  }
  const last = lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1];
  const comment = prompt('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã —á–µ–∫a:','');
  if (!comment || !comment.trim()) {
    alert('–ù–µ —É–∫–∞–∑–∞–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã —á–µ–∫–∞.\n–ß–µ–∫ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω—ë–Ω.');
    return;
  }
  const btn=document.getElementById('cancelMyNalogBtn');
  if(btn) btn.disabled=true;
  const ok = await cancelReceiptInternal(last, comment || '');
  if(ok){
    lastCalcFullData.orderStatus='canceled';
    const idx=appData.calcHistory.findIndex(e=>String(e.id)===String(lastCalcFullData.id));
    if(idx!==-1){
      appData.calcHistory[idx].orderStatus='canceled';
      saveToLocalStorage();
      renderHistoryTable();
    }
    const cancelBtn=document.getElementById('cancelMyNalogBtn');
    const showCancel = lastCalcFullData.nalogReceipts.length && !lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1].canceled;
    if(cancelBtn) cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
    alert('–ß–µ–∫ –æ—Ç–º–µ–Ω—ë–Ω.');
  }else{
    alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã —á–µ–∫–∞');
  }
  if(btn) btn.disabled=false;
}

function saveMyNalogSettings(){
  const token = document.getElementById('myNalogToken').value.trim();
  localStorage.setItem('my_nalog_token', token);
  const phoneEl = document.getElementById('myNalogPhone');
  if(phoneEl) localStorage.setItem('my_nalog_phone', phoneEl.value.trim());
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
}

async function checkMyNalogStatus() {
  const token = localStorage.getItem('my_nalog_token');
  const statusEl = document.getElementById('myNalogStatus');
  if (!token) {
    statusEl.textContent = '–¢–æ–∫–µ–Ω –Ω–µ –∑–∞–¥–∞–Ω';
    return;
  }
  statusEl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
  try {
    const resp = await sendMyNalogRequest('GET', MY_NALOG_API + '/api/v1/user');
    if (resp.ok) {
      const data = await resp.json();
      if (data.health === "false") {
        // Display technical work message from the API
        statusEl.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.message}`;
      } else if(data.displayName) {
        statusEl.innerHTML = `<i class="bi bi-check-square me-2"></i>–ò–ù–ù ${data.inn} ${data.displayName}`;
        localStorage.setItem('my_nalog_inn', data.inn || '');
      } else {
        statusEl.textContent = '–°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω';
      }
    } else {
      statusEl.textContent = '–û—à–∏–±–∫–∞: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å';
    }
  } catch (e) {
    statusEl.textContent = '–û—à–∏–±–∫–∞: –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
  }
}

async function requestMyNalogSms(){
  const phoneNum = document.getElementById('myNalogPhone').value.trim();
  const statusEl = document.getElementById('myNalogStatus');
  if(!phoneNum){
    alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω');
    return;
  }
  statusEl.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ SMS...';
  try{
    const resp = await fetch(MY_NALOG_API+'/api/v1/auth/challenge/sms/start', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({phone: phoneNum, requireTpToBeActive: true})
    });
    if(resp.ok){
      const data = await resp.json();
      myNalogChallengeToken = data.challengeToken;
      statusEl.textContent = 'SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
    }else{
      const text = await resp.text().catch(()=>resp.status);
      statusEl.textContent = '–û—à–∏–±–∫–∞: ' + text;
    }
  }catch(e){
    statusEl.textContent = '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
  }
}

async function confirmMyNalogSms(){
  const phoneNum = document.getElementById('myNalogPhone').value.trim();
  const code = document.getElementById('myNalogSms').value.trim();
  const statusEl = document.getElementById('myNalogStatus');
  if(!phoneNum || !code){
    alert('–ù—É–∂–µ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –∫–æ–¥');
    return;
  }
  statusEl.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ...';
  try{
    const challenge = myNalogChallengeToken || '';
    const deviceId = localStorage.getItem('my_nalog_device_id') || generateDeviceId();
    localStorage.setItem('my_nalog_device_id', deviceId);
    const body = {
      phone: phoneNum,
      code,
      challengeToken: challenge,
      deviceInfo:{
        sourceDeviceId: deviceId,
        sourceType:'WEB',
        appVersion:'1.0.0',
        metaDetails:{userAgent:navigator.userAgent}
      }
    };
    const resp = await fetch(MY_NALOG_API+'/api/v1/auth/challenge/sms/verify', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(resp.ok){
      const data = await resp.json().catch(()=>null);
      if(data?.token){
        localStorage.setItem('my_nalog_token', data.token);
        localStorage.setItem('my_nalog_refresh', data.refreshToken || '');
        document.getElementById('myNalogToken').value = data.token;
        if(data.inn){
          localStorage.setItem('my_nalog_inn', data.inn);
        } else {
          await checkMyNalogStatus();
        }
        statusEl.textContent = '–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω';
      }else{
        statusEl.textContent = '–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
      }
    }else{
      const text = await resp.text().catch(()=>resp.status);
      statusEl.textContent = '–û—à–∏–±–∫–∞: ' + text;
    }
  }catch(e){
    statusEl.textContent = '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
  }
}

function loadMyNalogSettings(){
  const token = localStorage.getItem('my_nalog_token') || '';
  const inp = document.getElementById('myNalogToken');
  if(inp) inp.value = token;
  const savedPhone = localStorage.getItem('my_nalog_phone') || '';
  const phoneInp = document.getElementById('myNalogPhone');
  if(phoneInp) phoneInp.value = savedPhone;
  if(token) checkMyNalogStatus();
}
function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
function startNewCalculation(){
  document.getElementById("calcName").value="";
  document.getElementById("calcClientName").value="";
  document.getElementById("calcOrderStatus").value="new";
  document.getElementById("calcOrderId").value="";
  document.getElementById("calcDiscountPercent").value = 0;
  document.getElementById("calcFinalCost").value = "";
  toggleFinalFields('new');
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("calcStartDate").value=today;
  document.getElementById("calcPreparationTime").value = appData.calcSettings.preparationTime ? formatTimeForDisplay(appData.calcSettings.preparationTime) : "";
  lastCalcFullData = null;
  appData.printers.forEach(pr=>{
    const table=document.getElementById(`calcModelsTable_${pr.id}`);
    if(table) table.querySelector("tbody").innerHTML="";
  });
}

function toggleFinalFields(val){
  const group=document.getElementById('finalCostGroup');
  if(group){
    group.classList.toggle('d-none', val !== 'done' && val !== 'paid');
  }
}


/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OrcaSlicer –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ */
let currentOrcaPrinterId = null;
let currentOrcaProfileIndex = 0;
const ORCA_PRINTER_FIELDS = [];

function populateOrcaProfileSelect(pr){
  const sel=document.getElementById('orcaProfileSelect');
  sel.innerHTML='';
  (pr.profileIds||[]).forEach((pid,i)=>{
    const pf=appData.printerProfiles.find(p=>String(p.id)===String(pid));
    const cfg=pf?pf.config||{}:{};
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=cfg.printer_settings_id||cfg.name||('–ü—Ä–æ—Ñ–∏–ª—å '+(i+1));
    sel.appendChild(opt);
  });
}

function loadOrcaProfile(pr,index){
  currentOrcaProfileIndex=index;
  const pid=pr.profileIds[index];
  const profile=appData.printerProfiles.find(p=>String(p.id)===String(pid));
  const cfg=profile?profile.config||{}:{};
  document.getElementById('orcaPrinterJsonView').textContent=JSON.stringify(cfg,null,2);
  document.getElementById('orcaPrinterInfoView').textContent=profile?profile.info||'':'';
  document.getElementById('orcaProfileSelect').value=index;
}

function openPrinterOrca(id){
  const pr=appData.printers.find(p=>String(p.id)===String(id));
  if(!pr) return;
  currentOrcaPrinterId=String(id);
  if(!Array.isArray(pr.profileIds)) pr.profileIds=[];
  if(pr.profileIds.length===0){
    const pf={id:getNextId('printerProfiles'),config:{},info:'',printerId:String(pr.id)};
    appData.printerProfiles.push(pf);
    pr.profileIds.push(pf.id);
  }
  populateOrcaProfileSelect(pr);
  loadOrcaProfile(pr,0);
  new bootstrap.Modal(document.getElementById('orcaPrinterModal')).show();
}




function deleteOrcaProfile(){
  if(currentOrcaPrinterId===null) return;
  const pr=appData.printers.find(p=>String(p.id)===String(currentOrcaPrinterId));
  if(!pr) return;
  if(pr.profileIds.length<=1) return;
  const pid=pr.profileIds.splice(currentOrcaProfileIndex,1)[0];
  appData.printerProfiles=appData.printerProfiles.filter(p=>String(p.id)!==String(pid));
  const idx=Math.max(0,currentOrcaProfileIndex-1);
  populateOrcaProfileSelect(pr);
  loadOrcaProfile(pr,idx);
}

function downloadFullDetailedCalculation(){
  if(!lastCalcFullData){ alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–∞."); return; }
  const h = generateMaxDetailedCalcHtml(lastCalcFullData);
  const b = new Blob([h], {type:"text/html"});
  const u = URL.createObjectURL(b);
  const l = document.createElement("a");
  l.href = u;
  l.download = `FullDetailedCalc_${Date.now()}.html`;
  document.body.appendChild(l);
  l.click();
  document.body.removeChild(l);
  URL.revokeObjectURL(u);
}
function generateMaxDetailedCalcHtml(d) {
  let s = `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç<\/title>
  <style>
    body { font-family: sans-serif; margin:20px; }
    .printer-block { margin:10px 0; padding:5px; border:1px dashed #999; }
    table { border-collapse: collapse; }
    td, th { border:1px solid #999; padding:4px 6px; }
  <\/style>
<\/head>
<body>
  <h1>–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á—ë—Ç<\/h1>
  <p>–ù–∞–∑–≤–∞–Ω–∏–µ: ${d.calcName || "(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)"}, –ö–ª–∏–µ–Ω—Ç: ${d.clientName || "(–ù–µ —É–∫–∞–∑–∞–Ω)"}, –°—Ç–∞—Ç—É—Å: ${d.orderStatus || "?"}<\/p>
  <p>–ò—Ç–æ–≥: <strong>${safeFixed(d.total)} ‚ÇΩ<\/strong>${d.priceBeforeDiscount ? ` (—Å–∫–∏–¥–∫–∞ ${d.discountPercent}% –æ—Ç ${safeFixed(d.priceBeforeDiscount)} ‚ÇΩ)` : ''}<\/p>
  <p>–û–ø–µ—Ä–∞—Ç–æ—Ä —á.: ${formatTimeForDisplay(d.totalHours)} —á, –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ${safeFixed(d.totalOperatorCost)} ‚ÇΩ, –ù–∞–ª–æ–≥: ${d.taxPercent}%, –£–ø–∞–∫–æ–≤–∫–∞/–î–æ—Å—Ç–∞–≤–∫–∞: ${d.shipping}‚ÇΩ, –≠–ª.: ${d.costKwh}‚ÇΩ/–∫–í—Ç‚ãÖ—á<\/p>
  <p>–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø–µ—á–∞—Ç—å: ${d.parallelMode}, –ù–∞—Ü–µ–Ω–∫–∞: ${d.markupPercent || 0}%<\/p>
  <p>–ü–æ–¥–∏—Ç–æ–≥: ${safeFixed(d.total - d.globalAdditional.taxAmount)} ‚ÇΩ, –û–±—â–∏–π –Ω–∞–ª–æ–≥: ${safeFixed(d.globalAdditional.taxAmount)} ‚ÇΩ<\/p>
  <hr/>
`;
  d.detailsByPrinter.forEach(pr => {
    s += `<div class="printer-block">
      <strong>–ü—Ä–∏–Ω—Ç–µ—Ä: ${pr.printerName} (ID: ${pr.printerId})<\/strong><br/>
      –í—Ä–µ–º—è: ${formatTimeForDisplay(pr.printerTime)} —á<br/>
    `;
    if(pr.linesDetail && pr.linesDetail.length>0){
      s += `<table style="margin-top:5px;">
        <thead><tr>
          <th>–ú–æ–¥–µ–ª—å<\/th>
          <th>–ò–∫–æ–Ω–∫–∞<\/th>
          <th>–°—Ç–∞—Ç—É—Å<\/th>
          <th>–ß–∞—Å—ã<\/th>
          <th>–í–µ—Å (–≥)<\/th>
          <th>–ú–∞—Ç–µ—Ä–∏–∞–ª<\/th>
          <th>–í–µ—Å —Å –±—Ä–∞–∫–æ–º<\/th>
          <th>–°—É–º–º–∞<\/th>
        <\/tr><\/thead>
        <tbody>`;
      pr.linesDetail.forEach(ln => {
        s += `<tr>
          <td>${ln.name} (${ln.id || ''})<\/td>
          <td>${ln.thumbnail ? `<img src="data:image/png;base64,${ln.thumbnail}" style="height:40px;"/>` : ''}<\/td>
          <td>${ln.status}<\/td>
          <td>${safeFixed(ln.hours)}<\/td>
          <td>${safeFixed(ln.weight)}<\/td>
          <td>${ln.matName}<\/td>
          <td>${safeFixed(ln.realWeight)}<\/td>
          <td>${safeFixed(ln.subTotalModel)}<\/td>
        <\/tr>`;
      });
      s += `<\/tbody><\/table>`;
    }
    s += `<\/div>`;
  });
  s += `<\/body><\/html>`;
  return s;
}
function onEditCalcHistory(timestamp){
  const it = appData.calcHistory.find(x => x.timestamp === timestamp);
  if(!it){ alert("–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏"); return; }

  const missing = [];
  if(it.calcData){
    for(const pid in it.calcData){
      if(!appData.printers.find(p=>String(p.id)===String(pid))) missing.push(pid);
    }
  }
  if(missing.length){
    const opts = appData.printers.map(p=>({value:String(p.id),label:p.name||p.id}));
    const fields = missing.map(id=>({id:id,label:`–ü—Ä–∏–Ω—Ç–µ—Ä –¥–ª—è ${id}`,type:'select',options:opts}));
    showMultiPrompt('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∏–Ω—Ç–µ—Ä—ã', fields).then(vals=>{
      if(!vals) return;
      missing.forEach(id=>{
        const newId = vals[id];
        if(newId && it.calcData[id]){
          it.calcData[newId] = (it.calcData[newId]||[]).concat(it.calcData[id]);
        }
        delete it.calcData[id];
      });
      onEditCalcHistory(timestamp);
    });
    return;
  }
  document.getElementById("calcOrderId").value = it.id || "";
  document.getElementById("calcName").value = it.calcName || "";
  document.getElementById("calcClientName").value = it.clientName || "";
  document.getElementById("calcOrderStatus").value = it.orderStatus || "new";
  document.getElementById("calcOperatorRate").value = it.operatorRate || "";
  document.getElementById("calcWorkHoursDay").value = appData.calcSettings.workHoursDay || "";
  document.getElementById("calcCostKwh").value = it.costKwh || "";
  document.getElementById("calcTaxPercent").value = it.taxPercent || "";
  document.getElementById("calcShipping").value = it.shipping || "";
  document.getElementById("calcStartDate").value = appData.calcSettings.startDate || "";
  document.getElementById("calcParallelPrinting").value = it.parallelMode || "no";
  document.getElementById("calcMarkupPercent").value = it.markupPercent || 0;
  document.getElementById("calcDiscountPercent").value = it.discountPercent || 0;
  document.getElementById("calcFinalCost").value = it.realTotal || '';
  toggleFinalFields(it.orderStatus || 'new');
  appData.calcSettings.customServices = it.services ? it.services.map(s=>({...s})) : [];
  renderCustomServicesTable();

  if(it.calcData){
    for(const printerId in it.calcData){
      const table = document.getElementById(`calcModelsTable_${printerId}`);
      if(!table) continue;
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";
      const prIdNum = isNaN(printerId) ? printerId : parseInt(printerId, 10);
      it.calcData[printerId].forEach(model => {
        addModelRow(prIdNum, model);
      });
    }
  }
  const tabEl = document.querySelector('#calculate-tab');
  const tab = new bootstrap.Tab(tabEl);
  tab.show();
}

  function ensureIconsLoaded() {
    if (!document.querySelector('link[href*="bootstrap-icons"]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css';
      document.head.appendChild(link);
    }
  }

  function onSummaryPeriodChange(){
    const val = document.getElementById('summaryPeriod').value;
    const fromInput = document.getElementById('summaryFrom');
    const toInput = document.getElementById('summaryTo');
    const applyBtn = document.getElementById('summaryApplyBtn');
    const showCustom = val === 'custom';
    fromInput.classList.toggle('d-none', !showCustom);
    toInput.classList.toggle('d-none', !showCustom);
    applyBtn.classList.toggle('d-none', !showCustom);
    if(!showCustom){
      renderSummary();
    }
  }

  function renderSummary() {
  ensureIconsLoaded();
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const formatCurrency = (value) => new Intl.NumberFormat('ru-RU', { 
    style: 'currency', 
    currency: 'RUB',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value);

  const formatNumber = (value, decimals = 2) =>
    new Intl.NumberFormat('ru-RU', {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    }).format(value);

  const period = document.getElementById('summaryPeriod').value;
  let to = new Date();
  let from = new Date(to);
  if(period === 'week'){
    from.setDate(from.getDate() - 7);
  } else if(period === 'month'){
    from.setMonth(from.getMonth() - 1);
  } else if(period === 'year'){
    from.setFullYear(from.getFullYear() - 1);
  } else if(period === 'custom'){
    const fv = document.getElementById('summaryFrom').value;
    const tv = document.getElementById('summaryTo').value;
    if(fv) from = new Date(fv);
    if(tv){ to = new Date(tv); to.setDate(to.getDate()+1); }
  } else if(period === 'all'){
    from = new Date('1970-01-01');
  }

  // 1. –†–∞—Å—á–µ—Ç –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π
  const calculateCapitalInvestments = () => {
    const printersCost = appData.printers.reduce((sum, p) => sum + (p.cost || 0), 0);
    const materials = appData.materials.reduce((acc, m) => {
      const weight = m.declaredWeight || 0;
      const cost = (m.costPerKg || 0) * weight;
      acc.cost += cost;
      acc.weight += weight;
      return acc;
    }, { cost: 0, weight: 0 });
    const additional = appData.additionalGlobal.reduce((sum, a) => sum + (a.cost || 0), 0);
    const total = printersCost + materials.cost + additional;
    return {
      printersCost,
      materialsCost: materials.cost,
      materialsWeight: materials.weight,
      additionalCost: additional,
      total
    };
  };

  // 2. –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
  const analyzeCompletedOrders = (fromDate, toDate) => {
    const completedOrders = appData.calcHistory.filter(o => {
      const ts = o.timestamp || (o.dateStr ? parseHistoryDate(o.dateStr).getTime() : 0);
      return (o.orderStatus === "done" || o.orderStatus === "paid") && ts >= fromDate.getTime() && ts < toDate.getTime();
    });
    const results = {
      totalRevenue: 0,
      totalTax: 0,
      totalCost: 0,
      totalPrintHours: 0,
      totalElectricityCost: 0,
      totalOperatorExpenses: 0,
      totalServiceCost: 0,
      totalShippingCost: 0,
      totalAdditionalCost: 0,
      totalMaterialCost: 0,
      totalPrinterCost: 0,
      totalMaintenanceCost: 0,
      totalRejectHours: 0,
      totalRejectGrams: 0,
      materialStats: {},
      printerStats: {},
      clientStats: {},
      completedOrdersCount: completedOrders.length
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
    appData.printers.forEach(p => {
      results.printerStats[p.id] = {
        name: p.name,
        hours: 0,
        amortization: 0,
        energy: 0,
        material: 0,
        maintenance: 0,
        revenue: 0,
        prints: 0,
        grams: 0,
        rejectHours: 0,
        rejectGrams: 0
      };
    });

    completedOrders.forEach(order => {
      results.totalRevenue += order.total || 0;
      let orderCost = 0;
      let orderGrams = 0;

      // –†–∞—Å—á–µ—Ç –Ω–∞–ª–æ–≥–æ–≤
      if (order.taxAmount !== undefined) {
        results.totalTax += order.taxAmount;
      } else if (order.taxPercent !== undefined && order.taxPercent > 0) {
        results.totalTax += order.total * (order.taxPercent / 100);
      }

      // –£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
      results.totalOperatorExpenses += order.totalOperatorCost || 0;

      // –£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ —É—Å–ª—É–≥–∏
      results.totalServiceCost += order.servicesTotal || 0;

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
      order.details?.forEach(printer => {
        const printerId = printer.printerId;

          if (!results.printerStats[printerId]) {
            results.printerStats[printerId] = {
              name: printer.printerName,
              hours: 0,
              amortization: 0,
              energy: 0,
              material: 0,
              maintenance: 0,
              revenue: 0,
              prints: 0,
              grams: 0,
              rejectHours: 0,
              rejectGrams: 0
            };
          }

        printer.linesDetail?.forEach(model => {
        const materialId = model.materialData?.id;
        const materialCost = model.costMaterial || 0;
        const amortization = model.costPrinterPart || 0;
        const electric = model.costElectric || 0;
        const maintenance = model.costMaintenance || 0;
        const modelRevenue = model.subTotalModel || 0;
        const hours = model.hours || 0;
        const status = model.status;
        const ps = results.printerStats[printerId];
        orderGrams += model.realWeight || 0;
        if (status === 'reject') {
          results.totalRejectHours += hours;
          results.totalRejectGrams += model.realWeight || 0;
          ps.rejectHours += hours;
          ps.rejectGrams += model.realWeight || 0;
        }

          if (materialId) {
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
            if (!results.materialStats[materialId]) {
              const mat = findMaterialById(materialId);
              results.materialStats[materialId] = {
                name: mat ? `${mat.name} (ID: ${mat.id}) | ${mat.manufacturer}` :
                          `${model.matName} | ${model.materialData?.manufacturer || 'N/A'}`,
                type: mat?.materialType || model.materialData?.materialType || '',
                manufacturer: mat?.manufacturer || model.materialData?.manufacturer || '',
                totalGrams: 0,
                totalCost: 0,
                totalRevenue: 0
              };
            }

            results.materialStats[materialId].totalGrams += model.realWeight || 0;
            results.materialStats[materialId].totalCost += materialCost;
            results.materialStats[materialId].totalRevenue += modelRevenue;
          }

          // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã
          results.totalMaterialCost += materialCost;
          results.totalPrinterCost += amortization;
          results.totalMaintenanceCost += maintenance;
          results.totalElectricityCost += electric;
          results.totalCost += materialCost + amortization + electric + maintenance;
          orderCost += materialCost + amortization + electric + maintenance;
          results.totalPrintHours += hours;

          // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º
          ps.hours += hours;
          ps.amortization += amortization;
          ps.energy += electric;
          ps.material += materialCost;
          ps.maintenance += maintenance;
          ps.revenue += modelRevenue;
          ps.prints++;
          ps.grams += model.realWeight || 0;
        });
      });

      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
      const addCost = order.globalAdditional?.sumGlobalAdd || 0;
      const shipping = order.shipping || 0;
      const globalCosts = addCost + shipping + (order.totalOperatorCost || 0) + (order.servicesTotal || 0);
      results.totalAdditionalCost += addCost;
      results.totalShippingCost += shipping;
      results.totalCost += globalCosts;
      orderCost += globalCosts;

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
      const clientName = order.clientName || '(–ù–µ —É–∫–∞–∑–∞–Ω)';
      if (!results.clientStats[clientName]) {
        results.clientStats[clientName] = { name: clientName, revenue: 0, cost: 0, grams: 0, orders: 0 };
      }
      const cs = results.clientStats[clientName];
      cs.revenue += order.total || 0;
      cs.cost += orderCost;
      cs.grams += orderGrams;
      cs.orders += 1;
    });

    return results;
  };

  // 3. –†–∞—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
  const calculateKPIs = (capital, ordersAnalysis) => {
    const {
      totalRevenue,
      totalCost,
      totalTax,
      totalPrintHours,
      totalElectricityCost,
      totalOperatorExpenses,
      totalServiceCost,
      totalShippingCost,
      totalAdditionalCost,
      totalMaterialCost,
      totalPrinterCost,
      totalMaintenanceCost,
      materialStats,
      completedOrdersCount
    } = ordersAnalysis;

    const grossProfit = totalRevenue - totalCost;
    const netProfit = grossProfit - totalTax;
    const netMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
    const grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;
    const roi = capital.total > 0 ? (netProfit / capital.total) * 100 : 0;

    const paybackOrders = completedOrdersCount > 0 && netProfit !== 0
      ? capital.total / (netProfit / completedOrdersCount)
      : 0;

    const totalGrams = Object.values(materialStats).reduce(
      (sum, m) => sum + m.totalGrams, 0);

    const ebitda = netProfit + totalTax + totalPrinterCost;
    const breakEvenRevenue = capital.total + (totalCost - totalPrinterCost) + totalTax;
    const revenueGap = breakEvenRevenue - totalRevenue;
    const profitabilityIndex = capital.total > 0 ? (netProfit + capital.total) / capital.total : 0;
    const depreciationRate = capital.printersCost > 0 ? (totalPrinterCost / capital.printersCost) * 100 : 0;

    return {
      grossProfit,
      netProfit,
      netMargin,
      grossMargin,
      roi,
      paybackOrders,
      profitPerHour: totalPrintHours > 0 ? netProfit / totalPrintHours : 0,
      revenuePerHour: totalPrintHours > 0 ? totalRevenue / totalPrintHours : 0,
      avgOrderRevenue: completedOrdersCount > 0 ? totalRevenue / completedOrdersCount : 0,
      avgOrderProfit: completedOrdersCount > 0 ? netProfit / completedOrdersCount : 0,
      avgPrintHoursPerOrder: completedOrdersCount > 0 ? totalPrintHours / completedOrdersCount : 0,
      avgMaterialPerOrder: completedOrdersCount > 0 ? totalGrams / completedOrdersCount : 0,
      costPerKg: totalGrams > 0 ? totalCost / (totalGrams / 1000) : 0,
      netProfitPerKg: totalGrams > 0 ? netProfit / (totalGrams / 1000) : 0,
      avgCostPerGram: totalGrams > 0 ? totalCost / totalGrams : 0,
      avgRevenuePerGram: totalGrams > 0 ? totalRevenue / totalGrams : 0,
      printerUtilization: appData.printers.length > 0 ?
        (totalPrintHours / (appData.printers.length * 24 * 30)) * 100 : 0,
      costStructure: {
        material: totalCost > 0 ? (totalMaterialCost / totalCost) * 100 : 0,
        electricity: totalCost > 0 ? (totalElectricityCost / totalCost) * 100 : 0,
        operator: totalCost > 0 ? (totalOperatorExpenses / totalCost) * 100 : 0,
        services: totalCost > 0 ? (totalServiceCost / totalCost) * 100 : 0,
        shipping: totalCost > 0 ? (totalShippingCost / totalCost) * 100 : 0,
        additional: totalCost > 0 ? (totalAdditionalCost / totalCost) * 100 : 0,
        amortization: totalCost > 0 ? (totalPrinterCost / totalCost) * 100 : 0,
        maintenance: totalCost > 0 ? (totalMaintenanceCost / totalCost) * 100 : 0
      },
      totalMaterialCost,
      totalGrams,
      ebitda,
      breakEvenRevenue,
      revenueGap,
      profitabilityIndex,
      depreciationRate
    };
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML
  const generateHTML = (capital, ordersAnalysis, kpis) => {
    const {
      completedOrdersCount,
      totalRevenue,
      totalTax,
      totalCost,
      totalOperatorExpenses,
      totalServiceCost,
      totalElectricityCost,
      totalMaterialCost,
      totalShippingCost,
      totalAdditionalCost,
      totalPrinterCost,
      totalMaintenanceCost,
      totalRejectHours,
      totalRejectGrams,
      materialStats,
      printerStats,
      clientStats
    } = ordersAnalysis;

    const {
      grossProfit,
      netProfit,
      netMargin,
      grossMargin,
      roi,
      paybackOrders,
      profitPerHour,
      revenuePerHour,
      avgOrderRevenue,
      avgOrderProfit,
      avgPrintHoursPerOrder,
      avgMaterialPerOrder,
      costPerKg,
      netProfitPerKg,
      avgCostPerGram,
      avgRevenuePerGram,
      printerUtilization,
      costStructure,
      ebitda,
      breakEvenRevenue,
      revenueGap,
      profitabilityIndex,
      depreciationRate
    } = kpis;

    const paybackAbs = netProfit - capital.total;

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∞–±–ª–∏—Ü
    const materialRows = Object.values(materialStats).map(m => `
      <tr>
        <td>${m.name}</td>
        <td class="text-end">${formatNumber(m.totalGrams / 1000, 3)} –∫–≥</td>
        <td class="text-end">${formatCurrency(m.totalCost)}</td>
        <td class="text-end">${m.totalGrams > 0 ?
          formatCurrency(m.totalCost / (m.totalGrams / 1000)) : '0.00'} ‚ÇΩ/–∫–≥</td>
      </tr>
    `).join('');

    const printerRows = Object.values(printerStats).map(p => {
      const expenses = p.amortization + p.energy + p.material + p.maintenance;
      const profit = p.revenue - expenses;
      return `
      <tr>
        <td>${p.name}</td>
        <td class="text-end">${formatNumber(p.hours, 1)} —á</td>
        <td class="text-end">${formatCurrency(p.revenue)}</td>
        <td class="text-end">${formatCurrency(expenses)}</td>
        <td class="text-end ${profit >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(profit)}</td>
        <td class="text-end">${p.prints}</td>
      </tr>`;
    }).join('');

    const totalPrinterRevenue = Object.values(printerStats).reduce((sum, p) => sum + p.revenue, 0);
    const totalPrinterExpenses = Object.values(printerStats).reduce((sum, p) => sum + p.amortization + p.energy + p.material + p.maintenance, 0);
    const totalPrinterProfit = totalPrinterRevenue - totalPrinterExpenses;
    const totalPrinterPrints = Object.values(printerStats).reduce((sum, p) => sum + p.prints, 0);

    const clientRows = Object.values(clientStats).map(c => {
      const profit = c.revenue - c.cost;
      return `
      <tr>
        <td>${c.name}</td>
        <td class="text-end">${formatCurrency(c.revenue)}</td>
        <td class="text-end">${formatCurrency(c.cost)}</td>
        <td class="text-end ${profit >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(profit)}</td>
        <td class="text-end">${c.orders}</td>
      </tr>`;
    }).join('');
    const totalClientRevenue = Object.values(clientStats).reduce((sum, c) => sum + c.revenue, 0);
    const totalClientCost = Object.values(clientStats).reduce((sum, c) => sum + c.cost, 0);
    const totalClientProfit = totalClientRevenue - totalClientCost;
    const totalClientOrders = Object.values(clientStats).reduce((sum, c) => sum + c.orders, 0);

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ KPI
    const kpiCards = [
      {title: 'ROI', value: roi, unit: '%', desc: '(–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –ö–∞–ø–∏—Ç–∞–ª)', icon: 'bi-piggy-bank'},
      {title: '–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å', value: paybackOrders, unit: '–∑–∞–∫–∞–∑–æ–≤', desc: '–ó–∞–∫–∞–∑—ã –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤–ª–æ–∂–µ–Ω–∏–π', icon: 'bi-arrow-repeat'},
      {title: '–ß–∏—Å—Ç–∞—è –º–∞—Ä–∂–∞', value: netMargin, unit: '%', desc: '(–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –í—ã—Ä—É—á–∫–∞)', icon: 'bi-graph-up'},
      {title: '–í–∞–ª–æ–≤–∞—è –º–∞—Ä–∂–∞', value: grossMargin, unit: '%', desc: '(–í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å / –í—ã—Ä—É—á–∫–∞)', icon: 'bi-graph-up-arrow'},
      {title: '–í—ã—Ä—É—á–∫–∞ –≤ —á–∞—Å', value: revenuePerHour, unit: '‚ÇΩ/—á', desc: '(–í—ã—Ä—É—á–∫–∞ / –ß–∞—Å—ã –ø–µ—á–∞—Ç–∏)', icon: 'bi-speedometer'},
      {title: '–ü—Ä–∏–±—ã–ª—å –≤ —á–∞—Å', value: profitPerHour, unit: '‚ÇΩ/—á', desc: '(–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –ß–∞—Å—ã –ø–µ—á–∞—Ç–∏)', icon: 'bi-speedometer2'},
      {title: '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫', value: avgOrderRevenue, unit: '‚ÇΩ', desc: '(–í—ã—Ä—É—á–∫–∞ / –ó–∞–∫–∞–∑—ã)', icon: 'bi-receipt'},
      {title: '–ü—Ä–∏–±—ã–ª—å / –∑–∞–∫–∞–∑', value: avgOrderProfit, unit: '‚ÇΩ', desc: '(–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –ó–∞–∫–∞–∑—ã)', icon: 'bi-box-seam'},
      {title: '–ß–∞—Å–æ–≤ –Ω–∞ –∑–∞–∫–∞–∑', value: avgPrintHoursPerOrder, unit: '—á', desc: '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø–µ—á–∞—Ç–∏', icon: 'bi-clock'},
      {title: '–ú–∞—Ç–µ—Ä–∏–∞–ª / –∑–∞–∫–∞–∑', value: avgMaterialPerOrder / 1000, unit: '–∫–≥', desc: '–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥', icon: 'bi-bezier', decimals: 3},
      {title: '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–≥', value: costPerKg, unit: '‚ÇΩ/–∫–≥', desc: '(–ó–∞—Ç—Ä–∞—Ç—ã / –ú–∞—Ç–µ—Ä–∏–∞–ª—ã)', icon: 'bi-printer'},
      {title: '–ü—Ä–∏–±—ã–ª—å / –∫–≥', value: netProfitPerKg, unit: '‚ÇΩ/–∫–≥', desc: '(–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å / –ú–∞—Ç–µ—Ä–∏–∞–ª—ã)', icon: 'bi-box'},
      {title: '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å / –≥', value: avgCostPerGram, unit: '‚ÇΩ/–≥', desc: '(–ó–∞—Ç—Ä–∞—Ç—ã / –ú–∞—Ç–µ—Ä–∏–∞–ª—ã)', icon: 'bi-currency-ruble', decimals: 2},
      {title: '–í—ã—Ä—É—á–∫–∞ / –≥', value: avgRevenuePerGram, unit: '‚ÇΩ/–≥', desc: '(–í—ã—Ä—É—á–∫–∞ / –ú–∞—Ç–µ—Ä–∏–∞–ª—ã)', icon: 'bi-cash-stack', decimals: 2},
      {title: '–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', value: printerUtilization, unit: '%', desc: '(–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ / –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª)', icon: 'bi-cpu'},
      {title: '–ò–Ω–¥–µ–∫—Å –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏', value: profitabilityIndex, unit: '', desc: '(–ü—Ä–∏–±—ã–ª—å + –í–ª–æ–∂–µ–Ω–∏—è) / –í–ª–æ–∂–µ–Ω–∏—è', icon: 'bi-clipboard-data', decimals: 2},
      {title: '–ë—Ä–∞–∫ (—á)', value: totalRejectHours, unit: '—á', desc: '–í—Ä–µ–º—è –±—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π', icon: 'bi-x-circle'},
      {title: '–ë—Ä–∞–∫ (–∫–≥)', value: totalRejectGrams / 1000, unit: '–∫–≥', desc: '–í–µ—Å –±—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π', icon: 'bi-exclamation-triangle', decimals: 3}
    ].map(card => `
      <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100 shadow-sm">
          <div class="card-body p-3">
            <div class="d-flex align-items-center">
              <i class="bi ${card.icon} fs-3 text-primary me-3"></i>
              <div>
                <h5 class="mb-0">${formatNumber(card.value, card.decimals ?? 1)}${card.unit}</h5>
                <small class="text-muted">${card.title}</small>
              </div>
            </div>
            <div class="mt-2 text-muted small">${card.desc}</div>
          </div>
        </div>
      </div>
    `).join('');

    return `
    <div class="container-fluid p-0">
      <!-- –ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>–ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <h6>–ü—Ä–∏–Ω—Ç–µ—Ä—ã:</h6>
              <p>–í—Å–µ–≥–æ: ${appData.printers.length} —à—Ç</p>
              <p>–°—É–º–º–∞: <strong>${formatCurrency(capital.printersCost)}</strong></p>
            </div>
            <div class="col-md-4">
              <h6>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</h6>
              <p class="mb-1">–°—É–º–º–∞: <strong>${formatCurrency(capital.materialsCost)}</strong></p>
              <p class="mb-1">–í–µ—Å: <strong>${formatNumber(capital.materialsWeight, 2)} –∫–≥</strong></p>
            </div>
            <div class="col-md-4">
              <h6>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</h6>
              <p class="mb-1">–°—É–º–º–∞: <strong>${formatCurrency(capital.additionalCost)}</strong></p>
            </div>
          </div>
          <div class="alert alert-primary mt-3 mb-0">
            <div class="d-flex justify-content-between align-items-center">
              <span>–û–±—â–∏–µ –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è:</span>
              <strong class="fs-5">${formatCurrency(capital.total)}</strong>
            </div>
          </div>
        </div>
      </div>
      
      <!-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏. 
            <a href="https://github.com/nazbav/3d-price/issues/1" class="alert-link">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –∑–¥–µ—Å—å</a>
          </div>
          
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</h6>
                <h3 class="text-center">${completedOrdersCount}</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</h6>
                <h3 class="text-center text-success">${formatCurrency(totalRevenue)}</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</h6>
                <h3 class="text-center text-danger">${formatCurrency(totalCost)}</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</h6>
                <h3 class="text-center ${netProfit >= 0 ? 'text-success' : 'text-danger'}">
                  ${formatCurrency(netProfit)}
                </h3>
          </div>
        </div>
      </div>

          <div class="row mb-4">
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>EBITDA</h6>
                <h3 class="text-center">${formatCurrency(ebitda)}</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–ë–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å</h6>
                <h3 class="text-center">${formatCurrency(breakEvenRevenue)}</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–î–µ–ª—å—Ç–∞ –¥–æ –±–µ–∑—É–±.</h6>
                <h3 class="text-center ${revenueGap <= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(revenueGap)}</h3>
              </div>
            </div>
            <div class="col-md-3">
              <div class="border p-3 rounded">
                <h6>–ò–∑–Ω–æ—Å –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤</h6>
                <h3 class="text-center">${formatNumber(depreciationRate,1)}%</h3>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-body">
                  <h6>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤</h6>
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</span>
                      <span>${formatCurrency(totalMaterialCost)} (${formatNumber(costStructure.material,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ:</span>
                      <span>${formatCurrency(totalElectricityCost)} (${formatNumber(costStructure.electricity,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–û–ø–µ—Ä–∞—Ç–æ—Ä:</span>
                      <span>${formatCurrency(totalOperatorExpenses)} (${formatNumber(costStructure.operator,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–£—Å–ª—É–≥–∏:</span>
                      <span>${formatCurrency(totalServiceCost)} (${formatNumber(costStructure.services,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                      <span>${formatCurrency(totalShippingCost)} (${formatNumber(costStructure.shipping,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã:</span>
                      <span>${formatCurrency(totalAdditionalCost)} (${formatNumber(costStructure.additional,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è:</span>
                      <span>${formatCurrency(totalPrinterCost)} (${formatNumber(costStructure.amortization,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ:</span>
                      <span>${formatCurrency(totalMaintenanceCost)} (${formatNumber(costStructure.maintenance,1)}%)</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–ù–∞–ª–æ–≥–∏:</span>
                      <span>${formatCurrency(totalTax)}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å (–ø—Ä–∏–±—ã–ª—å - –≤–ª–æ–∂–µ–Ω–∏—è):</span>
                      <span class="${paybackAbs >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(paybackAbs)}</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h6>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h6>
                  <div class="progress mb-2" style="height: 25px">
                    <div class="progress-bar" role="progressbar"
                         style="width: ${Math.min(100, netMargin)}%"
                         aria-valuenow="${netMargin}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                      –ß–∏—Å—Ç–∞—è –º–∞—Ä–∂–∞: ${formatNumber(netMargin, 1)}%
                    </div>
                  </div>
                  <div class="progress mb-2" style="height: 25px">
                    <div class="progress-bar bg-success" role="progressbar"
                         style="width: ${Math.min(100, grossMargin)}%"
                         aria-valuenow="${grossMargin}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                      –í–∞–ª–æ–≤–∞—è –º–∞—Ä–∂–∞: ${formatNumber(grossMargin, 1)}%
                    </div>
                  </div>
                  <div class="progress" style="height: 25px">
                    <div class="progress-bar bg-info" role="progressbar"
                         style="width: ${Math.min(100, printerUtilization)}%"
                         aria-valuenow="${printerUtilization}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                      –ó–∞–≥—Ä—É–∑–∫–∞: ${formatNumber(printerUtilization, 1)}%
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-boxes me-2"></i>–†–∞—Å—Ö–æ–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="">
                    <tr>
                      <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                      <th class="text-end">–†–∞—Å—Ö–æ–¥</th>
                      <th class="text-end">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                      <th class="text-end">‚ÇΩ/–∫–≥</th>
                    </tr>
                  </thead>
                  <tbody>${materialRows}</tbody>
                  <tfoot class="">
                    <tr>
                      <th>–ò—Ç–æ–≥–æ</th>
                      <th class="text-end">${formatNumber(kpis.totalGrams / 1000, 3)} –∫–≥</th>
                      <th class="text-end">${formatCurrency(kpis.totalMaterialCost)}</th>
                      <th class="text-end">${kpis.totalGrams > 0 ? 
                        formatCurrency(kpis.totalMaterialCost / (kpis.totalGrams / 1000)) : '0.00'} ‚ÇΩ/–∫–≥</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-printer me-2"></i>–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="">
                    <tr>
                      <th>–ü—Ä–∏–Ω—Ç–µ—Ä</th>
                      <th class="text-end">–í—Ä–µ–º—è</th>
                      <th class="text-end">–î–æ—Ö–æ–¥</th>
                      <th class="text-end">–†–∞—Å—Ö–æ–¥—ã</th>
                      <th class="text-end">–ü—Ä–∏–±—ã–ª—å</th>
                      <th class="text-end">–ú–æ–¥–µ–ª–µ–π</th>
                    </tr>
                  </thead>
                  <tbody>${printerRows}</tbody>
                  <tfoot class="">
                    <tr>
                      <th>–ò—Ç–æ–≥–æ</th>
                      <th class="text-end">${formatNumber(ordersAnalysis.totalPrintHours, 1)} —á</th>
                      <th class="text-end">${formatCurrency(totalPrinterRevenue)}</th>
                      <th class="text-end">${formatCurrency(totalPrinterExpenses)}</th>
                      <th class="text-end">${formatCurrency(totalPrinterProfit)}</th>
                      <th class="text-end">${totalPrinterPrints}</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-people me-2"></i>–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º</h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="">
                    <tr>
                      <th>–ö–ª–∏–µ–Ω—Ç</th>
                      <th class="text-end">–í—ã—Ä—É—á–∫–∞</th>
                      <th class="text-end">–†–∞—Å—Ö–æ–¥—ã</th>
                      <th class="text-end">–ü—Ä–∏–±—ã–ª—å</th>
                      <th class="text-end">–ó–∞–∫–∞–∑—ã</th>
                    </tr>
                  </thead>
                  <tbody>${clientRows}</tbody>
                  <tfoot class="">
                    <tr>
                      <th>–ò—Ç–æ–≥–æ</th>
                      <th class="text-end">${formatCurrency(totalClientRevenue)}</th>
                      <th class="text-end">${formatCurrency(totalClientCost)}</th>
                      <th class="text-end">${formatCurrency(totalClientProfit)}</th>
                      <th class="text-end">${totalClientOrders}</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-bar-chart"></i> –¶–µ–Ω–∞ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º (‚ÇΩ/–≥)</h6>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <select id="materialChartGroup" class="form-select form-select-sm w-auto me-2">
                  <option value="material">–ú–∞—Ç–µ—Ä–∏–∞–ª</option>
                  <option value="type">–¢–∏–ø –ø–ª–∞—Å—Ç–∏–∫–∞</option>
                  <option value="typeManuf">–¢–∏–ø+–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</option>
                  <option value="printer">–ü—Ä–∏–Ω—Ç–µ—Ä</option>
                </select>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="materialPriceMode">
                  <label class="form-check-label" for="materialPriceMode">–ü–æ –∑–∞–∫–∞–∑–∞–º</label>
                </div>
              </div>
              <canvas id="materialPriceChart"></canvas>
              <div id="materialPriceStats" class="mt-2 small text-muted"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-bar-chart"></i> –¶–µ–Ω–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º (‚ÇΩ/–≥)</h6>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <select id="clientChartGroup" class="form-select form-select-sm w-auto me-2">
                  <option value="client">–ö–ª–∏–µ–Ω—Ç</option>
                  <option value="material">–ú–∞—Ç–µ—Ä–∏–∞–ª</option>
                  <option value="type">–¢–∏–ø –ø–ª–∞—Å—Ç–∏–∫–∞</option>
                  <option value="typeManuf">–¢–∏–ø+–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</option>
                  <option value="printer">–ü—Ä–∏–Ω—Ç–µ—Ä</option>
                </select>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="clientPriceMode">
                  <label class="form-check-label" for="clientPriceMode">–ü–æ –∑–∞–∫–∞–∑–∞–º</label>
                </div>
              </div>
              <canvas id="clientPriceChart"></canvas>
              <div id="clientPriceStats" class="mt-2 small text-muted"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI -->
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h5>
        </div>
        <div class="card-body">
          <div class="row">
            ${kpiCards}
          </div>
        </div>
      </div>
    </div>`;
  };

  const renderSummaryCharts = (ordersAnalysis) => {
    const matCanvas = document.getElementById('materialPriceChart');
    const clientCanvas = document.getElementById('clientPriceChart');

    const groupSelect = document.getElementById('materialChartGroup');
    const modeSwitch = document.getElementById('materialPriceMode');
    const clientGroupSelect = document.getElementById('clientChartGroup');
    const clientModeSwitch = document.getElementById('clientPriceMode');
    const matStatsDiv = document.getElementById('materialPriceStats');
    const clientStatsDiv = document.getElementById('clientPriceStats');
    if (!matCanvas || !clientCanvas) return;

    const calcStats = (arr) => {
      const sorted = arr.slice().sort((a, b) => a - b);
      const n = sorted.length;
      if (!n) return { min: 0, max: 0, avg: 0, median: 0 };
      const sum = sorted.reduce((a, b) => a + b, 0);
      const avg = sum / n;
      const median = n % 2 ? sorted[(n - 1) / 2] : (sorted[n / 2 - 1] + sorted[n / 2]) / 2;
      return { min: sorted[0], max: sorted[n - 1], avg, median };
    };

    const renderStats = (el, arr) => {
      if (!el) return;
      const { min, max, avg, median } = calcStats(arr);
      el.textContent = `–º–∏–Ω: ${min.toFixed(2)}, –º–µ–¥–∏–∞–Ω–∞: ${median.toFixed(2)}, —Å—Ä–µ–¥–Ω–µ–µ: ${avg.toFixed(2)}, –º–∞–∫—Å: ${max.toFixed(2)}`;
    };

    const buildMatData = (group) => {
      const useRevenue = modeSwitch.checked;
      if (group === 'type') {
        const map = {};
        Object.values(ordersAnalysis.materialStats).forEach(m => {
          const key = m.type || 'N/A';
          if (!map[key]) map[key] = { grams: 0, cost: 0, revenue: 0 };
          map[key].grams += m.totalGrams;
          map[key].cost += m.totalCost;
          map[key].revenue += m.totalRevenue || 0;
        });
        const labels = Object.keys(map);
        const data = labels.map(k => {
          const entry = map[k];
          const value = useRevenue ? entry.revenue : entry.cost;
          return entry.grams > 0 ? value / entry.grams : 0;
        });
        return { labels, data };
      } else if (group === 'typeManuf') {
        const map = {};
        Object.values(ordersAnalysis.materialStats).forEach(m => {
          const key = `${m.type || 'N/A'} | ${m.manufacturer || 'N/A'}`;
          if (!map[key]) map[key] = { grams: 0, cost: 0, revenue: 0 };
          map[key].grams += m.totalGrams;
          map[key].cost += m.totalCost;
          map[key].revenue += m.totalRevenue || 0;
        });
        const labels = Object.keys(map);
        const data = labels.map(k => {
          const entry = map[k];
          const value = useRevenue ? entry.revenue : entry.cost;
          return entry.grams > 0 ? value / entry.grams : 0;
        });
        return { labels, data };
      } else if (group === 'printer') {
        const labels = Object.values(ordersAnalysis.printerStats).map(p => p.name);
        const data = Object.values(ordersAnalysis.printerStats).map(p => {
          const cost = p.material + p.amortization + p.energy + p.maintenance;
          const value = useRevenue ? p.revenue : cost;
          return p.grams > 0 ? value / p.grams : 0;
        });
        return { labels, data };
      }
      const labels = Object.values(ordersAnalysis.materialStats).map(m => m.name);
      const data = Object.values(ordersAnalysis.materialStats).map(m => {
        const value = useRevenue ? (m.totalRevenue || 0) : m.totalCost;
        return m.totalGrams > 0 ? value / m.totalGrams : 0;
      });
      return { labels, data };
    };

    const updateMaterialChart = () => {
      const group = groupSelect.value;
      const { labels, data } = buildMatData(group);
      if (window.materialChart) window.materialChart.destroy();
      window.materialChart = new Chart(matCanvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: '‚ÇΩ/–≥',
            data,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
      renderStats(matStatsDiv, data);
    };
    const buildClientData = (group) => {
      const useRevenue = clientModeSwitch.checked;
      if (group === 'client') {
        const labels = Object.values(ordersAnalysis.clientStats).map(c => c.name);
        const data = Object.values(ordersAnalysis.clientStats).map(c => {
          const value = useRevenue ? c.revenue : c.cost;
          return c.grams > 0 ? value / c.grams : 0;
        });
        return { labels, data };
      } else if (group === 'type') {
        const map = {};
        Object.values(ordersAnalysis.materialStats).forEach(m => {
          const key = m.type || 'N/A';
          if (!map[key]) map[key] = { grams: 0, cost: 0, revenue: 0 };
          map[key].grams += m.totalGrams;
          map[key].cost += m.totalCost;
          map[key].revenue += m.totalRevenue || 0;
        });
        const labels = Object.keys(map);
        const data = labels.map(k => {
          const entry = map[k];
          const value = useRevenue ? entry.revenue : entry.cost;
          return entry.grams > 0 ? value / entry.grams : 0;
        });
        return { labels, data };
      } else if (group === 'typeManuf') {
        const map = {};
        Object.values(ordersAnalysis.materialStats).forEach(m => {
          const key = `${m.type || 'N/A'} | ${m.manufacturer || 'N/A'}`;
          if (!map[key]) map[key] = { grams: 0, cost: 0, revenue: 0 };
          map[key].grams += m.totalGrams;
          map[key].cost += m.totalCost;
          map[key].revenue += m.totalRevenue || 0;
        });
        const labels = Object.keys(map);
        const data = labels.map(k => {
          const entry = map[k];
          const value = useRevenue ? entry.revenue : entry.cost;
          return entry.grams > 0 ? value / entry.grams : 0;
        });
        return { labels, data };
      } else if (group === 'printer') {
        const labels = Object.values(ordersAnalysis.printerStats).map(p => p.name);
        const data = Object.values(ordersAnalysis.printerStats).map(p => {
          const cost = p.material + p.amortization + p.energy + p.maintenance;
          const value = useRevenue ? p.revenue : cost;
          return p.grams > 0 ? value / p.grams : 0;
        });
        return { labels, data };
      }
      const labels = Object.values(ordersAnalysis.materialStats).map(m => m.name);
      const data = Object.values(ordersAnalysis.materialStats).map(m => {
        const value = useRevenue ? (m.totalRevenue || 0) : m.totalCost;
        return m.totalGrams > 0 ? value / m.totalGrams : 0;
      });
      return { labels, data };
    };

    const updateClientChart = () => {
      const group = clientGroupSelect.value;
      const { labels, data } = buildClientData(group);
      if (window.clientChart) window.clientChart.destroy();
      window.clientChart = new Chart(clientCanvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: '‚ÇΩ/–≥',
            data,
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
      renderStats(clientStatsDiv, data);
    };

    groupSelect.addEventListener('change', updateMaterialChart);
    modeSwitch.addEventListener('change', updateMaterialChart);
    clientGroupSelect.addEventListener('change', updateClientChart);
    clientModeSwitch.addEventListener('change', updateClientChart);
    updateMaterialChart();
    updateClientChart();
  };

  // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–æ–≤
  const capital = calculateCapitalInvestments();
  const ordersAnalysis = analyzeCompletedOrders(from, to);
  const kpis = calculateKPIs(capital, ordersAnalysis);

  // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  const summaryContent = document.getElementById("summaryContent");
  summaryContent.innerHTML = generateHTML(capital, ordersAnalysis, kpis);
  renderSummaryCharts(ordersAnalysis);
}

function parseIncomingLinkParams(params){
  const prName = params.get('printer');
  if(!prName) return;
  const statuses = params.getAll('model_status[]');
  const names = params.getAll('model_name[]');
  const ids = params.getAll('model_id[]');
  const thumbs = params.getAll('model_thumbnail[]');
  const times = params.getAll('model_time[]');
  const weights = params.getAll('model_weight[]');
  const mats = params.getAll('model_filament[]');
  const models = [];
  for(let i=0;i<names.length;i++){
    models.push({
      id: ids[i] || getNextId('models'),
      name: names[i] || '',
      thumbnail: thumbs[i] || '',
      status: statuses[i] || 'new',
      timeStr: times[i] || '',
      weight: weights[i] || '',
      matName: mats[i] || ''
    });
  }
  incomingLinkData = {printerKey: prName, models};
  showIncomingDataModal();
}

async function resolvePrinterForLink(key){
  const list = appData.printers.filter(p=>{
    if(p.name===key) return true;
    return (p.profileIds||[]).some(pid=>{
      const pf=appData.printerProfiles.find(x=>String(x.id)===String(pid));
      return pf && pf.config && pf.config.printer_settings_id===key;
    });
  });
  if(list.length===1) return list[0];
  if(list.length>1){
    const options=list.map(p=>({value:String(p.id),label:p.name}));
    const res=await showMultiPrompt('–ü—Ä–∏–Ω—Ç–µ—Ä –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è '+key,[{id:'pid',label:'–ü—Ä–∏–Ω—Ç–µ—Ä',type:'select',options}]);
    if(res && res.pid){
      return list.find(p=>String(p.id)===res.pid) || null;
    }
  }
  return null;
}

function showIncomingDataModal(){
  const sel = document.getElementById('targetOrderSelect');
  sel.innerHTML = '<option value="new">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</option>';
  appData.calcHistory.forEach(h=>{
    const opt = document.createElement('option');
    opt.value = h.timestamp;
    opt.textContent = h.calcName || h.dateStr;
    sel.appendChild(opt);
  });
  const modal = new bootstrap.Modal(document.getElementById('incomingDataModal'));
  document.getElementById('importLinkApplyBtn').onclick = applyIncomingData;
  modal.show();
}

async function applyIncomingData(){
  const sel = document.getElementById('targetOrderSelect');
  const val = sel.value;
  const modalEl = document.getElementById('incomingDataModal');
  const modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();
  if(val !== 'new'){
    onEditCalcHistory(parseInt(val,10));
  } else {
    document.getElementById('calcName').value = '';
    document.getElementById('calcClientName').value = '';
    document.getElementById('calcOrderStatus').value = 'new';
    appData.printers.forEach(pr=>{
      const tb = document.querySelector(`#calcModelsTable_${pr.id} tbody`);
      if(tb) tb.innerHTML='';
    });
  }
  if(incomingLinkData){
    const pr = await resolvePrinterForLink(incomingLinkData.printerKey);
    if(!pr){
      alert('–ù–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏–Ω—Ç–µ—Ä '+incomingLinkData.printerKey);
    } else {
      for(const m of incomingLinkData.models){
        const mid = await resolveMaterialIdByProfile(m.matName);
        addModelRow(pr.id, {
          id: m.id,
          name: m.name,
          thumbnail: m.thumbnail,
          status: m.status,
          hours: parseTimeFromLink(m.timeStr),
          weight: parseFloat(m.weight)||0,
          materialId: mid
        });
      }
    }
  }
  const tabEl = document.querySelector('#calculate-tab');
  const tab = new bootstrap.Tab(tabEl);
  tab.show();
  incomingLinkData = null;
}

</script>



<!-- Supabase & QR -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const SUPABASE_URL = "https://kvvxfytrlgihewmsvwkj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2dnhmeXRybGdpaGV3bXN2d2tqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5NDExMzIsImV4cCI6MjA2MTUxNzEzMn0.bvXmrh3XZivLVyg4irGo82pLAhlrSapzmxcDKLEAjLo";

const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // ‚úÖ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

let syncId = localStorage.getItem("sync_id") || crypto.randomUUID();
let encryptionKey = localStorage.getItem("encryption_key") || crypto.randomUUID() + crypto.randomUUID();
localStorage.setItem("sync_id", syncId);
localStorage.setItem("encryption_key", encryptionKey);

async function encryptData(data, key) {
  const text = JSON.stringify(data);
  const enc = new TextEncoder().encode(text);
  const cryptoKey = await crypto.subtle.importKey("raw", new TextEncoder().encode(key.slice(0, 32)), "AES-GCM", false, ["encrypt"]);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const cipher = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, enc);
  return btoa(JSON.stringify({ iv: Array.from(iv), data: Array.from(new Uint8Array(cipher)) }));
}

async function decryptData(encrypted, key) {
  const parsed = JSON.parse(atob(encrypted));
  const iv = new Uint8Array(parsed.iv);
  const data = new Uint8Array(parsed.data);
  const cryptoKey = await crypto.subtle.importKey("raw", new TextEncoder().encode(key.slice(0, 32)), "AES-GCM", false, ["decrypt"]);
  const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, cryptoKey, data);
  return JSON.parse(new TextDecoder().decode(decrypted));
}

async function saveSettingsToCloud() {
  const encrypted = await encryptData(appData, encryptionKey);
  const { error } = await _supabase
    .from('user_settings')
    .upsert({
      sync_id: syncId,
      encrypted_data: encrypted,
      updated_at: new Date().toISOString()
    }, { onConflict: 'sync_id' });

  if (error) alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + error.message);
  else alert("‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ.");
}

async function loadSettingsFromCloud() {
  const { data, error } = await _supabase
    .from('user_settings')
    .select('*')
    .eq('sync_id', syncId)
    .single();

  if (error || !data) {
    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + error?.message);
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
  const createdAt = new Date(data.created_at);
  const now = new Date();
  if ((now - createdAt) > 5 * 60 * 1000) { // 5 –º–∏–Ω—É—Ç
    alert("–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã");
    await _supabase.from('user_settings').delete().eq('sync_id', syncId);
    return;
  }

  try {
    const decrypted = await decryptData(data.encrypted_data, encryptionKey);
    appData = decrypted;
    saveToLocalStorage();
    initAll();
    alert("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
  } catch (e) {
    alert("–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏.");
  }
}

function generateSyncLinkAndQR() {
  const url = new URL(window.location.href);
  url.searchParams.set("sync_id", syncId);
  url.searchParams.set("key", encryptionKey);
  const link = url.toString();
  document.getElementById("syncLinkDisplay").value = link;
  const qrcodeDiv = document.getElementById("qrcode");
  qrcodeDiv.innerHTML = "";
  new QRCode(qrcodeDiv, {
    text: link,
    width: 256,
    height: 256,
    colorDark: "#000000",
    colorLight: "#ffffff"
  });
}

document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(window.location.search);
  const incomingId = params.get("sync_id");
  const incomingKey = params.get("key");

  if (incomingId && incomingKey) {
    localStorage.setItem("sync_id", incomingId);
    localStorage.setItem("encryption_key", incomingKey);
    syncId = incomingId;
    encryptionKey = incomingKey;
    await loadSettingsFromCloud();
  }
  document.getElementById('delOrcaProfileBtn').onclick = ()=>deleteOrcaProfile();
  document.getElementById('orcaProfileSelect').addEventListener('change',e=>{
    const pr=appData.printers.find(p=>String(p.id)===String(currentOrcaPrinterId));
    if(pr) loadOrcaProfile(pr,parseInt(e.target.value,10));
  });
  document.getElementById('saveMaterialBtn').onclick = saveMaterialFromModal;
  document.getElementById('savePrinterBtn').onclick = savePrinterFromModal;
  const jsonBtn = document.getElementById('downloadJsonFileBtn');
  if (jsonBtn) jsonBtn.addEventListener('click', downloadJsonFile);
  const allLabelsBtn = document.getElementById('downloadAllLabelsBtn');
  if (allLabelsBtn) allLabelsBtn.addEventListener('click', downloadAllThermoLabelsHtml);
  const summaryBtn = document.getElementById('downloadSummaryCardBtn');
  if (summaryBtn) summaryBtn.addEventListener('click', downloadSummaryCardHtml);
  const myNalogBtn = document.getElementById('sendMyNalogBtn');
  if (myNalogBtn) myNalogBtn.addEventListener('click', sendMyNalogReceipt);
  const myNalogBillBtn = document.getElementById('sendMyNalogBillBtn');
  if (myNalogBillBtn) myNalogBillBtn.addEventListener('click', sendMyNalogBill);
  const myNalogCancelBtn = document.getElementById('cancelMyNalogBtn');
  if (myNalogCancelBtn) myNalogCancelBtn.addEventListener('click', cancelMyNalogReceipt);
  const phoneInput = document.getElementById('myNalogPhone');
  if (phoneInput) {
    phoneInput.addEventListener('change', e => {
      localStorage.setItem('my_nalog_phone', e.target.value.trim());
    });
  }
  const requestSmsBtn = document.getElementById('requestSmsBtn');
  if (requestSmsBtn) requestSmsBtn.addEventListener('click', requestMyNalogSms);
  const confirmSmsBtn = document.getElementById('confirmSmsBtn');
  if (confirmSmsBtn) confirmSmsBtn.addEventListener('click', confirmMyNalogSms);
  const importFileInput = document.getElementById('importJsonFile');
  if (importFileInput) importFileInput.addEventListener('change', importFromFile);
  const applyLinkBtn=document.getElementById("applyMaterialProfileLinkBtn");
  if(applyLinkBtn) applyLinkBtn.onclick = applyMaterialProfileLink;
  const manageProfilesBtn=document.getElementById("manageMaterialProfilesBtn");
  if(manageProfilesBtn) manageProfilesBtn.onclick = openMaterialProfilesManager;
  const managePrProfilesBtn=document.getElementById("managePrinterProfilesBtn");
  if(managePrProfilesBtn) managePrProfilesBtn.onclick = openPrinterProfilesManager;
  loadMyNalogSettings();

  // document.getElementById('orcaPrinterFileInput').addEventListener('change',(e)=>{
  //   importPrinterJson(e.target.files[0]);
  //   e.target.value='';
  // });
  parseIncomingLinkParams(params);
  if(params.toString()){
    window.history.replaceState({}, document.title, window.location.pathname);
  }
  setupGcodeDrop();
});


const SPOOLMAN_CONFIG_KEY = "spoolman_config";

// Configuration management
function getSpoolmanConfig() {
  const configStr = localStorage.getItem(SPOOLMAN_CONFIG_KEY);
  if (!configStr) return { enabled: false, url: '', autoSync: false, lastSync: null };
  try {
    return JSON.parse(configStr);
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Spoolman –∏–∑ localStorage:", e);
    return { enabled: false, url: '', autoSync: false, lastSync: null };
  }
}

function saveSpoolmanConfig(config) {
  localStorage.setItem(SPOOLMAN_CONFIG_KEY, JSON.stringify(config));
  // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  populateSpoolmanUIFromConfig();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ UI –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
function populateSpoolmanUIFromConfig() {
  const cfg = getSpoolmanConfig();
  const cbEnabled = document.getElementById("spoolmanEnabledCheckbox");
  const inpUrl = document.getElementById("spoolmanUrlInput");
  const cbAuto = document.getElementById("spoolmanAutoSyncCheckbox");
  const lastSync = document.getElementById("spoolmanLastSync");

  if (cbEnabled) cbEnabled.checked = !!cfg.enabled;
  if (inpUrl) inpUrl.value = cfg.url || "";
  if (cbAuto) cbAuto.checked = !!cfg.autoSync;
  if (lastSync) {
    lastSync.textContent = cfg.lastSync
      ? new Date(cfg.lastSync).toLocaleString()
      : "–ù–∏–∫–æ–≥–¥–∞";
  }
}

// API interaction
async function spoolmanApiRequest(endpoint, method = 'GET', body = null) {
  const config = getSpoolmanConfig();
  if (!config.enabled || !config.url) {
    throw new Error('Spoolman is not configured');
  }

  const baseUrl = config.url.endsWith('/') ? config.url.slice(0, -1) : config.url;
  const url = `${baseUrl}/api/v1/${endpoint}`;

  const options = {
    method,
    headers: { 'Content-Type': 'application/json' }
  };

  if (body) {
    options.body = JSON.stringify(body);
  }

  try {
    console.log(`Sending ${method} request to ${url}`, body || '');
    const response = await fetch(url, options);
    if (!response.ok) {
      const errorText = await response.text();
      console.error(`API error response:`, errorText);
      throw new Error(`API error (${response.status}): ${errorText}`);
    }

    if (response.status === 204) return null; // No content

    const responseData = await response.json();
    console.log(`Response from ${endpoint}:`, responseData);
    return responseData;
  } catch (error) {
    console.error('Spoolman API error:', error);
    throw error;
  }
}

// Get all filaments from Spoolman
async function fetchSpoolmanFilaments() {
  return await spoolmanApiRequest('filament');
}

// Get all spools from Spoolman
async function fetchSpoolmanSpools() {
  return await spoolmanApiRequest('spool');
}

function prepareExtraForSpoolman(extra) {
  const prepared = {};
  for (const [key, value] of Object.entries(extra)) {
    // Convert value to JSON string
    prepared[key] = JSON.stringify(value);
  }
  return prepared;
}
	
function mapSpoolmanToMaterial(spool, filament) {
  // Parse extra fields properly
  let extraFields = {};
  if (spool.extra) {
    for (const [key, value] of Object.entries(spool.extra)) {
      try {
        // First, try to parse the value as JSON
        if (typeof value === 'string') {
          // Handle double-quoted strings like "\"value\""
          if (value.startsWith('"') && value.endsWith('"')) {
            // Remove the outer quotes and parse
            extraFields[key] = JSON.parse(value);
          } else {
            // Direct value or already parsed JSON
            extraFields[key] = value;
          }
        } else {
          extraFields[key] = value;
        }
      } catch (e) {
        console.log(`Error parsing extra field ${key}:`, e);
        extraFields[key] = value; // Keep as is if parsing fails
      }
    }
  }

  return {
    id: getNextId('materials'),
    materialType: filament.material || '', // –ù–æ–≤–æ–µ –ø–æ–ª–µ
    name:  filament.vendor?.name+'- '+filament.name || spool.comment || `${filament.material || 'Unknown'} (${spool.id})`,
    costPerKg: spool.price || 0,
    balance: spool.remaining_weight ? spool.remaining_weight / 1000 : 0, // Convert g to kg
    declaredWeight: spool.initial_weight ? spool.initial_weight / 1000 :
            (filament.weight ? filament.weight / 1000 : 1), // Convert g to kg
    manufacturer: filament.vendor?.name ,
    productionDate: spool.lot_nr || '',
    printers: [],
    profileIds: [],
    color: filament.color_hex || '#ffffff',
    spoolmanId: filament.id,
    spoolmanSpoolId: spool.id
  };
}


// Import all materials from Spoolman - PRIMARY SYNC METHOD
async function importAllMaterialsFromSpoolman(statusCallback) {
  const config = getSpoolmanConfig();
  if (!config.enabled || !config.url) {
    return { success: false, message: 'Spoolman is not configured' };
  }

  try {
    statusCallback('Connecting to Spoolman...');
    // Test connection
    await spoolmanApiRequest('info');

    statusCallback('Fetching data from Spoolman...');
    const filaments = await fetchSpoolmanFilaments();
    const spools = await fetchSpoolmanSpools();

    // Create mapping of filament IDs to filaments
    const filamentMap = {};
    filaments.forEach(filament => {
      filamentMap[filament.id] = filament;
    });

    // Map to our material format and add to app data
    const importedMaterials = [];
    const updatedMaterials = [];
    const errors = [];

    // Only import non-archived spools
    const activeSpools = spools.filter(spool => !spool.archived);

    statusCallback(`Processing ${activeSpools.length} spools...`);

    // Track existing materials by their Spoolman IDs to avoid duplicates
    const existingBySpoolmanId = {};
    appData.materials.forEach(material => {
      if (material.spoolmanSpoolId) {
        existingBySpoolmanId[material.spoolmanSpoolId] = material;
      }
    });

    for (const spool of activeSpools) {
      try {
        // Make sure we have a valid filament
        if (!spool.filament) {
          errors.push(`Spool ${spool.id} has no valid filament reference`);
          continue;
        }

        const filament = filamentMap[spool.filament.id];
        if (!filament) {
          errors.push(`Spool ${spool.id} references unknown filament ID ${spool.filament.id}`);
          continue;
        }

        // Check if we already have this material
        const existingMaterial = existingBySpoolmanId[spool.id];

        if (existingMaterial) {
          // Update existing material with fresh data from Spoolman
          const updatedData = mapSpoolmanToMaterial(spool, filament);

          // Preserve local-only fields
          updatedData.id = existingMaterial.id;
          updatedData.printers = existingMaterial.printers || [];
          updatedData.profileIds = existingMaterial.profileIds || [];

          // Update the existing material
          Object.assign(existingMaterial, updatedData);
          updatedMaterials.push(existingMaterial);
        } else {
          // Create new material from Spoolman data
          const material = mapSpoolmanToMaterial(spool, filament);
          appData.materials.push(material);
          importedMaterials.push(material);
          existingBySpoolmanId[spool.id] = material;
        }

      } catch (error) {
        console.error(`Error importing spool ${spool.id}:`, error);
        errors.push(`Spool ${spool.id}: ${error.message}`);
      }
    }

    saveToLocalStorage();
    renderGlobalMaterialsTable();

    config.lastSync = new Date().toISOString();
    saveSpoolmanConfig(config);

    const totalProcessed = importedMaterials.length + updatedMaterials.length;
    return {
      success: true,
      message: `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${totalProcessed} –∫–∞—Ç—É—à–µ–∫ –∏–∑ Spoolman (${importedMaterials.length} –Ω–æ–≤—ã—Ö, ${updatedMaterials.length} –æ–±–Ω–æ–≤–ª–µ–Ω–æ)`,
      materials: importedMaterials,
      updated: updatedMaterials,
      errors: errors.length ? errors : null
    };
  } catch (error) {
    console.error('Import error:', error);
    return { success: false, message: `–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${error.message}` };
  }
}

// Update spool usage in Spoolman when material is used in the calculator
async function updateSpoolUsageInSpoolman(materialId, usedWeight) {
  const material = appData.materials.find(m => String(m.id) === String(materialId));
  if (!material || !material.spoolmanSpoolId) {
    console.log(`Material ${materialId} not linked to Spoolman, skipping usage update`);
    return;
  }

  try {
    console.log(`Updating Spoolman spool ${material.spoolmanSpoolId} with used weight: ${usedWeight}kg`);
    await spoolmanApiRequest(`spool/${material.spoolmanSpoolId}/use`, 'PUT', {
      use_weight: usedWeight * 1000 // Convert kg to g for Spoolman API
    });

    // Update local material balance
    material.balance -= usedWeight;
    if (material.balance < 0) material.balance = 0;

    saveToLocalStorage();
    console.log(`Successfully updated usage for spool ${material.spoolmanSpoolId}`);
  } catch (error) {
    console.error('Failed to update spool usage in Spoolman:', error);
    // Continue without stopping execution - we've already updated local data
  }
}

// Test Spoolman connection
async function testSpoolmanConnection(url) {
  try {
    const baseUrl = url.endsWith('/') ? url.slice(0, -1) : url;
    const response = await fetch(`${baseUrl}/api/v1/info`);

    if (!response.ok) {
      throw new Error(`Server returned ${response.status}`);
    }

    const data = await response.json();
    return {
      success: true,
      version: data.version || 'Unknown',
      message: `Connected to Spoolman ${data.version || 'Unknown'}`
    };
  } catch (error) {
    return { success: false, message: `Connection failed: ${error.message}` };
  }
}

// Hook into material usage tracking
function hookMaterialUsage() {
  const originalCalculateAll = window.onCalculateAll;
  window.onCalculateAll = function() {
    // Call original function
    const result = originalCalculateAll.apply(this, arguments);

    // Track material usage if Spoolman integration is enabled
    const config = getSpoolmanConfig();
    if (config.enabled && config.autoSync && lastCalcFullData) {
      // Look through all printer details and find material usage
      const materialUsage = {};

      lastCalcFullData.detailsByPrinter.forEach(printer => {
        printer.linesDetail.forEach(model => {
          if (model.materialData && model.materialData.id) {
            const materialId = model.materialData.id;
            const usedWeight = (model.realWeight || 0) / 1000; // Convert g to kg

            if (!materialUsage[materialId]) materialUsage[materialId] = 0;
            materialUsage[materialId] += usedWeight;
          }
        });
      });

      // Update Spoolman for each material
      Object.keys(materialUsage).forEach(materialId => {
        updateSpoolUsageInSpoolman(materialId, materialUsage[materialId]);
      });
    }

    return result;
  };
}

// UI Functions
function createSpoolmanSettingsUI() {
  const config = getSpoolmanConfig();

  return `
    <div class="mt-4">
    <h3>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ Spoolman</h3>
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i>
      <strong>–ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥:</strong> Spoolman —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞—Ç—É—à–∫–∞—Ö. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–º–ø–æ—Ä—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Spoolman –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.
    </div>

    <div class="alert alert-warning">
      <h5><i class="bi bi-exclamation-triangle-fill"></i> –í–∞–∂–Ω–æ: –û–±—Ö–æ–¥ CORS –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ Spoolman</h5>
      <p>–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–æ–∫–∞–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º Spoolman –≤–∞–º –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –æ–±–æ–π—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è CORS. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:</p>
      <ol>
        <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ <a href="https://chromewebstore.google.com/detail/cors-unblock/lfhmikememgdcahcdlaciloancbhjino" target="_blank">CORS Unblock</a> –¥–ª—è Chrome</li>
        <li>–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤–∫–ª—é—á–∏—Ç–µ <em>Access-Control-Request-Headers</em></li>
        <li>–í–∫–ª—é—á–∏—Ç–µ –æ–ø—Ü–∏—é <em>Overwrite 4xx status codes with 200</em></li>
        <li>–ù–∞–∂–º–∏—Ç–µ ¬´Start¬ª</li>
      </ol>
      <p><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ —ç—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω—É–∂–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API Spoolman.</p>
    </div>

    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="spoolmanEnabledCheckbox">
      <label class="form-check-label" for="spoolmanEnabledCheckbox">–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Spoolman</label>
    </div>
    <div class="mb-3">
      <label for="spoolmanUrlInput" class="form-label">URL —Å–µ—Ä–≤–µ—Ä–∞ Spoolman:</label>
      <div class="input-group">
        <input type="text" id="spoolmanUrlInput" class="form-control" placeholder="http://localhost:7912">
        <button class="btn btn-outline-secondary" type="button" id="testSpoolmanConnectionBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      </div>
      <div class="form-text">–ü—Ä–∏–º–µ—Ä—ã: http://localhost:7912 –∏–ª–∏ https://127.0.0.1:7912</div>
    </div>
    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="spoolmanAutoSyncCheckbox">
      <label class="form-check-label" for="spoolmanAutoSyncCheckbox">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</label>
    </div>
    <div class="mb-3">
      <p>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: <span id="spoolmanLastSync">–ù–∏–∫–æ–≥–¥–∞</span></p>
    </div>
    <div id="spoolmanSyncStatus" class="alert alert-success" style="display: none; opacity: 1;"></div>
    <div class="mb-3">
      <button class="btn btn-primary" id="saveSpoolmanSettingsBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="btn btn-success" id="importFromSpoolmanBtn">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Spoolman</button>
      <button class="btn btn-warning" id="syncToSpoolmanBtn" style="display: none;">–≠–∫—Å–ø–æ—Ä—Ç (—É—Å—Ç–∞—Ä–µ–ª)</button>
      <button class="btn btn-danger" id="clearSpoolmanDuplicatesBtn">–û—á–∏—Å—Ç–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
      <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#instructionModal">
        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
      </button>
    </div>
  </div>
  <div class="modal fade" id="instructionModal" tabindex="-1" aria-labelledby="instructionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="instructionModalLabel">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ HTTPS –¥–ª—è Spoolman (–ª–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Ç—å)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
        <div class="modal-body">
          <ol>

           <li><strong>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Spoolman –Ω–∞ –≤–Ω–µ—à–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å Ubuntu –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏</strong> <a href="https://github.com/Donkie/Spoolman/wiki/Installation">https://github.com/Donkie/Spoolman/wiki/Installation</a></li>
   
            <li>
              <strong>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</strong><br>
              <pre><code>sudo mkdir -p /etc/ssl/spoolman
sudo openssl req -x509 -nodes -days 365 \
  -newkey rsa:2048 \
  -keyout /etc/ssl/spoolman/spoolman.key \
  -out /etc/ssl/spoolman/spoolman.crt \
  -subj "/CN=127.0.0.1" \
  -addext "subjectAltName=IP:127.0.0.1"

sudo chmod 600 /etc/ssl/spoolman/spoolman.key
sudo chmod 644 /etc/ssl/spoolman/spoolman.crt</code></pre><br/>
spoolman.crt –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ü–µ–Ω—Ç—Ä–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
            </li>
            <li>
              <strong>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx</strong><br>
              <pre><code>sudo apt update
sudo apt install -y nginx
sudo rm /etc/nginx/sites-enabled/default
sudo ln -s /etc/nginx/sites-available/spoolman /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx</code></pre>
            </li>
            <li>
              <strong>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx (HTTPS + CORS + PNA + proxy_pass)</strong><br>
              –°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª <code>/etc/nginx/sites-available/spoolman</code>:
              <pre><code>
server {
    listen 443 ssl;
    server_name 127.0.0.1;

    ssl_certificate     /etc/ssl/spoolman/spoolman.crt;
    ssl_certificate_key /etc/ssl/spoolman/spoolman.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_tickets off;

    location / {
        # –û–±—â–∏–µ CORS + –º–µ—Ç–æ–¥ PATCH
        add_header Access-Control-Allow-Origin         "https://nazbav.github.io" always;
        add_header Access-Control-Allow-Credentials    "true" always;
        add_header Access-Control-Allow-Private-Network "true" always;
        add_header Access-Control-Allow-Methods        "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers        "Origin, X-Requested-With, Content-Type, Accept" always;

        # Preflight OPTIONS
        if ($request_method = OPTIONS) {
            return 204;
        }

        proxy_pass         http://127.0.0.1:7912;
        proxy_http_version 1.1;
        proxy_set_header   Host            $host;
        proxy_set_header   X-Real-IP       $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
</code></pre> <br/>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
            </li>
            <li>
              <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞ (UFW)</strong><br>
              <pre><code>sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload</code></pre>
            </li>
            <li>
              <strong>–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞</strong><br>
              <pre><code>sudo systemctl restart Spoolman
sudo systemctl status Spoolman

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å HTTPS:
curl -vk https://127.0.0.1/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å preflight CORS/PNA:
curl -vk -X OPTIONS https://127.0.0.1/api/v1/info \
  -H "Origin: https://nazbav.github.io" \
  -H "Access-Control-Request-Method: GET" \
  -H "Access-Control-Request-Headers: Content-Type" \
  -H "Access-Control-Request-Private-Network: true"</code></pre>
              –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –±—É–¥–µ—Ç:
              <ul>
                <li><code>HTTP/1.1 204 No Content</code></li>
                <li><code>Access-Control-Allow-Private-Network: true</code></li>
              </ul>
            </li>
          </ol>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
  `;
}

// Set up event handlers
function setupSpoolmanUI() {
  document.getElementById('saveSpoolmanSettingsBtn').addEventListener('click', function() {
    const config = {
      enabled: document.getElementById('spoolmanEnabledCheckbox').checked,
      url: document.getElementById('spoolmanUrlInput').value.trim(),
      autoSync: document.getElementById('spoolmanAutoSyncCheckbox').checked,
      lastSync: getSpoolmanConfig().lastSync
    };

    saveSpoolmanConfig(config);
    showSpoolmanStatus('success', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
  });

  document.getElementById('testSpoolmanConnectionBtn').addEventListener('click', async function() {
    const url = document.getElementById('spoolmanUrlInput').value.trim();
    if (!url) {
      showSpoolmanStatus('danger', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å URL');
      return;
    }

    showSpoolmanStatus('info', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
    const result = await testSpoolmanConnection(url);
    if (result.success) {
      showSpoolmanStatus('success', result.message);
    } else {
      showSpoolmanStatus('danger', `${result.message}. –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å CORS Unblock.`);
    }
  });

  document.getElementById('importFromSpoolmanBtn').addEventListener('click', async function() {
    showSpoolmanStatus('info', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Spoolman...');
    this.disabled = true;

    const result = await importAllMaterialsFromSpoolman(msg => showSpoolmanStatus('info', msg));

    this.disabled = false;
    if (result.success) {
      showSpoolmanStatus('success', result.message);
      if (result.errors && result.errors.length > 0) {
        console.warn('Import completed with errors:', result.errors);
      }
    } else {
      showSpoolmanStatus('danger', result.message);
    }
  });

  // Keep the export button but show deprecation message
  document.getElementById('syncToSpoolmanBtn').addEventListener('click', async function() {
    const result = await syncAllMaterialsToSpoolman();
    showSpoolmanStatus('warning', result.message);
  });

  // Add button to clean up duplicates
  if (document.getElementById('clearSpoolmanDuplicatesBtn')) {
    document.getElementById('clearSpoolmanDuplicatesBtn').addEventListener('click', function() {
      clearSpoolmanDuplicates();
    });
  }
}

// Clean up duplicate materials that reference the same Spoolman spool
function clearSpoolmanDuplicates() {
  showSpoolmanStatus('info', '–ü–æ–∏—Å–∫ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤...');

  try {
    // Track materials by their Spoolman spool ID
    const materialsBySpoolmanId = {};
    const duplicates = [];

    // Group materials by Spoolman spool ID
    appData.materials.forEach(material => {
      if (material.spoolmanSpoolId) {
        const spoolId = material.spoolmanSpoolId;

        if (!materialsBySpoolmanId[spoolId]) {
          materialsBySpoolmanId[spoolId] = [];
        }

        materialsBySpoolmanId[spoolId].push(material);
      }
    });

    // Find duplicates (where multiple materials reference the same Spoolman spool)
    for (const [spoolId, materials] of Object.entries(materialsBySpoolmanId)) {
      if (materials.length > 1) {
        // Keep the first one, mark the rest for deletion
        console.log(`Found ${materials.length} materials referencing Spoolman spool ${spoolId}`);
        for (let i = 1; i < materials.length; i++) {
          duplicates.push(materials[i]);
        }
      }
    }

    // Remove duplicates from appData.materials
    if (duplicates.length > 0) {
      // Create a set of duplicate IDs for faster lookup
      const duplicateIds = new Set(duplicates.map(m => m.id));

      // Filter out duplicates
      appData.materials = appData.materials.filter(m => !duplicateIds.has(m.id));

      saveToLocalStorage();
      renderGlobalMaterialsTable();

      showSpoolmanStatus('success', `–£–¥–∞–ª–µ–Ω–æ ${duplicates.length} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.`);
    } else {
      showSpoolmanStatus('info', '–î—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.');
    }
  } catch (error) {
    console.error('Error cleaning up duplicates:', error);
    showSpoolmanStatus('danger', `–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${error.message}`);
  }
}

function showSpoolmanStatus(type, message) {
  const statusEl = document.getElementById('spoolmanSyncStatus');
  if (!statusEl) return;
  
  statusEl.className = `alert alert-${type}`;
  statusEl.style.display = 'block';
  statusEl.textContent = message;

  if (type === 'success' || type === 'info') {
    setTimeout(() => {
      statusEl.style.opacity = '0';
      setTimeout(() => {
        statusEl.style.display = 'none';
        statusEl.style.opacity = '1';
      }, 500);
    }, 5000);
  }
}

// Initialize Spoolman integration
function initSpoolmanIntegration() {
  // Create settings tab content for Spoolman
  const spoolmanTab = document.createElement('div');
  spoolmanTab.className = 'tab-pane fade';
  spoolmanTab.id = 'spoolmanPane';
  spoolmanTab.setAttribute('role', 'tabpanel');
  spoolmanTab.setAttribute('aria-labelledby', 'spoolman-tab');
  spoolmanTab.innerHTML = `
    <div class="mt-4">
      ${createSpoolmanSettingsUI()}
    </div>
  `;

  // Add tab content to main tab container
  const tabContent = document.getElementById('mainTabContent');
  if (tabContent) {
    tabContent.appendChild(spoolmanTab);
  }

  // Add tab navigation item
  const tabNav = document.getElementById('mainTab');
  if (tabNav) {
    const tabItem = document.createElement('li');
    tabItem.className = 'nav-item';
    tabItem.innerHTML = `
      <button class="nav-link" id="spoolman-tab" data-bs-toggle="tab"
              data-bs-target="#spoolmanPane" type="button" role="tab"
              aria-controls="spoolmanPane" aria-selected="false">
        Spoolman
      </button>
    `;
    tabNav.appendChild(tabItem);
  }

  saveToLocalStorage();

  // Hook into material usage tracking
  hookMaterialUsage();
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ localStorage
  setTimeout(() => {
    populateSpoolmanUIFromConfig();
  }, 200);
}

// Set up event listeners when document is ready
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    initSpoolmanIntegration();

    // Set up event handlers once the DOM is fully loaded with our new elements
    setTimeout(() => {
      setupSpoolmanUI();
    }, 500);
  }, 1000);


  console.log(appData);
});

document.getElementById('copyCheckLinkBtn').onclick = function() {
  const linkInput = document.getElementById('checkLinkInput');
  navigator.clipboard.writeText(linkInput.value);
};

</script>

</body>
</html>
