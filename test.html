<!DOCTYPE html>

<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
    <title>Калькулятор 3D-печати (TEST)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --app-navbar-bg: #f1f3f6;
            --app-navbar-border: rgba(15, 23, 42, 0.08);
        }

        [data-bs-theme="dark"] {
            --app-navbar-bg: #1F2533;
            --app-navbar-border: rgba(255, 255, 255, 0.12);
        }
        body { margin: 0; padding: 0; }

        .app-navbar {
            background: var(--app-navbar-bg);
            border: 1px solid var(--app-navbar-border);
            border-radius: 1rem;
            padding: 1rem 1.5rem;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }

        .app-navbar .navbar-brand {
            font-weight: 600;
            font-size: clamp(1.25rem, 2vw, 1.65rem);
            color: var(--bs-body-color);
        }

        .app-navbar .navbar-actions {
            gap: 0.75rem;
        }

        .app-panel {
            background: var(--app-navbar-bg);
            border: 1px solid var(--app-navbar-border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .container { margin-top: 20px; margin-bottom: 20px; }
        .nav-tabs .nav-link.active { font-weight: bold; }
        .small-text { font-size: 0.9rem; color: #555; }
        .footer { margin-top: 40px; font-size: 0.9rem; border-top: 1px solid var(--bs-border-color); padding-top: 10px; }
        table td, table th { vertical-align: middle; white-space: nowrap; }
        .history-client { font-size: 0.85rem; }
        .btn-group-sm > .btn { font-size: 0.8rem; padding: 2px 6px; margin-left: 2px; }
        thead th { background-color: var(--bs-table-bg) !important; color: var(--bs-body-color) !important; }
        [data-bs-theme="dark"] thead th { background-color: var(--bs-dark-bg-subtle) !important; color: var(--bs-light) !important; }
        @media (max-width: 576px) {
            .d-flex { flex-wrap: wrap !important; }
            .d-flex > * { margin-top: .5rem; }
        }
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            th, td {
                min-width: 100px;
            }
        }
        .form-select.form-select-sm { min-width: 120px; }

        #calcClientDropdownWrapper {
            position: relative;
        }

        #calcClientDropdownWrapper .dropdown-menu {
            width: 100%;
        }

        #calcClientDropdownMenu {
            max-height: 240px;
            overflow-y: auto;
        }
        .material-color-spool {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            margin-right: 8px;
            vertical-align: middle;
        }
        .material-color-spool svg {
            width: 40px;
            height: 40px;
            display: block;
        }
        .materials-profiles-col {
            display: none;
        }
        .material-color-spool .spool-body {
            fill: currentColor;
            stroke: rgba(0, 0, 0, 0.35);
            stroke-width: 0.8;
        }
        .material-color-spool .spool-hole {
            fill: var(--bs-body-bg, #ffffff);
            stroke: rgba(0, 0, 0, 0.35);
            stroke-width: 0.6;
        }
        /* Стили для этикетки */
        .label-preview { border: 1px solid #000; width: 30mm; height: 20mm; padding: 2mm; font-family: sans-serif; }

        .timeline-day-container {
            border-left: 4px solid rgba(0, 0, 0, 0.1);
            padding: 0.75rem;
            margin-bottom: 1.25rem;
            border-radius: 0.5rem;
            background-color: rgba(0, 0, 0, 0.015);
        }

        .timeline-day-current {
            border-left-color: var(--bs-primary);
            background-color: rgba(13, 110, 253, 0.05);
        }

        .timeline-day-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: capitalize;
        }

        .timeline-printer-row {
            background-color: rgba(0, 0, 0, 0.015);
            font-weight: 600;
        }

        .timeline-model-row {
            background-color: rgba(0, 0, 0, 0.01);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .timeline-model-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: none;
        }

        .timeline-model-id {
            font-size: 0.8rem;
            color: var(--bs-secondary-color);
            margin-left: 0.35rem;
            font-weight: normal;
        }

        .timeline-model-thumb {
            width: 28px;
            height: 28px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.12);
            background: #fff;
        }

        .timeline-slot-current {
            background-color: var(--bs-warning-bg-subtle) !important;
            color: var(--bs-warning-text-emphasis);
            font-weight: 600;
        }
        .timeline-break-row {
            background-color: rgba(255, 193, 7, 0.15);
            color: var(--bs-body-color);
            font-style: italic;
            border-left: 3px solid rgba(255, 193, 7, 0.6);
        }
        .timeline-break-row td {
            border-top: none !important;
        }

        .timeline-day-summary {
            margin-top: 0.5rem;
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 0.4rem;
            background-color: rgba(255, 193, 7, 0.25);
            font-weight: 600;
        }

        .calc-empty-placeholder {
            padding: 1rem;
            border: 1px dashed var(--bs-border-color);
            border-radius: 0.75rem;
            text-align: center;
            color: var(--bs-secondary-color);
            background-color: rgba(0, 0, 0, 0.02);
        }

        #calcPrintersContainer {
            position: relative;
            outline: 2px dashed transparent;
            border-radius: 1rem;
            transition: background-color 0.2s ease, outline-color 0.2s ease;
        }

        #calcPrintersContainer.calc-printers-drop-active {
            outline-color: var(--bs-primary);
            background-color: rgba(13, 110, 253, 0.08);
        }

        .mat-mass-mode-group {
            gap: 0.35rem;
        }

        .mat-mass-mode-group .btn {
            flex: 1 1 0;
        }

        .material-modal-body .form-label {
            margin-bottom: 0.2rem;
            font-weight: 600;
        }

        .material-modal-body .form-text {
            margin-top: 0.2rem;
            font-size: 0.75rem;
            line-height: 1.2;
        }

        .material-modal-body .mat-mass-block {
            border: 1px solid var(--bs-border-color);
            border-radius: 0.75rem;
            padding: 0.75rem;
            background-color: var(--bs-tertiary-bg);
        }

        @media (min-width: 576px) {
            .material-modal-body .mat-type-col {
                flex: 0 0 30%;
                max-width: 30%;
            }
            .material-modal-body .mat-name-col {
                flex: 0 0 70%;
                max-width: 70%;
            }
        }

        [data-bs-theme="dark"] .calc-empty-placeholder {
            border-color: rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.03);
            color: var(--bs-gray-400);
        }

        .schema-migration-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 1rem;
        }

        .schema-migration-overlay.show {
            display: flex;
        }

        .schema-migration-card {
            width: min(560px, 100%);
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 0.75rem 2rem rgba(0, 0, 0, 0.35);
        }

        .schema-migration-card h2 {
            font-size: 1.35rem;
            margin-bottom: 0.5rem;
        }

        .schema-migration-card ol {
            padding-left: 1.25rem;
        }

        .schema-migration-card li + li {
            margin-top: 0.75rem;
        }

        .schema-migration-card .status {
            font-size: 0.9rem;
        }

        [data-bs-theme="dark"] .timeline-day-container {
            border-left-color: rgba(255, 255, 255, 0.25);
            background-color: rgba(255, 255, 255, 0.05);
        }

        [data-bs-theme="dark"] .timeline-day-current {
            background-color: rgba(13, 110, 253, 0.18);
        }

        [data-bs-theme="dark"] .timeline-printer-row {
            background-color: rgba(255, 255, 255, 0.05);
        }

        [data-bs-theme="dark"] .timeline-model-row {
            background-color: rgba(255, 255, 255, 0.04);
        }

        [data-bs-theme="dark"] .timeline-model-title {
            color: var(--bs-body-color);
        }

        [data-bs-theme="dark"] .timeline-model-id {
            color: var(--bs-secondary-color);
        }

        [data-bs-theme="dark"] .timeline-model-thumb {
            border-color: rgba(255, 255, 255, 0.25);
            background: var(--bs-dark-bg-subtle);
        }

        [data-bs-theme="dark"] .timeline-slot-current {
            background-color: rgba(255, 193, 7, 0.45) !important;
            color: var(--bs-body-color);
        }

        [data-bs-theme="dark"] .timeline-day-summary {
            background-color: rgba(255, 193, 7, 0.28);
        }
        [data-bs-theme="dark"] .timeline-break-row {
            background-color: rgba(255, 193, 7, 0.22);
            border-left-color: rgba(255, 193, 7, 0.85);
            color: rgba(255,255,255,0.9);
        }

        /* Карточка итогов для клиента */
        .order-summary-card {
            max-width: 1200px;
            margin: 1rem auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-wrap: wrap;
        }
        .order-summary-card .order-info {
            flex: 1 1 300px;
            background: #f9fafb;
            padding: 1.5rem;
        }
        .order-summary-card .order-info h2 {
            font-size: 1.4rem;
            margin-bottom: 1rem;
            color: #4a90e2;
        }
        .order-summary-card .order-info .qr {
            text-align: center;
            margin-bottom: 1rem;
        }
        .order-summary-card .order-info .qr img {
            width: 120px;
            height: 120px;
        }
        .order-summary-card .info-item { margin-bottom: 0.5rem; font-size: 0.95rem; }
        .order-summary-card .info-item .label { font-weight: 600; color: #666; }
        .order-summary-card .info-item .value { margin-left: 0.5rem; font-weight: 500; }

        .order-summary-card .models { flex: 2 1 600px; padding: 1.5rem; }
        .models-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(369px, 1fr)); gap: 1rem; }
        .model-card { background: #fff; border-radius: 8px; padding: 1rem; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform .3s ease, box-shadow .3s ease; }
        .model-card:hover { transform: translateY(-4px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .model-card img { width: 48px; height: 48px; margin-bottom: 0.5rem; }
        .model-card h3 { font-size: 1rem; margin-bottom: 0.5rem; color: #4a90e2; }
        .model-card p { font-size: 0.9rem; margin: 0.25rem 0; color: #666; }
        .model-card p strong { color: #333; }

        @media (max-width: 800px) {
            .order-summary-card { flex-direction: column; }
            .order-summary-card .order-info, .order-summary-card .models { flex: 1 1 auto; }
        }

        .calc-layout {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        @media (min-width: 992px) {
            .calc-layout {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        .calc-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .calc-sidebar {
            width: 100%;
            max-width: 360px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .calc-card {
            background: var(--app-navbar-bg);
            border: 1px solid var(--app-navbar-border);
            border-radius: 1.25rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        [data-bs-theme="dark"] .calc-card {
            box-shadow: 0 18px 30px rgba(0, 0, 0, 0.55);
        }

        .calc-card-hero {
            background: radial-gradient(circle at top right, rgba(13, 110, 253, 0.35), transparent),
            linear-gradient(135deg, #101828, #1d3b7f);
            color: #fff;
            border: none;
            overflow: hidden;
        }

        .calc-card-hero .calc-hero-id {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.95rem;
        }

        .calc-card-hero #calcOrderIdHero {
            color: #fff;
            font-weight: 600;
        }

        .calc-card-hero .calc-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1.25rem;
        }

        .calc-card-hero .calc-meta-item {
            min-width: 140px;
            padding: 0.75rem 1rem;
            border-radius: 0.85rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .calc-card-hero .calc-meta-item span {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            opacity: 0.7;
            letter-spacing: 0.08em;
        }

        .calc-card-hero .calc-meta-item strong {
            font-size: 1.1rem;
        }

        .calc-section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            color: #5c6b8f;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        [data-bs-theme="dark"] .calc-section-title {
            color: rgba(255, 255, 255, 0.8);
        }

        .calc-section-title .icon {
            width: 30px;
            height: 30px;
            border-radius: 0.7rem;
            background: rgba(13, 110, 253, 0.12);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #0d6efd;
        }

        .calc-card table {
            margin-bottom: 0;
        }

        .calc-card-form {
            display: flex;
            flex-direction: column;
            gap: 1.1rem;
        }

        .calc-form-grid {
            display: grid;
            gap: 0.85rem;
        }

        @media (min-width: 992px) {
            .calc-form-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .calc-form-section {
            border: 1px dashed var(--app-navbar-border);
            border-radius: 1rem;
            padding: 0.9rem;
            background: rgba(255, 255, 255, 0.75);
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
            min-height: 100%;
        }

        [data-bs-theme="dark"] .calc-form-section {
            background: rgba(15, 23, 42, 0.35);
        }

        .calc-form-header {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .calc-form-subtitle {
            margin: 0;
            font-size: 0.85rem;
            color: rgba(15, 23, 42, 0.65);
        }

        [data-bs-theme="dark"] .calc-form-subtitle {
            color: rgba(255, 255, 255, 0.6);
        }

        .calc-field-grid {
            display: grid;
            gap: 0.75rem;
        }

        .calc-field-grid.cols-3 {
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        }

        .calc-field-grid.cols-4 {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }

        .calc-field-grid.cols-compact {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
        }

        .calc-form-section-compact {
            padding: 0.7rem;
        }

        .calc-form-section-compact .form-label {
            font-size: 0.85rem;
        }

        .calc-field-grid .form-text.small {
            margin-top: 0.1rem;
        }

        .calc-form-section-table .table {
            font-size: 0.85rem;
        }

        .calc-form-section-table .table thead th {
            white-space: nowrap;
        }

        .calc-sidebar-card {
            padding: 1.25rem 1.5rem;
            border-radius: 1.15rem;
            border: 1px solid var(--app-navbar-border);
            background: var(--bs-body-bg);
        }

        [data-bs-theme="dark"] .calc-sidebar-card {
            background: #111827;
        }

        .calc-summary-card {
            border-radius: 1.25rem;
            padding: 1.5rem;
            background: var(--bs-body-bg);
            border: 1px solid var(--app-navbar-border);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
            color: var(--bs-body-color);
        }

        [data-bs-theme="dark"] .calc-summary-card {
            background: #111827;
            box-shadow: 0 20px 36px rgba(0, 0, 0, 0.6);
        }

        .calc-summary-card h2 {
            font-weight: 700;
            font-size: 2rem;
            margin-bottom: 0.35rem;
        }

        .calc-summary-meta {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .calc-summary-meta div span {
            display: block;
            font-size: 0.7rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            opacity: 0.75;
        }

        .calc-summary-meta div strong {
            font-size: 1.15rem;
        }

        .calc-summary-meta div small {
            display: block;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .summary-table-compact .table {
            font-size: 0.86rem;
        }

        .summary-table-compact .table > :not(caption) > * > * {
            padding: 0.35rem 0.55rem;
        }

        .summary-table-compact .text-muted.small {
            font-size: 0.75rem;
        }

        .summary-table-compact .progress {
            height: 4px;
            margin-top: 0.35rem;
        }

        .summary-compact .card {
            border-radius: 1.15rem;
            background: var(--app-navbar-bg);
            border: 1px solid var(--app-navbar-border);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        [data-bs-theme="dark"] .summary-compact .card {
            box-shadow: 0 18px 30px rgba(0, 0, 0, 0.55);
        }

        .summary-compact .card-header {
            padding: 0.6rem 0.9rem;
            background: transparent;
            border-bottom: 1px solid var(--app-navbar-border);
        }

        .summary-compact .card-body {
            padding: 0.85rem;
        }

        .summary-compact .calc-card {
            padding: 1rem;
        }

        .summary-block {
            padding: 1rem;
        }

        .summary-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
            margin-bottom: 0.75rem;
        }

        .summary-header .calc-section-title {
            margin-bottom: 0;
        }

        .summary-badge {
            border: 1px solid var(--app-navbar-border);
            background: rgba(148, 163, 184, 0.12);
            color: var(--bs-body-color);
            font-weight: 600;
            font-size: 0.7rem;
        }

        [data-bs-theme="dark"] .summary-badge {
            background: rgba(15, 23, 42, 0.55);
        }

        .summary-table-wrap {
            border: 1px solid var(--app-navbar-border);
            border-radius: 0.9rem;
            overflow: hidden;
        }

        .summary-kpi-grid {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.9rem;
        }

        .summary-kpi-grid .calc-result-info {
            background: #ffffff;
            padding: 1.1rem 1.25rem;
            border-radius: 1rem;
        }

        [data-bs-theme="dark"] .summary-kpi-grid .calc-result-info {
            background: #111827;
        }

        .summary-kpi-grid .calc-result-info strong {
            font-size: 1.35rem;
        }

        .summary-kpi-grid .calc-result-info small {
            font-size: 0.8rem;
        }

        .summary-list-grid {
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.7rem;
        }

        .summary-list-grid .calc-result-info {
            padding: 0.7rem 0.85rem;
            background: #ffffff;
        }

        [data-bs-theme="dark"] .summary-list-grid .calc-result-info {
            background: #111827;
        }

        .summary-list-grid .calc-result-info strong {
            font-size: 1.05rem;
        }

        .summary-list-grid .calc-result-info small {
            font-size: 0.72rem;
        }

        .summary-structure .calc-structure-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.5rem;
        }

        .summary-structure .calc-structure-row {
            padding: 0.45rem 0.6rem;
        }

        .summary-top-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .summary-top-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.5rem 1rem;
            padding: 0.6rem 0.75rem;
            border-radius: 0.85rem;
            border: 1px solid var(--app-navbar-border);
            background: rgba(148, 163, 184, 0.08);
        }

        [data-bs-theme="dark"] .summary-top-item {
            background: rgba(15, 23, 42, 0.55);
        }

        .summary-top-title {
            font-weight: 600;
        }

        .summary-top-sub {
            font-size: 0.75rem;
            color: var(--bs-secondary-color, #6c757d);
        }

        .summary-top-values {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .summary-top-value {
            text-align: right;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .summary-top-label {
            font-size: 0.7rem;
            color: var(--bs-secondary-color, #6c757d);
        }

        .summary-driver-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.65rem;
        }

        .summary-driver-block {
            border: 1px solid var(--app-navbar-border);
            border-radius: 1rem;
            padding: 0.8rem;
            background: var(--app-navbar-bg);
        }

        .summary-driver-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 600;
            color: #5c6b8f;
            margin-bottom: 0.5rem;
        }

        [data-bs-theme="dark"] .summary-driver-title {
            color: rgba(255, 255, 255, 0.75);
        }

        .summary-sparkline {
            width: 100%;
            height: 90px;
        }

        .summary-bar-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .summary-bar-row {
            display: grid;
            grid-template-columns: 90px 1fr 50px;
            gap: 0.6rem;
            align-items: center;
        }

        .summary-bar-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--bs-secondary-color, #6c757d);
        }

        .summary-bar-track {
            height: 8px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.2);
            overflow: hidden;
        }

        .summary-bar-track span {
            display: block;
            height: 100%;
        }

        .summary-bar-value {
            text-align: right;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .summary-donut {
            position: relative;
            width: 150px;
            height: 150px;
        }

        .summary-donut svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .summary-donut-center {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            pointer-events: none;
        }

        .summary-donut-center .label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--bs-secondary-color, #6c757d);
        }

        .summary-donut-center .value {
            font-size: 1rem;
            font-weight: 700;
        }

        .summary-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .summary-chart-card {
            border: 1px solid var(--app-navbar-border);
            border-radius: 1rem;
            padding: 0.9rem;
            background: #ffffff;
        }

        [data-bs-theme="dark"] .summary-chart-card {
            background: #111827;
        }

        .summary-chart-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 600;
            color: #5c6b8f;
            margin-bottom: 0.6rem;
        }

        [data-bs-theme="dark"] .summary-chart-title {
            color: rgba(255, 255, 255, 0.75);
        }

        .summary-time-track {
            display: flex;
            height: 12px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.2);
        }

        .summary-time-track span {
            display: block;
            height: 100%;
        }

        .summary-time-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-top: 0.6rem;
            font-size: 0.75rem;
            color: var(--bs-secondary-color, #6c757d);
        }

        .summary-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            display: inline-block;
        }

        .summary-chart-tooltip {
            position: fixed;
            z-index: 3000;
            background: rgba(17, 24, 39, 0.92);
            color: #fff;
            padding: 0.4rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            pointer-events: none;
            transform: translate(-50%, -120%);
            opacity: 0;
            transition: opacity 0.08s ease;
        }

        .summary-chart-tooltip.visible {
            opacity: 1;
        }

        .summary-kpi-card {
            border: 1px dashed var(--app-navbar-border);
            border-radius: 0.9rem;
            padding: 0.65rem 0.75rem;
            background: rgba(255, 255, 255, 0.7);
        }

        [data-bs-theme="dark"] .summary-kpi-card {
            background: rgba(15, 23, 42, 0.45);
        }

        .summary-kpi-card .kpi-value {
            font-size: 1.05rem;
            font-weight: 700;
        }

        .summary-kpi-card .kpi-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--bs-secondary-color, #6c757d);
        }

        .summary-kpi-card .kpi-desc {
            font-size: 0.72rem;
            color: var(--bs-secondary-color, #6c757d);
        }

        .summary-capital-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.6rem;
        }

        .summary-capital-item {
            border-radius: 0.8rem;
            border: 1px solid var(--app-navbar-border);
            padding: 0.6rem 0.75rem;
            background: rgba(148, 163, 184, 0.12);
        }

        [data-bs-theme="dark"] .summary-capital-item {
            background: rgba(15, 23, 42, 0.55);
        }

        .summary-capital-title {
            font-size: 0.75rem;
            color: var(--bs-secondary-color, #6c757d);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .summary-capital-value {
            font-weight: 700;
            font-size: 1.05rem;
        }

        .summary-breakdown-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .summary-breakdown-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.4rem 0.75rem;
            align-items: center;
            padding: 0.5rem 0.65rem;
            border-radius: 0.8rem;
            border: 1px solid var(--app-navbar-border);
            background: rgba(148, 163, 184, 0.08);
        }

        .summary-breakdown-item .summary-mini-bar {
            grid-column: 1 / -1;
        }

        .summary-cell-stack {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .summary-mini-bar {
            width: 100%;
            height: 4px;
            background: rgba(13, 110, 253, 0.15);
            border-radius: 999px;
            overflow: hidden;
        }

        .summary-mini-bar > span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, rgba(13, 110, 253, 0.9), rgba(13, 110, 253, 0.45));
        }

        .summary-mini-label {
            font-size: 0.72rem;
            color: var(--bs-secondary-color, #6c757d);
        }

        .summary-header-badges .badge {
            font-weight: 600;
        }

        .summary-time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
        }

        .summary-time-item {
            padding: 0.6rem 0.75rem;
            border-radius: 0.85rem;
            border: 1px solid var(--app-navbar-border);
            background: rgba(148, 163, 184, 0.12);
        }

        [data-bs-theme="dark"] .summary-time-item {
            background: rgba(15, 23, 42, 0.55);
        }

        .summary-time-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--bs-secondary-color, #6c757d);
        }

        .summary-time-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .summary-time-meta {
            font-size: 0.8rem;
            color: var(--bs-secondary-color, #6c757d);
            margin-top: 0.4rem;
        }

        .calc-sidebar-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .calc-sidebar-actions .btn {
            width: 100%;
        }

        .calc-structure-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .calc-structure-chart {
            display: flex;
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid var(--app-navbar-border);
            min-height: 28px;
        }

        .calc-structure-segment {
            position: relative;
            min-width: 24px;
        }

        .calc-structure-segment::after {
            content: attr(data-label);
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #fff;
            font-weight: 600;
            opacity: 0.85;
        }

        .calc-structure-breakdown {
            display: flex;
            flex-direction: column;
            margin-top: 0.75rem;
            gap: 0.4rem;
        }

        .calc-structure-row {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.65rem;
            align-items: center;
            padding: 0.55rem 0.75rem;
            border-radius: 0.9rem;
            border: 1px solid var(--app-navbar-border);
            background: rgba(148, 163, 184, 0.12);
        }

        [data-bs-theme="dark"] .calc-structure-row {
            background: rgba(15, 23, 42, 0.55);
        }

        .calc-structure-row .label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calc-structure-row .meta {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .calc-structure-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .calc-params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .calc-param-tile {
            border-radius: 0.85rem;
            padding: 0.9rem;
            background: rgba(148, 163, 184, 0.15);
        }

        [data-bs-theme="dark"] .calc-param-tile {
            background: rgba(148, 163, 184, 0.15);
        }

        .calc-param-tile span {
            display: block;
            font-size: 0.75rem;
            opacity: 0.7;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .calc-param-tile strong {
            font-size: 1rem;
        }

        .calc-dates {
            margin-top: 1rem;
            border-top: 1px solid rgba(148, 163, 184, 0.3);
            padding-top: 1rem;
            font-size: 0.9rem;
        }

        .calc-dates div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.35rem;
            gap: 1rem;
        }

        .calc-dates span {
            font-weight: 600;
        }

        .calc-status-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.15);
        }

        .calc-result-panel {
            border: 1px dashed rgba(13, 110, 253, 0.35);
            background: rgba(13, 110, 253, 0.05);
            padding: 1.25rem;
            border-radius: 1rem;
        }

        [data-bs-theme="dark"] .calc-result-panel {
            background: rgba(13, 110, 253, 0.15);
        }

        .calc-alert {
            border-radius: 0.75rem;
            padding: 1rem;
            font-size: 0.9rem;
        }

        .calc-sidebar small {
            color: rgba(15, 23, 42, 0.7);
        }

        [data-bs-theme="dark"] .calc-sidebar small {
            color: rgba(255, 255, 255, 0.7);
        }

        .calc-result-section {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .calc-result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1rem;
        }

        .calc-result-card {
            border: 1px solid var(--app-navbar-border);
            border-radius: 1.25rem;
            background: var(--bs-body-bg);
            padding: 1.25rem;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            margin-top: 1rem;
        }

        [data-bs-theme="dark"] .calc-result-card {
            background: #111827;
            box-shadow: 0 18px 30px rgba(0, 0, 0, 0.55);
        }

        .calc-result-card-title {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 0.85rem;
            color: #5c6b8f;
        }

        [data-bs-theme="dark"] .calc-result-card-title {
            color: rgba(255, 255, 255, 0.75);
        }

        .calc-result-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .calc-result-info-grid.compact .calc-result-info {
            padding: 0.65rem 0.75rem;
            background: transparent;
        }

        .calc-result-info {
            border-radius: 0.9rem;
            background: var(--app-navbar-bg);
            border: 1px solid var(--app-navbar-border);
            padding: 0.9rem;
        }

        [data-bs-theme="dark"] .calc-result-info {
            background: #1c1f2b;
        }

        .calc-result-info span {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            opacity: 0.7;
        }

        .calc-result-info strong {
            display: block;
            font-size: 1.05rem;
        }

        .calc-result-info small {
            display: block;
            margin-top: 0.3rem;
            font-size: 0.75rem;
            opacity: 0.75;
        }

        .calc-result-printers-grid {
            gap: 1rem;
            display: flex;
            flex-direction: column;
        }

        .calc-result-printers-grid-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
        }

        @media (max-width: 992px) {
            .calc-result-printers-grid-row {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        .calc-printer-card {
            border: 1px solid var(--app-navbar-border);
            border-radius: 1.2rem;
            background: var(--app-navbar-bg);
            padding: 1rem;
            gap: 1rem;
        }

        [data-bs-theme="dark"] .calc-printer-card {
            background: #131722;
        }

        .calc-printer-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            gap: 1rem;
        }

        .calc-printer-title {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .calc-printer-meta {
            font-size: 0.8rem;
            color: rgba(15, 23, 42, 0.65);
        }

        [data-bs-theme="dark"] .calc-printer-meta {
            color: rgba(255, 255, 255, 0.6);
        }

        .calc-result-table {
            margin-top: 0.75rem;
        }

        .calc-result-table table {
            width: 100%;
            font-size: 0.85rem;
        }

        .calc-result-table th,
        .calc-result-table td {
            white-space: nowrap;
        }

        .calc-printer-model-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .calc-printer-model-list.limit-three {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        @media (max-width: 992px) {
            .calc-printer-model-list.limit-three {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
        }

        .calc-printer-model-card {
            border: 1px solid var(--app-navbar-border);
            border-radius: 1rem;
            padding: 0.85rem;
            background: var(--bs-body-bg);
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            box-shadow: 0 0.65rem 1.5rem rgba(15, 23, 42, 0.05);
        }

        [data-bs-theme="dark"] .calc-printer-model-card {
            background: rgba(15, 23, 42, 0.7);
            box-shadow: 0 0.65rem 1.5rem rgba(0, 0, 0, 0.5);
        }

        .calc-printer-card-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.85rem;
        }

        .calc-printer-head-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 0;
            flex: 1;
        }

        .calc-printer-head-text {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            min-width: 0;
        }

        .calc-printer-title-row {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            min-width: 0;
        }

        .calc-printer-status-row {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            flex-wrap: wrap;
        }

        .calc-printer-card-actions {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            flex-wrap: nowrap;
        }

        .calc-printer-card-total {
            font-weight: 700;
            font-size: 1rem;
            white-space: nowrap;
        }

        .calc-printer-avatar {
            width: 52px;
            height: 52px;
            border-radius: 0.9rem;
            background: rgba(13, 110, 253, 0.12);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #0d6efd;
            overflow: hidden;
            border: 1px solid rgba(13, 110, 253, 0.2);
            flex-shrink: 0;
            font-size: 1.25rem;
        }

        .calc-printer-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #fff;
        }

        @media (max-width: 576px) {
            .calc-printer-card-head {
                flex-direction: column;
                gap: 0.6rem;
            }

            .calc-printer-card-actions {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 0.4rem;
            }
        }

        .calc-printer-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            min-width: 0;
            margin-top: 0.1rem;
        }

        .calc-printer-info h5 {
            font-size: 0.88rem;
            margin: 0;
            color: rgba(15, 23, 42, 0.82);
        }

        [data-bs-theme="dark"] .calc-printer-info h5 {
            color: rgba(255, 255, 255, 0.9);
        }

        .calc-printer-status {
            font-size: 0.78rem;
            color: rgba(15, 23, 42, 0.6);
            white-space: nowrap;
        }

        [data-bs-theme="dark"] .calc-printer-status {
            color: rgba(255, 255, 255, 0.7);
        }

        .calc-printer-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.15rem;
        }

        .calc-printer-chip {
            font-size: 0.78rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.25);
            line-height: 1.1;
        }

        [data-bs-theme="dark"] .calc-printer-chip {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.12);
        }

        .calc-printer-cost-icons {
            display: flex;
            gap: 0.35rem;
        }

        .calc-cost-icon {
            width: 34px;
            height: 34px;
            border-radius: 0.65rem;
            background: rgba(148, 163, 184, 0.15);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        [data-bs-theme="dark"] .calc-cost-icon {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .calc-printer-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.35rem;
        }

        .calc-printer-id {
            font-size: 0.75rem;
            color: rgba(15, 23, 42, 0.65);
            padding: 0.15rem 0.55rem;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.2);
        }

        [data-bs-theme="dark"] .calc-printer-id {
            color: rgba(255, 255, 255, 0.75);
            background: rgba(255, 255, 255, 0.08);
        }

        .timeline-days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(849px, 1fr));
            gap: 1rem;
        }

        .calc-overhead-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(235px, 1fr));
            gap: 0.6rem;
        }

        .calc-overhead-card {
            border-radius: 0.8rem;
            border: 1px solid var(--app-navbar-border);
            padding: 0.7rem;
            background: var(--bs-body-bg);
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        [data-bs-theme="dark"] .calc-overhead-card {
            background: rgba(15, 23, 42, 0.7);
        }

        .calc-overhead-card-top {
            display: flex;
            justify-content: space-between;
            gap: 0.4rem;
            align-items: baseline;
        }

        .calc-overhead-card-info {
            flex: 1;
            min-width: 0;
        }

        .calc-overhead-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin: 0;
        }

        .calc-overhead-amount {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .calc-overhead-meta-row {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .calc-overhead-meta {
            flex: 1;
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: rgba(15, 23, 42, 0.65);
        }

        [data-bs-theme="dark"] .calc-overhead-meta {
            color: rgba(255, 255, 255, 0.65);
        }

        .calc-overhead-total {
            text-align: right;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .calc-result-alert {
            border-radius: 0.85rem;
            padding: 1rem;
        }
</style>
</head>
<body>
<script id="materialTypeCatalog" type="application/json">
{
  "customLabel": "Другое (вручную)",
  "groups": [
    {
      "label": "FDM / FFF",
      "items": [
        "PLA",
        "PLA+",
        "PETG",
        "ABS",
        "ASA",
        "TPU",
        "TPE",
        "HIPS",
        "PP",
        "PETT",
        "PCTG",
        "CPE",
        "CPE+"
      ]
    },
    {
      "label": "FDM / Инженерные",
      "items": [
        "PA (Nylon)",
        "PA6",
        "PA11",
        "PA12",
        "PC",
        "PC-ABS",
        "POM (Delrin)",
        "PMMA (Acrylic)",
        "PEI (Ultem)",
        "PPSU",
        "PSU",
        "PPS",
        "PEEK",
        "PEKK",
        "PVDF",
        "PBT"
      ]
    },
    {
      "label": "FDM / Поддержки и спец.",
      "items": [
        "PVA",
        "BVOH",
        "HIPS (Support)",
        "EVA"
      ]
    },
    {
      "label": "FDM / Композиты и наполнители",
      "items": [
        "PLA-CF",
        "PETG-CF",
        "ABS-CF",
        "ASA-CF",
        "PA-CF",
        "PC-CF",
        "PEEK-CF",
        "PP-CF",
        "PLA-GF",
        "PETG-GF",
        "PA-GF",
        "PC-GF",
        "PP-GF",
        "PA-Kevlar",
        "PLA-Wood",
        "PLA-Metal",
        "Ceramic-filled",
        "Stone-filled",
        "Glow-in-the-dark",
        "Conductive",
        "Magnetic"
      ]
    },
    {
      "label": "SLA / DLP / LCD (Resin)",
      "items": [
        "Resin Standard",
        "Resin ABS-like",
        "Resin Tough",
        "Resin Durable",
        "Resin Flexible",
        "Resin Elastic",
        "Resin Clear",
        "Resin High Temp",
        "Resin Castable",
        "Resin Dental",
        "Resin Biocompatible",
        "Resin Water-washable",
        "Resin Ceramic"
      ]
    }
  ]
}
</script>
<div class="schema-migration-overlay" id="schemaMigrationOverlay">
    <div class="schema-migration-card">
        <h2>Обновление формата данных</h2>
        <p>Сейчас мы переведём ваши сохранённые расчёты на новый формат. Для безопасности сначала скачайте резервную
            копию.</p>
        <ol>
            <li>
                <button class="btn btn-primary btn-sm" id="schemaMigrationBackupBtn">Скачать резервную копию</button>
                <div class="status mt-1 text-muted" id="schemaMigrationBackupStatus">Шаг 1: сохраните текущие данные.
                </div>
            </li>
            <li>
                <button class="btn btn-success btn-sm mt-2" disabled="" id="schemaMigrationStartBtn">Обновить данные
                </button>
                <div class="status mt-1 text-muted" id="schemaMigrationProgress"></div>
            </li>
        </ol>
        <div class="text-danger small mt-2" id="schemaMigrationError"></div>
    </div>
</div>
<div class="container-fluid">
    <div class="app-panel">
        <!-- ОДНА СТРОКА: табы слева (растягиваются), кнопки справа (по ширине) -->
        <div class="row align-items-center g-2">
            <!-- TABLIST -->
            <div class="col">
                <ul class="nav nav-tabs flex-nowrap" id="mainTab" role="tablist">
                    <li class="nav-item">
                        <button aria-controls="calculatePane" aria-selected="true" class="nav-link active"
                                data-bs-target="#calculatePane" data-bs-toggle="tab" id="calculate-tab" role="tab"
                                type="button">
                            Калькулятор
                        </button>
                    </li>
                    <li class="nav-item">
                        <button aria-controls="historyPane" aria-selected="false" class="nav-link"
                                data-bs-target="#historyPane" data-bs-toggle="tab" id="history-tab" role="tab"
                                type="button">
                            История
                        </button>
                    </li>
                    <li class="nav-item">
                        <button aria-controls="clientsPane" aria-selected="false" class="nav-link"
                                data-bs-target="#clientsPane" data-bs-toggle="tab" id="clients-tab" role="tab"
                                type="button">
                            Клиенты
                        </button>
                    </li>
                    <li class="nav-item">
                        <button aria-controls="printersPane" aria-selected="false" class="nav-link"
                                data-bs-target="#printersPane" data-bs-toggle="tab" id="printers-tab" role="tab"
                                type="button">
                            Принтеры
                        </button>
                    </li>
                    <li class="nav-item">
                        <button aria-controls="globalMaterialsPane" aria-selected="false" class="nav-link"
                                data-bs-target="#globalMaterialsPane" data-bs-toggle="tab" id="globalMaterials-tab"
                                role="tab" type="button">
                            Общие материалы
                        </button>
                    </li>
                    <li class="nav-item">
                        <button aria-controls="globalAdditionalPane" aria-selected="false" class="nav-link"
                                data-bs-target="#globalAdditionalPane" data-bs-toggle="tab" id="globalAdditional-tab"
                                role="tab" type="button">
                            Накладные расходы
                        </button>
                    </li>
                    <li class="nav-item d-none">
                        <button aria-controls="settingsPane" aria-selected="false" class="nav-link"
                                data-bs-target="#settingsPane" data-bs-toggle="tab" id="settings-tab" role="tab"
                                type="button">
                            Настройки
                        </button>
                    </li>
                    <li class="nav-item">
                        <button aria-controls="summaryPane" aria-selected="false" class="nav-link"
                                data-bs-target="#summaryPane" data-bs-toggle="tab" id="summary-tab" role="tab"
                                type="button">
                            Статистика
                        </button>
                    </li>
                </ul>
            </div>
            <!-- ACTIONS -->
            <div class="col-auto">
                <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                    <button class="btn btn-outline-primary d-flex align-items-center gap-1" onclick="openSettingsTab()">
                        <span>⚙️</span><span>Настройки</span>
                    </button>
                    <button class="btn btn-outline-secondary" id="themeToggle">🌙 Темная тема</button>
                </div>
            </div>
        </div>
        <div class="tab-content" id="mainTabContent">
            <!-- Принтеры -->
            <div aria-labelledby="printers-tab" class="tab-pane fade" id="printersPane" role="tabpanel">
                <div class="mt-4">
                    <h3>Список принтеров</h3>
                    <div class="mb-2">
                        <button class="btn btn-primary btn-sm" onclick="onAddPrinter()">Добавить принтер</button>
                        <button class="btn btn-danger btn-sm" onclick="massDelete('printers')">Массовое удаление
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="massEdit('printers')">Массовое изменение
                        </button>
                        <button class="btn btn-info btn-sm" id="managePrinterProfilesBtn">Профили принтеров</button>
                    </div>
                    <div class="table-responsive">
                        <input class="form-control form-control-sm mb-2"
                               oninput="filterTable('printersTable', this.value)" placeholder="Поиск..." type="text"/>
                        <table class="table table-bordered table-hover" id="printersTable">
                            <thead class="">
                            <tr>
                                <th><input id="selectAll_printers" onchange="selectAll(this, 'printers')"
                                           type="checkbox"/></th>
                                <th onclick="sortTable('printersTable',1)">ID</th>
                                <th onclick="sortTable('printersTable',2)">Название</th>
                                <th onclick="sortTable('printersTable',3)">Стоимость (₽)</th>
                                <th onclick="sortTable('printersTable',4)">Часы окуп.</th>
                                <th onclick="sortTable('printersTable',5)">Мощн. (Вт)</th>
                                <th onclick="sortTable('printersTable',6)">Обсл. (₽/ч)</th>
                                <th>Действия</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <hr/>
            </div>
            <!-- Общие материалы -->
            <div aria-labelledby="globalMaterials-tab" class="tab-pane fade" id="globalMaterialsPane" role="tabpanel">
                <div class="mt-4">
                    <h3>Общие материалы</h3>
                   <div class="mb-2">
                        <button class="btn btn-primary btn-sm" onclick="onAddGlobalMaterial()">Добавить материал
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="massDelete('globalMaterials')">Массовое
                            удаление
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="massEdit('globalMaterials')">Массовое
                            изменение
                        </button>
                        <button class="btn btn-info btn-sm" id="manageMaterialProfilesBtn">Профили Orca</button>
                    </div>
                    <div class="table-responsive">
                        <input class="form-control form-control-sm mb-2"
                               oninput="filterTable('materialsTable', this.value)" placeholder="Поиск..." type="text"/>
                        <table class="table table-bordered table-hover" id="materialsTable">
                            <thead class="">
                            <tr>
                                <th><input id="selectAll_globalMaterials" onchange="selectAll(this, 'globalMaterials')"
                                           type="checkbox"/></th>
                                <th onclick="sortTable('materialsTable',1)">Название</th>
                                <th onclick="sortTable('materialsTable',1)">Тип</th>
                                <th onclick="sortTable('materialsTable',2)">Стоим./кг</th>
                                <th onclick="sortTable('materialsTable',3)">Остаток (гр)</th>
                                <th onclick="sortTable('materialsTable',4)">Начальный вес (кг)</th>
                                <th onclick="sortTable('materialsTable',5)">Время остыв. (мин)</th>
                                <th onclick="sortTable('materialsTable',6)">Подготовка (мин)</th>
                                <th onclick="sortTable('materialsTable',7)">Производитель</th>
                                <th onclick="sortTable('materialsTable',8)">Дата произв.</th>
                                <th>Принтеры</th>
                                <th class="materials-profiles-col">Профили</th>
                                <th>Действия</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Накладные расходы -->
            <div aria-labelledby="globalAdditional-tab" class="tab-pane fade" id="globalAdditionalPane" role="tabpanel">
                <div class="mt-4">
                    <h3>Накладные расходы</h3>
                    <div class="mb-2">
                        <button class="btn btn-primary btn-sm" onclick="onAddGlobalAdditional()">Добавить расход
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="massDelete('globalAdditional')">Массовое
                            удаление
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="massEdit('globalAdditional')">Массовое
                            изменение
                        </button>
                    </div>
                    <div class="table-responsive">
                        <input class="form-control form-control-sm mb-2"
                               oninput="filterTable('additionalGlobalTable', this.value)" placeholder="Поиск..."
                               type="text"/>
                        <table class="table table-bordered table-hover" id="additionalGlobalTable">
                            <thead class="">
                            <tr>
                                <th><input id="selectAll_globalAdditional"
                                           onchange="selectAll(this, 'globalAdditional')" type="checkbox"/></th>
                                <th onclick="sortTable('additionalGlobalTable',1)">ID</th>
                                <th onclick="sortTable('additionalGlobalTable',2)">Описание</th>
                                <th onclick="sortTable('additionalGlobalTable',3)">Стоим. (₽)</th>
                                <th onclick="sortTable('additionalGlobalTable',4)">Часы окуп.</th>
                                <th onclick="sortTable('additionalGlobalTable',5)">Вкл. в расчёт?</th>
                                <th>Принтеры</th>
                                <th>Действия</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Калькулятор -->
            <div aria-labelledby="calculate-tab" class="tab-pane fade show active" id="calculatePane" role="tabpanel">
                <div class="calc-layout">
                    <div class="calc-main">
                        <div class="calc-card calc-card-hero">
                            <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
                                <div>
                                    <h3 class="mt-1">Расчёт стоимости заказа <span class="calc-hero-id">(ID: <span id="calcOrderIdHero">—</span>)</span></h3>
                                    <input id="calcOrderId" type="hidden">
                                    </input></div>
                                <div class="text-lg-end mt-1">
                                    <div class="calc-status-chip mb-2">
                                        <span class="text-uppercase small">Статус</span>
                                        <strong id="calcSummaryStatusSmall">—</strong>
                                    </div>
                                    <button class="btn btn-outline-light btn-sm" onclick="startNewCalculation()"
                                            type="button">Новый расчёт
                                    </button>
                                </div>
                            </div>
<!--                            <div class="calc-meta">-->
<!--                                <div class="calc-meta-item">-->
<!--                                    <span>Код заказа</span>-->
<!--                                    <strong id="calcOrderIdText">—</strong>-->
<!--                                </div>-->
<!--                                <div class="calc-meta-item">-->
<!--                                    <span>Клиент</span>-->
<!--                                    <strong id="calcSummaryClientHero">—</strong>-->
<!--                                </div>-->
<!--                                <div class="calc-meta-item">-->
<!--                                    <span>Срочность</span>-->
<!--                                    <strong id="calcSummaryUrgencyHero">—</strong>-->
<!--                </div>-->
<!--                                -->
<!--                            </div>-->
                        </div>
                        <div class="calc-card calc-card-form">
                            <div class="calc-form-header">
                                <div>
                                    <div class="calc-section-title mb-1">Параметры расчёта</div>
                                    <p class="calc-form-subtitle mb-0">Все ключевые поля собраны в две колонки, чтобы
                                        базовые настройки всегда были под рукой.</p>
                                </div>
                            </div>
                            <div class="calc-form-grid">
                                <div class="calc-form-section calc-form-section-compact">
                                    <div class="calc-section-title">
                                        <span class="icon">1</span>
                                        Основные данные
                                    </div>
                                    <div class="calc-field-grid cols-compact">
                                        <div>
                                            <label class="form-label" for="calcName">Название расчёта</label>
                                            <input class="form-control" id="calcName" placeholder="Например: Заказ 123"
                                                   type="text"/>
                                        </div>
                                        <div>
                                            <label class="form-label" for="calcClientName">Клиент (ФИО/компания)</label>
                                            <div class="dropdown w-100" id="calcClientDropdownWrapper">
                                                <div class="input-group">
                                                    <input autocomplete="off" class="form-control" id="calcClientName"
                                                           onfocus="onClientFieldFocus()" oninput="onCalcClientInput()"
                                                           onkeydown="onClientFieldKeydown(event)"
                                                           placeholder="Иванов Иван" type="text"/>
                                                </div>
                                                <div class="dropdown-menu w-100 p-0" id="calcClientDropdownMenu"></div>
                                            </div>
                                            <div class="form-text small">Enter — добавить клиента, ↓↑ — выбрать из
                                                истории.
                                            </div>
                        </div>
                                        <div>
                                            <label class="form-label" for="calcOrderStatus">Статус заказа</label>
                                            <select class="form-select" id="calcOrderStatus"
                                                    onchange="toggleFinalFields(this.value)">
                                                <option value="new">Новый</option>
                                                <option value="inprogress">В работе</option>
                                                <option value="done">Завершён</option>
                                                <option value="paid">Оплачен</option>
                                                <option value="canceled">Отменён</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="calc-form-section">
                                    <div class="calc-section-title">
                                        <span class="icon">2</span>
                                        Финансовые параметры
                    </div>
                                    <div class="calc-field-grid cols-4">
                                        <div>
                                            <label class="form-label" for="calcMarkupPercent">Наценка (%)</label>
                                            <input class="form-control" id="calcMarkupPercent" step="1" type="number"/>
                                        </div>
                                        <div>
                                            <label class="form-label" for="calcDiscountPercent">Скидка (%)</label>
                                            <input class="form-control" id="calcDiscountPercent" step="1"
                                                   type="number"/>
                                        </div>
                                        <div class="d-none" id="finalCostGroup">
                                            <label class="form-label" for="calcFinalCost">Финальная цена (₽)</label>
                                            <input class="form-control" id="calcFinalCost" step="0.01" type="number"/>
                                        </div>
                                        <div>
                                            <label class="form-label" for="calcPreparationTime">Часы подготовки
                                                (ч:м)</label>
                                            <input class="form-control" id="calcPreparationTime"
                                                   onblur="this.value = formatTimeForDisplay(handleTimeInput({target:{value:this.value}}))"
                                                   type="text"/>
                                        </div>
                    </div>
                                </div>
                                <div class="calc-form-section">
                                    <div class="calc-section-title">
                                        <span class="icon">3</span>
                                        Сроки и логистика
                    </div>

                                    <div class="calc-field-grid cols-3">
                                        <div>
                                            <label class="form-label" for="calcParallelPrinting">Принтеры работают параллельно?</label>
                                            <select class="form-select" id="calcParallelPrinting">
                                                <option value="no">Нет</option>
                                                <option value="yes">Да</option>
                                            </select>
                                        </div>


                                        <div>
                                            <label class="form-label" for="calcUrgencyProfile">Срочность заказа</label>
                                            <select class="form-select" id="calcUrgencyProfile"></select>
                                        </div>
                    </div>
                                    <div class="calc-field-grid cols-4">
                                        <div>
                                            <label class="form-label" for="calcShipping">Упаковка/Доставка (₽)</label>
                                            <input class="form-control" id="calcShipping" step="1" type="number"/>
                                        </div>
                                        <div>
                                            <label class="form-label" for="calcStartDate">Дата и время начала</label>
                                            <input class="form-control" id="calcStartDate" type="datetime-local"/>
                                        </div>
                                        <div>
                                            <label class="form-label" for="calcDeadlineDate">Дата
                                                окончания</label>
                                            <input class="form-control" id="calcDeadlineDate" type="datetime-local"/>
                                            <div class="form-text">Если указано, профиль срочности подбирается
                                                автоматически.
                                            </div>
                                        </div>
                    </div>
                                    <div class="row g-3 mt-2" id="calcAdvancedSettings" style="display:none"></div>
                                </div>
                                <div class="calc-form-section calc-form-section-table">
                                    <div class="calc-section-title">
                                        <span class="icon">4</span>
                                        Дополнительные услуги
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered mb-0" id="customServicesTable">
                                            <thead>
                                <tr>
                                    <th>Вкл.</th>
                                    <th>Название</th>
                                    <th>Стоимость за ед.</th>
                                    <th>Кол-во</th>
                                    <th>Тип</th>
                                    <th></th>
                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-sm btn-primary align-self-start"
                                            onclick="addCustomService()">Добавить услугу
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="calc-card">
                            <div class="calc-section-title">
                                <span class="icon">5</span>
                                Принтеры и модели
                            </div>
                            <div id="calcPrintersContainer"></div>
                        </div>
                        <div class="calc-card">
                            <div class="calc-section-title">
                                <span class="icon">6</span>
                                Расширенный отчёт
                            </div>
                            <div class="calc-empty-placeholder text-muted small" id="calcResultEmpty">
                                Пока нет данных — запустите расчёт.
                            </div>
                            <div class="calc-result-panel" id="calcResult" style="display:none;"></div>
                        </div>
                    </div>
                    <aside class="calc-sidebar">
                        <div class="calc-summary-card">
                            <div class="text-uppercase small opacity-75 mb-2">Итого к оплате</div>
                            <h2><span id="calcSummaryTotal">—</span> ₽</h2>
                            <div class="calc-summary-meta">
                                <div>
                                    <span>Себестоимость</span>
                                    <strong id="calcSummaryCost">— ₽</strong>
                                </div>
                                <div>
                                    <span>Маржа</span>
                                    <strong id="calcSummaryMargin">— ₽</strong>
                                    <small id="calcSummaryMarginPercent">0%</small>
                                </div>
                            </div>
                        </div>
                        <div class="calc-sidebar-card calc-sidebar-actions">
                            <button class="btn btn-success btn-lg" onclick="onCalculateAll()">Рассчитать всё</button>
                            <button class="btn btn-warning" id="downloadSummaryCardBtn" style="display:none">Скачать
                                смету
                            </button>
                            <button class="btn btn-outline-secondary" id="openReceiptsBtn">Чеки</button>
                        </div>
                        <div class="calc-sidebar-card">
                            <div class="calc-section-title mb-3">
                                <span class="icon">7</span>
                                Параметры заказа
                            </div>
                            <div class="calc-params-grid">
                                <div class="calc-param-tile">
                                    <span>Наценка</span>
                                    <strong id="calcSummaryMarkup">0%</strong>
                                </div>
                                <div class="calc-param-tile">
                                    <span>Скидка</span>
                                    <strong id="calcSummaryDiscount">0%</strong>
                                </div>
                                <div class="calc-param-tile">
                                    <span>Услуги</span>
                                    <strong id="calcSummaryServices">0 ₽</strong>
                                </div>
                                <div class="calc-param-tile">
                                    <span>Доставка</span>
                                    <strong id="calcSummaryShipping">0 ₽</strong>
                                </div>
                                <div class="calc-param-tile">
                                    <span>Налоги</span>
                                    <strong id="calcSummaryTax">0 ₽</strong>
                                </div>
                                <div class="calc-param-tile">
                                    <span>Режим печати</span>
                                    <strong id="calcSummaryParallel">—</strong>
                                </div>
                            </div>
                            <div class="calc-dates mt-3">

                                <div><span>Стоимость 1г</span><span id="calcPriceGramms">—</span></div>
                                <div><span>Итого до округления</span><span id="callcFullNoRounded">—</span></div>

                                <div><span>Время печати</span><span id="calcOperPrintTime">—</span></div>
                                <div><span>Подготовка</span><span id="calcOperExecutionTime">—</span></div>
                                <div><span>Простой</span><span id="calcOperFalseTime">—</span></div>
                                <div><span>Всего оператор</span><span id="calcOperFullTime">—</span></div>

                                <div><span>Старт</span><span id="calcSummaryStart">—</span></div>
                                <div><span>Дедлайн</span><span id="calcSummaryDeadline">—</span></div>
                                <div><span>Финиш</span><span id="calcSummaryFinish">—</span></div>

                            </div>
                        </div>
                        <div class="calc-sidebar-card">
                            <div class="calc-section-title mb-3">
                                <span class="icon">8</span>
                                Структура расходов
                            </div>
                            <div class="calc-structure-list" id="calcCostStructure"></div>
                            <div class="text-muted small" id="calcCostStructureEmpty">Пока нет данных — запустите
                                расчёт.
                            </div>
                        </div>
                        <div class="calc-sidebar-card calc-alert bg-warning-subtle text-warning-emphasis"
                             id="calcSidebarWarnings" style="display:none"></div>
                    </aside>
                </div>
            </div>
            <!-- Статистика -->
            <div aria-labelledby="summary-tab" class="tab-pane fade" id="summaryPane" role="tabpanel">
                <div class="mt-4">
                    <h3>Статистика</h3>
                    <div class="d-flex align-items-center mb-3">
                        <select class="form-select form-select-sm w-auto me-2" id="summaryPeriod">
                            <option value="all">Весь период</option>
                            <option value="week">Неделя</option>
                            <option value="month">Месяц</option>
                            <option value="year">Год</option>
                            <option value="custom">Ручной</option>
                        </select>
                        <input class="form-control form-control-sm w-auto me-2 d-none" id="summaryFrom" type="date"/>
                        <input class="form-control form-control-sm w-auto me-2 d-none" id="summaryTo" type="date"/>
                        <button class="btn btn-primary btn-sm d-none" id="summaryApplyBtn">Применить</button>
                    </div>
                    <div id="summaryContent"></div>
                </div>
            </div>
            <!-- История -->
            <div aria-labelledby="history-tab" class="tab-pane fade" id="historyPane" role="tabpanel">
                <div class="mt-4">
                    <h3>История расчетов</h3>
                    <div class="table-responsive">
                        <input class="form-control form-control-sm mb-2"
                               oninput="filterTable('historyTable', this.value)" placeholder="Поиск..." type="text"/>
                        <table class="table table-bordered table-hover" id="historyTable">
                            <thead class="">
                            <tr>
                                <th onclick="sortTable('historyTable',0)">Код</th>
                                <th onclick="sortTable('historyTable',1)">Дата</th>
                                <th onclick="sortTable('historyTable',2)">Название расчёта</th>
                                <th onclick="sortTable('historyTable',3)">Клиент</th>
                                <th onclick="sortTable('historyTable',4)">Статус</th>
                                <th onclick="sortTable('historyTable',5)">Итог (₽)</th>
                                <th>Чек</th>
                                <th>Подробнее</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div class="row g-2 mt-3">
                            <div class="col-auto">
                                <input class="form-control" id="histFrom" type="date"/>
                            </div>
                            <div class="col-auto">
                                <input class="form-control" id="histTo" type="date"/>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-primary" onclick="updateHistoryStats()">Фильтр</button>
                            </div>
                        </div>
                        <div class="mt-2" id="historyStats"></div>
                    </div>
                </div>
            </div>
            <!-- Клиенты -->
            <div aria-labelledby="clients-tab" class="tab-pane fade" id="clientsPane" role="tabpanel">
                <div class="mt-4">
                    <h3>Клиенты</h3>
                    <div class="mb-2">
                        <button class="btn btn-primary btn-sm" onclick="onAddClient()">Добавить клиента</button>
                    </div>
                    <div class="table-responsive">
                        <input class="form-control form-control-sm mb-2"
                               oninput="filterTable('clientsTable', this.value)" placeholder="Поиск..." type="text"/>
                        <table class="table table-bordered table-hover" id="clientsTable">
                            <thead>
                            <tr>
                                <th onclick="sortTable('clientsTable',0)">ID</th>
                                <th onclick="sortTable('clientsTable',1)">Имя</th>
                                <th onclick="sortTable('clientsTable',2)">Телефон</th>
                                <th onclick="sortTable('clientsTable',3)">Ссылки</th>
                                <th>Действия</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Настройки -->
        <div aria-labelledby="settings-tab" class="tab-pane fade" id="settingsPane" role="tabpanel">
            <div class="row mt-4">
                <div class="col-md-3 mb-3">
                    <div class="nav flex-column nav-pills" id="settingsSubTab" role="tablist">
                        <button class="nav-link active" data-bs-target="#brandSet" data-bs-toggle="pill"
                                id="brand-set-tab" role="tab" type="button">Брендинг
                        </button>
                        <button class="nav-link" data-bs-target="#calcSet" data-bs-toggle="pill" id="calc-set-tab"
                                role="tab" type="button">Калькуляция
                        </button>
                        <button class="nav-link" data-bs-target="#cloudSet" data-bs-toggle="pill" id="cloud-set-tab"
                                role="tab" type="button">Импорт/Экспорт
                        </button>
                        <button class="nav-link" data-bs-target="#spoolmanSet" data-bs-toggle="pill"
                                id="spoolman-set-tab" role="tab" type="button">Spoolman
                        </button>
                        <button class="nav-link" data-bs-target="#nalogSet" data-bs-toggle="pill" id="nalog-set-tab"
                                role="tab" type="button">Мой Налог
                        </button>
                        <button class="nav-link" data-bs-target="#aboutSet" data-bs-toggle="pill" id="about-set-tab"
                                role="tab" type="button">О калькуляторе
                        </button>
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="tab-content" id="settingsSubTabContent">
                        <div class="tab-pane fade show active" id="brandSet" role="tabpanel">
                            <h3>Брендинг</h3>
                            <div class="mb-3">
                                <label class="form-label" for="companyNameInput">Название компании:</label>
                                <input class="form-control" id="companyNameInput" type="text">
                                </input></div>
                            <div class="mb-3">
                                <label class="form-label" for="chatLinkInput">Ссылка на чат (QR):</label>
                                <input class="form-control" id="chatLinkInput" type="text">
                                </input></div>
                            <div class="mb-3">
                            <label class="form-label" for="bankDetailsInput">Банковские реквизиты (р/с):</label>
                            <textarea class="form-control" id="bankDetailsInput" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="brandLogoInput">Логотип (PNG до 48×48):</label>
                            <div class="d-flex flex-wrap align-items-center gap-3">
                                <div>
                                    <input class="form-control" id="brandLogoInput" accept="image/png" type="file"/>
                                    <div class="form-text">Используется в карточках моделей и смете.</div>
                                </div>
                                <div class="brand-logo-preview border rounded p-2">
                                    <img alt="Логотип" id="brandLogoPreview" style="width:48px;height:48px;object-fit:contain;display:none;"/>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearBrandLogo()" type="button">Удалить</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Профили срочности и графиков:</label>
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-5">
                                        <select class="form-select" id="urgencyProfileSelect"></select>
                                    </div>
                                    <div class="col-md-7 text-md-end">
                                        <button class="btn btn-sm btn-outline-secondary" id="addUrgencyProfileBtn"
                                                type="button">Добавить профиль
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="deleteUrgencyProfileBtn"
                                                type="button">Удалить
                                        </button>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-4">
                                        <label class="form-label">Название профиля</label>
                                        <input class="form-control" id="urgencyProfileName" type="text">
                                        </input></div>
                                    <div class="col-md-4">
                                        <label class="form-label">Наценка профиля (%)</label>
                                        <input class="form-control" id="urgencyProfileMarkup" step="1" type="number">
                                        </input></div>
                                    <div class="col-md-4">
                                        <label class="form-label">Описание</label>
                                        <input class="form-control" id="urgencyProfileDescription" type="text">
                                        </input></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">Рабочий график по дням недели:</label>
                                    <button class="btn btn-sm btn-outline-secondary"
                                            data-bs-target="#workdayTemplateModal" data-bs-toggle="modal" type="button">
                                        Автозаполнение дня
                                    </button>
                                </div>
                                <ul class="nav nav-tabs mb-3" id="operatorWeekTabs" role="tablist"></ul>
                                <div class="tab-content border rounded p-3" id="operatorWeekContent"></div>
                                <div class="form-text" id="urgencyScheduleHint"></div>
                                <div class="form-text">Оставьте строки пустыми, если день нерабочий. Перерывы
                                    добавляйте по необходимости.
                                </div>
                                <div class="form-text">Используйте кнопку автозаполнения, чтобы быстро задать шаблон
                                    (6/8/12 часовые смены, обед и спецперерывы). Изменения вступят в силу после
                                    сохранения.
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="saveBrandingSettings()">Сохранить</button>
                        </div>
                        <div class="tab-pane fade" id="calcSet" role="tabpanel">
                            <h3>Калькуляция</h3>
                            <div class="mb-3 form-check">
                                <input class="form-check-input" id="printLabelsCheckbox" type="checkbox"/>
                                <label class="form-check-label" for="printLabelsCheckbox">Печатать этикетки</label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="labelCostInput">Стоимость 1 этикетки (₽):</label>
                                <input class="form-control" id="labelCostInput" step="0.01" type="number">
                                </input></div>
                            <div class="mb-3 form-check">
                                <input class="form-check-input" id="printEstimateCheckbox" type="checkbox"/>
                                <label class="form-check-label" for="printEstimateCheckbox">Учитывать печать
                                    сметы</label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="estimatePrintCostInput">Стоимость печати сметы
                                    (₽):</label>
                                <input class="form-control" id="estimatePrintCostInput" step="0.01" type="number">
                                </input></div>
                            <div class="mb-3">
                                <label class="form-label" for="calcOperatorRate">Ставка оператора (₽/ч):</label>
                                <input class="form-control" id="calcOperatorRate" step="0.01" type="number">
                                </input></div>
                            <div class="mb-3 form-check">
                                <input class="form-check-input" id="calcOperatorReject" type="checkbox"/>
                                <label class="form-check-label" for="calcOperatorReject">Учесть ставку оператора для
                                    бракованных моделей</label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="calcDowntimeCost">Стоимость минуты простоя
                                    (₽/мин):</label>
                                <input class="form-control" id="calcDowntimeCost" step="0.01" type="number">
                                </input></div>
                            <div class="mb-3">
                                <label class="form-label" for="calcPreparationRate">Стоимость часа подготовки
                                    (₽/ч):</label>
                                <input class="form-control" id="calcPreparationRate" step="0.01" type="number"/>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="calcCostKwh">Цена 1 кВт⋅ч (₽):</label>
                                <input class="form-control" id="calcCostKwh" step="0.01" type="number"/>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="calcTaxPercent">Налог (%):</label>
                                <input class="form-control" id="calcTaxPercent" step="1" type="number"/>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="calcRoundingMode">Округление итоговой стоимости:</label>
                                <select class="form-select" id="calcRoundingMode">
                                    <option value="none">Без округления</option>
                                    <option value="round10">До 10 ₽ (вверх)</option>
                                    <option value="round100">До 100 ₽ (вверх)</option>
                                </select>
                                <div class="form-text">Доплата за округление добавляется как дополнительная наценка.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-block">Расчётные опции:</label>
                                <div class="form-check">
                                    <input class="form-check-input" id="settingsIncludeAmortization" type="checkbox"/>
                                    <label class="form-check-label" for="settingsIncludeAmortization">Учитывать
                                        амортизацию и обслуживание</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" id="settingsIncludeRejects" type="checkbox"/>
                                    <label class="form-check-label" for="settingsIncludeRejects">Учитывать брак в
                                        стоимости</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" id="settingsIncludeOverheads" type="checkbox"/>
                                    <label class="form-check-label" for="settingsIncludeOverheads">Учитывать накладные
                                        расходы</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" id="settingsIgnoreCoolingRejects" type="checkbox"/>
                                    <label class="form-check-label" for="settingsIgnoreCoolingRejects">Не учитывать
                                        остывание для брака</label>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="saveCalcSettings()">Сохранить</button>
                        </div>
                        <div class="tab-pane fade" id="cloudSet" role="tabpanel">
                            <div class="mt-4">
                                <h3>Облачный экспорт (SupaBase, шифрованное хранение данных 5 минут)</h3>
                                <button class="btn btn-primary mt-2" onclick="generateSyncLinkAndQR()">🔗 Сгенерировать
                                    ссылку и QR
                                </button>
                                <button class="btn btn-warning mt-2" onclick="saveSettingsToCloud()">☁️ Сохранить в
                                    облако (на 5 минут)
                                </button>
                                <button class="btn btn-info mt-2" onclick="loadSettingsFromCloud()">☁️ Загрузить из
                                    облака
                                </button>
                                <input class="form-control mt-2" id="syncLinkDisplay" readonly="" type="text"/>
                                <div class="mt-2" id="qrcode"></div>
                            </div>
                            <div class="mt-4">
                                <h3>Экспорт данных</h3>
                                <button class="btn btn-primary" onclick="onExportJson()">Выгрузить JSON</button>
                                <button class="btn btn-info" id="downloadJsonFileBtn">Скачать JSON файл</button>
                                <textarea class="form-control mt-2" id="exportArea" rows="5"></textarea>
                            </div>
                            <div class="mt-4">
                                <h3>Импорт данных</h3>
                                <textarea class="form-control" id="importArea" rows="5"></textarea>
                                <input accept=".json" class="form-control mt-2" id="importJsonFile" type="file"/>
                                <button class="btn btn-success mt-2" onclick="onImportJson()">Импортировать</button>
                                <button class="btn btn-info mt-2" onclick="importFromFile()">Импорт из файла</button>
                                <div class="mt-3 p-3 border rounded bg-light">
                                    <h5 class="mb-2">Сохранённые ответы модалок импорта</h5>
                                    <div class="small text-muted mb-2">
                                        Здесь хранятся ваши решения «сопоставить профиль → принтер/материал/заказ» (если вы включали галочку «Сохранить»).
                                    </div>
                                    <div class="d-flex gap-2 align-items-center flex-wrap">
                                        <button class="btn btn-outline-danger btn-sm" id="clearPromptMemoryBtn"
                                                type="button">Очистить сохранения
                                        </button>
                                        <div class="small text-muted" id="promptMemoryStats"></div>
                                    </div>
                                </div>
                                <div class="alert alert-secondary mt-3 mb-0 small">
                                    <p class="mb-1">Все данные сохраняются в LocalStorage при любых изменениях.</p>
                                    <p class="mb-0">Чтобы сбросить настройки, импортируйте пустой JSON или очистите
                                        LocalStorage вручную.</p>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="spoolmanSet" role="tabpanel">
                            <div class="mt-4" id="spoolmanSettingsContainer"></div>
                        </div>
                        <div class="tab-pane fade" id="nalogSet" role="tabpanel">
                            <h3>Мой Налог</h3>
                            <div class="mb-3">
                                <label class="form-label" for="myNalogToken">Токен доступа:</label>
                                <input class="form-control" id="myNalogToken" type="text">
                                </input></div>
                            <div class="mb-3">
                                <label class="form-label" for="myNalogPhone">Телефон:</label>
                                <input class="form-control" id="myNalogPhone" type="text">
                                </input></div>
                            <div class="mb-3">
                                <button class="btn btn-secondary" id="requestSmsBtn">Запросить SMS</button>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="myNalogSms">Код из SMS:</label>
                                <input class="form-control" id="myNalogSms" type="text">
                                <button class="btn btn-primary mt-2" id="confirmSmsBtn">Получить токен</button>
                                </input></div>
                            <div class="mb-3">
                                <button class="btn btn-primary" onclick="saveMyNalogSettings()">Сохранить</button>
                                <button class="btn btn-info ms-2" onclick="checkMyNalogStatus()">Проверить статус
                                </button>
                            </div>
                            <div class="small-text" id="myNalogStatus"></div>
                        </div>
                        <div class="tab-pane fade" id="aboutSet" role="tabpanel">
                            <div class="mt-4">
                                <h3>О калькуляторе</h3>
                                <p class="mb-0"> Интерфейс собран на
                                    Bootstrap 5, логика работает на чистом JavaScript без серверной части, данные живут в
                                    LocalStorage прямо в браузере.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно автозаполнения графика -->
<div aria-hidden="true" aria-labelledby="workdayTemplateModalLabel" class="modal fade" id="workdayTemplateModal"
     tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="workdayTemplateModalLabel">Автозаполнение рабочего дня</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label" for="workdayTemplateSelect">Шаблон</label>
                        <select class="form-select" id="workdayTemplateSelect">
                            <option data-hours="" data-lunch="" data-offset="" value="custom">Свои параметры</option>
                            <option data-hours="6" data-lunch="30" data-offset="180" value="6h_center">6 ч · обед 30 мин
                                (по центру)
                            </option>
                            <option data-hours="8" data-lunch="60" data-offset="240" value="8h_classic">8 ч · обед 1
                                час
                            </option>
                            <option data-hours="8" data-lunch="30" data-offset="270" value="8h_short">8 ч · обед 30
                                мин
                            </option>
                            <option data-hours="12" data-lunch="60" data-offset="240" value="12h_long">12 ч · обед 1
                                час
                            </option>
                            <option data-hours="12" data-lunch="30" data-offset="360" value="12h_short">12 ч · обед 30
                                мин
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="workdayStartTime">Начало смены</label>
                        <input class="form-control" id="workdayStartTime" type="time" value="09:00"/>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="workdayTotalHours">Рабочих часов</label>
                        <input class="form-control" id="workdayTotalHours" max="16" min="1" step="0.5" type="number"
                               value="8"/>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label class="form-label" for="workdayLunchStart">Начало обеда</label>
                        <input class="form-control" id="workdayLunchStart" type="time" value="13:00"/>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="workdayLunchDuration">Обед, минут</label>
                        <input class="form-control" id="workdayLunchDuration" max="120" min="30" step="5" type="number"
                               value="60"/>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <div class="form-check">
                            <input class="form-check-input" id="workdaySkipLunch" type="checkbox"/>
                            <label class="form-check-label" for="workdaySkipLunch">Без отдельного обеда</label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">Дополнительные перерывы</label>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary" id="addSpecialBreakBtn" type="button">Добавить
                                перерыв
                            </button>
                            <button class="btn btn-outline-secondary" id="addPresetBreaksBtn" type="button">+2 × 10
                                мин
                            </button>
                        </div>
                    </div>
                    <div class="small" id="specialBreaksContainer"></div>
                    <div class="form-text">Перерывы на обогрев и отдых включаются в рабочее время, но в расписании
                        отображаются отдельными окнами.
                    </div>
                </div>
                <div class="mt-3">
                    <label class="form-label">Дни недели для заполнения:</label>
                    <div class="d-flex flex-wrap gap-2" id="workdayDaysContainer">
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox"
                                                                                value="1"/> Пн</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox"
                                                                                value="2"/> Вт</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox"
                                                                                value="3"/> Ср</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox"
                                                                                value="4"/> Чт</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox"
                                                                                value="5"/> Пт</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox"
                                                                                value="6"/> Сб</label>
                        <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox"
                                                                                value="0"/> Вс</label>
                    </div>
                </div>
                <div class="alert alert-secondary mt-3 mb-0 small">
                    <p class="mb-1"><strong>Подсказка:</strong> обед и дополнительные перерывы можно указывать по
                        необходимости.</p>
                    <p class="mb-0">Шаблоны учитывают примеры для 6/8/12-часовых смен. Применяйте настройки к выбранным
                        дням, затем сохраните раздел «Брендинг».</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Закрыть</button>
                <button class="btn btn-primary" id="applyWorkdayTemplateBtn" type="button">Заполнить</button>
            </div>
        </div>
    </div>
</div>
<!-- Модальное окно для данных из ссылки -->
<div class="modal fade" id="incomingDataModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Импорт данных из ссылки</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" for="targetOrderSelect">Выберите расчёт</label>
                    <select class="form-select" id="targetOrderSelect">
                        <option value="new">Создать новый расчёт</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Отмена</button>
                <button class="btn btn-primary" id="importLinkApplyBtn" type="button">Загрузить</button>
            </div>
        </div>
    </div>
</div>
<!-- Модальное окно настроек принтера OrcaSlicer -->
<div class="modal fade" id="orcaPrinterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Настройки принтера OrcaSlicer</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex mb-2">
                    <select class="form-select me-2" id="orcaProfileSelect"></select>
                    <button class="btn btn-danger btn-sm" id="delOrcaProfileBtn" type="button">✖</button>
                </div>
                <pre class="p-2 border mt-2" id="orcaPrinterJsonView"></pre>
                <pre class="p-2 border mt-2" id="orcaPrinterInfoView"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Закрыть</button>
            </div>
        </div>
    </div>
</div>
<!-- Модальное окно редактирования принтера -->
<div class="modal fade" id="printerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Принтер</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Название</label>
                    <input class="form-control" id="printerNameInput" type="text"/>
                </div>
                <div class="mb-2">
                    <label class="form-label">Стоимость (₽)</label>
                    <input class="form-control" id="printerCostInput" type="number"/>
                </div>
                <div class="mb-2">
                    <label class="form-label">Часы окупаемости</label>
                    <input class="form-control" id="printerHoursInput" type="number"/>
                </div>
                <div class="mb-2">
                    <label class="form-label">Мощность (Вт)</label>
                    <input class="form-control" id="printerPowerInput" type="number"/>
                </div>
                <div class="mb-2">
                    <label class="form-label">Обсл. (₽/ч)</label>
                    <input class="form-control" id="printerMaintInput" type="number"/>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Отмена</button>
                <button class="btn btn-primary" id="savePrinterBtn" type="button">Сохранить</button>
            </div>
        </div>
    </div>
</div>
<!-- Модальное окно редактирования материала -->
<div class="modal fade" id="materialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Материал</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body material-modal-body">
                <div class="row g-2 align-items-end mb-2">
                    <div class="col-12 mat-type-col">
                        <label class="form-label">Тип</label>
                        <select class="form-select" id="matMaterialTypeInput" onchange="onMaterialTypeSelectChange()"></select>
                    </div>
                    <div class="col-12 mat-name-col">
                        <label class="form-label">Название</label>
                        <input class="form-control" id="matNameInput" type="text"/>
                    </div>
                </div>
                <div class="row g-2 align-items-end mb-2 d-none" id="matMaterialTypeCustomWrap">
                    <div class="col-12">
                        <label class="form-label">Свой тип материала</label>
                        <input class="form-control" id="matMaterialTypeCustomInput" type="text"/>
                    </div>
                </div>
                <div class="row g-2 align-items-end mb-2">
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Стоимость за кг</label>
                        <input class="form-control" id="matCostInput" min="0" step="0.01" type="number"/>
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Цвет</label>
                        <input class="form-control form-control-color w-100" id="matColorInput" type="color" value="#ffffff"/>
                    </div>
                </div>
                <div class="row g-2 align-items-end mb-2">
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Начальный вес (кг)</label>
                        <input class="form-control" id="matDeclaredInput" oninput="updateMaterialBalancePreview()" step="0.01"
                               type="number"/>
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Остаток (кг)</label>
                        <div class="input-group">
                            <input class="form-control" id="matBalanceInput" min="0" step="0.001" type="number"/>
                            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#matMassCollapse" aria-expanded="false"
                                    aria-controls="matMassCollapse" title="Режим ввода остатка">
                                <i class="bi bi-calculator"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mat-mass-block mb-2 collapse" id="matMassCollapse">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <label class="form-label mb-0">Масса катушки</label>
                        <small class="text-muted">Режим ввода массы</small>
                    </div>
                    <input id="matMassModeInput" type="hidden" value="used"/>
                    <div class="btn-group btn-group-sm d-flex flex-wrap mat-mass-mode-group mt-1" id="matMassModeGroup" role="group" aria-label="Режим ввода массы">
                        <button class="btn btn-outline-secondary btn-sm" data-mat-mass-mode="used"
                                onclick="setMaterialMassMode('used')" type="button">Использованный
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" data-mat-mass-mode="remaining"
                                onclick="setMaterialMassMode('remaining')" type="button">Оставшийся
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" data-mat-mass-mode="measured"
                                onclick="setMaterialMassMode('measured')" type="button">Измеренный
                        </button>
                    </div>
                    <div class="form-text">Измеренный вес доступен при указанном пустом весе.</div>
                    <div class="row g-2 align-items-end mt-2">
                        <div class="col-12 col-sm-6">
                            <label class="form-label">Пустой вес</label>
                            <div class="input-group">
                                <input class="form-control" id="matEmptySpoolWeightInput" min="0" step="0.1"
                                       oninput="updateMaterialMassAvailability();updateMaterialBalancePreview()" type="number"/>
                                <span class="input-group-text">г</span>
                            </div>
                            <div class="form-text">Оставьте пустым, чтобы использовать данные производителя.</div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="mat-mass-input" data-mode="used">
                                <label class="form-label">Использованный вес</label>
                                <div class="input-group">
                                    <input class="form-control" id="matUsedWeightInput" min="0" oninput="updateMaterialBalancePreview()"
                                           step="0.1" type="number"/>
                                    <span class="input-group-text">г</span>
                                </div>
                                <div class="form-text">Для новой катушки: 0 г.</div>
                            </div>
                            <div class="mat-mass-input d-none" data-mode="remaining">
                                <label class="form-label">Оставшийся вес</label>
                                <div class="input-group">
                                    <input class="form-control" id="matRemainingWeightInput" min="0" oninput="updateMaterialBalancePreview()"
                                           step="0.1" type="number"/>
                                    <span class="input-group-text">г</span>
                                </div>
                                <div class="form-text">Для новой катушки совпадает с начальным весом.</div>
                            </div>
                            <div class="mat-mass-input d-none" data-mode="measured">
                                <label class="form-label">Измеренный вес</label>
                                <div class="input-group">
                                    <input class="form-control" id="matMeasuredWeightInput" min="0" oninput="updateMaterialBalancePreview()"
                                           step="0.1" type="number"/>
                                    <span class="input-group-text">г</span>
                                </div>
                                <div class="form-text">Вес катушки с материалом.</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-2 align-items-end mb-2">
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Подготовка (мин)</label>
                        <input class="form-control" id="matPrepTimeInput" min="0" type="number"/>
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Остывание (мин)</label>
                        <input class="form-control" id="matCoolingTimeInput" min="0" type="number"/>
                    </div>
                </div>
                <div class="row g-2 align-items-end mb-2">
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Производитель</label>
                        <input class="form-control" id="matManufInput" type="text"/>
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Дата производства</label>
                        <input class="form-control" id="matProdDateInput" placeholder="ГГГГ-ММ-ДД" type="text"/>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">Принтеры</label>
                    <select class="form-select" id="matPrintersSelect" multiple=""></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Отмена</button>
                <button class="btn btn-primary" id="saveMaterialBtn" type="button">Сохранить</button>
            </div>
        </div>
    </div>
</div>
<!-- Модальное окно связывания материала с профилями -->
<div class="modal fade" id="materialProfileLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Профили материала</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <select class="form-select" id="materialProfileLinkSelect" multiple=""></select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Отмена</button>
                <button class="btn btn-primary" id="applyMaterialProfileLinkBtn" type="button">Применить</button>
            </div>
        </div>
    </div>
</div>
<!-- Модальное окно профилей Orca -->
<div class="modal fade" id="manageMaterialProfilesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Профили Orca</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                </div>
                <table class="table table-bordered table-sm">
                    <thead>
                    <tr>
                        <th>Название</th>
                        <th>Действия</th>
                    </tr>
                    </thead>
                    <tbody id="materialProfilesTable"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Закрыть</button>
            </div>
        </div>
    </div>
</div>
<!-- Модальное окно профилей принтеров -->
<div class="modal fade" id="managePrinterProfilesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Профили принтеров</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-sm">
                    <thead>
                    <tr>
                        <th>Название</th>
                        <th>Принтер</th>
                        <th>Действия</th>
                    </tr>
                    </thead>
                    <tbody id="printerProfilesTable"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Универсальное модальное окно для ввода данных -->
<div class="modal fade" id="multiPromptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="multiPromptTitle"></h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body" id="multiPromptBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Отмена</button>
                <button class="btn btn-primary" id="multiPromptOk" type="button">OK</button>
            </div>
        </div>
    </div>
</div>
<!-- Модальное окно с ссылкой на чек -->
<div class="modal fade" id="checkLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ссылка на чек</h5>
                <button aria-label="Закрыть" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <label class="form-label" for="checkLinkInput">Ссылка для копирования:</label>
                <div class="input-group mb-3">
                    <input class="form-control" id="checkLinkInput" readonly="" type="text"/>
                    <button class="btn btn-outline-secondary" id="copyCheckLinkBtn" type="button">Копировать</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно со списком чеков -->
<div class="modal fade" id="receiptsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Квитанции</h5>
                <button aria-label="Закрыть" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <div class="small text-muted mb-2">Ссылки на сформированные чеки «Мой Налог» для текущего расчёта.</div>

                <button class="btn btn-primary" id="sendMyNalogBtn" style="display:none">Отправить чек в налоговую
                </button>
                <button class="btn btn-danger" id="cancelMyNalogBtn" style="display:none">Отменить крайний чек
                </button>

                <div id="receiptsLinksContainer" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /**
     * Embedded utilities (previously )
     * Важно: эти функции НЕ зависят от Electron и работают на обычном сайте.
     */
    (function(){
        function _asArr(x){ return Array.isArray(x) ? x : []; }
        function _s(v){ return (v===undefined || v===null) ? '' : String(v); }
        function _isEmptyId(id){ const s=_s(id).trim(); return !s || s.toLowerCase()==='nan' || s.toLowerCase()==='undefined' || s.toLowerCase()==='null'; }
        function _isNumericId(id){ return /^\d+$/.test(_s(id).trim()); }
        function _maxNumericId(arr){
            let max=0;
            for(const it of _asArr(arr)){
                const n = parseInt(it && it.id, 10);
                if(!isNaN(n)) max = Math.max(max, n);
            }
            return max;
        }
        function _normalizeCollection(appData, arrName, counterKey){
            const arr = _asArr(appData[arrName]);
            const seen = new Set();
            const map = {}; // oldIdStr -> newIdStr
            let next = _maxNumericId(arr) + 1;

            for(const it of arr){
                if(!it) continue;
                const raw = _s(it.id).trim();
                const normalized = _isNumericId(raw) ? String(parseInt(raw, 10)) : '';
                if(!normalized || seen.has(normalized)){
                    const newId = String(next++);
                    if(!_isEmptyId(raw)) map[raw] = newId;
                    it.id = newId;
                    seen.add(newId);
                } else {
                    if(raw !== normalized){
                        map[raw] = normalized;
                    }
                    it.id = normalized;
                    seen.add(normalized);
                }
            }

            // counters: держим на максимуме, чтобы getNextId() не создавала коллизии
            appData.counters = appData.counters || {};
            const maxNow = _maxNumericId(arr);
            const current = parseInt(appData.counters[counterKey] || 0, 10);
            appData.counters[counterKey] = Math.max(isNaN(current)?0:current, maxNow);

            // сохранить обратно, если было не массивом
            appData[arrName] = arr;
            return map;
        }

        function _normalizeHistoryOrderIds(appData){
            const history = _asArr(appData.calcHistory);
            const seen = new Set();
            let maxId = history.reduce((max, entry) => {
                const val = parseInt(entry && entry.id, 10);
                return isNaN(val) ? max : Math.max(max, val);
            }, 0);

            history.forEach(entry => {
                if(!entry) return;
                const raw = _s(entry.id).trim();
                let normalized = _isNumericId(raw) ? String(parseInt(raw, 10)) : '';
                if(!normalized || seen.has(normalized)){
                    normalized = String(++maxId);
                }
                entry.id = normalized;
                seen.add(normalized);
            });

            appData.counters = appData.counters || {};
            const current = parseInt(appData.counters.orders || 0, 10);
            appData.counters.orders = Math.max(isNaN(current)?0:current, maxId);
        }

        function _normalizeHistoryModelIds(appData){
            const history = _asArr(appData.calcHistory);
            const seen = new Set();
            let maxId = parseInt(appData?.counters?.models, 10);
            if(isNaN(maxId)) maxId = 0;

            const touchModel = (model) => {
                if(!model) return;
                const raw = _s(model.id).trim();
                let normalized = _isNumericId(raw) ? String(parseInt(raw, 10)) : '';
                if(!normalized || seen.has(normalized)){
                    normalized = String(++maxId);
                }
                model.id = normalized;
                seen.add(normalized);
            };

            history.forEach(entry => {
                if(entry && Array.isArray(entry.details)){
                    entry.details.forEach(pr => {
                        if(pr && Array.isArray(pr.linesDetail)){
                            pr.linesDetail.forEach(touchModel);
                        }
                    });
                }
                if(entry && entry.calcData && typeof entry.calcData === 'object'){
                    Object.values(entry.calcData).forEach(list => {
                        if(Array.isArray(list)){
                            list.forEach(touchModel);
                        }
                    });
                }
            });

            appData.counters = appData.counters || {};
            const current = parseInt(appData.counters.models || 0, 10);
            appData.counters.models = Math.max(isNaN(current)?0:current, maxId);
        }

        function validateUniqueIds(appData){
            const errors = [];
            function checkCollection(arr, label){
                if(!Array.isArray(arr)){
                    errors.push(`${label}: not_array`);
                    return;
                }
                const seen = new Set();
                arr.forEach((it, idx)=>{
                    const id = it ? _s(it.id).trim() : '';
                    if(_isEmptyId(id)){
                        errors.push(`${label}[${idx}]: missing_id`);
                        return;
                    }
                    if(seen.has(id)){
                        errors.push(`${label}: duplicate_id ${id}`);
                    }
                    seen.add(id);
                });
            }

            checkCollection(appData.printers, 'printers');
            checkCollection(appData.materials, 'materials');
            checkCollection(appData.clients, 'clients');
            checkCollection(appData.additionalGlobal, 'additionalGlobal');
            checkCollection(appData.printerProfiles, 'printerProfiles');
            checkCollection(appData.materialProfiles, 'materialProfiles');


            const printerIds = new Set(_asArr(appData.printers).map(p=>_s(p.id)));
            const ppIds = new Set(_asArr(appData.printerProfiles).map(p=>_s(p.id)));
            const mpIds = new Set(_asArr(appData.materialProfiles).map(p=>_s(p.id)));

            _asArr(appData.printerProfiles).forEach((pf)=>{
                const prId = _s(pf && pf.printerId).trim();
                if(prId && !printerIds.has(prId)){
                    errors.push(`printerProfiles(${_s(pf.id)}): bad_printerId ${prId}`);
                }
            });

            _asArr(appData.printers).forEach((pr)=>{
                const pids = _asArr(pr && pr.profileIds).map(_s);
                const seenLocal = new Set();
                for(const pid of pids){
                    if(_isEmptyId(pid)) continue;
                    if(seenLocal.has(pid)) errors.push(`printers(${_s(pr.id)}).profileIds: duplicate ${pid}`);
                    seenLocal.add(pid);
                    if(!ppIds.has(pid)) errors.push(`printers(${_s(pr.id)}).profileIds: missing_ref ${pid}`);
                }
            });

            _asArr(appData.materials).forEach((m)=>{
                const pids = _asArr(m && m.profileIds).map(_s);
                const seenLocal = new Set();
                for(const pid of pids){
                    if(_isEmptyId(pid)) continue;
                    if(seenLocal.has(pid)) errors.push(`materials(${_s(m.id)}).profileIds: duplicate ${pid}`);
                    seenLocal.add(pid);
                    if(!mpIds.has(pid)) errors.push(`materials(${_s(m.id)}).profileIds: missing_ref ${pid}`);
                }
            });

            return { success: errors.length === 0, errors };
        }

        function normalizeIds(appData){
            if(!appData || typeof appData !== 'object') return;


            if(!Array.isArray(appData.printers)) appData.printers = [];
            if(!Array.isArray(appData.materials)) appData.materials = [];
            if(!Array.isArray(appData.clients)) appData.clients = [];
            if(!Array.isArray(appData.additionalGlobal)) appData.additionalGlobal = [];
            if(!Array.isArray(appData.printerProfiles)) appData.printerProfiles = [];
            if(!Array.isArray(appData.materialProfiles)) appData.materialProfiles = [];

            const mapPrinters = _normalizeCollection(appData, 'printers', 'printers');
            const mapMaterials = _normalizeCollection(appData, 'materials', 'materials');
            const mapClients = _normalizeCollection(appData, 'clients', 'clients');
            const mapAdd = _normalizeCollection(appData, 'additionalGlobal', 'globalAdditional');
            const mapPP = _normalizeCollection(appData, 'printerProfiles', 'printerProfiles');
            const mapMP = _normalizeCollection(appData, 'materialProfiles', 'materialProfiles');


            appData.materials.forEach(m=>{
                if(!Array.isArray(m.printers)) m.printers = [];
                m.printers = m.printers.map(pid=>{
                    const key=_s(pid).trim();
                    if(mapPrinters[key]) return mapPrinters[key];
                    return _isNumericId(key) ? String(parseInt(key,10)) : key;
                }).filter(pid=>!_isEmptyId(pid));
            });

            appData.additionalGlobal.forEach(a=>{
                if(!Array.isArray(a.printers)) a.printers = [];
                a.printers = a.printers.map(pid=>{
                    const key=_s(pid).trim();
                    if(mapPrinters[key]) return mapPrinters[key];
                    return _isNumericId(key) ? String(parseInt(key,10)) : key;
                }).filter(pid=>!_isEmptyId(pid));
            });


            appData.printerProfiles.forEach(pf=>{
                const prId = _s(pf && pf.printerId).trim();
                if(prId && mapPrinters[prId]) pf.printerId = mapPrinters[prId];
            });


            appData.printers.forEach(pr=>{
                if(!Array.isArray(pr.profileIds)) pr.profileIds = [];
                pr.profileIds = pr.profileIds.map(pid=>{
                    const s=_s(pid).trim();
                    return mapPP[s] ? mapPP[s] : pid;
                }).filter(pid=>!_isEmptyId(pid));

                pr.profileIds = Array.from(new Set(pr.profileIds.map(_s)));
            });


            appData.materials.forEach(m=>{
                if(!Array.isArray(m.profileIds)) m.profileIds = [];
                m.profileIds = m.profileIds.map(pid=>{
                    const s=_s(pid).trim();
                    return mapMP[s] ? mapMP[s] : pid;
                }).filter(pid=>!_isEmptyId(pid));
                m.profileIds = Array.from(new Set(m.profileIds.map(_s)));
            });


            if(Array.isArray(appData.calcHistory)){
                appData.calcHistory.forEach(h=>{
                    if(h && h.clientId!=null){
                        const old=_s(h.clientId).trim();
                        if(mapClients[old]){
                            h.clientId = mapClients[old];
                        } else if(_isNumericId(old)){
                            h.clientId = String(parseInt(old,10));
                        }
                    }

                    if(Array.isArray(h.details)){
                        h.details.forEach(d=>{
                            if(d && d.printerId!=null){
                                const old=_s(d.printerId);
                                if(mapPrinters[old]) d.printerId = mapPrinters[old];
                            }
                            if(d && d.materialId!=null){
                                const old=_s(d.materialId);
                                if(mapMaterials[old]) d.materialId = mapMaterials[old];
                            }
                        });
                    }


                    if(h && h.calcData && typeof h.calcData === 'object'){
                        const newCD = {};
                        Object.keys(h.calcData).forEach(pid=>{
                            const newPid = mapPrinters[_s(pid)] ? mapPrinters[_s(pid)] : pid;
                            const arr = h.calcData[pid];
                            if(Array.isArray(arr)){
                                arr.forEach(model=>{
                                    if(model && model.materialId!=null){
                                        const old=_s(model.materialId);
                                        if(mapMaterials[old]) model.materialId = mapMaterials[old];
                                    }
                                });
                            }
                            if(newCD[newPid]){

                                if(Array.isArray(newCD[newPid]) && Array.isArray(arr)) newCD[newPid] = newCD[newPid].concat(arr);
                            } else {
                                newCD[newPid] = arr;
                            }
                        });
                        h.calcData = newCD;
                    }
                });
            }

            appData.counters = appData.counters || {};

            _normalizeHistoryOrderIds(appData);
            _normalizeHistoryModelIds(appData);
        }

        window.normalizeIds = normalizeIds;
        window.validateUniqueIds = validateUniqueIds;
    })();
</script>
<script>
    const _instrumentInitialKeys = new Set(Object.keys(window));

    function instrumentFunctions(){
        const newKeys = Object.keys(window).filter(k=>!_instrumentInitialKeys.has(k) && typeof window[k]==='function');
        newKeys.forEach(fnName=>{
            const original = window[fnName];
            window[fnName] = function(...args){
                console.log('▶', fnName, 'called with', args);
                try{
                    const result = original.apply(this,args);
                    if(result instanceof Promise){
                        return result.then(r=>{console.log('✔', fnName, 'resolved with', r); return r;})
                            .catch(err=>{console.error('✖', fnName, 'rejected with', err); throw err;});
                    }
                    console.log('✔', fnName, 'returned', result);
                    return result;
                }catch(e){
                    console.error('✖', fnName, 'threw', e);
                    throw e;
                }
            };
        });
        console.log('Instrumented functions:', newKeys);
    }
    const THEME_STORAGE_KEY = "themePreference";
    function setTheme(theme) {
        document.documentElement.setAttribute("data-bs-theme", theme);
        localStorage.setItem(THEME_STORAGE_KEY, theme);
        const btn = document.getElementById("themeToggle");
        btn.innerText = theme==="dark" ? "☀️ Светлая тема" : "🌙 Темная тема";
    }
    document.getElementById("themeToggle").addEventListener("click",()=>{
        const th = document.documentElement.getAttribute("data-bs-theme");
        setTheme(th==="dark"?"light":"dark");
    });
    const savedTheme = localStorage.getItem(THEME_STORAGE_KEY)||"light";
    setTheme(savedTheme);

    function getNextId(type) {
        if (!appData.counters) appData.counters = {};
        if (!appData.counters[type]) appData.counters[type] = 0;
        return ++appData.counters[type];
    }

    function getNextOrderId() {
        if (!appData.counters) appData.counters = {};
        const maxExisting = Array.isArray(appData.calcHistory)
            ? appData.calcHistory.reduce((max, h) => {
                const id = parseInt(h.id, 10);
                return isNaN(id) ? max : Math.max(max, id);
            }, 0)
            : 0;
        const current = appData.counters.orders || 0;
        const next = Math.max(current, maxExisting) + 1;
        appData.counters.orders = next;
        return String(next);
    }

    /* Перенос данных из старого формата */
    function migrateOldData(obj){
        if(!Array.isArray(obj.printers)) obj.printers = [];
        if(!Array.isArray(obj.materials)) obj.materials = [];
        if(!Array.isArray(obj.additionalGlobal)) obj.additionalGlobal = [];
        if(!Array.isArray(obj.clients)) obj.clients = [];
        if(!Array.isArray(obj.calcHistory)) obj.calcHistory = [];

        if(!obj.calcSettings) obj.calcSettings = {};
        if(typeof obj.calcSettings.downtimeCost !== 'number') obj.calcSettings.downtimeCost = 0;
        if(typeof obj.calcSettings.preparationRate !== 'number') obj.calcSettings.preparationRate = 0;
        if(typeof obj.calcSettings.preparationTime !== 'number') obj.calcSettings.preparationTime = 0;
        if(typeof obj.calcSettings.roundingMode !== 'string') obj.calcSettings.roundingMode = 'none';
        if(typeof obj.calcSettings.includeOperatorForRejects !== 'boolean') obj.calcSettings.includeOperatorForRejects = false;
        if (typeof obj.calcSettings.includeEstimatePrint !== 'boolean') obj.calcSettings.includeEstimatePrint = false;
        if (typeof obj.calcSettings.estimatePrintCost !== 'number') obj.calcSettings.estimatePrintCost = 0;
        if(typeof obj.calcSettings.includeAmortization !== 'boolean') obj.calcSettings.includeAmortization = true;
        if(typeof obj.calcSettings.includeRejects !== 'boolean') obj.calcSettings.includeRejects = true;
        if(typeof obj.calcSettings.includeOverheads !== 'boolean') obj.calcSettings.includeOverheads = true;
        if(typeof obj.calcSettings.ignoreCoolingRejects !== 'boolean') obj.calcSettings.ignoreCoolingRejects = false;

        if (!obj.counters) {
            obj.counters = {
                printers: obj.printers.length,
                clients: obj.clients.length,
                materials: obj.materials.length,
                additionalGlobal: obj.additionalGlobal.length
            };
        }

        const unresolved = [];

        // Перенос материалов и расходов из принтеров
        obj.printers.forEach(pr=>{
            if(Array.isArray(pr.materials)){
                pr.materials.forEach(m=>{
                    if(!obj.materials.some(g=>g.id===m.id)){
                        m.printers = [String(pr.id)];
                        obj.materials.push(m);
                    }
                });
            }
            if(Array.isArray(pr.additional)){
                pr.additional.forEach(a=>{
                    if(!obj.additionalGlobal.some(g=>g.id===a.id)){
                        a.printers = [String(pr.id)];
                        obj.additionalGlobal.push(a);
                    }
                });
            }
            delete pr.materials;
            delete pr.additional;


        });

        // Удаляем дубликаты принтеров по имени или адресу
        const uniqList = [];
        const pMap = {};
        if(!Array.isArray(obj.printerProfiles)) obj.printerProfiles=[];
        obj.printers.forEach(pr=>{
            if(!Array.isArray(pr.profileIds)) pr.profileIds=[];
            if(Array.isArray(pr.orcaProfiles)){
                pr.orcaProfiles.forEach(op=>{
                    const pid=op.id||getNextId('printerProfiles');
                    obj.printerProfiles.push({id:pid,config:op.config||{},info:op.info||'',printerId:String(pr.id)});
                    if(!pr.profileIds.includes(pid)) pr.profileIds.push(pid);
                });
            } else if(pr.orca || pr.orcaInfo){
                const pid=getNextId('printerProfiles');
                obj.printerProfiles.push({id:pid,config:pr.orca||{},info:pr.orcaInfo||'',printerId:String(pr.id)});
                pr.profileIds.push(pid);
            }
            delete pr.orcaProfiles;
            delete pr.orca;
            delete pr.orcaInfo;
        });
        obj.printers.forEach(pr=>{
            const key = (pr.print_host||'').toLowerCase() + '|' + (pr.name||'').toLowerCase();
            const existing = pMap[key];
            if(existing){
                pr.profileIds.forEach(pid=>{
                    if(!existing.profileIds.includes(pid)){
                        existing.profileIds.push(pid);
                        const pf=obj.printerProfiles.find(x=>String(x.id)===String(pid));
                        if(pf) pf.printerId=String(existing.id);
                    }
                });
                ['cost','hoursToRecoup','power','maintCostHour'].forEach(f=>{ if(!existing[f] && pr[f]) existing[f]=pr[f]; });
            } else {
                pMap[key]=pr; uniqList.push(pr);
            }
        });
        obj.printers = uniqList;

        // Удаляем дубликаты материалов
        const uniqMat = [];
        const mMap = {};
        obj.materials.forEach(m=>{
            const key = String(m.id||'') + '|' + (m.name||'');
            if(!mMap[key]){ mMap[key]=m; uniqMat.push(m); }
        });
        obj.materials = uniqMat;

        // Удаляем дубликаты дополнительных расходов
        const uniqAdd = [];
        const aMap = {};
        obj.additionalGlobal.forEach(a=>{
            const key = String(a.id||'') + '|' + (a.description||'');
            if(!aMap[key]){ aMap[key]=a; uniqAdd.push(a); }
        });
        obj.additionalGlobal = uniqAdd;

        // Карта принтеров для поиска замены
        const idMap = {};
        obj.printers.forEach(pr=>{
            idMap[String(pr.id).toLowerCase()] = pr;
            if(pr.print_host) idMap[String(pr.print_host).toLowerCase()] = pr;
            if(pr.name) idMap[pr.name.toLowerCase()] = pr;
            (pr.profileIds||[]).forEach(pid=>{
                const pf=obj.printerProfiles.find(x=>String(x.id)===String(pid));
                const cfg=pf?pf.config||{}:{};
                if(cfg.printer_settings_id) idMap[String(cfg.printer_settings_id).toLowerCase()] = pr;
                if(cfg.name) idMap[String(cfg.name).toLowerCase()] = pr;
            });
        });
        function ensurePrinter(ref){
            if(!ref) return null;
            return idMap[String(ref).toLowerCase()] || null;
        }

        // Обновление истории расчётов и calcData
        obj.calcHistory.forEach(h=>{
            if(h.nalogInn) delete h.nalogInn;
            if(Array.isArray(h.nalogReceipts)){
                h.nalogReceipts = h.nalogReceipts.map(r=>({uuid:r.uuid, canceled: !!r.canceled}));
            }
            if(!h.markupPercent) h.markupPercent = 0;
            if(!h.discountPercent) h.discountPercent = 0;
            if(!h.globalAdditional) h.globalAdditional = {sumGlobalAdd:0,taxAmount:0,details:[]};
            if(typeof h.downtimeMinutes !== 'number') h.downtimeMinutes = 0;
            if(typeof h.coolingMinutes !== 'number') h.coolingMinutes = h.downtimeMinutes || 0;
            if(typeof h.printerPrepMinutes !== 'number') h.printerPrepMinutes = 0;
            if(typeof h.downtimeCost !== 'number') h.downtimeCost = 0;
            if(typeof h.preparationTime !== 'number') h.preparationTime = 0;
            if(typeof h.preparationCost !== 'number') h.preparationCost = 0;
            if(Array.isArray(h.details)){
                h.details.forEach(d=>{
                    let pr = ensurePrinter(d.printerId) || ensurePrinter(d.printerName?.toLowerCase());
                    if(pr){
                        d.printerId = pr.id;
                        d.printerName = pr.name;
                    } else {
                        unresolved.push({history:h,ref:d.printerId,origName:d.printerName||d.printerId,model:d.modelName||''});
                    }
                });
            }
            if(h.calcData){
                const newCD = {};
                for(const pid in h.calcData){
                    let pr = ensurePrinter(pid);
                    if(!pr){
                        const det = (h.details||[]).find(d=>String(d.printerId)===String(pid));
                        pr = det? ensurePrinter(det.printerId) : null;
                    }
                    if(pr){
                        newCD[pr.id] = h.calcData[pid];
                    } else {
                        const det = (h.details||[]).find(d=>String(d.printerId)===String(pid));
                        unresolved.push({history:h,ref:pid,origName:pid,model:det?det.modelName||'':''});
                        newCD[pid] = h.calcData[pid];
                    }
                }
                h.calcData = newCD;
            }
        });

        // Перенос клиентов из истории
        const nameMap = {};
        obj.calcHistory.forEach(h=>{
            const nm = h.clientName;
            if(!nm) return;
            let c = obj.clients.find(x=>x.name===nm);
            if(!c){
                if(nameMap[nm]){
                    c = nameMap[nm];
                }else{
                    c = {id: getNextId('clients'), name: nm};
                    obj.clients.push(c);
                    nameMap[nm] = c;
                }
            }
            if(!h.clientId) h.clientId = c.id;
        });

        obj.materials.forEach(m=>{ if(!m.printers) m.printers=[]; });
        if(!Array.isArray(obj.materialProfiles)) obj.materialProfiles=[];
        obj.materials.forEach(m=>{
            if(typeof m.coolingTime !== 'number') m.coolingTime = 0;
            if(typeof m.printerPrepMinutes !== 'number') m.printerPrepMinutes = 0;
            if(!Array.isArray(m.profileIds)) m.profileIds=[];
            if(m.orca || m.orcaInfo){
                const pf={id:getNextId('materialProfiles'),config:m.orca||{},info:m.orcaInfo||''};
                obj.materialProfiles.push(pf);
                m.profileIds.push(pf.id);
            }
            delete m.orca;
            delete m.orcaInfo;
        });
        obj.additionalGlobal.forEach(a=>{ if(!a.printers) a.printers=[]; });
        if(!Array.isArray(obj.printerProfiles)) obj.printerProfiles=[];
        obj.printers.forEach(p=>{ if(!Array.isArray(p.profileIds)) p.profileIds=[]; });

        // Удаляем временные принтеры без использования
        const used = new Set();
        obj.calcHistory.forEach(h=>{
            if(Array.isArray(h.details)) h.details.forEach(d=> used.add(String(d.printerId)) );
            if(h.calcData) Object.keys(h.calcData).forEach(pid=> used.add(String(pid)) );
        });
        obj.printers = obj.printers.filter(p=> !p.isTemp || used.has(String(p.id)) );
        return obj;
    }

    const __modalQueue = (() => {
        let chain = Promise.resolve();
        return {
            run(task){
                const next = chain.then(task, task);
                chain = next.catch(()=>{});
                return next;
            }
        };
    })();

    function __cleanupModalArtifacts() {
        try {
            const backdrops = Array.from(document.querySelectorAll('.modal-backdrop'));
            if (backdrops.length > 1) backdrops.slice(1).forEach(b => b.remove());

            const anyShown = document.querySelector('.modal.show');
            if (!anyShown) {
                // hard reset if nothing is open
                backdrops.forEach(b => b.remove());
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
            }
        } catch (e) {
            console.warn('cleanupModalArtifacts failed', e);
        }
    }

    function __waitModalHidden(modalEl) {
        return new Promise(resolve => {
            const handler = () => {
                modalEl.removeEventListener('hidden.bs.modal', handler);
                __cleanupModalArtifacts();
                resolve();
            };
            modalEl.addEventListener('hidden.bs.modal', handler);
        });
    }

    const PromptMemory = (() => {
        const KEY = 'gcodecalc_prompt_memory_v1';
        let data = { printerMap: {}, materialMap: {}, orderAuto: null };

        function load() {
            try {
                const raw = localStorage.getItem(KEY);
                if (!raw) return;
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed === 'object') {
                    data.printerMap = parsed.printerMap && typeof parsed.printerMap === 'object' ? parsed.printerMap : {};
                    data.materialMap = parsed.materialMap && typeof parsed.materialMap === 'object' ? parsed.materialMap : {};
                    data.orderAuto = parsed.orderAuto && typeof parsed.orderAuto === 'object' ? parsed.orderAuto : null;
                }
            } catch (e) {
                console.warn('PromptMemory load failed', e);
            }
        }
        function save() {
            try { localStorage.setItem(KEY, JSON.stringify(data)); } catch (e) {}
        }
        function clear() {
            data = { printerMap: {}, materialMap: {}, orderAuto: null };
            try { localStorage.removeItem(KEY); } catch(e) {}
        }

        function getPrinter(key) {
            if (!key) return '';
            return data.printerMap[key] ? String(data.printerMap[key]) : '';
        }
        function setPrinter(key, printerId) {
            if (!key || !printerId) return;
            data.printerMap[key] = String(printerId);
            save();
        }
        function forgetPrinter(key) {
            if (!key) return;
            delete data.printerMap[key];
            save();
        }

        function getMaterial(profile) {
            if (!profile) return '';
            return data.materialMap[profile] ? String(data.materialMap[profile]) : '';
        }
        function setMaterial(profile, materialId) {
            if (!profile || !materialId) return;
            data.materialMap[profile] = String(materialId);
            save();
        }
        function forgetMaterial(profile) {
            if (!profile) return;
            delete data.materialMap[profile];
            save();
        }

        function getOrderAuto() {
            return data.orderAuto && typeof data.orderAuto === 'object' ? data.orderAuto : null;
        }
        function setOrderAuto(orderAuto) {
            data.orderAuto = orderAuto || null;
            save();
        }
        function consumeOrderAuto() {
            if (!data.orderAuto) return;
            if (typeof data.orderAuto.remaining !== 'number') { data.orderAuto = null; save(); return; }
            data.orderAuto.remaining -= 1;
            if (data.orderAuto.remaining <= 0) data.orderAuto = null;
            save();
        }

        function stats() {
            const printers = Object.keys(data.printerMap || {}).length;
            const materials = Object.keys(data.materialMap || {}).length;
            const order = data.orderAuto ? `, авто-заказ: ${data.orderAuto.kind || '—'} (${data.orderAuto.remaining || 0})` : '';
            return `Принтеры: ${printers}, материалы: ${materials}${order}`;
        }

        load();
        return {
            clear, stats,
            getPrinter, setPrinter, forgetPrinter,
            getMaterial, setMaterial, forgetMaterial,
            getOrderAuto, setOrderAuto, consumeOrderAuto
        };
    })()

    function renderPromptMemoryStats(){
        const el = document.getElementById('promptMemoryStats');
        if(el) el.textContent = PromptMemory.stats();
    }

    function initPromptMemoryUi(){
        const btn = document.getElementById('clearPromptMemoryBtn');
        if(btn && !btn.__bound){
            btn.__bound = true;
            btn.addEventListener('click', () => {
                PromptMemory.clear();
                renderPromptMemoryStats();
                alert('Сохранённые ответы модалок импорта очищены.');
            });
        }
        renderPromptMemoryStats();
    }

    ;


    function showMultiPrompt(title, fields){
        return __modalQueue.run(() => new Promise(res=>{
            const body = document.getElementById('multiPromptBody');
            body.innerHTML = '';
            document.getElementById('multiPromptTitle').textContent = title;

            const elements = [];

            (fields||[]).forEach(f=>{
                if(!f) return;

                if(f.type==='html'){
                    const div=document.createElement('div');
                    div.className = f.className || 'mb-3';
                    div.innerHTML = f.html || '';
                    body.appendChild(div);
                    return;
                }

                const wrap=document.createElement('div');
                wrap.className = (f.type==='checkbox') ? 'form-check mb-2' : 'mb-2';

                const id = 'mp_' + f.id;

                let el=null;

                if(f.type==='checkbox'){
                    el=document.createElement('input');
                    el.type='checkbox';
                    el.className='form-check-input';
                    el.id=id;
                    el.checked=!!f.value;

                    const lbl=document.createElement('label');
                    lbl.className='form-check-label ms-2';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    wrap.appendChild(el);
                    wrap.appendChild(lbl);
                } else if(f.type==='multiselect'){
                    const lbl=document.createElement('label');
                    lbl.className='form-label';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    el=document.createElement('select');
                    el.className='form-select';
                    el.multiple=true;
                    el.id=id;
                    (f.options||[]).forEach(opt=>{
                        const o=document.createElement('option');
                        o.value=opt.value;
                        o.textContent=opt.label;
                        if(Array.isArray(f.value) && f.value.includes(opt.value)) o.selected=true;
                        el.appendChild(o);
                    });

                    wrap.appendChild(lbl);
                    wrap.appendChild(el);
                } else if(f.type==='select'){
                    const lbl=document.createElement('label');
                    lbl.className='form-label';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    el=document.createElement('select');
                    el.className='form-select';
                    el.id=id;

                    (f.options||[]).forEach(opt=>{
                        const o=document.createElement('option');
                        o.value=opt.value;
                        o.textContent=opt.label;
                        if(String(f.value ?? '') === String(opt.value)) o.selected=true;
                        el.appendChild(o);
                    });

                    wrap.appendChild(lbl);
                    wrap.appendChild(el);
                } else if(f.type==='textarea'){
                    const lbl=document.createElement('label');
                    lbl.className='form-label';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    el=document.createElement('textarea');
                    el.className='form-control';
                    el.id=id;
                    el.rows=f.rows||3;
                    el.value=f.value||'';

                    wrap.appendChild(lbl);
                    wrap.appendChild(el);
                } else if(f.type==='number'){
                    const lbl=document.createElement('label');
                    lbl.className='form-label';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    el=document.createElement('input');
                    el.type='number';
                    el.className='form-control';
                    el.id=id;
                    if (f.min !== undefined) el.min = String(f.min);
                    if (f.max !== undefined) el.max = String(f.max);
                    if (f.step !== undefined) el.step = String(f.step);
                    el.value = (f.value !== undefined && f.value !== null) ? String(f.value) : '';

                    wrap.appendChild(lbl);
                    wrap.appendChild(el);
                } else {
                    const lbl=document.createElement('label');
                    lbl.className='form-label';
                    lbl.setAttribute('for', id);
                    lbl.textContent=f.label||'';

                    el=document.createElement('input');
                    el.type=f.type||'text';
                    el.className='form-control';
                    el.id=id;
                    el.value=f.value||'';
                    if (f.placeholder) el.placeholder = f.placeholder;

                    wrap.appendChild(lbl);
                    wrap.appendChild(el);
                }

                if (el && f.disabled) el.disabled = true;

                if (f.help) {
                    const help=document.createElement('div');
                    help.className='form-text';
                    help.textContent = f.help;
                    wrap.appendChild(help);
                }

                if (el && typeof f.onChange === 'function') {
                    el.addEventListener('change', () => f.onChange(el));
                }

                body.appendChild(wrap);

                if(el) elements.push({field:f, el});
            });

            const modalEl = document.getElementById('multiPromptModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

            let finalResult = null;

            const okBtn = document.getElementById('multiPromptOk');
            const prevOnClick = okBtn.onclick;

            function cleanup(){
                okBtn.onclick = prevOnClick;
                __cleanupModalArtifacts();
            }

            modalEl.addEventListener('hidden.bs.modal', () => {
                cleanup();
                res(finalResult);
            }, { once: true });

            okBtn.onclick = () => {
                const result = {};
                elements.forEach(({field, el})=>{
                    if (!field || field.type === 'html') return;
                    if(field.type==='checkbox') result[field.id] = el.checked;
                    else if(field.type==='multiselect') result[field.id] = Array.from(el.selectedOptions).map(o=>o.value);
                    else if(field.type==='select') result[field.id] = el.value;
                    else if(field.type==='textarea') result[field.id] = el.value;
                    else if(field.type==='number') result[field.id] = el.value === '' ? '' : Number(el.value);
                    else result[field.id] = el.value;
                });
                finalResult = result;
                modal.hide();
            };

            __cleanupModalArtifacts();

            modal.show();
        }));
    }

    function showMaterialSelectionForGcode(fileName, thumbnail, materialOptions, profile){
        const safeProfile = (profile || '').trim();
        const infoHtml = (() => {
            const thumb = thumbnail ? `<img src="data:image/png;base64,${thumbnail}" style="width:80px;height:80px;object-fit:contain;border:1px solid #ccc;border-radius:4px;margin-bottom:10px;display:block;">` : '';
            const prof = safeProfile ? `<div class="small text-muted"><strong>Профиль:</strong> ${escapeHtml(safeProfile)}</div>` : '';
            return `
                <div class="mb-2 p-3 border rounded bg-light">
                    ${thumb}
                    <div class="mb-1"><strong>Файл:</strong> ${escapeHtml(fileName||'')}</div>
                    ${prof}
                </div>`;
        })();

        const options = [{value:'', label:'-- Выберите материал --'}].concat(materialOptions||[]);

        const rememberLabel = safeProfile
            ? `Сохранить выбор для профиля «${safeProfile}»`
            : 'Сохранить выбор для этого профиля';

        return showMultiPrompt('Выберите материал для модели', [
            { type:'html', html: infoHtml },
            { id:'materialId', label:'Материал', type:'select', options, value:'' },
            { id:'remember', label: rememberLabel, type:'checkbox', value:false }
        ]).then(r=>{
            if(!r || !r.materialId) return null;
            return { materialId: r.materialId, remember: !!r.remember };
        });
    }

    function populatePrintersSelect(sel, selected){
        sel.innerHTML='';
        appData.printers.forEach(p=>{
            const opt=document.createElement('option');
            opt.value=p.id;
            opt.textContent=p.name;
            if(selected && selected.some(id => String(id) === String(p.id))) opt.selected=true;
            sel.appendChild(opt);
        });
    }

    function collectUnresolvedPrinters(){
        const idSet=new Set(appData.printers.map(p=>String(p.id)));
        const list=[];
        appData.calcHistory.forEach(h=>{
            if(Array.isArray(h.details)) h.details.forEach(d=>{
                if(!idSet.has(String(d.printerId))){
                    list.push({history:h,ref:d.printerId,origName:d.printerName||d.printerId,model:d.modelName||''});
                }
            });
            if(h.calcData){
                for(const pid in h.calcData){
                    if(!idSet.has(String(pid))){
                        const det=(h.details||[]).find(dd=>String(dd.printerId)===String(pid));
                        list.push({history:h,ref:pid,origName:pid,model:det?det.modelName||'':''});
                    }
                }
            }
        });
        return list;
    }

    function isPrinterUsedInHistory(printerId){
        const pid = String(printerId);
        const history = Array.isArray(appData.calcHistory) ? appData.calcHistory : [];
        return history.some(h => {
            const details = Array.isArray(h.details)
                ? h.details
                : (Array.isArray(h.detailsByPrinter) ? h.detailsByPrinter : []);
            if (details.some(d => String(d.printerId) === pid)) return true;
            if (h.calcData && Object.prototype.hasOwnProperty.call(h.calcData, pid)) return true;
            return false;
        });
    }

    function showPrinterMapModal(list){
        if(!list || list.length===0) return;
        const tbody=document.querySelector('#printerMapTable tbody');
        tbody.innerHTML='';
        list.forEach((rec,i)=>{
            const h=rec.history;
            const tr=document.createElement('tr');
            tr.dataset.index=i;
            tr.innerHTML=`<td><input type="checkbox" class="form-check-input"></td>`+
                `<td>${new Date(h.timestamp||0).toLocaleString()}</td>`+
                `<td>${h.id||''}</td>`+
                `<td>${h.calcName||''}</td>`+
                `<td>${h.clientName||''}</td>`+
                `<td>${h.orderStatus||''}</td>`+
                `<td>${safeFixed(h.total||0)}</td>`+
                `<td>${rec.model||''}</td>`+
                `<td>${rec.origName}</td>`+
                '<td></td>';
            const sel=document.createElement('select');
            populatePrintersSelect(sel);
            tr.lastChild.appendChild(sel);
            tbody.appendChild(tr);
        });
        const bulkSel=document.getElementById('bulkPrinterSelect');
        populatePrintersSelect(bulkSel);
        document.getElementById('applyBulkMap').onclick=()=>{
            const rows=tbody.querySelectorAll('tr');
            rows.forEach(row=>{
                if(row.querySelector('input[type=checkbox]').checked){
                    const sel=row.querySelector('select');
                    sel.value=bulkSel.value;
                }
            });
        };
        const modal=new bootstrap.Modal(document.getElementById('printerMapModal'));
        document.getElementById('printerMapSave').onclick=()=>{
            const rows=tbody.querySelectorAll('tr');
            rows.forEach(row=>{
                const idx=parseInt(row.dataset.index,10);
                const sel=row.querySelector('select');
                const entry=list[idx];
                const target=appData.printers.find(p=>String(p.id)===String(sel.value));
                if(target){
                    const hist=entry.history;
                    if(Array.isArray(hist.details)) hist.details.forEach(d=>{
                        if(String(d.printerId)===String(entry.ref) || d.printerName===entry.origName){
                            d.printerId=target.id; d.printerName=target.name;
                        }
                    });
                    if(hist.calcData && hist.calcData[entry.ref]){
                        hist.calcData[target.id]=hist.calcData[entry.ref];
                        delete hist.calcData[entry.ref];
                    }
                }
            });
            modal.hide();
            renderHistoryTable();
            renderPrintersTable();
            saveToLocalStorage();
        };
        modal.show();
    }

    function printerNameById(id){
        const p=appData.printers.find(pr=>String(pr.id)===String(id));
        return p? p.name : id;
    }

    function profileNameById(pid){
        const pf=appData.materialProfiles.find(p=>String(p.id)===String(pid));
        if(!pf) return pid;
        const cfg=pf.config||{};
        return String(cfg.filament_settings_id||cfg.name||pid);
    }

    function textColorForBg(hex){
        if(!hex) return '#000';
        hex=hex.replace('#','');
        if(hex.length===3){ hex=hex.split('').map(c=>c+c).join(''); }
        const r=parseInt(hex.substr(0,2),16);
        const g=parseInt(hex.substr(2,2),16);
        const b=parseInt(hex.substr(4,2),16);
        const yiq=(r*299+g*587+b*114)/1000;
        return yiq>128?'#000':'#fff';
    }

    const STORAGE_KEY = "ThreeDPrintCalc_Extended_v5";
    const STORAGE_HISTORY_KEY = `${STORAGE_KEY}_history`;
    const CURRENT_SCHEMA_VERSION = 2;
    const migrationState = {
        needsMigration: false,
        rawData: null,
        backupDone: false,
        inProgress: false
    };
    window.migrationState = migrationState;
    const OPERATOR_PERIOD_ROWS = 5;
    const DEFAULT_OPERATOR_PERIODS = [
        {start: "10:00", end: "13:00"},
        {start: "14:00", end: "17:00"}
    ];
    const FAST_OPERATOR_PERIODS = [
        {start: "09:00", end: "13:00"},
        {start: "13:30", end: "18:30"}
    ];
    const RUSH_OPERATOR_PERIODS = [
        {start: "08:00", end: "14:00"},
        {start: "14:30", end: "20:30"}
    ];
    const DEFAULT_WORKING_DAYS = [1, 2, 3, 4, 5];
    const WEEKDAY_LABELS = [
        {value: 1, label: 'Пн'},
        {value: 2, label: 'Вт'},
        {value: 3, label: 'Ср'},
        {value: 4, label: 'Чт'},
        {value: 5, label: 'Пт'},
        {value: 6, label: 'Сб'},
        {value: 0, label: 'Вс'}
    ];
    const createScheduleFromPeriods = (periods, workingDays = DEFAULT_WORKING_DAYS) => {
        const map = {};
        WEEKDAY_LABELS.forEach(day => {
            map[day.value] = workingDays.includes(day.value)
                ? periods.map(p => ({start: p.start, end: p.end}))
                : [];
        });
        return map;
    };
    const DEFAULT_URGENCY_PROFILES = [
        {
            id: 'standard',
            title: 'Стандарт',
            markupPercent: 0,
            description: 'Обычные сроки, пятидневка',
            schedule: createScheduleFromPeriods(DEFAULT_OPERATOR_PERIODS),
            workingDays: [...DEFAULT_WORKING_DAYS]
        },
        {
            id: 'fast',
            title: 'Быстрый',
            markupPercent: 30,
            description: 'Ускоренный режим, сокращённый обед',
            schedule: createScheduleFromPeriods(FAST_OPERATOR_PERIODS),
            workingDays: [...DEFAULT_WORKING_DAYS]
        },
        {
            id: 'rush',
            title: 'Срочный',
            markupPercent: 100,
            description: 'Работаем 12 часов в сутки, минимальные перерывы',
            schedule: createScheduleFromPeriods(RUSH_OPERATOR_PERIODS, [1,2,3,4,5,6]),
            workingDays: [1,2,3,4,5,6]
        }
    ];
    let urgencyProfilesDraft = [];
    let currentUrgencyProfileId = null;
    let appData = {
        printers: [
            {
                id: 1,
                name: "FF5M",
                cost: 35000,
                hoursToRecoup: 500,
                power: 350,
                maintCostHour: 5,
                profileIds: []
            }
        ],
        // Глобальные материалы: добавлены новые поля: balance (остаток), declaredWeight, manufacturer, productionDate
        materials: [
            // Пример материала
            // { id: 1001, name: "PLA", costPerKg: 150, balance: 10, declaredWeight: 1, waste_percent: 5, manufacturer: "XYZ", productionDate: "01.01.2025", printers: [] }
        ],
        materialProfiles: [],
        printerProfiles: [],
        additionalGlobal: [],
        calcSettings: {
            operatorRate: 200,
            costKwh: 6,
            shipping: 300,
            taxPercent: 6,
            parallelPrinting: "no",
            deadlineDate: "",
            markupPercent: 0,
            discountPercent: 0,
            downtimeCost: 0,
            preparationRate: 0,
            preparationTime: 0,
            includeOperatorForRejects: false,
            includeAmortization: true,
            includeRejects: true,
            includeOverheads: true,
            ignoreCoolingRejects: false,
            includeEstimatePrint: false,
            estimatePrintCost: 0,
            customServices: [],
            currentUrgencyId: 'standard'
        },
        labelSettings: {
            companyName: "Компания",
            companyLogo: "",
            chatLink: "https://t.me/dur",
            bankDetails: "",
            costPerLabel: 0,
            printLabels: false,
            urgencyProfiles: DEFAULT_URGENCY_PROFILES.map(p => ({
                id: p.id,
                title: p.title,
                markupPercent: p.markupPercent,
                description: p.description,
                schedule: JSON.parse(JSON.stringify(p.schedule)),
                workingDays: [...p.workingDays]
            }))
        },
        clients: [],
        calcHistory: [],
        migrationInfo: {},
        schemaVersion: CURRENT_SCHEMA_VERSION
    };
    window.appData = appData;

    function setAppData(next) {
        appData = next || {};
        window.appData = appData;
    }

    function isLegacySchema(obj) {
        if (!obj || typeof obj !== 'object') return false;
        const version = parseInt(obj.schemaVersion, 10);
        if (!Number.isNaN(version)) {
            return version < CURRENT_SCHEMA_VERSION;
        }
        const calcSettings = obj.calcSettings || {};
        if ('workHoursDay' in calcSettings || 'modelingRate' in calcSettings || 'modelingCost' in calcSettings) return true;
        if (Array.isArray(obj.calcHistory)) {
            for (const entry of obj.calcHistory) {
                if (!entry || typeof entry !== 'object') continue;
                if ('timelineScheduleSummary' in entry ||
                    'actualFinishDate' in entry ||
                    'deadlineMet' in entry ||
                    'priceBeforeDiscount' in entry ||
                    'rounding' in entry ||
                    'operatorWorkCost' in entry ||
                    'downtimeCost' in entry ||
                    'preparationCost' in entry ||
                    'rejectHours' in entry ||
                    'rejectWeight' in entry ||
                    'autoSelectedUrgencyId' in entry) {
                    return true;
                }
            }
        }
        return false;
    }

    window.isLegacySchema = isLegacySchema;

    function ensureAppDataDefaults(obj) {
        if (!obj || typeof obj !== 'object') obj = {};
        const allowedMassModes = ['used','remaining','measured'];
        const normalizeOptionalNumber = (val) => {
            if (val === null || val === undefined || val === '') return null;
            const parsed = parseFloat(val);
            return Number.isFinite(parsed) ? parsed : null;
        };
        if (!Array.isArray(obj.printers)) obj.printers = [];
        if (!Array.isArray(obj.materials)) obj.materials = [];
        if (!Array.isArray(obj.materialProfiles)) obj.materialProfiles = [];
        if (!Array.isArray(obj.additionalGlobal)) obj.additionalGlobal = [];
        if (!Array.isArray(obj.clients)) obj.clients = [];
        if (!Array.isArray(obj.calcHistory)) obj.calcHistory = [];
        obj.materials.forEach(m => {
            if (!m.printers) m.printers = [];
            if (!allowedMassModes.includes(m.massInputMode)) {
                m.massInputMode = 'used';
            }
            m.emptySpoolWeight = normalizeOptionalNumber(m.emptySpoolWeight);
            m.usedWeightGrams = normalizeOptionalNumber(m.usedWeightGrams);
            m.remainingWeightGrams = normalizeOptionalNumber(m.remainingWeightGrams);
            m.measuredWeightGrams = normalizeOptionalNumber(m.measuredWeightGrams);
        });
        obj.additionalGlobal.forEach(a => {
            if (!a.printers) a.printers = [];
        });
        if (!obj.labelSettings) obj.labelSettings = {};
        if ('paymentInfo' in obj.labelSettings && !('bankDetails' in obj.labelSettings)) {
            obj.labelSettings.bankDetails = obj.labelSettings.paymentInfo;
            delete obj.labelSettings.paymentInfo;
        }
        if (!('companyName' in obj.labelSettings)) obj.labelSettings.companyName = 'Моя компания';
        if (!('companyLogo' in obj.labelSettings)) obj.labelSettings.companyLogo = '';
        if (!('bankDetails' in obj.labelSettings)) obj.labelSettings.bankDetails = '';
        if (!Array.isArray(obj.labelSettings.urgencyProfiles) || !obj.labelSettings.urgencyProfiles.length) {
            const legacySchedule = obj.labelSettings.operatorSchedule || createScheduleFromPeriods(DEFAULT_OPERATOR_PERIODS);
            const legacyWorking = Array.isArray(obj.labelSettings.operatorWorkingDays) && obj.labelSettings.operatorWorkingDays.length
                ? obj.labelSettings.operatorWorkingDays
                : [...DEFAULT_WORKING_DAYS];
            const fallback = {
                id: 'standard',
                title: 'Стандарт',
                markupPercent: 0,
                description: 'Обычные сроки, пятидневка',
                schedule: Object.keys(legacySchedule).length ? legacySchedule : createScheduleFromPeriods(DEFAULT_OPERATOR_PERIODS),
                workingDays: legacyWorking
            };
            const extra = DEFAULT_URGENCY_PROFILES.filter(p => p.id !== 'standard').map(p => ({
                id: p.id,
                title: p.title,
                markupPercent: p.markupPercent,
                description: p.description,
                schedule: JSON.parse(JSON.stringify(p.schedule)),
                workingDays: [...p.workingDays]
            }));
            obj.labelSettings.urgencyProfiles = [fallback, ...extra];
        }
        delete obj.labelSettings.operatorSchedule;
        delete obj.labelSettings.operatorWorkingDays;
        if (!obj.calcSettings) obj.calcSettings = {};
        if (!obj.calcSettings.currentUrgencyId) {
            const firstProfile = Array.isArray(obj.labelSettings.urgencyProfiles) && obj.labelSettings.urgencyProfiles.length
                ? obj.labelSettings.urgencyProfiles[0].id
                : 'standard';
            obj.calcSettings.currentUrgencyId = firstProfile;
        }
        if (!Array.isArray(obj.calcSettings.customServices)) obj.calcSettings.customServices = [];
        if (!obj.migrationInfo) obj.migrationInfo = {};
        if (!obj.schemaVersion) obj.schemaVersion = CURRENT_SCHEMA_VERSION;
        return obj;
    }

    function buildConfigSnapshotForStorage(data) {
        try {
            const snapshot = JSON.parse(JSON.stringify(data || {}));
            if (snapshot && snapshot.calcHistory) delete snapshot.calcHistory;
            return snapshot;
        } catch (e) {
            console.warn('buildConfigSnapshotForStorage.failed', e);
            const fallback = Object.assign({}, data);
            if (fallback && fallback.calcHistory) delete fallback.calcHistory;
            return fallback;
        }
    }

    function loadHistoryLayer() {
        try {
            const raw = localStorage.getItem(STORAGE_HISTORY_KEY);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) return parsed;
            if (parsed && Array.isArray(parsed.calcHistory)) return parsed.calcHistory;
        } catch (e) {
            console.warn('historyLayer.load.failed', e);
        }
        return null;
    }

    function persistHistoryLayer(history) {
        try {
            const payload = Array.isArray(history) ? history : [];
            localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(payload));
        } catch (e) {
            console.warn('historyLayer.save.failed', e);
        }
    }

    function hydrateCalcHistoryFromLayers(debugInfo) {
        let historySource = 'inline';
        let historyData = Array.isArray(appData && appData.calcHistory) ? appData.calcHistory : [];
        const layer = loadHistoryLayer();
        if (Array.isArray(layer)) {
            historyData = layer;
            historySource = 'layer';
        } else if (historyData.length) {
            persistHistoryLayer(historyData);
        }
        if (!Array.isArray(historyData)) historyData = [];
        appData.calcHistory = historyData;
        if (debugInfo) {
            debugInfo.historyLen = historyData.length;
            debugInfo.historySource = historySource;
        }
    }

    function loadFromLocalStorage() {
        const debugInfo = {
            rawLen: 0,
            parsed: false,
            legacy: false,
            schemaVersion: null,
            error: null,
            needsMigration: false,
            historySource: 'none',
            historyLen: 0
        };
        try {
            const s = localStorage.getItem(STORAGE_KEY);
            debugInfo.rawLen = s ? s.length : 0;
            if (s) {
                const p = JSON.parse(s);
                debugInfo.parsed = true;
                debugInfo.schemaVersion = (p && p.schemaVersion !== undefined) ? p.schemaVersion : null;
                migrationState.needsMigration = false;
                migrationState.rawData = null;
                migrationState.backupDone = false;
                migrationState.inProgress = false;
                if (p && isLegacySchema(p)) {
                    migrationState.needsMigration = true;
                    migrationState.rawData = s;
                    debugInfo.legacy = true;
                    debugInfo.needsMigration = true;
                    setAppData(ensureAppDataDefaults(p));
                    hydrateCalcHistoryFromLayers(debugInfo);
                    window.__migrationDebug = debugInfo;
                    return;
                }
                if (p) {
                    setAppData(ensureAppDataDefaults(migrateOldData(p)));
                }
                debugInfo.needsMigration = false;
            }
        } catch (e) {
            debugInfo.error = e && e.message ? e.message : String(e);
        }
        if (!appData.schemaVersion) {
            appData.schemaVersion = CURRENT_SCHEMA_VERSION;
            appData.migrationInfo = appData.migrationInfo || {};
        }
        hydrateCalcHistoryFromLayers(debugInfo);
        window.__migrationDebug = debugInfo;
    }

    loadFromLocalStorage();

    function saveToLocalStorage(options = {}) {
        if (appData && typeof appData === 'object') {
            appData.schemaVersion = CURRENT_SCHEMA_VERSION;
            appData.migrationInfo = appData.migrationInfo || {};
        }
        const historySnapshot = Array.isArray(appData && appData.calcHistory) ? appData.calcHistory : [];
        const configSnapshot = buildConfigSnapshotForStorage(appData);
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(configSnapshot));
        } catch (e) {
            console.error('saveToLocalStorage.config.failed', e);
        }
        if (options && options.skipHistory === true) return;
        persistHistoryLayer(historySnapshot);
    }

    function showSchemaMigrationOverlay() {
        const overlay = document.getElementById('schemaMigrationOverlay');
        if (!overlay) return;
        overlay.classList.add('show');
        updateSchemaMigrationUi();
    }

    function hideSchemaMigrationOverlay() {
        const overlay = document.getElementById('schemaMigrationOverlay');
        if (!overlay) return;
        overlay.classList.remove('show');
    }

    function updateSchemaMigrationUi() {
        const backupStatus = document.getElementById('schemaMigrationBackupStatus');
        const progress = document.getElementById('schemaMigrationProgress');
        const errorEl = document.getElementById('schemaMigrationError');
        const backupBtn = document.getElementById('schemaMigrationBackupBtn');
        const startBtn = document.getElementById('schemaMigrationStartBtn');
        if (backupStatus) {
            backupStatus.textContent = migrationState.backupDone
                ? 'Резервная копия сохранена. Можно переходить к шагу 2.'
                : 'Шаг 1: сохраните текущие данные.';
        }
        if (progress) {
            progress.textContent = migrationState.inProgress ? 'Идёт обновление. Пожалуйста, не закрывайте окно.' : '';
        }
        if (backupBtn) {
            backupBtn.disabled = migrationState.inProgress;
        }
        if (startBtn) {
            startBtn.disabled = !migrationState.backupDone || migrationState.inProgress;
            startBtn.textContent = migrationState.inProgress ? 'Обновляем...' : 'Обновить данные';
        }
        if (errorEl && errorEl.dataset.dismissOnUpdate === 'true') {
            errorEl.textContent = '';
            delete errorEl.dataset.dismissOnUpdate;
        }
    }

    function handleSchemaMigrationBackup() {
        if (!migrationState.rawData) return;
        const errorEl = document.getElementById('schemaMigrationError');
        if (errorEl) {
            errorEl.textContent = '';
        }
        try {
            const stamp = new Date().toISOString().replace(/[:.]/g, '-');
            const blob = new Blob([migrationState.rawData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `gcodecalc_backup_${stamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 500);
            migrationState.backupDone = true;
            updateSchemaMigrationUi();
        } catch (e) {
            if (errorEl) {
                errorEl.textContent = 'Не удалось сохранить резервную копию: ' + (e && e.message ? e.message : String(e));
            }
        }
    }

    function handleSchemaMigrationStart() {
        const errorEl = document.getElementById('schemaMigrationError');
        if (errorEl) errorEl.textContent = '';
        if (!migrationState.backupDone) {
            if (errorEl) {
                errorEl.textContent = 'Сначала скачайте резервную копию.';
                errorEl.dataset.dismissOnUpdate = 'true';
            }
            return;
        }
        if (!migrationState.rawData) {
            if (errorEl) {
                errorEl.textContent = 'Нет данных для миграции.';
            }
            return;
        }
        migrationState.inProgress = true;
        updateSchemaMigrationUi();
        setTimeout(() => {
            try {
                const parsed = JSON.parse(migrationState.rawData);
                let next = ensureAppDataDefaults(migrateOldData(parsed));
                next.schemaVersion = CURRENT_SCHEMA_VERSION;
                next.migrationInfo = next.migrationInfo || {};
                next.migrationInfo.lastMigrationAt = new Date().toISOString();
                normalizeIds(next);
                setAppData(next);
                saveToLocalStorage();
                migrationState.needsMigration = false;
                migrationState.rawData = null;
                migrationState.backupDone = false;
                migrationState.inProgress = false;
                hideSchemaMigrationOverlay();
                completeAppInitialization();
                if (window.backupBridge && typeof window.backupBridge.notify === 'function') {
                    window.backupBridge.notify({type: 'migrationComplete'});
                }
            } catch (e) {
                console.error('schema migration failed', e);
                window.__lastMigrationError = {
                    message: (e && e.message) ? e.message : String(e),
                    stack: e && e.stack ? e.stack : null
                };
                migrationState.inProgress = false;
                if (errorEl) {
                    errorEl.textContent = 'Не удалось обновить данные: ' + (e && e.message ? e.message : String(e)) + '. Резервная копия сохранена у вас. Попробуйте позже или импортируйте файл вручную.';
                }
                try {
                    localStorage.removeItem(STORAGE_HISTORY_KEY);
                    if (migrationState.rawData) localStorage.setItem(STORAGE_KEY, migrationState.rawData);
                } catch {
                }
                updateSchemaMigrationUi();
            }
        }, 50);
    }
    function initAll(){
        loadFromLocalStorage();
        if (migrationState.needsMigration) {
            showSchemaMigrationOverlay();
            return;
        }
        completeAppInitialization();
    }

    function completeAppInitialization() {
        hideSchemaMigrationOverlay();
        resetCalculationInsights();

        const validationResult = validateUniqueIds(appData);
        if (!validationResult.success) {
            console.log("ID validation failed, auto-normalizing:", validationResult.errors);
            normalizeIds(appData);
            saveToLocalStorage();
        }

        renderPrintersTable();
        renderGlobalMaterialsTable();
        renderGlobalAdditionalTable();
        renderClientsTable();
        renderCalcPrinters();
        renderCustomServicesTable();
        renderHistoryTable();
        updateHistoryStats();
        renderSummary();
        const periodSelect = document.getElementById("summaryPeriod");
        periodSelect.addEventListener("change", onSummaryPeriodChange);
        document.getElementById("summaryApplyBtn").addEventListener("click", renderSummary);
        onSummaryPeriodChange();
        document.getElementById("calcOperatorRate").value = appData.calcSettings.operatorRate || "";
        document.getElementById("calcOperatorReject").checked = appData.calcSettings.includeOperatorForRejects || false;
        document.getElementById("calcDowntimeCost").value = appData.calcSettings.downtimeCost || "";
        document.getElementById("calcPreparationRate").value = appData.calcSettings.preparationRate || "";
        document.getElementById("calcPreparationTime").value = appData.calcSettings.preparationTime ? formatTimeForDisplay(appData.calcSettings.preparationTime) : "";
        document.getElementById("calcCostKwh").value = appData.calcSettings.costKwh || "";
        document.getElementById("calcTaxPercent").value = appData.calcSettings.taxPercent || "";
        document.getElementById("calcRoundingMode").value = appData.calcSettings.roundingMode || "none";
        document.getElementById("calcShipping").value = appData.calcSettings.shipping || "";
        ensureCalcStartDate();
        const deadlineInput = document.getElementById("calcDeadlineDate");
        if (deadlineInput) {
            deadlineInput.value = appData.calcSettings.deadlineDate || "";
        }
        document.getElementById("calcParallelPrinting").value = appData.calcSettings.parallelPrinting || "no";
        document.getElementById("calcMarkupPercent").value = appData.calcSettings.markupPercent || 0;
        document.getElementById("calcDiscountPercent").value = appData.calcSettings.discountPercent || 0;
        document.getElementById("settingsIncludeAmortization").checked = appData.calcSettings.includeAmortization !== false;
        document.getElementById("settingsIncludeRejects").checked = appData.calcSettings.includeRejects !== false;
        document.getElementById("settingsIncludeOverheads").checked = appData.calcSettings.includeOverheads !== false;
        document.getElementById("settingsIgnoreCoolingRejects").checked = appData.calcSettings.ignoreCoolingRejects || false;
        document.getElementById("calcFinalCost").value = '';
        toggleFinalFields(document.getElementById("calcOrderStatus").value);
        document.getElementById("companyNameInput").value = appData.labelSettings.companyName || "";
        document.getElementById("chatLinkInput").value = appData.labelSettings.chatLink || "";
        document.getElementById("bankDetailsInput").value = appData.labelSettings.bankDetails || "";
        updateBrandLogoPreview(appData.labelSettings.companyLogo || "");
        document.getElementById("labelCostInput").value = appData.labelSettings.costPerLabel || 0;
        document.getElementById("printLabelsCheckbox").checked = appData.labelSettings.printLabels || false;
        document.getElementById("printEstimateCheckbox").checked = appData.calcSettings.includeEstimatePrint || false;
        document.getElementById("estimatePrintCostInput").value = appData.calcSettings.estimatePrintCost || 0;
        initUrgencyProfilesDraft();
        buildOperatorScheduleUI();
        renderUrgencyProfileOptions();
        renderCalcUrgencySelect();
        syncCalcStatusDisplay();
        const clientInput = document.getElementById("calcClientName");
        if (clientInput) {
            updateClientSummaryLabels(clientInput.value);
        }

        maybeShowMissingMaterialsToast();

        window.__gcodecalc_ready = true;
        if (window.__gcodecalc_readyResolve) {
            window.__gcodecalc_readyResolve();
            window.__gcodecalc_readyResolve = null;
        }
    }

    // Функции для работы с форматами времени
    function parseTimeInput(input) {
        if (input.includes(":")) {
            const [hours, minutes] = input.split(":").map(Number);
            return hours + (minutes / 60);
        }
        return parseFloat(input) || 0;
    }

    function formatTimeForDisplay(time) {
        if (time === undefined || time === null) return "";
        const hours = Math.floor(time);
        const minutes = Math.round((time - hours) * 60);
        return `${hours}:${minutes.toString().padStart(2, '0')}`;
    }

    function safeFixed(val, digits = 2) {
        const num = Number(val);
        return isNaN(num) ? '0.00' : num.toFixed(digits);
    }

    function handleTimeInput(event) {
        const input = event.target.value;
        // Позволяем вводить как Ч:М, так и десятичное число
        if (input.includes(":")) {
            const [hours, minutes] = input.split(":").map(Number);
            if (!isNaN(hours) && !isNaN(minutes)) {
                return hours + (minutes / 60);
            }
        }
        return parseFloat(input) || 0;
    }

    function parseTimeFromLink(str){
        if(!str) return 0;
        let m = str.match(/(\d+)h\s*(\d+)m/);
        if(m) return parseInt(m[1],10) + parseInt(m[2],10)/60;
        m = str.match(/(\d+)h/);
        if(m) return parseInt(m[1],10);
        m = str.match(/(\d+)m/);
        if(m) return parseInt(m[1],10)/60;
        return parseTimeInput(str);
    }

    function getTodayIsoDate() {
        const now = new Date();
        const tzOffset = now.getTimezoneOffset();
        const local = new Date(now.getTime() - tzOffset * 60000);
        return local.toISOString().slice(0, 16);
    }

    function normalizeDateTimeLocal(value) {
        if (!value) return getTodayIsoDate();
        if (value.includes("T")) {
            return value.slice(0, 16);
        }
        return `${value}T08:00`;
    }

    function parseDateTimeLocalToDate(value) {
        if (!value) return null;
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) return null;
        return parsed;
    }

    function ensureCalcStartDate() {
        const inp = document.getElementById("calcStartDate");
        if (inp) {
            inp.value = normalizeDateTimeLocal(inp.value);
        }
    }

    function initUrgencyProfilesDraft() {
        if (Array.isArray(appData.labelSettings.urgencyProfiles) && appData.labelSettings.urgencyProfiles.length) {
            urgencyProfilesDraft = JSON.parse(JSON.stringify(appData.labelSettings.urgencyProfiles));
        } else {
            urgencyProfilesDraft = JSON.parse(JSON.stringify(DEFAULT_URGENCY_PROFILES));
        }
        if (!urgencyProfilesDraft.length) {
            urgencyProfilesDraft = JSON.parse(JSON.stringify(DEFAULT_URGENCY_PROFILES));
        }
        currentUrgencyProfileId = urgencyProfilesDraft[0] ? urgencyProfilesDraft[0].id : null;
    }

    function getEditingProfileById(pid) {
        return urgencyProfilesDraft.find(p => String(p.id) === String(pid));
    }

    function renderUrgencyProfileOptions() {
        const select = document.getElementById('urgencyProfileSelect');
        if (!select) return;
        select.innerHTML = '';
        urgencyProfilesDraft.forEach(profile => {
            const option = document.createElement('option');
            option.value = profile.id;
            const suffix = profile.markupPercent ? ` (+${profile.markupPercent}% )` : '';
            option.textContent = `${profile.title}${suffix}`;
            select.appendChild(option);
        });
        if (!getEditingProfileById(currentUrgencyProfileId) && urgencyProfilesDraft.length) {
            currentUrgencyProfileId = urgencyProfilesDraft[0].id;
        }
        if (currentUrgencyProfileId) {
            select.value = currentUrgencyProfileId;
        }
        renderCurrentUrgencyMeta();
        renderOperatorScheduleInputsForProfile(currentUrgencyProfileId);
    }

    function renderCurrentUrgencyMeta() {
        const profile = getEditingProfileById(currentUrgencyProfileId);
        const nameInput = document.getElementById('urgencyProfileName');
        const markupInput = document.getElementById('urgencyProfileMarkup');
        const descInput = document.getElementById('urgencyProfileDescription');
        if (!profile) {
            if (nameInput) nameInput.value = '';
            if (markupInput) markupInput.value = '';
            if (descInput) descInput.value = '';
            updateUrgencyScheduleHint(null);
            return;
        }
        if (nameInput) nameInput.value = profile.title || '';
        if (markupInput) markupInput.value = profile.markupPercent || 0;
        if (descInput) descInput.value = profile.description || '';
        updateUrgencyScheduleHint(profile);
    }

    function captureScheduleFromInputs(profileId) {
        const profile = getEditingProfileById(profileId);
        if (!profile) return;
        const scheduleMap = {};
        WEEKDAY_LABELS.forEach(day => {
            const rows = [];
            for (let i = 0; i < OPERATOR_PERIOD_ROWS; i++) {
                const startInput = document.querySelector(`.operator-period-input[data-day="${day.value}"][data-index="${i}"][data-type="start"]`);
                const endInput = document.querySelector(`.operator-period-input[data-day="${day.value}"][data-index="${i}"][data-type="end"]`);
                if (!startInput || !endInput) continue;
                if (!startInput.value && !endInput.value) continue;
                rows.push({ start: startInput.value, end: endInput.value });
            }
            scheduleMap[day.value] = rows;
        });
        profile.schedule = scheduleMap;
    }

    function renderOperatorScheduleInputsForProfile(profileId) {
        const profile = getEditingProfileById(profileId);
        const scheduleMap = profile && profile.schedule ? profile.schedule : {};
        WEEKDAY_LABELS.forEach(day => {
            const daySchedule = Array.isArray(scheduleMap[day.value]) ? scheduleMap[day.value] : [];
            for (let i = 0; i < OPERATOR_PERIOD_ROWS; i++) {
                const startInput = document.querySelector(`.operator-period-input[data-day="${day.value}"][data-index="${i}"][data-type="start"]`);
                const endInput = document.querySelector(`.operator-period-input[data-day="${day.value}"][data-index="${i}"][data-type="end"]`);
                if (!startInput || !endInput) continue;
                const period = daySchedule[i];
                startInput.value = period && period.start ? period.start : '';
                endInput.value = period && period.end ? period.end : '';
            }
        });
        updateUrgencyScheduleHint(profile);
    }

    function updateUrgencyScheduleHint(profile) {
        const hint = document.getElementById('urgencyScheduleHint');
        if (!hint) return;
        if (!profile) {
            hint.textContent = '';
            return;
        }
        const summary = buildScheduleSummary(normalizeScheduleMap(profile.schedule || {}));
        if (!summary.length) {
            hint.textContent = 'График не задан.';
            return;
        }
        const parts = summary.map(item => `${item.dayLabel}: ${item.windowLabel}`);
        hint.textContent = `Текущий профиль: ${profile.title || ''}. ${parts.join('; ')}`;
    }

    function addUrgencyProfile() {
        captureScheduleFromInputs(currentUrgencyProfileId);
        const newProfile = {
            id: `urg_${Date.now()}`,
            title: 'Новый профиль',
            markupPercent: 0,
            description: '',
            schedule: createScheduleFromPeriods(DEFAULT_OPERATOR_PERIODS),
            workingDays: [...DEFAULT_WORKING_DAYS]
        };
        urgencyProfilesDraft.push(newProfile);
        currentUrgencyProfileId = newProfile.id;
        renderUrgencyProfileOptions();
    }

    function deleteCurrentUrgencyProfile() {
        if (urgencyProfilesDraft.length <= 1) {
            alert('Должен быть хотя бы один профиль.');
            return;
        }
        const targetId = currentUrgencyProfileId;
        urgencyProfilesDraft = urgencyProfilesDraft.filter(p => p.id !== targetId);
        currentUrgencyProfileId = urgencyProfilesDraft[0] ? urgencyProfilesDraft[0].id : null;
        if (appData.calcSettings.currentUrgencyId === targetId) {
            appData.calcSettings.currentUrgencyId = currentUrgencyProfileId;
        }
        renderUrgencyProfileOptions();
    }

    function refreshUrgencyProfileSelectLabels() {
        const select = document.getElementById('urgencyProfileSelect');
        if (!select) return;
        Array.from(select.options).forEach(option => {
            const profile = getEditingProfileById(option.value);
            if (profile) {
                const suffix = profile.markupPercent ? ` (+${profile.markupPercent}% )` : '';
                option.textContent = `${profile.title}${suffix}`;
            }
        });
    }

    function getUrgencyProfileById(pid) {
        if (!Array.isArray(appData.labelSettings.urgencyProfiles)) return null;
        return appData.labelSettings.urgencyProfiles.find(p => String(p.id) === String(pid)) || null;
    }

    function getScheduleMinutesForProfile(profile) {
        if (!profile) return normalizeScheduleMap({});
        return normalizeScheduleMap(profile.schedule || {});
    }

    function buildOperatorScheduleUI() {
        const tabs = document.getElementById("operatorWeekTabs");
        const content = document.getElementById("operatorWeekContent");
        if (!tabs || !content) return;
        tabs.innerHTML = "";
        content.innerHTML = "";
        WEEKDAY_LABELS.forEach((day, idx) => {
            const li = document.createElement("li");
            li.className = "nav-item";
            const btn = document.createElement("button");
            btn.className = "nav-link" + (idx === 0 ? " active" : "");
            btn.type = "button";
            btn.id = `day-tab-${day.value}`;
            btn.setAttribute("data-bs-toggle", "tab");
            btn.setAttribute("data-bs-target", `#day-pane-${day.value}`);
            btn.setAttribute("role", "tab");
            btn.setAttribute("data-day", String(day.value));
            btn.textContent = day.label;
            li.appendChild(btn);
            tabs.appendChild(li);

            const pane = document.createElement("div");
            pane.className = "tab-pane fade" + (idx === 0 ? " show active" : "");
            pane.id = `day-pane-${day.value}`;
            pane.setAttribute("role", "tabpanel");

            const tableWrapper = document.createElement("div");
            tableWrapper.className = "table-responsive";
            const table = document.createElement("table");
            table.className = "table table-sm align-middle mb-0";
            table.innerHTML = `
        <thead>
          <tr>
            <th style="width:5%">#</th>
            <th>Начало</th>
            <th>Конец</th>
          </tr>
        </thead>
        <tbody></tbody>`;
            const tbody = table.querySelector("tbody");
            for (let i = 0; i < OPERATOR_PERIOD_ROWS; i++) {
                const tr = document.createElement("tr");
                const tdIndex = document.createElement("td");
                tdIndex.textContent = i + 1;
                const tdStart = document.createElement("td");
                const tdEnd = document.createElement("td");
                const startInput = document.createElement("input");
                startInput.type = "time";
                startInput.className = "form-control operator-period-input";
                startInput.dataset.day = String(day.value);
                startInput.dataset.index = String(i);
                startInput.dataset.type = "start";
                startInput.step = "300";
                const endInput = document.createElement("input");
                endInput.type = "time";
                endInput.className = "form-control operator-period-input";
                endInput.dataset.day = String(day.value);
                endInput.dataset.index = String(i);
                endInput.dataset.type = "end";
                endInput.step = "300";
                tdStart.appendChild(startInput);
                tdEnd.appendChild(endInput);
                tr.appendChild(tdIndex);
                tr.appendChild(tdStart);
                tr.appendChild(tdEnd);
                tbody.appendChild(tr);
            }
            tableWrapper.appendChild(table);
            pane.appendChild(tableWrapper);
            content.appendChild(pane);
        });
    }


    let workdayLunchOffsetMinutes = 240;
    let lunchStartManual = false;

    function getActiveScheduleDayValue() {
        const activeTab = document.querySelector('#operatorWeekTabs .nav-link.active');
        if (activeTab) {
            const dayAttr = activeTab.getAttribute('data-day');
            if (dayAttr !== null) return Number(dayAttr);
            const target = activeTab.getAttribute('data-bs-target');
            if (target) {
                const match = target.match(/day-pane-(\d)/);
                if (match) return Number(match[1]);
            }
        }
        return WEEKDAY_LABELS[0]?.value ?? 1;
    }

    function setScheduleForDay(dayValue, segments) {
        for (let i = 0; i < OPERATOR_PERIOD_ROWS; i++) {
            const startInput = document.querySelector(`.operator-period-input[data-day="${dayValue}"][data-index="${i}"][data-type="start"]`);
            const endInput = document.querySelector(`.operator-period-input[data-day="${dayValue}"][data-index="${i}"][data-type="end"]`);
            if (!startInput || !endInput) continue;
            if (segments[i]) {
                startInput.value = minutesToTimeString(segments[i].start);
                endInput.value = minutesToTimeString(segments[i].end);
            } else {
                startInput.value = '';
                endInput.value = '';
            }
        }
    }

    function clearSpecialBreaks() {
        const container = document.getElementById('specialBreaksContainer');
        if (container) container.innerHTML = '';
    }

    function addSpecialBreakRow(defaultStart = '', defaultDuration = 10) {
        const container = document.getElementById('specialBreaksContainer');
        if (!container) return;
        const row = document.createElement('div');
        row.className = 'row g-2 align-items-center special-break-row mb-2';
        row.innerHTML = `
        <div class="col-md-5">
            <input type="time" class="form-control form-control-sm special-break-start" value="${defaultStart}">
        <\/div>
        <div class="col-md-4">
            <input type="number" class="form-control form-control-sm special-break-duration" min="5" max="60" step="5" value="${defaultDuration}">
        <\/div>
        <div class="col-md-3 text-end">
            <button type="button" class="btn btn-link text-danger p-0 remove-break-row">&times;<\/button>
        <\/div>`;
        container.appendChild(row);
    }

    function updateLunchStartByOffset() {
        if (lunchStartManual) return;
        const skip = document.getElementById('workdaySkipLunch');
        if (skip && skip.checked) return;
        const startInput = document.getElementById('workdayStartTime');
        const lunchInput = document.getElementById('workdayLunchStart');
        if (!startInput || !lunchInput) return;
        const startMin = timeStringToMinutes(startInput.value || '');
        if (Number.isNaN(startMin)) return;
        const normalized = startMin + workdayLunchOffsetMinutes;
        if (normalized >= 0 && normalized < 24 * 60) {
            lunchInput.value = minutesToTimeString(normalized);
        }
    }

    function presetWorkdayTemplateModal() {
        const templateSelect = document.getElementById('workdayTemplateSelect');
        if (templateSelect) {
            templateSelect.value = '8h_classic';
        }
        const startInput = document.getElementById('workdayStartTime');
        if (startInput) startInput.value = '09:00';
        const totalHoursInput = document.getElementById('workdayTotalHours');
        if (totalHoursInput) totalHoursInput.value = '8';
        const lunchDurationInput = document.getElementById('workdayLunchDuration');
        if (lunchDurationInput) {
            lunchDurationInput.value = '60';
            lunchDurationInput.disabled = false;
        }
        const lunchInput = document.getElementById('workdayLunchStart');
        if (lunchInput) {
            lunchInput.value = '13:00';
            lunchInput.disabled = false;
        }
        const skipLunch = document.getElementById('workdaySkipLunch');
        if (skipLunch) skipLunch.checked = false;
        workdayLunchOffsetMinutes = 240;
        lunchStartManual = false;
        clearSpecialBreaks();
        const activeDay = getActiveScheduleDayValue();
        const dayCheckboxes = document.querySelectorAll('#workdayDaysContainer input[type="checkbox"]');
        dayCheckboxes.forEach(chk => {
            chk.checked = Number(chk.value) === activeDay;
        });
    }

    function gatherSelectedWorkdays() {
        const boxes = document.querySelectorAll('#workdayDaysContainer input[type="checkbox"]:checked');
        if (boxes.length) {
            return Array.from(boxes).map(b => Number(b.value));
        }
        return [getActiveScheduleDayValue()];
    }

    function collectSpecialBreaks(startMinutes, totalWorkMinutes) {
        const breaks = [];
        const container = document.getElementById('specialBreaksContainer');
        if (!container) return breaks;
        container.querySelectorAll('.special-break-row').forEach(row => {
            const startField = row.querySelector('.special-break-start');
            const durationField = row.querySelector('.special-break-duration');
            if (!startField || !durationField) return;
            if (!startField.value) return;
            const s = timeStringToMinutes(startField.value);
            const d = parseInt(durationField.value, 10);
            if (Number.isNaN(s) || Number.isNaN(d) || d <= 0) return;
            breaks.push({start: s, duration: d, label: 'Спецперерыв'});
        });
        return breaks;
    }

    function buildTemplateSegments(startMinutes, totalWorkMinutes, breaks) {
        const sortedBreaks = breaks.slice().sort((a, b) => a.start - b.start);
        let cursor = startMinutes;
        let consumed = 0;
        const segments = [];
        for (const br of sortedBreaks) {
            if (consumed >= totalWorkMinutes) break;
            if (br.start < cursor) {
                throw new Error('Перерывы пересекаются или указаны раньше начала смены.');
            }
            const available = br.start - cursor;
            if (available > 0 && consumed < totalWorkMinutes) {
                const chunk = Math.min(available, totalWorkMinutes - consumed);
                if (chunk > 0) {
                    segments.push({start: cursor, end: cursor + chunk});
                    consumed += chunk;
                }
            }
            cursor = br.start + br.duration;
        }
        if (consumed < totalWorkMinutes) {
            segments.push({start: cursor, end: cursor + (totalWorkMinutes - consumed)});
            cursor += totalWorkMinutes - consumed;
            consumed = totalWorkMinutes;
        }
        if (!segments.length) {
            throw new Error('Не удалось сформировать рабочие промежутки.');
        }
        return {segments, end: cursor};
    }

    function applyWorkdayTemplateFromModal() {
        try {
            const totalHours = parseFloat(document.getElementById('workdayTotalHours').value) || 0;
            if (totalHours <= 0) {
                alert('Укажите длительность смены.');
                return;
            }
            const startValue = document.getElementById('workdayStartTime').value;
            const startMinutes = timeStringToMinutes(startValue);
            if (Number.isNaN(startMinutes)) {
                alert('Укажите корректное время начала.');
                return;
            }
            const skipLunch = document.getElementById('workdaySkipLunch').checked;
            const lunchDuration = parseInt(document.getElementById('workdayLunchDuration').value, 10) || 0;
            const totalWorkMinutes = totalHours * 60;
            const breaks = [];
            if (!skipLunch) {
                const lunchStart = timeStringToMinutes(document.getElementById('workdayLunchStart').value);
                if (Number.isNaN(lunchStart)) {
                    alert('Укажите время обеда.');
                    return;
                }
                if (lunchStart < startMinutes) {
                    alert('Обед не может начинаться раньше смены.');
                    return;
                }
                if (lunchStart >= startMinutes + totalWorkMinutes) {
                    alert('Обед должен попадать в рабочее время.');
                    return;
                }
                if (lunchDuration > 0) {
                    breaks.push({start: lunchStart, duration: lunchDuration, label: 'Обед'});
                }
            }
            const specialBreaks = collectSpecialBreaks(startMinutes, totalWorkMinutes);
            breaks.push(...specialBreaks);
            const limit = startMinutes + totalWorkMinutes;
            const validBreaks = [];
            for (const br of breaks) {
                if (br.start < startMinutes) {
                    alert(`${br.label || 'Перерыв'} начинается раньше смены.`);
                    return;
                }
                if (br.start >= limit) {
                    continue;
                }
                validBreaks.push(br);
            }
            const {segments, end} = buildTemplateSegments(startMinutes, totalWorkMinutes, validBreaks);
            if (end > 24 * 60) {
                alert('Смена выходит за пределы одних суток. Отрегулируйте параметры.');
                return;
            }
            const days = gatherSelectedWorkdays();
            if (!days.length) {
                alert('Выберите хотя бы один день недели.');
                return;
            }
            days.forEach(day => setScheduleForDay(day, segments));
            const modalEl = document.getElementById('workdayTemplateModal');
            if (modalEl) {
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
            alert('График заполнен. Не забудьте сохранить настройки.');
        } catch (error) {
            alert(error.message || 'Не удалось применить шаблон.');
        }
    }

    async function parseGcodeText(text) {
        const lines = text.split(/\r?\n/);
        let code = '', timeStr = '', weight = '', printer = 'Unknown', matProfile = '', thumb = '';
        let plateNameFound = false;
        let plateName = '';
        let afterExecStart = false, afterExecEnd = false, inConfig = false, inThumb = false;
        let thumbnailFound = false;
        let linesAfterExecStart = 0;

        for (let raw of lines) {
            const line = raw.trim();

            if (line.startsWith('; MODEL_CODE:')) {
                code = line.split(':')[1].trim();
                continue;
            }

            if (line === '; EXECUTABLE_BLOCK_START') {
                afterExecStart = true;
                continue;
            }

            if (line === '; EXECUTABLE_BLOCK_END') {
                afterExecEnd = true;
                continue;
            }

            if (afterExecStart && !plateNameFound && linesAfterExecStart < 50) {
                linesAfterExecStart++;

                if (line.includes('plate_name=')) {
                    const match = line.match(/plate_name=\s*([^;]+)/);
                    if (match && match[1]) {
                        plateName = match[1].trim();
                        plateNameFound = true;
                    }
                }
            }

            if (line.startsWith('; THUMBNAIL_BLOCK_START')) {
                continue;
            }

            if (line.startsWith('; thumbnail begin')) {
                if (!thumbnailFound) {
                    inThumb = true;
                    thumbnailFound = true;
                }
                continue;
            }

            if (line.startsWith('; thumbnail end')) {
                if (inThumb) {
                    inThumb = false;
                }
                continue;
            }

            if (inThumb && thumbnailFound) {
                if (line.startsWith(';')) {
                    thumb += line.slice(1).trim();
                } else {
                    thumb += line.trim();
                }
                continue;
            }

            if (line.startsWith('; THUMBNAIL_BLOCK_END')) {
                continue;
            }

            if (line === '; CONFIG_BLOCK_START') {
                inConfig = true;
                continue;
            }

            if (line === '; CONFIG_BLOCK_END') {
                inConfig = false;
                continue;
            }

            if (inConfig) {
                if (line.includes('printer_settings_id') && line.includes('=')) {
                    printer = line.split('=')[1].replace(/"/g, '').trim();
                } else if (line.startsWith('; filament_settings_id') && line.includes('=')) {
                    matProfile = line.split('=')[1].replace(/"/g, '').trim();
                }
            }

            if (line.startsWith('; estimated printing time') && line.includes('=')) {
                timeStr = line.split('=')[1].trim();
            }
            else if (line.startsWith('; total filament used [g]') && line.includes('=')) {
                weight = line.split('=')[1].trim();
            }
        }

        if (!code) code = getNextId('gcodeModels');

        const modelName = plateNameFound ? plateName : code;

        return { code, modelName, timeStr, weight, printer, matProfile, thumb };
    }

    async function addModelFromGcode(parsed){
        const pr = await resolvePrinterForLink(parsed.printer);
        if(!pr){
            alert('Не найден принтер '+parsed.printer);
            return;
        }
        const mid = await resolveMaterialIdByProfile(parsed.matProfile);
        const normalizedThumb = parsed.thumb ? await ensureThumbnailOpaque(parsed.thumb) : '';
        addModelRow(pr.id, {
            id: parsed.code,
            name: parsed.modelName || parsed.code,
            thumbnail: normalizedThumb,
            status: 'new',
            hours: parseTimeFromLink(parsed.timeStr),
            weight: parseFloat(parsed.weight) || 0,
            materialId: mid
        });
    }

    async function resolveDropPrinterId(target){
        const lookupAncestorPrinterId = (el) => {
            let current = el;
            while (current) {
                if (current.dataset && current.dataset.printerId) {
                    return current.dataset.printerId;
                }
                if (current.id && current.id.startsWith('calcModelsTable_')) {
                    return current.id.split('_')[1];
                }
                current = current.parentElement;
            }
            return null;
        };
        let printerId = lookupAncestorPrinterId(target);
        if (printerId) return printerId;

        const container = document.getElementById('calcPrintersContainer');
        if (!container) return null;
        const containerOwnsTarget = target === container || (typeof container.contains === 'function' && container.contains(target));
        if (!containerOwnsTarget) return null;

        const printerBlocks = container.querySelectorAll('[data-printer-id]');
        if (printerBlocks.length === 0) return null;
        if (printerBlocks.length === 1) {
            return printerBlocks[0].dataset.printerId || null;
        }
        const printers = Array.isArray(appData.printers) ? appData.printers : [];
        const options = printers.map(p => ({
            value: String(p.id),
            label: `${p.name} (ID: ${p.id})`
        }));
        if (!options.length) return null;
        const result = await showMultiPrompt('Выберите принтер для моделей', [
            {id:'printerId', label:'Принтер', type:'select', options, value: options[0].value}
        ]);
        if (result && result.printerId) {
            return result.printerId;
        }
        return null;
    }

    function setupGcodeDrop() {
        const printersContainer = document.getElementById('calcPrintersContainer');
        let dropHighlightDepth = 0;
        let fileDragActive = false;

        const isFileDrag = (event) => {
            const dt = event && event.dataTransfer;
            if (!dt) return false;
            return Array.from(dt.types || []).includes('Files');
        };

        const isInsidePrinters = (target) => {
            return printersContainer && (target === printersContainer || printersContainer.contains(target));
        };

        const clearHighlight = () => {
            dropHighlightDepth = 0;
            fileDragActive = false;
            if (printersContainer) {
                printersContainer.classList.remove('calc-printers-drop-active');
            }
        };

        window.addEventListener('dragenter', e => {
            if (!printersContainer) return;
            if (isFileDrag(e)) {
                fileDragActive = true;
            }
            if (!fileDragActive) return;
            if (isInsidePrinters(e.target)) {
                dropHighlightDepth++;
                printersContainer.classList.add('calc-printers-drop-active');
            }
        });

        window.addEventListener('dragleave', e => {
            if (!printersContainer) return;
            if (!fileDragActive) return;
            if (isInsidePrinters(e.target)) {
                dropHighlightDepth = Math.max(0, dropHighlightDepth - 1);
                if (dropHighlightDepth === 0) {
                    printersContainer.classList.remove('calc-printers-drop-active');
                }
            }
        });

        window.addEventListener('dragover', e => {
            if (isFileDrag(e)) {
                fileDragActive = true;
            } else if (!fileDragActive) {
                return;
            }
            e.preventDefault();
        });

        window.addEventListener('drop', async e => {
            const hasFiles = isFileDrag(e);
            if (hasFiles) {
                e.preventDefault();
            }
            clearHighlight();
            if (!hasFiles) return;

            const printerId = await resolveDropPrinterId(e.target);
            if (!printerId) {
                alert('Не удалось определить цель. Перетащите файл в блок принтера или выберите его при подсказке.');
                return;
            }

            const files = Array.from((e.dataTransfer && e.dataTransfer.files) || []).filter(f =>
                f.name.toLowerCase().endsWith('.gcode')
            );

            for (const f of files) {
                const txt = await f.text();
                const parsed = await parseGcodeText(txt);
                let mid = await resolveMaterialIdByProfile(parsed.matProfile);

                const baseName = (f.name || '').replace(/\.gcode$/i, '').trim();
                const modelName = baseName || f.name || parsed.code || parsed.modelName || 'Модель';

                if (!mid) {
                    const materialOptions = appData.materials.map(m => ({
                        value: String(m.id),
                        label: `${m.name} (ID: ${m.id}${m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : ''})`
                    }));

                    if (materialOptions.length > 0) {
                        const result = await showMaterialSelectionForGcode(f.name, parsed.thumb, materialOptions);

                        if (result && result.materialId) {
                            mid = result.materialId;
                            if (result.remember && (parsed.matProfile||'').trim()) {
                                PromptMemory.setMaterial(parsed.matProfile.trim(), mid);
                            }
                        } else {
                            continue;
                        }
                    } else {
                        alert('Нет доступных материалов. Добавьте материалы во вкладке "Материалы".');
                        continue;
                    }
                }

                const normalizedThumb = parsed.thumb ? await ensureThumbnailOpaque(parsed.thumb) : '';
                addModelRow(printerId, {
                    id: parsed.code,
                    name: modelName,
                    thumbnail: normalizedThumb,
                    status: 'new',
                    hours: parseTimeFromLink(parsed.timeStr),
                    weight: parseFloat(parsed.weight) || 0,
                    materialId: mid
                });
            }
        });

        window.addEventListener('dragend', clearHighlight);
    }


    function waitForAppReady(){
        if (window.__gcodecalc_ready) return Promise.resolve();
        return new Promise(resolve => {
            window.__gcodecalc_readyResolve = resolve;
        });
    }

    const __importQueue = (() => {
        let chain = Promise.resolve();
        return {
            enqueue(task){
                const next = chain.then(task, task);
                chain = next.catch(e => console.error('Import task failed', e));
                return next;
            }
        };
    })();

    const __recentImports = new Map();
    function __isDuplicateImportKey(key){
        const now = Date.now();
        const last = __recentImports.get(key) || 0;
        __recentImports.set(key, now);

        for (const [k,t] of __recentImports.entries()){
            if (now - t > 10000) __recentImports.delete(k);
        }
        return (now - last) < 1200;
    }

    async function ensureTargetOrderForImport(){
        const auto = PromptMemory.getOrderAuto();
        if(auto && typeof auto.remaining === 'number' && auto.remaining > 0){
            if(auto.kind === 'history'){
                const ts = parseInt(auto.value, 10);
                const exists = (appData.calcHistory||[]).some(h => String(h.timestamp) === String(ts));
                if(exists){
                    onEditCalcHistory(ts);
                    PromptMemory.consumeOrderAuto();
                    await new Promise(r => setTimeout(r, 0));
                    return true;
                }
                PromptMemory.setOrderAuto(null);
            } else if(auto.kind === 'current'){
                PromptMemory.consumeOrderAuto();
                return true;
            }
        }

        const options = [
            { value:'current', label:'Текущий расчёт' },
            { value:'new', label:'Создать новый расчёт' },
        ].concat((appData.calcHistory||[]).map(h => ({
            value: String(h.timestamp),
            label: (h.calcName || h.dateStr || String(h.timestamp))
        })));

        const res = await showMultiPrompt('Куда добавить модель?', [
            { id:'targetOrder', label:'Расчёт', type:'select', options, value:'current' },
            { id:'remember', label:'Сохранить выбор для следующих импортов', type:'checkbox', value:false,
                help:'Полезно, когда Orca экспортирует пачку моделей подряд.' ,
                onChange:(el)=>{ const cnt=document.getElementById('mp_rememberCount'); if(cnt) cnt.disabled=!el.checked; } },
            { id:'rememberCount', label:'Сколько следующих моделей', type:'number', min:1, max:999, step:1, value:5, disabled:true }
        ]);

        if(!res) return false;

        const val = String(res.targetOrder || 'current');

        if(val === 'new'){
            startNewCalculation();
        } else if(val !== 'current'){
            onEditCalcHistory(parseInt(val,10));
        }

        if(res.remember){
            const remaining = Math.max(1, parseInt(res.rememberCount || 1, 10));
            const kind = (val !== 'current' && val !== 'new') ? 'history' : 'current';
            const value = kind === 'history' ? val : 'current';
            PromptMemory.setOrderAuto({ kind, value, remaining });
        } else {
            PromptMemory.setOrderAuto(null);
        }

        await new Promise(r => setTimeout(r, 0));
        return true;
    }

    async function importGcodeTextFlow(gcodeText, fileName){
        await waitForAppReady();

        const txt = String(gcodeText || '');
        const fn = String(fileName || '').trim() || 'model.gcode';

        const parsed = await parseGcodeText(txt);

        const dedupeKey = [
            fn,
            parsed.code || '',
            parsed.modelName || '',
            parsed.printer || '',
            parsed.matProfile || '',
            parsed.timeStr || '',
            parsed.weight || ''
        ].join('|');

        if(__isDuplicateImportKey(dedupeKey)){
            console.warn('Duplicate import suppressed', dedupeKey);
            return;
        }

        const pr = await resolvePrinterForLink(parsed.printer);
        if(!pr){
            alert('Не найден принтер для профиля: ' + (parsed.printer || 'Unknown'));
            return;
        }

        let mid = await resolveMaterialIdByProfile(parsed.matProfile);

        if(!mid){
            const materialOptions = (appData.materials||[]).map(m => ({
                value: String(m.id),
                label: `${m.name} (ID: ${m.id}${m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : ''})`
            }));

            if(materialOptions.length === 0){
                alert('Нет доступных материалов. Добавьте материалы во вкладке "Материалы".');
                return;
            }

            const pick = await showMaterialSelectionForGcode(fn, parsed.thumb, materialOptions, parsed.matProfile);
            if(!pick || !pick.materialId) return;

            mid = pick.materialId;

            if(pick.remember && (parsed.matProfile||'').trim()){
                PromptMemory.setMaterial(parsed.matProfile.trim(), mid);
            }
        }

        const ok = await ensureTargetOrderForImport();
        if(!ok) return;

        const fileBaseName = (fn || '').replace(/\.gcode$/i,'').trim();
        const modelName = fileBaseName || fn || parsed.code || parsed.modelName || 'Модель';

        const normalizedThumb = parsed.thumb ? await ensureThumbnailOpaque(parsed.thumb) : '';
        addModelRow(pr.id, {
            id: parsed.code,
            name: modelName,
            thumbnail: normalizedThumb,
            status: 'new',
            hours: parseTimeFromLink(parsed.timeStr),
            weight: parseFloat(parsed.weight) || 0,
            materialId: mid
        });
    }

    function attachExternalImportBridge(){
        if(window.__gcodecalc_externalImportAttached) return;
        window.__gcodecalc_externalImportAttached = true;

        window.__gcodecalcImportGcodeText = (payload) => {
            if(!payload) return;
            __importQueue.enqueue(() => importGcodeTextFlow(payload.text || '', payload.fileName || payload.filePath || 'model.gcode'));
        };

        if(window.gcodeBridge && typeof window.gcodeBridge.onGcodeFile === 'function'){
            try {
                window.gcodeBridge.onGcodeFile((payload) => {
                    window.__gcodecalcImportGcodeText(payload);
                });
            } catch (e) {
                console.warn('Failed to attach gcodeBridge', e);
            }
        }
    }


    document.addEventListener("DOMContentLoaded", () => {
        instrumentFunctions();
        initAll();
        renderMaterialTypeOptions();
        const logoInput = document.getElementById('brandLogoInput');
        if (logoInput) logoInput.addEventListener('change', onBrandLogoChange);
    });

    /* Функции массовых действий */
    function selectAll(source, type) {
        const checkboxes = document.querySelectorAll("."+type+"_chk");
        checkboxes.forEach(cb => cb.checked = source.checked);
    }

    function filterTable(tableId, query){
        const tb = document.getElementById(tableId);
        if(!tb) return;
        const val = query.toLowerCase();
        tb.querySelectorAll('tbody tr').forEach(tr=>{
            tr.style.display = tr.innerText.toLowerCase().includes(val)?'' :'none';
        });
    }

    function sortTable(tableId, col){
        const tb=document.getElementById(tableId);
        if(!tb) return;
        const rows=Array.from(tb.querySelectorAll('tbody tr'));
        const asc=tb.dataset.sortCol==col && tb.dataset.sortDir==='asc'?false:true;
        rows.sort((a,b)=>{
            const va=a.children[col].innerText;
            const vb=b.children[col].innerText;
            return asc?va.localeCompare(vb,'ru',{numeric:true}):vb.localeCompare(va,'ru',{numeric:true});
        });
        const tbody=tb.querySelector('tbody');
        rows.forEach(r=>tbody.appendChild(r));
        tb.dataset.sortCol=col;
        tb.dataset.sortDir=asc?'asc':'desc';
    }
    function massDelete(type) {
        if(!confirm("Удалить выбранные элементы?")) return;
        switch(type) {
            case 'printers':
                const removed = [];
                const blocked = [];
                appData.printers = appData.printers.filter(p => {
                    const chk = document.getElementById("chk_printers_"+p.id);
                    const del = chk && chk.checked;
                    if(del && isPrinterUsedInHistory(p.id)){
                        blocked.push(p.name || p.id);
                        return true;
                    }
                    if(del) removed.push(String(p.id));
                    return !del;
                });
                renderPrintersTable();
                renderCalcPrinters();
                renderSummary();
                if(removed.length){
                    const unresolved = collectUnresolvedPrinters();
                    if(unresolved.length) showPrinterMapModal(unresolved);
                }
                if(blocked.length){
                    alert(`Не удалось удалить принтеры, которые уже есть в истории заказов:\n${blocked.join(', ')}`);
                }
                break;
            case 'globalMaterials':
                appData.materials = appData.materials.filter(m => {
                    const chk = document.getElementById("chk_globalMaterials_"+m.id);
                    return !(chk && chk.checked);
                });
                renderGlobalMaterialsTable();
                renderSummary();
                break;
            case 'globalAdditional':
                appData.additionalGlobal = appData.additionalGlobal.filter(a => {
                    const chk = document.getElementById("chk_globalAdditional_"+a.id);
                    return !(chk && chk.checked);
                });
                renderGlobalAdditionalTable();
                renderSummary();
                break;
        }
        saveToLocalStorage();
    }
    async function massEdit(type) {
        switch(type) {
            case 'printers': {
                const vals = await showMultiPrompt('Массовое редактирование принтеров', [
                    {id:'cost',label:'Стоимость (₽)',type:'number'},
                    {id:'hours',label:'Часы окупаемости',type:'number'},
                    {id:'power',label:'Мощность (Вт)',type:'number'},
                    {id:'maint',label:'Расход на обслуживание (₽/ч)',type:'number'}
                ]);
                if(!vals) return;
                appData.printers.forEach(p=>{
                    const chk=document.getElementById('chk_printers_'+p.id);
                    if(chk&&chk.checked){
                        if(vals.cost) p.cost=parseFloat(vals.cost)||p.cost;
                        if(vals.hours) p.hoursToRecoup=parseFloat(vals.hours)||p.hoursToRecoup;
                        if(vals.power) p.power=parseFloat(vals.power)||p.power;
                        if(vals.maint) p.maintCostHour=parseFloat(vals.maint)||p.maintCostHour;
                    }
                });
                renderPrintersTable();
                renderCalcPrinters();
                renderSummary();
            }
                break;
            case 'globalMaterials':
            {
                const vals = await showMultiPrompt('Массовое редактирование материалов',[
                    {id: 'materialType', label: 'Тип материала'},
                    {id:'cost',label:'Стоимость за кг',type:'number'},
                    {id:'balance',label:'Остаток (кг)',type:'number'},
                    {id:'declared',label:'Начальный вес (кг)',type:'number'},
                    {id:'prepMinutes',label:'Подготовка (мин)',type:'number'},
                    {id:'manuf',label:'Производитель'},
                    {id:'prodDate',label:'Дата производства'},
                    {id:'printers',label:'Принтеры',type:'multiselect',options:appData.printers.map(p=>({value:String(p.id),label:p.name}))},
                    // {
                    //     id: 'profiles',
                    //     label: 'Профили',
                    //     type: 'multiselect',
                    //     options: (appData.materialProfiles || []).map(p => ({
                    //         value: String(p.id),
                    //         label: profileNameById(p.id) || `Профиль ${p.id}`
                    //     }))
                    // }
                ]);
                if(!vals) return;
                appData.materials.forEach(m=>{
                    const chk=document.getElementById('chk_globalMaterials_'+m.id);
                    if(chk&&chk.checked){
                        if(vals.materialType) m.materialType=vals.materialType;
                        if(vals.cost) m.costPerKg=parseFloat(vals.cost)||m.costPerKg;
                        if(vals.balance) m.balance=parseFloat(vals.balance)||m.balance;
                        if(vals.declared) m.declaredWeight=parseFloat(vals.declared)||m.declaredWeight;
                        if(vals.prepMinutes) m.printerPrepMinutes=parseFloat(vals.prepMinutes)||m.printerPrepMinutes;
                        if(vals.manuf) m.manufacturer=vals.manuf;
                        if(vals.prodDate) m.productionDate=vals.prodDate;
                        if(vals.printers && vals.printers.length) m.printers=vals.printers;
                        // if(vals.profiles && vals.profiles.length) {
                        //     if(!Array.isArray(m.profileIds)) m.profileIds = [];
                        //     m.profileIds = vals.profiles;
                        // }
                    }
                });
                renderGlobalMaterialsTable();
                renderSummary();
            }
                break;
            case 'globalAdditional':
            {
                const vals = await showMultiPrompt('Накладные расходы',[
                    {id:'cost',label:'Стоимость (₽)',type:'number'},
                    {id:'hours',label:'Часы окупаемости',type:'number'},
                    {id:'use',label:'Включать в расчёт',type:'checkbox',value:true},
                    {id:'printers',label:'Принтеры',type:'multiselect',options:appData.printers.map(p=>({value:String(p.id),label:p.name}))}
                ]);
                if(!vals) return;
                appData.additionalGlobal.forEach(a=>{
                    const chk=document.getElementById('chk_globalAdditional_'+a.id);
                    if(chk&&chk.checked){
                        if(vals.cost) a.cost=parseFloat(vals.cost)||a.cost;
                        if(vals.hours) a.hoursToRecoup=parseFloat(vals.hours)||a.hoursToRecoup;
                        a.useInCalc=vals.use;
                        if(vals.printers && vals.printers.length) a.printers=vals.printers;
                    }
                });
                renderGlobalAdditionalTable();
                renderSummary();
            }
                break;
        }
        saveToLocalStorage();
    }
    function copyElement(type, id) {
        switch(type) {
            case 'printers':
            {
                const orig = appData.printers.find(p => String(p.id) === String(id));
                if(orig){
                    const copy = JSON.parse(JSON.stringify(orig));
                    copy.id = getNextId('printers');
                    copy.name += " (копия)";
                    appData.printers.push(copy);
                    renderPrintersTable();
                    renderCalcPrinters();
                    renderSummary();
                }
            }
                break;
            case 'globalMaterials':
            {
                const orig = appData.materials.find(m => String(m.id) === String(id));
                if(orig){
                    const copy = JSON.parse(JSON.stringify(orig));
                    copy.id = getNextId('materials');
                    copy.name += " (копия)";
                    appData.materials.push(copy);
                    renderGlobalMaterialsTable();
                    renderSummary();
                }
            }
                break;
            case 'globalAdditional':
            {
                const orig = appData.additionalGlobal.find(a => String(a.id) === String(id));
                if(orig){
                    const copy = JSON.parse(JSON.stringify(orig));
                    copy.id = getNextId('additionalGlobal');
                    copy.description += " (копия)";
                    appData.additionalGlobal.push(copy);
                    renderGlobalAdditionalTable();
                    renderSummary();
                }
            }
                break;
        }
        saveToLocalStorage();
    }
    /* Функции для принтеров */
    function renderPrintersTable(){
        const tbody = document.querySelector("#printersTable tbody");
        tbody.innerHTML = "";
        appData.printers.forEach(printer => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td><input type="checkbox" id="chk_printers_${printer.id}" class="printers_chk"><\/td>
      <td>${printer.id}<\/td>
      <td>${printer.name}<\/td>
      <td>${printer.cost}<\/td>
      <td>${printer.hoursToRecoup}<\/td>
      <td>${printer.power}<\/td>
      <td>${printer.maintCostHour}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditPrinter('${printer.id}')">Ред.<\/button>
          <button class="btn btn-success" onclick="openPrinterOrca('${printer.id}')">Orca<\/button>
          <button class="btn btn-warning" onclick="copyElement('printers', '${printer.id}')">Копировать<\/button>
          <button class="btn btn-danger" onclick="onDeletePrinter('${printer.id}')">Удл.<\/button>
        <\/div>
      <\/td>
    `;
            tbody.appendChild(tr);
        });
    }
    function onAddPrinter(){
        const newId = getNextId('printers');
        const p = {
            id: newId,
            name: "Новый принтер",
            cost: 0,
            hoursToRecoup: 1000,
            power: 0,
            maintCostHour: 0,
            profileIds: []
        };
        appData.printers.push(p);
        saveToLocalStorage();
        renderPrintersTable();
        renderCalcPrinters();
        renderSummary();
    }
    let currentPrinterEditId = null;
    function onEditPrinter(id){
        const p = appData.printers.find(x => String(x.id) === String(id));
        if(!p) return;
        currentPrinterEditId = id;
        document.getElementById('printerNameInput').value = p.name;
        document.getElementById('printerCostInput').value = p.cost;
        document.getElementById('printerHoursInput').value = p.hoursToRecoup;
        document.getElementById('printerPowerInput').value = p.power;
        document.getElementById('printerMaintInput').value = p.maintCostHour;
        new bootstrap.Modal(document.getElementById('printerModal')).show();
    }
    function savePrinterFromModal(){
        const p = appData.printers.find(x => String(x.id) === String(currentPrinterEditId));
        if(!p) return;
        p.name = document.getElementById('printerNameInput').value;
        p.cost = parseFloat(document.getElementById('printerCostInput').value) || 0;
        p.hoursToRecoup = parseFloat(document.getElementById('printerHoursInput').value) || 1000;
        p.power = parseFloat(document.getElementById('printerPowerInput').value) || 0;
        p.maintCostHour = parseFloat(document.getElementById('printerMaintInput').value) || 0;
        saveToLocalStorage();
        renderPrintersTable();
        renderCalcPrinters();
        renderSummary();
        bootstrap.Modal.getInstance(document.getElementById('printerModal')).hide();
    }
    function onDeletePrinter(id){
        if(isPrinterUsedInHistory(id)){
            alert("Нельзя удалить принтер: он используется в истории заказов.");
            return;
        }
        if(!confirm("Удалить принтер?")) return;
        appData.printers = appData.printers.filter(x => String(x.id) !== String(id));
        saveToLocalStorage();
        renderPrintersTable();
        renderCalcPrinters();
        renderSummary();
        const unresolved = collectUnresolvedPrinters();
        if(unresolved.length) showPrinterMapModal(unresolved);
    }
    const MATERIAL_MASS_MODES = ['used','remaining','measured'];

    function setMaterialMassMode(mode){
        if (!MATERIAL_MASS_MODES.includes(mode)) {
            mode = 'used';
        }
        const hiddenInput = document.getElementById('matMassModeInput');
        if (hiddenInput) {
            hiddenInput.value = mode;
        }
        const buttons = document.querySelectorAll('#matMassModeGroup [data-mat-mass-mode]');
        buttons.forEach(btn => {
            const isActive = btn.dataset.matMassMode === mode;
            btn.classList.toggle('active', isActive);
        });
        const sections = document.querySelectorAll('.mat-mass-input');
        sections.forEach(section => {
            const shouldShow = section.dataset.mode === mode;
            section.classList.toggle('d-none', !shouldShow);
        });
        updateMaterialBalancePreview();
    }

    function updateMaterialMassAvailability(){
        const emptyInput = document.getElementById('matEmptySpoolWeightInput');
        const measuredButton = document.querySelector('#matMassModeGroup [data-mat-mass-mode="measured"]');
        if (!emptyInput || !measuredButton) return;
        const rawValue = emptyInput.value;
        const parsed = parseFloat(rawValue);
        const allowMeasured = rawValue !== '' && Number.isFinite(parsed) && parsed > 0;
        measuredButton.disabled = !allowMeasured;
        if (!allowMeasured) {
            const currentMode = document.getElementById('matMassModeInput')?.value;
            if (currentMode === 'measured') {
                setMaterialMassMode('used');
            }
        }
        updateMaterialBalancePreview();
    }

    function setMaterialNumberInputValue(id, value){
        const el = document.getElementById(id);
        if (!el) return;
        if (value === null || value === undefined || value === '') {
            el.value = '';
            return;
        }
        el.value = value;
    }

    function getMaterialNumberInputValue(id){
        const el = document.getElementById(id);
        if (!el) return null;
        const raw = el.value;
        if (raw === '' || raw === null || raw === undefined) return null;
        const parsed = parseFloat(raw);
        return Number.isFinite(parsed) ? parsed : null;
    }

    function loadMaterialTypeCatalog(){
        const el = document.getElementById('materialTypeCatalog');
        if (!el) return {groups: [], customLabel: 'Другое (вручную)'};
        try {
            const parsed = JSON.parse(el.textContent || '');
            return parsed && typeof parsed === 'object' ? parsed : {groups: [], customLabel: 'Другое (вручную)'};
        } catch (e) {
            console.warn('Failed to parse material type catalog', e);
            return {groups: [], customLabel: 'Другое (вручную)'};
        }
    }

    function renderMaterialTypeOptions(){
        const select = document.getElementById('matMaterialTypeInput');
        if (!select) return;
        const catalog = loadMaterialTypeCatalog();
        select.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = '-- Выберите тип --';
        select.appendChild(placeholder);
        const groups = Array.isArray(catalog.groups) ? catalog.groups : [];
        groups.forEach(group => {
            const items = Array.isArray(group?.items) ? group.items : [];
            const label = group?.label ? String(group.label) : '';
            const optGroup = document.createElement('optgroup');
            if (label) optGroup.label = label;
            items.forEach(item => {
                let value = '';
                let text = '';
                if (typeof item === 'string') {
                    value = item;
                    text = item;
                } else if (item && typeof item === 'object') {
                    value = item.value || item.label || '';
                    text = item.label || item.value || '';
                }
                if (!value && !text) return;
                const opt = document.createElement('option');
                opt.value = value || text;
                opt.textContent = text || value;
                optGroup.appendChild(opt);
            });
            if (optGroup.children.length) {
                if (label) {
                    select.appendChild(optGroup);
                } else {
                    Array.from(optGroup.children).forEach(child => select.appendChild(child));
                }
            }
        });
        const customLabel = catalog.customLabel || 'Другое (вручную)';
        const customOpt = document.createElement('option');
        customOpt.value = '__custom__';
        customOpt.textContent = customLabel;
        select.appendChild(customOpt);
    }

    function onMaterialTypeSelectChange(){
        const select = document.getElementById('matMaterialTypeInput');
        const customWrap = document.getElementById('matMaterialTypeCustomWrap');
        const customInput = document.getElementById('matMaterialTypeCustomInput');
        if (!select || !customWrap) return;
        const isCustom = select.value === '__custom__';
        customWrap.classList.toggle('d-none', !isCustom);
        if (isCustom && customInput) {
            customInput.focus();
        }
        if (!isCustom && customInput) {
            customInput.value = '';
        }
    }

    function setMaterialTypeValue(value){
        const select = document.getElementById('matMaterialTypeInput');
        const customWrap = document.getElementById('matMaterialTypeCustomWrap');
        const customInput = document.getElementById('matMaterialTypeCustomInput');
        if (!select) return;
        if (!select.options.length) {
            renderMaterialTypeOptions();
        }
        const normalized = (value || '').trim();
        if (normalized === '') {
            select.value = '';
            if (customWrap) customWrap.classList.add('d-none');
            if (customInput) customInput.value = '';
            return;
        }
        const hasOption = Array.from(select.options).some(opt => opt.value === normalized);
        if (hasOption) {
            select.value = normalized;
            if (customWrap) customWrap.classList.add('d-none');
            if (customInput) customInput.value = '';
            return;
        }
        select.value = '__custom__';
        if (customWrap) customWrap.classList.remove('d-none');
        if (customInput) customInput.value = normalized;
    }

    function getMaterialTypeValue(){
        const select = document.getElementById('matMaterialTypeInput');
        if (!select) return '';
        if (select.value === '__custom__') {
            return document.getElementById('matMaterialTypeCustomInput')?.value?.trim() || '';
        }
        return select.value || '';
    }

    function hideMaterialMassCollapse(){
        const collapseEl = document.getElementById('matMassCollapse');
        if (!collapseEl) return;
        const instance = bootstrap.Collapse.getInstance(collapseEl) || new bootstrap.Collapse(collapseEl, {toggle: false});
        instance.hide();
    }

    function updateMaterialBalancePreview(){
        const balanceInput = document.getElementById('matBalanceInput');
        if (!balanceInput) return;
        const modeInput = document.getElementById('matMassModeInput');
        const mode = modeInput ? modeInput.value : 'used';
        const declaredKg = getMaterialNumberInputValue('matDeclaredInput');
        const declaredGrams = declaredKg !== null ? declaredKg * 1000 : null;
        let remainingGrams = null;
        if (mode === 'used') {
            const used = getMaterialNumberInputValue('matUsedWeightInput');
            if (declaredGrams !== null && used !== null) {
                remainingGrams = Math.max(declaredGrams - used, 0);
            }
        } else if (mode === 'remaining') {
            const remaining = getMaterialNumberInputValue('matRemainingWeightInput');
            if (remaining !== null) {
                remainingGrams = Math.max(remaining, 0);
            }
        } else if (mode === 'measured') {
            const measured = getMaterialNumberInputValue('matMeasuredWeightInput');
            const empty = getMaterialNumberInputValue('matEmptySpoolWeightInput');
            if (measured !== null && empty !== null) {
                remainingGrams = Math.max(measured - empty, 0);
            }
        }
        if (remainingGrams !== null) {
            const kgVal = remainingGrams / 1000;
            const normalized = Math.max(kgVal, 0);
            const rounded = Math.round(normalized * 1000) / 1000;
            balanceInput.value = rounded.toString();
        }
    }

    /* Функции для глобальных материалов */
    function renderGlobalMaterialsTable(){
        const tb = document.querySelector("#materialsTable tbody");
        tb.innerHTML = "";
        appData.materials.forEach(m => {
            const tr = document.createElement("tr");
            let col = m.color || '#ffffff';
            console.log(m.color);
            if (!col.startsWith('#')) {
                col = '#' + col;
            }

            const spoolmanText = m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : '';

            tr.innerHTML = `
      <td><input type="checkbox" id="chk_globalMaterials_${m.id}" class="globalMaterials_chk"><\/td>
      <td>
        <span class="material-color-spool" style="color:${col};" aria-hidden="true">
          <svg viewBox="0 0 24 24" role="presentation" focusable="false">
            <rect class="spool-body" x="3" y="5" width="18" height="14" rx="3" ry="3"></rect>
            <circle class="spool-hole" cx="12" cy="12" r="4.2"></circle>
          </svg>
        </span>
        ${m.name} (ID: ${m.id}${spoolmanText})
      <\/td>
      <td>${m.materialType}<\/td>
      <td>${m.costPerKg}<\/td>
      <td>${m.balance * 1000}<\/td>
      <td>${m.declaredWeight || "-"}<\/td>
      <td>${m.coolingTime || 0}<\/td>
      <td>${m.printerPrepMinutes || 0}<\/td>
      <td>${m.manufacturer || "-"}<\/td>
      <td>${m.productionDate || "-"}<\/td>
      <td>${(m.printers && m.printers.length) ? m.printers.map(printerNameById).join(', ') : 'Все'}<\/td>
      <td class="materials-profiles-col">${(m.profileIds && m.profileIds.length) ? m.profileIds.map(profileNameById).join(', ') : '-'}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditGlobalMaterial('${m.id}')">Ред.<\/button>
          <button class="btn btn-success" onclick="openMaterialProfileLink('${m.id}')">Профиль<\/button>

          <button class="btn btn-info" onclick="downloadMaterialLabelHtml('${m.id}')">Этикетка<\/button>
          <button class="btn btn-warning" onclick="copyElement('globalMaterials', '${m.id}')">Копировать<\/button>
          <button class="btn btn-danger" onclick="onDeleteGlobalMaterial('${m.id}')">Удл.<\/button>
        <\/div>
      <\/td>
    `;
            tb.appendChild(tr);
        });
    }
    let currentMaterialEditId = null;
    function onAddGlobalMaterial(){
        currentMaterialEditId = null;
        document.getElementById('matNameInput').value = '';
        setMaterialTypeValue('');
        document.getElementById('matCostInput').value = '0';
        document.getElementById('matBalanceInput').value = '0';
        document.getElementById('matDeclaredInput').value = '0';
        document.getElementById('matCoolingTimeInput').value = '0';
        setMaterialNumberInputValue('matEmptySpoolWeightInput', '');
        setMaterialNumberInputValue('matUsedWeightInput', '');
        setMaterialNumberInputValue('matRemainingWeightInput', '');
        setMaterialNumberInputValue('matMeasuredWeightInput', '');
        document.getElementById('matColorInput').value = '#ffffff';
        document.getElementById('matPrepTimeInput').value = '0';
        document.getElementById('matManufInput').value = '';
        document.getElementById('matProdDateInput').value = '';
        populatePrintersSelect(document.getElementById('matPrintersSelect'), []);
        setMaterialMassMode('used');
        updateMaterialMassAvailability();
        hideMaterialMassCollapse();
        new bootstrap.Modal(document.getElementById('materialModal')).show();
    }
    function onEditGlobalMaterial(id){
        const m = appData.materials.find(x => String(x.id) === String(id));
        if(!m) return;
        currentMaterialEditId = id;
        document.getElementById('matNameInput').value = m.name;
        setMaterialTypeValue(m.materialType);
        document.getElementById('matCostInput').value = m.costPerKg;
        document.getElementById('matBalanceInput').value = m.balance;
        document.getElementById('matDeclaredInput').value = m.declaredWeight;
        setMaterialNumberInputValue('matEmptySpoolWeightInput', m.emptySpoolWeight);
        setMaterialNumberInputValue('matUsedWeightInput', m.usedWeightGrams);
        setMaterialNumberInputValue('matRemainingWeightInput', m.remainingWeightGrams);
        setMaterialNumberInputValue('matMeasuredWeightInput', m.measuredWeightGrams);
        document.getElementById('matCoolingTimeInput').value = m.coolingTime || 0;
        document.getElementById('matPrepTimeInput').value = m.printerPrepMinutes || 0;
        document.getElementById('matColorInput').value = m.color || '#ffffff';
        document.getElementById('matManufInput').value = m.manufacturer || '';
        document.getElementById('matProdDateInput').value = m.productionDate || '';
        populatePrintersSelect(document.getElementById('matPrintersSelect'), m.printers||[]);
        setMaterialMassMode(m.massInputMode || 'used');
        updateMaterialMassAvailability();
        hideMaterialMassCollapse();
        new bootstrap.Modal(document.getElementById('materialModal')).show();
    }
    function saveMaterialFromModal(){
        const isNew = currentMaterialEditId === null;
        let m = isNew ? {id: getNextId('materials'), profileIds: [], printers: []} : appData.materials.find(x=>x.id==currentMaterialEditId);
        if(!m) return;
        const readOptionalNumber = (id) => {
            const el = document.getElementById(id);
            if (!el) return null;
            const raw = el.value;
            if (raw === '' || raw === null || raw === undefined) return null;
            const parsed = parseFloat(raw);
            return Number.isFinite(parsed) ? parsed : null;
        };
        m.name = document.getElementById('matNameInput').value;
        m.materialType = getMaterialTypeValue();
        m.costPerKg = parseFloat(document.getElementById('matCostInput').value) || 0;
        m.balance = parseFloat(document.getElementById('matBalanceInput').value) || 0;
        m.declaredWeight = parseFloat(document.getElementById('matDeclaredInput').value) || 0;
        m.coolingTime = parseFloat(document.getElementById('matCoolingTimeInput').value) || 0;
        m.printerPrepMinutes = parseFloat(document.getElementById('matPrepTimeInput').value) || 0;
        m.color = document.getElementById('matColorInput').value;
        m.manufacturer = document.getElementById('matManufInput').value;
        m.productionDate = document.getElementById('matProdDateInput').value;
        m.printers = Array.from(document.getElementById('matPrintersSelect').selectedOptions).map(o=>o.value);
        m.emptySpoolWeight = readOptionalNumber('matEmptySpoolWeightInput');
        m.massInputMode = document.getElementById('matMassModeInput')?.value || 'used';
        if (!MATERIAL_MASS_MODES.includes(m.massInputMode)) {
            m.massInputMode = 'used';
        }
        m.usedWeightGrams = readOptionalNumber('matUsedWeightInput');
        m.remainingWeightGrams = readOptionalNumber('matRemainingWeightInput');
        m.measuredWeightGrams = readOptionalNumber('matMeasuredWeightInput');
        if(isNew) appData.materials.push(m);
        saveToLocalStorage();
        renderGlobalMaterialsTable();
        renderSummary();
        bootstrap.Modal.getInstance(document.getElementById('materialModal')).hide();
    }
    function onDeleteGlobalMaterial(id){
        if(!confirm("Удалить материал?")) return;
        appData.materials = appData.materials.filter(x => String(x.id) !== String(id));
        saveToLocalStorage();
        renderGlobalMaterialsTable();
        renderSummary();
    }

    /* Функции для глобальных доп. расходов */
    function renderGlobalAdditionalTable(){
        const tb = document.querySelector("#additionalGlobalTable tbody");
        tb.innerHTML = "";
        appData.additionalGlobal.forEach(a => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td><input type="checkbox" id="chk_globalAdditional_${a.id}" class="globalAdditional_chk"><\/td>
      <td>${a.id}<\/td>
      <td>${a.description}<\/td>
      <td>${a.cost}<\/td>
      <td>${a.hoursToRecoup || 1000}<\/td>
      <td>${a.useInCalc ? "Да" : "Нет"}<\/td>
      <td>${(a.printers && a.printers.length)? a.printers.map(printerNameById).join(', '): 'Все'}<\/td>
      <td>
        <div class="btn-group-sm">
          <button class="btn btn-secondary" onclick="onEditGlobalAdditional('${a.id}')">Ред.<\/button>
          <button class="btn btn-warning" onclick="copyElement('globalAdditional', '${a.id}')">Копировать<\/button>
          <button class="btn btn-danger" onclick="onDeleteGlobalAdditional('${a.id}')">Удл.<\/button>
        <\/div>
      <\/td>
    `;
            tb.appendChild(tr);
        });
    }
    function onAddGlobalAdditional(){
        const nid = getNextId('additionalGlobal');
        appData.additionalGlobal.push({
            id: nid,
            description: "Новая статья",
            cost: 0,
            hoursToRecoup: 1000,
            useInCalc: true,
            printers: []
        });
        saveToLocalStorage();
        renderGlobalAdditionalTable();
        renderSummary();
    }
    async function onEditGlobalAdditional(id){
        const x = appData.additionalGlobal.find(a => String(a.id) === String(id));
        if(!x) return;
        const vals = await showMultiPrompt('Расход',[
            {id:'desc',label:'Описание',value:x.description},
            {id:'cost',label:'Стоимость (₽)',type:'number',value:x.cost},
            {id:'hours',label:'Часы окуп.',type:'number',value:x.hoursToRecoup||1000},
            {id:'use',label:'Включать в расчёт',type:'checkbox',value:x.useInCalc},
            {id:'printers',label:'Принтеры',type:'multiselect',options:appData.printers.map(p=>({value:String(p.id),label:p.name})),value:x.printers||[]}
        ]);
        if(!vals) return;
        x.description = vals.desc;
        x.cost = parseFloat(vals.cost)||0;
        x.hoursToRecoup = parseFloat(vals.hours)||1000;
        x.useInCalc = vals.use;
        x.printers = vals.printers || [];
        saveToLocalStorage();
        renderGlobalAdditionalTable();
        renderSummary();
    }
    function onDeleteGlobalAdditional(id){
        if(!confirm("Удалить статью?")) return;
        appData.additionalGlobal = appData.additionalGlobal.filter(a => String(a.id) !== String(id));
        saveToLocalStorage();
        renderGlobalAdditionalTable();
        renderSummary();
    }

    /* Функции для кастомных услуг */
    function renderCustomServicesTable(){
        const tb = document.querySelector('#customServicesTable tbody');
        if(!tb) return;
        tb.innerHTML='';
        if(!appData.calcSettings) appData.calcSettings = {};
        const services = Array.isArray(appData.calcSettings.customServices) ? appData.calcSettings.customServices : [];
        if(services.length === 0){
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6" class="text-center text-muted small">Добавьте услуги при необходимости<\/td>`;
            tb.appendChild(tr);
            return;
        }
        services.forEach(s=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`
      <td><input type="checkbox" ${s.use?'checked':''} onchange="updateService('${s.id}','use',this.checked)"></td>
      <td><input type="text" class="form-control form-control-sm" value="${s.name}" onchange="updateService('${s.id}','name',this.value)"></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${s.cost}" onchange="updateService('${s.id}','cost',this.value)"></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${s.qty}" onchange="updateService('${s.id}','qty',this.value)"></td>
      <td>
        <select class="form-select form-select-sm" onchange="updateService('${s.id}','mode',this.value)">
          <option value="per_unit" ${s.mode==='per_unit'?'selected':''}>за единицу</option>
          <option value="per_service" ${s.mode==='per_service'?'selected':''}>за услугу</option>
          <option value="per_hour" ${s.mode==='per_hour'?'selected':''}>за час</option>
        </select>
      </td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteCustomService('${s.id}')">Удалить</button></td>
    `;
            tb.appendChild(tr);
        });
    }

    function addCustomService(){
        if(!Array.isArray(appData.calcSettings.customServices)) appData.calcSettings.customServices=[];
        appData.calcSettings.customServices.push({id:getNextId('services'),name:'',cost:0,qty:1,mode:'per_service',use:true});
        saveToLocalStorage();
        renderCustomServicesTable();
    }

    function deleteCustomService(id){
        appData.calcSettings.customServices=(appData.calcSettings.customServices||[]).filter(s=>String(s.id)!==String(id));
        saveToLocalStorage();
        renderCustomServicesTable();
    }

    function updateService(id,field,value){
        const s=(appData.calcSettings.customServices||[]).find(x=>String(x.id)===String(id));
        if(!s) return;
        if(field==='cost'||field==='qty') s[field]=parseFloat(value)||0;
        else if(field==='use') s[field]=value;
        else s[field]=value;
        saveToLocalStorage();
    }

    /* Функции для клиентов */
    function renderClientsTable(){
        const tb = document.querySelector("#clientsTable tbody");
        if(!tb) return;
        tb.innerHTML="";
        appData.clients.forEach(c=>{
            const tr=document.createElement("tr");
            tr.innerHTML=`
      <td>${c.id}</td>
      <td>${c.name}</td>
      <td>${c.phone||""}</td>
      <td>${c.links||""}</td>
      <td><div class="btn-group-sm">
        <button class="btn btn-secondary" onclick="onEditClient('${c.id}')">Ред.</button>
        <button class="btn btn-danger" onclick="onDeleteClient('${c.id}')">Удл.</button>
      </div></td>`;
            tb.appendChild(tr);
        });
        renderClientOptions();
    }

    function renderClientOptions(filterText) {
        const menu = document.getElementById('calcClientDropdownMenu');
        if (!menu) return;
        const input = document.getElementById('calcClientName');
        const term = typeof filterText === 'string' ? filterText : (input ? input.value : '');
        const search = (term || '').toLowerCase();
        const list = appData.clients.filter(c => {
            if (!search) return true;
            const haystack = `${c.name || ''} ${(c.phone || '')} ${(c.links || '')}`.toLowerCase();
            return haystack.includes(search);
        });
        if (!list.length) {
            menu.innerHTML = `<div class="dropdown-item text-muted small">Нет совпадений. Нажмите Enter, чтобы добавить клиента.</div>`;
            return;
        }
        menu.innerHTML = list.map(c => {
            const safeName = escapeHtml(c.name || '');
            const safePhone = escapeHtml(c.phone || '');
            const phone = c.phone ? `<span class="text-muted small ms-2">${safePhone}</span>` : '';
            return `<button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="onCalcClientSelect('${c.id}')">
        <span>${safeName}</span>
        ${phone}
      </button>`;
        }).join('');
    }

    function getClientById(clientId) {
        if (!clientId && clientId !== 0) return null;
        return appData.clients.find(c => String(c.id) === String(clientId)) || null;
    }

    function findClientByName(name) {
        if (!name) return null;
        const lower = name.trim().toLowerCase();
        return appData.clients.find(c => (c.name || '').trim().toLowerCase() === lower) || null;
    }

    function escapeHtml(str) {
        return (str || '').replace(/[&<>"']/g, ch => {
            switch (ch) {
                case '&':
                    return '&amp;';
                case '<':
                    return '&lt;';
                case '>':
                    return '&gt;';
                case '"':
                    return '&quot;';
                case "'":
                    return '&#39;';
                default:
                    return ch;
            }
        });
    }

    function getServiceModeLabel(mode) {
        switch (mode) {
            case 'per_service':
                return 'за услугу';
            case 'per_unit':
                return 'за единицу';
            case 'per_hour':
                return 'за час';
            default:
                return mode || '—';
        }
    }

    function getClientDropdownElements() {
        return {
            wrapper: document.getElementById('calcClientDropdownWrapper'),
            menu: document.getElementById('calcClientDropdownMenu')
        };
    }

    function showClientDropdown() {
        const {wrapper, menu} = getClientDropdownElements();
        if (!wrapper || !menu) return;
        menu.classList.add('show');
        wrapper.classList.add('show');
        clientDropdownVisible = true;
    }

    function hideClientDropdown() {
        const {wrapper, menu} = getClientDropdownElements();
        if (!wrapper || !menu) return;
        menu.classList.remove('show');
        wrapper.classList.remove('show');
        clientDropdownVisible = false;
    }

    document.addEventListener('click', event => {
        if (!clientDropdownVisible) return;
        const {wrapper} = getClientDropdownElements();
        if (!wrapper) return;
        if (wrapper.contains(event.target)) return;
        hideClientDropdown();
    });

    function onClientFieldFocus() {
        renderClientOptions();
        showClientDropdown();
    }

    async function onClientFieldKeydown(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const value = event.target.value.trim();
            if (!value) {
                onCalcClientSelect('');
                hideClientDropdown();
                return;
            }
            const existing = findClientByName(value);
            if (existing) {
                onCalcClientSelect(existing.id);
                hideClientDropdown();
            } else {
                const created = await openClientModalAndSave({name: value});
                if (created) onCalcClientSelect(created.id);
            }
        } else if (event.key === 'Escape') {
            hideClientDropdown();
        } else if (event.key === 'Tab') {
            hideClientDropdown();
        }
    }

    async function promptClientData(defaults = {}) {
        return await showMultiPrompt('Клиент', [
            {id: 'name', label: 'Имя', value: defaults.name || ''},
            {id: 'phone', label: 'Телефон', value: defaults.phone || ''},
            {id: 'links', label: 'Ссылки', value: defaults.links || ''}
        ]);
    }

    async function openClientModalAndSave(defaults = {}) {
        const vals = await promptClientData(defaults);
        if (!vals) return null;
        const normalizedName = (vals.name || '').trim();
        if (!normalizedName) return null;
        let client = null;
        if (defaults.id) {
            client = getClientById(defaults.id);
        }
        if (!client) {
            client = findClientByName(normalizedName);
        }
        if (!client) {
            client = {id: getNextId('clients')};
            appData.clients.push(client);
        }
        client.name = normalizedName;
        client.phone = (vals.phone || '').trim();
        client.links = (vals.links || '').trim();
        saveToLocalStorage();
        renderClientsTable();
        return client;
    }

    async function onAddClient() {
        await openClientModalAndSave();
    }

    async function onEditClient(id){
        const c=appData.clients.find(x=>x.id==id);
        if(!c) return;
        await openClientModalAndSave({id: c.id, name: c.name, phone: c.phone || '', links: c.links || ''});
    }

    function onDeleteClient(id){
        if(!confirm('Удалить клиента?')) return;
        appData.clients=appData.clients.filter(c=>c.id!=id);
        saveToLocalStorage();
        renderClientsTable();
    }

    function applyClientSelection(clientId, fallbackName = '') {
        const input = document.getElementById('calcClientName');
        let client = null;
        if (clientId) {
            client = getClientById(clientId);
        }
        if (!client && fallbackName) {
            client = findClientByName(fallbackName);
        }
        currentCalcClientId = client ? client.id : '';
        if (input) {
            input.value = client ? client.name : (fallbackName || '');
        }
        renderClientOptions(input ? input.value : '');
        updateClientSummaryLabels(input ? input.value : '');
    }

    function resetCalcClientSelector() {
        currentCalcClientId = '';
        const input = document.getElementById('calcClientName');
        if (input) input.value = '';
        renderClientOptions('');
        hideClientDropdown();
        updateClientSummaryLabels('');
    }

    function onCalcClientSelect(clientId) {
        applyClientSelection(clientId || '');
        hideClientDropdown();
    }

    function onCalcClientInput() {
        const input = document.getElementById('calcClientName');
        if (!input) return;
        const value = input.value.trim();
        const client = findClientByName(value);
        currentCalcClientId = client ? client.id : '';
        renderClientOptions(value);
        showClientDropdown();
        updateClientSummaryLabels(value);
    }

    const ORDER_STATUS_LABELS = {
        new: 'Новый',
        inprogress: 'В работе',
        done: 'Завершён',
        paid: 'Оплачен',
        canceled: 'Отменён'
    };

    const MODEL_STATUS_LABELS = {
        new: 'Новая',
        inprogress: 'Печать',
        done: 'Готова',
        reject: 'Брак',
        canceled: 'Отменена'
    };

    const getOrderStatusLabel = (status) => ORDER_STATUS_LABELS[status] || status || '—';
    const getModelStatusLabel = (status) => MODEL_STATUS_LABELS[status] || status || '—';
    const getModelQualityLabel = (status) => status === 'reject' ? 'Брак' : '';

    const TIMELINE_STAGE_LABELS = {
        prep: 'Подготовка',
        print: 'Печать',
        cool: 'Остывание'
    };
    const TIMELINE_ACTIONS = {
        prep: 'Подготовить принтер и материал',
        print: 'Контролировать печать и готовиться к выгрузке',
        cool: 'Снять модель, освободить стол'
    };
    const minutesToDuration = (minutes) => {
        const hrs = Math.floor(minutes / 60);
        const mins = Math.round(minutes % 60);
        if (hrs > 0 && mins > 0) return `${hrs} ч ${mins} мин`;
        if (hrs > 0) return `${hrs} ч`;
        return `${mins} мин`;
    };
    const minutesToTimeString = (minutes) => {
        if (Number.isNaN(minutes)) return '';
        const normalized = ((minutes % (24 * 60)) + (24 * 60)) % (24 * 60);
        const hrs = Math.floor(normalized / 60);
        const mins = Math.round(normalized % 60);
        return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    };
    const timeStringToMinutes = (value) => {
        if (!value || !value.includes(":")) return NaN;
        const [hours, minutes] = value.split(":").map(Number);
        if (Number.isNaN(hours) || Number.isNaN(minutes)) return NaN;
        return hours * 60 + minutes;
    };
    const formatTimelineTime = (date) => date.toLocaleString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit',
        day: '2-digit',
        month: '2-digit'
    });
    const formatTimeOnly = (date) => date.toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });
    const normalizeScheduleMap = (schedule) => {
        const map = {};
        WEEKDAY_LABELS.forEach(day => {
            const periods = schedule && Array.isArray(schedule[day.value]) ? schedule[day.value] : [];
            map[day.value] = periods
                .map(period => {
                    const startMin = timeStringToMinutes(period.start);
                    const endMin = timeStringToMinutes(period.end);
                    if (Number.isNaN(startMin) || Number.isNaN(endMin) || startMin >= endMin) return null;
                    return {
                        start: period.start,
                        end: period.end,
                        startMinutes: startMin,
                        endMinutes: endMin,
                        startLabel: period.start || minutesToTimeString(startMin),
                        endLabel: period.end || minutesToTimeString(endMin)
                    };
                })
                .filter(Boolean)
                .sort((a, b) => a.startMinutes - b.startMinutes);
        });
        return map;
    };
    const getWorkingDaysSet = (scheduleMap) => {
        const set = new Set();
        WEEKDAY_LABELS.forEach(day => {
            const periods = scheduleMap && Array.isArray(scheduleMap[day.value]) ? scheduleMap[day.value] : [];
            if (periods.length) {
                set.add(day.value);
            }
        });
        if (!set.size) {
            DEFAULT_WORKING_DAYS.forEach(day => set.add(day));
        }
        return set;
    };
    const hasScheduleWindows = (scheduleMap) => {
        return Object.values(scheduleMap || {}).some(periods =>
            Array.isArray(periods) && periods.length > 0
        );
    };
    const getScheduleWindowsForWeekday = (weekday, scheduleMap) => {
        if (!scheduleMap) return [];
        const windows = scheduleMap[weekday];
        return Array.isArray(windows) ? windows : [];
    };
    const isWorkingDay = (date, workingDaysSet) => workingDaysSet.has(date.getDay());
    const getNextWorkingWindow = (cursor, scheduleMap, workingDaysSet) => {
        const hasSchedule = hasScheduleWindows(scheduleMap);
        if (!hasSchedule) {
            const start = new Date(cursor);
            return {start, end: new Date(start.getTime() + 24 * 60 * 60000)};
        }
        const workingDays = (workingDaysSet && workingDaysSet.size) ? workingDaysSet : getWorkingDaysSet(scheduleMap);
        if (!workingDays.size) {
            const start = new Date(cursor);
            return {start, end: new Date(start.getTime() + 24 * 60 * 60000)};
        }
        let probe = new Date(cursor);
        while (true) {
            const dayStart = new Date(probe);
            dayStart.setHours(0, 0, 0, 0);
            if (!isWorkingDay(dayStart, workingDays)) {
                probe = new Date(dayStart.getTime() + 24 * 60 * 60000);
                continue;
            }
            const weekday = dayStart.getDay();
            const windows = getScheduleWindowsForWeekday(weekday, scheduleMap);
            if (!windows.length) {
                probe = new Date(dayStart.getTime() + 24 * 60 * 60000);
                continue;
            }
            for (const window of windows) {
                const windowStart = new Date(dayStart.getTime() + window.startMinutes * 60000);
                const windowEnd = new Date(dayStart.getTime() + window.endMinutes * 60000);
                if (probe <= windowEnd) {
                    const slotStart = probe < windowStart ? windowStart : probe;
                    if (slotStart < windowEnd) {
                        return {start: slotStart, end: windowEnd};
                    }
                }
            }
            probe = new Date(dayStart.getTime() + 24 * 60 * 60000);
        }
    };
    const DAY_MS = 24 * 60 * 60000;
    const getDayStart = (value) => {
        const date = new Date(value);
        date.setHours(0, 0, 0, 0);
        return date;
    };
    const getDayEnd = (value) => {
        const start = getDayStart(value);
        return new Date(start.getTime() + DAY_MS);
    };
    const alignToWorkingMoment = (cursor, scheduleMap, workingDaysSet) => {
        const hasSchedule = hasScheduleWindows(scheduleMap);
        if (!hasSchedule) {
            const point = new Date(cursor);
            const dayStart = getDayStart(point);
            const dayEnd = getDayEnd(point);
            if (point >= dayEnd) {
                const next = dayEnd;
                return {instant: next, dayStart: getDayStart(next)};
            }
            return {instant: point, dayStart};
        }
        let probe = new Date(cursor);
        const workingDays = (workingDaysSet && workingDaysSet.size) ? workingDaysSet : getWorkingDaysSet(scheduleMap);
        for (let guard = 0; guard < 14; guard++) {
            const dayStart = getDayStart(probe);
            const weekday = dayStart.getDay();
            if (!isWorkingDay(dayStart, workingDays)) {
                probe = new Date(dayStart.getTime() + DAY_MS);
                continue;
            }
            const windows = getScheduleWindowsForWeekday(weekday, scheduleMap);
            if (!windows.length) {
                probe = new Date(dayStart.getTime() + DAY_MS);
                continue;
            }
            for (const window of windows) {
                const winStart = new Date(dayStart.getTime() + window.startMinutes * 60000);
                const winEnd = new Date(dayStart.getTime() + window.endMinutes * 60000);
                if (probe > winEnd) continue;
                const instant = probe < winStart ? winStart : probe;
                if (instant < winEnd) {
                    return {instant, dayStart};
                }
            }
            probe = new Date(dayStart.getTime() + DAY_MS);
        }
        return null;
    };
    const scheduleOperatorStage = (cursor, minutes, scheduleMap, workingDaysSet) => {
        const hasSchedule = hasScheduleWindows(scheduleMap);
        let attempt = new Date(cursor);
        let guard = 0;
        while (guard < 40) {
            if (!hasSchedule) {
                const dayStart = getDayStart(attempt);
                const dayEnd = getDayEnd(attempt);
                if (attempt >= dayEnd) {
                    attempt = dayEnd;
                    guard++;
                    continue;
                }
                if (minutes === 0) {
                    return {intervals: [], start: new Date(attempt), end: new Date(attempt), dayStart};
                }
                const end = new Date(attempt.getTime() + minutes * 60000);
                if (end > dayEnd) {
                    attempt = dayEnd;
                    guard++;
                    continue;
                }
                return {
                    intervals: [{start: new Date(attempt), end}],
                    start: new Date(attempt),
                    end,
                    dayStart
                };
            }
            const aligned = alignToWorkingMoment(attempt, scheduleMap, workingDaysSet);
            if (!aligned) return null;
            const {instant, dayStart} = aligned;
            const dayEnd = getDayEnd(dayStart);
            const windows = getScheduleWindowsForWeekday(dayStart.getDay(), scheduleMap);
            if (minutes === 0) {
                return {intervals: [], start: instant, end: instant, dayStart};
            }
            const intervals = [];
            let remaining = minutes;
            let cursorPoint = new Date(instant);
            for (const window of windows) {
                const winStart = new Date(dayStart.getTime() + window.startMinutes * 60000);
                const winEnd = new Date(dayStart.getTime() + window.endMinutes * 60000);
                if (winEnd <= cursorPoint) continue;
                const slotStart = cursorPoint > winStart ? cursorPoint : winStart;
                if (slotStart >= winEnd) continue;
                const available = (winEnd - slotStart) / 60000;
                const used = Math.min(remaining, available);
                const segEnd = new Date(slotStart.getTime() + used * 60000);
                intervals.push({start: slotStart, end: segEnd});
                remaining -= used;
                cursorPoint = new Date(segEnd.getTime());
                if (remaining <= 0) break;
            }
            if (remaining <= 0) {
                return {
                    intervals,
                    start: intervals[0].start,
                    end: intervals[intervals.length - 1].end,
                    dayStart
                };
            }
            attempt = dayEnd;
            guard++;
        }
        return null;
    };
    const schedulePrintJob = (printerCursor, operatorCursor, prepMinutes, printMinutes, scheduleMap, workingDaysSet) => {
        let guard = 0;
        let attempt = new Date(Math.max(printerCursor.getTime(), operatorCursor.getTime()));
        while (guard < 60) {
            const prepBlock = scheduleOperatorStage(attempt, prepMinutes, scheduleMap, workingDaysSet);
            if (!prepBlock) return null;
            const dayStart = prepBlock.dayStart;
            const dayEnd = getDayEnd(dayStart);
            const earliestPrintStart = prepBlock.end;
            const readyTime = Math.max(earliestPrintStart.getTime(), printerCursor.getTime());
            if (readyTime >= dayEnd.getTime()) {
                attempt = new Date(Math.max(dayEnd.getTime(), printerCursor.getTime(), operatorCursor.getTime()));
                guard++;
                continue;
            }
            const printEnd = new Date(readyTime + printMinutes * 60000);
            if (printEnd > dayEnd) {
                attempt = new Date(Math.max(dayEnd.getTime(), printerCursor.getTime(), operatorCursor.getTime()));
                guard++;
                continue;
            }
            return {
                prepBlock,
                printStart: new Date(readyTime),
                printEnd,
                dayStart
            };
        }
        return null;
    };
    const buildScheduleSummary = (scheduleMap, breaksMap = {}) => {
        if (!hasScheduleWindows(scheduleMap)) return [];
        const summary = [];
        WEEKDAY_LABELS.forEach(day => {
            const windows = getScheduleWindowsForWeekday(day.value, scheduleMap);
            const breaks = Array.isArray(breaksMap[day.value]) ? breaksMap[day.value] : [];
            if (!windows.length && !breaks.length) return;
            const workLabel = windows.length
                ? windows.map(window => `${window.startLabel} — ${window.endLabel}`).join(', ')
                : '';
            const breakLabel = breaks.length
                ? breaks.map(br => `${br.startLabel} — ${br.endLabel}`).join(', ')
                : '';
            summary.push({
                dayLabel: day.label,
                weekdayValue: day.value,
                windowLabel: workLabel,
                breaksLabel: breakLabel,
                breaksRaw: breaks
            });
        });
        return summary;
    };
    const computeBreaksMap = (scheduleMap) => {
        const breaksMap = {};
        WEEKDAY_LABELS.forEach(day => {
            const periods = Array.isArray(scheduleMap[day.value]) ? scheduleMap[day.value] : [];
            const sorted = periods.slice().sort((a, b) => a.startMinutes - b.startMinutes);
            const dayBreaks = [];
            for (let i = 0; i < sorted.length - 1; i++) {
                const gapStart = sorted[i].endMinutes;
                const gapEnd = sorted[i + 1].startMinutes;
                if (gapEnd > gapStart) {
                    dayBreaks.push({
                        startMinutes: gapStart,
                        endMinutes: gapEnd,
                        duration: gapEnd - gapStart,
                        startLabel: minutesToTimeString(gapStart),
                        endLabel: minutesToTimeString(gapEnd)
                    });
                }
            }
            breaksMap[day.value] = dayBreaks;
        });
        return breaksMap;
    };
    const buildTimelineEvents = (printers, startDateStr, scheduleMap, breaksMap = {}) => {
        if (!Array.isArray(printers) || printers.length === 0) {
            return {events: [], scheduleSummary: []};
        }
        let base = startDateStr ? new Date(startDateStr) : new Date();
        if (Number.isNaN(base.getTime())) {
            base = new Date();
        }
        const workingDaysSet = getWorkingDaysSet(scheduleMap);
        const scheduleSummary = buildScheduleSummary(scheduleMap, breaksMap);
        const events = [];
        printers.forEach(pr => {
            let cursor = new Date(base.getTime());
            let operatorCursor = new Date(cursor.getTime());
            (pr.linesDetail || []).filter(ln => !ln.excludedFromTotals).forEach(line => {
                const prepMinutes = Math.max(0, line.printerPrepMinutes || 0);
                const printMinutes = Math.max(0, (line.hours || 0) * 60);
                const coolingMinutes = Math.max(0, line.coolingMinutes || 0);
                if (prepMinutes === 0 && printMinutes === 0 && coolingMinutes === 0) return;
                const jobSchedule = schedulePrintJob(cursor, operatorCursor, prepMinutes, printMinutes, scheduleMap, workingDaysSet);
                if (!jobSchedule) return;
                const {prepBlock, printStart, printEnd} = jobSchedule;
                if (prepMinutes > 0 && prepBlock && Array.isArray(prepBlock.intervals) && prepBlock.intervals.length) {
                    events.push({
                        printer: pr.printerName,
                        modelName: line.displayName || line.name,
                        modelId: line.id,
                        thumbnail: line.thumbnail || '',
                        type: 'prep',
                        status: line.status,
                        intervals: prepBlock.intervals.map(interval => ({start: new Date(interval.start), end: new Date(interval.end)})),
                        duration: prepMinutes,
                        start: prepBlock.intervals[0].start,
                        end: prepBlock.intervals[prepBlock.intervals.length - 1].end
                    });
                }
                if (printMinutes > 0) {
                    events.push({
                        printer: pr.printerName,
                        modelName: line.displayName || line.name,
                        modelId: line.id,
                        thumbnail: line.thumbnail || '',
                        type: 'print',
                        status: line.status,
                        intervals: [{start: printStart, end: printEnd}],
                        duration: printMinutes,
                        start: printStart,
                        end: printEnd
                    });
                }
                operatorCursor = prepBlock ? new Date(Math.max(operatorCursor.getTime(), prepBlock.end.getTime())) : operatorCursor;
                cursor = new Date(printEnd.getTime());
                if (coolingMinutes > 0) {
                    const coolEvent = {
                        printer: pr.printerName,
                        modelName: line.displayName || line.name,
                        modelId: line.id,
                        thumbnail: line.thumbnail || '',
                        type: 'cool',
                        status: line.status,
                        intervals: [],
                        duration: 0,
                        start: null,
                        end: null
                    };
                    let remaining = coolingMinutes;
                    let coolCursor = new Date(printEnd.getTime());
                    while (remaining > 0) {
                        const chunk = Math.min(remaining, 60);
                        const segStart = new Date(coolCursor.getTime());
                        const segEnd = new Date(segStart.getTime() + chunk * 60000);
                        coolEvent.intervals.push({start: segStart, end: segEnd});
                        coolEvent.duration += chunk;
                        remaining -= chunk;
                        coolCursor = new Date(segEnd.getTime());
                    }
                    if (coolEvent.intervals.length) {
                        coolEvent.start = coolEvent.intervals[0].start;
                        coolEvent.end = coolEvent.intervals[coolEvent.intervals.length - 1].end;
                        events.push(coolEvent);
                        cursor = new Date(coolEvent.end.getTime());
                    }
                }
            });
        });
        events.sort((a, b) => a.start - b.start);
        return {
            events,
            scheduleSummary
        };
    };

    /* Функции калькуляции */
    function renderCalcPrinters(){
        const c = document.getElementById("calcPrintersContainer");
        if(!c) return;
        c.innerHTML = "";
        const printers = Array.isArray(appData.printers) ? appData.printers : [];
        if(printers.length === 0){
            const placeholder = document.createElement('div');
            placeholder.className = 'calc-empty-placeholder text-muted small';
            placeholder.id = 'calcPrintersEmpty';
            placeholder.textContent = 'Добавьте модель или перетащите файл .gcode в данную область';
            c.appendChild(placeholder);
            return;
        }
        printers.forEach(pr => {
            const block = document.createElement("div");

            block.className = "border p-3 mb-3";
            block.classList.add('calc-printer-block');
            block.dataset.printerId = String(pr.id);
            block.innerHTML = `
      <h5>Принтер: ${pr.name} (ID: ${pr.id})<\/h5>
      <div class="small-text mb-2">
        Мощность: ${pr.power}Вт, Обсл: ${pr.maintCostHour}₽/ч, Часы окупаемости: ${pr.hoursToRecoup}.
      <\/div>
      <table class="table table-bordered table-sm mb-2" id="calcModelsTable_${pr.id}">
        <thead>
          <tr>
            <th>Имя модели<\/th>
            <th>Иконка<\/th>
            <th>Статус<\/th>
            <th>Часы печати<\/th>
            <th>Вес (г)<\/th>
            <th>Материал<\/th>
            <th>Этикетка<\/th>
            <th>Действия<\/th>
          <\/tr>
        <\/thead>
        <tbody><\/tbody>
      <\/table>
      <div class="calc-empty-placeholder text-muted small mb-3" id="calcModelsPlaceholder_${pr.id}">
        Добавьте модель или перетащите файл .gcode в данную область
      <\/div>
      <button class="btn btn-sm btn-primary" onclick="addModelRow(${pr.id}, {})">Добавить модель<\/button>
    `;
            c.appendChild(block);
            updatePrinterModelsEmptyState(pr.id);
        });
    }

    function updatePrinterModelsEmptyState(printerId){
        const placeholder = document.getElementById(`calcModelsPlaceholder_${printerId}`);
        if(!placeholder) return;
        const table = document.getElementById(`calcModelsTable_${printerId}`);
        const hasRows = table ? !!table.querySelector('tbody tr') : false;
        placeholder.style.display = hasRows ? 'none' : 'block';
    }

    // --- Model ID hygiene -------------------------------------------------
    // В расчёте модельный id используется в нескольких местах (таймлайн, группировки, этикетки и т.д.).
    // Если в таблицах появляются дубли (часто после импорта пачки G-code с одинаковым кодом),
    // то ломаются DOM-id (thumb_*), а также группировки в расчётах.
    // Поэтому: (1) при добавлении строки стараемся не допускать дублей; (2) перед расчётом
    // делаем нормализацию и «перестраиваем» id, если нашли коллизию.

    function __cssEscape(val){
        try { return (window.CSS && typeof window.CSS.escape === 'function') ? window.CSS.escape(String(val)) : String(val).replace(/[^a-zA-Z0-9_\-]/g, '\\$&'); }
        catch(e){ return String(val).replace(/[^a-zA-Z0-9_\-]/g, '\\$&'); }
    }

    function ensureUniqueModelId(desiredId, excludeRow){
        const id = String(desiredId);
        const sel = `[data-model-id="${__cssEscape(id)}"]`;
        const existing = document.querySelectorAll(sel);
        if (!existing || existing.length === 0) return id;
        if (excludeRow && existing.length === 1 && existing[0] === excludeRow) return id;
        // коллизия -> выдаём новый id из models
        return String(getNextId('models'));
    }

    function sanitizeModelId(rawValue, fallbackValue){
        const tryParse = (input) => {
            if (input === undefined || input === null) return null;
            const num = parseInt(input, 10);
            return !isNaN(num) && num > 0 ? num : null;
        };
        const parsedRaw = tryParse(rawValue);
        if (parsedRaw !== null) {
            return String(parsedRaw);
        }
        if (fallbackValue !== undefined) {
            const fallbackCandidate = typeof fallbackValue === 'function' ? fallbackValue() : fallbackValue;
            const parsedFallback = tryParse(fallbackCandidate);
            if (parsedFallback !== null) {
                return String(parsedFallback);
            }
        }
        return String(getNextId('models'));
    }

    function __updateRowModelIdArtifacts(row, oldId, newId){
        if(!row || String(oldId) === String(newId)) return;
        row.dataset.modelId = String(newId);

        // Обновляем подпись (в первой колонке small: (id))
        try {
            const small = row.querySelector('td small');
            if(small) small.textContent = `(${newId})`;
        } catch(e) {}

        // Обновляем миниатюры и file input id/handlers внутри строки
        const thumb = row.querySelector(`#thumb_${__cssEscape(oldId)}`);
        if(thumb){
            thumb.id = `thumb_${newId}`;
            thumb.setAttribute('onclick', `document.getElementById('thumbFile_${newId}').click()`);
        }
        const file = row.querySelector(`#thumbFile_${__cssEscape(oldId)}`);
        if(file){
            file.id = `thumbFile_${newId}`;
            file.setAttribute('onchange', `onModelThumbnailChange(event, '${newId}')`);
        }
    }

    function normalizeCalcModelIds(){
        const seen = new Set();
        appData.printers.forEach(pr => {
            const table = document.getElementById(`calcModelsTable_${pr.id}`);
            if(!table) return;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const raw = row.dataset.modelId;
                let id = sanitizeModelId(raw, () => getNextId('models'));
                if (raw === undefined || String(raw).trim() !== id) {
                    __updateRowModelIdArtifacts(row, raw, id);
                }
                if(seen.has(id)){
                    const oldId = id;
                    id = String(getNextId('models'));
                    __updateRowModelIdArtifacts(row, oldId, id);
                } else {
                    // также проверяем коллизии на уровне DOM (на всякий случай)
                    const unique = ensureUniqueModelId(id, row);
                    if(unique !== id){
                        const oldId = id;
                        id = unique;
                        __updateRowModelIdArtifacts(row, oldId, id);
                    }
                }
                seen.add(id);
            });
        });
    }

    function renderCalcUrgencySelect(){
        const select = document.getElementById('calcUrgencyProfile');
        const summary = document.getElementById('calcUrgencySummary');
        if (!select) return;
        const profiles = Array.isArray(appData.labelSettings.urgencyProfiles) ? appData.labelSettings.urgencyProfiles : [];
        select.innerHTML = '';
        profiles.forEach(profile => {
            const option = document.createElement('option');
            option.value = profile.id;
            const markupText = profile.markupPercent ? ` (+${profile.markupPercent}% )` : '';
            option.textContent = `${profile.title}${markupText}`;
            select.appendChild(option);
        });
        let currentId = appData.calcSettings.currentUrgencyId;
        if (!profiles.some(p => String(p.id) === String(currentId)) && profiles.length) {
            currentId = profiles[0].id;
        }
        if (profiles.length && !currentId) {
            currentId = profiles[0].id;
        }
        if (currentId) {
            select.value = currentId;
            appData.calcSettings.currentUrgencyId = currentId;
        }
        const updateSummary = () => {
            const profile = profiles.find(p => String(p.id) === String(select.value));
            let text = '';
            if (profile) {
                const markupText = profile.markupPercent ? ` +${profile.markupPercent}% к цене` : ' без доп.наценки';
                const desc = profile.description ? ` — ${profile.description}` : '';
                const manualMarkup = appData.calcSettings.markupPercent || 0;
                const manualText = manualMarkup ? `, ручная +${manualMarkup}%` : '';
                text = `${profile.title}${markupText}${manualText}${desc}`;
            }
            if (summary) summary.textContent = text;
            updateUrgencySummaryLabels(text || (profile ? profile.title : '—'));
            appData.calcSettings.currentUrgencyId = select.value;
        };
        select.onchange = updateSummary;
        const markupInputEl = document.getElementById('calcMarkupPercent');
        if (markupInputEl) markupInputEl.oninput = updateSummary;
        updateSummary();
    }
    function addModelRow(printerId, modelData) {
        ensureIconsLoaded();
        const table = document.getElementById(`calcModelsTable_${printerId}`);
        if(!table) return;
        const tbody = table.querySelector("tbody");
        const idx = tbody.rows.length + 1;
        const statuses = [
            {val:"new", text:"Новая"},
            {val:"inprogress", text:"Печать"},
            {val:"done", text:"Готова"},
            {val:"reject", text:"Брак"},
            {val:"canceled", text:"Отменена"}
        ];
        const optsStatus = statuses.map(s =>
            `<option value="${s.val}" ${(modelData.status === s.val) ? "selected" : ""}>${s.text}<\/option>`
        ).join("");
        const mats = getAllMaterialsForPrinter(printerId, true);
        const optsMat = mats.map(m => {
            const spoolmanText = m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : '';
            return `<option value="${m.id}" ${(modelData.materialId == m.id) ? "selected" : ""}>
    ${m.name} (ID: ${m.id}${spoolmanText})
  </option>`;
        }).join("");
        // ВАЖНО: уникальные id моделей и DOM-элементов должны жить в одном неймспейсе.
        // Раньше тут ошибочно использовался счётчик clients, что приводило к коллизиям/дублям.
        const uniqueId = getNextId('models');
        const nameId = `modelName_${printerId}_${uniqueId}`;
        const statusId = `modelStatus_${printerId}_${uniqueId}`;
        const hoursId = `modelHours_${printerId}_${uniqueId}`;
        const weightId = `modelWeight_${printerId}_${uniqueId}`;
        const materialId = `modelMaterial_${printerId}_${uniqueId}`;
        const labelId = `modelLabel_${printerId}_${uniqueId}`;
        const includeLabel = modelData.includeLabel !== false;
        const tr = document.createElement('tr');
        let candidateId = (modelData && modelData.id !== undefined && modelData.id !== null)
            ? modelData.id
            : uniqueId;
        let code = sanitizeModelId(candidateId, uniqueId);
        code = ensureUniqueModelId(code);
        tr.dataset.modelId = code;
        const companyLogoBase64 = getBrandLogoBase64();
        const placeholderThumbHtml = companyLogoBase64
            ? `<img id="thumb_${code}" src="data:image/png;base64,${companyLogoBase64}" style="height:40px;width:40px;object-fit:contain;border:1px solid #ccc;background:#fff;cursor:pointer" onclick="document.getElementById('thumbFile_${code}').click()"/>`
            : `<i id="thumb_${code}" class="bi bi-image" style="font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('thumbFile_${code}').click()"></i>`;
        const initialThumb = modelData.thumbnail || '';
        tr.dataset.thumbnail = initialThumb;
        tr.innerHTML = `
    <td><input type="text" class="form-control form-control-sm" id="${nameId}" data-role="model-name" placeholder="Название" value="${modelData.name || ''}" /> <small>(${code})<\/small><\/td>
    <td>
      ${initialThumb ? `<img id="thumb_${code}" src="data:image/png;base64,${initialThumb}" style="height:40px;width:40px;object-fit:contain;border:1px solid #ccc;background:#fff;cursor:pointer" onclick="document.getElementById('thumbFile_${code}').click()"/>` : placeholderThumbHtml}
      <input type="file" id="thumbFile_${code}" accept="image/png" class="d-none" onchange="onModelThumbnailChange(event, '${code}')">
    <\/td>
    <td>
      <select class="form-select form-select-sm" id="${statusId}" data-role="model-status">
        ${optsStatus}
      <\/select>
    <\/td>
    <td><input type="text" class="form-control form-control-sm time-input"
             id="${hoursId}" data-role="model-hours" placeholder="ч:м"
             value="${modelData.hours ? formatTimeForDisplay(modelData.hours) : ''}"
             onblur="this.value = formatTimeForDisplay(handleTimeInput({target: {value: this.value}}))" /><\/td>
    <td><input type="number" step="0.1" class="form-control form-control-sm" id="${weightId}" data-role="model-weight" placeholder="г" value="${modelData.weight || ''}" /><\/td>
    <td>
      <select class="form-select form-select-sm" id="${materialId}" data-role="model-material">
        <option value="">-Материал-<\/option>
        ${optsMat}
      <\/select>
    <\/td>
    <td>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="${labelId}" data-role="model-label" ${includeLabel ? 'checked' : ''}>
        <label class="form-check-label small" for="${labelId}">Печатать<\/label>
      </div>
    <\/td>
    <td><button class="btn btn-sm btn-danger" onclick="removeModelRow(this)">Удл.<\/button><\/td>
  `;
        tbody.appendChild(tr);
        updatePrinterModelsEmptyState(printerId);
        if (initialThumb) {
            ensureThumbnailOpaque(initialThumb).then(processed => {
                if (!processed || processed === initialThumb) return;
                tr.dataset.thumbnail = processed;
                const imgEl = tr.querySelector(`#thumb_${code}`);
                if (imgEl) {
                    imgEl.src = `data:image/png;base64,${processed}`;
                }
            });
        }
    }

    function removeModelRow(button){
        if(!button) return;
        const row = button.closest('tr');
        const table = row ? row.closest('table') : null;
        if(row) row.remove();
        if(table && table.id && table.id.startsWith('calcModelsTable_')){
            const printerId = table.id.substring('calcModelsTable_'.length);
            updatePrinterModelsEmptyState(printerId);
        }
    }
    function getAllMaterialsForPrinter(printerId, includeAll=false){
        return appData.materials.filter(m => {
            if(!includeAll && m.balance <= 0) return false;
            if(!Array.isArray(m.printers) || m.printers.length===0) return true;
            return m.printers.some(pid => String(pid) === String(printerId));
        });
    }

    let lastCalcFullData = null;

    let incomingLinkData = null;

    let lastSummaryCardHtml = '';

    let myNalogChallengeToken = '';

    let clientDropdownVisible = false;
    let currentCalcClientId = "";
    const MY_NALOG_API = 'https://lknpd.nalog.ru';


    function setCalcOrderId(value) {
        const input = document.getElementById("calcOrderId");
        if (input) input.value = value || "";
        const text = document.getElementById("calcOrderIdText");
        const displayValue = value && String(value).trim() ? value : "—";
        if (text) {
            text.textContent = displayValue;
        }
        const summaryOrder = document.getElementById("calcSummaryOrderId");
        if (summaryOrder) {
            summaryOrder.textContent = displayValue;
        }
        const heroOrder = document.getElementById("calcOrderIdHero");
        if (heroOrder) {
            heroOrder.textContent = displayValue;
        }
    }

    function syncCalcStatusDisplay() {
        const select = document.getElementById("calcOrderStatus");
        const label = getOrderStatusLabel(select ? select.value : '');
        ["calcSummaryStatus", "calcSummaryStatusSmall"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = label || '—';
        });
    }

    function updateClientSummaryLabels(name) {
        const text = name && String(name).trim() ? name : '—';
        ["calcSummaryClient", "calcSummaryClientHero"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        });
    }

    function updateUrgencySummaryLabels(label) {
        const text = label && String(label).trim() ? label : '—';
        ["calcSummaryUrgency", "calcSummaryUrgencyHero"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        });
    }

    function getBrandLogoBase64() {
        return appData && appData.labelSettings && appData.labelSettings.companyLogo
            ? appData.labelSettings.companyLogo
            : '';
    }

    function getBrandLogoDataUrl() {
        const base64 = getBrandLogoBase64();
        return base64 ? `data:image/png;base64,${base64}` : '';
    }

    function updateBrandLogoPreview(base64) {
        const preview = document.getElementById('brandLogoPreview');
        if (!preview) return;
        if (base64) {
            preview.src = `data:image/png;base64,${base64}`;
            preview.style.display = 'block';
        } else {
            preview.removeAttribute('src');
            preview.style.display = 'none';
        }
    }

    function onBrandLogoChange(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        if (file.type !== 'image/png') {
            alert('Загрузите логотип в формате PNG.');
            event.target.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = () => {
            const img = new Image();
            img.onload = () => {
                const size = 48;
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, size, size);
                const scale = Math.min(size / img.width, size / img.height, 1);
                const w = Math.max(1, Math.round(img.width * scale));
                const h = Math.max(1, Math.round(img.height * scale));
                const dx = Math.round((size - w) / 2);
                const dy = Math.round((size - h) / 2);
                ctx.drawImage(img, dx, dy, w, h);
                const dataUrl = canvas.toDataURL('image/png');
                const base64 = dataUrl.split(',')[1];
                appData.labelSettings.companyLogo = base64;
                updateBrandLogoPreview(base64);
                saveToLocalStorage();
            };
            img.onerror = () => alert('Не удалось обработать логотип. Попробуйте другой файл.');
            img.src = reader.result;
        };
        reader.readAsDataURL(file);
    }

    function clearBrandLogo() {
        const input = document.getElementById('brandLogoInput');
        if (input) {
            input.value = '';
        }
        if (appData && appData.labelSettings) {
            appData.labelSettings.companyLogo = '';
            saveToLocalStorage();
        }
        updateBrandLogoPreview('');
    }

    function ensureThumbnailOpaque(base64) {
        return new Promise(resolve => {
            if (!base64) return resolve('');
            const img = new Image();
            img.onload = () => {
                const width = img.width || 64;
                const height = img.height || 64;
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, width, height);
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/png');
                resolve(dataUrl.split(',')[1]);
            };
            img.onerror = () => resolve(base64);
            img.src = base64.startsWith('data:')
                ? base64
                : `data:image/png;base64,${base64}`;
        });
    }

    function setFieldValidityState(field, isValid) {
        if (!field) return;
        field.classList.toggle('is-invalid', !isValid);
    }

    function validateCalculationForm() {
        const errors = [];
        let firstInvalid = null;

        const registerError = (label, field) => {
            errors.push(label);
            if (!firstInvalid && field && typeof field.focus === 'function') {
                firstInvalid = field;
            }
        };

        const requireField = (field, label, predicate) => {
            if (!field) {
                registerError(label);
                return;
            }
            const rawValue = field.value ?? '';
            const isValid = predicate ? predicate(rawValue) : Boolean(String(rawValue).trim());
            setFieldValidityState(field, isValid);
            if (!isValid) {
                registerError(label, field);
            }
        };

        requireField(document.getElementById('calcName'), 'Название расчёта');
        requireField(document.getElementById('calcClientName'), 'Клиент');
        requireField(document.getElementById('calcOrderStatus'), 'Статус заказа', value => Boolean(String(value).trim()));
        requireField(document.getElementById('calcStartDate'), 'Дата начала', value => Boolean(String(value).trim()));

        const modelRows = document.querySelectorAll('[id^="calcModelsTable_"] tbody tr');
        modelRows.forEach((row, idx) => {
            const nameInput = row.querySelector('input[data-role="model-name"]');
            const statusSelect = row.querySelector('select[data-role="model-status"]');
            const hoursInput = row.querySelector('input[data-role="model-hours"]');
            const weightInput = row.querySelector('input[data-role="model-weight"]');
            const materialSelect = row.querySelector('select[data-role="model-material"]');
            const rowLabel = (nameInput && nameInput.value.trim()) ? nameInput.value.trim() : `Модель #${idx + 1}`;

            const requireRowField = (field, fieldLabel, predicate) => {
                if (!field) return;
                const rawValue = field.value ?? '';
                const isValid = predicate ? predicate(rawValue) : Boolean(String(rawValue).trim());
                setFieldValidityState(field, isValid);
                if (!isValid) {
                    registerError(`${rowLabel}: ${fieldLabel}`, field);
                }
            };

            requireRowField(nameInput, 'Название', value => Boolean(String(value).trim()));
            requireRowField(statusSelect, 'Статус', value => Boolean(String(value).trim()));
            requireRowField(hoursInput, 'Время печати', value => {
                const normalized = handleTimeInput({target: {value}});
                return normalized > 0;
            });
            requireRowField(weightInput, 'Вес', value => parseFloat(value) > 0);
            requireRowField(materialSelect, 'Материал', value => Boolean(String(value).trim()));
        });

        return {valid: errors.length === 0, errors, firstInvalid};
    }

    function formatSummaryDateLabel(value) {
        if (!value) return '—';
        try {
            const date = value instanceof Date ? value : new Date(value);
            if (isNaN(date.getTime())) return typeof value === 'string' ? value : '—';
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return typeof value === 'string' ? value : '—';
        }
    }

    const COST_STRUCTURE_COLORS = ['#2563eb', '#f97316', '#10b981', '#a855f7', '#ec4899', '#14b8a6', '#facc15', '#0ea5e9', '#ef4444'];

    function renderCostStructureList(items, total) {
        const container = document.getElementById('calcCostStructure');
        const placeholder = document.getElementById('calcCostStructureEmpty');
        if (!container) return;
        container.innerHTML = '';
        const list = Array.isArray(items) ? items.filter(item => item.value && item.value > 0) : [];
        const totalAmountRaw = list.reduce((sum, item) => sum + item.value, 0);
        const totalAmount = total && total > 0 ? total : totalAmountRaw;
        if (!list.length || totalAmount <= 0) {
            if (placeholder) placeholder.style.display = 'block';
            return;
        }
        if (placeholder) placeholder.style.display = 'none';
        const sorted = [...list].sort((a, b) => b.value - a.value);
        const segments = [];
        const rows = [];
        sorted.forEach((item, index) => {
            const percent = totalAmount > 0 ? (item.value / totalAmount) * 100 : 0;
            const color = item.color || COST_STRUCTURE_COLORS[index % COST_STRUCTURE_COLORS.length];
            const width = Math.max(percent, 1);
            segments.push(`
                <div class="calc-structure-segment" data-label="${percent >= 18 ? `${Math.round(percent)}%` : ''}" style="flex:${width};background:${color};"></div>
            `);
            rows.push(`
                <div class="calc-structure-row">
                    <span class="calc-structure-color" style="background:${color};"></span>
                    <div>
                        <div class="label">${item.label}</div>
                        <div class="meta">${percent.toFixed(1)}%</div>
                    </div>
                    <strong>${safeFixed(item.value)} ₽</strong>
                </div>
            `);
        });
        container.innerHTML = `
            <div class="calc-structure-chart">${segments.join('')}</div>
            <div class="calc-structure-breakdown">${rows.join('')}</div>
        `;
    }

    function buildResultInfoGrid(items = []) {
        if (!Array.isArray(items)) return '';
        return items
            .filter(item => item && item.value !== undefined && item.value !== null && String(item.value).trim() !== '')
            .map(item => `
                <div class="calc-result-info">
                    <span>${item.label || ''}</span>
                    <strong>${item.value}</strong>
                    ${item.hint ? `<small>${item.hint}</small>` : ''}
                </div>
            `).join('');
    }

    function buildOverheadCards(items = [], {totalLabel = 'В заказе (₽)', totalKey = 'costDistributed'} = {}) {
        if (!Array.isArray(items) || !items.length) return '';
        const cards = items.map(item => {
            const rawName = item && item.description ? item.description : '—';
            const name = escapeHtml(rawName);
            const base = typeof item.baseCost === 'number' ? `${safeFixed(item.baseCost)} ₽` : '—';
            const payback = item && item.hoursToRecoup ? item.hoursToRecoup : '—';
            const distributedRaw = item && typeof item[totalKey] === 'number' ? item[totalKey] : 0;
            const distributed = `${safeFixed(distributedRaw)} ₽`;
            return `
                <div class="calc-overhead-card">
                    <div class="calc-overhead-card-top">
                        <div class="calc-overhead-card-info">
                            <div class="calc-overhead-title">${name}</div>
                        </div>
                        <div class="calc-overhead-amount" title="${escapeHtml(totalLabel)}">${distributed}</div>
                    </div>
                    <div class="calc-overhead-meta-row">
                        <div class="calc-overhead-meta"><span>Исх. стоим.</span><strong>${base}</strong></div>
                        <div class="calc-overhead-meta"><span>Часы окуп.</span><strong>${payback}</strong></div>
                    </div>
                </div>
            `;
        }).join('');
        return `<div class="calc-overhead-grid">${cards}</div>`;
    }

    function updateCalculationInsights(details = {}) {
        const setText = (id, text) => {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        };
        const formatMoney = (val, {signed = false, precision = 2} = {}) => {
            if (typeof val !== 'number' || isNaN(val)) {
                return signed ? '— ₽' : '— ₽';
            }
            const absolute = safeFixed(Math.abs(val), precision);
            if (!signed) {
                return `${safeFixed(val, precision)} ₽`;
            }
            if (val === 0) return `${absolute} ₽`;
            const sign = val > 0 ? '+' : '-';
            return `${sign}${absolute} ₽`;
        };

        setText('calcSummaryTotal', typeof details.total === 'number' ? safeFixed(details.total) : '—');
        setText('calcSummaryCost', formatMoney(details.baseCost || 0));
        setText('calcSummaryMargin', formatMoney(details.marginAmount || 0, {signed: true}));
        setText('calcSummaryMarginPercent', typeof details.marginPercent === 'number'
            ? `${details.marginPercent.toFixed(1)}%`
            : '0%');
        setText('calcSummaryMarkup', `${safeFixed(details.markupPercent || 0, 1)}%`);
        setText('calcSummaryDiscount', `${safeFixed(details.discountPercent || 0, 1)}%`);
        setText('calcSummaryServices', formatMoney(details.servicesTotal || 0));
        setText('calcSummaryShipping', formatMoney(details.shipping || 0));
        setText('calcSummaryTax', formatMoney(details.taxAmount || 0));
        const parallelLabel = details.parallelMode === 'yes' ? 'Парал.' : 'Послед.';
        setText('calcSummaryParallel', parallelLabel);
        updateClientSummaryLabels(details.clientName || '');
        setText('calcSummaryStatus', details.statusLabel || '—');
        setText('calcSummaryStatusSmall', details.statusLabel || '—');
        setText('calcSummaryOrderId', details.orderId || document.getElementById('calcSummaryOrderId')?.textContent || '—');

        const urgencyText = details.urgencyLabel || document.getElementById('calcSummaryUrgency')?.textContent || '—';
        updateUrgencySummaryLabels(urgencyText);

        const startLabel = formatSummaryDateLabel(details.startDate);
        const finishLabel = formatSummaryDateLabel(details.finishDate);
        const deadlineLabelRaw = formatSummaryDateLabel(details.deadline);
        let deadlineLabel = deadlineLabelRaw;
        if (deadlineLabelRaw !== '—' && typeof details.deadlineMet === 'boolean') {
            deadlineLabel = `${deadlineLabelRaw} • ${details.deadlineMet ? 'в срок' : 'просрочено'}`;
        }

        setText('calcSummaryStart', startLabel);
        setText('calcSummaryDeadline', deadlineLabel);
        setText('calcSummaryFinish', finishLabel);


        const pricePerGramLabel = (typeof details.pricePerGram === 'number' && !isNaN(details.pricePerGram))
            ? `${safeFixed(details.pricePerGram)} ₽/г`
            : '—';
        const totalNoRoundedLabel = (typeof details.totalBeforeRounding === 'number' && !isNaN(details.totalBeforeRounding))
            ? `${safeFixed(details.totalBeforeRounding)} ₽`
            : '—';

        setText('calcPriceGramms', pricePerGramLabel);
        setText('callcFullNoRounded', totalNoRoundedLabel);

        const opPrintLabel = (typeof details.operatorPrintHours === 'number' && !isNaN(details.operatorPrintHours))
            ? `${formatTimeForDisplay(details.operatorPrintHours)} ч`
            : '—';
        const opExecLabel = (typeof details.operatorExecutionHours === 'number' && !isNaN(details.operatorExecutionHours))
            ? `${formatTimeForDisplay(details.operatorExecutionHours)} ч`
            : '—';
        const opDownLabel = (typeof details.operatorDowntimeHours === 'number' && !isNaN(details.operatorDowntimeHours))
            ? `${formatTimeForDisplay(details.operatorDowntimeHours)} ч`
            : '—';
        const opFullLabel = (typeof details.operatorFullHours === 'number' && !isNaN(details.operatorFullHours))
            ? `${formatTimeForDisplay(details.operatorFullHours)} ч`
            : '—';

        setText('calcOperPrintTime', opPrintLabel);
        setText('calcOperExecutionTime', opExecLabel);
        setText('calcOperFalseTime', opDownLabel);
        setText('calcOperFullTime', opFullLabel);









        renderCostStructureList(details.costStructure || [], details.baseCost || 0);

        const warningsBox = document.getElementById('calcSidebarWarnings');
        if (warningsBox) {
            if (details.warnings && details.warnings.length) {
                warningsBox.style.display = 'block';
                warningsBox.innerHTML = `<strong>Предупреждения:</strong><br>${details.warnings.join('<br/>')}`;
            } else {
                warningsBox.style.display = 'none';
                warningsBox.innerHTML = '';
            }
        }
    }

    function resetCalculationInsights() {
        setTextContentIfExists('calcSummaryTotal', '—');
        setTextContentIfExists('calcSummaryCost', '— ₽');
        setTextContentIfExists('calcSummaryMargin', '— ₽');
        setTextContentIfExists('calcSummaryMarginPercent', '0%');
        setTextContentIfExists('calcSummaryMarkup', '0%');
        setTextContentIfExists('calcSummaryDiscount', '0%');
        setTextContentIfExists('calcSummaryServices', '0 ₽');
        setTextContentIfExists('calcSummaryShipping', '0 ₽');
        setTextContentIfExists('calcSummaryTax', '0 ₽');
        setTextContentIfExists('calcSummaryStart', '—');
        setTextContentIfExists('calcSummaryDeadline', '—');
        setTextContentIfExists('calcSummaryFinish', '—');


        setTextContentIfExists('calcPriceGramms', '—');
        setTextContentIfExists('callcFullNoRounded', '—');
        setTextContentIfExists('calcOperPrintTime', '—');
        setTextContentIfExists('calcOperExecutionTime', '—');
        setTextContentIfExists('calcOperFalseTime', '—');
        setTextContentIfExists('calcOperFullTime', '—');





        setTextContentIfExists('calcSummaryParallel', '—');
        setTextContentIfExists('calcSummaryOrderId', document.getElementById('calcOrderIdText')?.textContent || '—');
        updateClientSummaryLabels('—');
        updateUrgencySummaryLabels('—');
        renderCostStructureList([], 0);
        const placeholder = document.getElementById('calcCostStructureEmpty');
        if (placeholder) placeholder.style.display = 'block';
        const warningsBox = document.getElementById('calcSidebarWarnings');
        if (warningsBox) {
            warningsBox.style.display = 'none';
            warningsBox.innerHTML = '';
        }
    }

    function setTextContentIfExists(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
    }

    function openSettingsTab() {
        const tabTrigger = document.getElementById('settings-tab');
        if (!tabTrigger) return;
        const tab = new bootstrap.Tab(tabTrigger);
        tab.show();
        const settingsSection = document.getElementById('settingsPane');
        if (settingsSection) {
            settingsSection.scrollIntoView({behavior: 'smooth', block: 'start'});
        }
    }

    function openGlobalMaterialsTab() {
        const tabTrigger = document.getElementById('globalMaterials-tab');
        if (!tabTrigger) return;
        const tab = new bootstrap.Tab(tabTrigger);
        tab.show();
        const section = document.getElementById('globalMaterialsPane');
        if (section) {
            section.scrollIntoView({behavior: 'smooth', block: 'start'});
        }
    }

    function showToast(message, options = {}) {
        const container = document.getElementById('globalToastContainer');
        if (!container) return;
        const toast = document.createElement('div');
        const type = options.type || 'dark';
        const delay = Number.isFinite(options.delay) ? options.delay : 10000;
        const actionHtml = options.actionHtml || '';
        toast.className = `toast text-bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="toast-body">${message}</div>
            ${actionHtml}
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"><\/button>
        <\/div>`;
        container.appendChild(toast);
        const toastInstance = new bootstrap.Toast(toast, {delay});
        toast.addEventListener('hidden.bs.toast', () => toast.remove());
        toastInstance.show();
    }

    function maybeShowMissingMaterialsToast() {
        if (window.__missingMaterialsToastShown) return;
        const hasMaterials = Array.isArray(appData.materials) && appData.materials.length > 0;
        if (hasMaterials) return;
        window.__missingMaterialsToastShown = true;
        showToast(
            'Нет общих материалов. Заполните таблицу «Общие материалы».',
            {
                delay: 10000,
                type: 'dark',
                actionHtml: '<div class="me-2"><button class="btn btn-sm btn-outline-light" onclick="openGlobalMaterialsTab()">Открыть<\/button><\/div>'
            }
        );
    }

    function getCalcOrderId() {
        const input = document.getElementById("calcOrderId");
        return input ? input.value.trim() : "";
    }

    function onCalculateAll() {
        const validationState = validateCalculationForm();
        if (!validationState.valid) {
            alert('Заполните обязательные поля:\n- ' + validationState.errors.join('\n- '));
            if (validationState.firstInvalid) {
                if (typeof validationState.firstInvalid.scrollIntoView === 'function') {
                    validationState.firstInvalid.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
                validationState.firstInvalid.focus();
            }
            return;
        }

        const calcName = document.getElementById("calcName").value.trim();
        let clientName = document.getElementById("calcClientName").value.trim();
        let clientId = currentCalcClientId || "";
        if(clientName){
            let c = clientId ? getClientById(clientId) : null;
            if (!c) {
                c = appData.clients.find(x => x.name === clientName);
            }
            if(!c){
                c = {id: getNextId('clients'), name: clientName};
                appData.clients.push(c);
                renderClientsTable();
                saveToLocalStorage();
            }
            clientId = c.id;
            currentCalcClientId = c.id;
        } else {
            currentCalcClientId = "";
        }
        const orderStatus = document.getElementById("calcOrderStatus").value;
        const opRate = parseFloat(document.getElementById("calcOperatorRate").value) || 0;
        const cKwh = parseFloat(document.getElementById("calcCostKwh").value) || 0;
        const tPercent = parseFloat(document.getElementById("calcTaxPercent").value) || 0;
        const roundingMode = document.getElementById("calcRoundingMode").value || "none";
        const ship = parseFloat(document.getElementById("calcShipping").value) || 0;
        const startDateInput = document.getElementById("calcStartDate");
        let sDate = startDateInput ? startDateInput.value : "";
        if (sDate) {
            sDate = normalizeDateTimeLocal(sDate);
            if (startDateInput) startDateInput.value = sDate;
        } else {
            sDate = getTodayIsoDate();
            if (startDateInput) startDateInput.value = sDate;
        }
        const deadlineInputEl = document.getElementById("calcDeadlineDate");
        const rawDeadline = deadlineInputEl ? deadlineInputEl.value : "";
        const normalizedDeadline = rawDeadline && rawDeadline.trim() ? normalizeDateTimeLocal(rawDeadline) : "";
        if (deadlineInputEl && rawDeadline && normalizedDeadline !== rawDeadline) {
            deadlineInputEl.value = normalizedDeadline;
        }
        const deadlineDate = normalizedDeadline ? parseDateTimeLocalToDate(normalizedDeadline) : null;
        const parallelMode = document.getElementById("calcParallelPrinting").value;
        const urgencySelectEl = document.getElementById("calcUrgencyProfile");
        let urgencyId = urgencySelectEl ? urgencySelectEl.value : (appData.calcSettings.currentUrgencyId || '');
        let urgencyProfile = getUrgencyProfileById(urgencyId);
        if (!urgencyProfile) {
            const allProfiles = appData.labelSettings.urgencyProfiles || [];
            urgencyProfile = allProfiles.find(p => p.id === appData.calcSettings.currentUrgencyId) || allProfiles[0] || null;
            if (urgencyProfile) {
                urgencyId = urgencyProfile.id;
            }
        }
        const initialUrgencyId = urgencyProfile ? urgencyProfile.id : null;
        let profileMarkupPercent = urgencyProfile ? (parseFloat(urgencyProfile.markupPercent) || 0) : 0;
        const userMarkupPercent = parseFloat(document.getElementById("calcMarkupPercent").value) || 0;
        let markupPercent = userMarkupPercent + profileMarkupPercent;
        const discountPercent = parseFloat(document.getElementById("calcDiscountPercent").value) || 0;
        const manualFinalCost = parseFloat(document.getElementById("calcFinalCost").value) || 0;
        const downtimeRate = parseFloat(document.getElementById("calcDowntimeCost").value) || 0;
        const prepRate = parseFloat(document.getElementById("calcPreparationRate").value) || 0;
        const prepTime = handleTimeInput({target:{value: document.getElementById("calcPreparationTime").value}});
        const includeOpRejects = document.getElementById("calcOperatorReject").checked;
        const includeAmortization = document.getElementById("settingsIncludeAmortization").checked;
        const includeRejectsInCost = document.getElementById("settingsIncludeRejects").checked;
        const includeOverheads = document.getElementById("settingsIncludeOverheads").checked;
        const ignoreCoolingRejects = document.getElementById("settingsIgnoreCoolingRejects").checked;
        const servicesArr = appData.calcSettings.customServices || [];
        const includeEstimatePrint = appData.calcSettings.includeEstimatePrint;
        const estimatePrintCost = includeEstimatePrint ? (parseFloat(appData.calcSettings.estimatePrintCost) || 0) : 0;
        let servicesTotal = 0;
        const servicesUsed = [];
        servicesArr.forEach(s=>{
            if(!s.use) return;
            const cost=parseFloat(s.cost)||0;
            const qty=parseFloat(s.qty)||0;
            let total=0;
            if(s.mode==='per_service') total=cost; else total=cost*qty;
            servicesTotal+=total;
            servicesUsed.push({id:s.id,name:s.name,cost:cost,qty:qty,mode:s.mode,use:true,total});
        });
        appData.calcSettings.deadlineDate = normalizedDeadline;
        let orderId = getCalcOrderId();
        let existingIndex = -1;
        const safeCalcName = (calcName || '').trim();
        const historyHasId = entry => entry && entry.id !== undefined && entry.id !== null;
        if (orderId) {
            existingIndex = appData.calcHistory.findIndex(entry => String(entry.id) === String(orderId));
        }
        if (existingIndex === -1 && safeCalcName) {
            existingIndex = appData.calcHistory.findIndex(entry => !historyHasId(entry) && entry.calcName === safeCalcName);
        }
        if (!orderId) {
            orderId = getNextOrderId();
        } else {
            const conflict = appData.calcHistory.some((entry, idx) => String(entry.id) === String(orderId) && idx !== existingIndex);
            if (conflict) {
                orderId = getNextOrderId();
            } else {
                const numericId = parseInt(orderId, 10);
                if (!isNaN(numericId)) {
                    if (!appData.counters) appData.counters = {};
                    if (!appData.counters.orders || appData.counters.orders < numericId) {
                        appData.counters.orders = numericId;
                    }
                }
            }
        }
        setCalcOrderId(orderId);

        // итоговый HTML для вывода
        var htmlRes = '';

        // Сохранение настроек расчёта
        appData.calcSettings.operatorRate = opRate;
        appData.calcSettings.includeOperatorForRejects = includeOpRejects;
        appData.calcSettings.costKwh = cKwh;
        appData.calcSettings.taxPercent = tPercent;
        appData.calcSettings.roundingMode = roundingMode;
        appData.calcSettings.shipping = ship;
        appData.calcSettings.parallelPrinting = parallelMode;
        appData.calcSettings.markupPercent = userMarkupPercent;
        appData.calcSettings.discountPercent = discountPercent;
        appData.calcSettings.downtimeCost = downtimeRate;
        appData.calcSettings.preparationRate = prepRate;
        appData.calcSettings.preparationTime = prepTime;
        appData.calcSettings.includeAmortization = includeAmortization;
        appData.calcSettings.includeRejects = includeRejectsInCost;
        appData.calcSettings.includeOverheads = includeOverheads;
        appData.calcSettings.ignoreCoolingRejects = ignoreCoolingRejects;
        appData.calcSettings.currentUrgencyId = urgencyId || (urgencyProfile ? urgencyProfile.id : appData.calcSettings.currentUrgencyId);

        saveToLocalStorage();

        // Санитизация id моделей: убираем дубли и пустые значения перед тем, как собрать calcData и строить расчёт.
        // Это «перестраивает» id на лету, если пользователь/импорт принесли коллизии.
        normalizeCalcModelIds();

        // Сохраняем исходные данные моделей для каждого принтера
        let calcData = {};
        appData.printers.forEach(pr => {
            const table = document.getElementById(`calcModelsTable_${pr.id}`);
            if (!table) return;
            const rows = table.querySelectorAll("tbody tr");
            let modelsData = [];
            rows.forEach(row => {
                const inpName = row.querySelector('input[data-role="model-name"]');
                const selStatus = row.querySelector('select[data-role="model-status"]');
                const inpH = row.querySelector('input[data-role="model-hours"]');
                const inpW = row.querySelector('input[data-role="model-weight"]');
                const selM = row.querySelector('select[data-role="model-material"]');
                const labelToggle = row.querySelector('input[data-role="model-label"]');
                if (!inpName || !selStatus || !inpH || !inpW || !selM) return;
                const h = handleTimeInput({target: {value: inpH.value}}); // Обрабатываем ввод
                const w = parseFloat(inpW.value) || 0;
                let midVal = row.dataset.modelId;
                if (midVal === undefined || midVal === null || String(midVal).trim() === '') {
                    midVal = String(getNextId('models'));
                    row.dataset.modelId = midVal;
                }
                modelsData.push({
                    id: String(midVal),
                    thumbnail: row.dataset.thumbnail || '',
                    name: inpName.value.trim() || "Модель",
                    status: selStatus.value || "new",
                    hours: h,
                    weight: w,
                    materialId: selM.value,
                    includeLabel: !labelToggle || labelToggle.checked
                });
            });
            calcData[pr.id] = modelsData;
        });

        // Агрегируем суммарное потребление пластика (в граммах) для каждого материала по всему расчёту
        let materialConsumption = {};

        // Расчёт затрат по принтерам
        let detailsByPrinter = [];
        let sumWithoutTax = 0;
        let totalMaterialCost = 0;
        let totalPrinterPartCost = 0;
        let totalElectricCost = 0;
        let totalMaintenanceCost = 0;
        let finalTimeAllPrinters = 0;
        let finalOpTimeAllPrinters = 0;
        let maxPrinterTime = 0;
        let maxOpPrinterTime = 0;
        let totalCoolingMinutes = 0;
        let totalPrinterPrepMinutes = 0;
        let totalRejectHours = 0;
        let totalRejectWeight = 0;

        appData.printers.forEach(pr => {
            const table = document.getElementById(`calcModelsTable_${pr.id}`);
            if (!table) return;

            let prTime = 0;
            let prOpTime = 0;
            let prCostNoTax = 0;
            let prPrepMinutes = 0;
            let lines = [];
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach(row => {
                const inpName = row.querySelector('input[data-role="model-name"]');
                const selStatus = row.querySelector('select[data-role="model-status"]');
                const inpH = row.querySelector('input[data-role="model-hours"]');
                const inpW = row.querySelector('input[data-role="model-weight"]');
                const selM = row.querySelector('select[data-role="model-material"]');
                const labelToggle = row.querySelector('input[data-role="model-label"]');
                if (!inpName || !selStatus || !inpH || !inpW || !selM) return;
                const h = handleTimeInput({target: {value: inpH.value}}); // Обрабатываем ввод
                const w = parseFloat(inpW.value) || 0;
                const mid = selM.value;
                if (!mid || h <= 0 || w <= 0) return;

                const status = selStatus.value || "new";
                const isReject = status === "reject";
                if (isReject) {
                    totalRejectHours += h;
                }

                const mat = getAllMaterialsForPrinter(pr.id).find(x => String(x.id) === String(mid));
                if (!mat) return;

                const realW = w;
                if (isReject) {
                    totalRejectWeight += realW;
                }
                // Агрегируем потребление для данного материала
                materialConsumption[mid] = (materialConsumption[mid] || 0) + realW;

                const includeModelTotals = includeRejectsInCost || !isReject;
                const matCoolingMinutes = parseFloat(mat.coolingTime) || 0;
                const matPrepMinutes = parseFloat(mat.printerPrepMinutes) || 0;
                if (includeModelTotals) {
                    prTime += h;
                    if (!isReject || includeOpRejects) prOpTime += h;
                    if (!(ignoreCoolingRejects && isReject)) {
                        totalCoolingMinutes += matCoolingMinutes;
                    }
                    if (matPrepMinutes > 0) {
                        prPrepMinutes += matPrepMinutes;
                        totalPrinterPrepMinutes += matPrepMinutes;
                    }
                }

                const costPH = (pr.hoursToRecoup > 0) ? pr.cost / pr.hoursToRecoup : 0;
                const rawPrinterPart = includeAmortization ? h * costPH : 0;
                const costPerGram = mat.costPerKg / 1000;
                const rawMaterialCost = realW * costPerGram;
                const rawElectric = (pr.power / 1000) * h * cKwh;
                const rawMaintenance = includeAmortization ? pr.maintCostHour * h : 0;

                const costPrinterPart = includeModelTotals ? rawPrinterPart : 0;
                const costMaterial = includeModelTotals ? rawMaterialCost : 0;
                const costElectric = includeModelTotals ? rawElectric : 0;
                const costMaint = includeModelTotals ? rawMaintenance : 0;
                const subTotalModel = costPrinterPart + costMaterial + costElectric + costMaint;

                totalPrinterPartCost += costPrinterPart;
                totalMaterialCost += costMaterial;
                totalElectricCost += costElectric;
                totalMaintenanceCost += costMaint;

                prCostNoTax += subTotalModel;

                const normalizedName = inpName.value.trim();
                const effectiveName = normalizedName || row.dataset.modelId || `Модель ${lines.length + 1}`;
                lines.push({
                    id: row.dataset.modelId || getNextId('models'),
                    thumbnail: row.dataset.thumbnail || '',
                    name: effectiveName,
                    displayName: normalizedName,
                    status: selStatus.value || "new",
                    hours: h,
                    weight: w,
                    matName: `${mat.name} (ID: ${mat.id})`,
                    realWeight: realW,
                    costPrinterPart: costPrinterPart,
                    costMaterial: costMaterial,
                    costElectric: costElectric,
                    costMaintenance: costMaint,
                    subTotalModel: subTotalModel,
                    excludedFromTotals: !includeModelTotals,
                    printerPrepMinutes: includeModelTotals ? matPrepMinutes : 0,
                    coolingMinutes: includeModelTotals ? matCoolingMinutes : 0,
                    includeLabel: !labelToggle || labelToggle.checked,
                    materialData: {
                        id: mat.id,
                        declaredWeight: mat.declaredWeight,
                        manufacturer: mat.manufacturer,
                        productionDate: mat.productionDate
                    }
                });
            });

            // Дополнительные расходы принтера удалены, но оставляем структуру для обратной совместимости
            let printerAdditionalDetails = [];

            if (parallelMode === "no") {
                finalTimeAllPrinters += prTime;
                finalOpTimeAllPrinters += prOpTime;
            } else {
                if (prTime > maxPrinterTime) maxPrinterTime = prTime;
                if (prOpTime > maxOpPrinterTime) maxOpPrinterTime = prOpTime;
            }

            sumWithoutTax += prCostNoTax;
            detailsByPrinter.push({
                printerId: pr.id,
                printerName: pr.name,
                linesDetail: lines,
                printerTime: prTime,
                printerPrepMinutes: prPrepMinutes,
                subTotal: prCostNoTax,
                additionalDetails: printerAdditionalDetails
            });
        });

        const hasSelectableProfiles = Array.isArray(appData.labelSettings.urgencyProfiles) && appData.labelSettings.urgencyProfiles.length;
        const profilePool = hasSelectableProfiles ? appData.labelSettings.urgencyProfiles : DEFAULT_URGENCY_PROFILES;
        let scheduleMinutesMap = getScheduleMinutesForProfile(urgencyProfile);
        let breaksMap = computeBreaksMap(scheduleMinutesMap || {});
        let timelineComputation = null;
        let autoSelectedProfileId = null;
        if (deadlineDate && profilePool.length) {
            const sortedProfiles = profilePool.slice().sort((a, b) => {
                const aMarkup = parseFloat(a.markupPercent) || 0;
                const bMarkup = parseFloat(b.markupPercent) || 0;
                return aMarkup - bMarkup;
            });
            let fallbackCandidate = null;
            for (const profile of sortedProfiles) {
                const candidateSchedule = getScheduleMinutesForProfile(profile);
                const candidateBreaks = computeBreaksMap(candidateSchedule || {});
                const candidateTimeline = buildTimelineEvents(detailsByPrinter, sDate, candidateSchedule, candidateBreaks);
                const candidateFinish = getTimelineEndDate(candidateTimeline.events);
                if (!fallbackCandidate || (candidateFinish && (!fallbackCandidate.finish || candidateFinish < fallbackCandidate.finish))) {
                    fallbackCandidate = {
                        profile,
                        schedule: candidateSchedule,
                        breaks: candidateBreaks,
                        timeline: candidateTimeline,
                        finish: candidateFinish
                    };
                }
                if (candidateFinish && candidateFinish <= deadlineDate) {
                    urgencyProfile = profile;
                    scheduleMinutesMap = candidateSchedule;
                    breaksMap = candidateBreaks;
                    timelineComputation = candidateTimeline;
                    autoSelectedProfileId = profile.id;
                    break;
                }
            }
            if (!timelineComputation && fallbackCandidate) {
                urgencyProfile = fallbackCandidate.profile;
                scheduleMinutesMap = fallbackCandidate.schedule;
                breaksMap = fallbackCandidate.breaks;
                timelineComputation = fallbackCandidate.timeline;
                autoSelectedProfileId = fallbackCandidate.profile.id;
            }
            if (autoSelectedProfileId) {
                if (hasSelectableProfiles && urgencySelectEl) {
                    const hasOption = Array.from(urgencySelectEl.options).some(opt => String(opt.value) === String(autoSelectedProfileId));
                    if (hasOption) {
                        urgencySelectEl.value = autoSelectedProfileId;
                        urgencySelectEl.dispatchEvent(new Event('change'));
                    }
                }
                appData.calcSettings.currentUrgencyId = autoSelectedProfileId;
            }
        }
        if (!timelineComputation) {
            timelineComputation = buildTimelineEvents(detailsByPrinter, sDate, scheduleMinutesMap, breaksMap);
        }
        const {
            events: timelineEvents,
            scheduleSummary: timelineScheduleSummary
        } = timelineComputation;
        profileMarkupPercent = urgencyProfile ? (parseFloat(urgencyProfile.markupPercent) || 0) : 0;
        markupPercent = userMarkupPercent + profileMarkupPercent;
        const timelineEndDate = getTimelineEndDate(timelineEvents);
        const deadlineMet = deadlineDate && timelineEndDate ? timelineEndDate <= deadlineDate : null;
        const autoDeadlineApplied = Boolean(deadlineDate && autoSelectedProfileId);
        const autoDeadlineChangedProfile = Boolean(autoDeadlineApplied && autoSelectedProfileId !== initialUrgencyId);

        // Проверяем для каждого материала, достаточно ли остатка
        let warnings = [];
        for (let mid in materialConsumption) {
            const required = materialConsumption[mid];
            const mat = findMaterialById(mid);
            if (mat && required > (mat.balance * 1000)) {
                warnings.push(`Материала "${mat.name}" недостаточно: требуется ${safeFixed(required)} г, остаток ${safeFixed(mat.balance * 1000)} г.`);
            }
        }

        const totalCoolingHours = totalCoolingMinutes / 60;
        const totalPrepHours = totalPrinterPrepMinutes / 60;
        const totalDowntimeMinutes = totalCoolingMinutes + totalPrinterPrepMinutes;
        const totalDowntimeHours = totalDowntimeMinutes / 60;
        let baseOperatorTime = (parallelMode === "yes") ? maxOpPrinterTime : finalOpTimeAllPrinters;
        let finalTimeOperator = baseOperatorTime;
        const operatorWorkCost = baseOperatorTime * opRate;
        const downtimeCost = totalDowntimeMinutes * downtimeRate;
        const preparationCost = prepTime * prepRate;
        const totalOperatorCost = operatorWorkCost + downtimeCost + preparationCost;

        let sumGlobalAdd = 0;
        let globalAdditionalDetails = [];
        if (includeOverheads) {
            appData.additionalGlobal.forEach(g => {
                if (!g.useInCalc) return;
                let hours = 0;
                detailsByPrinter.forEach(d=>{
                    if(!g.printers || g.printers.length===0 || g.printers.some(pid => String(pid) === String(d.printerId))){
                        const prepHours = (d.printerPrepMinutes || 0) / 60;
                        hours += d.printerTime + prepHours;
                    }
                });
                const costPerHour = (g.hoursToRecoup > 0) ? g.cost / g.hoursToRecoup : 0;
                const cVal = costPerHour * hours;
                sumGlobalAdd += cVal;
                globalAdditionalDetails.push({
                    id: g.id,
                    description: g.description,
                    baseCost: g.cost,
                    hoursToRecoup: g.hoursToRecoup,
                    costDistributed: cVal
                });
            });
        }

        let totalLabelsCost = 0;
        if(appData.labelSettings.printLabels) {
            const labelCost = appData.labelSettings.costPerLabel || 0;
            const totalModels = Object.values(calcData).reduce((acc, models) => {
                const allowedModels = models.filter(m =>
                    (includeRejectsInCost || (m.status !== 'reject')) &&
                    (m.includeLabel !== false)
                );
                return acc + allowedModels.length;
            }, 0);
            totalLabelsCost = totalModels * labelCost;
        }


        let subtotalBeforeTax = sumWithoutTax + sumGlobalAdd + ship + totalOperatorCost + totalLabelsCost + estimatePrintCost;
        if (markupPercent > 0) {
            subtotalBeforeTax *= (1 + markupPercent / 100);
        }
        subtotalBeforeTax += servicesTotal;
        const totalBeforeDiscount = tPercent > 0 ? subtotalBeforeTax / (1 - tPercent / 100) : subtotalBeforeTax;
        let finalSum = totalBeforeDiscount;
        if(discountPercent > 0){
            finalSum = finalSum * (1 - discountPercent / 100);
        }
        const totalBeforeRounding = finalSum;
        let roundingInfo = { mode: roundingMode || "none", step: 0, adjustment: 0 };
        if (manualFinalCost > 0) {
            finalSum = manualFinalCost;
        } else if (roundingMode !== "none") {
            const step = roundingMode === "round100" ? 100 : 10;
            const rounded = Math.ceil(finalSum / step) * step;
            const adjustment = rounded - finalSum;
            if (adjustment > 0.0001) {
                roundingInfo = { mode: roundingMode, step, adjustment };
                finalSum = rounded;
            }
        }
        const taxAmount = tPercent > 0 ? finalSum * (tPercent / 100) : 0;
        const subtotal = finalSum - taxAmount;
        const modelsRevenue = Math.max(0, finalSum - ship - servicesTotal);
        const totalWeight = detailsByPrinter.reduce((acc, printer) =>
            acc + printer.linesDetail.reduce((sum, line) => sum + (line.excludedFromTotals ? 0 : line.realWeight), 0), 0);
        const pricePerGram = totalWeight > 0 ? modelsRevenue / totalWeight : 0;
        const baseCost = sumWithoutTax + sumGlobalAdd + ship + totalOperatorCost + totalLabelsCost + estimatePrintCost + servicesTotal;
        const profitBeforeTax = subtotal - baseCost;
        const marginPercent = subtotal > 0 ? (profitBeforeTax / subtotal) * 100 : 0;
        const shippingBucket = ship + totalLabelsCost + estimatePrintCost;
        const costStructureItems = [
            {label: 'Материалы', value: totalMaterialCost, color: '#0ea5e9'},
            {label: 'Амортизация', value: totalPrinterPartCost, color: '#6366f1'},
            {label: 'Электроэнергия', value: totalElectricCost, color: '#22d3ee'},
            {label: 'Обслуживание', value: totalMaintenanceCost, color: '#a855f7'},
            {label: 'Работа оператора', value: operatorWorkCost, color: '#22c55e'},
            {label: 'Простои и охлаждение', value: downtimeCost, color: '#f97316'},
            {label: 'Подготовка', value: preparationCost, color: '#06b6d4'},
            {label: 'Накладные расходы', value: sumGlobalAdd, color: '#f59e0b'},
            {label: 'Услуги', value: servicesTotal, color: '#ec4899'},
            {label: 'Доставка и этикетки', value: shippingBucket, color: '#94a3b8'}
        ].filter(item => item.value > 0.009);

        let finDateStr = calcFinishDate(timelineEvents, sDate);

        const urgencyLabel = urgencyProfile ? `${urgencyProfile.title}${profileMarkupPercent ? ` (+${profileMarkupPercent}% )` : ''}` : '—';
        const startLabel = formatSummaryDateLabel(sDate);
        const finishLabel = timelineEndDate ? formatSummaryDateLabel(timelineEndDate) : (finDateStr || '—');
        const deadlineLabel = deadlineDate ? formatSummaryDateLabel(deadlineDate) : '';
        const urgencyHintParts = [];
        if (autoDeadlineApplied) {
            urgencyHintParts.push('подбор по дедлайну');
            if (autoDeadlineChangedProfile) {
                urgencyHintParts.push('профиль изменён');
            }
        }
        if (deadlineMet === false) {
            urgencyHintParts.push('дедлайн просрочен');
        }
        const downtimeParts = [];
        if (totalCoolingHours > 0) {
            downtimeParts.push(`усадка: ${formatTimeForDisplay(totalCoolingHours)} ч`);
        }
        if (totalPrepHours > 0) {
            downtimeParts.push(`подготовка: ${formatTimeForDisplay(totalPrepHours)} ч`);
        }
        const downtimeHintParts = [];
        if (downtimeParts.length) downtimeHintParts.push(downtimeParts.join(', '));
        downtimeHintParts.push(`${safeFixed(downtimeCost)} ₽`);

        htmlRes = ``;

        if (servicesUsed.length > 0) {
            const serviceRows = servicesUsed.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${safeFixed(s.cost)}</td>
                    <td>${safeFixed(s.qty)}</td>
                    <td>${getServiceModeLabel(s.mode)}</td>
                    <td class="text-end">${safeFixed(s.total)} ₽</td>
                </tr>
            `).join('');
            htmlRes += `
                <div class="calc-result-card">
                    <div class="calc-result-card-title">Дополнительные услуги</div>
                    <div class="calc-result-table table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                            <thead>
                                <tr>
                                    <th>Услуга</th>
                                    <th>Цена</th>
                                    <th>Кол-во</th>
                                    <th>Тип</th>
                                    <th class="text-end">Итого</th>
                                </tr>
                            </thead>
                            <tbody>${serviceRows}</tbody>
                        </table>
                    </div>
                    <div class="text-end fw-semibold mt-2">Всего: ${safeFixed(servicesTotal)} ₽</div>
                </div>
            `;
        }

        if (deadlineDate && autoDeadlineApplied) {
            if (deadlineMet === false) {
                htmlRes += `<div class="text-danger small mt-2">⚠️ Даже при максимально быстром профиле срок не соблюдается — сократите объём или расширьте график.<\/div>`;
            } else if (autoDeadlineChangedProfile && urgencyProfile) {
                htmlRes += `<div class="text-muted small mt-2">Профиль срочности автоматически изменён на "${urgencyProfile.title}".<\/div>`;
            }
        } else if (deadlineDate && deadlineMet === false) {
            htmlRes += `<div class="text-danger small mt-2">⚠️ Дедлайн не соблюдается. Попробуйте выбрать более срочный профиль или скорректировать график.<\/div>`;
        }

        // формируем HTML карточки итогов для скачивания
        const brandLogoDataUrl = getBrandLogoDataUrl();
        const fallbackModelCardImg = brandLogoDataUrl ? `<img src="${brandLogoDataUrl}" alt="logo">` : '';
        let summaryModels = '';
        detailsByPrinter.forEach(pr => {
            pr.linesDetail.forEach(ln => {
                if (ln.excludedFromTotals) return;
                const statusLabel = getModelStatusLabel(ln.status);
                const qualityLabel = getModelQualityLabel(ln.status);
                const statusDisplay = qualityLabel ? `${statusLabel} — ${qualityLabel}` : statusLabel;
                summaryModels += `<div class="model-card">` +
                    (ln.thumbnail ? `<img src="data:image/png;base64,${ln.thumbnail}" alt="icon">` : fallbackModelCardImg) +
                    `<h3>${ln.name}<\/h3>` +
                    `<p><strong>Требуется:<\/strong> ${formatTimeForDisplay(ln.hours)}<\/p>` +
                    `<p><strong>Вес:<\/strong> ${safeFixed(ln.realWeight)} г<\/p>` +
                    `<p><strong>Материал:<\/strong> ${ln.matName}<\/p>` +
                    `<p><strong>Статус:<\/strong> ${statusDisplay}<\/p>` +
                    `</div>`;
            });
        });
        const qrText = buildPaymentQrString();
        generateQRCodeCanvas(qrText, 120, function(qrCanvas){
            const qrDataUrl = qrCanvas ? qrCanvas.toDataURL('image/png') : '';
            const roundingNote = roundingInfo.adjustment > 0
                ? `+${safeFixed(roundingInfo.adjustment)} ₽ до ${roundingInfo.step} ₽`
                : '';
            lastSummaryCardHtml = buildSummaryCardHtml({
                company: appData.labelSettings.companyName,
                logo: brandLogoDataUrl,
                orderId,
                orderName: calcName || '(Без названия)',
                client: clientName || '(Не указан)',
                status: getOrderStatusLabel(orderStatus),
                totalTime: formatTimeForDisplay(finalTimeOperator) + ' ч',
                totalTimeOperator: formatTimeForDisplay(finalTimeOperator + prepTime + totalDowntimeHours) + ' ч',
                downtimeTotalHours: formatTimeForDisplay(totalDowntimeHours),
                downtimeCoolingHours: formatTimeForDisplay(totalCoolingHours),
                downtimePrepHours: formatTimeForDisplay(totalPrepHours),
                downtimeCost: safeFixed(downtimeCost),

                prepTime: formatTimeForDisplay(prepTime),
                preparationCost: safeFixed(preparationCost),
                roundingNote,


                totalWeight: safeFixed(totalWeight),
                totalCost: safeFixed(finalSum),
                priceOld: discountPercent > 0 ? safeFixed(totalBeforeDiscount) : '',
                discountPercent,
                pricePerGram: safeFixed(pricePerGram),
                finDate: finDateStr,
                modelsHtml: summaryModels,
                qr: qrDataUrl,
                paymentInfo: appData.labelSettings.bankDetails,
                services: servicesUsed,
                servicesTotal: safeFixed(servicesTotal),
                estimatePrintCost: includeEstimatePrint && estimatePrintCost > 0 ? safeFixed(estimatePrintCost) : '',
                urgencyTitle: urgencyProfile ? urgencyProfile.title : '',
                urgencyProfileMarkup: profileMarkupPercent,
                urgencyUserMarkup: userMarkupPercent
            });
        });
        if (warnings.length > 0) {
            htmlRes += `<div class="calc-result-alert alert alert-warning mt-3"><strong>Предупреждения:<\/strong><br/>` + warnings.join("<br/>") + `<\/div>`;
        }


        const activePrinters = detailsByPrinter.filter(d => (d.linesDetail && d.linesDetail.length) || d.printerTime > 0);
        if (activePrinters.length > 0) {
            htmlRes += `<div class="calc-result-card"><div class="calc-result-card-title">Детализация по принтерам<\/div><div class="calc-result-printers-grid">`;
            activePrinters.forEach(d => {
                const printerWeight = d.linesDetail.reduce((sum, ln) => sum + (ln.realWeight || 0), 0);
                const printerInfo = buildResultInfoGrid([
                    {label: 'Время', value: `${formatTimeForDisplay(d.printerTime)} ч`},
                    {label: 'Моделей', value: d.linesDetail.length},
                    {
                        label: 'Подготовка',
                        value: d.printerPrepMinutes ? `${formatTimeForDisplay((d.printerPrepMinutes || 0) / 60)} ч` : ''
                    },
                    {label: 'Стоимость', value: `${safeFixed(d.subTotal)} ₽`},
                    {label: 'Вес', value: `${safeFixed(printerWeight)} г`}
                ]);
                htmlRes += `<div class="calc-printer-card">`;
                htmlRes += `<div class="calc-printer-card-header"><div><div class="calc-printer-title">${d.printerName}<\/div><div class="calc-printer-meta">ID: ${d.printerId}<\/div><\/div><\/div>`;
                if (printerInfo) {
                    htmlRes += `<div class="calc-result-info-grid compact">${printerInfo}<\/div>`;
                }
                if (d.linesDetail.length > 0) {
                    const modelRows = d.linesDetail.map((ln, idx) => {
                        const statusLabel = getModelStatusLabel(ln.status);
                        const qualityLabel = getModelQualityLabel(ln.status);
                        const safeNameRaw = escapeHtml(ln.name || '');
                        const rawId = ln.id ? escapeHtml(String(ln.id)) : '';
                        const displayName = safeNameRaw && safeNameRaw !== rawId ? safeNameRaw : `Модель ${idx + 1}`;
                        const idBadge = rawId ? `#${idx + 1} · ${rawId}` : `#${idx + 1}`;
                        const safeMaterial = escapeHtml(ln.matName || '—');
                        const excludedNote = ln.excludedFromTotals ? ' <span class="badge bg-secondary ms-1">Не в расчёте<\/span>' : '';
                        const status = [statusLabel, qualityLabel].filter(Boolean).join(' · ') || '—';
                        const chipStats = [
                            {icon: '⏱', value: `${formatTimeForDisplay(ln.hours)} ч`},
                            {icon: '⚖', value: `${safeFixed(ln.realWeight)} г`},
                            {icon: '⚙', value: `${safeFixed(ln.costPrinterPart)} ₽`},
                            {icon: '🧵', value: `${safeFixed(ln.costMaterial)} ₽`},
                            {icon: '⚡', value: `${safeFixed(ln.costElectric)} ₽`},
                            {icon: '🛠', value: `${safeFixed(ln.costMaintenance)} ₽`}
                        ];
                        const chipHtml = chipStats.map(stat => `<span class="calc-printer-chip">${stat.icon} ${stat.value}</span>`).join('');
                        const avatarLetter = escapeHtml((displayName || '?').charAt(0).toUpperCase());
                        const brandLogoUrl = getBrandLogoDataUrl();
                        const avatarFallback = brandLogoUrl
                            ? `<img src="${brandLogoUrl}" alt="${displayName}"/>`
                            : `<span>${avatarLetter}</span>`;
                        const avatar = ln.thumbnail
                            ? `<img src="data:image/png;base64,${ln.thumbnail}" alt="${displayName}"/>`
                            : avatarFallback;
                        return `
                            <div class="calc-printer-model-card mt-3">
                                <div class="calc-printer-card-head">
                                    <div class="calc-printer-head-left">
                                        <div class="calc-printer-avatar">${avatar}</div>
                                        <div class="calc-printer-head-text">
                                            <div class="calc-printer-title-row text-truncate" title="${displayName}">
                                                ${displayName}${excludedNote}
                                            </div>
                                            <div class="calc-printer-status-row">
                                                <div class="calc-printer-status text-truncate">${escapeHtml(status || '')}</div>
                                                <span class="calc-printer-id">${idBadge}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="calc-printer-card-actions">
                                        <div class="calc-printer-card-total">${safeFixed(ln.subTotalModel)} ₽</div>
                                        <button class="btn btn-sm btn-outline-secondary"
                                            onclick="downloadThermoLabelHtml('${ln.name}', '${d.printerName}', '${ln.matName}', '${safeFixed(ln.hours)}', '${safeFixed(ln.realWeight)}', '${ln.thumbnail || ''}')"
                                            ${ln.excludedFromTotals ? 'disabled title="Модель исключена из расчёта"' : ''}>
                                            Этикетка
                                        </button>
                                    </div>
                                </div>
                                <div class="calc-printer-info">
                                    <h5 class="text-truncate">${safeMaterial}</h5>
                                    <div class="calc-printer-chips">${chipHtml}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    htmlRes += `<div class="calc-printer-model-list">${modelRows}<\/div>`;
                }

                if (d.additionalDetails && d.additionalDetails.length > 0) {
                    let sumPrinterAdditional = 0;
                    d.additionalDetails.forEach(ad => {
                        sumPrinterAdditional += ad.costDistributed;
                    });
                    htmlRes += buildOverheadCards(d.additionalDetails, {totalLabel: 'Распределено (₽)'});
                    htmlRes += `<div class="text-muted small mt-2">Накладные по принтеру: ${safeFixed(sumPrinterAdditional)} ₽<\/div>`;
                }
                htmlRes += `<\/div>`;
            });
            htmlRes += `<\/div><\/div>`;
        }


        if (timelineEvents.length > 0) {
            htmlRes += `<div class="calc-result-card"><div class="calc-result-card-title">График печати<\/div>`;
            const timelineGroups = [];
            const printerOrder = [];
            const now = new Date();
            timelineEvents.forEach(evt => {
                const anchor = evt.start || (Array.isArray(evt.intervals) && evt.intervals.length ? evt.intervals[0].start : null);
                const baseDate = anchor instanceof Date ? anchor : (evt.intervals && evt.intervals[0] && evt.intervals[0].start instanceof Date ? evt.intervals[0].start : null);
                if (!baseDate) return;
                const dayDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
                const dayKey = dayDate.getTime();
                let group = timelineGroups.find(g => g.key === dayKey);
                if (!group) {
                    const dayLabel = dayDate.toLocaleDateString('ru-RU', {
                        weekday: 'long',
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    const isCurrentDay = dayDate.toDateString() === now.toDateString();
                    group = {key: dayKey, label: dayLabel, printers: [], isCurrentDay};
                    timelineGroups.push(group);
                }
                let printerGroup = group.printers.find(p => p.printer === (evt.printer || '—'));
                if (!printerGroup) {
                    printerGroup = {printer: evt.printer || '—', models: []};
                    group.printers.push(printerGroup);
                    if (!printerOrder.includes(printerGroup.printer)) printerOrder.push(printerGroup.printer);
                }
                const rawModelName = evt.modelName && evt.modelName.trim() ? evt.modelName.trim() : '';
                const fallbackModelId = evt.modelId || '';
                const modelLabel = rawModelName || fallbackModelId || '—';
                const modelKey = fallbackModelId || modelLabel;
                let modelGroup = printerGroup.models.find(m => m.key === modelKey);
                if (!modelGroup) {
                    modelGroup = {
                        key: modelKey,
                        modelLabel,
                        modelName: rawModelName,
                        modelId: fallbackModelId,
                        thumbnail: evt.thumbnail || '',
                        slots: []
                    };
                    printerGroup.models.push(modelGroup);
                } else if (!modelGroup.thumbnail && evt.thumbnail) {
                    modelGroup.thumbnail = evt.thumbnail;
                }
                modelGroup.slots.push(evt);
            });
            timelineGroups.sort((a, b) => a.key - b.key);
            printerOrder.sort((a, b) => a.localeCompare(b));

            const dayBlocks = [];
            timelineGroups.forEach(group => {
                const containerClass = group.isCurrentDay ? 'timeline-day-container timeline-day-current' : 'timeline-day-container';
                const dayDateObj = new Date(group.key);
                const getPrinterFirstEvent = (printerGroup) => printerGroup.models
                    .flatMap(model => model.slots)
                    .map(slot => slot.start || (slot.intervals && slot.intervals[0] && slot.intervals[0].start))
                    .filter(Boolean)
                    .sort((a, b) => a - b)[0] || null;
                const dayPrinters = group.printers
                    .slice()
                    .sort((a, b) => {
                        const firstA = getPrinterFirstEvent(a);
                        const firstB = getPrinterFirstEvent(b);
                        if (firstA && firstB) return firstA - firstB;
                        if (firstA) return -1;
                        if (firstB) return 1;
                        return printerOrder.indexOf(a.printer) - printerOrder.indexOf(b.printer);
                    });
                const dayBreakInfo = (timelineScheduleSummary || []).find(entry => entry.weekdayValue === dayDateObj.getDay());
                const breakRows = dayBreakInfo && Array.isArray(dayBreakInfo.breaksRaw) ? dayBreakInfo.breaksRaw : [];
                const dayBreakEntries = breakRows
                    .map(br => ({
                        ...br,
                        startDate: new Date(dayDateObj.getTime() + (br.startMinutes || 0) * 60000),
                        endDate: new Date(dayDateObj.getTime() + (br.endMinutes || 0) * 60000)
                    }))
                    .sort((a, b) => a.startDate - b.startDate);
                let breakPointer = 0;
                const dayTableRows = [];
                const renderBreaksUpTo = (limitDate) => {
                    while (breakPointer < dayBreakEntries.length && dayBreakEntries[breakPointer].startDate <= limitDate) {
                        const br = dayBreakEntries[breakPointer];
                        const timeRange = `${formatTimeOnly(br.startDate)} — ${formatTimeOnly(br.endDate)}`;
                        const durationLabel = br.duration ? minutesToDuration(br.duration) : '—';
                        dayTableRows.push(`<tr class="timeline-break-row">
            <td>${timeRange}</td>
            <td>${durationLabel}</td>
            <td>Перерыв</td>
          </tr>`);
                        breakPointer++;
                    }
                };
                let dayTotalMinutes = 0;
                dayPrinters.forEach(prGroup => {
                    dayTableRows.push(`<tr class="timeline-printer-row"><td colspan="5" class="text-center"><strong>Принтер: ${prGroup.printer}</strong></td></tr>`);
                    prGroup.models.forEach(modelGroup => {
                        const hasReject = modelGroup.slots.some(slot => slot.status === 'reject');
                        const modelQuality = hasReject ? ' — Брак' : '';
                        const brandLogoUrl = getBrandLogoDataUrl();
                        const modelIcon = modelGroup.thumbnail
                            ? `<img src="data:image/png;base64,${modelGroup.thumbnail}" alt="${modelGroup.modelLabel}" class="timeline-model-thumb">`
                            : (brandLogoUrl
                                ? `<img src="${brandLogoUrl}" alt="${modelGroup.modelLabel}" class="timeline-model-thumb">`
                                : `<i class="bi bi-box text-primary"></i>`);
                        const secondaryId = modelGroup.modelName && modelGroup.modelId && modelGroup.modelId !== modelGroup.modelLabel
                            ? `<span class="timeline-model-id">${modelGroup.modelId}</span>`
                            : '';
                        dayTableRows.push(`<tr class="timeline-model-row"><td colspan="5"><div class="timeline-model-title">${modelIcon}<strong>${modelGroup.modelLabel}${modelQuality}</strong>${secondaryId}</div></td></tr>`);
                        modelGroup.slots.forEach(evt => {
                            const intervals = Array.isArray(evt.intervals) && evt.intervals.length ? evt.intervals : [{
                                start: evt.start,
                                end: evt.end
                            }];
                            const eventStart = intervals[0].start || evt.start || new Date(group.key);
                            renderBreaksUpTo(eventStart);
                            const stage = TIMELINE_STAGE_LABELS[evt.type] || evt.type;
                            const timeRange = intervals.map(interval => `${formatTimeOnly(interval.start)} — ${formatTimeOnly(interval.end)}`).join('<br/>');
                            const isCurrentSlot = intervals.some(interval => now >= interval.start && now <= interval.end);
                            const slotClass = isCurrentSlot ? 'timeline-slot-current' : '';
                            const nowBadge = isCurrentSlot ? ' <span class="badge bg-warning text-dark ms-2">Сейчас</span>' : '';
                            dayTableRows.push(`<tr class="${slotClass}">
                    <td>${timeRange}${nowBadge}</td>
          <td>${minutesToDuration(evt.duration || 0)}</td>
          <td>${stage}</td>
        </tr>`);
                            dayTotalMinutes += evt.duration || 0;
                            const eventEnd = intervals[intervals.length - 1].end || evt.end || eventStart;
                            renderBreaksUpTo(eventEnd);
                        });
                    });
                });
                renderBreaksUpTo(new Date(dayDateObj.getTime() + 24 * 60 * 60000 - 1));
                const dayBodyHtml = dayTableRows.join('');
                dayBlocks.push(`<div class="${containerClass}">
        <div class="timeline-day-title">${group.label}<\/div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle mb-0">
            <thead>
              <tr>
                <th style="width:35%;">Время<\/th>
                <th style="width:15%;">Длительность<\/th>
                <th style="width:20%;">Этап<\/th>
              <\/tr>
            <\/thead>
            <tbody>${dayBodyHtml}<\/tbody>
          <\/table>
        <\/div>
        <div class="timeline-day-summary">Итого за день: ${minutesToDuration(dayTotalMinutes)}<\/div>
      <\/div>`);
            });
            if (dayBlocks.length) {
                htmlRes += `<div class="timeline-days-grid">${dayBlocks.join('')}</div>`;
            }
            const scheduleSummaryText = (timelineScheduleSummary || []).map(window => `${window.dayLabel}: ${window.windowLabel}`).join('; ');
            const scheduleText = scheduleSummaryText ? `Рабочие окна: ${scheduleSummaryText}. ` : '';
            const scheduleStartDate = new Date(sDate);
            const startLabel = Number.isNaN(scheduleStartDate.getTime()) ? sDate : formatTimelineTime(scheduleStartDate);
            htmlRes += `<div class="text-muted small mt-2">${scheduleText}График учитывает только рабочие периоды оператора и формируется от даты начала ${startLabel}.<\/div><\/div>`;
        }


        if (globalAdditionalDetails.length > 0) {
            const overheadCards = buildOverheadCards(globalAdditionalDetails, {totalLabel: 'В заказе (₽)'});
            htmlRes += `<div class="calc-result-card"><div class="calc-result-card-title">Накладные расходы<\/div>${overheadCards}<div class="calc-overhead-total">Всего: ${safeFixed(sumGlobalAdd)} ₽<\/div><\/div>`;
        }

        const calcResultEmptyEl = document.getElementById("calcResultEmpty");
        if (calcResultEmptyEl) {
            calcResultEmptyEl.style.display = 'none';
        }
        const calcResultContainer = document.getElementById("calcResult");
        if (calcResultContainer) {
            calcResultContainer.style.display = "block";
            calcResultContainer.innerHTML = htmlRes;
        }
        const qrTarget=document.getElementById("orderSummaryQr");
        if(qrTarget){
            new QRCode(qrTarget,{text:appData.labelSettings.chatLink,width:120,height:120,correctLevel:QRCode.CorrectLevel.H});
        }
        const summaryBtn=document.getElementById("downloadSummaryCardBtn");
        if(summaryBtn) summaryBtn.style.display='inline-block';
        const myNalogBtn=document.getElementById("sendMyNalogBtn");
        if(myNalogBtn) myNalogBtn.style.display='inline-block';
        const myNalogBillBtn=document.getElementById("sendMyNalogBillBtn");
        if(myNalogBillBtn) myNalogBillBtn.style.display='inline-block';
        const myNalogCancelBtn=document.getElementById("cancelMyNalogBtn");
        if(myNalogCancelBtn) myNalogCancelBtn.style.display='none';

        updateCalculationInsights({
            total: finalSum,
            baseCost,
            marginAmount: profitBeforeTax,
            marginPercent,
            orderId,
            clientName,
            statusLabel: getOrderStatusLabel(orderStatus),
            urgencyLabel,
            startDate: sDate,
            deadline: normalizedDeadline,
            finishDate: timelineEndDate,
            deadlineMet,

            pricePerGram,
            totalBeforeRounding,
            operatorPrintHours: finalTimeOperator,
            operatorExecutionHours: prepTime,
            operatorDowntimeHours: totalDowntimeHours,
            operatorFullHours: (finalTimeOperator + prepTime + totalDowntimeHours),


            shipping: ship,
            taxAmount,
            servicesTotal,
            markupPercent,
            discountPercent,
            parallelMode,
            costStructure: costStructureItems,
            warnings
        });

        lastCalcFullData = {
            id: orderId,
            calcName,
            clientName,
            clientId,
            orderStatus,
            total: finalSum,
            totalHours: finalTimeOperator,
            taxPercent: tPercent,
            taxAmount,
            shipping: ship,
            includeEstimatePrint,
            estimatePrintCost,
            services: servicesUsed,
            servicesTotal,
            detailsByPrinter,
            costKwh: cKwh,
            operatorRate: opRate,
            totalOperatorCost: totalOperatorCost,
            operatorWorkCost: operatorWorkCost,
            downtimeCost: downtimeCost,
            downtimeMinutes: totalDowntimeMinutes,
            coolingMinutes: totalCoolingMinutes,
            printerPrepMinutes: totalPrinterPrepMinutes,
            rounding: roundingInfo,
            preparationCost: preparationCost,
            preparationTime: prepTime,
            calcData,
            globalAdditional: {
                sumGlobalAdd,
                taxAmount,
                details: globalAdditionalDetails
            },
            parallelMode,
            startDate: sDate,
            markupPercent,
            discountPercent,
            priceBeforeDiscount: totalBeforeDiscount,
            realTotal: manualFinalCost > 0 ? manualFinalCost : null,
            totalLabelsCost,
            modelsRevenue,
            urgencyProfileId: urgencyProfile ? urgencyProfile.id : '',
            urgencyProfileTitle: urgencyProfile ? urgencyProfile.title : '',
            profileMarkupPercent,
            userMarkupPercent,
            timelineScheduleSummary,
            requiredFinishDate: normalizedDeadline || "",
            actualFinishDate: timelineEndDate ? timelineEndDate.toISOString() : "",
            deadlineMet,
            autoSelectedUrgencyId: autoSelectedProfileId || null,
            nalogReceipts: []
        };
        window.lastCalcFullData = lastCalcFullData;



        if(existingIndex !== -1){
            const ex = appData.calcHistory[existingIndex];
            if(Array.isArray(ex.nalogReceipts)){
                lastCalcFullData.nalogReceipts = ex.nalogReceipts.map(r=>({uuid:r.uuid, canceled: !!r.canceled}));
            }else if(ex.nalogReceiptUuid){
                lastCalcFullData.nalogReceipts = [{uuid: ex.nalogReceiptUuid, canceled: !!ex.nalogCanceled}];
            }
            if(Array.isArray(lastCalcFullData.nalogReceipts) && lastCalcFullData.nalogReceipts.length){
                const last = lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1];
                lastCalcFullData.receiptUuid = last.uuid;
            }
            const cancelBtn=document.getElementById('cancelMyNalogBtn');
            const showCancel = Array.isArray(lastCalcFullData.nalogReceipts) && lastCalcFullData.nalogReceipts.length && !lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1].canceled;
            if(cancelBtn) cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
        }

        updateReceiptsUi();

        const dtStr = new Date().toLocaleString("ru-RU");
        const newEntry = {
            id: orderId,
            timestamp: Date.now(),
            dateStr: dtStr,
            calcName,
            clientName,
            clientId,
            orderStatus,
            total: finalSum,
            totalHours: finalTimeOperator,
            taxPercent: tPercent,
            taxAmount,
            shipping: ship,
            includeEstimatePrint,
            estimatePrintCost,
            services: servicesUsed,
            servicesTotal,
            operatorRate: opRate,
            costKwh: cKwh,
            totalOperatorCost: totalOperatorCost,
            operatorWorkCost: operatorWorkCost,
            downtimeCost: downtimeCost,
            downtimeMinutes: totalDowntimeMinutes,
            coolingMinutes: totalCoolingMinutes,
            printerPrepMinutes: totalPrinterPrepMinutes,
            rounding: roundingInfo,
            preparationCost: preparationCost,
            preparationTime: prepTime,
            details: detailsByPrinter,
            calcData,
            globalAdditional: {
                sumGlobalAdd,
                taxAmount,
                details: globalAdditionalDetails
            },
            parallelMode,
            startDate: sDate,
            markupPercent,
            discountPercent,
            priceBeforeDiscount: totalBeforeDiscount,
            realTotal: manualFinalCost > 0 ? manualFinalCost : null,
            urgencyProfileId: urgencyProfile ? urgencyProfile.id : '',
            urgencyProfileTitle: urgencyProfile ? urgencyProfile.title : '',
            profileMarkupPercent,
            userMarkupPercent,
            timelineScheduleSummary,
            requiredFinishDate: normalizedDeadline || "",
            actualFinishDate: timelineEndDate ? timelineEndDate.toISOString() : "",
            deadlineMet,
            autoSelectedUrgencyId: autoSelectedProfileId || null,
            nalogReceipts: Array.isArray(lastCalcFullData.nalogReceipts)
                ? lastCalcFullData.nalogReceipts.map(r=>({uuid:r.uuid, canceled:!!r.canceled}))
                : [],
            nalogReceiptUuid: lastCalcFullData.receiptUuid || null,
            rejectHours: totalRejectHours,
            rejectWeight: totalRejectWeight,
            totalLabelsCost,
            modelsRevenue
        };
        if (existingIndex !== -1) {
            appData.calcHistory[existingIndex] = newEntry;
        } else {
            appData.calcHistory.push(newEntry);
        }
        saveToLocalStorage();
        renderHistoryTable();
        updateHistoryStats();
    }

    function findMaterialById(mid) {
        let mat = appData.materials.find(m => String(m.id) === String(mid));
        if (mat) return mat;
        for (let p of appData.printers) {
            if (Array.isArray(p.materials)) {
                mat = p.materials.find(m => String(m.id) === String(mid));
                if (mat) return mat;
            }
        }
        return null;
    }

    function findMaterialByName(name) {
        if (!name) return null;
        let mat = appData.materials.find(m => m.name === name);
        if (mat) return mat;
        for (let p of appData.printers) {
            if(Array.isArray(p.materials)){
                mat = p.materials.find(m => m.name === name);
                if (mat) return mat;
            }
        }
        return null;
    }

    function findMaterialsByProfile(profile){
        if(!profile) return [];
        const key=String(profile).toLowerCase();
        const ids = appData.materialProfiles
            .filter(p=>{
                const cfg=p.config||{};
                const nm=String(cfg.filament_settings_id||cfg.name||'').toLowerCase();
                return nm===key;
            })
            .map(p=>String(p.id));
        if(ids.length===0) return [];
        const list=[];
        const check=(m)=>Array.isArray(m.profileIds) && m.profileIds.some(id=>ids.includes(String(id)));
        appData.materials.forEach(m=>{ if(check(m)) list.push(m); });
        appData.printers.forEach(pr=>{ (pr.materials||[]).forEach(m=>{ if(check(m)) list.push(m); }); });
        return list;
    }

    async function resolveMaterialIdByProfile(profile){
        const safeProfile = (profile || '').trim();
        if(!safeProfile) return '';

        const rememberedId = PromptMemory.getMaterial(safeProfile);
        if(rememberedId){
            const mm = (appData.materials||[]).find(m=>String(m.id)===String(rememberedId));
            if(mm) return String(mm.id);
            PromptMemory.forgetMaterial(safeProfile);
        }

        const mats = findMaterialsByProfile(safeProfile);
        if(mats.length===1) return String(mats[0].id);

        if(mats.length>1){
            const options = mats.map(m => ({
                value: String(m.id),
                label: `${m.name} (ID: ${m.id}${m.spoolmanSpoolId ? ` | SM: ${m.spoolmanSpoolId}` : ''})`
            }));

            const res=await showMultiPrompt('Материал для профиля '+safeProfile,[
                {id:'mid',label:'Материал',type:'select',options,value:options[0]?.value||''},
                {id:'remember',label:`Сохранить выбор для профиля «${safeProfile}»`,type:'checkbox',value:false,help:'Сохранение работает только для этого браузера/компьютера (LocalStorage).'}
            ]);

            if(res && res.mid){
                if(res.remember) PromptMemory.setMaterial(safeProfile, res.mid);
                return String(res.mid);
            }
        }
        return '';
    }

    function defaultOrcaConfig(){
        return {};
    }

    let currentMaterialForProfiles = null;
    function populateProfileSelect(selected){
        const sel=document.getElementById('materialProfileLinkSelect');
        sel.innerHTML='';
        appData.materialProfiles.forEach(p=>{
            const cfg=p.config||{};
            const name=String(cfg.filament_settings_id||cfg.name||p.id);
            const opt=document.createElement('option');
            opt.value=p.id;
            opt.textContent=name;
            if(selected.includes(String(p.id))) opt.selected=true;
            sel.appendChild(opt);
        });
        if(sel.options.length===0){
            const opt=document.createElement('option');
            opt.textContent='Нет профилей';
            opt.disabled=true;
            sel.appendChild(opt);
        }
    }
    function openMaterialProfileLink(mid){
        const mat=findMaterialById(mid);
        if(!mat) return;
        if(appData.materialProfiles.length===0){
            alert('Нет профилей Orca. Добавьте их в менеджере.');
            return;
        }
        currentMaterialForProfiles=String(mid);
        populateProfileSelect((mat.profileIds||[]).map(String));
        new bootstrap.Modal(document.getElementById('materialProfileLinkModal')).show();
    }
    function applyMaterialProfileLink(){
        if(currentMaterialForProfiles===null) return;
        const mat=findMaterialById(currentMaterialForProfiles);
        if(!mat) return;
        const sel=document.getElementById('materialProfileLinkSelect');
        mat.profileIds=Array.from(sel.selectedOptions).map(o=>o.value);
        saveToLocalStorage();
        bootstrap.Modal.getInstance(document.getElementById('materialProfileLinkModal')).hide();
    }
    function renderMaterialProfilesTable(){
        const tb=document.getElementById('materialProfilesTable');
        tb.innerHTML='';
        appData.materialProfiles.forEach(p=>{
            const cfg=p.config||{};
            const name=String(cfg.filament_settings_id||cfg.name||p.id);
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${name}</td><td><button class="btn btn-sm btn-info" onclick="downloadProfileJson('${p.id}')">JSON</button> <button class="btn btn-sm btn-info ms-1" onclick="downloadProfileInfo('${p.id}')">INFO</button> <button class="btn btn-sm btn-danger ms-1" onclick="deleteMaterialProfileGlobal('${p.id}')">✖</button></td>`;
            tb.appendChild(tr);
        });
    }
    function openMaterialProfilesManager(){
        renderMaterialProfilesTable();
        new bootstrap.Modal(document.getElementById('manageMaterialProfilesModal')).show();
    }
    function deleteMaterialProfileGlobal(pid){
        appData.materials.forEach(m=>{if(Array.isArray(m.profileIds)) m.profileIds=m.profileIds.filter(id=>String(id)!==String(pid));});
        appData.materialProfiles=appData.materialProfiles.filter(p=>String(p.id)!==String(pid));
        saveToLocalStorage();
        renderMaterialProfilesTable();
    }

    function renderPrinterProfilesTable(){
        const tb=document.getElementById('printerProfilesTable');
        tb.innerHTML='';
        appData.printerProfiles.forEach(p=>{
            const cfg=p.config||{};
            const pr=appData.printers.find(x=>String(x.id)===String(p.printerId));
            const prName=pr?pr.name:'?';
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${cfg.printer_settings_id||cfg.name||p.id}</td><td>${prName}</td><td><button class="btn btn-sm btn-warning me-1" onclick="reassignPrinterProfile('${p.id}')">Изменить</button><button class="btn btn-sm btn-danger" onclick="deletePrinterProfileGlobal('${p.id}')">✖</button></td>`;
            tb.appendChild(tr);
        });
    }
    function openPrinterProfilesManager(){
        renderPrinterProfilesTable();
        new bootstrap.Modal(document.getElementById('managePrinterProfilesModal')).show();
    }
    async function reassignPrinterProfile(pid){
        const pf=appData.printerProfiles.find(p=>String(p.id)===String(pid));
        if(!pf) return;
        const options=appData.printers.map(pr=>({value:String(pr.id),label:pr.name}));
        const res=await showMultiPrompt('Переназначить профиль',[{id:'prid',label:'Принтер',type:'select',options,value:pf.printerId}]);
        if(!res || !res.prid) return;
        const newPr=appData.printers.find(pr=>String(pr.id)===String(res.prid));
        if(!newPr) return;
        const oldPr=appData.printers.find(pr=>String(pr.id)===String(pf.printerId));
        if(oldPr) oldPr.profileIds=oldPr.profileIds.filter(id=>String(id)!==String(pid));
        if(!Array.isArray(newPr.profileIds)) newPr.profileIds=[];
        if(!newPr.profileIds.includes(pid)) newPr.profileIds.push(pid);
        pf.printerId=newPr.id;
        saveToLocalStorage();
        renderPrinterProfilesTable();
    }
    function deletePrinterProfileGlobal(pid){
        appData.printers.forEach(pr=>{ if(Array.isArray(pr.profileIds)) pr.profileIds=pr.profileIds.filter(id=>String(id)!==String(pid)); });
        appData.printerProfiles=appData.printerProfiles.filter(p=>String(p.id)!==String(pid));
        saveToLocalStorage();
        renderPrinterProfilesTable();
    }
    function downloadProfileJson(pid){
        const prof=appData.materialProfiles.find(p=>String(p.id)===String(pid));
        if(!prof) return;
        const cfg=prof.config||{};
        downloadBlob(new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'}),(cfg.name||cfg.filament_settings_id||'filament')+'.json');
    }
    function downloadProfileInfo(pid){
        const prof=appData.materialProfiles.find(p=>String(p.id)===String(pid));
        if(!prof) return;
        const info=prof.info||'';
        const cfg=prof.config||{};
        downloadBlob(new Blob([info],{type:'text/plain'}),(cfg.name||cfg.filament_settings_id||'filament')+'.info');
    }
    function importProfileFile(file){
        if(!file) return;
        const reader=new FileReader();
        reader.onload=()=>{
            try{ const data=JSON.parse(reader.result); appData.materialProfiles.push({id:getNextId('materialProfiles'),config:data,info:''}); saveToLocalStorage(); renderMaterialProfilesTable(); }
            catch(e){ alert('Ошибка: '+e); }
        };
        reader.readAsText(file);
    }

    function getTimelineEndDate(events){
        if (!Array.isArray(events) || !events.length) return null;
        let maxDate = null;
        events.forEach(evt => {
            if (evt && evt.end instanceof Date) {
                if (!maxDate || evt.end > maxDate) {
                    maxDate = evt.end;
                }
            } else if (Array.isArray(evt?.intervals) && evt.intervals.length) {
                const lastInterval = evt.intervals[evt.intervals.length - 1];
                if (lastInterval?.end && (!maxDate || lastInterval.end > maxDate)) {
                    maxDate = lastInterval.end;
                }
            }
        });
        return maxDate;
    }

    function calcFinishDate(events, fallbackStart){
        try{
            const maxDate = getTimelineEndDate(events);
            if (maxDate) {
                return maxDate.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            if (fallbackStart) {
                const d = new Date(fallbackStart);
                if (!Number.isNaN(d.getTime())) {
                    return d.toLocaleDateString('ru-RU');
                }
            }
        } catch (e) {
            console.warn('calcFinishDate error', e);
        }
        return '';
    }
    function formatHistoryDateOnly(str){
        if (!str) return '';
        const parts = String(str).split(',');
        return parts[0].trim();
    }

    function renderHistoryTable(){
        const tb = document.querySelector("#historyTable tbody");
        tb.innerHTML = "";
        appData.calcHistory.forEach(h => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td>${h.id || ''}<\/td>
      <td>${formatHistoryDateOnly(h.dateStr)}<\/td>
      <td>${h.calcName || "(Без названия)"}<\/td>
      <td class="history-client">${h.clientName || "(Не указан)"}<\/td>
      <td>
        <select class="form-select form-select-sm" onchange="onChangeCalcHistoryStatus(${h.timestamp}, this.value)">
          <option value="new" ${h.orderStatus==="new"?"selected":""}>Новый<\/option>
          <option value="inprogress" ${h.orderStatus==="inprogress"?"selected":""}>В работе<\/option>
          <option value="done" ${h.orderStatus==="done"?"selected":""}>Завершён<\/option>
          <option value="paid" ${h.orderStatus==="paid"?"selected":""}>Оплачен<\/option>
          <option value="canceled" ${h.orderStatus==="canceled"?"selected":""}>Отменён<\/option>
        <\/select>
      <\/td>
      <td>${safeFixed(h.total)}<\/td>
      <td>
        ${Array.isArray(h.nalogReceipts) && h.nalogReceipts.length ?
                h.nalogReceipts.map((r,i)=>`<a href=\"https://lknpd.nalog.ru/api/v1/receipt/${localStorage.getItem('my_nalog_inn') || ''}/${r.uuid}/print\" target=\"_blank\" ${(r.canceled || i < h.nalogReceipts.length-1) ? 'class="text-danger"' : ''}>Чек ${h.nalogReceipts.length>1 ? ' '+(i+1) : ''}<\/a>`).join('<br/>') :
                (h.nalogReceiptUuid ? `<a href=\"https://lknpd.nalog.ru/api/v1/receipt/${localStorage.getItem('my_nalog_inn') || ''}/${h.nalogReceiptUuid}/print\" target=\"_blank\">Чек #${h.nalogReceiptUuid}<\/a>` : '')}
      <\/td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="onEditCalcHistory(${h.timestamp})">Редакт.<\/button>
        <button class="btn btn-sm btn-danger" onclick="onDeleteCalcHistoryEntry(${h.timestamp})">Удалить<\/button>
      <\/td>
    `;
            tb.appendChild(tr);
        });
    }

    function parseHistoryDate(str){
        const [d,t] = str.split(',');
        const [day,mon,year] = d.trim().split('.');
        return new Date(`${year}-${mon}-${day}T${(t||'00:00:00').trim()}`);
    }

    function updateHistoryStats(){
        const fromVal = document.getElementById('histFrom').value;
        const toVal = document.getElementById('histTo').value;
        const from = fromVal ? new Date(fromVal) : new Date('1970-01-01');
        const to = toVal ? new Date(toVal) : new Date();
        to.setDate(to.getDate()+1);
        const list = appData.calcHistory.filter(h=>{
            const d = parseHistoryDate(h.dateStr);
            return d>=from && d<to;
        });
        const sum = list.reduce((s,h)=>s+h.total,0);
        const hrs = list.reduce((s,h)=>s+h.totalHours,0);
        const div = document.getElementById('historyStats');
        div.textContent = `Всего заказов: ${list.length}, сумма: ${safeFixed(sum)} ₽, часы печати: ${safeFixed(hrs)}`;
    }
    function onDeleteCalcHistoryEntry(timestamp) {
        if(!confirm("Удалить выбранный расчет из истории?")) return;
        appData.calcHistory = appData.calcHistory.filter(entry => entry.timestamp !== timestamp);
        saveToLocalStorage();
        renderHistoryTable();
        updateHistoryStats();
    }

    function onChangeCalcHistoryStatus(timestamp, newStatus){
        const it = appData.calcHistory.find(x => x.timestamp === timestamp);
        if(!it) return;
        it.orderStatus = newStatus;
        saveToLocalStorage();
    }

    /* Функции импорта/экспорта JSON */
    function onExportJson(){
        const s = JSON.stringify(appData, null, 2);
        document.getElementById("exportArea").value = s;
    }

    function downloadJsonFile(){
        const blob = new Blob([JSON.stringify(appData,null,2)],{type:'application/json'});
        downloadBlob(blob,'calc_data.json');
    }

    function importFromFile(){
        const inp=document.getElementById('importJsonFile');
        if(!inp.files.length) return;
        const file=inp.files[0];
        const reader=new FileReader();
        reader.onload=()=>{
            document.getElementById('importArea').value=reader.result;
            onImportJson();
        };
        reader.readAsText(file);
    }
    function onImportJson(){
        const s = document.getElementById("importArea").value.trim();
        if(!s){
            if(confirm("Пустая строка. Очистить все данные?")){
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
            return;
        }
        try{
            const obj = JSON.parse(s);
            setAppData(migrateOldData(obj));

            normalizeIds(appData);

            const validationResult = validateUniqueIds(appData);
            let alertMessage = "Импорт выполнен.";

            if (!validationResult.success) {
                alertMessage += "\n\nОбнаружены проблемы с ID, но они были автоматически исправлены.";
            } else {
                alertMessage += " Все ID корректны.";
            }

            saveToLocalStorage();
            initAll();
            alert(alertMessage);
        } catch(e){
            alert("Ошибка: " + e);
        }
    }
    function sanitizeProfileSchedule(profileLabel, rawSchedule) {
        const schedule = {};
        const workingDays = [];
        const errors = [];
        WEEKDAY_LABELS.forEach(day => {
            const entries = Array.isArray(rawSchedule && rawSchedule[day.value]) ? rawSchedule[day.value] : [];
            const normalized = entries
                .map((period, idx) => {
                    if (!period || (!period.start && !period.end)) return null;
                    if (!period.start || !period.end) {
                        errors.push(`${profileLabel}: ${day.label} строка ${idx + 1} заполнена некорректно`);
                        return null;
                    }
                    const startMin = timeStringToMinutes(period.start);
                    const endMin = timeStringToMinutes(period.end);
                    if (Number.isNaN(startMin) || Number.isNaN(endMin) || startMin >= endMin) {
                        errors.push(`${profileLabel}: ${day.label} строка ${idx + 1} заполнена некорректно`);
                        return null;
                    }
                    return {startMinutes: startMin, endMinutes: endMin};
                })
                .filter(Boolean)
                .sort((a, b) => a.startMinutes - b.startMinutes);
            const sanitizedDay = [];
            normalized.forEach((segment, idx) => {
                if (idx > 0 && segment.startMinutes < normalized[idx - 1].endMinutes) {
                    errors.push(`${profileLabel}: ${day.label} имеет пересечение интервалов #${idx} и #${idx + 1}`);
                }
                sanitizedDay.push({
                    start: minutesToTimeString(segment.startMinutes),
                    end: minutesToTimeString(segment.endMinutes)
                });
            });
            if (sanitizedDay.length) {
                workingDays.push(day.value);
            }
            schedule[day.value] = sanitizedDay;
        });
        return {schedule, workingDays, errors};
    }

    function saveBrandingSettings(){
        captureScheduleFromInputs(currentUrgencyProfileId);
        const cn = document.getElementById("companyNameInput").value.trim();
        const cl = document.getElementById("chatLinkInput").value.trim();
        const pay = document.getElementById("bankDetailsInput").value.trim();
        const sanitizedProfiles = [];
        const errors = [];
        urgencyProfilesDraft.forEach(profile => {
            const cleanName = (profile.title || '').trim() || 'Без названия';
            const markup = parseFloat(profile.markupPercent) || 0;
            const description = (profile.description || '').trim();
            const {schedule, workingDays, errors: profileErrors} = sanitizeProfileSchedule(cleanName, profile.schedule || {});
            if (profileErrors.length) {
                errors.push(...profileErrors);
            }
            sanitizedProfiles.push({
                id: profile.id || `urg_${Date.now()}`,
                title: cleanName,
                markupPercent: markup,
                description,
                schedule,
                workingDays
            });
        });
        if (errors.length) {
            alert(`Исправьте график:\n${errors.join('\n')}`);
            return;
        }
        appData.labelSettings.companyName = cn || "Моя компания";
        appData.labelSettings.chatLink = cl || "https://t.me/example";
        appData.labelSettings.bankDetails = pay;
        appData.labelSettings.urgencyProfiles = sanitizedProfiles;
        if (!appData.labelSettings.urgencyProfiles.some(p => String(p.id) === String(appData.calcSettings.currentUrgencyId))) {
            appData.calcSettings.currentUrgencyId = appData.labelSettings.urgencyProfiles[0] ? appData.labelSettings.urgencyProfiles[0].id : '';
        }
        saveToLocalStorage();
        initUrgencyProfilesDraft();
        renderUrgencyProfileOptions();
        renderCalcUrgencySelect();
        alert("Сохранено");
    }

    function saveCalcSettings(){
        appData.labelSettings.printLabels = document.getElementById("printLabelsCheckbox").checked;
        appData.labelSettings.costPerLabel = parseFloat(document.getElementById("labelCostInput").value) || 0;
        appData.calcSettings.operatorRate = parseFloat(document.getElementById("calcOperatorRate").value) || 0;
        appData.calcSettings.includeOperatorForRejects = document.getElementById("calcOperatorReject").checked;
        appData.calcSettings.downtimeCost = parseFloat(document.getElementById("calcDowntimeCost").value) || 0;
        appData.calcSettings.preparationRate = parseFloat(document.getElementById("calcPreparationRate").value) || 0;
        appData.calcSettings.costKwh = parseFloat(document.getElementById("calcCostKwh").value) || 0;
        appData.calcSettings.taxPercent = parseFloat(document.getElementById("calcTaxPercent").value) || 0;
        appData.calcSettings.includeEstimatePrint = document.getElementById("printEstimateCheckbox").checked;
        appData.calcSettings.estimatePrintCost = parseFloat(document.getElementById("estimatePrintCostInput").value) || 0;
        appData.calcSettings.roundingMode = document.getElementById("calcRoundingMode").value || "none";
        appData.calcSettings.includeAmortization = document.getElementById("settingsIncludeAmortization").checked;
        appData.calcSettings.includeRejects = document.getElementById("settingsIncludeRejects").checked;
        appData.calcSettings.includeOverheads = document.getElementById("settingsIncludeOverheads").checked;
        appData.calcSettings.ignoreCoolingRejects = document.getElementById("settingsIgnoreCoolingRejects").checked;
        saveToLocalStorage();
        alert("Сохранено");
    }

    function onModelThumbnailChange(e, code){
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 140;
                canvas.height = 110;
                const ctx = canvas.getContext('2d');

                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                const targetRatio = canvas.width / canvas.height;
                const imgRatio = img.width / img.height;
                let sx, sy, sw, sh;
                if(imgRatio > targetRatio){
                    sh = img.height;
                    sw = sh * targetRatio;
                    sx = (img.width - sw) / 2;
                    sy = 0;
                } else {
                    sw = img.width;
                    sh = sw / targetRatio;
                    sx = 0;
                    sy = (img.height - sh) / 2;
                }

                ctx.drawImage(img, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/png');
                const base64 = dataUrl.split(',')[1];
                const tr = e.target.closest('tr');
                if(tr) tr.dataset.thumbnail = base64;
                let imgEl = document.getElementById('thumb_'+code);
                if(imgEl){
                    if(imgEl.tagName.toLowerCase() === 'img'){
                        imgEl.src = dataUrl;
                    } else {
                        imgEl.outerHTML = `<img id="thumb_${code}" src="${dataUrl}" style="height:40px;width:40px;object-fit:contain;border:1px solid #ccc;cursor:pointer" onclick=\"document.getElementById('thumbFile_${code}').click()\">`;
                    }
                }
                saveToLocalStorage();
            };
            img.src = reader.result;
        };
        reader.readAsDataURL(file);
    }

    /* Функция генерации QR-кода */
    function generateQRCodeCanvas(data, size, callback){
        const tempDiv = document.createElement("div");
        new QRCode(tempDiv, {
            text: data,
            width: size,
            height: size,
            correctLevel: QRCode.CorrectLevel.H
        });
        setTimeout(() => {
            const qrCanvas = tempDiv.querySelector("canvas");
            callback(qrCanvas);
        }, 100);
    }

    function getExportBridge() {
        if (window && window.exportBridge && typeof window.exportBridge.saveHtml === 'function') {
            return window.exportBridge;
        }
        return null;
    }

    function buildExportOrderMeta() {
        const calcNameEl = document.getElementById("calcName");
        const clientInput = document.getElementById("calcClientName");
        const orderId = getCalcOrderId() || (lastCalcFullData && lastCalcFullData.id) || '';
        const orderName = (calcNameEl ? calcNameEl.value : '') || (lastCalcFullData && lastCalcFullData.calcName) || '';
        const clientId = currentCalcClientId || (lastCalcFullData && lastCalcFullData.clientId) || '';
        const clientName = (clientInput ? clientInput.value : '') || (lastCalcFullData && lastCalcFullData.clientName) || '';
        return { orderId, orderName, clientId, clientName };
    }

    async function saveHtmlExportOrDownload(htmlContent, downloadName, payload) {
        const bridge = getExportBridge();
        if (bridge) {
            try {
                const res = await bridge.saveHtml(Object.assign({ html: htmlContent }, payload || {}));
                if (res && res.ok) return;
            } catch (e) {
                console.warn('export.saveHtml failed', e);
            }
        }
        const blob = new Blob([htmlContent], { type: "text/html" });
        downloadBlob(blob, downloadName);
    }

    function downloadThermoLabelHtml(modelName, printerName, materialName, hours, weight, thumbnail) {
        const qrSize = 100;
        generateQRCodeCanvas(appData.labelSettings.chatLink, qrSize, async function(qrCanvas) {
            const fallbackThumb = thumbnail || getBrandLogoBase64();
            const qrDataUrl = qrCanvas ? qrCanvas.toDataURL("image/png") : "";
            const htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=58mm, initial-scale=1">
  <title>Этикетка<\/title>
  <style>
    body { width: 58mm; height: 40mm; margin: 0; padding: 0; font-family: sans-serif; }
    #labelContainer {
      width: 58mm;
      height: 40mm;
      padding: 2mm;
      box-sizing: border-box;
      position: relative;
    }
    .label-header {
      text-align: center;
      font-size: 12pt;
      font-weight: bold;
      margin-bottom: 2mm;
    }
    .label-content {
      font-size: 10pt;
      line-height: 1.2;
    }
    .label-content div { margin-bottom: 1mm; }
    .qr-code {
      position: absolute;
      bottom: 2mm;
      right: 2mm;
      width: 15mm;
      height: 15mm;
    }
    .thumb {
      position: absolute;
      bottom: 2mm;
      right: 20mm;
      width: 15mm;
      height: 15mm;
    }
  <\/style>
<\/head>
<body>
<div id="labelContainer">
  <div class="label-header">${appData.labelSettings.companyName}<\/div>
  <div class="label-content">
    <div style="text-align: center;">${modelName}<\/div>
    <div>${printerName}<\/div>
    <div>${materialName}<\/div>
    <div>${formatTimeForDisplay(hours)}<\/div>
    <div>${weight} г<\/div>
    <div>${new Date().toLocaleDateString("ru-RU")}<\/div>
  <\/div>
  ${fallbackThumb ? `<img class="thumb" src="data:image/png;base64,${fallbackThumb}">` : ''}
  <img class="qr-code" src="${qrDataUrl}" alt="QR-код">
  <\/div>
  <\/body>
<\/html>
    `.trim();
            const meta = buildExportOrderMeta();
            await saveHtmlExportOrDownload(
                htmlContent,
                `ThermoLabel_${modelName}_${Date.now()}.html`,
                Object.assign({ kind: 'model-label', modelName }, meta)
            );
        });
    }

    /* Новая функция для генерации этикетки материала в формате 30x20 мм */
    async function downloadMaterialLabelHtml(materialId) {
        // Ищем материал сначала в глобальных, затем в материалах принтеров
        let mat = appData.materials.find(m => String(m.id) === String(materialId));
        if(!mat) {
            // Если не найден в глобальных, проверяем у каждого принтера
            for(let p of appData.printers) {
                if (Array.isArray(p.materials)) {
                    mat = p.materials.find(m => String(m.id) === String(materialId));
                    if(mat) break;
                }
            }
        }
        if(!mat) { alert("Материал не найден."); return; }

        // Формируем HTML для этикетки (30x20 мм)
        const htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=30mm, initial-scale=1">
  <title>Этикетка<\/title>
  <style>
    body { width: 30mm; height: 20mm; margin: 0; padding: 0; font-family: sans-serif; font-size: 8pt; }
    #labelContainer {
      width: 30mm;
      height: 20mm;
      padding: 1mm;
      box-sizing: border-box;
      position: relative;
      border: 1px solid #000;
    }
    .label-header { text-align: center; font-weight: bold; margin-bottom: 1mm; }
    .label-content div { margin-bottom: 0.5mm; }
  <\/style>
<\/head>
<body>
  <div id="labelContainer">
    <div class="label-header">${mat.name}<\/div>
    <div class="label-content">
      <div>${mat.declaredWeight || "-"} кг<\/div>
      <div>${mat.manufacturer || "-"}<\/div>
      <div>${mat.productionDate || "-"}<\/div>
    <\/div>
  <\/div>
<\/body>
<\/html>
  `.trim();
        await saveHtmlExportOrDownload(
            htmlContent,
            `MaterialLabel_${mat.name}_${Date.now()}.html`,
            { kind: 'material-label', materialId: mat.id, materialName: mat.name }
        );
    }

    function buildSummaryCardHtml(data){
        return `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Смета</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:var(--bs-body-bg,#ffffff);color:var(--bs-body-color,#212529);font-family:'Segoe UI',Tahoma,sans-serif;padding:2rem;background-image:radial-gradient(circle at 20% 20%,var(--bs-primary-bg-subtle,#cfe2ff),transparent 60%),radial-gradient(circle at 80% 0,var(--bs-success-bg-subtle,#d1e7dd),transparent 60%);}
    .order-summary-card{max-width:1200px;margin:0 auto;background:var(--bs-light-bg-subtle,#f8f9fa);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.1);overflow:hidden;display:flex;flex-wrap:wrap;}
    .order-info{flex:1 1 300px;padding:1.5rem;background:var(--bs-secondary-bg,#e9ecef);}
    .brand-title-row{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem;}
    .brand-title-row h2{font-size:1.4rem;margin:0;color:var(--bs-primary,#0d6efd);}
    .brand-title-row img{width:48px;height:48px;object-fit:contain;}
    .order-info .info-item{margin-bottom:.5rem;font-size:.95rem;}
    .order-info .label{font-weight:600;color:var(--bs-secondary-color,#6c757d);}
    .order-info .value{margin-left:.5rem;font-weight:500;}
    .order-info .qr{text-align:center;margin-bottom:1rem;}
    .order-info .qr img{width:120px;height:120px;}
    .models{flex:2 1 600px;padding:1.5rem;}
    .models-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem;}
    .model-card{background:var(--bs-light-bg-subtle,#f8f9fa);border-radius:8px;padding:1rem;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.05);transition:transform .3s ease,box-shadow .3s ease;}
    .model-card:hover{transform:translateY(-4px);box-shadow:0 4px 16px rgba(0,0,0,0.1);}
    .model-card img{width:48px;height:48px;margin-bottom:.5rem;}
    .model-card h3{font-size:1rem;margin-bottom:.5rem;color:var(--bs-primary,#0d6efd);}
    .model-card p{font-size:.9rem;margin:.25rem 0;color:var(--bs-secondary-color,#6c757d);}
    .model-card p strong{color:var(--bs-body-color,#212529);}
    @media (max-width:800px){.order-summary-card{flex-direction:column;}.order-info,.models{flex:1 1 auto;}}
  </style>
</head>
<body>
<div class="order-summary-card">
  <div class="order-info">
    <div class="brand-title-row">
      ${data.logo ? `<img src="${data.logo}" alt="Логотип">` : ''}
      <h2>${data.company}</h2>
    </div>
    <div class="qr"><img src="${data.qr}" alt="QR"></div>
    <div class="info-item"><span class="label">Код заказа:<\/span><span class="value">${data.orderId}<\/span></div>
    <div class="info-item"><span class="label">Название заказа:<\/span><span class="value">${data.orderName}<\/span></div>
    <div class="info-item"><span class="label">Клиент:<\/span><span class="value">${data.client}<\/span></div>
    <div class="info-item"><span class="label">Статус:<\/span><span class="value">${data.status}<\/span></div>
    ${data.urgencyTitle ? `<div class="info-item"><span class="label">Срочность:<\/span><span class="value">${data.urgencyTitle}${data.urgencyProfileMarkup ? ` (+${data.urgencyProfileMarkup}% )` : ''}${data.urgencyUserMarkup ? `, ручная ${data.urgencyUserMarkup}%` : ''}<\/span></div>` : ''}
    <div class="info-item"><span class="label">Общее время печати:<\/span><span class="value">${data.totalTime}<\/span></div>
	<div class="info-item"><span class="label">Общее время работы оператора:<\/span><span class="value">${data.totalTimeOperator}<\/span></div>
    <div class="info-item"><span class="label">Суммарный вес:</span><span class="value">${data.totalWeight} г</span></div>
    ${data.services && data.services.length ? data.services.map(s => `<div class="info-item"><span class="label">${s.name}:<\/span><span class="value">${s.total} ₽<\/span></div>`).join('') + `<div class="info-item"><span class="label">Итого услуги:<\/span><span class="value">${data.servicesTotal} ₽<\/span></div>` : ''}
    <div class="info-item"><span class="label">Итого:<\/span><span class="value">${data.priceOld ? `<del>${data.priceOld} ₽<\/del> ${data.totalCost} ₽ (-${data.discountPercent}% )` : `${data.totalCost} ₽`}<\/span></div>
    <div class="info-item"><span class="label">Цена за 1 грамм:<\/span><span class="value">${data.pricePerGram} ₽<\/span></div>
    ${data.paymentInfo ? `<div class="info-item"><span class="label">Оплата:<\/span><span class="value">${data.paymentInfo}<\/span></div>` : ''}
    ${data.finDate ? `<div class="info-item"><span class="label">Дата завершения:<\/span><span class="value">${data.finDate}<\/span></div>` : ''}
  <\/div>
  <div class="models">
    <div class="models-grid">${data.modelsHtml}<\/div>
  <\/div>
<\/div>
</body>
</html>`;
    }

    async function downloadSummaryCardHtml(){
        if(!lastSummaryCardHtml){alert('Нет данных.');return;}
        const meta = buildExportOrderMeta();
        await saveHtmlExportOrDownload(
            lastSummaryCardHtml,
            `Estimate_${Date.now()}.html`,
            Object.assign({ kind: 'estimate' }, meta)
        );
    }

    function generateDeviceId(len=16){
        const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let out='';
        for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
        return out;
    }

    function buildPaymentQrString(){
        return appData.labelSettings.chatLink || '';
    }

    async function refreshMyNalogToken(){
        const refresh = localStorage.getItem('my_nalog_refresh');
        const deviceId = localStorage.getItem('my_nalog_device_id');
        if(!refresh || !deviceId) return false;
        const body={
            refreshToken: refresh,
            deviceInfo:{
                sourceDeviceId: deviceId,
                sourceType:'WEB',
                appVersion:'1.0.0',
                metaDetails:{userAgent:navigator.userAgent}
            }
        };
        try{
            const resp = await fetch(MY_NALOG_API+'/api/v1/auth/token',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
            if(resp.ok){
                const data = await resp.json();
                if(data.token){
                    localStorage.setItem('my_nalog_token', data.token);
                    if(data.refreshToken) localStorage.setItem('my_nalog_refresh', data.refreshToken);
                    return true;
                }
            }
        }catch(e){
            console.error('token refresh failed');
        }
        return false;
    }

    async function sendMyNalogRequest(method,url,body){
        let token = localStorage.getItem('my_nalog_token');
        if(!token) throw new Error('no token');
        const opt={method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}};
        if(body) opt.body=JSON.stringify(body);
        let resp = await fetch(url,opt);
        if(resp.status===401){
            const ok = await refreshMyNalogToken();
            if(ok){
                token = localStorage.getItem('my_nalog_token');
                opt.headers['Authorization']='Bearer '+token;
                resp = await fetch(url,opt);
            }
        }
        return resp;
    }

    async function cancelReceiptInternal(receipt, comment){
        if(!receipt || !receipt.uuid) return false;
        const payload = {
            receiptUuid: receipt.uuid,
            comment: comment || '',
            partnerCode: null,
            requestTime: new Date().toISOString()
        };
        try{
            const resp = await sendMyNalogRequest('POST',MY_NALOG_API+'/api/v1/cancel',payload);
            if(resp.ok){
                receipt.canceled = true;
                const idx = appData.calcHistory.findIndex(e=>String(e.id)===String(lastCalcFullData.id));
                if(idx!==-1 && Array.isArray(appData.calcHistory[idx].nalogReceipts)){
                    const arr = appData.calcHistory[idx].nalogReceipts;
                    const j = arr.findIndex(r=>r.uuid===receipt.uuid);
                    if(j!==-1) arr[j].canceled = true;
                    saveToLocalStorage();
                    renderHistoryTable();
                    updateReceiptsUi();
                }
                return true;
            }
        }catch(e){
        }
        return false;
    }

    function buildReceiptPrintUrl(uuid){
        const inn = localStorage.getItem('my_nalog_inn') || '';
        if(!inn || !uuid) return '';
        return `https://lknpd.nalog.ru/api/v1/receipt/${inn}/${uuid}/print`;
    }

    function updateReceiptsUi(){
        const btn = document.getElementById('openReceiptsBtn');
        const container = document.getElementById('receiptsLinksContainer');

        const receipts = (window.lastCalcFullData && Array.isArray(window.lastCalcFullData.nalogReceipts))
            ? window.lastCalcFullData.nalogReceipts
            : [];

        if(btn){
            btn.style.display = 'inline-block';
            if(!btn.__bound){
                btn.__bound = true;
                btn.addEventListener('click', () => showReceiptsModal());
            }
        }

        if(!container) return;

        if(!receipts.length){
            container.innerHTML = '<div class="text-muted">Нет сформированных чеков.</div>';
            return;
        }

        container.innerHTML = receipts.map((r,i)=>{
            const url = buildReceiptPrintUrl(r.uuid);
            const label = receipts.length > 1 ? `Чек ${i+1}` : 'Чек';
            if(!url) return `<div class="text-muted">${label}: недоступно (нет ИНН)</div>`;
            const cls = (r.canceled || i < receipts.length-1) ? 'text-danger' : '';
            const suffix = r.canceled ? ' (отменён)' : '';
            return `<div class="mb-1"><a href="${url}" target="_blank" class="${cls}">${label}</a>${suffix}</div>`;
        }).join('');
    }

    function showReceiptsModal(){
        updateReceiptsUi();
        const modalEl = document.getElementById('receiptsModal');
        if(!modalEl) return;
        bootstrap.Modal.getOrCreateInstance(modalEl).show();
    }


    function showCheckLinkModal(checkUrl) {
        document.getElementById('checkLinkInput').value = checkUrl;
        const modal = new bootstrap.Modal(document.getElementById('checkLinkModal'));
        modal.show();
    }

    async function sendMyNalogReceipt(){
        if(!lastCalcFullData){ alert('Нет данных расчёта.'); return; }
        if(!Array.isArray(lastCalcFullData.nalogReceipts)) lastCalcFullData.nalogReceipts = [];
        if(lastCalcFullData.nalogReceipts.length){
            const last = lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1];
            const inn = localStorage.getItem('my_nalog_inn') || '';
            const url = inn ? `https://lknpd.nalog.ru/api/v1/receipt/${inn}/${last.uuid}/print` : '';
            const force = confirm('Чек уже сформирован' + (url ? '\n'+url : '') + '\nПерегенерировать?');
            if(!force) return;
            await cancelReceiptInternal(last, 'ошибочное формирование');
        }
        const btn = document.getElementById('sendMyNalogBtn');
        if(btn) btn.disabled = true;
        const payload = {
            operationTime: new Date().toISOString(),
            requestTime: new Date().toISOString(),
            services: [{ name: `Печать на 3д-принтере "${lastCalcFullData.calcName || ''}" #${lastCalcFullData.id || ''}`, amount: lastCalcFullData.total, quantity: 1 }],
            totalAmount: lastCalcFullData.total,
            paymentType: 'CASH',
            ignoreMaxTotalIncomeRestriction: false,
            client: { contactPhone: null, displayName: null, incomeType: 'FROM_INDIVIDUAL', inn: null }
        };
        try {
            const resp = await sendMyNalogRequest('POST',MY_NALOG_API+'/api/v1/income',payload);
            if(resp.ok){
                const data = await resp.json().catch(()=>null);
                if(data?.approvedReceiptUuid){
                    console.log(data);
                    const inn = localStorage.getItem('my_nalog_inn') || '';
                    lastCalcFullData.receiptUuid = data.approvedReceiptUuid;
                    lastCalcFullData.orderStatus = 'paid';
                    document.getElementById('calcOrderStatus').value = 'paid';
                    toggleFinalFields('paid');
                    const idx = appData.calcHistory.findIndex(e=>String(e.id)===String(lastCalcFullData.id));
                    if(idx!==-1){
                        const recList = Array.isArray(appData.calcHistory[idx].nalogReceipts)
                            ? appData.calcHistory[idx].nalogReceipts.map(r=>({uuid:r.uuid, canceled:!!r.canceled}))
                            : [];
                        recList.push({uuid:data.approvedReceiptUuid, canceled:false});
                        appData.calcHistory[idx].nalogReceipts = recList;
                        appData.calcHistory[idx].nalogReceiptUuid = data.approvedReceiptUuid;
                        appData.calcHistory[idx].orderStatus = 'paid';
                    }
                    if(!Array.isArray(lastCalcFullData.nalogReceipts)) lastCalcFullData.nalogReceipts = [];
                    lastCalcFullData.nalogReceipts.push({uuid:data.approvedReceiptUuid,canceled:false});


                    saveToLocalStorage();
                    if(idx!==-1){
                        renderHistoryTable();
                    }
                    const cancelBtn=document.getElementById('cancelMyNalogBtn');
                    if(cancelBtn) cancelBtn.style.display='inline-block';
                    if(btn) btn.disabled = false;

                    updateReceiptsUi();

                    alert('Чек отправлен.');
                    const receiptUrl = inn ? `https://lknpd.nalog.ru/api/v1/receipt/${inn}/${data.approvedReceiptUuid}/print` : '';
                    showCheckLinkModal(receiptUrl);

                }else{
                    alert('Запрос отправлен в Мой Налог');
                }
            }else{
                const text = await resp.text().catch(()=>resp.status);
                alert('Ошибка отправки: '+text);
            }
        }catch(e){
            alert('Не удалось подключиться к сервису Мой Налог');
        }finally{
            if(btn) btn.disabled = false;
        }
    }

    async function cancelMyNalogReceipt(){
        if(!lastCalcFullData || !Array.isArray(lastCalcFullData.nalogReceipts) || !lastCalcFullData.nalogReceipts.length){
            alert('Нет чека для отмены.');
            return;
        }
        const last = lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1];
        const comment = prompt('Причина отмены чекa:','');
        if (!comment || !comment.trim()) {
            alert('Не указана причина отмены чека.\nЧек не будет отменён.');
            return;
        }
        const btn=document.getElementById('cancelMyNalogBtn');
        if(btn) btn.disabled=true;
        const ok = await cancelReceiptInternal(last, comment || '');
        if(ok){
            lastCalcFullData.orderStatus='canceled';
            const idx=appData.calcHistory.findIndex(e=>String(e.id)===String(lastCalcFullData.id));
            if(idx!==-1){
                appData.calcHistory[idx].orderStatus='canceled';
                saveToLocalStorage();
                renderHistoryTable();
            }
            const cancelBtn=document.getElementById('cancelMyNalogBtn');
            const showCancel = lastCalcFullData.nalogReceipts.length && !lastCalcFullData.nalogReceipts[lastCalcFullData.nalogReceipts.length-1].canceled;
            if(cancelBtn) cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
            alert('Чек отменён.');
        }else{
            alert('Ошибка отмены чека');
        }
        if(btn) btn.disabled=false;
    }

    function saveMyNalogSettings(){
        const token = document.getElementById('myNalogToken').value.trim();
        localStorage.setItem('my_nalog_token', token);
        const phoneEl = document.getElementById('myNalogPhone');
        if(phoneEl) localStorage.setItem('my_nalog_phone', phoneEl.value.trim());
        alert('Сохранено');
    }

    async function checkMyNalogStatus() {
        const token = localStorage.getItem('my_nalog_token');
        const statusEl = document.getElementById('myNalogStatus');
        if (!token) {
            statusEl.textContent = 'Токен не задан';
            return;
        }
        statusEl.textContent = 'Проверка...';
        try {
            const resp = await sendMyNalogRequest('GET', MY_NALOG_API + '/api/v1/user');
            if (resp.ok) {
                const data = await resp.json();
                if (data.health === "false") {

                    statusEl.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.message}`;
                } else if(data.displayName) {
                    statusEl.innerHTML = `<i class="bi bi-check-square me-2"></i>ИНН ${data.inn} ${data.displayName}`;
                    localStorage.setItem('my_nalog_inn', data.inn || '');
                } else {
                    statusEl.textContent = 'Сервис доступен';
                }
            } else {
                statusEl.textContent = 'Ошибка: Невозможно проверить статус';
            }
        } catch (e) {
            statusEl.textContent = 'Ошибка: Нет соединения с сервером';
        }
    }

    async function requestMyNalogSms(){
        const phoneNum = document.getElementById('myNalogPhone').value.trim();
        const statusEl = document.getElementById('myNalogStatus');
        if(!phoneNum){
            alert('Введите телефон');
            return;
        }
        statusEl.textContent = 'Отправка SMS...';
        try{
            const resp = await fetch(MY_NALOG_API+'/api/v1/auth/challenge/sms/start', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({phone: phoneNum, requireTpToBeActive: true})
            });
            if(resp.ok){
                const data = await resp.json();
                myNalogChallengeToken = data.challengeToken;
                statusEl.textContent = 'SMS отправлено';
            }else{
                const text = await resp.text().catch(()=>resp.status);
                statusEl.textContent = 'Ошибка: ' + text;
            }
        }catch(e){
            statusEl.textContent = 'Нет соединения';
        }
    }

    async function confirmMyNalogSms(){
        const phoneNum = document.getElementById('myNalogPhone').value.trim();
        const code = document.getElementById('myNalogSms').value.trim();
        const statusEl = document.getElementById('myNalogStatus');
        if(!phoneNum || !code){
            alert('Нужен телефон и код');
            return;
        }
        statusEl.textContent = 'Подтверждение...';
        try{
            const challenge = myNalogChallengeToken || '';
            const deviceId = localStorage.getItem('my_nalog_device_id') || generateDeviceId();
            localStorage.setItem('my_nalog_device_id', deviceId);
            const body = {
                phone: phoneNum,
                code,
                challengeToken: challenge,
                deviceInfo:{
                    sourceDeviceId: deviceId,
                    sourceType:'WEB',
                    appVersion:'1.0.0',
                    metaDetails:{userAgent:navigator.userAgent}
                }
            };
            const resp = await fetch(MY_NALOG_API+'/api/v1/auth/challenge/sms/verify', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(body)
            });
            if(resp.ok){
                const data = await resp.json().catch(()=>null);
                if(data?.token){
                    localStorage.setItem('my_nalog_token', data.token);
                    localStorage.setItem('my_nalog_refresh', data.refreshToken || '');
                    document.getElementById('myNalogToken').value = data.token;
                    if(data.inn){
                        localStorage.setItem('my_nalog_inn', data.inn);
                    } else {
                        await checkMyNalogStatus();
                    }
                    statusEl.textContent = 'Токен получен';
                }else{
                    statusEl.textContent = 'Код подтвержден';
                }
            }else{
                const text = await resp.text().catch(()=>resp.status);
                statusEl.textContent = 'Ошибка: ' + text;
            }
        }catch(e){
            statusEl.textContent = 'Нет соединения';
        }
    }

    function loadMyNalogSettings(){
        const token = localStorage.getItem('my_nalog_token') || '';
        const inp = document.getElementById('myNalogToken');
        if(inp) inp.value = token;
        const savedPhone = localStorage.getItem('my_nalog_phone') || '';
        const phoneInp = document.getElementById('myNalogPhone');
        if(phoneInp) phoneInp.value = savedPhone;
        if(token) checkMyNalogStatus();
    }
    function downloadBlob(blob, filename){
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
    function startNewCalculation(){
        document.getElementById("calcName").value="";
        resetCalcClientSelector();
        document.getElementById("calcOrderStatus").value="new";
        setCalcOrderId("");
        resetCalculationInsights();
        document.getElementById("calcDiscountPercent").value = 0;
        document.getElementById("calcFinalCost").value = "";
        toggleFinalFields('new');
        document.getElementById("calcStartDate").value = getTodayIsoDate();
        const deadlineInput = document.getElementById("calcDeadlineDate");
        if (deadlineInput) {
            deadlineInput.value = "";
        }
        appData.calcSettings.deadlineDate = "";
        document.getElementById("calcPreparationTime").value = appData.calcSettings.preparationTime ? formatTimeForDisplay(appData.calcSettings.preparationTime) : "";
        lastCalcFullData = null;
        appData.printers.forEach(pr=>{
            const table=document.getElementById(`calcModelsTable_${pr.id}`);
            if(table) table.querySelector("tbody").innerHTML="";
            updatePrinterModelsEmptyState(pr.id);
        });
        ['downloadSummaryCardBtn','sendMyNalogBtn','cancelMyNalogBtn'].forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.style.display = 'none';
        });
        const calcResultEl = document.getElementById("calcResult");
        if (calcResultEl) {
            calcResultEl.style.display = 'none';
            calcResultEl.innerHTML = '';
        }
        const calcResultEmptyEl = document.getElementById("calcResultEmpty");
        if (calcResultEmptyEl) {
            calcResultEmptyEl.style.display = 'block';
        }
    }

    function toggleFinalFields(val){
        const group=document.getElementById('finalCostGroup');
        if(group){
            group.classList.toggle('d-none', val !== 'done' && val !== 'paid');
        }
        syncCalcStatusDisplay();
    }


    /* Настройки OrcaSlicer для принтера */
    let currentOrcaPrinterId = null;
    let currentOrcaProfileIndex = 0;
    const ORCA_PRINTER_FIELDS = [];

    function populateOrcaProfileSelect(pr){
        const sel=document.getElementById('orcaProfileSelect');
        sel.innerHTML='';
        (pr.profileIds||[]).forEach((pid,i)=>{
            const pf=appData.printerProfiles.find(p=>String(p.id)===String(pid));
            const cfg=pf?pf.config||{}:{};
            const opt=document.createElement('option');
            opt.value=i;
            opt.textContent=cfg.printer_settings_id||cfg.name||('Профиль '+(i+1));
            sel.appendChild(opt);
        });
    }

    function loadOrcaProfile(pr,index){
        currentOrcaProfileIndex=index;
        const pid=pr.profileIds[index];
        const profile=appData.printerProfiles.find(p=>String(p.id)===String(pid));
        const cfg=profile?profile.config||{}:{};
        document.getElementById('orcaPrinterJsonView').textContent=JSON.stringify(cfg,null,2);
        document.getElementById('orcaPrinterInfoView').textContent=profile?profile.info||'':'';
        document.getElementById('orcaProfileSelect').value=index;
    }

    function openPrinterOrca(id){
        const pr=appData.printers.find(p=>String(p.id)===String(id));
        if(!pr) return;
        currentOrcaPrinterId=String(id);
        if(!Array.isArray(pr.profileIds)) pr.profileIds=[];
        if(pr.profileIds.length===0){
            const pf={id:getNextId('printerProfiles'),config:{},info:'',printerId:String(pr.id)};
            appData.printerProfiles.push(pf);
            pr.profileIds.push(pf.id);
        }
        populateOrcaProfileSelect(pr);
        loadOrcaProfile(pr,0);
        new bootstrap.Modal(document.getElementById('orcaPrinterModal')).show();
    }




    function deleteOrcaProfile(){
        if(currentOrcaPrinterId===null) return;
        const pr=appData.printers.find(p=>String(p.id)===String(currentOrcaPrinterId));
        if(!pr) return;
        if(pr.profileIds.length<=1) return;
        const pid=pr.profileIds.splice(currentOrcaProfileIndex,1)[0];
        appData.printerProfiles=appData.printerProfiles.filter(p=>String(p.id)!==String(pid));
        const idx=Math.max(0,currentOrcaProfileIndex-1);
        populateOrcaProfileSelect(pr);
        loadOrcaProfile(pr,idx);
    }

    function downloadFullDetailedCalculation(){
        if(!lastCalcFullData){ alert("Нет данных расчёта."); return; }
        const h = generateMaxDetailedCalcHtml(lastCalcFullData);
        const b = new Blob([h], {type:"text/html"});
        const u = URL.createObjectURL(b);
        const l = document.createElement("a");
        l.href = u;
        l.download = `FullDetailedCalc_${Date.now()}.html`;
        document.body.appendChild(l);
        l.click();
        document.body.removeChild(l);
        URL.revokeObjectURL(u);
    }
    function generateMaxDetailedCalcHtml(d) {
        let s = `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>Подробный расчёт<\/title>
  <style>
    body { font-family: sans-serif; margin:20px; }
    .printer-block { margin:10px 0; padding:5px; border:1px dashed #999; }
    table { border-collapse: collapse; }
    td, th { border:1px solid #999; padding:4px 6px; }
  <\/style>
<\/head>
<body>
  <h1>Подробный расчёт<\/h1>
  <p>Название: ${d.calcName || "(Без названия)"}, Клиент: ${d.clientName || "(Не указан)"}, Статус: ${getOrderStatusLabel(d.orderStatus)}<\/p>
  <p>Срочность: ${d.urgencyProfileTitle || '—'}${d.profileMarkupPercent ? ` (+${d.profileMarkupPercent}% )` : ''}${d.userMarkupPercent ? `, ручная ${d.userMarkupPercent}%` : ''}<\/p>
  <p>Итог: <strong>${safeFixed(d.total)} ₽<\/strong>${d.priceBeforeDiscount ? ` (скидка ${d.discountPercent}% от ${safeFixed(d.priceBeforeDiscount)} ₽)` : ''}<\/p>
  <p>Оператор ч.: ${formatTimeForDisplay(d.totalHours)} ч, Стоимость работы оператора: ${safeFixed(d.totalOperatorCost)} ₽, Налог: ${d.taxPercent}%, Упаковка/Доставка: ${d.shipping}₽, Этикетки: ${safeFixed(d.totalLabelsCost || 0)} ₽, Эл.: ${d.costKwh}₽/кВт⋅ч<\/p>
  <p>Параллельная печать: ${d.parallelMode}, Наценка: ${d.markupPercent || 0}%<\/p>
  <p>Подитог: ${safeFixed(d.total - d.globalAdditional.taxAmount)} ₽, Общий налог: ${safeFixed(d.globalAdditional.taxAmount)} ₽<\/p>
  <hr/>
`;
        d.detailsByPrinter.forEach(pr => {
            s += `<div class="printer-block">
      <strong>Принтер: ${pr.printerName} (ID: ${pr.printerId})<\/strong><br/>
      Время: ${formatTimeForDisplay(pr.printerTime)} ч<br/>
    `;
            if(pr.linesDetail && pr.linesDetail.length>0){
                s += `<table style="margin-top:5px;">
        <thead><tr>
          <th>Модель<\/th>
          <th>Иконка<\/th>
          <th>Статус<\/th>
          <th>Часы<\/th>
          <th>Вес (г)<\/th>
          <th>Материал<\/th>
          <th>Сумма<\/th>
        <\/tr><\/thead>
        <tbody>`;
                pr.linesDetail.forEach(ln => {
                    s += `<tr>
          <td>${ln.name} (${ln.id || ''})${ln.excludedFromTotals ? ' <span style="color:#999;">(не в расчёте)<\/span>' : ''}<\/td>
          <td>${ln.thumbnail ? `<img src="data:image/png;base64,${ln.thumbnail}" style="height:40px;"/>` : (getBrandLogoDataUrl() ? `<img src="${getBrandLogoDataUrl()}" style="height:40px;"/>` : '')}<\/td>
          <td>${getModelStatusLabel(ln.status)}${getModelQualityLabel(ln.status) ? ` — ${getModelQualityLabel(ln.status)}` : ''}<\/td>
          <td>${safeFixed(ln.hours)}<\/td>
          <td>${safeFixed(ln.realWeight)}<\/td>
          <td>${ln.matName}<\/td>
          <td>${safeFixed(ln.subTotalModel)}<\/td>
        <\/tr>`;
                });
                s += `<\/tbody><\/table>`;
            }
            s += `<\/div>`;
        });
        s += `<\/body><\/html>`;
        return s;
    }
    function onEditCalcHistory(timestamp){
        const it = appData.calcHistory.find(x => x.timestamp === timestamp);
        if(!it){ alert("Нет такого элемента в истории"); return; }

        const missing = [];
        if(it.calcData){
            for(const pid in it.calcData){
                if(!appData.printers.find(p=>String(p.id)===String(pid))) missing.push(pid);
            }
        }
        if(missing.length){
            const opts = appData.printers.map(p=>({value:String(p.id),label:p.name||p.id}));
            const fields = missing.map(id=>({id:id,label:`Принтер для ${id}`,type:'select',options:opts}));
            showMultiPrompt('Не найдены принтеры', fields).then(vals=>{
                if(!vals) return;
                missing.forEach(id=>{
                    const newId = vals[id];
                    if(newId && it.calcData[id]){
                        it.calcData[newId] = (it.calcData[newId]||[]).concat(it.calcData[id]);
                    }
                    delete it.calcData[id];
                });
                onEditCalcHistory(timestamp);
            });
            return;
        }
        setCalcOrderId(it.id || "");
        document.getElementById("calcName").value = it.calcName || "";
        applyClientSelection(it.clientId || '', it.clientName || "");
        document.getElementById("calcOrderStatus").value = it.orderStatus || "new";
        document.getElementById("calcOperatorRate").value = it.operatorRate || "";
        document.getElementById("calcCostKwh").value = it.costKwh || "";
        document.getElementById("calcTaxPercent").value = it.taxPercent || "";
        document.getElementById("calcShipping").value = it.shipping || "";
        document.getElementById("calcStartDate").value = normalizeDateTimeLocal(it.startDate);
        const deadlineInput = document.getElementById("calcDeadlineDate");
        if (deadlineInput) {
            deadlineInput.value = it.requiredFinishDate ? normalizeDateTimeLocal(it.requiredFinishDate) : "";
        }
        document.getElementById("calcParallelPrinting").value = it.parallelMode || "no";
        const manualMarkup = typeof it.userMarkupPercent === 'number' ? it.userMarkupPercent : (it.markupPercent || 0);
        document.getElementById("calcMarkupPercent").value = manualMarkup;
        const urgencySelectEl = document.getElementById('calcUrgencyProfile');
        if (urgencySelectEl && it.urgencyProfileId) {
            urgencySelectEl.value = it.urgencyProfileId;
            appData.calcSettings.currentUrgencyId = it.urgencyProfileId;
            urgencySelectEl.dispatchEvent(new Event('change'));
        }
        document.getElementById("calcDiscountPercent").value = it.discountPercent || 0;
        document.getElementById("calcFinalCost").value = it.realTotal || '';
        toggleFinalFields(it.orderStatus || 'new');
        appData.calcSettings.customServices = it.services ? it.services.map(s=>({...s})) : [];
        renderCustomServicesTable();

        if(it.calcData){
            for(const printerId in it.calcData){
                const table = document.getElementById(`calcModelsTable_${printerId}`);
                if(!table) continue;
                const tbody = table.querySelector("tbody");
                tbody.innerHTML = "";
                const prIdNum = isNaN(printerId) ? printerId : parseInt(printerId, 10);
                updatePrinterModelsEmptyState(prIdNum);
                it.calcData[printerId].forEach(model => {
                    addModelRow(prIdNum, model);
                });
            }
        }
        const tabEl = document.querySelector('#calculate-tab');
        const tab = new bootstrap.Tab(tabEl);
        tab.show();
    }

    function ensureIconsLoaded() {
        if (!document.querySelector('link[href*="bootstrap-icons"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css';
            document.head.appendChild(link);
        }
    }

    function onSummaryPeriodChange(){
        const val = document.getElementById('summaryPeriod').value;
        const fromInput = document.getElementById('summaryFrom');
        const toInput = document.getElementById('summaryTo');
        const applyBtn = document.getElementById('summaryApplyBtn');
        const showCustom = val === 'custom';
        fromInput.classList.toggle('d-none', !showCustom);
        toInput.classList.toggle('d-none', !showCustom);
        applyBtn.classList.toggle('d-none', !showCustom);
        if(!showCustom){
            renderSummary();
        }
    }

    function initSummaryChartTooltips(root){
        if(!root) return;
        let tooltip = document.getElementById('summaryChartTooltip');
        if(!tooltip){
            tooltip = document.createElement('div');
            tooltip.id = 'summaryChartTooltip';
            tooltip.className = 'summary-chart-tooltip';
            document.body.appendChild(tooltip);
        }

        const move = (event) => {
            if(!tooltip.classList.contains('visible')) return;
            tooltip.style.left = `${event.clientX}px`;
            tooltip.style.top = `${event.clientY}px`;
        };

        const show = (event) => {
            const target = event.target.closest('[data-chart-label]');
            if(!target) return;
            tooltip.textContent = target.getAttribute('data-chart-label') || '';
            tooltip.classList.add('visible');
            move(event);
        };

        const hide = () => {
            tooltip.classList.remove('visible');
        };

        root.querySelectorAll('[data-chart-label]').forEach(el => {
            el.addEventListener('mouseenter', show);
            el.addEventListener('mousemove', move);
            el.addEventListener('mouseleave', hide);
            el.addEventListener('focus', show);
            el.addEventListener('blur', hide);
        });
    }

    function renderSummary() {
        ensureIconsLoaded();
// Вспомогательные функции форматирования
        const formatCurrency = (value) => new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);

        const formatNumber = (value, decimals = 2) =>
            new Intl.NumberFormat('ru-RU', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);

        const formatCompact = (value, decimals = 1) =>
            new Intl.NumberFormat('ru-RU', {
                notation: 'compact',
                compactDisplay: 'short',
                maximumFractionDigits: decimals
            }).format(value);

        const getOrderTimestamp = (order) =>
            order.timestamp || (order.dateStr ? parseHistoryDate(order.dateStr).getTime() : 0);

        const buildDonutChart = (segments, options = {}) => {
            const size = options.size || 150;
            const thickness = options.thickness || 18;
            const centerLabel = options.centerLabel || '';
            const centerValue = options.centerValue || '';
            const valueFormatter = options.valueFormatter;
            const total = segments.reduce((sum, seg) => sum + (seg.value || 0), 0);
            if (!total) {
                return `<div class="calc-empty-placeholder text-muted small">Нет данных</div>`;
            }
            const radius = (size - thickness) / 2;
            const circumference = 2 * Math.PI * radius;
            let offset = 0;
            const circles = segments.map(seg => {
                const value = seg.value || 0;
                const percent = total > 0 ? (value / total) * 100 : 0;
                const length = (percent / 100) * circumference;
                const dashArray = `${length} ${circumference - length}`;
                const dashOffset = -offset;
                offset += length;
                const formattedValue = valueFormatter ? valueFormatter(value) : formatNumber(value, 1);
                const tooltipLabel = `${seg.label}: ${formattedValue} (${formatNumber(percent, 1)}%)`;
                return `
                  <circle cx="${size / 2}" cy="${size / 2}" r="${radius}"
                          fill="none"
                          stroke="${seg.color || '#2563eb'}"
                          stroke-width="${thickness}"
                          stroke-dasharray="${dashArray}"
                          stroke-dashoffset="${dashOffset}"
                          data-chart-label="${escapeHtml(tooltipLabel)}"
                          tabindex="0"></circle>`;
            }).join('');
            const centerHtml = (centerLabel || centerValue)
                ? `
                  <div class="summary-donut-center">
                    <div class="label">${centerLabel}</div>
                    <div class="value">${centerValue}</div>
                  </div>`
                : '';
            return `
              <div class="summary-donut" style="width:${size}px;height:${size}px;">
                <svg viewBox="0 0 ${size} ${size}" role="img" aria-label="${escapeHtml(centerLabel || 'Диаграмма')}" focusable="false">
                  <circle cx="${size / 2}" cy="${size / 2}" r="${radius}" fill="none" stroke="rgba(148, 163, 184, 0.25)" stroke-width="${thickness}"></circle>
                  <g transform="rotate(-90 ${size / 2} ${size / 2})">
                    ${circles}
                  </g>
                </svg>
                ${centerHtml}
              </div>
            `;
        };

        const buildLegend = (segments, valueFormatter) => `
          <div class="summary-time-legend">
            ${segments.map(seg => {
                const formattedValue = valueFormatter ? valueFormatter(seg.value || 0) : formatNumber(seg.value || 0, 1);
                return `<span><span class="summary-legend-dot" style="background:${seg.color || '#2563eb'};"></span>${seg.label} ${formattedValue}</span>`;
            }).join('')}
          </div>
        `;

        const buildSparklineChart = (series, options = {}) => {
            if (!series || !series.length) {
                return `<div class="calc-empty-placeholder text-muted small">Нет данных</div>`;
            }
            const width = options.width || 160;
            const height = options.height || 60;
            const color = options.color || '#2563eb';
            const valueFormatter = options.valueFormatter;
            const gradientId = `spark-${options.id || Math.random().toString(36).slice(2, 8)}`;
            const values = series.map(item => item.value || 0);
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);
            const range = Math.max(1, maxValue - minValue);
            const padding = 6;
            const step = series.length > 1 ? (width - padding * 2) / (series.length - 1) : 0;
            const points = series.map((item, index) => {
                const x = padding + index * step;
                const y = height - padding - ((item.value - minValue) / range) * (height - padding * 2);
                return { x, y, item };
            });
            const path = points.map((pt, index) => `${index === 0 ? 'M' : 'L'}${pt.x},${pt.y}`).join(' ');
            const areaPath = `${path} L ${points[points.length - 1].x},${height - padding} L ${points[0].x},${height - padding} Z`;
            const dots = points.map(pt => {
                const formattedValue = valueFormatter ? valueFormatter(pt.item.value) : formatNumber(pt.item.value, 0);
                const tooltipLabel = `${pt.item.label}: ${formattedValue}`;
                return `<circle cx="${pt.x}" cy="${pt.y}" r="2.6" fill="${color}" data-chart-label="${escapeHtml(tooltipLabel)}" tabindex="0"></circle>`;
            }).join('');
            return `
              <svg class="summary-sparkline" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                <defs>
                  <linearGradient id="${gradientId}" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="${color}" stop-opacity="0.35"></stop>
                    <stop offset="100%" stop-color="${color}" stop-opacity="0"></stop>
                  </linearGradient>
                </defs>
                <path d="${areaPath}" fill="url(#${gradientId})"></path>
                <path d="${path}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round"></path>
                ${dots}
              </svg>
            `;
        };

        const buildTimeTrack = (segments) => {
            const total = segments.reduce((sum, seg) => sum + (seg.value || 0), 0);
            if (!total) {
                return `<div class="calc-empty-placeholder text-muted small">Нет данных</div>`;
            }
            const bars = segments.map(seg => {
                const percent = total > 0 ? (seg.value / total) * 100 : 0;
                const label = `${seg.label}: ${formatNumber(seg.value || 0, 1)} ч (${formatNumber(percent, 1)}%)`;
                return `<span style="width:${Math.max(1, percent)}%;background:${seg.color};" data-chart-label="${escapeHtml(label)}" tabindex="0"></span>`;
            }).join('');
            const legend = segments.map(seg =>
                `<span><span class="summary-legend-dot" style="background:${seg.color};"></span>${seg.label} ${formatNumber(seg.value || 0, 1)} ч</span>`
            ).join('');
            return `<div class="summary-time-track">${bars}</div><div class="summary-time-legend">${legend}</div>`;
        };

        const buildStatusBars = (items) => {
            const total = items.reduce((sum, item) => sum + (item.value || 0), 0);
            if (!total) {
                return `<div class="calc-empty-placeholder text-muted small">Нет данных</div>`;
            }
            const rows = items.map(item => {
                const percent = total > 0 ? (item.value / total) * 100 : 0;
                const label = `${item.label}: ${item.value} (${formatNumber(percent, 1)}%)`;
                return `
                  <div class="summary-bar-row">
                    <div class="summary-bar-label">${item.label}</div>
                    <div class="summary-bar-track">
                      <span style="width:${Math.max(2, percent)}%;background:${item.color};" data-chart-label="${escapeHtml(label)}" tabindex="0"></span>
                    </div>
                    <div class="summary-bar-value">${formatCompact(item.value, 0)}</div>
                  </div>
                `;
            }).join('');
            return `<div class="summary-bar-list">${rows}</div>`;
        };

        const buildRevenueSeries = (orders, fromDate, toDate, days) => {
            if (!fromDate || !toDate) return [];
            const start = new Date(fromDate);
            const end = new Date(toDate);
            if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return [];
            start.setHours(0, 0, 0, 0);
            const endSafe = new Date(end);
            endSafe.setHours(0, 0, 0, 0);
            if (endSafe <= start) return [];

            const bucketType = days > 120 ? 'month' : (days > 45 ? 'week' : 'day');
            const buckets = [];
            const formatDay = (date) => date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
            const formatMonth = (date) => date.toLocaleDateString('ru-RU', { month: 'short', year: '2-digit' });

            let cursor = new Date(start);
            while (cursor < endSafe) {
                const bucketStart = new Date(cursor);
                let bucketEnd = new Date(cursor);
                if (bucketType === 'month') {
                    bucketEnd.setMonth(bucketEnd.getMonth() + 1);
                } else if (bucketType === 'week') {
                    bucketEnd.setDate(bucketEnd.getDate() + 7);
                } else {
                    bucketEnd.setDate(bucketEnd.getDate() + 1);
                }
                if (bucketEnd > endSafe) bucketEnd = new Date(endSafe);
                let label = '';
                if (bucketType === 'month') {
                    label = formatMonth(bucketStart);
                } else if (bucketType === 'week') {
                    const lastDay = new Date(bucketEnd.getTime() - 24 * 60 * 60 * 1000);
                    label = `${formatDay(bucketStart)}-${formatDay(lastDay)}`;
                } else {
                    label = formatDay(bucketStart);
                }
                buckets.push({ start: bucketStart.getTime(), end: bucketEnd.getTime(), label, value: 0 });
                cursor = bucketEnd;
            }

            const sortedOrders = Array.isArray(orders) ? orders.slice() : [];
            sortedOrders.sort((a, b) => getOrderTimestamp(a) - getOrderTimestamp(b));
            let orderIndex = 0;
            buckets.forEach(bucket => {
                let sum = 0;
                while (orderIndex < sortedOrders.length) {
                    const ts = getOrderTimestamp(sortedOrders[orderIndex]);
                    if (ts < bucket.start) {
                        orderIndex += 1;
                        continue;
                    }
                    if (ts >= bucket.end) break;
                    sum += sortedOrders[orderIndex].total || 0;
                    orderIndex += 1;
                }
                bucket.value = sum;
            });

            return buckets.map(bucket => ({ label: bucket.label, value: bucket.value }));
        };

        const period = document.getElementById('summaryPeriod').value;
        let to = new Date();
        let from = new Date(to);
        if(period === 'week'){
            from.setDate(from.getDate() - 7);
        } else if(period === 'month'){
            from.setMonth(from.getMonth() - 1);
        } else if(period === 'year'){
            from.setFullYear(from.getFullYear() - 1);
        } else if(period === 'custom'){
            const fv = document.getElementById('summaryFrom').value;
            const tv = document.getElementById('summaryTo').value;
            if(fv) from = new Date(fv);
            if(tv){ to = new Date(tv); to.setDate(to.getDate()+1); }
        } else if(period === 'all'){
            from = new Date('1970-01-01');
        }

        const periodMs = Math.max(1, to.getTime() - from.getTime());
        const periodDays = periodMs / (1000 * 60 * 60 * 24);

        // 1. Расчет капитальных вложений
        const calculateCapitalInvestments = () => {
            const printersCost = appData.printers.reduce((sum, p) => sum + (p.cost || 0), 0);
            const materials = appData.materials.reduce((acc, m) => {
                const weight = m.declaredWeight || 0;
                const cost = (m.costPerKg || 0) * weight;
                acc.cost += cost;
                acc.weight += weight;
                return acc;
            }, { cost: 0, weight: 0 });
            const additional = appData.additionalGlobal.reduce((sum, a) => sum + (a.cost || 0), 0);
            const total = printersCost + materials.cost + additional;
            return {
                printersCost,
                materialsCost: materials.cost,
                materialsWeight: materials.weight,
                additionalCost: additional,
                total
            };
        };

        // 2. Анализ завершенных заказов
        const analyzeCompletedOrders = (fromDate, toDate) => {
            const completedOrders = appData.calcHistory
                .filter(o => {
                    const ts = o.timestamp || (o.dateStr ? parseHistoryDate(o.dateStr).getTime() : 0);
                    return (o.orderStatus === "done" || o.orderStatus === "paid") && ts >= fromDate.getTime() && ts < toDate.getTime();
                })
                .sort((a, b) => {
                    const tsA = a.timestamp || (a.dateStr ? parseHistoryDate(a.dateStr).getTime() : 0);
                    const tsB = b.timestamp || (b.dateStr ? parseHistoryDate(b.dateStr).getTime() : 0);
                    return tsA - tsB;
                });
            const results = {
                totalRevenue: 0,
                totalTax: 0,
                totalCost: 0,
                totalPrintHours: 0,
                totalElectricityCost: 0,
                totalOperatorExpenses: 0,
                totalServiceCost: 0,
                totalShippingCost: 0,
                totalAdditionalCost: 0,
                totalLabelsCost: 0,
                totalMaterialCost: 0,
                totalPrinterCost: 0,
                totalMaintenanceCost: 0,
                totalRejectHours: 0,
                totalRejectGrams: 0,
                totalDowntimeMinutes: 0,
                totalCoolingMinutes: 0,
                totalModels: 0,
                smallBatchOrders: 0,
                batchSizes: [],
                materialStats: {},
                printerStats: {},
                clientStats: {},
                additionalStats: {},
                completedOrdersCount: completedOrders.length,
                totalPrepMinutes: 0
            };

            const ensureAdditionalStat = (source) => {
                if (!source) return null;
                const rawId = source.id ?? source;
                if (rawId === undefined || rawId === null || rawId === '') return null;
                const id = String(rawId);
                if (!results.additionalStats[id]) {
                    const baseCost = parseFloat(source.cost ?? source.baseCost) || 0;
                    results.additionalStats[id] = {
                        id,
                        name: source.description || source.name || `Расход #${id}`,
                        baseCost,
                        distributed: 0,
                        orders: 0
                    };
                } else if ((source.cost !== undefined || source.baseCost !== undefined) && results.additionalStats[id].baseCost === 0) {
                    const baseCost = parseFloat(source.cost ?? source.baseCost);
                    if (!isNaN(baseCost)) {
                        results.additionalStats[id].baseCost = baseCost;
                    }
                }
                return results.additionalStats[id];
            };

            (appData.additionalGlobal || []).forEach(add => ensureAdditionalStat(add));

            // Инициализация статистики принтеров
            appData.printers.forEach(p => {
                results.printerStats[p.id] = {
                    name: p.name,
                    hours: 0,
                    amortization: 0,
                    energy: 0,
                    material: 0,
                    maintenance: 0,
                    revenue: 0,
                    prints: 0,
                    grams: 0,
                    rejectHours: 0,
                    rejectGrams: 0,
                    prepMinutes: 0
                };
            });

            completedOrders.forEach(order => {
                results.totalRevenue += order.total || 0;
                let orderCost = 0;
                let orderGrams = 0;
                let orderModelCount = 0;
                const orderMaterialGrams = {};

                // Расчет налогов
                if (order.taxAmount !== undefined) {
                    results.totalTax += order.taxAmount;
                } else if (order.taxPercent !== undefined && order.taxPercent > 0) {
                    results.totalTax += order.total * (order.taxPercent / 100);
                }

                // Учет расходов на оператора
                results.totalOperatorExpenses += order.totalOperatorCost || 0;

                // Учет расходов на услуги
                const serviceCost = order.servicesTotal || 0;
                results.totalServiceCost += serviceCost;

                // Обработка деталей заказа
                order.details?.forEach(printer => {
                    const printerId = printer.printerId;

                    if (!results.printerStats[printerId]) {
                        results.printerStats[printerId] = {
                            name: printer.printerName,
                            hours: 0,
                            amortization: 0,
                            energy: 0,
                            material: 0,
                            maintenance: 0,
                            revenue: 0,
                            prints: 0,
                            grams: 0,
                            rejectHours: 0,
                            rejectGrams: 0
                        };
                    }

                    printer.linesDetail?.forEach(model => {
                        const materialId = model.materialData?.id;
                        const materialCost = model.costMaterial || 0;
                        const amortization = model.costPrinterPart || 0;
                        const electric = model.costElectric || 0;
                        const maintenance = model.costMaintenance || 0;
                        const modelRevenue = model.subTotalModel || 0;
                        const hours = model.hours || 0;
                        const status = model.status;
                        const ps = results.printerStats[printerId];
                        if (status === 'reject') {
                            results.totalRejectHours += hours;
                            results.totalRejectGrams += model.realWeight || 0;
                            ps.rejectHours += hours;
                            ps.rejectGrams += model.realWeight || 0;
                        }

                        if (model.excludedFromTotals) {
                            return;
                        }
                        const prepMinutes = model.printerPrepMinutes || 0;

                        orderModelCount += 1;
                        orderGrams += model.realWeight || 0;
                        if (materialId) {
                            orderMaterialGrams[materialId] = (orderMaterialGrams[materialId] || 0) + (model.realWeight || 0);
                        }

                        if (materialId) {
                            // Статистика по материалам
                            if (!results.materialStats[materialId]) {
                                const mat = findMaterialById(materialId);
                                results.materialStats[materialId] = {
                                    name: mat ? `${mat.name} (ID: ${mat.id}) | ${mat.manufacturer}` :
                                        `${model.matName} | ${model.materialData?.manufacturer || 'N/A'}`,
                                    type: mat?.materialType || model.materialData?.materialType || '',
                                    manufacturer: mat?.manufacturer || model.materialData?.manufacturer || '',
                                    totalGrams: 0,
                                    totalCost: 0,
                                    totalRevenue: 0,
                                    clientRevenue: 0
                                };
                            }

                            results.materialStats[materialId].totalGrams += model.realWeight || 0;
                            results.materialStats[materialId].totalCost += materialCost;
                            results.materialStats[materialId].totalRevenue += modelRevenue;
                        }

                        // Глобальные суммы
                        results.totalMaterialCost += materialCost;
                        results.totalPrinterCost += amortization;
                        results.totalMaintenanceCost += maintenance;
                        results.totalElectricityCost += electric;
                        results.totalCost += materialCost + amortization + electric + maintenance;
                        orderCost += materialCost + amortization + electric + maintenance;
                        results.totalPrintHours += hours;

                        // Статистика по принтерам
                        ps.hours += hours;
                        ps.amortization += amortization;
                        ps.energy += electric;
                        ps.material += materialCost;
                        ps.maintenance += maintenance;
                        ps.revenue += modelRevenue;
                        ps.prepMinutes += prepMinutes;
                        results.totalPrepMinutes += prepMinutes;
                        ps.prints++;
                        ps.grams += model.realWeight || 0;
                    });
                });

                if (orderModelCount > 0) {
                    results.totalModels += orderModelCount;
                    results.batchSizes.push(orderModelCount);
                    if (orderModelCount <= 3) {
                        results.smallBatchOrders += 1;
                    }
                }

                const additionsInOrder = new Set();
                let orderAdditionalCost = 0;
                order.globalAdditional?.details?.forEach(det => {
                    const stat = ensureAdditionalStat({
                        id: det.id,
                        description: det.description,
                        cost: det.baseCost
                    });
                    if (!stat) return;
                    const distributed = det.costDistributed || 0;
                    const remaining = stat.baseCost > 0 ? Math.max(0, stat.baseCost - stat.distributed) : Infinity;
                    const applied = Math.min(distributed, remaining);
                    stat.distributed += applied;
                    if (applied > 0) {
                        orderAdditionalCost += applied;
                        additionsInOrder.add(stat.id);
                    }
                });

                // Глобальные расходы
                const addCost = orderAdditionalCost;
                const shipping = order.shipping || 0;
                const labelsCost = order.totalLabelsCost || 0;
                const estimateCostHistory = order.estimatePrintCost || 0;
                const globalCosts = addCost + labelsCost + estimateCostHistory + shipping + (order.totalOperatorCost || 0) + serviceCost;
                results.totalAdditionalCost += addCost + labelsCost + estimateCostHistory;
                results.totalShippingCost += shipping;
                results.totalLabelsCost += labelsCost;
                if (estimateCostHistory > 0) {
                    results.additionalStats['estimatePrint'] = results.additionalStats['estimatePrint'] || {
                        id: 'estimatePrint',
                        name: 'Печать сметы',
                        baseCost: parseFloat(order.estimatePrintCost) || 0,
                        distributed: 0,
                        orders: 0
                    };
                    results.additionalStats['estimatePrint'].distributed += estimateCostHistory;
                    results.additionalStats['estimatePrint'].orders += 1;
                }
                results.totalCost += globalCosts;
                orderCost += globalCosts;

                const orderDowntimeMinutes = order.downtimeMinutes || 0;
                const orderCoolingMinutes = order.coolingMinutes !== undefined
                    ? order.coolingMinutes
                    : Math.max(0, orderDowntimeMinutes - (order.printerPrepMinutes || 0));
                results.totalDowntimeMinutes += orderDowntimeMinutes;
                results.totalCoolingMinutes += orderCoolingMinutes;

                const orderModelsRevenue = typeof order.modelsRevenue === 'number'
                    ? order.modelsRevenue
                    : Math.max(0, (order.total || 0) - (order.shipping || 0) - (order.servicesTotal || 0));
                if (orderGrams > 0 && orderModelsRevenue > 0) {
                    const orderRevenueShare = orderModelsRevenue;
                    Object.entries(orderMaterialGrams).forEach(([materialId, grams]) => {
                        const stat = results.materialStats[materialId];
                        if (!stat) return;
                        stat.clientRevenue += orderRevenueShare * (grams / orderGrams);
                    });
                }

                // Статистика по клиентам
                const clientName = order.clientName || '(Не указан)';
                if (!results.clientStats[clientName]) {
                    results.clientStats[clientName] = { name: clientName, revenue: 0, cost: 0, grams: 0, orders: 0 };
                }
                const cs = results.clientStats[clientName];
                cs.revenue += order.total || 0;
                cs.cost += orderCost;
                cs.grams += orderGrams;
                cs.orders += 1;

                additionsInOrder.forEach(id => {
                    const stat = results.additionalStats[id];
                    if (!stat) return;
                    stat.orders += 1;
                });
            });

            const sortedBatch = results.batchSizes.slice().sort((a, b) => a - b);
            const batchCount = sortedBatch.length;
            const medianBatch = batchCount
                ? (batchCount % 2
                    ? sortedBatch[(batchCount - 1) / 2]
                    : (sortedBatch[batchCount / 2 - 1] + sortedBatch[batchCount / 2]) / 2)
                : 0;

            results.batchStats = {
                avgModelsPerOrder: results.completedOrdersCount > 0 ? results.totalModels / results.completedOrdersCount : 0,
                medianBatchSize: medianBatch,
                smallBatchShare: results.completedOrdersCount > 0 ? (results.smallBatchOrders / results.completedOrdersCount) * 100 : 0,
                totalModels: results.totalModels
            };
            delete results.batchSizes;
            results.ordersList = completedOrders;

            return results;
        };

        // 3. Расчет ключевых показателей
        const calculateKPIs = (capital, ordersAnalysis) => {
            const {
                totalRevenue,
                totalCost,
                totalTax,
                totalElectricityCost,
                totalOperatorExpenses,
                totalPrintHours: summaryPrintHours,
                totalServiceCost,
                totalShippingCost,
                totalAdditionalCost,
                totalMaterialCost,
                totalPrinterCost,
                totalMaintenanceCost,
                materialStats,
                completedOrdersCount
            } = ordersAnalysis;

            const grossProfit = totalRevenue - totalCost;
            const netProfit = grossProfit - totalTax;
            const netMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
            const grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;
            const roi = capital.total > 0 ? (netProfit / capital.total) * 100 : 0;
            const avgOrderCost = completedOrdersCount > 0 ? totalCost / completedOrdersCount : 0;

            const paybackOrders = completedOrdersCount > 0 && netProfit !== 0
                ? capital.total / (netProfit / completedOrdersCount)
                : 0;

            const totalGrams = Object.values(materialStats).reduce(
                (sum, m) => sum + m.totalGrams, 0);

            const ebitda = netProfit + totalTax + totalPrinterCost;
            const breakEvenRevenue = capital.total + (totalCost - totalPrinterCost) + totalTax;
            const revenueGap = breakEvenRevenue - totalRevenue;
            const profitabilityIndex = capital.total > 0 ? (netProfit + capital.total) / capital.total : 0;
            const depreciationRate = capital.printersCost > 0 ? (totalPrinterCost / capital.printersCost) * 100 : 0;

            return {
                grossProfit,
                netProfit,
                netMargin,
                grossMargin,
                roi,
                paybackOrders,
                profitPerHour: summaryPrintHours > 0 ? netProfit / summaryPrintHours : 0,
                avgOrderRevenue: completedOrdersCount > 0 ? totalRevenue / completedOrdersCount : 0,
                avgOrderProfit: completedOrdersCount > 0 ? netProfit / completedOrdersCount : 0,
                avgOrderCost,
                avgPrintHoursPerOrder: completedOrdersCount > 0 ? summaryPrintHours / completedOrdersCount : 0,
                avgMaterialPerOrder: completedOrdersCount > 0 ? totalGrams / completedOrdersCount : 0,
                costPerKg: totalGrams > 0 ? totalCost / (totalGrams / 1000) : 0,
                netProfitPerKg: totalGrams > 0 ? netProfit / (totalGrams / 1000) : 0,
                avgCostPerGram: totalGrams > 0 ? totalCost / totalGrams : 0,
                avgRevenuePerGram: totalGrams > 0 ? totalRevenue / totalGrams : 0,
                costStructure: {
                    material: totalCost > 0 ? (totalMaterialCost / totalCost) * 100 : 0,
                    electricity: totalCost > 0 ? (totalElectricityCost / totalCost) * 100 : 0,
                    operator: totalCost > 0 ? (totalOperatorExpenses / totalCost) * 100 : 0,
                    services: totalCost > 0 ? (totalServiceCost / totalCost) * 100 : 0,
                    shipping: totalCost > 0 ? (totalShippingCost / totalCost) * 100 : 0,
                    additional: totalCost > 0 ? (totalAdditionalCost / totalCost) * 100 : 0,
                    amortization: totalCost > 0 ? (totalPrinterCost / totalCost) * 100 : 0,
                    maintenance: totalCost > 0 ? (totalMaintenanceCost / totalCost) * 100 : 0
                },
                totalMaterialCost,
                totalGrams,
                ebitda,
                breakEvenRevenue,
                revenueGap,
                profitabilityIndex,
                depreciationRate
            };
        };



        const generateHTML = (capital, ordersAnalysis, kpis, meta = {}) => {
            const {
                completedOrdersCount,
                totalRevenue,
                totalTax,
                totalCost,
                totalOperatorExpenses,
                totalServiceCost,
                totalElectricityCost,
                totalMaterialCost,
                totalShippingCost,
                totalAdditionalCost,
                totalPrinterCost,
                totalMaintenanceCost,
                totalRejectHours,
                totalRejectGrams,
                totalPrepMinutes,
                totalDowntimeMinutes,
                totalCoolingMinutes,
                totalModels,
                materialStats,
                printerStats,
                clientStats,
                batchStats = { avgModelsPerOrder: 0, medianBatchSize: 0, smallBatchShare: 0 },
                additionalStats = {}
            } = ordersAnalysis;
            const totalPrintHours = ordersAnalysis.totalPrintHours || 0;

            const {
                grossProfit,
                netProfit,
                netMargin,
                grossMargin,
                paybackOrders,
                avgOrderRevenue,
                avgOrderProfit,
                avgOrderCost,
                profitPerHour,
                avgPrintHoursPerOrder,
                avgMaterialPerOrder,
                costPerKg,
                netProfitPerKg,
                avgCostPerGram,
                avgRevenuePerGram,
                costStructure,
                ebitda,
                breakEvenRevenue,
                revenueGap,
                depreciationRate
            } = kpis;

            const { periodDays = 1 } = meta;
            const rangeFrom = meta.from instanceof Date ? meta.from : null;
            const rangeTo = meta.to instanceof Date ? meta.to : null;

            const paybackAbs = netProfit - capital.total;
            const avgModelsPerOrder = batchStats.avgModelsPerOrder || 0;
            const totalOutputMass = (kpis.totalGrams || 0) + (totalRejectGrams || 0);
            const yieldRate = totalOutputMass > 0 ? ((kpis.totalGrams || 0) / totalOutputMass) * 100 : 0;
            const periodHours = Math.max(1, periodDays) * 24;

            // Форматирование данных для таблиц
            const totalMaterialRevenue = Object.values(materialStats).reduce((sum, m) => sum + (m.totalRevenue || 0), 0);
            const totalMaterialClientRevenue = Object.values(materialStats).reduce((sum, m) => sum + (m.clientRevenue || 0), 0);
            const totalMaterialMargin = totalMaterialRevenue - totalMaterialCost;
            const avgClientPricePerGram = kpis.totalGrams > 0 ? totalMaterialClientRevenue / kpis.totalGrams : 0;
            const materialRows = Object.values(materialStats).map(m => {
                const margin = (m.totalRevenue || 0) - (m.totalCost || 0);
                const share = kpis.totalGrams > 0 ? (m.totalGrams / kpis.totalGrams) * 100 : 0;
                const costPerKg = m.totalGrams > 0 ? m.totalCost / (m.totalGrams / 1000) : 0;
                const clientPricePerGram = m.totalGrams > 0 ? (m.clientRevenue || 0) / m.totalGrams : 0;
                return `
      <tr>
        <td>
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${m.name}</strong>
              <div class="text-muted small">${m.type || '—'} | ${m.manufacturer || '—'}</div>
              <div class="text-muted small">Расход: ${formatNumber(m.totalGrams / 1000, 3)} кг · ₽/кг: ${costPerKg > 0 ? `${formatCurrency(costPerKg)}/кг` : '0.00 ₽/кг'}</div>
            </div>
            <div class="text-end ms-2">
              <span class="${margin >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(margin)}</span>
              <div class="small text-muted">Маржа</div>
            </div>
          </div>
          <div class="progress mt-1" style="height: 4px;">
            <div class="progress-bar bg-info" style="width: ${Math.min(100, Math.max(0, share))}%"></div>
          </div>
          <div class="summary-mini-label">Доля расхода: ${formatNumber(share, 1)}%</div>
        </td>
        <td class="text-end">${formatCurrency(m.totalCost)}</td>
        <td class="text-end">${formatCurrency(m.totalRevenue || 0)}</td>
        <td class="text-end">${formatNumber(clientPricePerGram, 2)} ₽/г</td>
      </tr>
    `;
            }).join('') || `<tr><td colspan="4" class="text-center text-muted py-4">Нет данных по материалам</td></tr>`;
            const downtimeHours = (totalDowntimeMinutes || 0) / 60;
            const coolingHours = (totalCoolingMinutes || 0) / 60;
            const prepHours = (totalPrepMinutes || 0) / 60;
            const productionHours = totalPrintHours + downtimeHours;
            const downtimeShare = productionHours > 0 ? (downtimeHours / productionHours) * 100 : 0;
            const prepShare = downtimeHours > 0 ? (prepHours / downtimeHours) * 100 : 0;
            const totalPrinterRevenue = Object.values(printerStats).reduce((sum, p) => sum + p.revenue, 0);
            const totalPrinterExpenses = Object.values(printerStats).reduce((sum, p) => sum + p.amortization + p.energy + p.material + p.maintenance, 0);
            const totalPrinterPrints = Object.values(printerStats).reduce((sum, p) => sum + p.prints, 0);

            const printerRows = Object.values(printerStats).map(p => {
                const expenses = p.amortization + p.energy + p.material + p.maintenance;
                const prepHours = (p.prepMinutes || 0) / 60;
                const revenueShare = totalPrinterRevenue > 0 ? (p.revenue / totalPrinterRevenue) * 100 : 0;
                return `
      <tr>
        <td>
          <div class="summary-cell-stack">
            <div>${p.name}</div>
            <div class="summary-mini-bar"><span style="width:${Math.min(100, Math.max(0, revenueShare))}%"></span></div>
            <div class="summary-mini-label">Доля выручки: ${formatNumber(revenueShare, 1)}%</div>
          </div>
        </td>
        <td class="text-end">${formatNumber(p.hours, 1)} ч</td>
        <td class="text-end">${formatNumber(prepHours, 2)} ч</td>
        <td class="text-end">${formatCurrency(p.revenue)}</td>
        <td class="text-end">${formatCurrency(expenses)}</td>
        <td class="text-end">${p.prints}</td>
      </tr>`;
            }).join('') || `<tr><td colspan="6" class="text-center text-muted py-4">Нет данных по принтерам</td></tr>`;

            const totalClientRevenue = Object.values(clientStats).reduce((sum, c) => sum + c.revenue, 0);
            const totalClientCost = Object.values(clientStats).reduce((sum, c) => sum + c.cost, 0);
            const totalClientProfit = totalClientRevenue - totalClientCost;
            const totalClientOrders = Object.values(clientStats).reduce((sum, c) => sum + c.orders, 0);

            const clientRows = Object.values(clientStats).map(c => {
                const profit = c.revenue - c.cost;
                const revenueShare = totalClientRevenue > 0 ? (c.revenue / totalClientRevenue) * 100 : 0;
                return `
      <tr>
        <td>
          <div class="summary-cell-stack">
            <div>${c.name}</div>
            <div class="summary-mini-bar"><span style="width:${Math.min(100, Math.max(0, revenueShare))}%"></span></div>
            <div class="summary-mini-label">Доля выручки: ${formatNumber(revenueShare, 1)}%</div>
          </div>
        </td>
        <td class="text-end">${formatCurrency(c.revenue)}</td>
        <td class="text-end">${formatCurrency(c.cost)}</td>
        <td class="text-end ${profit >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(profit)}</td>
        <td class="text-end">${c.orders}</td>
      </tr>`;
            }).join('') || `<tr><td colspan="5" class="text-center text-muted py-4">Нет данных по клиентам</td></tr>`;
            const clientProfitBadgeClass = totalClientProfit >= 0 ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger';
            const printerHoursTotal = formatNumber(ordersAnalysis.totalPrintHours, 1);
            const printerPrepTotal = formatNumber((ordersAnalysis.totalPrepMinutes || 0) / 60, 2);
            const materialKgTotal = formatNumber(kpis.totalGrams / 1000, 3);

            const breakdownRows = [
                {label: 'Материалы', value: totalMaterialCost},
                {label: 'Электричество', value: totalElectricityCost},
                {label: 'Оператор', value: totalOperatorExpenses},
                {label: 'Услуги', value: totalServiceCost},
                {label: 'Доставка', value: totalShippingCost},
                {label: 'Накладные', value: totalAdditionalCost},
                {label: 'Амортизация', value: totalPrinterCost},
                {label: 'Обслуживание', value: totalMaintenanceCost},
                {label: 'Налоги', value: totalTax}
            ];

            const breakdownFiltered = breakdownRows.filter(item => item.value && item.value > 0);
            const breakdownTotal = (totalCost + totalTax) > 0
                ? (totalCost + totalTax)
                : breakdownFiltered.reduce((sum, item) => sum + item.value, 0);
            const breakdownSorted = [...breakdownFiltered].sort((a, b) => b.value - a.value);

            const restSum = 0;

       //     const breakdownTop = breakdownSorted.slice(0, 6);
            // const restSum = breakdownSorted.slice(6).reduce((sum, item) => sum + item.value, 0);
            // if (restSum > 0) {
            //     breakdownTop.push({label: 'Прочее', value: restSum});
            // }
            const breakdownTop = breakdownSorted; // без агрегации

            const breakdownSegments = [];
            const breakdownItems = [];
            breakdownTop.forEach((item, index) => {
                const percent = breakdownTotal > 0 ? (item.value / breakdownTotal) * 100 : 0;
                const color = COST_STRUCTURE_COLORS[index % COST_STRUCTURE_COLORS.length];
                const width = Math.max(percent, 1);
                breakdownSegments.push(`
                <div class="calc-structure-segment" data-label="${percent >= 18 ? `${Math.round(percent)}%` : ''}" style="flex:${width};background:${color};"></div>
            `);
                breakdownItems.push(`
                <div class="calc-structure-row">
                    <span class="calc-structure-color" style="background:${color};"></span>
                    <div>
                        <div class="label">${item.label}</div>
                        <div class="meta">${percent.toFixed(1)}%</div>
                    </div>
                    <strong>${formatCurrency(item.value)}</strong>
                </div>
            `);
            });

            const costDonutSegments = breakdownTop.map((item, index) => ({
                label: item.label,
                value: item.value,
                color: COST_STRUCTURE_COLORS[index % COST_STRUCTURE_COLORS.length]
            }));
            const costDonut = buildDonutChart(costDonutSegments, {
                centerLabel: 'Затраты',
                centerValue: formatCurrency(breakdownTotal),
                valueFormatter: formatCurrency
            });
            const costLegend = buildLegend(costDonutSegments, formatCurrency);

            const materialSorted = Object.values(materialStats)
                .sort((a, b) => (b.totalGrams || 0) - (a.totalGrams || 0));

            const materialTop = materialSorted.slice(0, 6);
            const materialRest = materialSorted.slice(6).reduce((sum, item) => sum + (item.totalGrams || 0), 0);

            //смотреть все
        //    const materialRest = 0;
        //    const materialTop = materialSorted;

            const materialSegments = materialTop.map((item, index) => ({
                label: item.name,
                value: item.totalGrams || 0,
                color: COST_STRUCTURE_COLORS[(index + 2) % COST_STRUCTURE_COLORS.length]
            }));
            if (materialRest > 0) {
                materialSegments.push({
                    label: 'Прочее',
                    value: materialRest,
                    color: COST_STRUCTURE_COLORS[(materialSegments.length + 2) % COST_STRUCTURE_COLORS.length]
                });
            }
            const materialDonut = buildDonutChart(materialSegments, {
                centerLabel: 'Материалы',
                centerValue: `${formatNumber((kpis.totalGrams || 0) / 1000, 2)} кг`,
                valueFormatter: (value) => `${formatNumber(value / 1000, 2)} кг`
            });
            const materialLegend = buildLegend(materialSegments, (value) => `${formatNumber(value / 1000, 2)} кг`);

            const revenueSeries = buildRevenueSeries(ordersAnalysis.ordersList || [], rangeFrom, rangeTo, periodDays);
            const revenueSparkline = buildSparklineChart(revenueSeries, {
                id: 'revenue',
                color: '#2563eb',
                valueFormatter: formatCurrency
            });
            const revenueSum = revenueSeries.reduce((sum, item) => sum + (item.value || 0), 0);

            const downtimeIdleHours = Math.max(0, downtimeHours - coolingHours);
            const timeSegments = [
                { label: 'Печать', value: totalPrintHours, color: '#2563eb' },
                { label: 'Подготовка', value: prepHours, color: '#f97316' },
                { label: 'Остывание', value: coolingHours, color: '#38bdf8' },
                { label: 'Простой', value: downtimeIdleHours, color: '#94a3b8' }
            ];
            const timeTrack = buildTimeTrack(timeSegments);

            const statusOrders = Array.isArray(appData.calcHistory)
                ? appData.calcHistory.filter(order => {
                    if (!rangeFrom || !rangeTo) return true;
                    const ts = getOrderTimestamp(order);
                    return ts >= rangeFrom.getTime() && ts < rangeTo.getTime();
                })
                : [];
            const statusCounts = {
                new: 0,
                inprogress: 0,
                done: 0,
                paid: 0,
                canceled: 0
            };
            statusOrders.forEach(order => {
                let status = order.orderStatus || 'new';
                if (status === 'cancelled') status = 'canceled';
                if (statusCounts[status] !== undefined) {
                    statusCounts[status] += 1;
                }
            });
            const statusItems = [
                { key: 'new', label: 'Новые', color: '#93c5fd', value: statusCounts.new },
                { key: 'inprogress', label: 'В работе', color: '#2563eb', value: statusCounts.inprogress },
                { key: 'done', label: 'Готово', color: '#10b981', value: statusCounts.done },
                { key: 'paid', label: 'Оплачено', color: '#22c55e', value: statusCounts.paid },
                { key: 'canceled', label: 'Отменено', color: '#ef4444', value: statusCounts.canceled }
            ];
            const statusBars = buildStatusBars(statusItems.filter(item => item.value > 0));

            const activeAdditional = Object.values(additionalStats).filter(stat =>
                stat.baseCost <= 0 || stat.distributed < stat.baseCost
            );
            const additionalRows = activeAdditional.map(stat => {
                const progress = stat.baseCost > 0 ? Math.min(100, (stat.distributed / stat.baseCost) * 100) : 0;
                const paidOff = stat.baseCost > 0 && stat.distributed >= stat.baseCost;
                return `
      <tr>
        <td>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${stat.name}</strong>
              <div class="text-muted small">База: ${formatCurrency(stat.baseCost)}</div>
            </div>
            <span class="${paidOff ? 'text-success' : 'text-warning'}">${paidOff ? 'Окупился' : 'В работе'}</span>
          </div>
          <div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar ${paidOff ? 'bg-success' : 'bg-warning'}" style="width: ${Math.min(100, Math.max(0, progress))}%"></div>
          </div>
          <div class="summary-mini-label">Заполнение: ${formatNumber(progress, 1)}%</div>
        </td>
        <td class="text-end">${formatCurrency(stat.distributed)}</td>
        <td class="text-end">${formatCurrency(Math.max(0, stat.baseCost - stat.distributed))}</td>
        <td class="text-end">${stat.orders || 0}</td>
      </tr>`;
            }).join('') || `<tr><td colspan="4" class="text-center text-muted py-4">Нет активных накладных расходов</td></tr>`;

            const topMaterials = Object.values(materialStats)
                .sort((a, b) => (b.totalGrams || 0) - (a.totalGrams || 0))
                .slice(0, 5);
            const materialsTopHtml = topMaterials.map(m => {
                const share = kpis.totalGrams > 0 ? (m.totalGrams / kpis.totalGrams) * 100 : 0;
                return `
      <div class="calc-result-info">
        <span>${m.name}</span>
        <strong>${formatNumber(m.totalGrams / 1000, 2)} кг</strong>
        <small>Себест.: ${formatCurrency(m.totalCost || 0)} · Доля: ${formatNumber(share, 1)}%</small>
        <div class="progress mt-2" style="height:4px;">
          <div class="progress-bar bg-info" style="width:${Math.min(100, Math.max(0, share))}%"></div>
        </div>
      </div>
    `;
            }).join('') || `<div class="calc-empty-placeholder text-muted small">Нет данных по материалам.</div>`;

            const topPrinters = Object.values(printerStats)
                .sort((a, b) => (b.revenue || 0) - (a.revenue || 0))
                .slice(0, 5);
            const printersTopHtml = topPrinters.map(p => {
                const expenses = p.amortization + p.energy + p.material + p.maintenance;
                const profit = (p.revenue || 0) - expenses;
                const share = totalPrinterRevenue > 0 ? (p.revenue / totalPrinterRevenue) * 100 : 0;
                return `
      <div class="calc-result-info">
        <span>${p.name}</span>
        <strong>${formatCurrency(p.revenue || 0)}</strong>
        <small>Прибыль: ${formatCurrency(profit)} · Часы: ${formatNumber(p.hours, 1)} · Модели: ${p.prints}</small>
        <div class="progress mt-2" style="height:4px;">
          <div class="progress-bar bg-primary" style="width:${Math.min(100, Math.max(0, share))}%"></div>
        </div>
      </div>
    `;
            }).join('') || `<div class="calc-empty-placeholder text-muted small">Нет данных по принтерам.</div>`;

            const topClients = Object.values(clientStats)
                .sort((a, b) => (b.revenue || 0) - (a.revenue || 0))
                .slice(0, 5);
            const clientsTopHtml = topClients.map(c => {
                const profit = (c.revenue || 0) - (c.cost || 0);
                const share = totalClientRevenue > 0 ? (c.revenue / totalClientRevenue) * 100 : 0;
                return `
      <div class="calc-result-info">
        <span>${c.name}</span>
        <strong>${formatCurrency(c.revenue)}</strong>
        <small>Прибыль: ${formatCurrency(profit)} · Заказы: ${c.orders}</small>
        <div class="progress mt-2" style="height:4px;">
          <div class="progress-bar bg-success" style="width:${Math.min(100, Math.max(0, share))}%"></div>
        </div>
      </div>
    `;
            }).join('') || `<div class="calc-empty-placeholder text-muted small">Нет данных по клиентам.</div>`;

            const topAdditional = Object.values(additionalStats)
                .sort((a, b) => (b.distributed || 0) - (a.distributed || 0))
                .slice(0, 5);
            const additionalTopHtml = topAdditional.map(stat => {
                const progress = stat.baseCost > 0 ? Math.min(100, (stat.distributed / stat.baseCost) * 100) : 0;
                return `
      <div class="calc-result-info">
        <span>${stat.name}</span>
        <strong>${formatCurrency(stat.distributed)}</strong>
        <small>Остаток: ${formatCurrency(Math.max(0, stat.baseCost - stat.distributed))} · База: ${formatCurrency(stat.baseCost)}</small>
        <div class="progress mt-2" style="height:4px;">
          <div class="progress-bar bg-warning" style="width:${Math.min(100, Math.max(0, progress))}%"></div>
        </div>
      </div>
    `;
            }).join('') || `<div class="calc-empty-placeholder text-muted small">Нет накладных расходов.</div>`;

            const kpiCardItems = [
                {title: 'Окупаемость', value: paybackAbs, desc: 'Прибыль минус капвложения', format: formatCurrency, valueClass: paybackAbs >= 0 ? 'text-success' : 'text-danger'},
                {title: 'Прибыль/час', value: profitPerHour, unit: ' ₽/ч', desc: 'Чистая прибыль на час', decimals: 0},
                {title: 'Себестоимость на кг', value: costPerKg, unit: ' ₽/кг', desc: 'Все расходы / масса', decimals: 0},
                {title: 'Цена клиента', value: avgClientPricePerGram, unit: ' ₽/г', desc: 'Средняя цена за грамм', decimals: 2},
                {title: 'Средний расход', value: avgMaterialPerOrder / 1000, unit: ' кг', desc: 'Материал / заказ', decimals: 2},
                {title: 'Среднее время печати', value: avgPrintHoursPerOrder, unit: ' ч', desc: 'Часов печати / заказ', decimals: 1},
                {title: 'Средняя партия', value: avgModelsPerOrder, unit: ' моделей', desc: 'Моделей в заказе', decimals: 1},
            ];
            const formatCardValue = (card) => {
                if (typeof card.format === 'function') {
                    return card.format(card.value);
                }
                const decimals = Object.prototype.hasOwnProperty.call(card, 'decimals') ? card.decimals : 1;
                const unit = card.unit || '';
                return `${formatNumber(card.value, decimals)}${unit}`;
            };
            const kpiCards = kpiCardItems.map(card => `
      <div class="calc-result-info">
        <span>${card.title}</span>
        <strong class="${card.valueClass || ''}">${formatCardValue(card)}</strong>
        <small>${card.desc}</small>
      </div>
    `).join('');

            return `
    <div class="calc-layout summary-layout">
      <div class="calc-main">
        <div class="calc-card">
          <div class="calc-section-title"><i class="bi bi-bar-chart-line me-2"></i>Ключевые показатели</div>
          <div class="calc-result-info-grid summary-kpi-grid">
            ${kpiCards}
          </div>
        </div>

        <div class="calc-card">
          <div class="calc-section-title"><i class="bi bi-pie-chart me-2"></i>Диаграммы и тренды</div>
          <div class="summary-charts-grid">
            <div class="summary-chart-card">
              <div class="summary-chart-title">Структура затрат</div>
              <div class="d-flex flex-column align-items-center gap-2">
                ${costDonut}
                ${costLegend}
              </div>
            </div>
            <div class="summary-chart-card">
              <div class="summary-chart-title">Материалы по расходу</div>
              <div class="d-flex flex-column align-items-center gap-2">
                ${materialDonut}
                ${materialLegend}
              </div>
            </div>
            <div class="summary-chart-card">
              <div class="summary-chart-title">Выручка по периоду</div>
              ${revenueSparkline}
              <div class="d-flex justify-content-between small text-muted mt-2">
                <span>Итого: ${formatCurrency(revenueSum)}</span>
                <span>Точек: ${revenueSeries.length}</span>
              </div>
            </div>
            <div class="summary-chart-card">
              <div class="summary-chart-title">Время производства</div>
              ${timeTrack}
              <div class="small text-muted mt-2">Всего: ${formatNumber(totalPrintHours + downtimeHours + prepHours, 1)} ч</div>
            </div>
            <div class="summary-chart-card">
              <div class="summary-chart-title">Статусы заказов</div>
              ${statusBars}
              <div class="small text-muted mt-2">Всего: ${statusOrders.length}</div>
            </div>
          </div>
        </div>

          <div class="row g-3">
          <div class="col-12">
            <div class="calc-card">
              <div class="calc-section-title"><i class="bi bi-printer me-2"></i>Топ принтеров</div>
              <div class="calc-result-info-grid summary-list-grid">
                ${printersTopHtml}
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="calc-card">
              <div class="calc-section-title"><i class="bi bi-people me-2"></i>Топ клиентов</div>
              <div class="calc-result-info-grid summary-list-grid">
                ${clientsTopHtml}
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-lg-6">
            <div class="calc-card">
              <div class="calc-section-title"><i class="bi bi-boxes me-2"></i>Топ материалов</div>
              <div class="calc-result-info-grid summary-list-grid">
                ${materialsTopHtml}
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="calc-card">
              <div class="calc-section-title"><i class="bi bi-diagram-2"></i>Накладные расходы</div>
              <div class="calc-result-info-grid summary-list-grid">
                ${additionalTopHtml}
              </div>
            </div>
          </div>
        </div>

        <div class="calc-card">
          <div class="calc-section-title"><i class="bi bi-list-check me-2"></i>Подробные таблицы</div>
          <div class="accordion" id="summaryDetailsAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header" id="summaryPrintersHeading">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#summaryPrintersCollapse" aria-expanded="false" aria-controls="summaryPrintersCollapse">
                    Все принтеры
                  </button>
                </h2>
                <div id="summaryPrintersCollapse" class="accordion-collapse collapse" data-bs-parent="#summaryDetailsAccordion">
                  <div class="accordion-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover table-striped table-sm mb-0">
                        <thead class="">
                          <tr>
                            <th>Принтер</th>
                            <th class="text-end">Время</th>
                            <th class="text-end">Подготовка</th>
                            <th class="text-end">Выручка</th>
                            <th class="text-end">Расходы</th>
                            <th class="text-end">Кол-во моделей</th>
                          </tr>
                        </thead>
                        <tbody>${printerRows}</tbody>
                        <tfoot class="">
                          <tr>
                            <th>Итого</th>
                            <th class="text-end">${formatNumber(ordersAnalysis.totalPrintHours, 1)} ч</th>
                            <th class="text-end">${formatNumber((ordersAnalysis.totalPrepMinutes || 0) / 60, 2)} ч</th>
                            <th class="text-end">${formatCurrency(totalPrinterRevenue)}</th>
                            <th class="text-end">${formatCurrency(totalPrinterExpenses)}</th>
                            <th class="text-end">${totalPrinterPrints}</th>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="summaryClientsHeading">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#summaryClientsCollapse" aria-expanded="false" aria-controls="summaryClientsCollapse">
                    Все клиенты
                  </button>
                </h2>
                <div id="summaryClientsCollapse" class="accordion-collapse collapse" data-bs-parent="#summaryDetailsAccordion">
                  <div class="accordion-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover table-striped table-sm mb-0">
                        <thead class="">
                          <tr>
                            <th>Клиент</th>
                            <th class="text-end">Выручка</th>
                            <th class="text-end">Расходы</th>
                            <th class="text-end">Прибыль</th>
                            <th class="text-end">Заказы</th>
                          </tr>
                        </thead>
                        <tbody>${clientRows}</tbody>
                        <tfoot class="">
                          <tr>
                            <th>Итого</th>
                            <th class="text-end">${formatCurrency(totalClientRevenue)}</th>
                            <th class="text-end">${formatCurrency(totalClientCost)}</th>
                            <th class="text-end">${formatCurrency(totalClientProfit)}</th>
                            <th class="text-end">${totalClientOrders}</th>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="summaryMaterialsHeading">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#summaryMaterialsCollapse" aria-expanded="false" aria-controls="summaryMaterialsCollapse">
                    Все материалы
                  </button>
                </h2>
                <div id="summaryMaterialsCollapse" class="accordion-collapse collapse" data-bs-parent="#summaryDetailsAccordion">
                  <div class="accordion-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover table-striped table-sm mb-0">
                        <thead class="">
                          <tr>
                            <th>Материал</th>
                            <th class="text-end">Себестоимость</th>
                            <th class="text-end">Выручка</th>
                            <th class="text-end">Ср. цена (₽/г)</th>
                          </tr>
                        </thead>
                        <tbody>${materialRows}</tbody>
                        <tfoot class="">
                          <tr>
                            <th>Итого: ${materialKgTotal} кг</th>
                            <th class="text-end">${formatCurrency(kpis.totalMaterialCost)}</th>
                            <th class="text-end">${formatCurrency(totalMaterialRevenue)}</th>
                            <th class="text-end">${formatNumber(avgClientPricePerGram, 2)} ₽/г</th>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="summaryAdditionalHeading">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#summaryAdditionalCollapse" aria-expanded="false" aria-controls="summaryAdditionalCollapse">
                    Все накладные расходы
                  </button>
                </h2>
                <div id="summaryAdditionalCollapse" class="accordion-collapse collapse" data-bs-parent="#summaryDetailsAccordion">
                  <div class="accordion-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover table-striped table-sm mb-0">
                        <thead>
                          <tr>
                            <th>Статья</th>
                            <th class="text-end">Распределено</th>
                            <th class="text-end">Остаток</th>
                            <th class="text-end">Заказы</th>
                          </tr>
                        </thead>
                        <tbody>${additionalRows}</tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </div>
      </div>
      <aside class="calc-sidebar">
        <div class="calc-summary-card">
          <div class="text-uppercase small opacity-75 mb-2">Выручка</div>
          <h2>${formatCurrency(totalRevenue)}</h2>
          <div class="calc-summary-meta">
            <div>
              <span>Чистая прибыль</span>
              <strong class="${netProfit >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(netProfit)}</strong>
            </div>
            <div>
              <span>Маржа</span>
              <strong>${formatCurrency(grossProfit)}</strong>
              <small>${formatNumber(grossMargin, 1)}%</small>
            </div>
          </div>
          <div class="mt-3 small text-muted">Заказов: ${completedOrdersCount} · Средний чек: ${formatCurrency(avgOrderRevenue)}</div>
        </div>

        <div class="calc-sidebar-card">
          <div class="calc-section-title mb-2">Капвложения</div>
          <div class="calc-result-info-grid compact">
            <div class="calc-result-info">
              <span>Принтеры</span>
              <strong>${formatCurrency(capital.printersCost)}</strong>
              <small>${appData.printers.length} шт</small>
            </div>
            <div class="calc-result-info">
              <span>Материалы</span>
              <strong>${formatCurrency(capital.materialsCost)}</strong>
              <small>${formatNumber(capital.materialsWeight, 2)} кг</small>
            </div>
            <div class="calc-result-info">
              <span>Накладные</span>
              <strong>${formatCurrency(capital.additionalCost)}</strong>
              <small>Вложений</small>
            </div>
          </div>
        </div>

        <div class="calc-sidebar-card">
          <div class="calc-section-title mb-2">Качество</div>
          <div class="calc-result-info-grid compact">
            <div class="calc-result-info">
              <span>Выход годных</span>
              <strong>${formatNumber(yieldRate, 1)}%</strong>
              <small>Без брака</small>
            </div>
            <div class="calc-result-info">
              <span>Брак (кг)</span>
              <strong>${formatNumber(totalRejectGrams / 1000, 3)} кг</strong>
              <small>Масса брака</small>
            </div>
            <div class="calc-result-info">
              <span>Брак (ч)</span>
              <strong>${formatNumber(totalRejectHours, 2)} ч</strong>
              <small>Время брака</small>
            </div>
          </div>
        </div>
      </aside>
    </div>`;
        };

        // Выполнение расчетов
        const capital = calculateCapitalInvestments();
        const ordersAnalysis = analyzeCompletedOrders(from, to);
        const kpis = calculateKPIs(capital, ordersAnalysis);

        // Рендеринг результата
        const summaryContent = document.getElementById("summaryContent");
        summaryContent.innerHTML = generateHTML(capital, ordersAnalysis, kpis, { periodDays, from, to });
        initSummaryChartTooltips(summaryContent);
    }

    function parseIncomingLinkParams(params){
        const prName = params.get('printer');
        if(!prName) return;
        const statuses = params.getAll('model_status[]');
        const names = params.getAll('model_name[]');
        const ids = params.getAll('model_id[]');
        const thumbs = params.getAll('model_thumbnail[]');
        const times = params.getAll('model_time[]');
        const weights = params.getAll('model_weight[]');
        const mats = params.getAll('model_filament[]');
        const models = [];
        for(let i=0;i<names.length;i++){
            models.push({
                id: ids[i] || getNextId('models'),
                name: names[i] || '',
                thumbnail: thumbs[i] || '',
                status: statuses[i] || 'new',
                timeStr: times[i] || '',
                weight: weights[i] || '',
                matName: mats[i] || ''
            });
        }
        incomingLinkData = {printerKey: prName, models};
        showIncomingDataModal();
    }

    async function resolvePrinterForLink(key){
        const safeKey = (key || 'Unknown').trim();
        const printers = Array.isArray(appData.printers) ? appData.printers : [];

        const list = printers.filter(p=>{
            if(p.name===safeKey) return true;
            return (p.profileIds||[]).some(pid=>{
                const pf=appData.printerProfiles.find(x=>String(x.id)===String(pid));
                return pf && pf.config && pf.config.printer_settings_id===safeKey;
            });
        });

        if(list.length===1) return list[0];

        const rememberedId = PromptMemory.getPrinter(safeKey);
        if(rememberedId){
            const remembered = printers.find(p=>String(p.id)===String(rememberedId));
            if(remembered) return remembered;
            PromptMemory.forgetPrinter(safeKey);
        }

        if(list.length===0 && printers.length===1) return printers[0];

        const candidates = (list.length>0 ? list : printers);
        if(candidates.length<=0) return null;

        const options=candidates.map(p=>({value:String(p.id),label:p.name}));
        const res=await showMultiPrompt('Принтер для профиля '+safeKey,[
            {id:'pid',label:'Принтер',type:'select',options,value:options[0]?.value||''},
            {id:'remember',label:`Сохранить выбор для профиля «${safeKey}»`,type:'checkbox',value:false,help:'Сохранение работает только для этого браузера/компьютера (LocalStorage).'}
        ]);

        if(res && res.pid){
            if(res.remember) PromptMemory.setPrinter(safeKey, res.pid);
            return printers.find(p=>String(p.id)===String(res.pid)) || null;
        }
        return null;
    }

    function showIncomingDataModal(){
        const sel = document.getElementById('targetOrderSelect');
        sel.innerHTML = '<option value="new">Создать новый расчёт</option>';
        appData.calcHistory.forEach(h=>{
            const opt = document.createElement('option');
            opt.value = h.timestamp;
            opt.textContent = h.calcName || h.dateStr;
            sel.appendChild(opt);
        });
        const modal = new bootstrap.Modal(document.getElementById('incomingDataModal'));
        document.getElementById('importLinkApplyBtn').onclick = applyIncomingData;
        modal.show();
    }

    async function applyIncomingData(){
        const sel = document.getElementById('targetOrderSelect');
        const val = sel ? sel.value : 'new';

        const modalEl = document.getElementById('incomingDataModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || bootstrap.Modal.getOrCreateInstance(modalEl);

        modal.hide();
        await __waitModalHidden(modalEl);

        if(val !== 'new'){
            onEditCalcHistory(parseInt(val,10));
        } else {
            startNewCalculation();
        }

        await new Promise(r=>setTimeout(r,0));

        if(incomingLinkData){
            const pr = await resolvePrinterForLink(incomingLinkData.printerKey);
            if(!pr){
                alert('Не найден принтер '+incomingLinkData.printerKey);
            } else {
                for(const m of incomingLinkData.models){
                    const mid = await resolveMaterialIdByProfile(m.matName);
                    addModelRow(pr.id, {
                        id: m.id,
                        name: m.name,
                        thumbnail: m.thumbnail,
                        status: m.status,
                        hours: parseTimeFromLink(m.timeStr),
                        weight: parseFloat(m.weight)||0,
                        materialId: mid
                    });
                }
            }
        }
        const tabEl = document.querySelector('#calculate-tab');
        const tab = new bootstrap.Tab(tabEl);
        tab.show();
        incomingLinkData = null;

    }

</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    const SUPABASE_URL = "https://kvvxfytrlgihewmsvwkj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2dnhmeXRybGdpaGV3bXN2d2tqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5NDExMzIsImV4cCI6MjA2MTUxNzEzMn0.bvXmrh3XZivLVyg4irGo82pLAhlrSapzmxcDKLEAjLo";

    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // ✅ исправлено

    let syncId = localStorage.getItem("sync_id") || crypto.randomUUID();
    let encryptionKey = localStorage.getItem("encryption_key") || crypto.randomUUID() + crypto.randomUUID();
    localStorage.setItem("sync_id", syncId);
    localStorage.setItem("encryption_key", encryptionKey);

    async function encryptData(data, key) {
        const text = JSON.stringify(data);
        const enc = new TextEncoder().encode(text);
        const cryptoKey = await crypto.subtle.importKey("raw", new TextEncoder().encode(key.slice(0, 32)), "AES-GCM", false, ["encrypt"]);
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const cipher = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, cryptoKey, enc);
        return btoa(JSON.stringify({ iv: Array.from(iv), data: Array.from(new Uint8Array(cipher)) }));
    }

    async function decryptData(encrypted, key) {
        const parsed = JSON.parse(atob(encrypted));
        const iv = new Uint8Array(parsed.iv);
        const data = new Uint8Array(parsed.data);
        const cryptoKey = await crypto.subtle.importKey("raw", new TextEncoder().encode(key.slice(0, 32)), "AES-GCM", false, ["decrypt"]);
        const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, cryptoKey, data);
        return JSON.parse(new TextDecoder().decode(decrypted));
    }

    async function saveSettingsToCloud() {
        const encrypted = await encryptData(appData, encryptionKey);
        const { error } = await _supabase
            .from('user_settings')
            .upsert({
                sync_id: syncId,
                encrypted_data: encrypted,
                updated_at: new Date().toISOString()
            }, { onConflict: 'sync_id' });

        if (error) alert("Ошибка сохранения: " + error.message);
        else alert("✅ Данные сохранены в облако.");
    }

    async function loadSettingsFromCloud() {
        const { data, error } = await _supabase
            .from('user_settings')
            .select('*')
            .eq('sync_id', syncId)
            .single();

        if (error || !data) {
            alert("Ошибка загрузки: " + error?.message);
            return;
        }

        // Проверка времени
        const createdAt = new Date(data.created_at);
        const now = new Date();
        if ((now - createdAt) > 5 * 60 * 1000) { // 5 минут
            alert("Данные устарели и были удалены");
            await _supabase.from('user_settings').delete().eq('sync_id', syncId);
            return;
        }

        try {
            const decrypted = await decryptData(data.encrypted_data, encryptionKey);
            setAppData(decrypted);
            saveToLocalStorage();
            initAll();
            alert("✅ Настройки загружены.");
        } catch (e) {
            alert("Ошибка расшифровки.");
        }
    }

    function generateSyncLinkAndQR() {
        const url = new URL(window.location.href);
        url.searchParams.set("sync_id", syncId);
        url.searchParams.set("key", encryptionKey);
        const link = url.toString();
        document.getElementById("syncLinkDisplay").value = link;
        const qrcodeDiv = document.getElementById("qrcode");
        qrcodeDiv.innerHTML = "";
        new QRCode(qrcodeDiv, {
            text: link,
            width: 256,
            height: 256,
            colorDark: "#000000",
            colorLight: "#ffffff"
        });
    }

    document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const incomingId = params.get("sync_id");
        const incomingKey = params.get("key");

        if (incomingId && incomingKey) {
            localStorage.setItem("sync_id", incomingId);
            localStorage.setItem("encryption_key", incomingKey);
            syncId = incomingId;
            encryptionKey = incomingKey;
            await loadSettingsFromCloud();
        }
        document.getElementById('delOrcaProfileBtn').onclick = ()=>deleteOrcaProfile();
        document.getElementById('orcaProfileSelect').addEventListener('change',e=>{
            const pr=appData.printers.find(p=>String(p.id)===String(currentOrcaPrinterId));
            if(pr) loadOrcaProfile(pr,parseInt(e.target.value,10));
        });
        document.getElementById('saveMaterialBtn').onclick = saveMaterialFromModal;
        document.getElementById('savePrinterBtn').onclick = savePrinterFromModal;
        const jsonBtn = document.getElementById('downloadJsonFileBtn');
        if (jsonBtn) jsonBtn.addEventListener('click', downloadJsonFile);
        const summaryBtn = document.getElementById('downloadSummaryCardBtn');
        if (summaryBtn) summaryBtn.addEventListener('click', downloadSummaryCardHtml);
        const myNalogBtn = document.getElementById('sendMyNalogBtn');
        if (myNalogBtn) myNalogBtn.addEventListener('click', sendMyNalogReceipt);
        const myNalogBillBtn = document.getElementById('sendMyNalogBillBtn');
        if (myNalogBillBtn) myNalogBillBtn.addEventListener('click', sendMyNalogBill);
        const myNalogCancelBtn = document.getElementById('cancelMyNalogBtn');
        if (myNalogCancelBtn) myNalogCancelBtn.addEventListener('click', cancelMyNalogReceipt);
        const phoneInput = document.getElementById('myNalogPhone');
        if (phoneInput) {
            phoneInput.addEventListener('change', e => {
                localStorage.setItem('my_nalog_phone', e.target.value.trim());
            });
        }
        const workdayModal = document.getElementById('workdayTemplateModal');
        if (workdayModal) {
            workdayModal.addEventListener('show.bs.modal', () => {
                presetWorkdayTemplateModal();
                updateLunchStartByOffset();
            });
        }
        const templateSelect = document.getElementById('workdayTemplateSelect');
        if (templateSelect) {
            templateSelect.addEventListener('change', () => {
                const option = templateSelect.options[templateSelect.selectedIndex];
                const hours = parseFloat(option.dataset.hours);
                if (!Number.isNaN(hours)) {
                    document.getElementById('workdayTotalHours').value = hours;
                }
                const lunch = parseInt(option.dataset.lunch, 10);
                const skipLunch = document.getElementById('workdaySkipLunch');
                if (!Number.isNaN(lunch) && lunch > 0) {
                    document.getElementById('workdayLunchDuration').value = lunch;
                    if (skipLunch) skipLunch.checked = false;
                }
                const offset = parseInt(option.dataset.offset, 10);
                if (!Number.isNaN(offset)) {
                    workdayLunchOffsetMinutes = offset;
                    lunchStartManual = false;
                    updateLunchStartByOffset();
                }
            });
        }
        const startTimeInput = document.getElementById('workdayStartTime');
        if (startTimeInput) {
            startTimeInput.addEventListener('change', () => {
                lunchStartManual = false;
                updateLunchStartByOffset();
            });
        }
        const lunchStartInput = document.getElementById('workdayLunchStart');
        if (lunchStartInput) {
            lunchStartInput.addEventListener('input', () => {
                lunchStartManual = true;
            });
        }
        const skipLunchCheckbox = document.getElementById('workdaySkipLunch');
        if (skipLunchCheckbox) {
            skipLunchCheckbox.addEventListener('change', e => {
                const disabled = e.target.checked;
                document.getElementById('workdayLunchStart').disabled = disabled;
                document.getElementById('workdayLunchDuration').disabled = disabled;
                if (disabled) {
                    lunchStartManual = true;
                } else {
                    lunchStartManual = false;
                    updateLunchStartByOffset();
                }
            });
        }
        const addBreakBtn = document.getElementById('addSpecialBreakBtn');
        if (addBreakBtn) {
            addBreakBtn.addEventListener('click', () => addSpecialBreakRow());
        }
        const addPresetBreaksBtn = document.getElementById('addPresetBreaksBtn');
        if (addPresetBreaksBtn) {
            addPresetBreaksBtn.addEventListener('click', () => {
                const startVal = document.getElementById('workdayStartTime').value;
                const startMin = timeStringToMinutes(startVal || '');
                if (!Number.isNaN(startMin)) {
                    addSpecialBreakRow(minutesToTimeString(startMin + 120), 10);
                    addSpecialBreakRow(minutesToTimeString(startMin + 360), 10);
                } else {
                    addSpecialBreakRow('', 10);
                    addSpecialBreakRow('', 10);
                }
            });
        }
        const breaksContainer = document.getElementById('specialBreaksContainer');
        if (breaksContainer) {
            breaksContainer.addEventListener('click', event => {
                const removeBtn = event.target.closest('.remove-break-row');
                if (removeBtn) {
                    event.preventDefault();
                    const row = removeBtn.closest('.special-break-row');
                    if (row) row.remove();
                }
            });
        }
        const applyTemplateBtn = document.getElementById('applyWorkdayTemplateBtn');
        if (applyTemplateBtn) {
            applyTemplateBtn.addEventListener('click', applyWorkdayTemplateFromModal);
        }
        const urgencySelectEl = document.getElementById('urgencyProfileSelect');
        if (urgencySelectEl) {
            urgencySelectEl.addEventListener('change', () => {
                captureScheduleFromInputs(currentUrgencyProfileId);
                currentUrgencyProfileId = urgencySelectEl.value;
                renderCurrentUrgencyMeta();
                renderOperatorScheduleInputsForProfile(currentUrgencyProfileId);
            });
        }
        const urgencyNameInput = document.getElementById('urgencyProfileName');
        if (urgencyNameInput) {
            urgencyNameInput.addEventListener('input', e => {
                const profile = getEditingProfileById(currentUrgencyProfileId);
                if (!profile) return;
                profile.title = e.target.value;
                refreshUrgencyProfileSelectLabels();
            });
        }
        const urgencyMarkupInput = document.getElementById('urgencyProfileMarkup');
        if (urgencyMarkupInput) {
            urgencyMarkupInput.addEventListener('input', e => {
                const profile = getEditingProfileById(currentUrgencyProfileId);
                if (!profile) return;
                profile.markupPercent = parseFloat(e.target.value) || 0;
                refreshUrgencyProfileSelectLabels();
            });
        }
        const urgencyDescInput = document.getElementById('urgencyProfileDescription');
        if (urgencyDescInput) {
            urgencyDescInput.addEventListener('input', e => {
                const profile = getEditingProfileById(currentUrgencyProfileId);
                if (!profile) return;
                profile.description = e.target.value;
            });
        }
        const addUrgencyBtn = document.getElementById('addUrgencyProfileBtn');
        if (addUrgencyBtn) addUrgencyBtn.addEventListener('click', addUrgencyProfile);
        const deleteUrgencyBtn = document.getElementById('deleteUrgencyProfileBtn');
        if (deleteUrgencyBtn) deleteUrgencyBtn.addEventListener('click', deleteCurrentUrgencyProfile);
        [
            {id: 'settingsIncludeAmortization', key: 'includeAmortization'},
            {id: 'settingsIncludeRejects', key: 'includeRejects'},
            {id: 'settingsIncludeOverheads', key: 'includeOverheads'},
            {id: 'settingsIgnoreCoolingRejects', key: 'ignoreCoolingRejects'}
        ].forEach(({id, key}) => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', () => {
                    if(!appData.calcSettings) appData.calcSettings = {};
                    appData.calcSettings[key] = el.checked;
                    saveToLocalStorage();
                });
            }
        });
        const requestSmsBtn = document.getElementById('requestSmsBtn');
        if (requestSmsBtn) requestSmsBtn.addEventListener('click', requestMyNalogSms);
        const confirmSmsBtn = document.getElementById('confirmSmsBtn');
        if (confirmSmsBtn) confirmSmsBtn.addEventListener('click', confirmMyNalogSms);
        const importFileInput = document.getElementById('importJsonFile');
        if (importFileInput) importFileInput.addEventListener('change', importFromFile);
        const applyLinkBtn=document.getElementById("applyMaterialProfileLinkBtn");
        if(applyLinkBtn) applyLinkBtn.onclick = applyMaterialProfileLink;
        const manageProfilesBtn=document.getElementById("manageMaterialProfilesBtn");
        if(manageProfilesBtn) manageProfilesBtn.onclick = openMaterialProfilesManager;
        const managePrProfilesBtn=document.getElementById("managePrinterProfilesBtn");
        if(managePrProfilesBtn) managePrProfilesBtn.onclick = openPrinterProfilesManager;
        loadMyNalogSettings();

        parseIncomingLinkParams(params);
        if(params.toString()){
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        setupGcodeDrop();
        attachExternalImportBridge();
        initPromptMemoryUi();
    });

    document.addEventListener('DOMContentLoaded', () => {
        const backupBtn = document.getElementById('schemaMigrationBackupBtn');
        const startBtn = document.getElementById('schemaMigrationStartBtn');
        if (backupBtn) backupBtn.addEventListener('click', handleSchemaMigrationBackup);
        if (startBtn) startBtn.addEventListener('click', handleSchemaMigrationStart);
        updateSchemaMigrationUi();
    });


    const SPOOLMAN_CONFIG_KEY = "spoolman_config";

    function getSpoolmanConfig() {
        const configStr = localStorage.getItem(SPOOLMAN_CONFIG_KEY);
        if (!configStr) return { enabled: false, url: '', autoSync: false, lastSync: null };
        try {
            return JSON.parse(configStr);
        } catch (e) {
            console.error("Ошибка парсинга настроек Spoolman из localStorage:", e);
            return { enabled: false, url: '', autoSync: false, lastSync: null };
        }
    }

    function saveSpoolmanConfig(config) {
        localStorage.setItem(SPOOLMAN_CONFIG_KEY, JSON.stringify(config));
        // Немедленно обновляем UI после сохранения
        populateSpoolmanUIFromConfig();
    }

    // Функция для обновления элементов UI из конфигурации
    function populateSpoolmanUIFromConfig() {
        const cfg = getSpoolmanConfig();
        const cbEnabled = document.getElementById("spoolmanEnabledCheckbox");
        const inpUrl = document.getElementById("spoolmanUrlInput");
        const cbAuto = document.getElementById("spoolmanAutoSyncCheckbox");
        const lastSync = document.getElementById("spoolmanLastSync");

        if (cbEnabled) cbEnabled.checked = !!cfg.enabled;
        if (inpUrl) inpUrl.value = cfg.url || "";
        if (cbAuto) cbAuto.checked = !!cfg.autoSync;
        if (lastSync) {
            lastSync.textContent = cfg.lastSync
                ? new Date(cfg.lastSync).toLocaleString()
                : "Никогда";
        }
    }

    async function spoolmanApiRequest(endpoint, method = 'GET', body = null) {
        const config = getSpoolmanConfig();
        if (!config.enabled || !config.url) {
            throw new Error('Spoolman is not configured');
        }

        const baseUrl = config.url.endsWith('/') ? config.url.slice(0, -1) : config.url;
        const url = `${baseUrl}/api/v1/${endpoint}`;

        const options = {
            method,
            headers: { 'Content-Type': 'application/json' }
        };

        if (body) {
            options.body = JSON.stringify(body);
        }

        try {
            console.log(`Sending ${method} request to ${url}`, body || '');
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API error response:`, errorText);
                throw new Error(`API error (${response.status}): ${errorText}`);
            }

            if (response.status === 204) return null;

            const responseData = await response.json();
            console.log(`Response from ${endpoint}:`, responseData);
            return responseData;
        } catch (error) {
            console.error('Spoolman API error:', error);
            throw error;
        }
    }

    async function fetchSpoolmanFilaments() {
        return await spoolmanApiRequest('filament');
    }

    async function fetchSpoolmanSpools() {
        return await spoolmanApiRequest('spool');
    }

    function prepareExtraForSpoolman(extra) {
        const prepared = {};
        for (const [key, value] of Object.entries(extra)) {
            prepared[key] = JSON.stringify(value);
        }
        return prepared;
    }

    function mapSpoolmanToMaterial(spool, filament) {
        const parseOptionalWeight = (val) => {
            if (val === null || val === undefined || val === '') return null;
            const num = parseFloat(val);
            return Number.isFinite(num) ? num : null;
        };
        let extraFields = {};
        if (spool.extra) {
            for (const [key, value] of Object.entries(spool.extra)) {
                try {
                    if (typeof value === 'string') {

                        if (value.startsWith('"') && value.endsWith('"')) {
                            extraFields[key] = JSON.parse(value);
                        } else {

                            extraFields[key] = value;
                        }
                    } else {
                        extraFields[key] = value;
                    }
                } catch (e) {
                    console.log(`Error parsing extra field ${key}:`, e);
                    extraFields[key] = value;
                }
            }
        }

        return {
            id: getNextId('materials'),
            materialType: filament.material || '',
            name:  filament.vendor?.name+'- '+filament.name || spool.comment || `${filament.material || 'Unknown'} (${spool.id})`,
            costPerKg: spool.price || 0,
            balance: spool.remaining_weight ? spool.remaining_weight / 1000 : 0,
            declaredWeight: spool.initial_weight ? spool.initial_weight / 1000 :
                (filament.weight ? filament.weight / 1000 : 1),
            manufacturer: filament.vendor?.name ,
            productionDate: spool.lot_nr || '',
            printers: [],
            profileIds: [],
            color: filament.color_hex || '#ffffff',
            spoolmanId: filament.id,
            spoolmanSpoolId: spool.id,
            printerPrepMinutes: parseFloat(extraFields.printerPrepMinutes ?? extraFields.prepMinutes ?? 0) || 0,
            emptySpoolWeight: parseOptionalWeight(spool.empty_spool_weight),
            massInputMode: 'remaining',
            usedWeightGrams: parseOptionalWeight(spool.used_weight),
            remainingWeightGrams: parseOptionalWeight(spool.remaining_weight),
            measuredWeightGrams: parseOptionalWeight(spool.weight)
        };
    }

    async function importAllMaterialsFromSpoolman(statusCallback) {
        const config = getSpoolmanConfig();
        if (!config.enabled || !config.url) {
            return { success: false, message: 'Spoolman is not configured' };
        }

        try {
            statusCallback('Connecting to Spoolman...');
            await spoolmanApiRequest('info');

            statusCallback('Fetching data from Spoolman...');
            const filaments = await fetchSpoolmanFilaments();
            const spools = await fetchSpoolmanSpools();
            const filamentMap = {};
            filaments.forEach(filament => {
                filamentMap[filament.id] = filament;
            });

            const importedMaterials = [];
            const updatedMaterials = [];
            const errors = [];

            const activeSpools = spools.filter(spool => !spool.archived);

            statusCallback(`Processing ${activeSpools.length} spools...`);

            const existingBySpoolmanId = {};
            appData.materials.forEach(material => {
                if (material.spoolmanSpoolId) {
                    existingBySpoolmanId[material.spoolmanSpoolId] = material;
                }
            });

            for (const spool of activeSpools) {
                try {
                    if (!spool.filament) {
                        errors.push(`Spool ${spool.id} has no valid filament reference`);
                        continue;
                    }

                    const filament = filamentMap[spool.filament.id];
                    if (!filament) {
                        errors.push(`Spool ${spool.id} references unknown filament ID ${spool.filament.id}`);
                        continue;
                    }

                    const existingMaterial = existingBySpoolmanId[spool.id];

                    if (existingMaterial) {
                        const updatedData = mapSpoolmanToMaterial(spool, filament);

                        updatedData.id = existingMaterial.id;
                        updatedData.printers = existingMaterial.printers || [];
                        updatedData.profileIds = existingMaterial.profileIds || [];

                        Object.assign(existingMaterial, updatedData);
                        updatedMaterials.push(existingMaterial);
                    } else {
                        const material = mapSpoolmanToMaterial(spool, filament);
                        appData.materials.push(material);
                        importedMaterials.push(material);
                        existingBySpoolmanId[spool.id] = material;
                    }

                } catch (error) {
                    console.error(`Error importing spool ${spool.id}:`, error);
                    errors.push(`Spool ${spool.id}: ${error.message}`);
                }
            }

            saveToLocalStorage();
            renderGlobalMaterialsTable();

            config.lastSync = new Date().toISOString();
            saveSpoolmanConfig(config);

            const totalProcessed = importedMaterials.length + updatedMaterials.length;
            return {
                success: true,
                message: `Синхронизировано ${totalProcessed} катушек из Spoolman (${importedMaterials.length} новых, ${updatedMaterials.length} обновлено)`,
                materials: importedMaterials,
                updated: updatedMaterials,
                errors: errors.length ? errors : null
            };
        } catch (error) {
            console.error('Import error:', error);
            return { success: false, message: `Ошибка импорта: ${error.message}` };
        }
    }

    async function updateSpoolUsageInSpoolman(materialId, usedWeight) {
        const material = appData.materials.find(m => String(m.id) === String(materialId));
        if (!material || !material.spoolmanSpoolId) {
            console.log(`Material ${materialId} not linked to Spoolman, skipping usage update`);
            return;
        }

        try {
            console.log(`Updating Spoolman spool ${material.spoolmanSpoolId} with used weight: ${usedWeight}kg`);
            await spoolmanApiRequest(`spool/${material.spoolmanSpoolId}/use`, 'PUT', {
                use_weight: usedWeight * 1000
            });

            material.balance -= usedWeight;
            if (material.balance < 0) material.balance = 0;

            saveToLocalStorage();
            console.log(`Successfully updated usage for spool ${material.spoolmanSpoolId}`);
        } catch (error) {
            console.error('Failed to update spool usage in Spoolman:', error);
        }
    }

    async function testSpoolmanConnection(url) {
        try {
            const baseUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            const response = await fetch(`${baseUrl}/api/v1/info`);

            if (!response.ok) {
                throw new Error(`Server returned ${response.status}`);
            }

            const data = await response.json();
            return {
                success: true,
                version: data.version || 'Unknown',
                message: `Connected to Spoolman ${data.version || 'Unknown'}`
            };
        } catch (error) {
            return { success: false, message: `Connection failed: ${error.message}` };
        }
    }

    function hookMaterialUsage() {
        const originalCalculateAll = window.onCalculateAll;
        window.onCalculateAll = function() {
            const result = originalCalculateAll.apply(this, arguments);

            const config = getSpoolmanConfig();
            if (config.enabled && config.autoSync && lastCalcFullData) {
                const materialUsage = {};

                lastCalcFullData.detailsByPrinter.forEach(printer => {
                    printer.linesDetail.forEach(model => {
                        if (model.materialData && model.materialData.id) {
                            const materialId = model.materialData.id;
                            const usedWeight = (model.realWeight || 0) / 1000;

                            if (!materialUsage[materialId]) materialUsage[materialId] = 0;
                            materialUsage[materialId] += usedWeight;
                        }
                    });
                });

                Object.keys(materialUsage).forEach(materialId => {
                    updateSpoolUsageInSpoolman(materialId, materialUsage[materialId]);
                });
            }

            return result;
        };
    }

    function createSpoolmanSettingsUI() {
        const config = getSpoolmanConfig();

        return `
    <div class="mt-4">
    <h3>Интеграция со Spoolman</h3>
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i>
      При активации происходит импорт данных из Spoolman в калькулятор (в одну сторону).
    </div>

    <div class="alert alert-warning">
      <h5><i class="bi bi-exclamation-triangle-fill"></i> Важно: Обход CORS для локального Spoolman</h5>
      <p>Для работы с локально установленным Spoolman вам может потребоваться обойти ограничения CORS. Выполните следующие шаги:</p>
      <ol>
        <li>Установите расширение <a href="https://chromewebstore.google.com/detail/cors-unblock/lfhmikememgdcahcdlaciloancbhjino" target="_blank">CORS Unblock</a> для Chrome</li>
        <li>В настройках расширения включите <em>Access-Control-Request-Headers</em></li>
        <li>Включите опцию <em>Overwrite 4xx status codes with 200</em></li>
        <li>Нажмите «Start»</li>
      </ol>
      <p><strong>Примечание:</strong> Необходимо использовать именно это расширение, так как оно добавляет нужные заголовки для работы с API Spoolman.</p>
    </div>

    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="spoolmanEnabledCheckbox">
      <label class="form-check-label" for="spoolmanEnabledCheckbox">Включить интеграцию с Spoolman</label>
    </div>
    <div class="mb-3">
      <label for="spoolmanUrlInput" class="form-label">URL сервера Spoolman:</label>
      <div class="input-group">
        <input type="text" id="spoolmanUrlInput" class="form-control" placeholder="http://localhost:7912">
        <button class="btn btn-outline-secondary" type="button" id="testSpoolmanConnectionBtn">Проверить</button>
      </div>
      <div class="form-text">Примеры: http://localhost:7912 или https://127.0.0.1:7912</div>
    </div>
    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="spoolmanAutoSyncCheckbox">
      <label class="form-check-label" for="spoolmanAutoSyncCheckbox">Автоматически обновлять использование материалов</label>
    </div>
    <div class="mb-3">
      <p>Последняя синхронизация: <span id="spoolmanLastSync">Никогда</span></p>
    </div>
    <div id="spoolmanSyncStatus" class="alert alert-success" style="display: none; opacity: 1;"></div>
    <div class="mb-3">
      <button class="btn btn-primary" id="saveSpoolmanSettingsBtn">Сохранить настройки</button>
      <button class="btn btn-success" id="importFromSpoolmanBtn">Синхронизация с Spoolman</button>
      <button class="btn btn-warning" id="syncToSpoolmanBtn" style="display: none;">Экспорт (устарел)</button>
      <button class="btn btn-danger" id="clearSpoolmanDuplicatesBtn">Очистить дубликаты</button>
      <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#instructionModal">
        Инструкция по установке
      </button>
    </div>
  </div>
  <div class="modal fade" id="instructionModal" tabindex="-1" aria-labelledby="instructionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="instructionModalLabel">Инструкция по настройке HTTPS для Spoolman (локальная сеть)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
        </div>
        <div class="modal-body">
          <ol>

           <li><strong>Установить Spoolman на внешнее устройство с Ubuntu в локальной сети</strong> <a href="https://github.com/Donkie/Spoolman/wiki/Installation">https://github.com/Donkie/Spoolman/wiki/Installation</a></li>

            <li>
              <strong>Генерация самоподписанного сертификата</strong><br>
              <pre><code>sudo mkdir -p /etc/ssl/spoolman
sudo openssl req -x509 -nodes -days 365 \
  -newkey rsa:2048 \
  -keyout /etc/ssl/spoolman/spoolman.key \
  -out /etc/ssl/spoolman/spoolman.crt \
  -subj "/CN=127.0.0.1" \
  -addext "subjectAltName=IP:127.0.0.1"

sudo chmod 600 /etc/ssl/spoolman/spoolman.key
sudo chmod 644 /etc/ssl/spoolman/spoolman.crt</code></pre><br/>
spoolman.crt нужно скачать на локальный компьютер и добавить в доверенные центрв сертификации.
            </li>
            <li>
              <strong>Установка и базовая настройка Nginx</strong><br>
              <pre><code>sudo apt update
sudo apt install -y nginx
sudo rm /etc/nginx/sites-enabled/default
sudo ln -s /etc/nginx/sites-available/spoolman /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx</code></pre>
            </li>
            <li>
              <strong>Конфигурация Nginx (HTTPS + CORS + PNA + proxy_pass)</strong><br>
              Создайте или отредактируйте файл <code>/etc/nginx/sites-available/spoolman</code>:
              <pre><code>
server {
    listen 443 ssl;
    server_name 127.0.0.1;

    ssl_certificate     /etc/ssl/spoolman/spoolman.crt;
    ssl_certificate_key /etc/ssl/spoolman/spoolman.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_tickets off;

    location / {
        # Общие CORS + метод PATCH
        add_header Access-Control-Allow-Origin         "https://nazbav.github.io" always;
        add_header Access-Control-Allow-Credentials    "true" always;
        add_header Access-Control-Allow-Private-Network "true" always;
        add_header Access-Control-Allow-Methods        "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers        "Origin, X-Requested-With, Content-Type, Accept" always;

        # Preflight OPTIONS
        if ($request_method = OPTIONS) {
            return 204;
        }

        proxy_pass         http://127.0.0.1:7912;
        proxy_http_version 1.1;
        proxy_set_header   Host            $host;
        proxy_set_header   X-Real-IP       $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
</code></pre> <br/>Перезагружаем
            </li>
            <li>
              <strong>Настройка файрвола (UFW)</strong><br>
              <pre><code>sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload</code></pre>
            </li>
            <li>
              <strong>Перезапуск и проверка</strong><br>
              <pre><code>sudo systemctl restart Spoolman
sudo systemctl status Spoolman

# Проверить HTTPS:
curl -vk https://127.0.0.1/

# Проверить preflight CORS/PNA:
curl -vk -X OPTIONS https://127.0.0.1/api/v1/info \
  -H "Origin: https://nazbav.github.io" \
  -H "Access-Control-Request-Method: GET" \
  -H "Access-Control-Request-Headers: Content-Type" \
  -H "Access-Control-Request-Private-Network: true"</code></pre>
              При успешном ответе будет:
              <ul>
                <li><code>HTTP/1.1 204 No Content</code></li>
                <li><code>Access-Control-Allow-Private-Network: true</code></li>
              </ul>
            </li>
          </ol>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
        </div>
      </div>
    </div>
  </div>
  `;
    }

    function setupSpoolmanUI() {
        document.getElementById('saveSpoolmanSettingsBtn').addEventListener('click', function() {
            const config = {
                enabled: document.getElementById('spoolmanEnabledCheckbox').checked,
                url: document.getElementById('spoolmanUrlInput').value.trim(),
                autoSync: document.getElementById('spoolmanAutoSyncCheckbox').checked,
                lastSync: getSpoolmanConfig().lastSync
            };

            saveSpoolmanConfig(config);
            showSpoolmanStatus('success', 'Настройки сохранены');
        });

        document.getElementById('testSpoolmanConnectionBtn').addEventListener('click', async function() {
            const url = document.getElementById('spoolmanUrlInput').value.trim();
            if (!url) {
                showSpoolmanStatus('danger', 'Необходимо указать URL');
                return;
            }

            showSpoolmanStatus('info', 'Проверка подключения...');
            const result = await testSpoolmanConnection(url);
            if (result.success) {
                showSpoolmanStatus('success', result.message);
            } else {
                showSpoolmanStatus('danger', `${result.message}. Возможно нужно установить и активировать CORS Unblock.`);
            }
        });

        document.getElementById('importFromSpoolmanBtn').addEventListener('click', async function() {
            showSpoolmanStatus('info', 'Синхронизация с Spoolman...');
            this.disabled = true;

            const result = await importAllMaterialsFromSpoolman(msg => showSpoolmanStatus('info', msg));

            this.disabled = false;
            if (result.success) {
                showSpoolmanStatus('success', result.message);
                if (result.errors && result.errors.length > 0) {
                    console.warn('Import completed with errors:', result.errors);
                }
            } else {
                showSpoolmanStatus('danger', result.message);
            }
        });

        document.getElementById('syncToSpoolmanBtn').addEventListener('click', async function() {
            const result = await syncAllMaterialsToSpoolman();
            showSpoolmanStatus('warning', result.message);
        });

        if (document.getElementById('clearSpoolmanDuplicatesBtn')) {
            document.getElementById('clearSpoolmanDuplicatesBtn').addEventListener('click', function() {
                clearSpoolmanDuplicates();
            });
        }
    }

    function clearSpoolmanDuplicates() {
        showSpoolmanStatus('info', 'Поиск и удаление дубликатов...');

        try {
            const materialsBySpoolmanId = {};
            const duplicates = [];
            appData.materials.forEach(material => {
                if (material.spoolmanSpoolId) {
                    const spoolId = material.spoolmanSpoolId;

                    if (!materialsBySpoolmanId[spoolId]) {
                        materialsBySpoolmanId[spoolId] = [];
                    }

                    materialsBySpoolmanId[spoolId].push(material);
                }
            });

            for (const [spoolId, materials] of Object.entries(materialsBySpoolmanId)) {
                if (materials.length > 1) {
                    console.log(`Found ${materials.length} materials referencing Spoolman spool ${spoolId}`);
                    for (let i = 1; i < materials.length; i++) {
                        duplicates.push(materials[i]);
                    }
                }
            }

            if (duplicates.length > 0) {
                const duplicateIds = new Set(duplicates.map(m => m.id));

                appData.materials = appData.materials.filter(m => !duplicateIds.has(m.id));

                saveToLocalStorage();
                renderGlobalMaterialsTable();

                showSpoolmanStatus('success', `Удалено ${duplicates.length} дубликатов. Обновите страницу для применения изменений.`);
            } else {
                showSpoolmanStatus('info', 'Дубликатов не найдено.');
            }
        } catch (error) {
            console.error('Error cleaning up duplicates:', error);
            showSpoolmanStatus('danger', `Ошибка очистки дубликатов: ${error.message}`);
        }
    }

    function showSpoolmanStatus(type, message) {
        const statusEl = document.getElementById('spoolmanSyncStatus');
        if (!statusEl) return;

        statusEl.className = `alert alert-${type}`;
        statusEl.style.display = 'block';
        statusEl.textContent = message;

        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                    statusEl.style.opacity = '1';
                }, 500);
            }, 5000);
        }
    }

    function initSpoolmanIntegration() {
        const container = document.getElementById('spoolmanSettingsContainer');
        if (!container) return;

        container.innerHTML = createSpoolmanSettingsUI();

        saveToLocalStorage();
        hookMaterialUsage();

        // Заполняем форму существующими значениями из localStorage
        setTimeout(() => {
            populateSpoolmanUIFromConfig();
        }, 200);
    }

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            initSpoolmanIntegration();
            setTimeout(() => {
                setupSpoolmanUI();
            }, 500);
        }, 1000);


        console.log(appData);
    });

    document.getElementById('copyCheckLinkBtn').onclick = function() {
        const linkInput = document.getElementById('checkLinkInput');
        navigator.clipboard.writeText(linkInput.value);
    };

</script>
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="globalToastContainer"></div>
</body>
</html>
